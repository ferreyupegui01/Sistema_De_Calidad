CONTEXTO DEL PROYECTO (FECHA: 2026-01-28T19:25:03.881Z):


==================================================================
ARCHIVO: backend\config\db.js
==================================================================
import sql from 'mssql';
import dotenv from 'dotenv';

dotenv.config();

// 1. Configuraci√≥n SGC (Principal)
export const configSGC = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    server: process.env.DB_SERVER,
    database: process.env.DB_NAME,
    port: 1433,
    options: { encrypt: false, trustServerCertificate: true },
    // Timeout por defecto es 15000 (15s)
};

// 2. Configuraci√≥n RRHH (IP 10.10.10.8)
const configRRHH = {
    user: process.env.DB_RRHH_USER,
    password: process.env.DB_RRHH_PASSWORD,
    server: process.env.DB_RRHH_SERVER,
    database: process.env.DB_RRHH_NAME,
    port: 1433,
    options: { encrypt: false, trustServerCertificate: true }
};

// 3. Configuraci√≥n ERP (IP 10.10.10.32)
const configERP = {
    user: process.env.DB_ERP_USER,
    password: process.env.DB_ERP_PASSWORD,
    server: process.env.DB_ERP_SERVER,
    database: process.env.DB_ERP_NAME,
    port: 1433,
    options: { encrypt: false, trustServerCertificate: true }
};

// Pools Singleton (Para no abrir mil conexiones)
let poolSGC = null;
let poolRRHH = null;
let poolERP = null;

// Conexi√≥n Principal
export async function getConnection() {
    try {
        if (!poolSGC) poolSGC = await new sql.ConnectionPool(configSGC).connect();
        return poolSGC;
    } catch (error) {
        console.error('Error conectando a SGC:', error);
        throw error;
    }
}

// Conexi√≥n RRHH (Gosem)
export async function getConnectionRRHH() {
    try {
        if (!poolRRHH) poolRRHH = await new sql.ConnectionPool(configRRHH).connect();
        return poolRRHH;
    } catch (error) {
        console.error('Error conectando a RRHH (10.10.10.8):', error);
        throw error;
    }
}

// Conexi√≥n ERP (Sofsin)
export async function getConnectionERP() {
    try {
        if (!poolERP) poolERP = await new sql.ConnectionPool(configERP).connect();
        return poolERP;
    } catch (error) {
        console.error('Error conectando a ERP (10.10.10.32):', error);
        throw error;
    }
}

export { sql };


==================================================================
ARCHIVO: backend\controllers\acpmController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// CREAR NUEVA ACCI√ìN (ACPM)
// ==========================================
export const crearACPM = async (req, res) => {
    const { 
        tipo, origen, origenPlan, descripcion, planAccion, 
        responsable, fechaLimite, analisisCausa, idReporte, idAuditoria 
    } = req.body;

    if (!tipo || !origen || !origenPlan || !descripcion || !planAccion || !responsable || !fechaLimite) {
        return res.status(400).json({ mensaje: 'Por favor complete todos los campos obligatorios (*)' });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('Tipo_Accion', sql.NVarChar, tipo)
            .input('Origen', sql.NVarChar, origen)
            .input('Origen_Plan', sql.NVarChar, origenPlan)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Plan_Accion', sql.NVarChar, planAccion)
            .input('Responsable', sql.NVarChar, responsable)
            .input('Fecha_Limite', sql.Date, fechaLimite)
            .input('Analisis_Causa', sql.NVarChar, analisisCausa || '')
            .input('ID_Reporte_Origen', sql.Int, idReporte || null)
            .input('ID_Auditoria', sql.Int, idAuditoria || null)
            .execute('dbo.SP_CrearACPM');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'ACPM', `Cre√≥ acci√≥n ${tipo}. Origen: ${origen}`);
        res.status(201).json({ mensaje: 'Acci√≥n ACPM creada exitosamente' });
    } catch (error) {
        console.error("Error creando ACPM:", error);
        res.status(500).json({ mensaje: 'Error interno al crear la acci√≥n' });
    }
};

// ==========================================
// LISTAR ACCIONES
// ==========================================
export const listarACPM = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarACPM');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener el listado de acciones' });
    }
};

// ==========================================
// OBTENER UN ACPM
// ==========================================
export const obtenerACPM = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_ACPM', sql.Int, id)
            .execute('dbo.SP_ObtenerACPM');
            
        if (result.recordset.length === 0) return res.status(404).json({ mensaje: 'No encontrado' });
        
        res.json(result.recordset[0]);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener el plan' });
    }
};

// ==========================================
// CERRAR ACPM (CON SUBIDA REAL DE EVIDENCIA)
// ==========================================
export const cerrarACPM = async (req, res) => {
    const { id } = req.params;
    
    // --- CORRECCI√ìN HOSTINGER: USAR ARCHIVO REAL ---
    if (!req.file) {
        return res.status(400).json({ mensaje: 'Es obligatorio adjuntar evidencia (Archivo) para cerrar la acci√≥n' });
    }

    // Guardamos ruta relativa "uploads/evidencia.pdf"
    const urlEvidencia = `uploads/${req.file.filename}`;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_ACPM', sql.Int, id)
            .input('Url_Evidencia', sql.NVarChar, urlEvidencia)
            .execute('dbo.SP_CerrarACPM');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CERRAR', 'ACPM', `Cerr√≥ ACPM ID ${id} con evidencia.`);
        res.json({ mensaje: 'Acci√≥n ACPM cerrada correctamente' });
    } catch (error) {
        console.error("Error cerrando ACPM:", error);
        res.status(500).json({ mensaje: 'Error al cerrar la acci√≥n' });
    }
};

// ==========================================
// GESTIONAR ACPM (CAMBIAR ESTADO + OPCIONAL EVIDENCIA)
// ==========================================
export const gestionarACPM = async (req, res) => {
    const { id } = req.params;
    const { nuevoEstado, comentario, usuario } = req.body; // urlEvidencia ya no viene del body como texto

    // --- CORRECCI√ìN HOSTINGER ---
    let urlEvidencia = '';
    if (req.file) {
        urlEvidencia = `uploads/${req.file.filename}`;
    }

    // Validaci√≥n: Si cierra, debe tener evidencia
    if (nuevoEstado === 'Cerrada' && !urlEvidencia) {
        return res.status(400).json({ mensaje: 'Para cerrar la acci√≥n es OBLIGATORIO adjuntar una evidencia (Archivo).' });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_ACPM', sql.Int, id)
            .input('NuevoEstado', sql.NVarChar, nuevoEstado)
            .input('Comentario', sql.NVarChar, comentario || '')
            .input('Url_Evidencia', sql.NVarChar, urlEvidencia) // Pasa ruta relativa o string vac√≠o
            .input('Usuario', sql.NVarChar, usuario || 'Sistema')
            .execute('dbo.SP_GestionarACPM');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'GESTIONAR', 'ACPM', `Cambi√≥ estado a ${nuevoEstado} en ACPM ID ${id}.`);
        res.json({ mensaje: 'Gesti√≥n guardada exitosamente.' });
    } catch (error) {
        console.error("Error gestionando ACPM:", error);
        res.status(500).json({ mensaje: 'Error al guardar la gesti√≥n.' });
    }
};

// ... obtenerOrigenes y agregarOrigen quedan igual ...
export const obtenerOrigenes = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarOrigenesACPM');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al cargar or√≠genes' }); }
};

export const agregarOrigen = async (req, res) => {
    const { nombre } = req.body;
    try {
        const pool = await getConnection();
        await pool.request().input('Nombre_Origen', sql.NVarChar, nombre).execute('dbo.SP_AgregarOrigenACPM');
        res.json({ mensaje: 'Origen agregado correctamente' });
    } catch (error) { res.status(500).json({ mensaje: 'Error al agregar origen' }); }
};

// ==========================================
// NUEVO: VER EVIDENCIA ACPM
// ==========================================
export const verEvidenciaACPM = (req, res) => {
    const { nombreArchivo } = req.params;
    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }
    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);
    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Evidencia no encontrada' });
    }
};


==================================================================
ARCHIVO: backend\controllers\actasController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- OBTENER LISTADO ---
export const getActas = async (req, res) => {
    try {
        const pool = await getConnection();
        // Ordenamos por n√∫mero descendente para ver la √∫ltima primero
        const result = await pool.request().query(`
            SELECT * FROM Actas_Destruccion 
            ORDER BY TRY_CAST(Numero_Acta AS INT) DESC
        `);
        res.json(result.recordset);
    } catch (error) {
        console.error("Error al obtener actas:", error);
        res.status(500).json({ message: 'Error al obtener actas de la base de datos' });
    }
};

// --- CREAR ACTA (CON FOTOS REALES) ---
export const createActa = async (req, res) => {
    const { 
        sede, testigos, producto, cantidad, 
        bodega, novedad, elaborado_por, revisado_por, aprobado_por,
        codigo_formato,
        aplica_saave, 
        nota_saave 
    } = req.body;
    
    // Convertir a Bit (1 o 0)
    const saaveBit = (aplica_saave === 'true' || aplica_saave === true || aplica_saave === 1) ? 1 : 0;
    const notaFinal = saaveBit === 1 ? (nota_saave || 'SAAVE 1370 Doc realizado por operaciones en sofsin') : '';

    // --- CORRECCI√ìN HOSTINGER: RUTAS RELATIVAS ---
    // req.files viene de upload.array('fotos', 4)
    const files = req.files || [];
    
    // Guardamos "uploads/archivo.jpg" en lugar de "/uploads/..." o "http://..."
    const foto1 = files[0] ? `uploads/${files[0].filename}` : null;
    const foto2 = files[1] ? `uploads/${files[1].filename}` : null;
    const foto3 = files[2] ? `uploads/${files[2].filename}` : null;
    const foto4 = files[3] ? `uploads/${files[3].filename}` : null;

    try {
        const pool = await getConnection();

        // 1. CALCULAR EL SIGUIENTE N√öMERO
        const resultNum = await pool.request().query(`
            SELECT ISNULL(MAX(TRY_CAST(Numero_Acta AS INT)), 0) + 1 AS SiguienteNumero 
            FROM Actas_Destruccion 
            WHERE ISNUMERIC(Numero_Acta) = 1
        `);
        
        let nuevoNumero = resultNum.recordset[0].SiguienteNumero;
        const numeroString = nuevoNumero.toString();

        // 2. INSERTAR DATOS
        await pool.request()
            .input('Numero_Acta', sql.NVarChar, numeroString)
            .input('Codigo_Formato', sql.NVarChar, codigo_formato || 'FT-SGC-019')
            .input('Sede', sql.NVarChar, sede)
            .input('Testigos', sql.NVarChar, testigos)
            .input('Producto', sql.NVarChar, producto)
            .input('Cantidad', sql.NVarChar, cantidad)
            .input('Bodega', sql.NVarChar, bodega)
            .input('Novedad', sql.NVarChar, novedad)
            .input('Url_Foto1', sql.NVarChar, foto1)
            .input('Url_Foto2', sql.NVarChar, foto2)
            .input('Url_Foto3', sql.NVarChar, foto3)
            .input('Url_Foto4', sql.NVarChar, foto4)
            .input('Elaborado_Por', sql.NVarChar, elaborado_por)
            .input('Revisado_Por', sql.NVarChar, revisado_por)
            .input('Aprobado_Por', sql.NVarChar, aprobado_por)
            .input('Aplica_Saave', sql.Bit, saaveBit)
            .input('Nota_Saave', sql.NVarChar, notaFinal)
            .query(`
                INSERT INTO Actas_Destruccion 
                (Numero_Acta, Codigo_Formato, Sede, Testigos, Producto, Cantidad, Bodega_Procedente, Novedad, 
                 Url_Foto1, Url_Foto2, Url_Foto3, Url_Foto4, 
                 Elaborado_Por, Revisado_Por, Aprobado_Por, Aplica_Saave, Nota_Saave, Fecha, Empresa)
                VALUES 
                (@Numero_Acta, @Codigo_Formato, @Sede, @Testigos, @Producto, @Cantidad, @Bodega, @Novedad, 
                 @Url_Foto1, @Url_Foto2, @Url_Foto3, @Url_Foto4, 
                 @Elaborado_Por, @Revisado_Por, @Aprobado_Por, @Aplica_Saave, @Nota_Saave, GETDATE(), 'Empaquetados El Trece')
            `);

        res.status(201).json({ message: `Acta #${numeroString} creada correctamente` });
    } catch (error) {
        console.error('Error creando acta:', error);
        res.status(500).json({ message: 'Error al guardar en base de datos.' });
    }
};

// ==========================================
// NUEVO: VER FOTO ACTA (STREAMING)
// ==========================================
export const verFotoActa = (req, res) => {
    const { nombreArchivo } = req.params;

    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Foto no encontrada en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\auditController.js
==================================================================
// backend/controllers/auditController.js
import { getConnection } from '../config/db.js';

export const getAuditoriaReport = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ObtenerAuditoriaCalidad');
        
        // El SP devuelve 3 tablas (Recordsets)
        res.json({
            resumen: result.recordsets[0],      // Estad√≠sticas
            cronogramas: result.recordsets[1],  // Qu√© han planeado
            actividades: result.recordsets[2]   // Qu√© han ejecutado
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al obtener auditor√≠a' });
    }
};


==================================================================
ARCHIVO: backend\controllers\auditGlobalController.js
==================================================================
// backend/controllers/auditGlobalController.js
import { getConnection } from '../config/db.js';

export const getGlobalLogs = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_VerAuditoriaGlobal');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error obteniendo bit√°cora' });
    }
};


==================================================================
ARCHIVO: backend\controllers\auditoriaController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// LISTAR TODAS LAS AUDITOR√çAS
// ==========================================
export const getAuditorias = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarAuditorias');
        res.json(result.recordset);
    } catch (error) {
        console.error("Error al listar auditor√≠as:", error);
        res.status(500).json({ mensaje: 'Error interno al listar auditor√≠as' });
    }
};

// ==========================================
// CREAR AUDITOR√çA (CON SUBIDA REAL)
// ==========================================
export const createAuditoria = async (req, res) => {
    const { tipo, auditor, area, normas, observaciones } = req.body;
    
    // --- CORRECCI√ìN HOSTINGER ---
    let urlEvidencia = null;
    if (req.file) {
        // Guardamos 'uploads/archivo.pdf'
        urlEvidencia = `uploads/${req.file.filename}`; 
    }

    if (!tipo || !auditor || !area) {
        return res.status(400).json({ mensaje: 'Faltan campos obligatorios (Tipo, Auditor, √Årea)' });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('Tipo', sql.NVarChar, tipo)
            .input('Auditor', sql.NVarChar, auditor)
            .input('Area', sql.NVarChar, area)
            .input('Normas', sql.NVarChar, normas || '')
            .input('Observaciones', sql.NVarChar, observaciones || '')
            .input('Url_Evidencia', sql.NVarChar, urlEvidencia) 
            .input('ID_Usuario', sql.Int, req.usuario.id)
            .execute('dbo.SP_CrearAuditoria');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'AUDITORIA', `Registr√≥ auditor√≠a ${tipo} con evidencia.`);

        res.status(201).json({ mensaje: 'Auditor√≠a registrada correctamente' });
    } catch (error) {
        console.error("Error creando auditor√≠a:", error);
        res.status(500).json({ mensaje: 'Error al registrar la auditor√≠a en base de datos' });
    }
};

// ==========================================
// GESTI√ìN DIN√ÅMICA (Sin cambios, solo logica)
// ==========================================
export const manageAuditores = async (req, res) => {
    const { nuevo } = req.body; 
    try {
        const pool = await getConnection();
        const request = pool.request();
        request.input('Nombre', sql.NVarChar, nuevo || null);
        const result = await request.execute('dbo.SP_GestionarAuditorDinamico');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al gestionar auditores' });
    }
};

export const manageAreas = async (req, res) => {
    const { nuevo } = req.body;
    try {
        const pool = await getConnection();
        const request = pool.request();
        request.input('Nombre', sql.NVarChar, nuevo || null);
        const result = await request.execute('dbo.SP_GestionarAreaDinamica');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al gestionar √°reas' });
    }
};

// ==========================================
// NUEVO: VER EVIDENCIA AUDITOR√çA
// ==========================================
export const verEvidenciaAuditoria = (req, res) => {
    const { nombreArchivo } = req.params;

    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Evidencia no encontrada en el servidor' });
    }
};




==================================================================
ARCHIVO: backend\controllers\authController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { registrarLog } from '../libs/logger.js'; 

export const login = async (req, res) => {
    const { cedula, password } = req.body;

    if (!cedula || !password) {
        return res.status(400).json({ mensaje: 'Por favor ingrese c√©dula y contrase√±a' });
    }

    try {
        const pool = await getConnection();
        
        // 2. Ejecutar el Procedimiento Almacenado (Ahora trae el Email)
        const result = await pool.request()
            .input('Cedula', sql.NVarChar, cedula)
            .execute('dbo.SP_ValidarLogin');

        if (result.recordset.length === 0) {
            return res.status(401).json({ mensaje: 'Credenciales inv√°lidas (Usuario no existe)' });
        }

        const usuario = result.recordset[0];

        if (!usuario.Estado) {
            return res.status(403).json({ mensaje: 'Usuario inactivo. Contacte al administrador.' });
        }

        const isMatch = await bcrypt.compare(password, usuario.Password_Hash);
        if (!isMatch) {
            return res.status(401).json({ mensaje: 'Credenciales inv√°lidas (Contrase√±a incorrecta)' });
        }

        // 6. Generar Token (Opcional: puedes incluir el email en el token si quieres, pero no es estricto)
        const token = jwt.sign(
            { id: usuario.ID_Usuario, rol: usuario.Rol, nombre: usuario.Nombre_Completo }, 
            process.env.JWT_SECRET, 
            { expiresIn: '8h' }
        );

        // --- REGISTRAR LOG ---
        await registrarLog(
            usuario.Nombre_Completo, 
            usuario.Rol, 
            'LOGIN', 
            'Autenticaci√≥n', 
            `Inicio de sesi√≥n exitoso desde IP: ${req.ip || 'Desconocida'}`
        );

        // 7. Respuesta exitosa (AQU√ç AGREGAMOS EL EMAIL)
        res.json({
            mensaje: 'Login exitoso',
            token,
            usuario: {
                id: usuario.ID_Usuario,
                cedula: usuario.Cedula, // √ötil tenerlo
                nombre: usuario.Nombre_Completo,
                rol: usuario.Rol,
                email: usuario.Email // <--- ¬°AQU√ç EST√Å LA SOLUCI√ìN! Se env√≠a al frontend
            }
        });

    } catch (error) {
        console.error('Error en login:', error);
        res.status(500).json({ mensaje: 'Error del servidor', error: error.message });
    }
};


==================================================================
ARCHIVO: backend\controllers\capacitacionController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// 1. GESTI√ìN DE CAPACITACIONES (MATERIAL)
// ==========================================

export const crearCapacitacion = async (req, res) => {
    const { titulo, descripcion } = req.body;
    
    if (!req.file) return res.status(400).json({ mensaje: 'Debe subir un material (PDF/PPT)' });
    
    // Guardamos solo el nombre del archivo o ruta relativa simple
    // Esto es clave para que funcione en cualquier entorno
    const urlMaterial = `uploads/${req.file.filename}`;
    
    const ext = req.file.filename.split('.').pop().toLowerCase();
    let tipoArchivo = 'OTRO';
    if (ext === 'pdf') tipoArchivo = 'PDF';
    else if (['ppt', 'pptx'].includes(ext)) tipoArchivo = 'PPT';
    else if (['mp4', 'avi'].includes(ext)) tipoArchivo = 'VIDEO';

    try {
        const pool = await getConnection();
        await pool.request()
            .input('Titulo', sql.NVarChar, titulo)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Url_Material', sql.NVarChar, urlMaterial)
            .input('Tipo_Archivo', sql.NVarChar, tipoArchivo)
            .execute('dbo.SP_CrearCapacitacion');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Capacitaci√≥n', `Cre√≥ capacitaci√≥n: ${titulo}`);
        res.json({ mensaje: 'Capacitaci√≥n creada y evaluaci√≥n asignada.' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al crear capacitaci√≥n' });
    }
};

export const listarCapacitacionesAdmin = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarCapacitacionesAdmin');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al listar' }); }
};

export const listarParaKiosco = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarCapacitacionesKiosco');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al listar para kiosco' }); }
};

// ==========================================
// 2. REPORTES AVANZADOS
// ==========================================

export const obtenerResumenAdmin = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_Admin_ResumenCapacitaciones');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al cargar resumen' }); }
};

export const obtenerUsuariosPorCurso = async (req, res) => {
    const { idEvaluacion } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Evaluacion', sql.Int, idEvaluacion)
            .execute('dbo.SP_Admin_UsuariosPorEvaluacion');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al cargar usuarios' }); }
};

export const obtenerHistorialUsuario = async (req, res) => {
    const { idEvaluacion } = req.params;
    const { nombre } = req.query; 
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Evaluacion', sql.Int, idEvaluacion)
            .input('NombreEvaluado', sql.NVarChar, nombre)
            .execute('dbo.SP_Admin_HistorialUsuario');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al cargar historial' }); }
};

// ==========================================
// 3. GESTI√ìN DE RESULTADOS Y PREGUNTAS
// ==========================================

export const listarResultados = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarResultadosEvaluacion');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error' }); }
};

export const cambiarEstadoResultado = async (req, res) => {
    const { id } = req.params;
    const { estado } = req.body;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Resultado', sql.Int, id).input('NuevoEstado', sql.NVarChar, estado).execute('dbo.SP_CambiarEstadoResultado');
        res.json({ mensaje: 'Estado actualizado' });
    } catch (error) { res.status(500).json({ mensaje: 'Error' }); }
};

export const obtenerDetalleResultado = async (req, res) => {
    const { idResultado } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Resultado', sql.Int, idResultado)
            .execute('dbo.SP_ObtenerDetalleEvaluacion'); 
        res.json(result.recordset);
    } catch (error) { 
        console.error(error);
        res.status(500).json({ mensaje: 'Error al obtener detalle' }); 
    }
};

export const listarPreguntas = async (req, res) => {
    const { idEvaluacion } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request().input('ID_Evaluacion', sql.Int, idEvaluacion).execute('dbo.SP_ListarPreguntasEvaluacion');
        
        const preguntasMap = new Map();
        result.recordset.forEach(row => {
            if (!preguntasMap.has(row.ID_Pregunta_Eval)) {
                preguntasMap.set(row.ID_Pregunta_Eval, {
                    id: row.ID_Pregunta_Eval,
                    pregunta: row.Texto_Pregunta,
                    imagen: row.Url_Imagen, 
                    opciones: []
                });
            }
            preguntasMap.get(row.ID_Pregunta_Eval).opciones.push({
                id: row.ID_Opcion, text: row.Texto_Opcion, isCorrect: row.Es_Correcta
            });
        });
        res.json(Array.from(preguntasMap.values()));
    } catch (error) { res.status(500).json({ mensaje: 'Error al listar preguntas' }); }
};

export const agregarPregunta = async (req, res) => {
    const { idEvaluacion, texto, opciones } = req.body;
    
    let urlImagen = null;
    if (req.file) {
        urlImagen = `uploads/${req.file.filename}`;
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Evaluacion', sql.Int, idEvaluacion)
            .input('TextoPregunta', sql.NVarChar, texto)
            .input('Url_Imagen', sql.NVarChar, urlImagen) 
            .input('OpcionesJSON', sql.NVarChar, opciones)
            .execute('dbo.SP_AgregarPreguntaEval');
            
        res.json({ mensaje: 'Pregunta agregada correctamente' });
    } catch (error) { 
        console.error("Error agregando pregunta:", error);
        res.status(500).json({ mensaje: 'Error al guardar la pregunta' }); 
    }
};

export const eliminarPregunta = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Pregunta', sql.Int, id).execute('dbo.SP_EliminarPreguntaEvaluacion');
        res.json({ mensaje: 'Eliminada' });
    } catch (error) { res.status(500).json({ mensaje: 'Error' }); }
};

// ==========================================
// 4. NUEVO ENDPOINT: STREAMING DE MATERIAL
// ==========================================
// Esta es la funci√≥n clave para Hostinger
export const streamMaterialCapacitacion = (req, res) => {
    const { nombreArchivo } = req.params; // Aseg√∫rate de que en la ruta se llame :nombreArchivo o :filename

    // 1. Obtener la ra√≠z del proyecto (donde ejecutas 'npm run dev')
    const projectRoot = process.cwd(); 

    // 2. Definir las posibles ubicaciones del archivo
    // Esto cubre si est√° en una subcarpeta o en la ra√≠z de uploads
    const posiblesRutas = [
        path.join(projectRoot, 'uploads', nombreArchivo),                          // Caso 1: backend/uploads/archivo.pdf
        path.join(projectRoot, 'uploads', 'Capacitacion', nombreArchivo),          // Caso 2: backend/uploads/Capacitacion/archivo.pdf
        path.join(projectRoot, 'backend', 'uploads', nombreArchivo),               // Caso 3: si ejecutas desde ra√≠z del repo
    ];

    console.log(`üîç [DEBUG] Buscando archivo: ${nombreArchivo}`);

    // 3. Iterar y buscar
    for (const ruta of posiblesRutas) {
        if (fs.existsSync(ruta)) {
            // console.log(`‚úÖ Encontrado en: ${ruta}`);
            return res.sendFile(ruta);
        }
    }

    // 4. Si llegamos aqu√≠, no existe
    console.error(`‚ùå [ERROR] Archivo NO encontrado en ninguna ruta prevista.`);
    console.error(`   Rutas intentadas:`, posiblesRutas);
    
    res.status(404).json({ mensaje: 'Archivo no encontrado en el servidor' });
};


==================================================================
ARCHIVO: backend\controllers\certificadosController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras para manejo de archivos
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// =========================================================================
// 1. LISTAR PLANTILLAS
// =========================================================================
export const listarPlantillas = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarPlantillas_Relacional');
        
        const plantillasMapeadas = result.recordset.map(row => {
            let estructura = [];
            try {
                const rawJson = row.Estructura_JSON_Reconstruida;
                if (rawJson) {
                    estructura = typeof rawJson === 'string' ? JSON.parse(rawJson) : rawJson;

                    if (Array.isArray(estructura)) {
                        estructura = estructura.map(seccion => {
                            // Limpieza de columnas y filas para evitar errores en frontend
                            if (seccion.tipo === 'tabla') {
                                if (seccion.columnas_obj) {
                                    seccion.columnas = seccion.columnas_obj.map(c => c.Etiqueta);
                                    delete seccion.columnas_obj;
                                }
                                if (typeof seccion.filas === 'string') {
                                    try { seccion.filas = JSON.parse(seccion.filas); } catch (e) { seccion.filas = []; }
                                }
                                if (!Array.isArray(seccion.filas)) seccion.filas = [];
                            }
                            seccion.fijo = Boolean(seccion.fijo);
                            return seccion;
                        });
                    }
                }
            } catch (e) {
                console.error("Error parseando JSON ID " + row.ID_Plantilla, e);
                estructura = [];
            }

            return {
                ID_Plantilla: row.ID_Plantilla,
                Nombre: row.Nombre,
                Fecha_Creacion: row.Fecha_Creacion,
                Estructura_JSON: estructura 
            };
        });

        res.json(plantillasMapeadas);
    } catch (error) {
        console.error("Error al listar plantillas:", error);
        res.status(500).json({ mensaje: 'Error al listar plantillas' });
    }
};

// =========================================================================
// 2. GUARDAR PLANTILLA
// =========================================================================
export const guardarPlantilla = async (req, res) => {
    const { nombre, estructura, id } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Nombre', sql.NVarChar, nombre)
            .input('EstructuraJSON', sql.NVarChar, JSON.stringify(estructura))
            .input('ID_Plantilla', sql.Int, id || null)
            .execute('dbo.SP_GuardarPlantilla_Relacional');
        
        res.json({ mensaje: 'Plantilla guardada correctamente' });
    } catch (error) {
        console.error("Error al guardar plantilla:", error);
        res.status(500).json({ mensaje: 'Error al guardar plantilla' });
    }
};

// =========================================================================
// 3. REGISTRAR GENERACI√ìN (Optimizado para Hostinger)
// =========================================================================
export const registrarGeneracion = async (req, res) => {
    const archivo = req.file; 
    let { idPlantilla, lote, cliente, datos } = req.body;

    // --- CORRECCI√ìN CR√çTICA: RUTA RELATIVA ---
    // Guardamos solo el nombre del archivo si existe
    let urlPDF = archivo ? `uploads/${archivo.filename}` : null;

    let listaValores = [];
    
    try {
        const dataObj = JSON.parse(datos); 

        // --- L√ìGICA INTELIGENTE PARA EXTRAER LOTE Y CLIENTE ---
        if (!lote || ['undefined', 'null', 'N/A', 'S/L'].includes(lote)) {
            lote = 'N/A';
            if (dataObj.form) {
                for (const [seccion, contenido] of Object.entries(dataObj.form)) {
                    if (typeof contenido === 'object') {
                        for (const [key, value] of Object.entries(contenido)) {
                            const k = key.toLowerCase();
                            if (['lote', 'batch', 'referencia', 'c√≥digo'].some(w => k.includes(w))) {
                                if (value && String(value).trim() !== '') { lote = String(value); break; }
                            }
                        }
                    }
                    if (lote !== 'N/A') break;
                }
            }
        }

        if (!cliente || ['undefined', 'null', 'General', 'Varios'].includes(cliente)) {
            cliente = 'General';
            if (dataObj.form) {
                for (const [seccion, contenido] of Object.entries(dataObj.form)) {
                    if (typeof contenido === 'object') {
                        for (const [key, value] of Object.entries(contenido)) {
                            const k = key.toLowerCase();
                            if (['cliente', 'empresa', 'se√±ores', 'destinatario'].some(w => k.includes(w))) {
                                if (value && String(value).trim() !== '') { cliente = String(value); break; }
                            }
                        }
                    }
                    if (cliente !== 'General') break;
                }
            }
        }
        // -------------------------------------------------------------

        // Aplanar datos para el historial detallado
        if (dataObj.form) {
            for (const [seccion, contenido] of Object.entries(dataObj.form)) {
                if (typeof contenido === 'string') {
                    listaValores.push({ seccion, campo: 'CONTENIDO_TEXTO', fila: 0, valor: contenido });
                } else {
                    for (const [campo, valor] of Object.entries(contenido)) {
                        listaValores.push({ seccion, campo: campo, fila: 0, valor: String(valor || '') });
                    }
                }
            }
        }
        if (dataObj.tables) {
            for (const [seccion, filas] of Object.entries(dataObj.tables)) {
                filas.forEach((filaObj, index) => {
                    for (const [columna, valor] of Object.entries(filaObj)) {
                        listaValores.push({ seccion, campo: columna, fila: index + 1, valor: String(valor || '') });
                    }
                });
            }
        }

    } catch (e) {
        console.error("Error procesando JSON:", e);
        return res.status(400).json({ mensaje: 'Error en formato de datos.' });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Plantilla', sql.Int, idPlantilla)
            .input('Lote', sql.NVarChar, lote)
            .input('Cliente', sql.NVarChar, cliente)
            .input('Usuario', sql.NVarChar, req.usuario.nombre)
            .input('Url_PDF', sql.NVarChar, urlPDF) 
            .input('DatosJSON', sql.NVarChar, JSON.stringify(listaValores)) 
            .execute('dbo.SP_RegistrarCertificadoGenerado'); 

        res.json({ mensaje: 'Certificado guardado y registrado.' });
    } catch (error) {
        console.error("Error SQL:", error);
        res.status(500).json({ mensaje: 'Error al registrar historial.' });
    }
};

// =========================================================================
// 4. OBTENER HISTORIAL
// =========================================================================
export const obtenerHistorial = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarCertificadosHistorial');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener historial' });
    }
};

// =========================================================================
// 5. VER PDF CERTIFICADO (STREAMING ROBUSTO)
// =========================================================================
export const verCertificadoPDF = (req, res) => {
    const { nombreArchivo } = req.params;

    console.log(`üîç [CERTIFICADOS] Buscando PDF: ${nombreArchivo}`);

    // Seguridad b√°sica
    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const projectRoot = process.cwd();

    // Estrategia de b√∫squeda m√∫ltiple (Igual que en los otros m√≥dulos)
    const posiblesRutas = [
        path.join(projectRoot, 'uploads', nombreArchivo),
        path.join(projectRoot, 'backend', 'uploads', nombreArchivo),
        path.resolve(__dirname, '../../uploads', nombreArchivo)
    ];

    let archivoEncontrado = null;

    for (const ruta of posiblesRutas) {
        if (fs.existsSync(ruta)) {
            archivoEncontrado = ruta;
            break;
        }
    }

    if (archivoEncontrado) {
        console.log(`‚úÖ [CERTIFICADOS] Encontrado en: ${archivoEncontrado}`);
        
        // Headers para visualizaci√≥n correcta
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);
        
        res.sendFile(archivoEncontrado);
    } else {
        console.error(`‚ùå [CERTIFICADOS] No encontrado. Buscado en:`, posiblesRutas);
        res.status(404).json({ mensaje: 'El archivo del certificado no existe en el servidor.' });
    }
};


==================================================================
ARCHIVO: backend\controllers\coreController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js'; 

// --- CATEGOR√çAS ---
export const crearCategoria = async (req, res) => {
    const { nombre } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Nombre', sql.NVarChar, nombre)
            .execute('dbo.SP_CrearCategoria');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Categor√≠as', `Cre√≥ categor√≠a: ${nombre}`);
        res.status(201).json({ mensaje: 'Categor√≠a creada' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al crear categor√≠a' });
    }
};

export const listarCategorias = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarCategorias');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al listar categor√≠as' });
    }
};

// --- ACTIVOS ---
export const crearActivo = async (req, res) => {
    const { nombre, idCategoria, codigo, ubicacion } = req.body;
    if (!nombre || !idCategoria || !codigo) return res.status(400).json({ mensaje: 'Faltan campos obligatorios' });
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Nombre', sql.NVarChar, nombre)
            .input('ID_Categoria', sql.Int, idCategoria)
            .input('Codigo', sql.NVarChar, codigo)
            .input('Ubicacion', sql.NVarChar, ubicacion)
            .execute('dbo.SP_CrearActivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Activos', `Cre√≥ activo: ${nombre} (${codigo})`);
        res.status(201).json({ mensaje: 'Activo creado correctamente' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al crear activo' });
    }
};

export const listarActivos = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarActivos');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al listar activos' });
    }
};

export const actualizarActivo = async (req, res) => {
    const { id } = req.params;
    const { nombre, idCategoria, codigo, ubicacion } = req.body;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Activo', sql.Int, id)
            .input('Nombre', sql.NVarChar, nombre)
            .input('ID_Categoria', sql.Int, idCategoria)
            .input('Codigo', sql.NVarChar, codigo)
            .input('Ubicacion', sql.NVarChar, ubicacion)
            .execute('dbo.SP_ActualizarActivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Activos', `Edit√≥ activo ID: ${id} - ${nombre}`);
        res.json({ mensaje: 'Activo actualizado' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al actualizar activo' });
    }
};

export const cambiarEstadoActivo = async (req, res) => {
    const { id } = req.params;
    const { nuevoEstado } = req.body;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Activo', sql.Int, id)
            .input('NuevoEstado', sql.Bit, nuevoEstado)
            .execute('dbo.SP_CambiarEstadoActivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ESTADO', 'Activos', `Cambi√≥ estado activo ID ${id} a: ${nuevoEstado}`);
        res.json({ mensaje: `Estado del activo actualizado` });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al cambiar estado' });
    }
};

// --- FORMULARIOS ---
export const crearFormularioCompleto = async (req, res) => {
    const { idCategoria, titulo, codigo, descripcion, esVisible, preguntas, programa } = req.body;
    
    if (!titulo || !idCategoria) return res.status(400).json({ mensaje: 'Faltan datos obligatorios' });
    
    try {
        const pool = await getConnection();
        const resultHeader = await pool.request()
            .input('ID_Categoria', sql.Int, idCategoria)
            .input('Titulo', sql.NVarChar, titulo)
            .input('Codigo', sql.NVarChar, codigo || '')
            .input('Descripcion', sql.NVarChar, descripcion || '')
            .input('EsVisible', sql.Bit, esVisible !== undefined ? esVisible : false)
            .input('Programa', sql.NVarChar, programa || 'General')
            .output('NewId', sql.Int)
            .execute('dbo.SP_CrearFormularioCabecera');
        
        const idFormulario = resultHeader.output.NewId;

        if (preguntas && preguntas.length > 0) {
            for (let i = 0; i < preguntas.length; i++) {
                const p = preguntas[i];
                const textoPregunta = typeof p === 'object' && p.texto ? p.texto : p;
                const tipoPregunta = typeof p === 'object' && p.tipo ? p.tipo : 'BOOL';

                await pool.request()
                    .input('ID_Formulario', sql.Int, idFormulario)
                    .input('Texto', sql.NVarChar, textoPregunta)
                    .input('Orden', sql.Int, i + 1)
                    .input('Tipo', sql.NVarChar, tipoPregunta)
                    .execute('dbo.SP_AgregarPregunta');
            }
        }

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Formularios', `Cre√≥ formulario: ${titulo} (${codigo}) para programa: ${programa}`);
        res.status(201).json({ mensaje: 'Formulario creado exitosamente', id: idFormulario });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al crear formulario completo' });
    }
};

// --- LISTAR FORMULARIOS (CORREGIDA PARA ROL) ---
export const listarFormularios = async (req, res) => {
    try {
        const pool = await getConnection();
        
        // 1. Obtener Rol y normalizarlo (may√∫sculas)
        const rolRaw = req.usuario ? req.usuario.rol : '';
        const rolUsuario = rolRaw.trim().toUpperCase();

        console.log(`[Forms] Usuario: ${req.usuario?.nombre} | Rol: ${rolUsuario}`);

        // 2. Query Base
        let query = `
            SELECT F.ID_Formulario, F.Titulo, F.Codigo, F.Descripcion, F.Es_Visible_Colaborador, F.Programa, C.Nombre as Categoria, C.ID_Categoria
            FROM Formularios F
            LEFT JOIN Categorias_Form C ON F.ID_Categoria = C.ID_Categoria
        `;

        // 3. Filtro Inteligente
        // Definimos qui√©nes son los administradores que pueden ver todo
        const esJefe = ['ADMINCALIDAD', 'SUPERADMIN', 'ADMINISTRADOR', 'ADMIN'].includes(rolUsuario);

        if (!esJefe) {
            // Si NO es jefe (es Colaborador), ocultamos los formularios no visibles
            query += ' WHERE F.Es_Visible_Colaborador = 1';
        }

        query += ' ORDER BY F.Fecha_Creacion DESC';

        const result = await pool.request().query(query);
        res.json(result.recordset);

    } catch (error) {
        console.error("Error al listar formularios:", error);
        res.status(500).json({ mensaje: 'Error al listar formularios' });
    }
};

export const actualizarFormulario = async (req, res) => {
    const { id } = req.params;
    const { titulo, codigo, descripcion, idCategoria, programa } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Formulario', sql.Int, id)
            .input('Titulo', sql.NVarChar, titulo)
            .input('Codigo', sql.NVarChar, codigo)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('ID_Categoria', sql.Int, idCategoria)
            .input('Programa', sql.NVarChar, programa)
            .execute('dbo.SP_ActualizarFormulario');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Formularios', `Actualiz√≥ formulario ID ${id}: ${titulo}`);
        res.json({ mensaje: 'Formulario actualizado correctamente' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al actualizar formulario' });
    }
};

export const eliminarFormulario = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Formulario', sql.Int, id)
            .execute('dbo.SP_EliminarFormularioCompleto');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Formularios', `Elimin√≥ formulario ID ${id} y su contenido.`);
        res.json({ mensaje: 'Formulario eliminado completamente' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al eliminar formulario' });
    }
};

export const toggleVisibilidad = async (req, res) => {
    const { id } = req.params;
    const { esVisible } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Formulario', sql.Int, id)
            .input('EsVisible', sql.Bit, esVisible)
            .execute('dbo.SP_CambiarVisibilidadForm');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'VISIBILIDAD', 'Formularios', `Cambi√≥ visibilidad Form ID ${id} a: ${esVisible}`);
        res.json({ mensaje: 'Visibilidad actualizada' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al actualizar visibilidad' });
    }
};

// --- PREGUNTAS ---
export const obtenerPreguntas = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Formulario', sql.Int, id)
            .execute('dbo.SP_ObtenerPreguntasPorFormulario');
        res.json(result.recordset);
    } catch (error) {
        console.error("Error al obtener preguntas:", error);
        res.status(500).json({ mensaje: 'Error al obtener preguntas' });
    }
};

export const agregarPreguntaIndividual = async (req, res) => {
    const { idFormulario, texto, tipo } = req.body;
    const tipoPregunta = tipo || 'BOOL'; 

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Formulario', sql.Int, idFormulario)
            .input('Texto', sql.NVarChar, texto)
            .input('Orden', sql.Int, 99)
            .input('Tipo', sql.NVarChar, tipoPregunta) 
            .execute('dbo.SP_AgregarPregunta');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Formularios', `Agreg√≥ pregunta (${tipoPregunta}) a Form ID ${idFormulario}`);

        res.json({ mensaje: 'Pregunta agregada' });
    } catch (error) {
        console.error("Error al agregar pregunta:", error);
        res.status(500).json({ mensaje: 'Error al agregar pregunta' });
    }
};

export const borrarPreguntaIndividual = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Pregunta', sql.Int, id)
            .execute('dbo.SP_EliminarPregunta');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Formularios', `Elimin√≥ pregunta ID ${id}`);
        res.json({ mensaje: 'Pregunta eliminada' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al eliminar pregunta' });
    }
};

// --- ASIGNACI√ìN ---
export const asignarFormulario = async (req, res) => {
    const { idActivo, idFormulario } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Activo', sql.Int, idActivo)
            .input('ID_Formulario', sql.Int, idFormulario)
            .execute('dbo.SP_AsignarFormularioAActivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ASIGNAR', 'Core', `Asign√≥ Form ID ${idFormulario} a Activo ID ${idActivo}`);
        res.json({ mensaje: 'Asignaci√≥n correcta' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al asignar' });
    }
};

export const obtenerFormsDeActivo = async (req, res) => {
    const { idActivo } = req.params;
    try {
        const pool = await getConnection();
        
        // 1. DETECTAR QUI√âN PIDE LOS DATOS
        // Si req.usuario no existe (ej. error de token), asumimos rol vac√≠o
        const rolRaw = req.usuario ? req.usuario.rol : '';
        const rolUsuario = rolRaw.trim().toUpperCase();

        // Lista de roles con "Superpoderes"
        const esJefe = ['ADMINCALIDAD', 'SUPERADMIN', 'ADMINISTRADOR', 'ADMIN'].includes(rolUsuario);

        console.log(`[FormsActivo] Usuario: ${req.usuario?.nombre} | Rol: ${rolUsuario} | Es Jefe: ${esJefe}`);

        // 2. EJECUTAR EL SP (Ahora trae TODOS los formularios de la categor√≠a)
        const result = await pool.request()
            .input('ID_Activo', sql.Int, idActivo)
            .execute('dbo.SP_ObtenerFormsPorActivo');
            
        let formularios = result.recordset;

        // 3. FILTRAR POR SOFTWARE
        if (esJefe) {
            // SI ES ADMIN: Le mostramos todo (incluso los ocultos)
            res.json(formularios);
        } else {
            // SI ES COLABORADOR: Filtramos manualmente los que no son visibles
            const visibles = formularios.filter(f => f.Es_Visible_Colaborador === true || f.Es_Visible_Colaborador === 1);
            res.json(visibles);
        }

    } catch (error) {
        console.error("Error obteniendo forms del activo:", error);
        res.status(500).json({ mensaje: 'Error al obtener formularios del activo' });
    }
};
// --- TARJETAS DIN√ÅMICAS ---
export const listarTarjetas = async (req, res) => {
    const { modulo } = req.params; 
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('Modulo', sql.NVarChar, modulo)
            .execute('dbo.SP_ListarTarjetas');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al listar tarjetas' }); }
};

export const crearTarjeta = async (req, res) => {
    const { modulo, titulo, descripcion, color, icono } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Modulo', sql.NVarChar, modulo)
            .input('Titulo', sql.NVarChar, titulo)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Color', sql.NVarChar, color)
            .input('Icono', sql.NVarChar, icono)
            .execute('dbo.SP_CrearTarjeta');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Config', `Cre√≥ tarjeta ${titulo} en ${modulo}`);
        res.json({ mensaje: 'Tarjeta creada' });
    } catch (error) { res.status(500).json({ mensaje: 'Error al crear tarjeta' }); }
};

export const eliminarTarjeta = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Tarjeta', sql.Int, id).execute('dbo.SP_EliminarTarjeta');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Config', `Elimin√≥ tarjeta ID ${id}`);
        res.json({ mensaje: 'Tarjeta eliminada' });
    } catch (error) { res.status(500).json({ mensaje: 'Error al eliminar' }); }
};


==================================================================
ARCHIVO: backend\controllers\cronogramaController.js
==================================================================
import { getConnection, sql, configSGC } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// =====================================================================
// 1. GESTI√ìN DE CRONOGRAMAS (CABECERAS / CARPETAS)
// =====================================================================

export const crearCronograma = async (req, res) => {
    const { nombre, anio, descripcion, tipo = 'GENERAL' } = req.body;

    try {
        const pool = await sql.connect(configSGC);
        await pool.request()
            .input('Nombre', sql.NVarChar, nombre)
            .input('Anio', sql.Int, anio)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Tipo', sql.NVarChar, tipo)
            .execute('SP_CrearCronograma');

        res.json({ message: 'Cronograma creado correctamente' });
    } catch (error) {
        console.error("Error crearCronograma:", error);
        res.status(500).json({ message: error.message });
    }
};

export const listarCronogramas = async (req, res) => {
    const { tipo } = req.query;

    try {
        const pool = await sql.connect(configSGC);
        const result = await pool.request()
            .input('Tipo', sql.NVarChar, tipo || null)
            .execute('SP_ListarCronogramas');

        res.json(result.recordset);
    } catch (error) {
        console.error("Error listarCronogramas:", error);
        res.status(500).json({ message: error.message });
    }
};

export const eliminarCronograma = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Cronograma', sql.Int, id).execute('dbo.SP_EliminarCronograma');
        
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Cronogramas', `Elimin√≥ cronograma ID: ${id}`);
        res.json({ mensaje: 'Cronograma eliminado correctamente' });
    } catch (error) { 
        console.error("Error eliminarCronograma:", error);
        res.status(500).json({ mensaje: 'Error al eliminar cronograma' }); 
    }
};

// =====================================================================
// 2. GESTI√ìN DE ACTIVIDADES (TAREAS) E INTELIGENCIA DE PROGRAMAS
// =====================================================================

export const crearActividadAgendada = async (req, res) => {
    const { actividad, frecuencia, fechaInicio, idFormulario, programa } = req.body;
    
    try {
        const pool = await getConnection();
        await pool.request()
            .input('NombreActividad', sql.NVarChar, actividad)
            .input('Frecuencia', sql.NVarChar, frecuencia)
            .input('FechaInicio', sql.Date, new Date(fechaInicio)) 
            .input('ID_Formulario', sql.Int, idFormulario || null)
            .input('Programa', sql.NVarChar, programa || 'General')
            .execute('dbo.SP_CrearActividadProgramada'); 
            
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Cronogramas', `Agend√≥ actividad: ${actividad} para ${programa}`);
        res.json({ mensaje: 'Actividad programada y sincronizada.' });
    } catch (error) {
        console.error("Error crearActividadAgendada:", error);
        res.status(500).json({ mensaje: 'Error al agendar actividad' });
    }
};

export const crearActividad = async (req, res) => {
    const { idCronograma, nombreActividad, descripcion, responsable, fechaLimite } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Cronograma', sql.Int, idCronograma)
            .input('Nombre_Actividad', sql.NVarChar, nombreActividad)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Responsable', sql.NVarChar, responsable)
            .input('Fecha_Limite', sql.Date, fechaLimite)
            .execute('dbo.SP_CrearActividad');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Actividades', `Agreg√≥ actividad manual: ${nombreActividad}`);
        res.json({ mensaje: 'Actividad creada' });
    } catch (error) { 
        console.error("Error crearActividad:", error);
        res.status(500).json({ mensaje: 'Error al crear actividad' }); 
    }
};

export const editarActividad = async (req, res) => {
    const { id } = req.params;
    const { nombreActividad, descripcion, responsable, fechaLimite } = req.body;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Actividad', sql.Int, id)
            .input('Nombre_Actividad', sql.NVarChar, nombreActividad)
            .input('Descripcion', sql.NVarChar, descripcion)
            .input('Responsable', sql.NVarChar, responsable)
            .input('Fecha_Limite', sql.Date, fechaLimite)
            .execute('dbo.SP_EditarActividad');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Actividades', `Edit√≥ actividad ID: ${id}`);
        res.json({ mensaje: 'Actividad actualizada' });
    } catch (error) {
        console.error("Error editarActividad:", error);
        res.status(500).json({ mensaje: 'Error al editar actividad' });
    }
};

export const eliminarActividad = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Actividad', sql.Int, id).execute('dbo.SP_EliminarActividad');
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Actividades', `Elimin√≥ actividad ID: ${id}`);
        res.json({ mensaje: 'Actividad eliminada' });
    } catch (error) { 
        console.error("Error eliminarActividad:", error);
        res.status(500).json({ mensaje: 'Error al eliminar actividad' }); 
    }
};

export const obtenerActividades = async (req, res) => {
    const { idCronograma } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request().input('ID_Cronograma', sql.Int, idCronograma).execute('dbo.SP_ListarActividadesPorCronograma');
        res.json(result.recordset);
    } catch (error) { 
        console.error("Error obtenerActividades:", error);
        res.status(500).json({ mensaje: 'Error al obtener actividades' }); 
    }
};

export const obtenerTodasActividades = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ObtenerAgendaGlobal');
        res.json(result.recordset);
    } catch (error) {
        console.error("Error obtenerTodasActividades:", error);
        res.status(500).json({ mensaje: 'Error al cargar agenda global' });
    }
};

// =====================================================================
// 3. GESTI√ìN DE ESTADOS Y EVIDENCIAS
// =====================================================================

export const cambiarEstadoActividad = async (req, res) => {
    const { id } = req.params;
    const { nuevoEstado } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Actividad', sql.Int, id)
            .input('NuevoEstado', sql.NVarChar, nuevoEstado)
            .execute('dbo.SP_ActualizarEstadoActividad');
            
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ESTADO', 'Actividades', `Cambi√≥ estado ID ${id} a: ${nuevoEstado}`);
        res.json({ mensaje: 'Estado actualizado' });
    } catch (error) { 
        console.error("Error cambiarEstadoActividad:", error);
        res.status(500).json({ mensaje: 'Error al cambiar estado' }); 
    }
};

export const agregarSeguimiento = async (req, res) => {
    const { id } = req.params;
    const { nota } = req.body;
    
    // --- CORRECCI√ìN HOSTINGER: RUTA RELATIVA ---
    let urlEvidencia = null;
    if (req.file) {
        // Guardamos 'uploads/archivo.png' en lugar de 'http://localhost...'
        urlEvidencia = `uploads/${req.file.filename}`;
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Actividad', sql.Int, id)
            .input('Nota', sql.NVarChar, nota)
            .input('Url_Evidencia', sql.NVarChar, urlEvidencia)
            .execute('dbo.SP_AgregarSeguimientoActividad');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'SEGUIMIENTO', 'Actividades', `Agreg√≥ seguimiento a ID: ${id}`);
        res.json({ mensaje: 'Gesti√≥n guardada correctamente' });
    } catch (error) { 
        console.error("Error agregarSeguimiento:", error);
        res.status(500).json({ mensaje: 'Error al agregar seguimiento' }); 
    }
};

// =========================================================================
// 4. NUEVO ENDPOINT: VER EVIDENCIA (STREAMING)
// =========================================================================
export const verEvidenciaCronograma = (req, res) => {
    const { nombreArchivo } = req.params;

    // Validaci√≥n de seguridad (Directory Traversal)
    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    // Ruta f√≠sica en el servidor
    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Evidencia no encontrada en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\dashboardController.js
==================================================================
import { getConnection } from '../config/db.js';

export const obtenerResumen = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ObtenerResumenDashboard');
        
        // SQL devuelve m√∫ltiples tablas (recordsets)
        const contadores = result.recordsets[0][0]; // Primera tabla, primera fila
        const graficaSemanal = result.recordsets[1]; // Segunda tabla (Array)
        const graficaEstado = result.recordsets[2];  // Tercera tabla (Array)

        res.json({
            stats: contadores,
            chartData: graficaSemanal,
            pieData: graficaEstado
        });

    } catch (error) {
        console.error("Error obteniendo dashboard:", error);
        res.status(500).json({ mensaje: 'Error al cargar el resumen del dashboard' });
    }
};


==================================================================
ARCHIVO: backend\controllers\driveController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import { registrarLog } from '../libs/logger.js';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// 1. OBTENER CONTENIDO
// ==========================================
export const obtenerContenido = async (req, res) => {
    const { idCarpeta } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_CarpetaPadre', sql.Int, idCarpeta)
            .execute('dbo.SP_DRIVE_ObtenerContenido');
        res.json({
            carpetas: result.recordsets[0],
            archivos: result.recordsets[1]
        });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al cargar contenido' });
    }
};

// ==========================================
// 2. CREAR CARPETA
// ==========================================
export const crearCarpeta = async (req, res) => {
    const { nombre, idPadre } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Nombre', sql.NVarChar, nombre)
            .input('ID_Padre', sql.Int, idPadre)
            .execute('dbo.SP_DRIVE_CrearCarpeta');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Drive', `Cre√≥ carpeta: ${nombre}`);
        res.json({ mensaje: 'Carpeta creada' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al crear carpeta' });
    }
};

// ==========================================
// 3. ELIMINAR CARPETA
// ==========================================
export const eliminarCarpeta = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Carpeta', sql.Int, id)
            .execute('dbo.SP_DRIVE_EliminarCarpeta');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Drive', `Elimin√≥ carpeta ID: ${id}`);
        res.json({ mensaje: 'Carpeta eliminada' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al eliminar carpeta' });
    }
};

// ==========================================
// 4. SUBIR ARCHIVO
// ==========================================
export const subirArchivoDrive = async (req, res) => {
    const { idCarpeta } = req.body;
    if (!req.file) return res.status(400).json({ mensaje: 'No hay archivo' });

    // Guardamos ruta relativa
    const url = `uploads/${req.file.filename}`;
    
    // Detecci√≥n de Tipo
    const tipoMime = req.file.mimetype.toLowerCase(); 
    let tipoOrigen = 'Archivo';
    if (tipoMime.includes('sheet') || tipoMime.includes('excel') || tipoMime.includes('xls')) tipoOrigen = 'Excel';
    else if (tipoMime.includes('presentation') || tipoMime.includes('powerpoint')) tipoOrigen = 'PowerPoint';
    else if (tipoMime.includes('word') || tipoMime.includes('doc')) tipoOrigen = 'Word';
    else if (tipoMime.includes('pdf')) tipoOrigen = 'PDF';
    else if (tipoMime.includes('image')) tipoOrigen = 'Imagen';
    else if (tipoMime.includes('video')) tipoOrigen = 'Video';

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Carpeta', sql.Int, idCarpeta)
            .input('Nombre', sql.NVarChar, req.file.originalname)
            .input('Url', sql.NVarChar, url)
            .input('TipoOrigen', sql.NVarChar, tipoOrigen) 
            .execute('dbo.SP_DRIVE_SubirArchivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'SUBIR', 'Drive', `Subi√≥ archivo: ${req.file.originalname}`);
        res.json({ mensaje: 'Archivo guardado' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al subir archivo' });
    }
};

// ==========================================
// 5. ELIMINAR ARCHIVO
// ==========================================
export const eliminarArchivo = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        // 1. Obtener nombre para borrar f√≠sico
        const result = await pool.request().input('ID_Doc', sql.Int, id).execute('dbo.SP_DRIVE_ObtenerArchivo');
        
        if (result.recordset.length > 0) {
            const archivo = result.recordset[0];
            const nombreEnDisco = archivo.Url_Archivo.split('/').pop();
            const rutaFisica = path.resolve(__dirname, '../uploads', nombreEnDisco);
            try { if (fs.existsSync(rutaFisica)) fs.unlinkSync(rutaFisica); } catch(e) { console.warn('No se pudo borrar f√≠sico:', e); }
        }

        // 2. Borrar de BD
        await pool.request()
            .input('ID_Doc', sql.Int, id)
            .execute('dbo.SP_DRIVE_EliminarArchivo');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Drive', `Elimin√≥ archivo ID: ${id}`);
        res.json({ mensaje: 'Archivo eliminado' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al eliminar archivo' });
    }
};

// ==========================================
// 6. DESCARGAR ARCHIVO
// ==========================================
export const descargarArchivo = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Doc', sql.Int, id)
            .execute('dbo.SP_DRIVE_ObtenerArchivo');

        if (result.recordset.length === 0) {
            return res.status(404).json({ mensaje: 'Archivo no encontrado' });
        }

        const archivo = result.recordset[0];
        const nombreArchivoEnDisco = archivo.Url_Archivo.split('/').pop();
        const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivoEnDisco);

        if (fs.existsSync(rutaFisica)) {
            await registrarLog(req.usuario.nombre, req.usuario.rol, 'DESCARGAR', 'Drive', `Descarg√≥ archivo: ${archivo.Nombre}`);
            res.download(rutaFisica, archivo.Nombre);
        } else {
            res.status(404).json({ mensaje: 'El archivo f√≠sico no existe en el servidor' });
        }

    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al descargar' });
    }
};

// ==========================================
// 7. NUEVO: VER ARCHIVO (STREAMING H√çBRIDO)
// ==========================================
// Correcci√≥n: Soporta tanto ID num√©rico (BD) como Nombre de Archivo directo
export const verArchivo = async (req, res) => {
    const { id } = req.params; // 'id' puede ser "15" o "archivo-1234.pdf"

    // --- OPCI√ìN A: ES UN NOMBRE DE ARCHIVO DIRECTO ---
    // Si contiene punto (extensi√≥n) o NO es un n√∫mero, asumimos que es el nombre f√≠sico
    if (isNaN(id) || id.includes('.')) {
        const nombreArchivo = id;
        
        // Seguridad b√°sica
        if (nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
            return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
        }

        const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

        if (fs.existsSync(rutaFisica)) {
            // Detectar MIME type b√°sico
            const ext = path.extname(nombreArchivo).toLowerCase();
            let contentType = 'application/octet-stream';
            if (ext === '.pdf') contentType = 'application/pdf';
            else if (['.jpg', '.jpeg', '.png'].includes(ext)) contentType = 'image/jpeg';

            res.setHeader('Content-Type', contentType);
            res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);
            return res.sendFile(rutaFisica);
        } else {
            console.error(`Archivo f√≠sico no encontrado: ${rutaFisica}`);
            return res.status(404).json({ mensaje: 'Archivo f√≠sico no encontrado' });
        }
    }

    // --- OPCI√ìN B: ES UN ID DE BASE DE DATOS (L√≥gica Original) ---
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Doc', sql.Int, id)
            .execute('dbo.SP_DRIVE_ObtenerArchivo');

        if (result.recordset.length === 0) return res.status(404).json({ mensaje: 'No encontrado en BD' });

        const archivo = result.recordset[0];
        const nombreDisco = archivo.Url_Archivo.split('/').pop();
        const rutaFisica = path.resolve(__dirname, '../uploads', nombreDisco);

        if (fs.existsSync(rutaFisica)) {
            res.setHeader('Content-Disposition', `inline; filename="${archivo.Nombre}"`);
            res.sendFile(rutaFisica);
        } else {
            res.status(404).json({ mensaje: 'Archivo f√≠sico no encontrado' });
        }
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al visualizar' });
    }
};


==================================================================
ARCHIVO: backend\controllers\externosController.js
==================================================================
import { getConnectionRRHH, getConnectionERP } from '../config/db.js';

// --- DESDE RRHH (10.10.10.8) ---

// 1. Obtener Maquinistas (Oficio 23)
export const getMaquinistas = async (req, res) => {
    try {
        const pool = await getConnectionRRHH();
        const result = await pool.request().query(`
            SELECT
                rh_co_contratos.cod_contrato,
                rh_recursos.nombres,
                rh_recursos.apellidos
            FROM rh_co_contratos
            INNER JOIN rh_recursos ON rh_co_contratos.id_recurso = rh_recursos.id_recurso
            INNER JOIN rh_oficios ON rh_co_contratos.id_oficio = rh_oficios.id_oficio
            WHERE rh_co_contratos.estado = '1'
              AND cod_oficio = '23'
        `);

        // Formateamos
        const data = result.recordset.map(m => ({
            id: m.cod_contrato,
            nombre: `${m.nombres} ${m.apellidos}`.trim()
        }));
        res.json(data);
    } catch (error) {
        console.error(error);
        res.status(500).json([]);
    }
};

// 2. Obtener Selladores (Oficio 24)
export const getSelladores = async (req, res) => {
    try {
        const pool = await getConnectionRRHH();
        const result = await pool.request().query(`
            SELECT
                rh_co_contratos.cod_contrato,
                rh_recursos.nombres,
                rh_recursos.apellidos
            FROM rh_co_contratos
            INNER JOIN rh_recursos ON rh_co_contratos.id_recurso = rh_recursos.id_recurso
            INNER JOIN rh_oficios ON rh_co_contratos.id_oficio = rh_oficios.id_oficio
            WHERE rh_co_contratos.estado = '1'
              AND cod_oficio = '24'
        `);

        const data = result.recordset.map(s => ({
            id: s.cod_contrato,
            nombre: `${s.nombres} ${s.apellidos}`.trim()
        }));
        res.json(data);
    } catch (error) {
        console.error(error);
        res.status(500).json([]);
    }
};

// --- DESDE ERP (10.10.10.32) ---

// 3. Obtener Productos (Materia Prima)
export const getProductos = async (req, res) => {
    try {
        const pool = await getConnectionERP();
        
        // NOTA: Multiplicamos rumfactor * 1000 asumiendo que el ERP lo tiene en Kilos (0.5 kg -> 500g)
        // Si en tu ERP el factor ya est√° en gramos, quita el "* 1000".
        const result = await pool.request().query(`
            SELECT 
                i.itecodigo, 
                i.itedesclarg,
                (r.rumfactor * 1000) AS peso_gramos 
            FROM [dbo].[in_items] i
            LEFT JOIN [dbo].[in_relaunidmedi] r 
                ON i.iteuma = r.rumunidmedide 
                AND r.rumcompania = '01' 
            WHERE (i.itecompania LIKE '%01%')
              AND (i.itetipoitem LIKE '%PRO%')
            ORDER BY i.itedesclarg ASC
        `);

        const data = result.recordset.map(p => ({
            codigo: p.itecodigo,
            // Quitamos espacios extra al nombre
            descripcion: p.itedesclarg.trim(), 
            // Si el peso es null o 0, enviamos '', si no, lo enviamos redondeado (sin decimales .00)
            peso: p.peso_gramos ? Math.round(p.peso_gramos) : '' 
        }));

        res.json(data);
    } catch (error) {
        console.error("Error en getProductos:", error);
        res.status(500).json([]);
    }
};

// 4. Obtener Proveedores
export const getProveedores = async (req, res) => {
    try {
        const pool = await getConnectionERP();
        
        // MODIFICACI√ìN: Se eliminaron los filtros 'tgeactivecono' para traer todos
        const result = await pool.request().query(`
            SELECT tgecodigo, tgenombcomp
            FROM [dbo].[un_tercegener]
            WHERE [tgecompania] LIKE '%01%' 
            -- Se elimin√≥ el filtro de c√≥digos espec√≠ficos (2013, 2221, etc.)
            ORDER BY tgenombcomp ASC
        `);

        const data = result.recordset.map(p => ({
            codigo: p.tgecodigo,
            nombre: p.tgenombcomp
        }));
        res.json(data);
    } catch (error) {
        console.error(error);
        res.status(500).json([]);
    }
};


// 5. Obtener Clientes (Para PMIR - Residuos)
// ...
export const getClientes = async (req, res) => {
    try {
        const pool = await getConnectionERP(); // Conexi√≥n a la base externa
        
        // MODIFICACI√ìN: Quitamos "TOP (1000)" para que traiga TODO el universo de clientes
        const result = await pool.request().query(`
            SELECT tclcodigo, tclnombre
            FROM [SSF_ELTRECE].[dbo].[un_terceclien]
            WHERE [tclcompania] LIKE '%01%' 
            ORDER BY tclnombre ASC
        `);

        const data = result.recordset.map(c => ({
            codigo: c.tclcodigo,
            nombre: c.tclnombre 
        }));
        
        res.json(data);
    } catch (error) {
        console.error("Error obteniendo clientes:", error);
        res.status(500).json([]);
    }
};


==================================================================
ARCHIVO: backend\controllers\notificationController.js
==================================================================
import { getConnection, sql } from '../config/db.js';

// ==========================================
// 1. OBTENER NOTIFICACIONES
// ==========================================
export const obtenerNotificaciones = async (req, res) => {
    try {
        const pool = await getConnection();
        // Obtenemos rol y nombre del token del usuario (middleware checkAuth)
        const { rol, nombre } = req.usuario; 

        const result = await pool.request()
            .input('RolUsuario', sql.NVarChar, rol)
            .input('NombreUsuario', sql.NVarChar, nombre)
            .execute('dbo.SP_ObtenerNotificaciones');

        res.json(result.recordset);
    } catch (error) {
        console.error("Error obteniendo notificaciones:", error);
        res.status(500).json({ mensaje: 'Error al obtener notificaciones' });
    }
};

// ==========================================
// 2. ELIMINAR NOTIFICACI√ìN (Borrado F√≠sico)
// ==========================================
export const eliminarNotificacion = async (req, res) => {
    const { id } = req.params;

    // Protecci√≥n: Las alertas con ID negativo son calculadas por el sistema (Vencimientos)
    // y no est√°n en la tabla, por lo que no se pueden borrar con DELETE.
    if (parseInt(id) < 0) {
        return res.status(400).json({ 
            mensaje: 'Las alertas autom√°ticas (vencimientos) desaparecen solas al gestionar la actividad.' 
        });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Notificacion', sql.Int, id)
            .execute('dbo.SP_EliminarNotificacion');
        
        res.json({ mensaje: 'Notificaci√≥n eliminada correctamente' });
    } catch (error) {
        console.error("Error eliminando notificaci√≥n:", error);
        res.status(500).json({ mensaje: 'Error al eliminar la notificaci√≥n' });
    }
};

// ==========================================
// 3. MARCAR COMO LE√çDA (Opcional)
// ==========================================
// Nota: Actualmente tu sistema usa "Eliminar" para quitarlas, 
// pero dejamos esto por si quisieras solo marcarla como vista sin borrarla.
export const marcarLeida = async (req, res) => {
    const { id } = req.params;
    
    if (parseInt(id) < 0) return res.json({ mensaje: 'Alerta temporal, no requiere marca.' });

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Notificacion', sql.Int, id)
            .execute('dbo.SP_MarcarNotificacionLeida');
        res.json({ mensaje: 'Notificaci√≥n marcada como le√≠da' });
    } catch (error) {
        console.error("Error marcando le√≠da:", error);
        res.status(500).json({ mensaje: 'Error al actualizar estado' });
    }
};


==================================================================
ARCHIVO: backend\controllers\pesosController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const safeDecimal = (val) => {
    if (!val) return 0;
    const num = parseFloat(val);
    if (isNaN(num)) return 0;
    return parseFloat(num.toFixed(2));
};

// --- REGISTRAR NUEVO CONTROL ---
export const registrarControlPesos = async (req, res) => {
    let { cabecera, muestras } = req.body;
    const archivo = req.file; 

    try {
        if (typeof cabecera === 'string') cabecera = JSON.parse(cabecera);
        if (typeof muestras === 'string') muestras = JSON.parse(muestras);

        if (!cabecera || !muestras || muestras.length === 0) {
            return res.status(400).json({ mensaje: 'Datos incompletos.' });
        }

        const fechaVencimientoDate = new Date(cabecera.fechaVencimiento);

        // --- CORRECCI√ìN HOSTINGER ---
        const urlEvidencia = archivo ? `uploads/${archivo.filename}` : null;

        const pool = await getConnection();
        const transaction = new sql.Transaction(pool);

        await transaction.begin();

        const min = safeDecimal(cabecera.limiteInferior);
        const max = safeDecimal(cabecera.limiteSuperior);
        
        const hayDefectosPeso = muestras.some(m => {
            if (m.peso === '' || m.peso === null) return false;
            const p = parseFloat(m.peso);
            return p < min || p > max;
        });

        const falloSellado = (
            !cabecera.selladoInferior || 
            !cabecera.selladoSuperior || 
            !cabecera.selladoVertical || 
            !cabecera.selladoLoteado
        );
        
        const estadoFinal = (hayDefectosPeso || falloSellado) ? 'Rechazado' : 'Aprobado';

        const requestCabecera = new sql.Request(transaction); 
        const resultCabecera = await requestCabecera
            .input('Lote', sql.NVarChar, cabecera.lote)
            .input('Fecha_Vencimiento', sql.Date, fechaVencimientoDate) 
            .input('Producto', sql.NVarChar, cabecera.producto)
            .input('Peso_Nominal', sql.Decimal(10,2), safeDecimal(cabecera.pesoNominal))
            .input('Proveedor', sql.NVarChar, cabecera.proveedor)
            .input('Maquinista', sql.NVarChar, cabecera.maquinista)
            .input('Sellador', sql.NVarChar, cabecera.sellador)
            .input('Nombre_Lamina', sql.NVarChar, cabecera.nombreLamina)
            .input('Golpes_Minuto', sql.Int, parseInt(cabecera.golpesMinuto) || 0)
            .input('Temp_Vertical', sql.Decimal(5,2), safeDecimal(cabecera.tempVertical))
            .input('Temp_Horiz_Sup', sql.Decimal(5,2), safeDecimal(cabecera.tempHorizSup))
            .input('Temp_Horiz_Inf', sql.Decimal(5,2), safeDecimal(cabecera.tempHorizInf))
            .input('Lote_MP', sql.NVarChar, cabecera.loteMP)
            .input('Lote_Lamina', sql.NVarChar, cabecera.loteLamina)
            .input('Limite_Inferior', sql.Decimal(10,2), min)
            .input('Limite_Superior', sql.Decimal(10,2), max)
            .input('ID_Usuario', sql.Int, req.usuario.id)
            .input('Estado_Final', sql.NVarChar, estadoFinal)
            .input('Sellado_Inferior', sql.Bit, cabecera.selladoInferior ? 1 : 0)
            .input('Sellado_Superior', sql.Bit, cabecera.selladoSuperior ? 1 : 0)
            .input('Sellado_Vertical', sql.Bit, cabecera.selladoVertical ? 1 : 0)
            .input('Sellado_Loteado', sql.Bit, cabecera.selladoLoteado ? 1 : 0)
            .input('Url_Evidencia', sql.NVarChar, urlEvidencia)
            .execute('dbo.SP_CrearCabeceraControl');

        const idControl = resultCabecera.recordset[0].ID_Generado;

        for (const muestra of muestras) {
            const peso = safeDecimal(muestra.peso);
            const esConforme = (peso >= min && peso <= max);

            const requestDetalle = new sql.Request(transaction);
            await requestDetalle
                .input('ID_Control', sql.Int, idControl)
                .input('Numero_Muestra', sql.Int, muestra.index)
                .input('Valor_Peso', sql.Decimal(10,2), peso)
                .input('Es_Conforme', sql.Bit, esConforme)
                .execute('dbo.SP_InsertarDetalleControl');
        }

        await transaction.commit();
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'PESOS', `Lote ${cabecera.lote} registrado.`);

        res.status(201).json({ mensaje: 'Control guardado correctamente', id: idControl });

    } catch (error) {
        console.error("Error Transacci√≥n Pesos:", error);
        if (typeof transaction !== 'undefined' && transaction._aborted === false) {
            await transaction.rollback();
        }
        res.status(500).json({ mensaje: 'Error al guardar.', error: error.message });
    }
};

// ... listarControles y obtenerDetalleControl quedan igual ...
export const listarControles = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarControlesPesos');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al listar controles' });
    }
};

export const obtenerDetalleControl = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Control', sql.Int, id)
            .execute('dbo.SP_ObtenerDetalleControlPesos');
            
        if (!result.recordsets[0] || result.recordsets[0].length === 0) {
            return res.status(404).json({ mensaje: 'Control no encontrado' });
        }

        res.json({
            cabecera: result.recordsets[0][0],
            muestras: result.recordsets[1]
        });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener detalle' });
    }
};

// ==========================================
// NUEVO: VER EVIDENCIA PESOS (STREAMING)
// ==========================================
export const verEvidenciaPesos = (req, res) => {
    const { nombreArchivo } = req.params;

    if (!nombreArchivo || nombreArchivo.includes('..')) {
        return res.status(400).json({ mensaje: 'Archivo inv√°lido' });
    }

    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Foto no encontrada' });
    }
};


==================================================================
ARCHIVO: backend\controllers\pmirController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Helper para decimales seguros
const safeDecimal = (val) => {
    if (!val) return 0;
    const num = parseFloat(val);
    return isNaN(num) ? 0 : parseFloat(num.toFixed(2));
};

export const getRecolecciones = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().query("SELECT * FROM RecoleccionResiduos ORDER BY Fecha DESC");
        res.json(result.recordset);
    } catch (error) {
        console.error("Error al obtener recolecciones:", error);
        res.status(500).send(error.message);
    }
};

export const createRecoleccion = async (req, res) => {
    try {
        const { tipoMaterial, fecha, cantidad, cliente, peso } = req.body;
        
        if (!tipoMaterial || !fecha || !cliente) {
            return res.status(400).json({ msg: 'Faltan campos obligatorios.' });
        }

        // --- CORRECCI√ìN HOSTINGER: RUTA RELATIVA ---
        let urlDoc = null;
        if (req.file) {
            // Guardamos "uploads/archivo.pdf"
            urlDoc = `uploads/${req.file.filename}`;
        }

        const pool = await getConnection();
        await pool.request()
            .input('TipoMaterial', sql.NVarChar, tipoMaterial)
            .input('Fecha', sql.Date, fecha)
            .input('Cantidad', sql.Int, parseInt(cantidad) || 0) 
            .input('Cliente', sql.NVarChar, cliente)
            .input('Peso', sql.Decimal(10,2), safeDecimal(peso)) 
            .input('Url_Documento', sql.NVarChar, urlDoc) 
            .query(`
                INSERT INTO RecoleccionResiduos 
                (TipoMaterial, Fecha, Cantidad, Cliente, Peso, Url_Documento)
                VALUES 
                (@TipoMaterial, @Fecha, @Cantidad, @Cliente, @Peso, @Url_Documento)
            `);

        res.json({ msg: 'Registro creado exitosamente' });
    } catch (error) {
        console.error("Error al crear recolecci√≥n:", error);
        res.status(500).json({ message: error.message || 'Error interno del servidor' });
    }
};

// ==========================================
// VER EVIDENCIA PMIR (STREAMING ROBUSTO)
// ==========================================
// ==========================================
export const verEvidenciaPMIR = (req, res) => {
    const { nombreArchivo } = req.params;

    console.log(`üîç [PMIR] Solicitando archivo: ${nombreArchivo}`);

    // Limpieza b√°sica de seguridad
    if (!nombreArchivo || nombreArchivo.includes('..')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const projectRoot = process.cwd(); 
    
    // Rutas posibles donde puede estar el archivo
    const posiblesRutas = [
        path.join(projectRoot, 'uploads', nombreArchivo),
        path.join(projectRoot, 'backend', 'uploads', nombreArchivo),
        path.join(__dirname, '../../uploads', nombreArchivo)
    ];

    let archivoEncontrado = null;

    // Buscar en todas las rutas posibles
    for (const ruta of posiblesRutas) {
        if (fs.existsSync(ruta)) {
            archivoEncontrado = ruta;
            break;
        }
    }

    if (archivoEncontrado) {
        console.log(`‚úÖ [PMIR] Archivo encontrado en: ${archivoEncontrado}`);
        
        // 1. Detectar extensi√≥n manualmente si no usas librer√≠as
        const ext = path.extname(archivoEncontrado).toLowerCase();
        let contentType = 'application/octet-stream'; // Por defecto

        if (ext === '.pdf') contentType = 'application/pdf';
        else if (ext === '.jpg' || ext === '.jpeg') contentType = 'image/jpeg';
        else if (ext === '.png') contentType = 'image/png';

        // 2. Establecer cabeceras para que el navegador sepa qu√© hacer
        res.setHeader('Content-Type', contentType);
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`); // 'inline' para ver, 'attachment' para descargar

        // 3. Enviar archivo
        res.sendFile(archivoEncontrado);
    } else {
        console.error(`‚ùå [PMIR] Archivo NO encontrado. Buscado en:`, posiblesRutas);
        res.status(404).json({ mensaje: 'Documento no encontrado en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\proveedoresController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- OBTENER TODAS LAS EVALUACIONES ---
export const getEvaluaciones = async (req, res) => {
    try {
        const pool = await getConnection();
        // Ordenamos por fecha descendente para ver las √∫ltimas primero
        const result = await pool.request().query('SELECT * FROM Evaluaciones_Proveedores ORDER BY Fecha_Registro DESC');
        res.json(result.recordset);
    } catch (error) {
        console.error(error);
        res.status(500).send(error.message);
    }
};

// --- OBTENER UNA EVALUACI√ìN CON DETALLES ---
export const getEvaluacionById = async (req, res) => {
    try {
        const { id } = req.params;
        const pool = await getConnection();
        
        const cabecera = await pool.request()
            .input('Id', sql.Int, id)
            .query('SELECT * FROM Evaluaciones_Proveedores WHERE ID_Evaluacion = @Id');

        const detalles = await pool.request()
            .input('Id', sql.Int, id)
            .query('SELECT * FROM Detalles_Evaluacion_Proveedores WHERE ID_Evaluacion = @Id');

        if (cabecera.recordset.length === 0) return res.status(404).json({ msg: 'Evaluaci√≥n no encontrada' });

        res.json({
            datos: cabecera.recordset[0],
            items: detalles.recordset
        });
    } catch (error) {
        res.status(500).send(error.message);
    }
};

// --- CREAR NUEVA EVALUACI√ìN (SIN SUBIDA DE ARCHIVO INICIAL) ---
export const createEvaluacion = async (req, res) => {
    // Extraemos solo los datos del formulario
    const { 
        empresa, ciudad, registroSanitario, producto, conceptoSanitario, 
        fichasTecnicas, objeto, esCertificada, cualCertificacion,
        puntajeObtenido, puntajePosible, porcentajeFinal, conceptoFinal,
        realizadoPor, recibidoPor, observaciones,
        items: itemsString // Viene como string JSON
    } = req.body;

    // Parsear los items (Checklist)
    let items = [];
    try {
        items = JSON.parse(itemsString);
    } catch (error) {
        console.error("Error parseando items:", error);
        return res.status(400).json({ msg: 'El formato de la lista de chequeo no es v√°lido' });
    }

    const pool = await getConnection();
    const transaction = new sql.Transaction(pool);

    try {
        await transaction.begin();

        // 1. Insertar Cabecera (SIN Url_Carta_Invima)
        const requestCabecera = new sql.Request(transaction);
        const resultCabecera = await requestCabecera
            .input('Empresa', sql.NVarChar, empresa)
            .input('Ciudad', sql.NVarChar, ciudad)
            .input('Registro_Sanitario', sql.NVarChar, registroSanitario)
            .input('Producto_Provee', sql.NVarChar, producto)
            .input('Concepto_Sanitario', sql.NVarChar, conceptoSanitario)
            .input('Fichas_Tecnicas', sql.Bit, fichasTecnicas === 'true' || fichasTecnicas === true)
            .input('Objeto_Contrato', sql.NVarChar, objeto)
            .input('Es_Certificada', sql.Bit, esCertificada === 'true' || esCertificada === true)
            .input('Cual_Certificacion', sql.NVarChar, cualCertificacion)
            .input('Puntaje_Obtenido', sql.Int, puntajeObtenido)
            .input('Puntaje_Posible', sql.Int, puntajePosible)
            .input('Porcentaje_Final', sql.Decimal(5, 2), porcentajeFinal)
            .input('Concepto_Final', sql.NVarChar, conceptoFinal)
            .input('Realizado_Por', sql.NVarChar, realizadoPor)
            .input('Recibido_Por', sql.NVarChar, recibidoPor)
            .input('Observaciones_Generales', sql.NVarChar, observaciones)
            .query(`
                INSERT INTO Evaluaciones_Proveedores 
                (Empresa, Ciudad, Registro_Sanitario, Producto_Provee, Concepto_Sanitario, Fichas_Tecnicas, Objeto_Contrato, Es_Certificada, Cual_Certificacion, Puntaje_Obtenido, Puntaje_Posible, Porcentaje_Final, Concepto_Final, Realizado_Por, Recibido_Por, Observaciones_Generales)
                OUTPUT INSERTED.ID_Evaluacion
                VALUES 
                (@Empresa, @Ciudad, @Registro_Sanitario, @Producto_Provee, @Concepto_Sanitario, @Fichas_Tecnicas, @Objeto_Contrato, @Es_Certificada, @Cual_Certificacion, @Puntaje_Obtenido, @Puntaje_Posible, @Porcentaje_Final, @Concepto_Final, @Realizado_Por, @Recibido_Por, @Observaciones_Generales)
            `);

        const idEvaluacion = resultCabecera.recordset[0].ID_Evaluacion;

        // 2. Insertar Detalles (Items de la lista de chequeo)
        for (const item of items) {
            const requestDetalle = new sql.Request(transaction);
            await requestDetalle
                .input('ID_Evaluacion', sql.Int, idEvaluacion)
                .input('Pregunta', sql.NVarChar, item.pregunta)
                .input('Calificacion', sql.Int, item.calificacion) // 0 o 2
                .input('Es_NA', sql.Bit, item.esNA)
                .input('Observacion', sql.NVarChar, item.observacion || '')
                .query(`
                    INSERT INTO Detalles_Evaluacion_Proveedores (ID_Evaluacion, Pregunta, Calificacion, Es_NA, Observacion)
                    VALUES (@ID_Evaluacion, @Pregunta, @Calificacion, @Es_NA, @Observacion)
                `);
        }

        await transaction.commit();
        res.json({ msg: 'Evaluaci√≥n registrada correctamente', id: idEvaluacion });

    } catch (error) {
        if (transaction) await transaction.rollback();
        console.error("Error en createEvaluacion:", error);
        res.status(500).send('Error al guardar la evaluaci√≥n en base de datos');
    }
};

// --- SUBIR CARTA INVIMA POSTERIORMENTE ---
export const uploadCartaInvima = async (req, res) => {
    const { id } = req.params;
    
    if (!req.file) {
        return res.status(400).json({ msg: 'No se ha subido ning√∫n archivo' });
    }

    // --- CORRECCI√ìN HOSTINGER: RUTA RELATIVA ---
    // Guardamos 'uploads/archivo.pdf'
    const urlCarta = `uploads/${req.file.filename}`;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('Id', sql.Int, id)
            .input('Url', sql.NVarChar, urlCarta)
            .query('UPDATE Evaluaciones_Proveedores SET Url_Carta_Invima = @Url WHERE ID_Evaluacion = @Id');

        res.json({ msg: 'Carta INVIMA subida correctamente', url: urlCarta });
    } catch (error) {
        console.error(error);
        res.status(500).json({ msg: 'Error al actualizar la base de datos' });
    }
};

// ==========================================
// NUEVO: VER CARTA INVIMA (STREAMING)
// ==========================================
export const verCartaInvima = async (req, res) => {
    const { nombreArchivo } = req.params;

    // Validaci√≥n de seguridad
    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    // Ruta f√≠sica
    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.setHeader('Content-Type', 'application/pdf'); // Asumimos PDF generalmente
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Archivo no encontrado en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\recallController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// --- OBTENER TODAS LAS SALIDAS ---
export const getSalidas = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .query('SELECT * FROM Recall_Salidas ORDER BY Fecha_Envio DESC');
        
        res.json(result.recordset);
    } catch (error) {
        console.error('Error al obtener salidas:', error);
        res.status(500).json({ message: 'Error interno del servidor' });
    }
};

// --- CREAR NUEVA SALIDA ---
export const createSalida = async (req, res) => {
    const { producto, lote, cliente, cantidad, observaciones, fecha_envio } = req.body;
    
    // --- CORRECCI√ìN HOSTINGER ---
    // Guardamos nombre de archivo simple para evitar problemas de rutas absolutas en BD
    const urlDocumento = req.file ? `uploads/${req.file.filename}` : null;

    try {
        const pool = await getConnection();
        
        await pool.request()
            .input('Producto', sql.NVarChar, producto)
            .input('Lote', sql.NVarChar, lote)
            .input('Cliente', sql.NVarChar, cliente)
            .input('Cantidad', sql.Decimal(18, 2), cantidad)
            .input('Observaciones', sql.NVarChar, observaciones)
            .input('Url_Documento', sql.NVarChar, urlDocumento)
            .input('Fecha_Envio', sql.DateTime, fecha_envio || new Date())
            .query(`
                INSERT INTO Recall_Salidas (
                    Producto, Lote, Cliente, Cantidad, Observaciones, Url_Documento, Fecha_Envio, Fecha_Registro
                )
                VALUES (
                    @Producto, @Lote, @Cliente, @Cantidad, @Observaciones, @Url_Documento, @Fecha_Envio, GETDATE()
                )
            `);

        res.status(201).json({ message: 'Salida registrada correctamente' });
    } catch (error) {
        console.error('Error al crear salida:', error);
        res.status(500).json({ message: 'Error al registrar la salida' });
    }
};

// ==========================================
// VER DOCUMENTO SALIDA (STREAMING ROBUSTO)
// ==========================================
export const verDocumentoSalida = (req, res) => {
    const { nombreArchivo } = req.params;

    console.log(`üîç [RECALL] Buscando archivo: ${nombreArchivo}`);

    // Seguridad b√°sica
    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Archivo inv√°lido' });
    }

    const projectRoot = process.cwd();

    // 1. Definir posibles ubicaciones (Local, Producci√≥n Root, Producci√≥n Subfolder)
    const posiblesRutas = [
        path.join(projectRoot, 'uploads', nombreArchivo),
        path.join(projectRoot, 'backend', 'uploads', nombreArchivo),
        path.resolve(__dirname, '../../uploads', nombreArchivo)
    ];

    let archivoEncontrado = null;

    // 2. Buscar archivo
    for (const ruta of posiblesRutas) {
        if (fs.existsSync(ruta)) {
            archivoEncontrado = ruta;
            break;
        }
    }

    if (archivoEncontrado) {
        console.log(`‚úÖ [RECALL] Archivo encontrado en: ${archivoEncontrado}`);

        // 3. Detectar tipo MIME manualmente para evitar pantalla blanca
        const ext = path.extname(archivoEncontrado).toLowerCase();
        let contentType = 'application/octet-stream';

        if (ext === '.pdf') contentType = 'application/pdf';
        else if (ext === '.jpg' || ext === '.jpeg') contentType = 'image/jpeg';
        else if (ext === '.png') contentType = 'image/png';

        // 4. Configurar cabeceras
        res.setHeader('Content-Type', contentType);
        // 'inline' permite ver en el navegador, 'attachment' fuerza descarga
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);

        // 5. Enviar stream
        res.sendFile(archivoEncontrado);
    } else {
        console.error(`‚ùå [RECALL] Archivo NO encontrado. Buscado en:`, posiblesRutas);
        res.status(404).json({ mensaje: 'Documento no encontrado' });
    }
};


==================================================================
ARCHIVO: backend\controllers\reportesController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import { enviarCorreoNotificacion } from '../libs/email.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// 1. CREAR REPORTE (Con Foto, Notificaci√≥n y Correo)
// ==========================================
export const crearReporte = async (req, res) => {
    try {
        const { idActivo, idFormulario, respuestas, observaciones } = req.body;
        const idUsuario = req.usuario.id;

        if (!idActivo || !idFormulario || !respuestas) {
            return res.status(400).json({ mensaje: 'Faltan datos obligatorios' });
        }

        let respuestasParsed;
        try {
            respuestasParsed = JSON.parse(respuestas);
        } catch (e) {
            return res.status(400).json({ mensaje: 'Formato de respuestas inv√°lido' });
        }

        // --- CORRECCI√ìN HOSTINGER: RUTA RELATIVA ---
        let urlEvidencia = null;
        if (req.file) {
            // Guardamos 'uploads/archivo.jpg'
            urlEvidencia = `uploads/${req.file.filename}`;
        }

        // Validaci√≥n robusta de fallas
        const tieneFallas = respuestasParsed.some(r => {
            const tipoNormalizado = (r.tipo || '').toUpperCase();
            return tipoNormalizado === 'BOOL' && (r.cumple === false || r.cumple === 'false' || r.cumple === 0);
        });
        
        const pool = await getConnection();

        // 1. Insertar Cabecera
        const resultHeader = await pool.request()
            .input('ID_Usuario', sql.Int, idUsuario)
            .input('ID_Activo', sql.Int, idActivo)
            .input('ID_Formulario', sql.Int, idFormulario)
            .input('TieneFallas', sql.Bit, tieneFallas)
            .input('UrlEvidencia', sql.NVarChar, urlEvidencia)
            .input('Observaciones', sql.NVarChar, observaciones || '')
            .output('NewId', sql.Int)
            .execute('dbo.SP_CrearReporteCabecera');
        
        const idReporte = resultHeader.output.NewId;

        // 2. Insertar Detalles
        for (const r of respuestasParsed) {
            await pool.request()
                .input('ID_Reporte', sql.Int, idReporte)
                .input('ID_Pregunta', sql.Int, r.idPregunta)
                .input('Cumple', sql.Bit, (r.tipo && r.tipo.toUpperCase() === 'TEXT') ? 1 : r.cumple)
                .input('Respuesta_Texto', sql.NVarChar, r.respuestaTexto || null)
                .execute('dbo.SP_InsertarDetalleReporte');
        }

        // --- 3. NOTIFICACIONES (BD + EMAIL) ---
        const tituloNotif = tieneFallas ? '‚ö†Ô∏è Reporte con Fallas' : 'Nuevo Reporte Operativo';
        const mensajeNotif = `El usuario ${req.usuario.nombre} ha registrado el reporte #${idReporte} (Activo ID: ${idActivo}). ${tieneFallas ? 'Se detectaron NO conformidades.' : 'Todo conforme.'}`;
        
        // A) Insertar Notificaci√≥n en BD
        await pool.request()
            .input('Titulo', sql.NVarChar, tituloNotif)
            .input('Mensaje', sql.NVarChar, mensajeNotif)
            .input('Tipo', sql.NVarChar, tieneFallas ? 'Alerta' : 'Reporte')
            .input('RolDestino', sql.NVarChar, 'AdminCalidad') 
            .input('Enlace', sql.NVarChar, '/admin/reportes')
            .execute('dbo.SP_CrearNotificacion');

        // B) Enviar Correo a Admins
        const adminsResult = await pool.request()
            .query(`
                SELECT U.Email 
                FROM Usuarios U
                INNER JOIN Roles R ON U.ID_Rol = R.ID_Rol
                WHERE (R.Nombre = 'AdminCalidad' OR R.Nombre = 'SuperAdmin') 
                AND U.Email IS NOT NULL
            `);
        
        const correosAdmins = adminsResult.recordset.map(u => u.Email);
        
        correosAdmins.forEach(email => {
            enviarCorreoNotificacion(email, tituloNotif, mensajeNotif);
        });

        // 4. Log
        const estadoReporte = tieneFallas ? 'CON FALLAS' : 'CONFORME';
        await registrarLog(
            req.usuario.nombre, 
            req.usuario.rol, 
            'REPORTE', 
            'Operativo', 
            `Cre√≥ reporte ID ${idReporte} para Activo ID ${idActivo}. Estado: ${estadoReporte}`
        );

        res.status(201).json({ 
            mensaje: 'Reporte registrado exitosamente', 
            idReporte, 
            tieneFallas 
        });

    } catch (error) {
        console.error("Error al crear reporte:", error);
        res.status(500).json({ mensaje: 'Error interno al guardar el reporte' });
    }
};

export const listarReportes = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarReportes');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener historial' });
    }
};

export const obtenerDetalleReporte = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request().input('ID_Reporte', sql.Int, id).execute('dbo.SP_ObtenerDetalleReporte');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener detalle' });
    }
};

export const verificarReporte = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request().input('ID_Reporte', sql.Int, id).execute('dbo.SP_VerificarReporte');
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'VERIFICAR', 'Reportes', `Verific√≥ reporte ID: ${id}`);
        res.json({ mensaje: 'Reporte verificado correctamente' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al verificar reporte' });
    }
};

// ==========================================
// NUEVA FUNCI√ìN: VER EVIDENCIA DE REPORTE (STREAMING)
// ==========================================
export const verEvidenciaReporte = (req, res) => {
    const { nombreArchivo } = req.params;

    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const rutaFisica = path.resolve(__dirname, '../uploads', nombreArchivo);

    if (fs.existsSync(rutaFisica)) {
        res.sendFile(rutaFisica);
    } else {
        res.status(404).json({ mensaje: 'Evidencia no encontrada en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\specializedController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// 1. CONFIGURACI√ìN DE RUTAS BLINDADA
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ESTA ES LA CLAVE: Definimos la ruta de uploads EXACTAMENTE igual que en storage.js
// storage.js est√° en ../libs/storage.js y usa '../uploads' -> apunta a backend/uploads
// Este archivo est√° en ../controllers/specializedController.js y usa '../uploads' -> apunta a backend/uploads
const CARPETA_UPLOADS = path.join(__dirname, '../uploads');

// ================= 3. AGUA POTABLE =================

export const registrarVerificacionAgua = async (req, res) => {
    const { puntoToma, medicion } = req.body;
    const idUsuario = req.usuario.id;
    
    if (!req.file) return res.status(400).json({ mensaje: 'Foto obligatoria' });
    
    // Guardamos en BD la ruta relativa simple
    const urlFoto = `uploads/${req.file.filename}`;

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Usuario', sql.Int, idUsuario)
            .input('PuntoToma', sql.NVarChar, puntoToma)
            .input('DatosMedicion', sql.NVarChar, medicion)
            .input('UrlFoto', sql.NVarChar, urlFoto)
            .execute('dbo.SP_RegistrarVerificacionAgua');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'REGISTRO', 'Calidad Agua', `Registr√≥ toma en: ${puntoToma}`);
        res.json({ mensaje: 'Registrado' });
    } catch (error) { 
        console.error(error);
        res.status(500).json({ mensaje: 'Error al registrar verificaci√≥n' }); 
    }
};

export const obtenerHistorialAgua = async (req, res) => {
    try {
        const pool = await getConnection();
        const { rol, id } = req.usuario; 
        const result = await pool.request()
            .input('ID_Usuario', sql.Int, (rol==='SuperAdmin'||rol==='AdminCalidad')?null:id)
            .execute('dbo.SP_ListarVerificacionesAgua');
        res.json(result.recordset);
    } catch (error) { res.status(500).json({ mensaje: 'Error al obtener historial' }); }
};

// ================= 4. CAPACITACI√ìN KIOSCO =================

export const registrarEvaluacionKiosco = async (req, res) => {
    const { idEvaluacion, nombreEvaluado, calificacion, detalleRespuestas } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Evaluacion', sql.Int, idEvaluacion)
            .input('NombreEvaluado', sql.NVarChar, nombreEvaluado)
            .input('Calificacion', sql.Decimal(4,2), calificacion)
            .input('DetalleJSON', sql.NVarChar, JSON.stringify(detalleRespuestas || []))
            .execute('dbo.SP_RegistrarResultadoKiosco');

        await registrarLog('Kiosco P√∫blico', 'Invitado', 'EVALUACION', 'Capacitaci√≥n', `Evaluado: ${nombreEvaluado}, Nota: ${calificacion}`);
        res.json({ mensaje: 'Evaluaci√≥n guardada.' });
    } catch (error) {
        console.error("Error Kiosco:", error);
        res.status(500).json({ mensaje: 'Error al guardar' });
    }
};

export const obtenerPreguntasKiosco = async (req, res) => {
    const { idEvaluacion } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Evaluacion', sql.Int, idEvaluacion)
            .execute('dbo.SP_ListarPreguntasEvaluacion');
        
        const preguntasMap = new Map();
        result.recordset.forEach(row => {
            if (!preguntasMap.has(row.ID_Pregunta_Eval)) {
                preguntasMap.set(row.ID_Pregunta_Eval, {
                    id: row.ID_Pregunta_Eval,
                    pregunta: row.Texto_Pregunta,
                    imagen: row.Url_Imagen, 
                    opciones: []
                });
            }
            preguntasMap.get(row.ID_Pregunta_Eval).opciones.push({
                id: row.ID_Opcion,
                texto: row.Texto_Opcion,
                esCorrecta: row.Es_Correcta
            });
        });
        res.json(Array.from(preguntasMap.values()));
    } catch (error) { res.status(500).json({ mensaje: 'Error al cargar examen' }); }
};

// =========================================================================
// 5. VER FOTO AGUA (SOLUCI√ìN DEFINITIVA SIN TOCAR STORAGE)
// =========================================================================
export const verFotoAgua = (req, res) => {
    // 1. Recibimos el par√°metro
    let { nombreArchivo } = req.params;

    // 2. LIMPIEZA TOTAL: Eliminamos rutas anteriores si las hubiera
    // Si viene "uploads/foto.png", lo convertimos a "foto.png"
    // Si viene "../../foto.png", lo convertimos a "foto.png"
    nombreArchivo = path.basename(nombreArchivo);

    // 3. Construimos la ruta absoluta usando la misma l√≥gica que storage.js
    const rutaAbsoluta = path.join(CARPETA_UPLOADS, nombreArchivo);

    console.log(`\nüîé [AGUA] Buscando: ${nombreArchivo}`);
    console.log(`üìÇ Ruta calculada: ${rutaAbsoluta}`);

    // 4. Verificaci√≥n f√≠sica
    if (fs.existsSync(rutaAbsoluta)) {
        console.log(`‚úÖ ¬°ARCHIVO ENCONTRADO! Enviando...`);
        
        // Detectar MIME Type
        const ext = path.extname(rutaAbsoluta).toLowerCase();
        let contentType = 'application/octet-stream';
        if (['.jpg', '.jpeg'].includes(ext)) contentType = 'image/jpeg';
        else if (ext === '.png') contentType = 'image/png';
        else if (ext === '.pdf') contentType = 'application/pdf';

        res.setHeader('Content-Type', contentType);
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);
        res.sendFile(rutaAbsoluta);
    } else {
        // 5. DIAGN√ìSTICO DE ERROR (Solo se ejecuta si falla)
        console.error(`‚ùå NO ENCONTRADO.`);
        
        // Intentar listar qu√© hay en la carpeta para ver el error
        if (fs.existsSync(CARPETA_UPLOADS)) {
            console.log(`üìã Archivos que S√ç est√°n en la carpeta uploads:`);
            const archivos = fs.readdirSync(CARPETA_UPLOADS);
            console.log(archivos.slice(0, 10)); // Muestra los primeros 10 para no saturar
            
            // Ver si hay alguno parecido
            const parecido = archivos.find(a => a.includes(nombreArchivo.split('-')[0])); // Buscar coincidencia parcial
            if (parecido) console.log(`üí° ¬øQuiz√°s buscabas este?: ${parecido}`);
        } else {
            console.error(`üö® ALERTA CR√çTICA: La carpeta ${CARPETA_UPLOADS} NO EXISTE.`);
        }

        res.status(404).json({ mensaje: 'Archivo f√≠sico no encontrado en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\trazabilidadController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import { registrarLog } from '../libs/logger.js';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n de rutas seguras
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// 1. LISTAR FICHAS (Para Admin y Colaborador)
// ==========================================
export const listarFichas = async (req, res) => {
    try {
        const pool = await getConnection();
        // Usamos el SP gen√©rico filtrando por M√≥dulo y SubTipo
        const result = await pool.request()
            .input('Modulo', sql.NVarChar, 'TRAZABILIDAD')
            .input('SubTipo', sql.NVarChar, 'FICHA_TECNICA')
            .execute('dbo.SP_ListarDocumentos');
        
        res.json(result.recordset);
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al listar fichas t√©cnicas' });
    }
};

// ==========================================
// 2. SUBIR FICHA (Solo Admin)
// ==========================================
export const subirFicha = async (req, res) => {
    const { nombre, descripcion } = req.body;
    
    if (!req.file) return res.status(400).json({ mensaje: 'Debe subir un archivo PDF o Imagen' });

    // --- CORRECCI√ìN HOSTINGER: RUTA RELATIVA ---
    // Guardamos solo el nombre del archivo para m√°xima compatibilidad
    // (Opcional: puedes guardar 'uploads/nombre' si tu frontend lo espera as√≠, 
    // pero el extractor de nombre en el frontend se encarga de limpiar)
    const urlArchivo = `uploads/${req.file.filename}`;
    
    const ext = req.file.filename.split('.').pop().toLowerCase();
    
    // Determinamos tipo de origen visual
    let tipoOrigen = 'PDF';
    if (['jpg', 'jpeg', 'png'].includes(ext)) tipoOrigen = 'Imagen';
    else if (['doc', 'docx'].includes(ext)) tipoOrigen = 'Word';
    else if (['xls', 'xlsx'].includes(ext)) tipoOrigen = 'Excel';

    try {
        const pool = await getConnection();
        await pool.request()
            .input('Modulo', sql.NVarChar, 'TRAZABILIDAD')
            .input('SubTipo', sql.NVarChar, 'FICHA_TECNICA')
            .input('Nombre', sql.NVarChar, nombre)
            .input('TipoOrigen', sql.NVarChar, tipoOrigen)
            .input('UrlArchivo', sql.NVarChar, urlArchivo)
            .input('Descripcion', sql.NVarChar, descripcion || '')
            .execute('dbo.SP_GuardarDocumento');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'SUBIR', 'Trazabilidad', `Subi√≥ ficha t√©cnica: ${nombre}`);
        res.json({ mensaje: 'Ficha t√©cnica guardada correctamente' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al guardar la ficha' });
    }
};

// ==========================================
// 3. ELIMINAR FICHA (Solo Admin)
// ==========================================
export const eliminarFicha = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Doc', sql.Int, id)
            .execute('dbo.SP_EliminarDocumento'); // Borrado l√≥gico

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ELIMINAR', 'Trazabilidad', `Elimin√≥ ficha ID: ${id}`);
        res.json({ mensaje: 'Ficha eliminada correctamente' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al eliminar' });
    }
};

// ==========================================
// 4. VER FICHA T√âCNICA (STREAMING ROBUSTO)
// ==========================================
export const verFichaTecnica = (req, res) => {
    const { nombreArchivo } = req.params;

    console.log(`üîç [TRAZABILIDAD] Buscando ficha: ${nombreArchivo}`);

    if (!nombreArchivo || nombreArchivo.includes('..') || nombreArchivo.includes('/') || nombreArchivo.includes('\\')) {
        return res.status(400).json({ mensaje: 'Nombre de archivo inv√°lido' });
    }

    const projectRoot = process.cwd();

    // Estrategia de m√∫ltiples rutas para asegurar que lo encuentre en Hostinger
    const posiblesRutas = [
        path.join(projectRoot, 'uploads', nombreArchivo),
        path.join(projectRoot, 'backend', 'uploads', nombreArchivo),
        path.resolve(__dirname, '../../uploads', nombreArchivo)
    ];

    let archivoEncontrado = null;

    for (const ruta of posiblesRutas) {
        if (fs.existsSync(ruta)) {
            archivoEncontrado = ruta;
            break;
        }
    }

    if (archivoEncontrado) {
        console.log(`‚úÖ [TRAZABILIDAD] Encontrado en: ${archivoEncontrado}`);

        // Detectar Content-Type para evitar pantalla blanca
        const ext = path.extname(archivoEncontrado).toLowerCase();
        let contentType = 'application/octet-stream';

        if (ext === '.pdf') contentType = 'application/pdf';
        else if (['.jpg', '.jpeg'].includes(ext)) contentType = 'image/jpeg';
        else if (ext === '.png') contentType = 'image/png';

        res.setHeader('Content-Type', contentType);
        res.setHeader('Content-Disposition', `inline; filename="${nombreArchivo}"`);

        res.sendFile(archivoEncontrado);
    } else {
        console.error(`‚ùå [TRAZABILIDAD] No encontrado. Buscado en:`, posiblesRutas);
        res.status(404).json({ mensaje: 'Ficha t√©cnica no encontrada en el servidor' });
    }
};


==================================================================
ARCHIVO: backend\controllers\userController.js
==================================================================
import { getConnection, sql } from '../config/db.js';
import bcrypt from 'bcryptjs';
import { registrarLog } from '../libs/logger.js';
import { enviarCorreoNotificacion } from '../libs/email.js'; 

// --- OBTENER ROLES ---
export const obtenerRoles = async (req, res) => {
    try {
        const pool = await getConnection();
        const result = await pool.request().execute('dbo.SP_ListarRoles');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al listar roles' });
    }
};

// --- REGISTRAR COLABORADOR (CREAR) ---
export const registrarColaborador = async (req, res) => {
    const { cedula, nombre, password, cargo, area, idRol } = req.body;

    if (!cedula || !nombre || !password || !idRol) {
        return res.status(400).json({ mensaje: 'Faltan campos obligatorios' });
    }

    try {
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(password, salt);

        const pool = await getConnection();
        const result = await pool.request()
            .input('Cedula', sql.NVarChar, cedula)
            .input('PasswordHash', sql.NVarChar, passwordHash)
            .input('Nombre', sql.NVarChar, nombre)
            .input('Cargo', sql.NVarChar, cargo || 'No especificado')
            .input('Area', sql.NVarChar, area || 'No especificada')
            .input('ID_Rol', sql.Int, idRol)
            .execute('dbo.SP_RegistrarUsuario');

        if (result.recordset[0].ID === -1) {
            return res.status(400).json({ mensaje: 'La c√©dula ya est√° registrada' });
        }

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'CREAR', 'Usuarios', `Cre√≥ nuevo usuario: ${nombre} (C√©dula: ${cedula})`);
        res.status(201).json({ mensaje: 'Usuario creado exitosamente' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al registrar usuario' });
    }
};

// --- ACTUALIZAR USUARIO (EDITAR) ---
export const actualizarUsuario = async (req, res) => {
    const { id } = req.params;
    // Aqu√≠ recibimos el idRol que env√≠a el ModalEditUser
    const { nombre, cargo, area, idRol } = req.body; 

    if (!nombre || !idRol) {
        return res.status(400).json({ mensaje: 'Nombre y Rol son obligatorios' });
    }

    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Usuario', sql.Int, id)
            .input('Nombre', sql.NVarChar, nombre)
            .input('Cargo', sql.NVarChar, cargo || '')
            .input('Area', sql.NVarChar, area || '')
            .input('ID_Rol', sql.Int, idRol) // <--- ENVIAMOS EL ROL AL SP ACTUALIZADO
            .execute('dbo.SP_ActualizarDatosUsuario');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'EDITAR', 'Usuarios', `Actualiz√≥ datos del usuario ID: ${id} - Nombre: ${nombre}`);
        res.json({ mensaje: 'Usuario actualizado correctamente' });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al actualizar usuario' });
    }
};

// --- OBTENER COLABORADORES ---
export const obtenerColaboradores = async (req, res) => {
    try {
        const pool = await getConnection();
        // Aseg√∫rate de que este SP devuelva la columna ID_Rol para que el modal sepa cu√°l pre-seleccionar
        const result = await pool.request().execute('dbo.SP_ListarColaboradores');
        res.json(result.recordset);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener usuarios' });
    }
};

// --- CAMBIAR ESTADO (Activar/Inactivar) ---
export const cambiarEstado = async (req, res) => {
    const { id } = req.params;
    const { estado } = req.body;
    try {
        const pool = await getConnection();
        await pool.request()
            .input('ID_Usuario', sql.Int, id)
            .input('NuevoEstado', sql.Bit, estado)
            .execute('dbo.SP_CambiarEstadoUsuario');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'ESTADO', 'Usuarios', `Cambi√≥ estado de usuario ID ${id} a: ${estado ? 'Activo' : 'Inactivo'}`);
        res.json({ mensaje: `Estado actualizado` });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al actualizar estado' });
    }
};

// --- OBTENER USUARIO POR ID ---
export const obtenerUsuarioPorId = async (req, res) => {
    const { id } = req.params;
    try {
        const pool = await getConnection();
        const result = await pool.request()
            .input('ID_Usuario', sql.Int, id)
            .execute('dbo.SP_ObtenerUsuarioPorID');
        if (result.recordset.length === 0) return res.status(404).json({ mensaje: 'No encontrado' });
        res.json(result.recordset[0]);
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al obtener usuario' });
    }
};

// --- RESTABLECER PASSWORD ---
export const restablecerPassword = async (req, res) => {
    const { id } = req.params;
    const { nuevaPassword } = req.body;
    
    if (!nuevaPassword || nuevaPassword.length < 6) return res.status(400).json({ mensaje: 'M√≠nimo 6 caracteres' });

    try {
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(nuevaPassword, salt);

        const pool = await getConnection();
        await pool.request()
            .input('ID_Usuario', sql.Int, id)
            .input('PasswordHash', sql.NVarChar, passwordHash)
            .execute('dbo.SP_RestablecerPassword');

        await registrarLog(req.usuario.nombre, req.usuario.rol, 'SEGURIDAD', 'Usuarios', `Restableci√≥ contrase√±a para el usuario ID: ${id}`);
        res.json({ mensaje: 'Contrase√±a restablecida' });
    } catch (error) {
        res.status(500).json({ mensaje: 'Error al cambiar contrase√±a' });
    }
};

// --- ACTUALIZAR CORREO (PERFIL) ---
export const actualizarPerfilCorreo = async (req, res) => {
    const { id } = req.params;
    const { email } = req.body;

    try {
        const pool = await getConnection();
        
        // 1. Actualizar en Base de Datos
        await pool.request()
            .input('ID_Usuario', sql.Int, id)
            .input('Email', sql.NVarChar, email)
            .query('UPDATE Usuarios SET Email = @Email WHERE ID_Usuario = @ID_Usuario');

        // 2. Log de Auditor√≠a
        await registrarLog(req.usuario.nombre, req.usuario.rol, 'PERFIL', 'Usuarios', `Actualiz√≥ su correo de notificaciones a: ${email}`);

        // 3. ENVIAR CORREO DE CONFIRMACI√ìN AUTOM√ÅTICO
        const asunto = "Correo Configurado Exitosamente";
        const mensaje = `Hola ${req.usuario.nombre}, hemos verificado tu direcci√≥n de correo electr√≥nico. A partir de ahora recibir√°s aqu√≠ las notificaciones de vencimientos, reportes y alertas del Sistema de Gesti√≥n.`;
        
        enviarCorreoNotificacion(email, asunto, mensaje);

        res.json({ mensaje: 'Correo actualizado y notificaci√≥n de prueba enviada.', email });
    } catch (error) {
        console.error(error);
        res.status(500).json({ mensaje: 'Error al actualizar correo' });
    }
};


==================================================================
ARCHIVO: backend\libs\cronJobs.js
==================================================================
import cron from 'node-cron';
import { getConnection, sql } from '../config/db.js';
import { enviarCorreoNotificacion } from './email.js';

// Funci√≥n que revisa y env√≠a correos
const verificarVencimientos = async () => {
    console.log('‚è∞ Iniciando chequeo autom√°tico de vencimientos...');
    
    try {
        const pool = await getConnection();

        // ------------------------------------------------------------------
        // 1. BUSCAR ACTIVIDADES DEL CRONOGRAMA (Vencen en los pr√≥ximos 3 d√≠as)
        // ------------------------------------------------------------------
        const actividadesResult = await pool.request().query(`
            SELECT 
                A.ID_Actividad, A.Nombre_Actividad, A.Fecha_Programada, 
                U.Email, U.Nombre_Completo
            FROM Actividades A
            INNER JOIN Usuarios U ON A.Responsable = U.Nombre_Completo
            WHERE A.Estado = 'Pendiente'
              AND U.Email IS NOT NULL
              AND A.Fecha_Programada BETWEEN CAST(GETDATE() AS DATE) AND DATEADD(DAY, 3, CAST(GETDATE() AS DATE))
        `);

        // Enviar correos Actividades
        for (const act of actividadesResult.recordset) {
            const fechaVence = new Date(act.Fecha_Programada).toLocaleDateString();
            const asunto = `Recordatorio: Actividad por Vencer`;
            const mensaje = `Hola ${act.Nombre_Completo}, te recordamos que la actividad "<strong>${act.Nombre_Actividad}</strong>" est√° programada para el d√≠a <strong>${fechaVence}</strong>. Por favor gestionarla a tiempo.`;
            
            await enviarCorreoNotificacion(act.Email, asunto, mensaje);
            console.log(`üì© Correo enviado a ${act.Email} (Actividad ${act.ID_Actividad})`);
        }

        // ------------------------------------------------------------------
        // 2. BUSCAR PLANES DE ACCI√ìN (ACPM) (Vencen en los pr√≥ximos 3 d√≠as)
        // ------------------------------------------------------------------
        const acpmResult = await pool.request().query(`
            SELECT 
                P.ID_ACPM, P.Origen, P.Fecha_Limite,
                U.Email, U.Nombre_Completo
            FROM ACPM P
            INNER JOIN Usuarios U ON P.Responsable = U.Nombre_Completo
            WHERE P.Estado IN ('Abierta', 'En Progreso')
              AND U.Email IS NOT NULL
              AND P.Fecha_Limite BETWEEN CAST(GETDATE() AS DATE) AND DATEADD(DAY, 3, CAST(GETDATE() AS DATE))
        `);

        // Enviar correos ACPM
        for (const plan of acpmResult.recordset) {
            const fechaVence = new Date(plan.Fecha_Limite).toLocaleDateString();
            const asunto = `Alerta: Plan de Acci√≥n por Vencer`;
            const mensaje = `Hola ${plan.Nombre_Completo}, el plan de acci√≥n derivado de "<strong>${plan.Origen}</strong>" (ID: ${plan.ID_ACPM}) tiene fecha l√≠mite para el <strong>${fechaVence}</strong>.`;
            
            await enviarCorreoNotificacion(plan.Email, asunto, mensaje);
            console.log(`üì© Correo enviado a ${plan.Email} (ACPM ${plan.ID_ACPM})`);
        }

    } catch (error) {
        console.error('‚ùå Error en el Cron Job:', error);
    }
};

// Configurar la tarea programada
export const iniciarCronJobs = () => {
    // Programado para correr todos los d√≠as a las 08:00 AM
    // Formato Cron:  Minuto Hora DiaMes Mes DiaSemana
    cron.schedule('0 8 * * *', () => {
        verificarVencimientos();
    }, {
        scheduled: true,
        timezone: "America/Bogota" // Ajusta a tu zona horaria
    });

    console.log('‚úÖ Tareas programadas iniciadas (08:00 AM diario).');
    
    // --- SOLO PARA PRUEBAS (Descomenta esto para que corra 5 segundos despu√©s de iniciar el server) ---
    // setTimeout(() => {
    //    console.log("‚ö° Ejecutando prueba de correos de vencimiento...");
    //    verificarVencimientos();
    // }, 5000);
};


==================================================================
ARCHIVO: backend\libs\email.js
==================================================================
// backend/libs/email.js
import nodemailer from 'nodemailer';
import dotenv from 'dotenv';

dotenv.config();

// URL del Logo proporcionada
const LOGO_URL = "https://i.ibb.co/27GMjSQM/logo.png";
// URL de tu Frontend (Aj√∫stala si subes a producci√≥n, por ahora local)
const PLATAFORMA_URL = "http://localhost:5173"; 

export const enviarCorreoNotificacion = async (destinatario, asunto, mensaje) => {
    if (!destinatario) return;

    try {
        const transporter = nodemailer.createTransport({
            service: 'gmail', // O el servicio que configures en .env
            auth: {
                user: process.env.MAIL_USER,
                pass: process.env.MAIL_PASS
            }
        });

        // --- PLANTILLA HTML PROFESIONAL ---
        const htmlTemplate = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
                .container { max-width: 600px; margin: 20px auto; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
                .header { text-align: center; padding: 30px; background-color: #ffffff; border-bottom: 3px solid #0c4760; }
                .logo { max-width: 180px; height: auto; }
                .content { padding: 40px 30px; color: #333333; }
                .title-row { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
                .icon-warning { color: #f59e0b; font-size: 24px; font-weight: bold; }
                .title { color: #0c4760; font-size: 22px; font-weight: 700; margin: 0; }
                .message-box { background-color: #f0f9ff; border-left: 5px solid #0ea5e9; padding: 15px; margin-bottom: 25px; border-radius: 4px; }
                .message-text { font-size: 16px; color: #1e293b; margin: 0; line-height: 1.5; }
                .info-text { font-size: 14px; color: #64748b; margin-bottom: 30px; }
                .btn-container { text-align: center; margin-top: 20px; }
                .btn { background-color: #0c4760; color: #ffffff !important; text-decoration: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; font-size: 16px; display: inline-block; transition: background 0.3s; }
                .footer { background-color: #333333; color: #ffffff; text-align: center; padding: 15px; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <img src="${LOGO_URL}" alt="Empaquetados El Trece" class="logo">
                </div>

                <div class="content">
                    
                    <div class="title-row">
                        <span style="font-size: 24px;"></span>
                        <h2 class="title">${asunto}</h2>
                    </div>

                    <div class="message-box">
                        <p class="message-text">${mensaje}</p>
                    </div>

                    <p class="info-text">Se ha registrado una novedad en el Sistema de Gesti√≥n que requiere tu atenci√≥n o confirmaci√≥n.</p>

                    <div class="btn-container">
                        <a href="${PLATAFORMA_URL}" class="btn">Ir a la Plataforma</a>
                    </div>
                </div>

                <div class="footer">
                    Empaquetados El Trece S.A.S - Sistema de Gesti√≥n de Calidad
                    <br>
                    <span style="color: #888; font-size: 10px;">Este es un mensaje autom√°tico, por favor no responder.</span>
                </div>
            </div>
        </body>
        </html>
        `;

        const mailOptions = {
            from: '"SGC El Trece" <notificaciones@eltrece.com>',
            to: destinatario,
            subject: ` ${asunto}`, // Icono en el asunto para destacar
            html: htmlTemplate
        };

        await transporter.sendMail(mailOptions);
        console.log(`‚úÖ Correo enviado a ${destinatario}`);

    } catch (error) {
        console.error('‚ùå Error enviando correo:', error);
    }
};


==================================================================
ARCHIVO: backend\libs\logger.js
==================================================================
// backend/libs/logger.js
import { getConnection, sql } from '../config/db.js';

export const registrarLog = async (usuario, rol, accion, modulo, detalle) => {
    try {
        const pool = await getConnection();
        await pool.request()
            .input('Usuario', sql.NVarChar, usuario || 'Sistema')
            .input('Rol', sql.NVarChar, rol || 'System')
            .input('Accion', sql.NVarChar, accion)
            .input('Modulo', sql.NVarChar, modulo)
            .input('Detalle', sql.NVarChar, detalle)
            .execute('dbo.SP_RegistrarLogGlobal');
            
        console.log(`[LOG] ${accion} en ${modulo}: ${detalle}`); // Tambi√©n lo muestra en consola
    } catch (error) {
        console.error('Error guardando log de auditor√≠a:', error);
        // No lanzamos error para no detener el proceso principal si falla el log
    }
};


==================================================================
ARCHIVO: backend\libs\storage.js
==================================================================
// backend/libs/storage.js
import multer from 'multer';
import path from 'path';

// Configuramos d√≥nde guardar los archivos
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        // Los guardaremos en una carpeta p√∫blica llamada 'uploads'
        cb(null, 'uploads/');
    },
    filename: function (req, file, cb) {
        // Generamos nombre √∫nico: fecha + nombre original
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        const ext = path.extname(file.originalname);
        cb(null, file.fieldname + '-' + uniqueSuffix + ext);
    }
});

export const upload = multer({ storage: storage });


==================================================================
ARCHIVO: backend\middlewares\authMiddleware.js
==================================================================
import jwt from 'jsonwebtoken';
import dotenv from 'dotenv'; 

dotenv.config();

// --- 1. L√ìGICA PRINCIPAL DE AUTENTICACI√ìN ---
const authMiddleware = (req, res, next) => {
    let token;
    
    // Verificamos si viene el header Authorization con Bearer
    if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
        try {
            // Extraemos el token
            token = req.headers.authorization.split(' ')[1];
            
            // Verificamos la firma del token
            const decoded = jwt.verify(token, process.env.JWT_SECRET || 'secretkey');
            
            // Creamos el objeto de usuario normalizado
            const usuarioNormalizado = {
                ...decoded,
                // Normalizamos el rol para evitar problemas de may√∫sculas/min√∫sculas o nombres distintos
                rol: decoded.Rol || decoded.rol || decoded.role,
                id: decoded.id || decoded.ID_Usuario,
                nombre: decoded.nombre || decoded.Nombre_Completo,
                email: decoded.email || decoded.Email
            };

            // ASIGNACI√ìN DOBLE PARA COMPATIBILIDAD TOTAL
            req.usuario = usuarioNormalizado; // Para tu c√≥digo nuevo
            req.user = usuarioNormalizado;    // Para librer√≠as o c√≥digo antiguo
            
            return next();
        } catch (error) {
            console.error('Error Auth:', error.message);
            // CORRECCI√ìN: Devolvemos 401 para que el frontend sepa que la sesi√≥n caduc√≥
            return res.status(401).json({ msg: 'Token no v√°lido o expirado. Por favor inicie sesi√≥n nuevamente.' });
        }
    }

    // Si no hay token en el header
    if (!token) {
        return res.status(401).json({ msg: 'No hay token, autorizaci√≥n denegada' });
    }
};

// --- 2. MIDDLEWARE PARA ADMIN (esAdmin) ---
// CORRECCI√ìN: Ahora acepta m√∫ltiples roles administrativos
const esAdmin = (req, res, next) => {
    // Validamos que el usuario haya pasado por el authMiddleware primero
    if (!req.usuario) {
        return res.status(500).json({ msg: 'Se requiere iniciar sesi√≥n antes de verificar el rol' });
    }

    // LISTA DE ROLES PERMITIDOS
    // Agregamos aqu√≠ todos los roles que consideras "Jefes" o "Admins"
    const rolesPermitidos = ['SuperAdmin', 'AdminCalidad', 'Administrador'];

    // Verificamos si el rol del usuario est√° en la lista
    if (!rolesPermitidos.includes(req.usuario.rol)) {
        console.log(`[ACCESO DENEGADO] Usuario: ${req.usuario.nombre} | Rol: ${req.usuario.rol}`);
        return res.status(403).json({ 
            msg: `No tienes permisos suficientes. Tu rol es: ${req.usuario.rol}` 
        });
    }
    
    next();
};

// --- 3. EXPORTACIONES ---
export { authMiddleware };
export const checkAuth = authMiddleware;
export { esAdmin };
export default authMiddleware;


==================================================================
ARCHIVO: backend\middlewares\uploadMiddleware.js
==================================================================
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

// Configuraci√≥n para manejar rutas en ES Modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Asegurar que existe la carpeta de subidas 'uploads' en la ra√≠z del backend
const uploadDir = path.join(__dirname, '../uploads');
if (!fs.existsSync(uploadDir)){
    fs.mkdirSync(uploadDir, { recursive: true });
}

// Configuraci√≥n de almacenamiento
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, uploadDir);
    },
    filename: function (req, file, cb) {
        // Generar nombre √∫nico
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        const cleanName = file.originalname.replace(/[^a-zA-Z0-9.]/g, '_');
        cb(null, uniqueSuffix + '-' + cleanName);
    }
});

const upload = multer({ 
    storage: storage,
    limits: { fileSize: 50 * 1024 * 1024 } // L√≠mite de 50MB
});

export default upload;


==================================================================
ARCHIVO: backend\package.json
==================================================================
{
  "name": "backend",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "type": "module",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "nodemon server.js",
    "start": "node server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "jsonwebtoken": "^9.0.3",
    "mssql": "^12.2.0",
    "multer": "^2.0.2",
    "node-cron": "^4.2.1",
    "nodemailer": "^7.0.12"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}



==================================================================
ARCHIVO: backend\routes\acpmRoutes.js
==================================================================
import { Router } from 'express';
import { 
    crearACPM, 
    listarACPM, 
    obtenerACPM, 
    cerrarACPM, 
    gestionarACPM, 
    obtenerOrigenes, 
    agregarOrigen,
    verEvidenciaACPM // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/acpmController.js';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; // <--- 2. IMPORTACI√ìN PARA SUBIR ARCHIVOS

const router = Router();

// Rutas de Or√≠genes (Para el desplegable)
router.get('/origenes', checkAuth, obtenerOrigenes);
router.post('/origenes', checkAuth, esAdmin, agregarOrigen);

// Gesti√≥n de ACPM
router.route('/')
    .post(checkAuth, esAdmin, crearACPM)
    .get(checkAuth, esAdmin, listarACPM);

router.get('/:id', checkAuth, esAdmin, obtenerACPM);

// --- RUTAS CON SUBIDA DE ARCHIVOS ---
// Ahora cerrar y gestionar aceptan evidencia real, necesitamos el middleware
router.put('/cerrar/:id', checkAuth, esAdmin, upload.single('evidencia'), cerrarACPM);
router.put('/gestion/:id', checkAuth, esAdmin, upload.single('evidencia'), gestionarACPM);

// ==========================================
// NUEVA RUTA: VER EVIDENCIA (STREAMING)
// ==========================================
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaACPM);

export default router;


==================================================================
ARCHIVO: backend\routes\actasRoutes.js
==================================================================
import { Router } from 'express';
import { 
    getActas, 
    createActa, 
    verFotoActa // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/actasController.js';
import { checkAuth } from '../middlewares/authMiddleware.js';
// Usaremos la librer√≠a est√°ndar para mantener consistencia, 
// o puedes dejar tu importaci√≥n si 'uploadMiddleware' es lo mismo que 'libs/storage'
import { upload } from '../libs/storage.js'; 

const router = Router();

router.get('/', checkAuth, getActas);

// Permitimos subir hasta 4 fotos en el campo 'fotos'
router.post('/', checkAuth, upload.array('fotos', 4), createActa);

// ==========================================
// NUEVA RUTA: VER FOTO ACTA (STREAMING)
// ==========================================
router.get('/foto/:nombreArchivo', checkAuth, verFotoActa);

export default router;


==================================================================
ARCHIVO: backend\routes\auditGlobalRoutes.js
==================================================================
// backend/routes/auditGlobalRoutes.js
import { Router } from 'express';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { getGlobalLogs } from '../controllers/auditGlobalController.js';

const router = Router();

// Solo SuperAdmin deber√≠a ver esto idealmente
router.get('/', checkAuth, esAdmin, getGlobalLogs);

export default router;


==================================================================
ARCHIVO: backend\routes\auditoriaRoutes.js
==================================================================
import { Router } from 'express';
import { 
    getAuditorias, 
    createAuditoria, 
    manageAuditores, 
    manageAreas,
    verEvidenciaAuditoria // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/auditoriaController.js';
import { checkAuth } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; // <--- 2. USAMOS LA CONFIG EST√ÅNDAR

const router = Router();

// --- RUTAS ---

router.get('/', checkAuth, getAuditorias);

// Middleware upload.single('evidencia') procesa el archivo antes del controlador
router.post('/', checkAuth, upload.single('evidencia'), createAuditoria);

router.post('/auditores', checkAuth, manageAuditores);
router.post('/areas', checkAuth, manageAreas);

// ==========================================
// NUEVA RUTA: VER EVIDENCIA (STREAMING)
// ==========================================
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaAuditoria);

export default router;


==================================================================
ARCHIVO: backend\routes\auditRoutes.js
==================================================================
// backend/routes/auditRoutes.js
import { Router } from 'express';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { getAuditoriaReport } from '../controllers/auditController.js';

const router = Router();

// Solo el SuperAdmin deber√≠a ver esto idealmente, pero usamos esAdmin por compatibilidad de tu middleware
// En el frontend ocultaremos el bot√≥n.
router.get('/', checkAuth, esAdmin, getAuditoriaReport);

export default router;


==================================================================
ARCHIVO: backend\routes\authRoutes.js
==================================================================
// backend/routes/authRoutes.js
import { Router } from 'express';
import { login } from '../controllers/authController.js';

const router = Router();

// Definimos el endpoint POST /api/auth/login
router.post('/login', login);

export default router;


==================================================================
ARCHIVO: backend\routes\capacitacionRoutes.js
==================================================================
import { Router } from 'express';
// Aseg√∫rate de usar 'checkAuth' o 'verifyToken' seg√∫n lo tengas en authMiddleware.js
// En tu caso parece ser 'checkAuth'.
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; // Tu configuraci√≥n de Multer

import { 
    crearCapacitacion, 
    listarCapacitacionesAdmin, 
    listarParaKiosco,
    listarResultados, 
    cambiarEstadoResultado, 
    obtenerDetalleResultado,
    listarPreguntas, 
    agregarPregunta, 
    eliminarPregunta,
    obtenerResumenAdmin,
    obtenerUsuariosPorCurso,
    obtenerHistorialUsuario,
    streamMaterialCapacitacion // <--- IMPORTACI√ìN CLAVE
} from '../controllers/capacitacionController.js';

const router = Router();

// === GESTI√ìN MATERIAL (ADMIN) ===
router.post('/', checkAuth, esAdmin, upload.single('archivo'), crearCapacitacion);
router.get('/', checkAuth, esAdmin, listarCapacitacionesAdmin);

// === RUTAS P√öBLICAS (KIOSCO) ===
// Esta ruta es p√∫blica para que el Kiosco (sin login) pueda listar los cursos
router.get('/kiosco', listarParaKiosco); 

// === REPORTES Y RESULTADOS ===
router.get('/admin/resumen', checkAuth, esAdmin, obtenerResumenAdmin);
router.get('/admin/usuarios/:idEvaluacion', checkAuth, esAdmin, obtenerUsuariosPorCurso);
router.get('/admin/historial/:idEvaluacion', checkAuth, esAdmin, obtenerHistorialUsuario);

// === GESTI√ìN RESULTADOS INDIVIDUALES ===
router.get('/resultados', checkAuth, esAdmin, listarResultados);
router.get('/resultados/:idResultado', checkAuth, esAdmin, obtenerDetalleResultado);
router.put('/resultados/:id', checkAuth, esAdmin, cambiarEstadoResultado);

// === EDITOR DE PREGUNTAS ===
router.get('/preguntas/:idEvaluacion', checkAuth, esAdmin, listarPreguntas);
router.post('/preguntas', checkAuth, esAdmin, upload.single('imagen'), agregarPregunta);
router.delete('/preguntas/:id', checkAuth, esAdmin, eliminarPregunta);

// ==========================================
// RUTA DE ARCHIVOS: STREAMING SEGURO
// ==========================================
// Esta ruta coincide con la llamada del frontend: /capacitacion/material/:filename
// Nota: Puedes requerir 'checkAuth' si quieres que solo logueados vean el material,
// o dejarla p√∫blica si el Kiosco tambi√©n necesita acceder a los PDFs/Videos.
router.get('/material/:nombreArchivo', streamMaterialCapacitacion);

export default router;


==================================================================
ARCHIVO: backend\routes\certificadosRoutes.js
==================================================================
import { Router } from 'express';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; 
import { 
    listarPlantillas, 
    guardarPlantilla, 
    registrarGeneracion, 
    obtenerHistorial,
    verCertificadoPDF // <--- Importamos la funci√≥n segura
} from '../controllers/certificadosController.js';

const router = Router();

// === GESTI√ìN DE PLANTILLAS ===
router.get('/plantillas', checkAuth, listarPlantillas);
router.post('/plantillas', checkAuth, esAdmin, guardarPlantilla);

// === GENERACI√ìN Y REGISTRO ===
// Recibe el PDF generado desde el frontend
router.post('/generar', checkAuth, upload.single('pdf'), registrarGeneracion);

// === HISTORIAL Y TRAZABILIDAD ===
router.get('/historial', checkAuth, obtenerHistorial);

// === VISUALIZACI√ìN DE DOCUMENTOS (STREAMING) ===
// Esta ruta debe coincidir con la llamada del frontend: /certificados/pdf/:filename
// Nota: En el frontend pusiste `/certificados/pdf/${filename}`, as√≠ que aqu√≠ debe ser 'pdf'
router.get('/pdf/:nombreArchivo', checkAuth, verCertificadoPDF);

export default router;


==================================================================
ARCHIVO: backend\routes\coreRoutes.js
==================================================================
import { Router } from 'express';
import { 
    // Categor√≠as
    crearCategoria, listarCategorias,
    
    // Activos
    crearActivo, listarActivos, actualizarActivo, cambiarEstadoActivo,
    
    // Formularios
    crearFormularioCompleto, listarFormularios, actualizarFormulario, 
    eliminarFormulario, toggleVisibilidad,
    
    // Preguntas
    obtenerPreguntas, agregarPreguntaIndividual, borrarPreguntaIndividual,
    
    // Asignaci√≥n
    asignarFormulario, obtenerFormsDeActivo,

    // Tarjetas Din√°micas
    listarTarjetas,
    crearTarjeta,
    eliminarTarjeta
} from '../controllers/coreController.js';

import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';

const router = Router();

// ==========================================
// RUTAS DE CATEGOR√çAS
// ==========================================
router.post('/categorias', checkAuth, esAdmin, crearCategoria);
router.get('/categorias', checkAuth, listarCategorias); 

// ==========================================
// RUTAS DE ACTIVOS
// ==========================================
router.route('/activos')
    .post(checkAuth, esAdmin, crearActivo)
    .get(checkAuth, listarActivos);

router.route('/activos/:id')
    .put(checkAuth, esAdmin, actualizarActivo); 

router.put('/activos/:id/estado', checkAuth, esAdmin, cambiarEstadoActivo); 

// ==========================================
// RUTAS DE FORMULARIOS (GESTOR)
// ==========================================
router.route('/formularios')
    .get(checkAuth, listarFormularios)        // <--- CAMBIO IMPORTANTE: Quitamos 'esAdmin'
    .post(checkAuth, esAdmin, crearFormularioCompleto); 

router.route('/formularios/:id')
    .put(checkAuth, esAdmin, actualizarFormulario)   
    .delete(checkAuth, esAdmin, eliminarFormulario); 

router.put('/formularios/:id/visibilidad', checkAuth, esAdmin, toggleVisibilidad);

// ==========================================
// RUTAS DE PREGUNTAS
// ==========================================
router.get('/formularios/:id/preguntas', checkAuth, obtenerPreguntas);
router.post('/formularios/pregunta', checkAuth, esAdmin, agregarPreguntaIndividual);
router.delete('/formularios/pregunta/:id', checkAuth, esAdmin, borrarPreguntaIndividual);

// ==========================================
// RUTAS DE ASIGNACI√ìN
// ==========================================
router.post('/asignar', checkAuth, esAdmin, asignarFormulario);
router.get('/asignar/:idActivo', checkAuth, obtenerFormsDeActivo); 

// ==========================================
// RUTAS DE TARJETAS (CARPETAS DIN√ÅMICAS)
// ==========================================
router.get('/tarjetas/:modulo', checkAuth, listarTarjetas);
router.post('/tarjetas', checkAuth, crearTarjeta); // Permitimos a AdminCalidad crear
router.delete('/tarjetas/:id', checkAuth, eliminarTarjeta);

export default router;


==================================================================
ARCHIVO: backend\routes\cronogramaRoutes.js
==================================================================
import { Router } from 'express';
import { 
    crearCronograma, 
    listarCronogramas, 
    eliminarCronograma,
    crearActividad, 
    obtenerActividades, 
    editarActividad, 
    eliminarActividad, 
    cambiarEstadoActividad, 
    agregarSeguimiento,
    obtenerTodasActividades,
    crearActividadAgendada,
    verEvidenciaCronograma // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/cronogramaController.js';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js';

const router = Router();

// ==========================================
// 1. GESTI√ìN DE CRONOGRAMAS (CARPETAS)
// ==========================================
router.route('/')
    .get(checkAuth, esAdmin, listarCronogramas)
    .post(checkAuth, esAdmin, crearCronograma); 

router.delete('/:id', checkAuth, esAdmin, eliminarCronograma);

// ==========================================
// 2. AGENDAR ACTIVIDADES (DESDE M√ìDULOS)
// ==========================================
router.post('/agendar', checkAuth, esAdmin, crearActividadAgendada);

// ==========================================
// 3. GESTI√ìN DE ACTIVIDADES (CRUD)
// ==========================================
router.get('/actividades/todas', checkAuth, esAdmin, obtenerTodasActividades); 

router.post('/actividad', checkAuth, esAdmin, crearActividad);
router.get('/:idCronograma/actividades', checkAuth, esAdmin, obtenerActividades);
router.put('/actividad/:id', checkAuth, esAdmin, editarActividad);
router.delete('/actividad/:id', checkAuth, esAdmin, eliminarActividad);

// ==========================================
// 4. GESTI√ìN DE ESTADOS Y SEGUIMIENTO
// ==========================================
router.put('/actividad/estado/:id', checkAuth, esAdmin, cambiarEstadoActividad);
router.put('/actividad/seguimiento/:id', checkAuth, esAdmin, upload.single('evidencia'), agregarSeguimiento);

// ==========================================
// 5. NUEVA RUTA: VER EVIDENCIA (STREAMING)
// ==========================================
// Permite ver la foto/PDF sin exponer la carpeta uploads p√∫blicamente
// Uso frontend: apiFetchBlob(`/cronogramas/evidencia/${nombreArchivo}`)
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaCronograma);

export default router;


==================================================================
ARCHIVO: backend\routes\dashboardRoutes.js
==================================================================
// backend/routes/dashboardRoutes.js
import { Router } from 'express';
import { obtenerResumen } from '../controllers/dashboardController.js';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';

const router = Router();

// GET /api/dashboard/resumen - Protegido solo para Admins
router.get('/resumen', checkAuth, esAdmin, obtenerResumen);

export default router;


==================================================================
ARCHIVO: backend\routes\driveRoutes.js
==================================================================
import { Router } from 'express';
import { 
    obtenerContenido, 
    crearCarpeta, 
    subirArchivoDrive, 
    eliminarArchivo, 
    eliminarCarpeta, 
    descargarArchivo,
    verArchivo // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/driveController.js';
import { checkAuth } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js';

const router = Router();

// === NAVEGACI√ìN Y CARPETAS ===
router.get('/contenido/:idCarpeta', checkAuth, obtenerContenido);
router.post('/carpeta', checkAuth, crearCarpeta);
router.delete('/carpeta/:id', checkAuth, eliminarCarpeta);

// === GESTI√ìN DE ARCHIVOS ===
router.post('/archivo', checkAuth, upload.single('archivo'), subirArchivoDrive);
router.delete('/archivo/:id', checkAuth, eliminarArchivo);
router.get('/descargar/:id', checkAuth, descargarArchivo);

// ==========================================
// NUEVA RUTA: VISUALIZACI√ìN (STREAMING)
// ==========================================
// Permite ver PDF/Im√°genes en el navegador sin exponer la carpeta real
// Uso Frontend: apiFetchBlob(`/drive/ver/${id}`)
router.get('/ver/:id', checkAuth, verArchivo);

export default router;


==================================================================
ARCHIVO: backend\routes\externosRoutes.js
==================================================================
import { Router } from 'express';
// Aseg√∫rate de importar el nuevo controlador getClientes
import { 
    getProductos, 
    getProveedores, 
    getMaquinistas, 
    getSelladores,
    getClientes // <--- IMPORTANTE: Agr√©galo aqu√≠
} from '../controllers/externosController.js';

const router = Router();

router.get('/productos', getProductos);
router.get('/proveedores', getProveedores);
router.get('/maquinistas', getMaquinistas);
router.get('/selladores', getSelladores);

// --- AGREGA ESTA L√çNEA ---
router.get('/clientes', getClientes); 
// -------------------------

export default router;


==================================================================
ARCHIVO: backend\routes\notificationRoutes.js
==================================================================
import { Router } from 'express';
import { checkAuth } from '../middlewares/authMiddleware.js';
import { obtenerNotificaciones, eliminarNotificacion } from '../controllers/notificationController.js';

const router = Router();

router.get('/', checkAuth, obtenerNotificaciones);
// CAMBIO: Ruta DELETE para borrar de verdad
router.delete('/:id', checkAuth, eliminarNotificacion);

export default router;


==================================================================
ARCHIVO: backend\routes\pesosRoutes.js
==================================================================
import { Router } from 'express';
import { 
    registrarControlPesos, 
    listarControles, 
    obtenerDetalleControl,
    verEvidenciaPesos // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/pesosController.js';
import { checkAuth } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; // <--- 2. USAMOS CONFIG EST√ÅNDAR

const router = Router();

// Subimos 'evidencia' usando el storage centralizado
router.post('/', checkAuth, upload.single('evidencia'), registrarControlPesos);

router.get('/', checkAuth, listarControles);
router.get('/:id', checkAuth, obtenerDetalleControl);

// ==========================================
// NUEVA RUTA: VER EVIDENCIA PESOS (STREAMING)
// ==========================================
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaPesos);

export default router;


==================================================================
ARCHIVO: backend\routes\pmirRoutes.js
==================================================================
import { Router } from 'express';
import { checkAuth } from '../middlewares/authMiddleware.js'; // O verifyToken, como lo tengas
import { upload } from '../libs/storage.js'; // Tu Multer

import { 
    getRecolecciones, 
    createRecoleccion, 
    verEvidenciaPMIR // <--- Importamos tu funci√≥n
} from '../controllers/pmirController.js';

const router = Router();

// Rutas de Recolecci√≥n
router.get('/recoleccion', checkAuth, getRecolecciones);
router.post('/recoleccion', checkAuth, upload.single('documento'), createRecoleccion);

// ==========================================
// RUTA DE EVIDENCIA (STREAMING)
// ==========================================
// Esta ruta coincide con la llamada del frontend: /pmir/evidencia/:filename
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaPMIR);

export default router;


==================================================================
ARCHIVO: backend\routes\proveedoresRoutes.js
==================================================================
import { Router } from 'express';
import { 
    createEvaluacion, 
    getEvaluaciones, 
    getEvaluacionById, 
    uploadCartaInvima,
    verCartaInvima // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/proveedoresController.js';
import { upload } from '../libs/storage.js';
import authMiddleware from '../middlewares/authMiddleware.js'; 

const router = Router();

// Rutas base
router.get('/', authMiddleware, getEvaluaciones);
router.get('/:id', authMiddleware, getEvaluacionById);

// Nota: Aunque uses upload.single aqu√≠, recuerda que el controlador createEvaluacion 
// que hicimos est√° dise√±ado para guardar solo datos. El archivo se sube en el PUT de abajo.
router.post('/', authMiddleware, upload.single('cartaInvima'), createEvaluacion);

// --- RUTA PARA SUBIR CARTA DESPU√âS ---
router.put('/:id/carta-invima', authMiddleware, upload.single('archivo'), uploadCartaInvima);

// ==========================================
// NUEVA RUTA: VER CARTA INVIMA (STREAMING)
// ==========================================
// Permite ver el PDF sin exponer la carpeta uploads p√∫blicamente
router.get('/carta/:nombreArchivo', authMiddleware, verCartaInvima);

export default router;


==================================================================
ARCHIVO: backend\routes\recallRoutes.js
==================================================================
import { Router } from 'express';
import { 
    getSalidas, 
    createSalida,
    verDocumentoSalida // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/recallController.js';
import { checkAuth } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js'; // <--- 2. USAMOS CONFIG EST√ÅNDAR

const router = Router();

// Rutas protegidas
router.get('/salidas', checkAuth, getSalidas);

// Crear Salida con documento
router.post('/salidas', checkAuth, upload.single('documento'), createSalida);

// ==========================================
// NUEVA RUTA: VER DOCUMENTO SALIDA (STREAMING)
// ==========================================
router.get('/documento/:nombreArchivo', checkAuth, verDocumentoSalida);

export default router;


==================================================================
ARCHIVO: backend\routes\reportesRoutes.js
==================================================================
import { Router } from 'express';
import { 
    crearReporte, 
    listarReportes, 
    obtenerDetalleReporte, 
    verificarReporte,
    verEvidenciaReporte // <--- 1. IMPORTACI√ìN NUEVA
} from '../controllers/reportesController.js';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js';

const router = Router();

// Creaci√≥n y Listado
router.post('/', checkAuth, upload.single('evidencia'), crearReporte); 
router.get('/', checkAuth, listarReportes);
router.get('/:id/detalle', checkAuth, obtenerDetalleReporte);

// Verificaci√≥n (Solo Admin/Calidad)
router.put('/:id/verificar', checkAuth, esAdmin, verificarReporte);

// ==========================================
// NUEVA RUTA: VER EVIDENCIA (STREAMING)
// ==========================================
// Permite ver la foto del reporte de forma segura
// Uso Frontend: apiFetchBlob(`/reportes/evidencia/${nombreArchivo}`)
router.get('/evidencia/:nombreArchivo', checkAuth, verEvidenciaReporte);

export default router;


==================================================================
ARCHIVO: backend\routes\specializedRoutes.js
==================================================================
import { Router } from 'express';
import { upload } from '../libs/storage.js'; // Usamos la configuraci√≥n est√°ndar
import { checkAuth } from '../middlewares/authMiddleware.js';
import { 
    registrarVerificacionAgua,
    obtenerHistorialAgua,
    registrarEvaluacionKiosco,
    obtenerPreguntasKiosco,
    verFotoAgua // <--- 1. Importamos la funci√≥n blindada
} from '../controllers/specializedController.js';

// Importamos la funci√≥n del kiosco desde capacitaci√≥n
import { listarParaKiosco } from '../controllers/capacitacionController.js'; 

const router = Router();

// ====================================================================
// RUTAS AGUA POTABLE
// ====================================================================

// 1. Registrar verificaci√≥n (Sube la foto)
router.post('/agua/verificar', checkAuth, upload.single('foto'), registrarVerificacionAgua);

// 2. Obtener historial
router.get('/agua/historial', checkAuth, obtenerHistorialAgua);

// 3. RUTA CR√çTICA DE STREAMING (Ver Evidencia)
// Coincide con la llamada del frontend: /agua/evidencia/nombre_archivo.jpg
router.get('/agua/evidencia/:nombreArchivo', checkAuth, verFotoAgua);

// ====================================================================
// RUTAS KIOSCO CAPACITACI√ìN (P√∫blicas - Sin checkAuth)
// ====================================================================

// Registrar evaluaci√≥n
router.post('/kiosco/evaluar', registrarEvaluacionKiosco);

// Obtener preguntas
router.get('/kiosco/preguntas/:idEvaluacion', obtenerPreguntasKiosco);

// Listar capacitaciones disponibles
router.get('/kiosco/capacitaciones', listarParaKiosco); 

export default router;


==================================================================
ARCHIVO: backend\routes\trazabilidadRoutes.js
==================================================================
import { Router } from 'express';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';
import { upload } from '../libs/storage.js';
import { 
    listarFichas, 
    subirFicha, 
    eliminarFicha, 
    verFichaTecnica // <--- Importamos la nueva funci√≥n
} from '../controllers/trazabilidadController.js';

const router = Router();

// Rutas Fichas T√©cnicas
router.get('/fichas', checkAuth, listarFichas);
router.post('/fichas', checkAuth, esAdmin, upload.single('archivo'), subirFicha);
router.delete('/fichas/:id', checkAuth, esAdmin, eliminarFicha);

// ==========================================
// RUTA DE STREAMING (COINCIDE CON FRONTEND)
// ==========================================
// Frontend llama a: /trazabilidad/ficha/${filename}
router.get('/ficha/:nombreArchivo', checkAuth, verFichaTecnica);

export default router;


==================================================================
ARCHIVO: backend\routes\userRoutes.js
==================================================================
import { Router } from 'express';
import { 
    registrarColaborador, 
    obtenerColaboradores, 
    cambiarEstado,
    obtenerUsuarioPorId, 
    actualizarUsuario,
    restablecerPassword,
    obtenerRoles,
    actualizarPerfilCorreo // <--- IMPORTADO
} from '../controllers/userController.js';
import { checkAuth, esAdmin } from '../middlewares/authMiddleware.js';

const router = Router();

// 1. RUTA DE ROLES
router.get('/roles', checkAuth, esAdmin, obtenerRoles);

// 2. RUTAS GENERALES
router.route('/')
    .post(checkAuth, esAdmin, registrarColaborador)
    .get(checkAuth, esAdmin, obtenerColaboradores);

// 3. RUTAS CON ID
router.route('/:id')
    .get(checkAuth, esAdmin, obtenerUsuarioPorId)
    .put(checkAuth, esAdmin, actualizarUsuario);

// Acciones Espec√≠ficas
router.put('/estado/:id', checkAuth, esAdmin, cambiarEstado);
router.put('/password/:id', checkAuth, esAdmin, restablecerPassword);

// NUEVA RUTA: Actualizar correo del perfil (Cualquier usuario autenticado)
router.put('/perfil/correo/:id', checkAuth, actualizarPerfilCorreo);

export default router;


==================================================================
ARCHIVO: backend\server.js
==================================================================
// backend/server.js
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

// Importar Conexi√≥n BD
import { getConnection } from './config/db.js';

// --- IMPORTAR NUEVA FUNCIONALIDAD (TAREAS AUTOM√ÅTICAS) ---
import { iniciarCronJobs } from './libs/cronJobs.js'; // <--- AGREGADO

// --- IMPORTAR RUTAS (TUS RUTAS ORIGINALES) ---
import authRoutes from './routes/authRoutes.js';
import userRoutes from './routes/userRoutes.js';
import cronogramaRoutes from './routes/cronogramaRoutes.js';
import coreRoutes from './routes/coreRoutes.js';
import reportesRoutes from './routes/reportesRoutes.js';
import acpmRoutes from './routes/acpmRoutes.js';
import specializedRoutes from './routes/specializedRoutes.js';
import dashboardRoutes from './routes/dashboardRoutes.js';
import driveRoutes from './routes/driveRoutes.js';
import capacitacionRoutes from './routes/capacitacionRoutes.js';
import auditRoutes from './routes/auditRoutes.js';
import auditGlobalRoutes from './routes/auditGlobalRoutes.js';
import notificationRoutes from './routes/notificationRoutes.js';
import trazabilidadRoutes from './routes/trazabilidadRoutes.js';
import certificadosRoutes from './routes/certificadosRoutes.js';
import auditoriaRoutes from './routes/auditoriaRoutes.js'
import pesosRoutes from './routes/pesosRoutes.js'
import externosRoutes from './routes/externosRoutes.js';
import proveedoresRoutes from './routes/proveedoresRoutes.js';
import pmirRoutes from './routes/pmirRoutes.js';
import recallRoutes from './routes/recallRoutes.js';
import actasRoutes from './routes/actasRoutes.js'

// Configuraci√≥n de Variables de Entorno
dotenv.config();

// Configuraci√≥n de __dirname para ES Modules (Node.js moderno)
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

// --- MIDDLEWARES GLOBALES ---
app.use(cors()); // Permitir peticiones desde el Frontend
app.use(express.json()); // Permitir leer JSON en el body
app.use(express.urlencoded({ extended: true })); // Permitir leer datos de formularios (Form-Data)

// --- CARPETA P√öBLICA (ARCHIVOS EST√ÅTICOS) ---
// Esto permite acceder a las fotos subidas v√≠a URL: http://localhost:3000/uploads/archivo.jpg
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// --- DEFINICI√ìN DE RUTAS (API) ---
app.use('/api/auth', authRoutes);           // Login
app.use('/api/usuarios', userRoutes);       // Gesti√≥n de Colaboradores
app.use('/api/cronogramas', cronogramaRoutes); // Planificaci√≥n
app.use('/api/core', coreRoutes);           // Categor√≠as, Activos, Formularios
app.use('/api/reportes', reportesRoutes);   // Operaci√≥n Diaria (Checklists)
app.use('/api/acpm', acpmRoutes);           // Acciones Correctivas
app.use('/api/specialized', specializedRoutes); // Archivos, Agua y Kiosco
app.use('/api/dashboard', dashboardRoutes);
app.use('/api/drive', driveRoutes);
app.use('/api/capacitacion', capacitacionRoutes);
app.use('/api/auditoria', auditRoutes);
app.use('/api/bitacora', auditGlobalRoutes);
app.use('/api/notificaciones', notificationRoutes);
app.use('/api/trazabilidad', trazabilidadRoutes);
app.use('/api/certificados', certificadosRoutes);
app.use('/api/auditorias', auditoriaRoutes);
app.use('/api/pesos', pesosRoutes);
app.use('/api/externos', externosRoutes);
app.use('/api/proveedores', proveedoresRoutes);
// Rutas para el m√≥dulo de Recall (Documentaci√≥n y Salidas)
app.use('/api/recall', recallRoutes);
// Rutas PMIR (Gesti√≥n de Residuos)
app.use('/api/pmir', pmirRoutes);
app.use('/api/actas', actasRoutes);
// Ruta de prueba b√°sica
app.get('/ping', (req, res) => res.send('pong - El servidor est√° vivo'));

// --- INICIAR SERVIDOR ---
const PORT = process.env.PORT || 3000;

app.listen(PORT, async () => {
    console.log(`\n==================================================`);
    console.log(`üöÄ Servidor corriendo en http://localhost:${PORT}`);
    console.log(`==================================================`);
    
    // Verificamos conexi√≥n a SQL Server al iniciar
    try {
        await getConnection();
        console.log('‚úÖ Conexi√≥n a SQL Server: EXITOSA');
        console.log('üìÇ Carpeta de cargas p√∫blica en: /uploads');

        // --- INICIAR EL RELOJ AUTOM√ÅTICO (CRON JOBS) ---
        // Esto activa la revisi√≥n de correos a las 8:00 AM
        iniciarCronJobs(); // <--- AGREGADO

    } catch (error) {
        console.error('‚ùå Error fatal al conectar con la base de datos:');
        console.error(error.message);
    }
});


==================================================================
ARCHIVO: backend\utils\createAdmin.js
==================================================================
// backend/createAdmin.js
import bcrypt from 'bcryptjs';
import { getConnection, sql } from '../config/db.js';

const crearSuperAdmin = async () => {
    console.log('üîÑ Iniciando creaci√≥n de Super Admin...');

    const cedula = '1001';
    const passwordPlana = '123456';
    const nombre = 'Super Admin';
    const rol = 'SuperAdmin';

    try {
        // 1. Generar el Hash usando la misma librer√≠a del proyecto
        const salt = await bcrypt.genSalt(10);
        const passwordHash = await bcrypt.hash(passwordPlana, salt);

        console.log('üîë Contrase√±a encriptada correctamente.');

        const pool = await getConnection();

        // 2. Verificar si existe y BORRARLO para crearlo desde cero (limpieza total)
        await pool.request()
            .input('Cedula', sql.NVarChar, cedula)
            .query("DELETE FROM Usuarios WHERE Cedula = @Cedula");

        // 3. Insertar el usuario nuevo
        await pool.request()
            .input('Cedula', sql.NVarChar, cedula)
            .input('PasswordHash', sql.NVarChar, passwordHash)
            .input('Nombre', sql.NVarChar, nombre)
            .input('Rol', sql.NVarChar, rol)
            .query(`
                INSERT INTO Usuarios (Cedula, Password_Hash, Nombre_Completo, Rol, Estado)
                VALUES (@Cedula, @PasswordHash, @Nombre, @Rol, 1)
            `);

        console.log('‚úÖ ¬°Usuario Admin creado/reseteado con √©xito!');
        console.log('-------------------------------------------');
        console.log(`üë§ C√©dula: ${cedula}`);
        console.log(`üîë Contrase√±a: ${passwordPlana}`);
        console.log('-------------------------------------------');

        process.exit(0);

    } catch (error) {
        console.error('‚ùå Error al crear admin:', error);
        process.exit(1);
    }
};

crearSuperAdmin();


==================================================================
ARCHIVO: frontend\eslint.config.js
==================================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])



==================================================================
ARCHIVO: frontend\package.json
==================================================================
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "date-fns": "^4.1.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "react": "^19.2.0",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^19.2.0",
    "react-icons": "^5.5.0",
    "react-router-dom": "^7.11.0",
    "recharts": "^3.6.0",
    "sweetalert2": "^11.26.10"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "vite": "^7.2.4"
  }
}



==================================================================
ARCHIVO: frontend\src\App.css
==================================================================



==================================================================
ARCHIVO: frontend\src\App.jsx
==================================================================
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './context/AuthProvider';
import ProtectedRoute from './components/ProtectedRoute';

// --- P√ÅGINAS P√öBLICAS ---
import Welcome from './pages/Welcome';
import Login from './pages/Login';
import Kiosco from './pages/public/Kiosco';

// --- P√ÅGINAS ADMIN ---
import DashboardAdmin from './pages/admin/DashboardAdmin';
import Usuarios from './pages/admin/Usuarios';
import Activos from './pages/admin/Activos';
import Dise√±adorForms from './pages/admin/Dise√±adorForms';
import CrearReporteAdmin from './pages/admin/CrearReporteAdmin'; 
import HistorialReportes from './pages/admin/HistorialReportes';
import HistorialAguaAdmin from './pages/admin/HistorialAguaAdmin';
import GestionACPM from './pages/admin/GestionACPM';
import Cronogramas from './pages/admin/Cronogramas';

// --- GESTI√ìN DE CALIDAD Y PROGRAMAS ---
import GestionCapacitaciones from './pages/admin/GestionCapacitaciones';
import GestionLimpieza from './pages/admin/GestionLimpieza';
import GestionTrazabilidad from './pages/admin/GestionTrazabilidad';
import GestionPlagas from './pages/admin/GestionPlagas';
import GestionAuditorias from './pages/admin/GestionAuditorias';
import GestionProveedores from './pages/admin/GestionProveedores';
import GestionCalibracion from './pages/admin/GestionCalibracion';
import GestionMuestreo from './pages/admin/GestionMuestreo'; 
import GestionPMIR from './pages/admin/GestionPMIR';

// --- NUEVOS PROGRAMAS ---
import GestionRecall from './pages/admin/GestionRecall';
import GestionHACCP from './pages/admin/GestionHACCP';
import GestionAlergenos from './pages/admin/GestionAlergenos';
import GestionElementosExtranos from './pages/admin/GestionElementosExtranos';
import ActasDestruccion from './pages/admin/ActasDestruccion'; // <--- NUEVO IMPORT

// --- SUPER ADMIN ---
import Auditoria from './pages/admin/Auditoria'; 
import BitacoraGlobal from './pages/admin/BitacoraGlobal';

// --- P√ÅGINAS COLABORADOR ---
import Reportes from './pages/colaborador/Reportes';
import AguaPotable from './pages/colaborador/AguaPotable';
import FichasTecnicas from './pages/colaborador/FichasTecnicas';

function App() {
  return (
    <BrowserRouter>
      <AuthProvider>
        <Routes>
          {/* ZONA P√öBLICA */}
          <Route path="/" element={<Welcome />} /> 
          <Route path="/login" element={<Login />} />
          <Route path="/kiosco" element={<Kiosco />} />
          
          {/* ZONA PROTEGIDA */}
          <Route element={<ProtectedRoute />}>
              
              {/* RUTAS ADMINISTRATIVAS GENERALES */}
              <Route path="/admin/dashboard" element={<DashboardAdmin />} />
              <Route path="/admin/usuarios" element={<Usuarios />} />
              <Route path="/admin/activos" element={<Activos />} />
              <Route path="/admin/forms" element={<Dise√±adorForms />} />
              
              {/* GESTI√ìN DE CALIDAD Y PROGRAMAS */}
              <Route path="/admin/capacitacion" element={<GestionCapacitaciones />} />
              <Route path="/admin/limpieza" element={<GestionLimpieza />} />
              <Route path="/admin/trazabilidad" element={<GestionTrazabilidad />} />
              <Route path="/admin/plagas" element={<GestionPlagas />} />
              <Route path="/admin/gestion-auditorias" element={<GestionAuditorias />} /> 
              <Route path="/admin/proveedores" element={<GestionProveedores />} />
              <Route path="/admin/calibracion" element={<GestionCalibracion />} /> 
              <Route path="/admin/muestreo" element={<GestionMuestreo />} />
              <Route path="/admin/pmir" element={<GestionPMIR />} />
              
              {/* NUEVOS PROGRAMAS AGREGADOS */}
              <Route path="/admin/recall" element={<GestionRecall />} />
              <Route path="/admin/haccp" element={<GestionHACCP />} />
              <Route path="/admin/alergenos" element={<GestionAlergenos />} />
              <Route path="/admin/elementos" element={<GestionElementosExtranos />} />
              <Route path="/admin/actas" element={<ActasDestruccion />} /> {/* <--- NUEVA RUTA */}
            

              {/* SEGUIMIENTO */}
              <Route path="/admin/acpm" element={<GestionACPM />} />
              <Route path="/admin/agua-historial" element={<HistorialAguaAdmin />} />
              <Route path="/admin/reportes" element={<HistorialReportes />} />
              <Route path="/admin/cronogramas" element={<Cronogramas />} />
              <Route path="/admin/crear-reporte" element={<CrearReporteAdmin />} />

              {/* EXCLUSIVO SUPERADMIN */}
              <Route path="/admin/auditoria" element={<Auditoria />} />
              <Route path="/admin/bitacora" element={<BitacoraGlobal />} />

              {/* RUTAS COLABORADOR */}
              <Route path="/colaborador/reportes" element={<Reportes />} />
              <Route path="/colaborador/agua" element={<AguaPotable />} />
              <Route path="/colaborador/fichas" element={<FichasTecnicas />} />

              <Route path="*" element={<Navigate to="/" replace />} />

          </Route>
        </Routes>
      </AuthProvider>
    </BrowserRouter>
  );
}

export default App;


==================================================================
ARCHIVO: frontend\src\components\FileManager.jsx
==================================================================
import { useState, useEffect } from 'react';
// IMPORTANTE: Aseg√∫rate de importar las utilidades de seguridad
import { API_URL, getAuthHeaders, apiFetchBlob, extractFilename } from '../services/api';
import Swal from 'sweetalert2';
import { 
    FaFolder, FaFilePdf, FaFileWord, FaFileExcel, FaFileImage, FaFile, 
    FaHome, FaPlus, FaFileUpload, FaTrash, FaChevronRight, FaSearch, FaDownload,
    FaFilePowerpoint, FaFileCode, FaFileVideo, FaFileAlt, FaSpinner, FaArrowLeft, FaEye
} from 'react-icons/fa';
import '../styles/Drive.css';

const FileManager = ({ initialFolderId, title, onClose }) => {
    const [currentFolder, setCurrentFolder] = useState(initialFolderId);
    const [content, setContent] = useState({ carpetas: [], archivos: [] });
    const [breadcrumbs, setBreadcrumbs] = useState([]); 
    const [searchTerm, setSearchTerm] = useState('');
    const [loading, setLoading] = useState(false);
    
    // Estado para feedback visual de carga al abrir archivos
    const [viewingId, setViewingId] = useState(null);

    // Toast Config
    const Toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true
    });

    useEffect(() => {
        if (currentFolder) loadContent(currentFolder);
    }, [currentFolder]);

    useEffect(() => {
        setBreadcrumbs([{ id: initialFolderId, name: title || 'Carpeta Ra√≠z' }]);
    }, [initialFolderId, title]);

    const loadContent = async (id) => {
        setLoading(true);
        try {
            const res = await fetch(`${API_URL}/drive/contenido/${id}`, { headers: getAuthHeaders() });
            const data = await res.json();
            setContent(data);
        } catch (error) {
            console.error(error);
            Toast.fire({ icon: 'error', title: 'Error al cargar contenido' });
        } finally { setLoading(false); }
    };

    // --- ACCIONES ---
    const handleCreateFolder = async () => {
        const { value: nombre } = await Swal.fire({
            title: 'Nueva Subcarpeta',
            input: 'text',
            inputPlaceholder: 'Nombre...',
            showCancelButton: true,
            confirmButtonText: 'Crear',
            confirmButtonColor: '#0c4760'
        });
        if (nombre) {
            try {
                await fetch(`${API_URL}/drive/carpeta`, {
                    method: 'POST', headers: getAuthHeaders(),
                    body: JSON.stringify({ nombre, idPadre: currentFolder })
                });
                Toast.fire({ icon: 'success', title: 'Carpeta creada' });
                loadContent(currentFolder);
            } catch (e) { Toast.fire({ icon: 'error', title: 'Error al crear' }); }
        }
    };

    const handleUploadFile = async () => {
        const { value: file } = await Swal.fire({
            title: 'Subir Archivo',
            input: 'file',
            showCancelButton: true,
            confirmButtonText: 'Subir',
            confirmButtonColor: '#0c4760'
        });
        if (file) {
            const formData = new FormData();
            formData.append('archivo', file);
            formData.append('idCarpeta', currentFolder);
            
            Swal.fire({ title: 'Subiendo...', didOpen: () => Swal.showLoading() });
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_URL}/drive/archivo`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData
                });
                if(res.ok) {
                    Swal.close();
                    Toast.fire({ icon: 'success', title: 'Archivo subido' });
                    loadContent(currentFolder);
                } else throw new Error();
            } catch (e) { Swal.close(); Swal.fire('Error', 'Fallo la subida', 'error'); }
        }
    };

    const handleDeleteFile = async (e, idDoc) => {
        e.stopPropagation();
        if (await confirmAction('¬øEliminar archivo?')) {
            await fetch(`${API_URL}/drive/archivo/${idDoc}`, { method: 'DELETE', headers: getAuthHeaders() });
            loadContent(currentFolder);
            Toast.fire({ icon: 'success', title: 'Eliminado' });
        }
    };

    const handleDeleteFolder = async (e, idCarpeta) => {
        e.stopPropagation();
        if (await confirmAction('¬øEliminar carpeta?')) {
            await fetch(`${API_URL}/drive/carpeta/${idCarpeta}`, { method: 'DELETE', headers: getAuthHeaders() });
            loadContent(currentFolder);
            Toast.fire({ icon: 'success', title: 'Eliminado' });
        }
    };

    // --- DESCARGA SEGURA (Por ID) ---
    const handleDownload = async (e, idDoc, nombre) => {
        e.stopPropagation();
        Toast.fire({ icon: 'info', title: 'Iniciando descarga...' });
        try {
            // Usamos apiFetchBlob para manejar los headers de auth autom√°ticamente
            // Nota: Asumimos que el backend tiene ruta /drive/descargar/:id que devuelve stream
            const blob = await apiFetchBlob(`/drive/descargar/${idDoc}`);
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = nombre;
            document.body.appendChild(a); 
            a.click(); 
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (e) { 
            console.error(e);
            Swal.fire('Error', 'No se pudo descargar el archivo', 'error'); 
        }
    };

    // --- VISUALIZACI√ìN SEGURA (Nuevo) ---
    const handleViewFile = async (urlOriginal, id) => {
        if (!urlOriginal) return;
        setViewingId(id);
        try {
            const filename = extractFilename(urlOriginal);
            // Usamos una ruta de streaming espec√≠fica para Drive
            // Debes crear esta ruta en el backend: router.get('/ver/:nombreArchivo', ...)
            const blob = await apiFetchBlob(`/drive/ver/${filename}`);
            const url = window.URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error visualizando:", error);
            // Fallback por si acaso es un link externo antiguo
            if (urlOriginal.startsWith('http')) {
                window.open(urlOriginal, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo abrir el archivo.', 'error');
            }
        } finally {
            setViewingId(null);
        }
    };

    const confirmAction = async (title) => {
        const result = await Swal.fire({
            title, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠, eliminar'
        });
        return result.isConfirmed;
    };

    // Navegaci√≥n
    const handleEnterFolder = (folder) => {
        setBreadcrumbs([...breadcrumbs, { id: folder.ID_Carpeta, name: folder.NombreCarpeta }]);
        setCurrentFolder(folder.ID_Carpeta);
    };
    const handleBreadcrumbClick = (index) => {
        const newCrumbs = breadcrumbs.slice(0, index + 1);
        setBreadcrumbs(newCrumbs);
        setCurrentFolder(newCrumbs[newCrumbs.length - 1].id);
    };

    // Render Helpers
    const renderIcon = (tipo) => {
        const t = (tipo || '').toLowerCase();
        if (t.includes('pdf')) return <FaFilePdf className="item-icon icon-pdf" />;
        if (t.includes('word') || t.includes('doc')) return <FaFileWord className="item-icon icon-word" />;
        if (t.includes('sheet') || t.includes('excel')) return <FaFileExcel className="item-icon icon-excel" />;
        if (t.includes('image')) return <FaFileImage className="item-icon icon-img" />;
        return <FaFile className="item-icon icon-default" />;
    };

    const filteredFiles = content.archivos.filter(f => f.Nombre.toLowerCase().includes(searchTerm.toLowerCase()));
    const filteredFolders = content.carpetas.filter(c => c.NombreCarpeta.toLowerCase().includes(searchTerm.toLowerCase()));

    return (
        <div className="file-manager-embedded" style={{background: '#f8fafc', padding: '1rem', borderRadius: '8px', height: '100%', display: 'flex', flexDirection: 'column'}}>
            
            {/* Header del Componente */}
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                    <button onClick={onClose} style={{background:'none', border:'none', cursor:'pointer', color:'#64748b', fontSize:'1.1rem'}} title="Volver">
                        <FaArrowLeft />
                    </button>
                    <h3 style={{margin:0, color:'#0c4760'}}>{title}</h3>
                </div>
                <div style={{fontSize:'0.9rem', color:'#64748b'}}>Gesti√≥n de Archivos</div>
            </div>

            {/* Toolbar */}
            <div className="docs-toolbar" style={{padding:'0.5rem', marginBottom:'10px'}}>
                <div className="document-breadcrumb">
                    {breadcrumbs.map((crumb, idx) => (
                        <div key={crumb.id} style={{display:'flex', alignItems:'center'}}>
                            <span className={`breadcrumb-item ${idx === breadcrumbs.length-1 ? 'active' : ''}`} onClick={() => handleBreadcrumbClick(idx)}>
                                {idx===0 && <FaHome/>} {crumb.name}
                            </span>
                            {idx < breadcrumbs.length - 1 && <FaChevronRight size={10} style={{margin:'0 5px', color:'#ccc'}}/>}
                        </div>
                    ))}
                </div>
                <div style={{display:'flex', gap:'10px'}}>
                    <button className="btn-icon-action secondary" onClick={handleCreateFolder} title="Nueva Carpeta"><FaPlus/></button>
                    <button className="btn-icon-action primary" onClick={handleUploadFile} title="Subir Archivo"><FaFileUpload/></button>
                </div>
            </div>

            {/* Lista */}
            <div className="document-list-container" style={{flex:1, overflowY:'auto', border:'1px solid #e2e8f0'}}>
                <div className="document-list-header" style={{gridTemplateColumns: '40px 1fr 100px'}}>
                    <span>Tipo</span>
                    <span>Nombre</span>
                    <span style={{textAlign:'right'}}>Acciones</span>
                </div>

                {loading ? <div style={{padding:'2rem', textAlign:'center'}}><FaSpinner className="spin"/></div> : (
                    <>
                        {filteredFolders.map(folder => (
                            <div key={folder.ID_Carpeta} className="document-row" style={{gridTemplateColumns: '40px 1fr 100px'}} onClick={() => handleEnterFolder(folder)}>
                                <div className="doc-icon-wrapper"><FaFolder className="icon-folder"/></div>
                                <div className="doc-name">{folder.NombreCarpeta}</div>
                                <div className="doc-actions">
                                    <button className="btn-row-action delete" onClick={(e) => handleDeleteFolder(e, folder.ID_Carpeta)}><FaTrash/></button>
                                </div>
                            </div>
                        ))}
                        {filteredFiles.map(file => (
                            <div key={file.ID_Doc} className="document-row" style={{gridTemplateColumns: '40px 1fr 100px'}}>
                                <div className="doc-icon-wrapper">{renderIcon(file.Tipo_Origen)}</div>
                                
                                {/* NOMBRE CLICKABLE SEGURO */}
                                <div 
                                    className="doc-name" 
                                    onClick={() => handleViewFile(file.Url_Archivo, file.ID_Doc)}
                                    style={{
                                        cursor: viewingId === file.ID_Doc ? 'wait' : 'pointer', 
                                        color: '#334155',
                                        transition: 'color 0.2s',
                                        fontWeight: '500',
                                        opacity: viewingId === file.ID_Doc ? 0.7 : 1
                                    }}
                                    onMouseEnter={(e) => e.target.style.color = '#0c4760'}
                                    onMouseLeave={(e) => e.target.style.color = '#334155'}
                                    title="Clic para ver archivo"
                                >
                                    {viewingId === file.ID_Doc ? 'Cargando...' : file.Nombre}
                                </div>

                                <div className="doc-actions">
                                    <button className="btn-row-action download" onClick={(e) => handleDownload(e, file.ID_Doc, file.Nombre)}><FaDownload/></button>
                                    <button className="btn-row-action delete" onClick={(e) => handleDeleteFile(e, file.ID_Doc)}><FaTrash/></button>
                                </div>
                            </div>
                        ))}
                        {filteredFolders.length === 0 && filteredFiles.length === 0 && (
                            <div style={{padding:'2rem', textAlign:'center', color:'#94a3b8'}}>Carpeta vac√≠a</div>
                        )}
                    </>
                )}
            </div>
        </div>
    );
};

export default FileManager;


==================================================================
ARCHIVO: frontend\src\components\layout\MainLayout.jsx
==================================================================
import { useState } from 'react';
import Sidebar from './Sidebar';
import Navbar from './Navbar';
import useAuth from '../../hooks/useAuth';
import '../../styles/layout.css';

const MainLayout = ({ children }) => {
    const { auth } = useAuth();
    
    // Estado para controlar el sidebar en m√≥vil
    const [isMobileOpen, setIsMobileOpen] = useState(false);

    // Funci√≥n para alternar el estado (se la pasaremos al Navbar)
    const toggleSidebar = () => {
        setIsMobileOpen(!isMobileOpen);
    };

    // Verificamos si es colaborador para no renderizar sidebar
    const isColaborador = auth.user?.rol === 'Colaborador';

    return (
        <div className="layout-container">
            {/* Solo mostramos Sidebar si NO es colaborador */}
            {!isColaborador && (
                <>
                    {/* Sidebar recibe el estado para saber si agregar la clase .open */}
                    <Sidebar isOpen={isMobileOpen} />
                    
                    {/* Overlay oscuro para cerrar al hacer clic afuera (UX m√≥vil) */}
                    {isMobileOpen && (
                        <div 
                            className="mobile-overlay" 
                            onClick={() => setIsMobileOpen(false)}
                        ></div>
                    )}
                </>
            )}

            <main 
                className="main-content" 
                style={{ 
                    // En escritorio usamos margen, en m√≥vil el CSS lo fuerza a 0
                    marginLeft: isColaborador ? 0 : 'var(--sidebar-width)', 
                    width: isColaborador ? '100%' : 'calc(100% - var(--sidebar-width))' 
                }}
            >
                {/* PASAMOS LA FUNCI√ìN AL NAVBAR */}
                <Navbar onToggleSidebar={toggleSidebar} />
                
                <div className="page-content">
                    {children}
                </div>
            </main>
        </div>
    );
};

export default MainLayout;


==================================================================
ARCHIVO: frontend\src\components\layout\Navbar.jsx
==================================================================
import { useState, useEffect, useRef } from 'react';
import useAuth from '../../hooks/useAuth';
import { useNavigate } from 'react-router-dom';
import { getNotificaciones, deleteNotification } from '../../services/notificationService';
import '../../styles/Navbar.css';
import { FaBell, FaExclamationCircle, FaBars, FaInfoCircle, FaTimes } from 'react-icons/fa';
import ModalConfigCorreo from '../modals/ModalConfigCorreo';

const Navbar = ({ onToggleSidebar }) => {
    const { auth, logoutUser } = useAuth();
    const navigate = useNavigate();
    
    // Estados
    const [notificaciones, setNotificaciones] = useState([]);
    const [showNotifMenu, setShowNotifMenu] = useState(false);
    const [showProfileModal, setShowProfileModal] = useState(false);
    const notifRef = useRef(null);

    // Datos de Usuario
    const inicial = auth.user?.nombre ? auth.user.nombre.charAt(0).toUpperCase() : 'U';
    const nombreUsuario = auth.user?.nombre || 'Usuario';
    const rolUsuario = auth.user?.rol || 'Rol Desconocido';

    // Validaci√≥n de Rol
    const isColaborador = auth.user?.rol === 'Colaborador';
    
    // Validaci√≥n de Correo (Solo importa si NO es colaborador)
    const tieneCorreo = auth.user?.email && auth.user.email.trim() !== '';

    useEffect(() => {
        // Solo cargamos notificaciones si NO es colaborador y hay token
        if(auth.token && !isColaborador) {
            cargarNotificaciones();
            const interval = setInterval(cargarNotificaciones, 60000);
            return () => clearInterval(interval);
        }
    }, [auth.token, isColaborador]);

    // Cerrar men√∫ al hacer clic fuera
    useEffect(() => {
        function handleClickOutside(event) {
            if (notifRef.current && !notifRef.current.contains(event.target)) {
                setShowNotifMenu(false);
            }
        }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [notifRef]);

    const cargarNotificaciones = async () => {
        try {
            const data = await getNotificaciones();
            setNotificaciones(data);
        } catch (error) { console.error("Error notificaciones", error); }
    };

    const handleNotifClick = (notif) => {
        if (notif.Link) {
            navigate(notif.Link);
            setShowNotifMenu(false);
        }
    };

    const handleDelete = async (e, id) => {
        e.stopPropagation();
        const nuevas = notificaciones.filter(n => n.ID !== id);
        setNotificaciones(nuevas);
        if (id > 0) {
            await deleteNotification(id);
        }
    };

    return (
        <header className="navbar">
            
            {/* BOT√ìN HAMBURGUESA (Solo visible en m√≥vil y si NO es colaborador) */}
            {!isColaborador && (
                <button className="btn-hamburger" onClick={onToggleSidebar}>
                    <FaBars />
                </button>
            )}

            <div className="navbar-actions">
                
                {/* --- SECCI√ìN EXCLUSIVA PARA ADMINS (OCULTA PARA COLABORADORES) --- */}
                {!isColaborador && (
                    <>
                        {/* 1. ALERTA CONFIGURAR CORREO (Solo si no tiene) */}
                        {!tieneCorreo && (
                            <div 
                                className="nav-action-item danger-link" 
                                onClick={() => setShowProfileModal(true)}
                                title="Haz clic para configurar tu correo"
                            >
                                <FaExclamationCircle />
                                <span className="hide-on-mobile">Configurar Correo</span>
                            </div>
                        )}

                        {/* 2. CAMPANA DE NOTIFICACIONES */}
                        <div className="nav-action-item icon-only" style={{position:'relative'}} ref={notifRef}>
                            <div onClick={() => setShowNotifMenu(!showNotifMenu)} style={{cursor:'pointer', display:'flex'}}>
                                <FaBell />
                                {notificaciones.length > 0 && (
                                    <span className="bell-badge">{notificaciones.length}</span>
                                )}
                            </div>

                            {showNotifMenu && (
                                <div className="notif-dropdown">
                                    <div className="notif-header">
                                        <span>Notificaciones</span>
                                        {notificaciones.length > 0 && <span style={{fontSize:'0.75rem', fontWeight:'normal', color:'#64748b'}}>{notificaciones.length} nuevas</span>}
                                    </div>
                                    <div className="notif-list">
                                        {notificaciones.length === 0 ? (
                                            <div className="notif-empty">Sin novedades ‚úÖ</div>
                                        ) : (
                                            notificaciones.map((n, idx) => (
                                                <div key={idx} className={`notif-item ${n.Tipo === 'Alerta' || n.Tipo === 'Vencimiento' ? 'notif-danger' : ''}`} onClick={() => handleNotifClick(n)}>
                                                    <div className="notif-icon">{n.Tipo === 'Alerta' || n.Tipo === 'Vencimiento' ? <FaExclamationCircle/> : <FaInfoCircle/>}</div>
                                                    <div className="notif-content">
                                                        <div className="notif-title">{n.Titulo}</div>
                                                        <div className="notif-msg">{n.Mensaje}</div>
                                                        <div className="notif-date">{n.Fecha ? new Date(n.Fecha).toLocaleDateString() : 'Hoy'}</div>
                                                    </div>
                                                    <button className="btn-delete-notif" onClick={(e) => handleDelete(e, n.ID)} title="Descartar"><FaTimes /></button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="nav-divider"></div>
                    </>
                )}

                {/* --- INFORMACI√ìN DE USUARIO (Visible para todos) --- */}
                
                <div className="user-info" onClick={() => !isColaborador && setShowProfileModal(true)} style={{cursor: isColaborador ? 'default' : 'pointer'}}>
                    <span className="user-role">{rolUsuario}</span>
                    <span className="user-name">{nombreUsuario}</span>
                </div>

                <div 
                    className="user-avatar" 
                    onClick={() => !isColaborador && setShowProfileModal(true)} 
                    style={{cursor: isColaborador ? 'default' : 'pointer'}}
                >
                    {inicial}
                    {/* AQU√ç ELIMINAMOS EL SPAN status-indicator QUE HAC√çA EL PUNTO ROJO */}
                </div>

                <button onClick={logoutUser} className="btn-logout-nav">
                    Salir
                </button>
            </div>

            {/* MODAL DE PERFIL (Solo accesible si NO es colaborador) */}
            {!isColaborador && (
                <ModalConfigCorreo 
                    isOpen={showProfileModal} 
                    onClose={() => setShowProfileModal(false)} 
                />
            )}
        </header>
    );
};

export default Navbar;


==================================================================
ARCHIVO: frontend\src\components\layout\Sidebar.jsx
==================================================================
import { Link, useLocation } from 'react-router-dom';
import useAuth from '../../hooks/useAuth';
import '../../styles/Sidebar.css';
import logoImg from '../../assets/logo_eltrece.png';

import { 
    FaUsers, FaClipboardList, FaFileSignature, FaHistory, 
    FaCalendarAlt, FaIndustry, FaClipboardCheck, FaTint,
    FaGraduationCap, FaUserSecret, FaShieldAlt, FaBroom, FaRoute,
    FaBug, FaHandshake, FaBalanceScale, FaVial, FaRecycle,
    // Nuevos Iconos
    FaBullhorn, FaMagnet, FaBreadSlice, FaStore, FaBiohazard, FaTrash
} from 'react-icons/fa';
import { MdDashboard } from 'react-icons/md';

const Sidebar = ({ isOpen }) => {
    const { auth } = useAuth();
    const location = useLocation();
    
    const isActive = (path) => location.pathname === path ? 'active' : '';
    
    const rol = auth.user?.rol;

    // L√≥gica para que SuperAdmin y AdminCalidad compartan el men√∫ principal
    const esGestor = rol === 'SuperAdmin' || rol === 'AdminCalidad';

    return (
        <aside className={`sidebar ${isOpen ? 'open' : ''}`}>
            
            <div className="sidebar-header">
                <img src={logoImg} alt="El Trece Logo" className="sidebar-logo-img" />
                <h2 className="system-title">SISTEMA DE GESTI√ìN DE CALIDAD</h2>
            </div>

            <nav className="sidebar-nav">
                
                {/* 1. OPCIONES EXCLUSIVAS DE SUPER ADMIN (Solo √©l las ve) */}
                {rol === 'SuperAdmin' && (
                    <>
                        <div className="sidebar-section-label">SUPERVISI√ìN T√âCNICA</div>
                        
                        <Link to="/admin/auditoria" className={`menu-item ${isActive('/admin/auditoria')}`}>
                            <div className="menu-item-content"><FaUserSecret /> Auditor√≠a (Logs)</div>
                        </Link>

                        <Link to="/admin/bitacora" className={`menu-item ${isActive('/admin/bitacora')}`}>
                            <div className="menu-item-content"><FaShieldAlt /> Bit√°cora Global</div>
                        </Link>
                    </>
                )}

                {/* 2. OPCIONES COMPARTIDAS (SuperAdmin + AdminCalidad) */}
                {esGestor && (
                    <>
                        <div className="sidebar-section-label">CENTRO DE COMANDO</div>
                        
                        <Link to="/admin/dashboard" className={`menu-item ${isActive('/admin/dashboard')}`}>
                            <div className="menu-item-content"><MdDashboard /> Dashboard Global</div>
                        </Link>

                        <div className="sidebar-section-label">CONFIGURACI√ìN</div>

                        <Link to="/admin/usuarios" className={`menu-item ${isActive('/admin/usuarios')}`}>
                            <div className="menu-item-content"><FaUsers /> Gesti√≥n de Usuarios</div>
                        </Link>

                        <Link to="/admin/activos" className={`menu-item ${isActive('/admin/activos')}`}>
                            <div className="menu-item-content"><FaIndustry /> Activos y Maquinaria</div>
                        </Link>

                        <Link to="/admin/forms" className={`menu-item ${isActive('/admin/forms')}`}>
                            <div className="menu-item-content"><FaClipboardList /> Dise√±ador de Forms</div>
                        </Link>
                        
                        <div className="sidebar-section-label">PROGRAMAS DE CALIDAD</div>
                        
                        <Link to="/admin/capacitacion" className={`menu-item ${isActive('/admin/capacitacion')}`}>
                            <div className="menu-item-content"><FaGraduationCap /> Capacitaciones</div>
                        </Link>

                        <Link to="/admin/haccp" className={`menu-item ${isActive('/admin/haccp')}`}>
                            <div className="menu-item-content"><FaBiohazard /> Plan HACCP</div>
                        </Link>

                        <Link to="/admin/proveedores" className={`menu-item ${isActive('/admin/proveedores')}`}>
                            <div className="menu-item-content"><FaHandshake /> Proveedores</div>
                        </Link>

                        <Link to="/admin/calibracion" className={`menu-item ${isActive('/admin/calibracion')}`}>
                            <div className="menu-item-content"><FaBalanceScale /> Calibraci√≥n</div>
                        </Link>

                        <Link to="/admin/muestreo" className={`menu-item ${isActive('/admin/muestreo')}`}>
                            <div className="menu-item-content"><FaVial /> Muestreo</div>
                        </Link>

                        <Link to="/admin/pmir" className={`menu-item ${isActive('/admin/pmir')}`}>
                            <div className="menu-item-content"><FaRecycle /> PMIR (Residuos)</div>
                        </Link>

                        <Link to="/admin/limpieza" className={`menu-item ${isActive('/admin/limpieza')}`}>
                            <div className="menu-item-content"><FaBroom /> Limpieza y Desinfecci√≥n</div>
                        </Link>

                        <Link to="/admin/plagas" className={`menu-item ${isActive('/admin/plagas')}`}>
                            <div className="menu-item-content"><FaBug /> Control de Plagas</div>
                        </Link>

                        <Link to="/admin/alergenos" className={`menu-item ${isActive('/admin/alergenos')}`}>
                            <div className="menu-item-content"><FaBreadSlice /> Al√©rgenos</div>
                        </Link>

                        <Link to="/admin/elementos" className={`menu-item ${isActive('/admin/elementos')}`}>
                            <div className="menu-item-content"><FaMagnet /> Elementos Extra√±os</div>
                        </Link>

                        <Link to="/admin/recall" className={`menu-item ${isActive('/admin/recall')}`}>
                            <div className="menu-item-content"><FaBullhorn /> Recall (Retiro)</div>
                        </Link>

                        <Link to="/admin/actas" className={`menu-item ${isActive('/admin/actas')}`}>
                            <div className="menu-item-content"><FaTrash /> Actas de Destrucci√≥n</div>
                        </Link>

                        <Link to="/admin/gestion-auditorias" className={`menu-item ${isActive('/admin/gestion-auditorias')}`}>
                            <div className="menu-item-content"><FaClipboardCheck /> Gesti√≥n Auditor√≠as</div>
                        </Link>

                        <Link to="/admin/agua-historial" className={`menu-item ${isActive('/admin/agua-historial')}`}>
                            <div className="menu-item-content"><FaTint /> Agua Potable</div>
                        </Link>

                        <Link to="/admin/trazabilidad" className={`menu-item ${isActive('/admin/trazabilidad')}`}>
                            <div className="menu-item-content"><FaRoute /> Trazabilidad</div>
                        </Link>

                        <div className="sidebar-section-label">SEGUIMIENTO OPERATIVO</div>

                        <Link to="/admin/acpm" className={`menu-item ${isActive('/admin/acpm')}`}>
                            <div className="menu-item-content"><FaFileSignature /> Planes de Acci√≥n (ACPM)</div>
                        </Link>

                        <Link to="/admin/reportes" className={`menu-item ${isActive('/admin/reportes')}`}>
                            <div className="menu-item-content"><FaHistory /> Historial Reportes</div>
                        </Link>

                        <Link to="/admin/cronogramas" className={`menu-item ${isActive('/admin/cronogramas')}`}>
                            <div className="menu-item-content"><FaCalendarAlt /> Planificaci√≥n</div>
                        </Link>
                        
                        <Link to="/admin/crear-reporte" className={`menu-item ${isActive('/admin/crear-reporte')}`}>
                            <div className="menu-item-content"><FaClipboardCheck /> Realizar Reporte</div>
                        </Link>
                    </>
                )}

            </nav>

            <div className="sidebar-footer">
                <span className="footer-role-label">
                    {rol === 'SuperAdmin' ? 'SUPER USUARIO' : 'ADMIN CALIDAD'}
                </span>
                <span className="footer-user-name">
                    {auth.user?.nombre || 'USUARIO'}
                </span>
            </div>

        </aside>
    );
};

export default Sidebar;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalBitacora.jsx
==================================================================
import { useState } from 'react';
import { addSeguimiento } from '../../services/cronogramaService';
import '../../styles/Modal.css';
import { FaPaperPlane, FaTimes, FaHistory } from 'react-icons/fa';

const ModalBitacora = ({ isOpen, onClose, actividad, onSuccess }) => {
    const [nota, setNota] = useState('');

    if (!isOpen || !actividad) return null;

    // Convertir el string de bit√°cora "Fecha - Nota || Fecha - Nota ||" en Array
    // Separamos por '||' y filtramos vac√≠os
    const historial = actividad.Bitacora_Seguimiento 
        ? actividad.Bitacora_Seguimiento.split('||').filter(item => item.trim() !== '') 
        : [];

    const handleSend = async (e) => {
        e.preventDefault();
        if (!nota.trim()) return;
        try {
            await addSeguimiento(actividad.ID_Actividad, nota);
            setNota('');
            onSuccess(); // Recargar actividades para ver la nueva nota
        } catch (error) { alert('Error al guardar nota'); }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px'}}>
                <div className="modal-header">
                    <h3 style={{display:'flex', alignItems:'center', gap:'8px'}}>
                        <FaHistory color="#0c4760"/> Bit√°cora de Seguimiento
                    </h3>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>
                
                <div className="modal-body" style={{background:'#f8fafc', padding:'0'}}>
                    {/* ZONA DE CHAT / HISTORIAL */}
                    <div style={{maxHeight:'300px', overflowY:'auto', padding:'1.5rem', display:'flex', flexDirection:'column', gap:'10px'}}>
                        {historial.length === 0 ? (
                            <p style={{textAlign:'center', color:'#94a3b8', fontStyle:'italic'}}>No hay notas registradas.</p>
                        ) : (
                            historial.map((entry, idx) => {
                                // Separamos Fecha y Texto (Formato: "dd/MM/yyyy HH:mm - Texto")
                                const parts = entry.split(' - ');
                                const fecha = parts[0];
                                const texto = parts.slice(1).join(' - '); // Por si el texto ten√≠a guiones

                                return (
                                    <div key={idx} style={{background:'white', padding:'0.8rem', borderRadius:'8px', border:'1px solid #e2e8f0', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}}>
                                        <div style={{fontSize:'0.75rem', color:'#64748b', marginBottom:'4px', fontWeight:'bold'}}>{fecha}</div>
                                        <div style={{color:'#334155', fontSize:'0.9rem'}}>{texto}</div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* INPUT PARA NUEVA NOTA */}
                    <form onSubmit={handleSend} style={{padding:'1rem', borderTop:'1px solid #e2e8f0', background:'white', display:'flex', gap:'8px'}}>
                        <input 
                            type="text" 
                            placeholder="Escriba una observaci√≥n..." 
                            style={{flex:1, padding:'0.7rem', border:'1px solid #cbd5e1', borderRadius:'6px', outline:'none'}}
                            value={nota}
                            onChange={(e) => setNota(e.target.value)}
                            autoFocus
                        />
                        <button type="submit" className="btn-primary-modal" style={{padding:'0 1rem'}}>
                            <FaPaperPlane />
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default ModalBitacora;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalConfigCorreo.jsx
==================================================================
import { useState, useEffect } from 'react';
import useAuth from '../../hooks/useAuth';
import { updateEmailPerfil } from '../../services/userService';
import Swal from 'sweetalert2';
import '../../styles/Modal.css'; // Reutilizamos estilos base
import { FaTimes, FaEnvelope } from 'react-icons/fa';

const ModalConfigCorreo = ({ isOpen, onClose }) => {
    const { auth, setAuth } = useAuth(); // Necesitamos setAuth para actualizar el contexto localmente
    const [email, setEmail] = useState('');
    const [loading, setLoading] = useState(false);

    // Cargar email actual si existe en el usuario logueado
    useEffect(() => {
        if (isOpen && auth.user) {
            setEmail(auth.user.email || ''); 
        }
    }, [isOpen, auth.user]);

    if (!isOpen) return null;

    const handleSave = async (e) => {
        e.preventDefault();
        if (!email.includes('@') || !email.includes('.')) {
            return Swal.fire('Error', 'Ingrese un correo v√°lido', 'error');
        }

        setLoading(true);
        try {
            // 1. Guardar en BD
            await updateEmailPerfil(auth.user.id, email);
            
            // 2. Actualizar Contexto y LocalStorage (Para que desaparezca la alerta roja inmediatamente)
            const updatedUser = { ...auth.user, email: email };
            setAuth({ ...auth, user: updatedUser });
            localStorage.setItem('user', JSON.stringify(updatedUser));

            Swal.fire({
                icon: 'success',
                title: 'Perfil Actualizado',
                text: 'Recibir√°s notificaciones a este correo.',
                timer: 2000,
                showConfirmButton: false
            });
            onClose();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    // Estilos inline espec√≠ficos para replicar la imagen exacta
    const avatarCircle = {
        width: '80px', height: '80px', borderRadius: '50%',
        backgroundColor: '#0c4760', color: 'white',
        fontSize: '2.5rem', fontWeight: 'bold',
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        margin: '0 auto 10px auto'
    };

    const cardProfile = {
        border: '1px solid #e2e8f0', borderRadius: '8px', padding: '20px',
        textAlign: 'center', backgroundColor: '#f8fafc', marginBottom: '20px'
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '450px'}}>
                <div className="modal-header" style={{borderBottom:'none', paddingBottom:0}}>
                    <h2 style={{fontSize:'1.5rem'}}>Mi Perfil</h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>
                
                <div style={{padding:'0 1.5rem'}}><hr style={{borderTop:'1px solid #f1f5f9', margin:'10px 0 20px 0'}}/></div>

                <div className="modal-body" style={{paddingTop:0}}>
                    {/* TARJETA DE PERFIL (Como en la imagen) */}
                    <div style={cardProfile}>
                        <div style={avatarCircle}>
                            {auth.user.nombre.charAt(0).toUpperCase()}
                        </div>
                        <h3 style={{margin:'5px 0', color:'#0f172a'}}>{auth.user.nombre}</h3>
                        <div style={{color:'#64748b', fontSize:'0.9rem'}}>{auth.user.rol}</div>
                        <div style={{color:'#94a3b8', fontSize:'0.8rem'}}>ID: {auth.user.cedula || auth.user.id}</div>
                    </div>

                    <form onSubmit={handleSave}>
                        <div className="form-group">
                            <label style={{display:'flex', alignItems:'center', gap:'8px', color:'#0c4760'}}>
                                <FaEnvelope /> Correo Electr√≥nico
                            </label>
                            <input 
                                type="email" 
                                placeholder="ejemplo@empaquetadoseltrece.com.co"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                style={{padding:'10px', fontSize:'1rem'}}
                                autoFocus
                            />
                            <small style={{color:'#64748b', marginTop:'5px'}}>
                                Recibir√°s notificaciones de seguridad y alertas a este correo.
                            </small>
                        </div>

                        <div style={{display:'flex', gap:'10px', marginTop:'2rem'}}>
                            <button type="button" className="btn-secondary" style={{flex:1, background:'#6c757d', color:'white', border:'none'}} onClick={onClose}>
                                Cancelar
                            </button>
                            <button type="submit" className="btn-primary-modal" style={{flex:1, background:'#007bff'}} disabled={loading}>
                                {loading ? 'Guardando...' : 'Guardar y Actualizar'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default ModalConfigCorreo;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCrearAuditoria.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { createAuditoria, getAuditoresList, getAreasList } from '../../services/auditoriaService';
import '../../styles/Modal.css'; // Aseg√∫rate de que este archivo tenga las clases nuevas
import { FaTimes, FaCloudUploadAlt, FaCheck } from 'react-icons/fa';

const ModalCrearAuditoria = ({ isOpen, onClose, onSuccess }) => {
    const [formData, setFormData] = useState({
        tipo: 'Interna',
        auditor: '',
        area: '',
        normas: '',
        observaciones: ''
    });

    const [archivo, setArchivo] = useState(null);
    const [auditoresDB, setAuditoresDB] = useState([]);
    const [areasDB, setAreasDB] = useState([]);
    
    // Estados para "OTRO"
    const [isOtroAuditor, setIsOtroAuditor] = useState(false);
    const [nuevoAuditor, setNuevoAuditor] = useState('');
    const [isOtraArea, setIsOtraArea] = useState(false);
    const [nuevaArea, setNuevaArea] = useState('');

    // --- 1. BLOQUEO DE SCROLL DEL FONDO (Igual que en los otros modales) ---
    useEffect(() => {
        if(isOpen) {
            document.body.style.overflow = 'hidden'; // Bloquear fondo
            cargarListas();
            // Reset
            setFormData({ tipo: 'Interna', auditor: '', area: '', normas: '', observaciones: '' });
            setArchivo(null);
            setIsOtroAuditor(false); setIsOtraArea(false);
            setNuevoAuditor(''); setNuevaArea('');
        } else {
            document.body.style.overflow = 'unset'; // Desbloquear fondo
        }
        return () => { document.body.style.overflow = 'unset'; };
    }, [isOpen]);

    const cargarListas = async () => {
        try {
            const auds = await getAuditoresList();
            setAuditoresDB(auds);
            const areas = await getAreasList();
            setAreasDB(areas);
        } catch (error) { console.error(error); }
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setArchivo(e.target.files[0]);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        let finalAuditor = formData.auditor;
        let finalArea = formData.area;

        // Gesti√≥n de "OTRO"
        if(isOtroAuditor) {
            if(!nuevoAuditor.trim()) return Swal.fire('Error', 'Escriba el nombre del nuevo auditor', 'warning');
            finalAuditor = nuevoAuditor.trim();
            await getAuditoresList(finalAuditor); 
        }

        if(isOtraArea) {
            if(!nuevaArea.trim()) return Swal.fire('Error', 'Escriba el nombre de la nueva √°rea', 'warning');
            finalArea = nuevaArea.trim();
            await getAreasList(finalArea);
        }

        const dataToSend = new FormData();
        dataToSend.append('tipo', formData.tipo);
        dataToSend.append('auditor', finalAuditor);
        dataToSend.append('area', finalArea);
        dataToSend.append('normas', formData.normas);
        dataToSend.append('observaciones', formData.observaciones);
        
        if (archivo) {
            dataToSend.append('evidencia', archivo);
        }

        try {
            await createAuditoria(dataToSend);
            
            Swal.fire({
                title: '¬°Registrado!',
                text: 'La auditor√≠a y sus evidencias se han guardado correctamente.',
                icon: 'success',
                timer: 2000
            });
            onSuccess();
            onClose();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo subir la auditor√≠a. Revise el tama√±o del archivo.', 'error');
        }
    };

    if(!isOpen) return null;

    return (
        <div className="modal-overlay">
            {/* USAMOS LA CLASE MAESTRA: modal-content-fixed */}
            <div className="modal-content-fixed" style={{maxWidth:'700px'}}>
                
                {/* HEADER FIJO */}
                <div className="modal-header-fixed">
                    <h2 style={{margin:0}}>Nueva Auditor√≠a de Calidad</h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>
                
                {/* BODY SCROLLABLE (Envuelve al form content) */}
                <div className="modal-body-scrollable">
                    <form id="formAuditoria" onSubmit={handleSubmit} encType="multipart/form-data">
                        
                        {/* TIPO */}
                        <div className="form-group">
                            <label>Tipo de Auditor√≠a *</label>
                            <select className="form-control" value={formData.tipo} onChange={e=>setFormData({...formData, tipo:e.target.value})}>
                                <option value="Interna">Auditor√≠a Interna</option>
                                <option value="Externa">Auditor√≠a Externa</option>
                            </select>
                        </div>

                        {/* AUDITOR (DIN√ÅMICO) */}
                        <div className="form-group">
                            <label>Auditor / Entidad *</label>
                            {!isOtroAuditor ? (
                                <select className="form-control" required value={formData.auditor} 
                                    onChange={(e) => {
                                        if(e.target.value === 'OTRO') {
                                            setIsOtroAuditor(true);
                                            setFormData({...formData, auditor: ''});
                                        } else {
                                            setFormData({...formData, auditor:e.target.value});
                                        }
                                    }}>
                                    <option value="">-- Seleccione Auditor --</option>
                                    {auditoresDB.map(a => (
                                        <option key={a.ID_Auditor} value={a.Nombre_Auditor}>{a.Nombre_Auditor}</option>
                                    ))}
                                    <option value="OTRO" style={{fontWeight:'bold', color:'#0ea5e9'}}>+ AGREGAR NUEVO...</option>
                                </select>
                            ) : (
                                <div style={{animation: 'fadeIn 0.3s'}}>
                                    <input className="form-control" placeholder="Escriba el nombre del nuevo auditor..." autoFocus
                                        value={nuevoAuditor} onChange={e=>setNuevoAuditor(e.target.value)} 
                                        style={{border:'2px solid #0ea5e9'}}
                                    />
                                    <small style={{color:'#64748b', display:'block', marginTop:'5px'}}>
                                        <span style={{cursor:'pointer', textDecoration:'underline'}} onClick={()=>setIsOtroAuditor(false)}>Cancelar y volver a lista</span>
                                        {' '}| Este nombre se guardar√° en la lista autom√°ticamente.
                                    </small>
                                </div>
                            )}
                        </div>

                        {/* √ÅREA (DIN√ÅMICO) */}
                        <div className="form-group">
                            <label>√Årea Auditada *</label>
                            {!isOtraArea ? (
                                <select className="form-control" required value={formData.area} 
                                    onChange={(e) => {
                                        if(e.target.value === 'OTRO') {
                                            setIsOtraArea(true);
                                            setFormData({...formData, area: ''});
                                        } else {
                                            setFormData({...formData, area:e.target.value});
                                        }
                                    }}>
                                    <option value="">-- Seleccione √Årea --</option>
                                    {areasDB.map(a => (
                                        <option key={a.ID_Area} value={a.Nombre_Area}>{a.Nombre_Area}</option>
                                    ))}
                                    <option value="OTRO" style={{fontWeight:'bold', color:'#0ea5e9'}}>+ AGREGAR NUEVA...</option>
                                </select>
                            ) : (
                                <div style={{animation: 'fadeIn 0.3s'}}>
                                    <input className="form-control" placeholder="Escriba el nombre de la nueva √°rea..." autoFocus
                                        value={nuevaArea} onChange={e=>setNuevaArea(e.target.value)} 
                                        style={{border:'2px solid #0ea5e9'}}
                                    />
                                    <small style={{color:'#64748b', display:'block', marginTop:'5px'}}>
                                        <span style={{cursor:'pointer', textDecoration:'underline'}} onClick={()=>setIsOtraArea(false)}>Cancelar y volver a lista</span>
                                        {' '}| Esta √°rea se guardar√° en la lista autom√°ticamente.
                                    </small>
                                </div>
                            )}
                        </div>

                        <div className="form-group">
                            <label>Normas / Criterios</label>
                            <input className="form-control" placeholder="Ej: ISO 9001, BPM..."
                                value={formData.normas} onChange={e=>setFormData({...formData, normas:e.target.value})} />
                        </div>

                        <div className="form-group">
                            <label>Observaciones</label>
                            <textarea className="form-control" rows="3" 
                                value={formData.observaciones} onChange={e=>setFormData({...formData, observaciones:e.target.value})} />
                        </div>

                        {/* INPUT FILE */}
                        <div className="form-group">
                            <label>Adjuntar Evidencia (PDF, Imagen, Doc)</label>
                            <div style={{border:'2px dashed #cbd5e1', padding:'20px', borderRadius:'8px', textAlign:'center', backgroundColor:'#f8fafc', position:'relative'}}>
                                <input 
                                    type="file" 
                                    id="fileEvidencia"
                                    onChange={handleFileChange}
                                    style={{position:'absolute', top:0, left:0, width:'100%', height:'100%', opacity:0, cursor:'pointer'}}
                                />
                                <FaCloudUploadAlt size={30} color="#64748b" />
                                <p style={{margin:'10px 0 0', color:'#475569', fontSize:'0.9rem'}}>
                                    {archivo ? (
                                        <strong style={{color:'#0ea5e9'}}><FaCheck/> {archivo.name}</strong>
                                    ) : (
                                        "Haz clic o arrastra un archivo aqu√≠"
                                    )}
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                {/* FOOTER FIJO */}
                <div className="modal-footer-fixed">
                    <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                    {/* El bot√≥n est√° fuera del form, as√≠ que usamos form="idForm" o movemos el bot√≥n dentro */}
                    <button type="submit" form="formAuditoria" className="btn-primary-modal">Registrar Auditor√≠a</button>
                </div>
                
            </div>
        </div>
    );
};

export default ModalCrearAuditoria;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateACPM.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { createACPM, getOrigenesACPM, addOrigenACPM } from '../../services/acpmService';
import { getUsers } from '../../services/userService';
import '../../styles/Modal.css';
import { FaPen } from 'react-icons/fa';

const ModalCreateACPM = ({ isOpen, onClose, onSuccess, initialData }) => {
    // --- ESTADO DEL FORMULARIO ---
    const [formData, setFormData] = useState({
        tipo: 'Correctiva',
        origen: '',      // Texto libre (Ubicaci√≥n/Referencia del hallazgo)
        origenPlan: '',  // Desplegable (Fuente: Auditor√≠a, Indicador, etc.)
        descripcion: '', // Descripci√≥n del Hallazgo
        planAccion: '',  // Tareas a realizar
        responsable: '',
        fechaLimite: '',
        analisisCausa: '',
        idReporte: null,   // Vinculaci√≥n con Reportes Operativos
        idAuditoria: null  // Vinculaci√≥n con Auditor√≠as (NUEVO)
    });
    
    // --- ESTADOS AUXILIARES ---
    const [origenesList, setOrigenesList] = useState([]);
    const [isCustomOrigen, setIsCustomOrigen] = useState(false);
    const [customOrigenText, setCustomOrigenText] = useState('');
    const [usuarios, setUsuarios] = useState([]);
    const [loading, setLoading] = useState(false);

    // --- CARGA INICIAL ---
    useEffect(() => {
        if (isOpen) {
            cargarUsuarios();
            cargarOrigenes();
            
            // Si viene informaci√≥n precargada (desde Auditor√≠a o Reporte)
            if (initialData) {
                setFormData(prev => ({
                    ...prev,
                    tipo: 'Correctiva',
                    origen: initialData.origen || '', 
                    origenPlan: '', // El usuario debe seleccionar la fuente (ej: Auditor√≠a Interna)
                    descripcion: initialData.descripcion || '',
                    planAccion: '',
                    responsable: '',
                    fechaLimite: '',
                    analisisCausa: '',
                    idReporte: initialData.idReporte || null,
                    idAuditoria: initialData.idAuditoria || null // <--- IMPORTANTE PARA VINCULAR
                }));
                setIsCustomOrigen(false);
                setCustomOrigenText('');
            } else {
                // Limpiar formulario si se abre vac√≠o
                setFormData({
                    tipo: 'Correctiva', origen: '', origenPlan: '', descripcion: '', 
                    planAccion: '', responsable: '', fechaLimite: '', analisisCausa: '', 
                    idReporte: null, idAuditoria: null
                });
                setIsCustomOrigen(false);
                setCustomOrigenText('');
            }
        }
    }, [isOpen, initialData]);

    // --- SERVICIOS ---
    const cargarUsuarios = async () => {
        try {
            const data = await getUsers();
            setUsuarios(data);
        } catch (error) { console.error("Error cargando usuarios", error); }
    };

    const cargarOrigenes = async () => {
        try {
            const data = await getOrigenesACPM();
            setOrigenesList(data);
        } catch (error) { console.error("Error cargando or√≠genes", error); }
    };

    // --- HANDLERS ---
    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleOrigenPlanChange = (e) => {
        const value = e.target.value;
        if (value === 'OTRO_CUSTOM') {
            setIsCustomOrigen(true);
            setFormData({ ...formData, origenPlan: '' }); 
        } else {
            setIsCustomOrigen(false);
            setFormData({ ...formData, origenPlan: value });
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        let finalOrigenPlan = formData.origenPlan;

        // Si seleccion√≥ "Otro", validamos y guardamos el nuevo origen
        if (isCustomOrigen) {
            if (!customOrigenText.trim()) {
                return Swal.fire('Error', 'Debe especificar el nuevo Origen del Plan.', 'warning');
            }
            finalOrigenPlan = customOrigenText.trim();
            // Guardar nuevo origen en BD en segundo plano para futuro uso
            try { await addOrigenACPM(finalOrigenPlan); } catch (err) { /* Ignorar si ya existe */ }
        }

        setLoading(true);
        try {
            // Enviamos todo el objeto formData (incluyendo idAuditoria si existe)
            await createACPM({
                ...formData,
                origenPlan: finalOrigenPlan 
            });

            Swal.fire({
                title: 'Plan Creado',
                text: 'Se ha registrado el plan de acci√≥n correctamente.',
                icon: 'success',
                confirmButtonColor: '#0c4760',
                timer: 2000
            });
            
            if(onSuccess) onSuccess(); 
            onClose();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight:'95vh', display:'flex', flexDirection:'column'}}>
                
                <div className="modal-header">
                    <h2>Crear Nuevo Plan de Acci√≥n</h2>
                    <button className="modal-close-button" onClick={onClose}>√ó</button>
                </div>
                
                <form onSubmit={handleSubmit} style={{display:'flex', flexDirection:'column', flex:1, overflow:'hidden'}}>
                    <div className="modal-body" style={{overflowY:'auto', paddingRight:'1rem'}}>
                        
                        {/* FILA 1: TIPO Y ORIGEN DEL PLAN */}
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'1rem', marginBottom:'1rem'}}>
                            <div className="form-group" style={{margin:0}}>
                                <label>Tipo de Acci√≥n *</label>
                                <select name="tipo" value={formData.tipo} onChange={handleChange} className="form-control">
                                    <option value="Correctiva">Correctiva</option>
                                    <option value="Preventiva">Preventiva</option>
                                    <option value="Mejora">Oportunidad de Mejora</option>
                                </select>
                            </div>

                            <div className="form-group" style={{margin:0}}>
                                <label style={{display:'flex', justifyContent:'space-between'}}>
                                    <span>Origen del Plan *</span>
                                    {isCustomOrigen && (
                                        <button 
                                            type="button" 
                                            onClick={() => { setIsCustomOrigen(false); setFormData({...formData, origenPlan:''}); }}
                                            style={{background:'none', border:'none', color:'#0ea5e9', cursor:'pointer', fontSize:'0.8rem', textDecoration:'underline'}}
                                        >
                                            Ver lista
                                        </button>
                                    )}
                                </label>
                                
                                {!isCustomOrigen ? (
                                    <select 
                                        name="origenPlan" 
                                        value={formData.origenPlan} 
                                        onChange={handleOrigenPlanChange} 
                                        required 
                                        className="form-control"
                                    >
                                        <option value="">-- Seleccione Fuente --</option>
                                        {origenesList.map(item => (
                                            <option key={item.ID_Origen} value={item.Nombre_Origen}>
                                                {item.Nombre_Origen}
                                            </option>
                                        ))}
                                        <option value="OTRO_CUSTOM" style={{fontWeight:'bold', color:'#0c4760'}}>
                                            + Otro (Nuevo)
                                        </option>
                                    </select>
                                ) : (
                                    <div style={{position:'relative', animation: 'fadeIn 0.3s ease'}}>
                                        <input 
                                            type="text" 
                                            placeholder="Especifique nuevo origen..." 
                                            value={customOrigenText} 
                                            onChange={(e) => setCustomOrigenText(e.target.value)} 
                                            required 
                                            className="form-control"
                                            style={{paddingLeft:'2.5rem', borderColor:'#0ea5e9', background:'#f0f9ff'}}
                                            autoFocus
                                        />
                                        <FaPen style={{position:'absolute', left:'10px', top:'10px', color:'#0ea5e9'}}/>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* ORIGEN ESPEC√çFICO */}
                        <div className="form-group">
                            <label>Origen Espec√≠fico del Hallazgo (Ubicaci√≥n/Ref) *</label>
                            <input 
                                type="text"
                                name="origen" 
                                placeholder="Ej: Reporte #123, Auditor√≠a Noviembre, √Årea de Empaque..."
                                value={formData.origen} 
                                onChange={handleChange} 
                                required 
                                className="form-control"
                            />
                        </div>

                        {/* DESCRIPCI√ìN */}
                        <div className="form-group">
                            <label>Descripci√≥n del Problema/Hallazgo *</label>
                            <textarea 
                                name="descripcion" 
                                rows="3" 
                                value={formData.descripcion} 
                                onChange={handleChange} 
                                required 
                                className="form-control"
                                style={{resize:'vertical'}}
                            />
                        </div>

                        {/* PLAN DE ACCI√ìN */}
                        <div className="form-group">
                            <label>Plan de Acci√≥n (Actividades a realizar) *</label>
                            <textarea 
                                name="planAccion" 
                                rows="3" 
                                placeholder="¬øQu√© se va a hacer para corregirlo?"
                                value={formData.planAccion} 
                                onChange={handleChange} 
                                required 
                                className="form-control"
                            />
                        </div>

                        {/* RESPONSABLE */}
                        <div className="form-group">
                            <label>Responsable de la Ejecuci√≥n *</label>
                            <select name="responsable" value={formData.responsable} onChange={handleChange} required className="form-control">
                                <option value="">-- Seleccione un responsable --</option>
                                {usuarios.map(u => (
                                    <option key={u.ID_Usuario} value={u.Nombre_Completo}>{u.Nombre_Completo}</option>
                                ))}
                            </select>
                        </div>

                        {/* FECHA L√çMITE */}
                        <div className="form-group">
                            <label>Fecha L√≠mite *</label>
                            <input 
                                type="date" 
                                name="fechaLimite" 
                                value={formData.fechaLimite} 
                                onChange={handleChange} 
                                required 
                                className="form-control"
                            />
                        </div>

                        {/* AN√ÅLISIS CAUSA */}
                        <div className="form-group">
                            <label>An√°lisis de Causa (Opcional)</label>
                            <textarea 
                                name="analisisCausa" 
                                rows="2" 
                                placeholder="¬øPor qu√© ocurri√≥? (5 Porqu√©s, Espina de Pescado...)"
                                value={formData.analisisCausa} 
                                onChange={handleChange} 
                                className="form-control"
                            />
                        </div>

                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose} disabled={loading}>Cancelar</button>
                        <button type="submit" className="btn-primary-modal" style={{backgroundColor:'#007bff'}} disabled={loading}>
                            {loading ? 'Guardando...' : 'Crear Plan de Acci√≥n'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCreateACPM;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateActa.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { apiFetch } from '../../services/api'; // <--- Usamos nuestra api unificada
import { FaTimes, FaSave, FaCamera, FaImages, FaInfoCircle, FaBuilding, FaBoxOpen, FaUserTie, FaTrash, FaPen, FaCheckSquare } from 'react-icons/fa';
import '../../styles/Modal.css';

const ModalCreateActa = ({ isOpen, onClose, onSuccess }) => {
    const [formData, setFormData] = useState({
        codigo_formato: 'FT-SGC-019',
        sede: 'PLANTA CEDI CALDAS',
        testigos: '',
        producto: '',
        cantidad: '',
        bodega: '',
        novedad: '',
        elaborado_por: '',
        revisado_por: '',
        aprobado_por: '',
        aplica_saave: false, 
        nota_saave: 'SAAVE 1370 Doc realizado por operaciones en sofsin' 
    });
    
    const [fotos, setFotos] = useState([]); 
    const [loading, setLoading] = useState(false);
    const THEME_COLOR = '#0c4760';

    useEffect(() => {
        if(isOpen) {
            setFormData({
                codigo_formato: 'FT-SGC-019',
                sede: 'PLANTA CEDI CALDAS',
                testigos: '',
                producto: '',
                cantidad: '',
                bodega: '',
                novedad: '',
                elaborado_por: '',
                revisado_por: '',
                aprobado_por: '',
                aplica_saave: false,
                nota_saave: 'SAAVE 1370 Doc realizado por operaciones en sofsin'
            });
            setFotos([]);
        }
    }, [isOpen]);

    const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        const val = type === 'checkbox' ? checked : value;
        setFormData(prev => ({ ...prev, [name]: val }));
    };

    const handleFileChange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length + fotos.length > 4) {
            Swal.fire('L√≠mite excedido', 'Solo puedes adjuntar un m√°ximo de 4 fotos.', 'warning');
            return;
        }
        setFotos([...fotos, ...files]);
    };

    const removePhoto = (index) => {
        const newFotos = [...fotos];
        newFotos.splice(index, 1);
        setFotos(newFotos);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if(!formData.producto || !formData.cantidad || !formData.testigos) {
            Swal.fire('Campos obligatorios', 'Por favor complete Producto, Cantidad y Testigos.', 'warning');
            return;
        }

        setLoading(true);

        const data = new FormData();
        Object.keys(formData).forEach(key => data.append(key, formData[key]));
        
        // Importante: El backend espera req.files (upload.array('fotos'))
        fotos.forEach(file => data.append('fotos', file));

        try {
            // Usamos apiFetch: maneja URL base, token y detecta FormData autom√°ticamente
            await apiFetch('/actas', {
                method: 'POST',
                body: data
            });

            Swal.fire({
                title: '¬°Guardado!',
                text: 'Acta de destrucci√≥n registrada correctamente.',
                icon: 'success',
                confirmButtonColor: THEME_COLOR
            });
            onSuccess();
            onClose();
        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'No se pudo guardar el acta.', 'error');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '850px', borderRadius: '12px', padding: '0', overflow:'hidden'}}>
                
                {/* HEADER */}
                <div className="modal-header" style={{background: 'white', borderBottom: '1px solid #e2e8f0', padding: '1.5rem'}}>
                    <div style={{display:'flex', alignItems:'center', gap:'12px'}}>
                        <div style={{background:'#f0f9ff', padding:'12px', borderRadius:'50%', display:'flex', alignItems:'center', justifyContent:'center'}}>
                            <FaTrash size={20} color={THEME_COLOR}/>
                        </div>
                        <div>
                            <h2 style={{margin:0, fontSize: '1.4rem', color: THEME_COLOR}}>Nueva Acta de Destrucci√≥n</h2>
                            <p style={{margin:0, fontSize:'0.85rem', color:'#64748b'}}>Diligencie la informaci√≥n para legalizar el producto no conforme.</p>
                        </div>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color: '#94a3b8'}}><FaTimes/></button>
                </div>

                <div className="modal-body" style={{padding: '2rem', maxHeight: '70vh', overflowY: 'auto', background: '#f8fafc'}}>
                    
                    <div style={{background: '#eff6ff', borderLeft: '4px solid #3b82f6', padding: '12px 15px', borderRadius: '6px', marginBottom: '25px', display:'flex', gap:'12px', alignItems:'start'}}>
                        <FaInfoCircle size={18} color="#3b82f6" style={{marginTop:'3px'}}/>
                        <div>
                            <strong style={{color:'#1e3a8a', fontSize:'0.95rem'}}>Informaci√≥n Autom√°tica</strong>
                            <p style={{margin:0, fontSize:'0.85rem', color:'#64748b'}}>El <strong>N√∫mero de Acta</strong>, la <strong>Fecha</strong> y la <strong>Empresa</strong> se generar√°n autom√°ticamente al guardar.</p>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit}>
                        
                        {/* 1. UBICACI√ìN */}
                        <div style={{marginBottom:'25px'}}>
                            <h4 style={{color: THEME_COLOR, fontSize:'1rem', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px', marginBottom: '15px'}}>1. Datos Generales y Ubicaci√≥n</h4>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px'}}>
                                <div className="form-group">
                                    <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>C√≥digo Formato</label>
                                    <input className="form-control" name="codigo_formato" value={formData.codigo_formato} onChange={handleInputChange} style={{background:'white'}} />
                                </div>
                                <div className="form-group">
                                    <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}><FaBuilding style={{marginRight:'5px'}}/> Sede</label>
                                    <input className="form-control" name="sede" required value={formData.sede} onChange={handleInputChange} style={{background:'white'}} />
                                </div>
                            </div>
                        </div>

                        {/* 2. PRODUCTO (CON SAAVE) */}
                        <div style={{marginBottom:'25px'}}>
                            <h4 style={{color: THEME_COLOR, fontSize:'1rem', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px', marginBottom: '15px'}}>2. Detalles del Producto</h4>
                            <div className="form-group" style={{marginBottom:'15px'}}>
                                <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}><FaUserTie style={{marginRight:'5px'}}/> Testigos</label>
                                <input className="form-control" name="testigos" required value={formData.testigos} onChange={handleInputChange} placeholder="Nombres de los testigos..." />
                            </div>
                            
                            <div style={{display:'grid', gridTemplateColumns:'2fr 1fr 1fr', gap:'20px', marginBottom:'15px'}}>
                                <div className="form-group">
                                    <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}><FaBoxOpen style={{marginRight:'5px'}}/> Producto</label>
                                    <input className="form-control" name="producto" required value={formData.producto} onChange={handleInputChange} placeholder="Nombre del producto" />
                                </div>
                                <div className="form-group">
                                    <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Cantidad</label>
                                    <input className="form-control" name="cantidad" required value={formData.cantidad} onChange={handleInputChange} placeholder="Ej: 20 Kg" />
                                </div>
                                <div className="form-group">
                                    <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Bodega</label>
                                    <input className="form-control" name="bodega" required value={formData.bodega} onChange={handleInputChange} />
                                </div>
                            </div>

                            {/* CHECKBOX + CAMPO EDITABLE */}
                            <div style={{background:'#f0fdf4', border:'1px solid #86efac', borderRadius:'8px', padding:'15px'}}>
                                <div style={{display:'flex', alignItems:'center', gap:'10px', marginBottom: formData.aplica_saave ? '10px' : '0'}}>
                                    <input type="checkbox" id="checkSaave" name="aplica_saave" checked={formData.aplica_saave} onChange={handleInputChange} style={{width:'18px', height:'18px', cursor:'pointer', accentColor: '#16a34a'}} />
                                    <label htmlFor="checkSaave" style={{cursor:'pointer', color:'#15803d', fontWeight:'700', fontSize:'0.9rem', display:'flex', alignItems:'center', gap:'5px'}}>
                                        <FaCheckSquare /> Incluir Nota Oficial (SAAVE)
                                    </label>
                                </div>
                                {formData.aplica_saave && (
                                    <div className="fade-in">
                                        <label style={{fontWeight:'600', color:'#166534', fontSize:'0.8rem', display:'flex', alignItems:'center', gap:'5px', marginBottom:'5px'}}><FaPen size={10}/> Editar Contenido de la Nota:</label>
                                        <input className="form-control" name="nota_saave" value={formData.nota_saave} onChange={handleInputChange} style={{background:'white', border:'1px solid #16a34a', color:'#14532d', fontWeight:'500'}}/>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 3. JUSTIFICACI√ìN */}
                        <div style={{marginBottom:'25px'}}>
                            <h4 style={{color: THEME_COLOR, fontSize:'1rem', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px', marginBottom: '15px'}}>3. Justificaci√≥n</h4>
                            <div className="form-group">
                                <label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Novedad / Motivo</label>
                                <textarea className="form-control" name="novedad" rows="3" required value={formData.novedad} onChange={handleInputChange} placeholder="Describa el motivo de la destrucci√≥n..." style={{resize:'none'}} />
                                <small style={{display:'block', marginTop:'5px', color:'#94a3b8', fontStyle:'italic'}}>* Se incluir√° autom√°ticamente la declaraci√≥n legal de "no apto para consumo".</small>
                            </div>
                        </div>

                        {/* 4. FOTOS */}
                        <div style={{marginBottom:'25px'}}>
                            <h4 style={{color: THEME_COLOR, fontSize:'1rem', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px', marginBottom: '15px'}}>4. Registro Fotogr√°fico (M√°x 4)</h4>
                            <div style={{border:'2px dashed #cbd5e1', borderRadius:'8px', padding:'2rem', textAlign:'center', background:'white', cursor:'pointer', transition:'all 0.2s', marginBottom:'15px'}} onClick={()=>document.getElementById('fileInput').click()} onMouseEnter={(e)=>{e.currentTarget.style.borderColor=THEME_COLOR; e.currentTarget.style.background='#f8fafc'}} onMouseLeave={(e)=>{e.currentTarget.style.borderColor='#cbd5e1'; e.currentTarget.style.background='white'}}>
                                <FaCamera size={32} color="#94a3b8" style={{marginBottom:'10px'}}/>
                                <p style={{margin:0, color:'#475569', fontWeight:'500'}}>Haga clic aqu√≠ para adjuntar evidencias</p>
                                <p style={{margin:0, color:'#94a3b8', fontSize:'0.85rem'}}>Soporta im√°genes JPG, PNG</p>
                                <input id="fileInput" type="file" multiple accept="image/*" style={{display:'none'}} onChange={handleFileChange} />
                            </div>
                            {fotos.length > 0 && (
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(120px, 1fr))', gap:'10px'}}>
                                    {fotos.map((f, i) => (
                                        <div key={i} style={{background:'white', padding:'8px', borderRadius:'6px', border:'1px solid #e2e8f0', position:'relative', display:'flex', flexDirection:'column', alignItems:'center'}}>
                                            <div style={{width:'100%', height:'60px', background:'#f1f5f9', borderRadius:'4px', display:'flex', alignItems:'center', justifyContent:'center', marginBottom:'5px'}}><FaImages color="#64748b" size={24}/></div>
                                            <div style={{fontSize:'0.75rem', color:'#475569', width:'100%', whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis', textAlign:'center'}}>{f.name}</div>
                                            <button type="button" onClick={() => removePhoto(i)} style={{position:'absolute', top:'-5px', right:'-5px', background:'#ef4444', color:'white', border:'none', borderRadius:'50%', width:'20px', height:'20px', fontSize:'10px', cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center'}}><FaTimes/></button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* 5. RESPONSABLES */}
                        <div>
                            <h4 style={{color: THEME_COLOR, fontSize:'1rem', borderBottom: '1px solid #e2e8f0', paddingBottom: '8px', marginBottom: '15px'}}>5. Responsables</h4>
                            <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px', marginBottom:'20px'}}>
                                <div className="form-group"><label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Elaborado Por</label><input className="form-control" name="elaborado_por" value={formData.elaborado_por} onChange={handleInputChange} /></div>
                                <div className="form-group"><label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Revisado Por</label><input className="form-control" name="revisado_por" value={formData.revisado_por} onChange={handleInputChange} /></div>
                                <div className="form-group"><label style={{fontWeight:'600', color:'#475569', fontSize:'0.9rem'}}>Aprobado Por</label><input className="form-control" name="aprobado_por" value={formData.aprobado_por} onChange={handleInputChange} /></div>
                            </div>
                        </div>

                    </form>
                </div>

                <div className="modal-footer" style={{padding: '1.5rem', background:'white', borderTop:'1px solid #e2e8f0', display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                    <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                    <button type="button" onClick={handleSubmit} className="btn-primary" disabled={loading} style={{backgroundColor: THEME_COLOR, padding:'10px 30px', fontSize:'1rem'}}>
                        {loading ? 'Guardando...' : <><FaSave style={{marginRight:'8px'}}/> Guardar Acta</>}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalCreateActa;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateActividad.jsx
==================================================================
/* eslint-disable no-empty */
import { useState, useEffect } from 'react';
import { createActividad } from '../../services/cronogramaService';
import { getUsers } from '../../services/userService';
import '../../styles/Cronograma.css';

const ModalCreateActividad = ({ isOpen, onClose, idCronograma, onSuccess }) => {
    const [formData, setFormData] = useState({ nombreActividad: '', responsable: '', fechaLimite: '', descripcion: '' });
    const [usuarios, setUsuarios] = useState([]);

    // eslint-disable-next-line react-hooks/immutability
    useEffect(() => { if (isOpen) loadUsers(); }, [isOpen]);
    // eslint-disable-next-line no-unused-vars
    const loadUsers = async () => { try { setUsuarios(await getUsers()); } catch (e) {} };

    if (!isOpen) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await createActividad({ idCronograma, ...formData });
            onSuccess(); onClose();
        } catch (error) { alert(error.message); }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div className="modal-header-clean">
                    <h3>A√±adir Nueva Actividad</h3>
                    <button className="close-btn" onClick={onClose}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body-clean">
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Nombre de la Actividad *</label>
                            <input type="text" className="form-control" placeholder="Ej: Capacitaci√≥n Uso de EPP" required
                                value={formData.nombreActividad} onChange={e => setFormData({...formData, nombreActividad: e.target.value})} />
                        </div>
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Responsable *</label>
                            <select className="form-control" required value={formData.responsable} onChange={e => setFormData({...formData, responsable: e.target.value})}>
                                <option value="">-- Seleccione un responsable --</option>
                                {usuarios.map(u => <option key={u.ID_Usuario} value={u.Nombre_Completo}>{u.Nombre_Completo}</option>)}
                            </select>
                        </div>
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Fecha L√≠mite *</label>
                            <input type="date" className="form-control" required
                                value={formData.fechaLimite} onChange={e => setFormData({...formData, fechaLimite: e.target.value})} />
                        </div>
                        <div>
                            <label className="input-label">Descripci√≥n (Opcional)</label>
                            <textarea className="form-control" rows="2"
                                value={formData.descripcion} onChange={e => setFormData({...formData, descripcion: e.target.value})} />
                        </div>
                    </div>
                    <div className="modal-footer-clean">
                        <button type="button" className="btn btn-grey" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn btn-blue">A√±adir Actividad</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCreateActividad;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateActivo.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { createActivo, getCategorias } from '../../services/coreService';
import '../../styles/Modal.css';

const ModalCreateActivo = ({ isOpen, onClose, onSuccess }) => {
    // Estado del formulario id√©ntico a la imagen
    const [formData, setFormData] = useState({
        idCategoria: '',
        codigo: '',
        nombre: '',
        ubicacion: ''
    });

    const [categorias, setCategorias] = useState([]);

    useEffect(() => {
        if (isOpen) {
            // eslint-disable-next-line react-hooks/immutability
            cargarCategorias();
            // Limpiar formulario al abrir
            setFormData({ idCategoria: '', codigo: '', nombre: '', ubicacion: '' });
        }
    }, [isOpen]);

    const cargarCategorias = async () => {
        try {
            const data = await getCategorias();
            setCategorias(data);
        } catch (error) { console.error(error); }
    };

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        // Validaciones b√°sicas
        if (!formData.idCategoria || !formData.codigo || !formData.nombre) {
            Swal.fire('Atenci√≥n', 'Complete los campos obligatorios (*)', 'warning');
            return;
        }

        try {
            await createActivo(formData);
            Swal.fire({
                title: '¬°Activo Creado!',
                text: 'El activo ha sido registrado correctamente.',
                icon: 'success',
                confirmButtonColor: '#0c4760',
                timer: 2000
            });
            onSuccess(); // Recargar tabla
            onClose();   // Cerrar modal
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px'}}> {/* Ancho ajustado a la imagen */}
                
                {/* Header */}
                <div className="modal-header" style={{borderBottom:'none', paddingBottom:'0'}}> 
                    <h2 style={{fontSize:'1.5rem', fontWeight:'700'}}>Crear Nuevo Activo</h2>
                    <button className="modal-close-button" onClick={onClose}>√ó</button>
                </div>
                
                <div style={{padding:'0 2rem', marginBottom:'1rem'}}>
                    <hr style={{borderTop:'1px solid #e5e7eb', margin:0}}/>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body" style={{paddingTop:'0'}}>
                        
                        {/* 1. Tipo de Activo (Categor√≠a) */}
                        <div className="form-group">
                            <label>Tipo de Activo *</label>
                            <select 
                                name="idCategoria" 
                                value={formData.idCategoria} 
                                onChange={handleChange}
                                required
                                style={{height:'45px'}}
                            >
                                <option value="">Seleccione...</option>
                                {categorias.map(c => (
                                    <option key={c.ID_Categoria} value={c.ID_Categoria}>{c.Nombre}</option>
                                ))}
                            </select>
                        </div>

                        {/* 2. C√≥digo Identificador */}
                        <div className="form-group">
                            <label>C√≥digo Identificador *</label>
                            <input 
                                type="text" 
                                name="codigo"
                                placeholder="Ej: MAQ-01" 
                                value={formData.codigo} 
                                onChange={handleChange} 
                                required 
                            />
                        </div>

                        {/* 3. Nombre Descriptivo */}
                        <div className="form-group">
                            <label>Nombre Descriptivo *</label>
                            <input 
                                type="text" 
                                name="nombre"
                                placeholder="Ej: Taladro de Banco" 
                                value={formData.nombre} 
                                onChange={handleChange} 
                                required 
                            />
                        </div>

                        {/* 4. Ubicaci√≥n / √Årea */}
                        <div className="form-group">
                            <label>Ubicaci√≥n / √Årea</label>
                            <input 
                                type="text" 
                                name="ubicacion"
                                placeholder="Ej: Parqueadero / Bodega" 
                                value={formData.ubicacion} 
                                onChange={handleChange} 
                            />
                        </div>

                    </div>

                    <div style={{padding:'0 2rem 2rem 2rem', marginTop:'1rem', display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                        <hr style={{width:'100%', position:'absolute', left:0, bottom:'80px', borderTop:'1px solid #e5e7eb', margin:0}} />
                        
                        {/* Botones Id√©nticos */}
                        <button 
                            type="button" 
                            className="btn-secondary" 
                            onClick={onClose}
                            style={{backgroundColor:'#6c757d', color:'white', border:'none', fontWeight:'600'}}
                        >
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            className="btn-primary-modal" 
                            style={{backgroundColor:'#007bff', fontWeight:'600'}} // Azul brillante como la foto
                        >
                            Crear Activo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCreateActivo;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateCronograma.jsx
==================================================================
import { useState } from 'react';
import { createCronograma } from '../../services/cronogramaService';
import '../../styles/Cronograma.css';

const ModalCreateCronograma = ({ isOpen, onClose, onSuccess }) => {
    const [formData, setFormData] = useState({ 
        nombre: '', 
        anio: new Date().getFullYear(), 
        descripcion: '',
        tipo: 'GENERAL' 
    });
    
    if (!isOpen) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await createCronograma(formData);
            onSuccess(); 
            onClose();
            // Resetear el formulario al valor por defecto GENERAL
            setFormData({ nombre: '', anio: new Date().getFullYear(), descripcion: '', tipo: 'GENERAL' });
        } catch (error) { 
            alert('Error: ' + error.message); 
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div className="modal-header-clean">
                    <h3>Crear Nuevo Cronograma</h3>
                    <button className="close-btn" onClick={onClose}>&times;</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body-clean">
                        
                        {/* SELECTOR DE TIPO ACTUALIZADO (Sin Muestreo ni PMIR) */}
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Tipo de Programa</label>
                            <select 
                                className="form-control"
                                value={formData.tipo}
                                onChange={e => setFormData({...formData, tipo: e.target.value})}
                                style={{background: '#f8fafc', fontWeight:'600', color:'#0f172a'}}
                            >
                                <option value="GENERAL">General / Administrativo</option>
                                <option value="CALIBRACION">Programa de Calibraci√≥n</option>
                            </select>
                            <small style={{color:'#64748b', fontSize:'0.8rem'}}>
                                * Define en qu√© m√≥dulo aparecer√° este cronograma.
                            </small>
                        </div>

                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Nombre del Cronograma *</label>
                            <input type="text" className="form-control" placeholder="Ej: Plan Gesti√≥n Residuos 2026" required
                                value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} />
                        </div>
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">A√±o de Aplicaci√≥n</label>
                            <input type="number" className="form-control" placeholder="2026"
                                value={formData.anio} onChange={e => setFormData({...formData, anio: e.target.value})} />
                        </div>
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Descripci√≥n (Opcional)</label>
                            <textarea className="form-control" rows="2"
                                value={formData.descripcion} onChange={e => setFormData({...formData, descripcion: e.target.value})} />
                        </div>
                    </div>
                    <div className="modal-footer-clean">
                        <button type="button" className="btn btn-grey" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn btn-blue">Crear Cronograma</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
export default ModalCreateCronograma;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateForm.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { createFormulario, getCategorias, createCategoria } from '../../services/coreService';
import { FaTrash, FaPlus, FaList } from 'react-icons/fa';
import '../../styles/Modal.css';

const ModalCreateForm = ({ isOpen, onClose, onSuccess }) => {
    // Estado inicial
    const [formData, setFormData] = useState({
        codigo: '', 
        nombre: '', 
        descripcion: '', 
        categoria: '', 
        programa: 'General'
    });
    
    const [isCreatingCategory, setIsCreatingCategory] = useState(false);
    const [newCategoryName, setNewCategoryName] = useState('');
    
    const [preguntas, setPreguntas] = useState([]);
    const [newQText, setNewQText] = useState('');
    const [newQType, setNewQType] = useState('BOOL');
    const [categorias, setCategorias] = useState([]);

    useEffect(() => {
        if (isOpen) {
            cargarCategorias();
            setFormData({ codigo: '', nombre: '', descripcion: '', categoria: '', programa: 'General' });
            setPreguntas([]);
            setNewQText('');
            setNewQType('BOOL');
            setIsCreatingCategory(false);
            setNewCategoryName('');
        }
    }, [isOpen]);

    const cargarCategorias = async () => {
        try {
            const data = await getCategorias();
            setCategorias(data);
        } catch (error) { console.error(error); }
    };

    const handleAddPreguntaLocal = (e) => {
        if (e) e.preventDefault();
        if (!newQText.trim()) return;
        setPreguntas([...preguntas, { texto: newQText, tipo: newQType }]);
        setNewQText('');
    };

    const handleDeletePreguntaLocal = (index) => {
        setPreguntas(preguntas.filter((_, i) => i !== index));
    };

    const handleSave = async () => {
        if (!formData.codigo || !formData.nombre) {
            Swal.fire('Atenci√≥n', 'El C√≥digo y el Nombre son obligatorios', 'warning');
            return;
        }

        let finalCategoryId = formData.categoria;

        try {
            if (isCreatingCategory) {
                if (!newCategoryName.trim()) {
                    Swal.fire('Atenci√≥n', 'Escriba un nombre para la nueva categor√≠a', 'warning');
                    return;
                }
                await createCategoria(newCategoryName);
                const catsActualizadas = await getCategorias();
                const catNueva = catsActualizadas.find(c => c.Nombre === newCategoryName);
                if (catNueva) finalCategoryId = catNueva.ID_Categoria;
            } else {
                if (!formData.categoria) {
                    Swal.fire('Atenci√≥n', 'Seleccione una categor√≠a de activos', 'warning');
                    return;
                }
            }

            // ENVIAMOS EL FORMULARIO
            await createFormulario({
                idCategoria: finalCategoryId,
                titulo: formData.nombre,
                codigo: formData.codigo,
                descripcion: formData.descripcion,
                esVisible: true, // Visible por defecto
                programa: formData.programa,
                preguntas: preguntas
            });
            
            Swal.fire({
                title: '¬°Formulario Creado!',
                text: 'El formulario ya est√° visible y listo para usarse.',
                icon: 'success',
                confirmButtonColor: '#0c4760'
            });
            onSuccess();
            onClose();
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '750px'}}>
                <div className="modal-header">
                    <h2>Crear Nuevo Formulario</h2>
                    <button className="modal-close-button" onClick={onClose}>&times;</button>
                </div>

                <div className="modal-body">
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                        <div className="form-group">
                            <label>C√≥digo Identificador *</label>
                            <input type="text" placeholder="Ej: FTO-MUE-01" value={formData.codigo} onChange={e => setFormData({...formData, codigo: e.target.value})} />
                        </div>
                        <div className="form-group">
                            <label>Nombre del Formulario *</label>
                            <input type="text" value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} />
                        </div>
                    </div>

                    <div className="form-group">
                        <label>Descripci√≥n</label>
                        <input type="text" value={formData.descripcion} onChange={e => setFormData({...formData, descripcion: e.target.value})} />
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                        {/* SELECTOR DE CATEGOR√çA DE ACTIVOS */}
                        <div className="form-group" style={{background:'#f0f9ff', padding:'10px', borderRadius:'8px', border:'1px solid #bae6fd'}}>
                            <label style={{color:'#0369a1'}}>Categor√≠a de Activos *</label>
                            <div style={{display:'flex', gap:'5px', marginTop:'5px'}}>
                                {isCreatingCategory ? (
                                    <div style={{flex:1, display:'flex', gap:'5px'}}>
                                        <input type="text" placeholder="Nombre Nueva Cat." value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} style={{borderColor:'#0ea5e9'}} />
                                        <button className="btn-secondary" onClick={() => setIsCreatingCategory(false)}><FaList /></button>
                                    </div>
                                ) : (
                                    <div style={{flex:1, display:'flex', gap:'5px'}}>
                                        <select value={formData.categoria} onChange={e => setFormData({...formData, categoria: e.target.value})} style={{flex:1}}>
                                            <option value="">-- Seleccione --</option>
                                            {categorias.map(c => <option key={c.ID_Categoria} value={c.ID_Categoria}>{c.Nombre}</option>)}
                                        </select>
                                        <button className="btn-primary-modal" onClick={() => setIsCreatingCategory(true)}><FaPlus /></button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* SELECTOR DE PROGRAMA DESTINO - SIN PUNTOS DE VENTA */}
                        <div className="form-group" style={{background:'#f0fdf4', padding:'10px', borderRadius:'8px', border:'1px solid #bbf7d0'}}>
                            <label style={{color:'#166534', fontWeight:'bold'}}>Programa de Destino *</label>
                            <select 
                                value={formData.programa} 
                                onChange={e => setFormData({...formData, programa: e.target.value})}
                                style={{marginTop:'5px', borderColor:'#22c55e', fontWeight:'500'}}
                            >
                                <option value="General">General / Otros</option>
                                <option value="Limpieza y Desinfecci√≥n">Limpieza y Desinfecci√≥n (LYD)</option>
                                <option value="Calibraci√≥n">Calibraci√≥n</option>
                                <option value="Muestreo">Programa de Muestreo</option>
                                <option value="PMIR">Programa PMIR (Residuos)</option>
                                <option value="Control de Plagas">Control de Plagas</option>
                                <option value="Agua Potable">Agua Potable</option>
                                <option value="Trazabilidad">Trazabilidad</option>
                                <option value="Proveedores">Proveedores / Recepci√≥n</option>
                                <option value="Materia Prima">Materia Prima</option>
                                <option value="Capacitaci√≥n">Programa de Capacitaci√≥n</option>
                                <option value="Recall">Recall (Retiro de Producto)</option>
                                <option value="Elementos Extra√±os">Elementos Extra√±os</option>
                                <option value="Al√©rgenos">Control de Al√©rgenos</option>
                                <option value="HACCP">HACCP / PCC</option>
                            </select>
                            <small style={{color:'#15803d', fontSize:'0.75rem'}}>* Define d√≥nde se visualizar√°n los reportes.</small>
                        </div>
                    </div>

                    <hr style={{border:'0', borderTop:'1px solid #e2e8f0', margin:'1.5rem 0'}} />

                    {/* SECCI√ìN DE PREGUNTAS */}
                    <div>
                        <h3 style={{fontSize:'0.95rem', color:'#0f172a', marginBottom:'0.8rem', fontWeight:'600'}}>Campos del Formulario</h3>
                        
                        <div style={{display:'flex', flexDirection:'column', gap:'8px', marginBottom:'1rem', maxHeight:'200px', overflowY:'auto'}}>
                            {preguntas.map((p, i) => (
                                <div key={i} style={{display:'flex', gap:'10px', alignItems:'center', background:'white', border:'1px solid #e2e8f0', padding:'5px 10px', borderRadius:'6px'}}>
                                    <span style={{fontWeight:'bold', color:'#64748b', fontSize:'0.85rem'}}>{i+1}.</span>
                                    <div style={{flex:1, display:'flex', flexDirection:'column'}}>
                                        <span style={{fontSize:'0.9rem'}}>{p.texto}</span>
                                        <span style={{fontSize:'0.7rem', color: p.tipo==='BOOL'?'#16a34a':'#0369a1', fontWeight:'700'}}>
                                            {p.tipo === 'BOOL' ? 'SI/NO' : 'TEXTO'}
                                        </span>
                                    </div>
                                    <button onClick={() => handleDeletePreguntaLocal(i)} style={{background:'#fee2e2', color:'#ef4444', border:'none', borderRadius:'6px', padding:'0.5rem', cursor:'pointer'}}><FaTrash size={12}/></button>
                                </div>
                            ))}
                        </div>
                        
                        <div style={{display:'flex', gap:'10px'}}>
                            <select 
                                style={{flex:'0 0 100px', fontSize:'0.85rem'}}
                                value={newQType}
                                onChange={e => setNewQType(e.target.value)}
                            >
                                <option value="BOOL">Si / No</option>
                                <option value="TEXT">Texto</option>
                            </select>

                            <input 
                                type="text" 
                                placeholder={newQType === 'BOOL' ? "¬øQu√© verificar?" : "¬øQu√© dato solicitar?"}
                                value={newQText} 
                                onChange={e => setNewQText(e.target.value)} 
                                style={{flex:1, fontSize:'0.85rem'}} 
                                onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); handleAddPreguntaLocal(); } }}
                            />
                            <button type="button" className="btn-secondary" onClick={handleAddPreguntaLocal}>
                                <FaPlus/>
                            </button>
                        </div>
                    </div>
                </div>

                <div className="modal-footer">
                    <button className="btn-secondary" onClick={onClose}>Cancelar</button>
                    <button className="btn-primary-modal" onClick={handleSave}>Guardar Formulario</button>
                </div>
            </div>
        </div>
    );
};

export default ModalCreateForm;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateRecoleccion.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { FaTimes, FaSave, FaTruck, FaWeight, FaUserTie, FaBoxOpen, FaPencilAlt, FaCamera, FaFileUpload } from 'react-icons/fa';
import { API_URL, getAuthHeaders } from '../../services/api';
import { getListasExternas } from '../../services/externosService';

const ModalCreateRecoleccion = ({ isOpen, onClose, onSuccess }) => {
    
    // Estado del formulario (Sin observaciones)
    const [form, setForm] = useState({
        fecha: new Date().toISOString().split('T')[0],
        tipoMaterial: '',
        cantidad: '',
        peso: '',
        cliente: ''
    });

    // Estados auxiliares
    const [otroMaterial, setOtroMaterial] = useState('');
    const [evidenciaFile, setEvidenciaFile] = useState(null);

    // Listas y B√∫squeda
    const [listas, setListas] = useState({ materiales: [], clientes: [] });
    const [searchCliente, setSearchCliente] = useState('');
    const [showCliList, setShowCliList] = useState(false);

    const THEME_COLOR = '#0c4760';

    useEffect(() => {
        if (isOpen) {
            cargarListas();
            resetForm();
        }
    }, [isOpen]);

    const resetForm = () => {
        setForm({
            fecha: new Date().toISOString().split('T')[0],
            tipoMaterial: '',
            cantidad: '',
            peso: '',
            cliente: ''
        });
        setSearchCliente('');
        setOtroMaterial('');
        setEvidenciaFile(null);
    };

    const cargarListas = async () => {
        const data = await getListasExternas();
        setListas({
            materiales: ['Cart√≥n', 'Pl√°stico', 'Vidrio', 'Metal', 'Ordinarios', 'Peligrosos', 'Madera', 'Papel Archivo', 'Chatarra', 'Otro'], 
            clientes: data.clientes || [] 
        });
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setForm(prev => ({ ...prev, [name]: value }));
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setEvidenciaFile(e.target.files[0]);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!form.cliente) {
            return Swal.fire('Atenci√≥n', 'Debe seleccionar un Cliente / Gestor.', 'warning');
        }

        let materialFinal = form.tipoMaterial;
        if (materialFinal === 'Otro') {
            if (!otroMaterial.trim()) return Swal.fire('Atenci√≥n', 'Especifique el material.', 'warning');
            materialFinal = otroMaterial.trim();
        }

        try {
            const formData = new FormData();
            formData.append('fecha', form.fecha);
            formData.append('tipoMaterial', materialFinal);
            formData.append('cantidad', form.cantidad);
            formData.append('peso', form.peso);
            formData.append('cliente', form.cliente);
            // formData.append('observaciones') ELIMINADO
            
            if (evidenciaFile) {
                formData.append('documento', evidenciaFile);
            }

            const headers = getAuthHeaders();
            delete headers['Content-Type']; 

            const res = await fetch(`${API_URL}/pmir/recoleccion`, {
                method: 'POST',
                headers: headers,
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                Swal.fire({
                    title: 'Registrado',
                    text: 'Recolecci√≥n guardada exitosamente',
                    icon: 'success',
                    confirmButtonColor: THEME_COLOR
                });
                onSuccess();
                onClose();
            } else {
                Swal.fire('Error', data.message || 'No se pudo guardar.', 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Fallo de conexi√≥n.', 'error');
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay" style={{
            position: 'fixed', inset: 0, background: 'rgba(0, 0, 0, 0.5)', zIndex: 1000,
            display: 'flex', justifyContent: 'center', alignItems: 'center'
        }}>
            <div className="modal-content" style={{
                background: 'white', borderRadius: '12px', width: '550px', maxWidth: '95%', 
                boxShadow: '0 10px 25px rgba(0,0,0,0.2)', animation: 'fadeIn 0.2s ease-out'
            }}>
                
                {/* Header */}
                <div style={{padding: '15px 20px', borderBottom: '1px solid #e2e8f0', display: 'flex', justifyContent: 'space-between', alignItems: 'center', background: '#f8fafc', borderRadius: '12px 12px 0 0'}}>
                    <h3 style={{margin:0, color: THEME_COLOR, display:'flex', alignItems:'center', gap:'10px'}}><FaTruck /> Nueva Recolecci√≥n</h3>
                    <button onClick={onClose} style={{background:'none', border:'none', fontSize:'1.2rem', color:'#64748b', cursor:'pointer'}}><FaTimes /></button>
                </div>

                <form onSubmit={handleSubmit} style={{padding: '20px'}}>
                    
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginBottom:'15px'}}>
                        <div className="form-group">
                            <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'block'}}>Fecha</label>
                            <input type="date" name="fecha" value={form.fecha} onChange={handleChange} required style={{width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #cbd5e1'}}/>
                        </div>
                        <div className="form-group">
                            <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'block'}}>Material</label>
                            <select name="tipoMaterial" value={form.tipoMaterial} onChange={handleChange} required style={{width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #cbd5e1'}}>
                                <option value="">-- Seleccionar --</option>
                                {listas.materiales.map((mat, i) => (<option key={i} value={mat}>{mat}</option>))}
                            </select>
                        </div>
                    </div>

                    {form.tipoMaterial === 'Otro' && (
                        <div className="form-group fade-in" style={{marginBottom:'15px'}}>
                            <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'flex', alignItems:'center', gap:'5px'}}><FaPencilAlt /> Especifique</label>
                            <input type="text" placeholder="Nombre del material..." value={otroMaterial} onChange={(e) => setOtroMaterial(e.target.value)} required style={{width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #3b82f6', background:'#eff6ff'}} />
                        </div>
                    )}

                    {/* BUSCADOR CLIENTE */}
                    <div className="form-group" style={{position: 'relative', marginBottom: '15px'}}>
                        <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'flex', alignItems:'center', gap:'5px'}}><FaUserTie /> Cliente / Gestor *</label>
                        <input 
                            type="text" 
                            placeholder="Escriba para buscar..."
                            value={form.cliente} 
                            onChange={(e) => {
                                setForm({...form, cliente: e.target.value});
                                setSearchCliente(e.target.value);
                                setShowCliList(true);
                            }}
                            onFocus={() => setShowCliList(true)}
                            onBlur={() => setTimeout(() => setShowCliList(false), 200)}
                            required
                            style={{width:'100%', padding:'10px', borderRadius:'6px', border:'1px solid #cbd5e1'}}
                        />
                        {showCliList && (
                            <div style={{position: 'absolute', top: '100%', left: 0, width: '100%', maxHeight: '180px', overflowY: 'auto', background: 'white', border: '1px solid #cbd5e1', borderRadius: '0 0 8px 8px', zIndex: 100, boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)'}}>
                                {listas.clientes
                                    .filter(c => c.nombre.toLowerCase().includes((searchCliente || '').toLowerCase()))
                                    .slice(0, 50)
                                    .map(c => (
                                        <div key={c.codigo}
                                            onClick={() => {
                                                setForm({...form, cliente: c.nombre});
                                                setSearchCliente(c.nombre);
                                                setShowCliList(false);
                                            }}
                                            style={{padding: '10px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '0.9rem'}}
                                            onMouseEnter={(e) => e.target.style.background = '#f0f9ff'}
                                            onMouseLeave={(e) => e.target.style.background = 'white'}
                                        >
                                            {c.nombre}
                                        </div>
                                    ))}
                            </div>
                        )}
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginBottom:'15px'}}>
                        <div className="form-group">
                            <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'block'}}><FaBoxOpen /> Cantidad</label>
                            <input type="number" name="cantidad" value={form.cantidad} onChange={handleChange} placeholder="Ej. 10" style={{width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #cbd5e1'}} />
                        </div>
                        <div className="form-group">
                            <label style={{fontSize:'0.9rem', fontWeight:'600', color:'#475569', display:'block'}}><FaWeight /> Peso (Kg) *</label>
                            <input type="number" step="0.01" name="peso" value={form.peso} onChange={handleChange} required placeholder="0.00" style={{width:'100%', padding:'8px', borderRadius:'6px', border:'1px solid #cbd5e1'}} />
                        </div>
                    </div>

                    <div className="form-group" style={{marginBottom:'20px'}}>
                        <label style={{display:'flex', alignItems:'center', gap:'10px', fontSize:'0.9rem', fontWeight:'600', color:'#475569', marginBottom:'8px'}}>
                            <FaCamera /> Adjuntar Evidencia (Foto)
                        </label>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <label className="btn-secondary" style={{cursor:'pointer', display:'flex', alignItems:'center', gap:'8px', padding:'8px 15px', fontSize:'0.85rem', background:'#e2e8f0', borderRadius:'6px'}}>
                                <FaFileUpload /> Seleccionar Archivo
                                <input type="file" onChange={handleFileChange} style={{display:'none'}} accept="image/*,.pdf" />
                            </label>
                            {evidenciaFile && <span style={{color: THEME_COLOR, fontWeight:'bold', fontSize:'0.85rem'}}>{evidenciaFile.name}</span>}
                        </div>
                    </div>

                    {/* SECCI√ìN OBSERVACIONES ELIMINADA */}

                    <div style={{display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                        <button type="button" onClick={onClose} style={{padding:'10px 20px', borderRadius:'6px', border:'none', background:'#e2e8f0', color:'#475569', fontWeight:'bold', cursor:'pointer'}}>Cancelar</button>
                        <button type="submit" style={{padding:'10px 20px', borderRadius:'6px', border:'none', background: THEME_COLOR, color:'white', fontWeight:'bold', cursor:'pointer', display:'flex', alignItems:'center', gap:'8px'}}>
                            <FaSave /> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCreateRecoleccion;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateSalida.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { createSalida } from '../../services/recallService';
import { getListasExternas } from '../../services/externosService'; 
import { FaSave, FaTimes, FaTruck, FaBoxOpen, FaUserTie, FaCloudUploadAlt, FaCheck } from 'react-icons/fa';
import '../../styles/Modal.css';

const ModalCreateSalida = ({ isOpen, onClose, onSuccess }) => {
    const [formData, setFormData] = useState({
        fecha_envio: '',
        producto: '',
        lote: '',
        cliente: '',
        cantidad: '',
        observaciones: ''
    });
    
    const [archivo, setArchivo] = useState(null);
    const [listas, setListas] = useState({ productos: [], clientes: [] });
    const [loading, setLoading] = useState(false);
    
    // Estados para buscadores
    const [searchProd, setSearchProd] = useState('');
    const [searchCli, setSearchCli] = useState('');
    const [showProdList, setShowProdList] = useState(false);
    const [showCliList, setShowCliList] = useState(false);

    const THEME_COLOR = '#0c4760';

    useEffect(() => {
        if (isOpen) {
            cargarListas();
            setFormData({ fecha_envio: '', producto: '', lote: '', cliente: '', cantidad: '', observaciones: '' });
            setArchivo(null);
            setSearchProd('');
            setSearchCli('');
        }
    }, [isOpen]);

    const cargarListas = async () => {
        try {
            const data = await getListasExternas();
            setListas({
                productos: data.productos || [],
                clientes: data.clientes || [] 
            });
        } catch (error) {
            console.error("Error cargando listas:", error);
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.producto || !formData.cliente || !formData.fecha_envio) {
            return Swal.fire('Campos incompletos', 'Producto, Cliente y Fecha son obligatorios', 'warning');
        }

        setLoading(true);
        const data = new FormData();
        Object.keys(formData).forEach(key => data.append(key, formData[key]));
        if (archivo) data.append('documento', archivo);

        try {
            await createSalida(data);
            Swal.fire({
                title: '¬°Registrado!',
                text: 'Salida de producto registrada correctamente',
                icon: 'success',
                confirmButtonColor: THEME_COLOR,
                timer: 2000
            });
            onSuccess();
            onClose();
        } catch (error) {
            Swal.fire('Error', error.message || 'Error al guardar', 'error');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            {/* CORRECCI√ìN AQU√ç: maxHeight y overflowY para el scroll */}
            <div className="modal-content" style={{
                maxWidth: '650px', 
                maxHeight: '90vh', 
                overflowY: 'auto',
                display: 'flex',
                flexDirection: 'column'
            }}>
                <div className="modal-header">
                    <h2 style={{display:'flex', alignItems:'center', gap:'10px', color: THEME_COLOR}}>
                        <FaTruck /> Nueva Salida / Distribuci√≥n
                    </h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>

                <form onSubmit={handleSubmit} style={{display:'flex', flexDirection:'column', gap:'15px'}}>
                    <div className="modal-body">
                        
                        {/* FECHA Y LOTE */}
                        <div style={{display:'flex', gap:'15px', marginBottom:'15px'}}>
                            <div className="form-group" style={{flex:1}}>
                                <label>Fecha Env√≠o *</label>
                                <input 
                                    type="date" 
                                    className="form-control"
                                    required 
                                    value={formData.fecha_envio} 
                                    onChange={e => setFormData({...formData, fecha_envio: e.target.value})} 
                                />
                            </div>
                            <div className="form-group" style={{flex:1}}>
                                <label>Lote de Producci√≥n *</label>
                                <input 
                                    type="text" 
                                    className="form-control"
                                    placeholder="Ej: 2501-A"
                                    required 
                                    value={formData.lote} 
                                    onChange={e => setFormData({...formData, lote: e.target.value})} 
                                />
                            </div>
                        </div>

                        {/* PRODUCTO */}
                        <div className="form-group" style={{position:'relative', marginBottom:'15px'}}>
                            <label><FaBoxOpen/> Producto *</label>
                            <input 
                                type="text" 
                                className="form-control"
                                placeholder="Buscar producto..."
                                value={formData.producto}
                                onChange={e => {
                                    setFormData({...formData, producto: e.target.value});
                                    setSearchProd(e.target.value);
                                    setShowProdList(true);
                                }}
                                onFocus={() => setShowProdList(true)}
                                onBlur={() => setTimeout(() => setShowProdList(false), 200)}
                            />
                            {showProdList && searchProd && listas.productos.length > 0 && (
                                <div className="dropdown-suggestions">
                                    {listas.productos
                                        .filter(p => p.descripcion.toLowerCase().includes(searchProd.toLowerCase()))
                                        .slice(0, 8)
                                        .map((p, i) => (
                                            <div key={i} className="suggestion-item" onClick={() => {
                                                setFormData({...formData, producto: p.descripcion});
                                                setSearchProd(p.descripcion);
                                            }}>
                                                {p.descripcion}
                                            </div>
                                        ))}
                                </div>
                            )}
                        </div>

                        {/* CLIENTE */}
                        <div className="form-group" style={{position:'relative', marginBottom:'15px'}}>
                            <label><FaUserTie/> Cliente Destino *</label>
                            <input 
                                type="text" 
                                className="form-control"
                                placeholder="Buscar cliente..."
                                value={formData.cliente}
                                onChange={e => {
                                    setFormData({...formData, cliente: e.target.value});
                                    setSearchCli(e.target.value);
                                    setShowCliList(true);
                                }}
                                onFocus={() => setShowCliList(true)}
                                onBlur={() => setTimeout(() => setShowCliList(false), 200)}
                            />
                            {showCliList && searchCli && listas.clientes.length > 0 && (
                                <div className="dropdown-suggestions">
                                    {listas.clientes
                                        .filter(c => c.nombre.toLowerCase().includes(searchCli.toLowerCase()))
                                        .slice(0, 8)
                                        .map((c, i) => (
                                            <div key={i} className="suggestion-item" onClick={() => {
                                                setFormData({...formData, cliente: c.nombre});
                                                setSearchCli(c.nombre);
                                            }}>
                                                {c.nombre}
                                            </div>
                                        ))}
                                </div>
                            )}
                        </div>

                        {/* CANTIDAD */}
                        <div className="form-group" style={{marginBottom:'15px'}}>
                            <label>Cantidad Enviada (Kg / Unidades) *</label>
                            <input 
                                type="number" 
                                step="0.01"
                                className="form-control"
                                required 
                                value={formData.cantidad} 
                                onChange={e => setFormData({...formData, cantidad: e.target.value})} 
                            />
                        </div>

                        {/* OBSERVACIONES */}
                        <div className="form-group" style={{marginBottom:'15px'}}>
                            <label>Observaciones / Novedades</label>
                            <textarea 
                                className="form-control" 
                                rows="2"
                                value={formData.observaciones}
                                onChange={e => setFormData({...formData, observaciones: e.target.value})}
                            />
                        </div>

                        {/* ARCHIVO */}
                        <div className="form-group">
                            <label>Soporte (Remisi√≥n / Factura)</label>
                            <div className="file-input-wrapper" style={{border: '1px dashed #cbd5e1', padding: '15px', borderRadius: '6px', textAlign: 'center', cursor:'pointer', position:'relative', backgroundColor: '#f8fafc'}}>
                                <input 
                                    type="file" 
                                    onChange={e => setArchivo(e.target.files[0])} 
                                    style={{opacity: 0, position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', cursor: 'pointer'}}
                                />
                                <div className="file-custom-label" style={{color: '#64748b', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '5px'}}>
                                    {archivo ? (
                                        <><FaCheck style={{color:'green', fontSize:'1.5rem'}}/> <strong>{archivo.name}</strong></>
                                    ) : (
                                        <><FaCloudUploadAlt size={24}/> <span>Clic aqu√≠ para adjuntar archivo</span></>
                                    )}
                                </div>
                            </div>
                        </div>

                    </div>
                    <div className="modal-footer" style={{marginTop: 'auto', paddingTop: '15px'}}>
                        <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn-primary" disabled={loading} style={{backgroundColor: THEME_COLOR}}>
                            {loading ? 'Guardando...' : <><FaSave/> Registrar Salida</>}
                        </button>
                    </div>
                </form>

                <style>{`
                    .dropdown-suggestions {
                        position: absolute; top: 100%; left: 0; width: 100%; 
                        background: white; border: 1px solid #cbd5e1; border-radius: 0 0 8px 8px;
                        max-height: 200px; overflow-y: auto; z-index: 100;
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
                    }
                    .suggestion-item {
                        padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem;
                    }
                    .suggestion-item:hover { background: #f0f9ff; color: #0c4760; }
                `}</style>
            </div>
        </div>
    );
};

export default ModalCreateSalida;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalCreateUser.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2'; // <--- IMPORTADO
import { createUser, getRoles } from '../../services/userService';
import useAuth from '../../hooks/useAuth';
import '../../styles/Modal.css';
import { FaTimes, FaUser, FaBriefcase, FaBuilding, FaUserTag, FaIdCard, FaLock } from 'react-icons/fa';

const ModalCreateUser = ({ isOpen, onClose, onSuccess }) => {
    const { auth } = useAuth();
    const [formData, setFormData] = useState({
        cedula: '',
        nombre: '',
        password: '',
        cargo: '',
        area: '',
        idRol: ''
    });
    const [roles, setRoles] = useState([]);
    const [loadingRoles, setLoadingRoles] = useState(false);
    const [submitting, setSubmitting] = useState(false);

    useEffect(() => {
        if (isOpen) {
            setFormData({ cedula: '', nombre: '', password: '', cargo: '', area: '', idRol: '' });
            
            const fetchRoles = async () => {
                setLoadingRoles(true);
                try {
                    const data = await getRoles();
                    setRoles(data);
                } catch (error) {
                    console.error("Error cargando roles:", error);
                    Swal.fire('Error', 'No se pudieron cargar los roles del sistema.', 'error');
                } finally {
                    setLoadingRoles(false);
                }
            };
            fetchRoles();
        }
    }, [isOpen]);

    if (!isOpen) return null;

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();

        // Validaci√≥n con SweetAlert
        if (!formData.cedula || !formData.nombre || !formData.password || !formData.idRol) {
            return Swal.fire({
                icon: 'warning',
                title: 'Campos Incompletos',
                text: 'Por favor complete todos los campos obligatorios marcados con (*).',
                confirmButtonColor: '#0c4760'
            });
        }

        setSubmitting(true);
        try {
            await createUser(formData);
            
            // √âxito con SweetAlert
            await Swal.fire({
                icon: 'success',
                title: '¬°Usuario Creado!',
                text: `El usuario ${formData.nombre} ha sido registrado exitosamente.`,
                confirmButtonColor: '#0c4760',
                timer: 2000
            });

            onSuccess();
            onClose();
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error al crear',
                text: error.message,
                confirmButtonColor: '#d33'
            });
        } finally {
            setSubmitting(false);
        }
    };

    // L√≥gica de filtrado de roles seg√∫n quien est√© logueado
    const rolesVisibles = roles.filter(rol => {
        const miRol = auth.user?.rol;
        if (miRol === 'SuperAdmin') return true; 
        if (miRol === 'AdminCalidad') return rol.Nombre === 'Colaborador';
        return false;
    });

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '600px' }}>
                <div className="modal-header">
                    <h2>Nuevo Usuario</h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes /></button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        
                        <div className="form-group">
                            <label><FaIdCard /> C√©dula *</label>
                            <input 
                                type="text" 
                                name="cedula" 
                                placeholder="Ej: 10203040"
                                value={formData.cedula} 
                                onChange={handleChange} 
                                required 
                            />
                        </div>

                        <div className="form-group">
                            <label><FaUser /> Nombre Completo *</label>
                            <input 
                                type="text" 
                                name="nombre" 
                                placeholder="Ej: Juan P√©rez"
                                value={formData.nombre} 
                                onChange={handleChange} 
                                required 
                            />
                        </div>

                        <div className="form-group">
                            <label><FaLock /> Contrase√±a *</label>
                            <input 
                                type="password" 
                                name="password" 
                                placeholder="******"
                                value={formData.password} 
                                onChange={handleChange} 
                                required 
                            />
                        </div>

                        <div className="form-grid-row">
                            <div className="form-group form-col-half">
                                <label><FaUserTag /> Rol *</label>
                                <select 
                                    name="idRol" 
                                    value={formData.idRol} 
                                    onChange={handleChange} 
                                    required
                                    style={{ height: '45px' }}
                                >
                                    <option value="">-- Seleccione --</option>
                                    {loadingRoles ? (
                                        <option disabled>Cargando...</option>
                                    ) : rolesVisibles.length > 0 ? (
                                        rolesVisibles.map(rol => (
                                            <option key={rol.ID_Rol} value={rol.ID_Rol}>{rol.Nombre}</option>
                                        ))
                                    ) : (
                                        <option disabled>Sin permisos</option>
                                    )}
                                </select>
                            </div>

                            <div className="form-group form-col-half">
                                <label><FaBriefcase /> Cargo</label>
                                <input 
                                    type="text" 
                                    name="cargo" 
                                    placeholder="Ej: Analista"
                                    value={formData.cargo} 
                                    onChange={handleChange} 
                                />
                            </div>
                        </div>

                        <div className="form-group">
                            <label><FaBuilding /> √Årea / Departamento</label>
                            <input 
                                type="text" 
                                name="area" 
                                placeholder="Ej: Producci√≥n"
                                value={formData.area} 
                                onChange={handleChange} 
                            />
                        </div>

                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose} disabled={submitting}>
                            Cancelar
                        </button>
                        <button type="submit" className="btn-primary-modal" disabled={submitting}>
                            {submitting ? 'Creando...' : 'Crear Usuario'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalCreateUser;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalDetalleActividad.jsx
==================================================================
import '../../styles/Cronograma.css';

const ModalDetalleActividad = ({ isOpen, onClose, actividad }) => {
    if (!isOpen || !actividad) return null;

    // Colores de estado
    const badgeClass = actividad.Estado === 'Realizada' ? 'status-realizada' : 
                       actividad.Estado === 'Cancelada' ? 'status-cancelada' : 'status-pendiente';

    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div className="modal-header-clean">
                    <h3>Detalle de Actividad</h3>
                    <button className="close-btn" onClick={onClose}>&times;</button>
                </div>
                <div className="modal-body-clean">
                    <div style={{marginBottom:'15px'}}>
                        <label className="input-label">Nombre de la Actividad:</label>
                        <div style={{fontSize:'1.1rem'}}>{actividad.Nombre_Actividad}</div>
                    </div>
                    
                    <div style={{display:'flex', gap:'20px', marginBottom:'15px'}}>
                        <div style={{flex:1}}>
                            <label className="input-label">Estado:</label>
                            <span className={`status-badge ${badgeClass}`}>{actividad.Estado}</span>
                        </div>
                        <div style={{flex:1}}>
                            <label className="input-label">Responsable:</label>
                            <div>{actividad.Responsable}</div>
                        </div>
                    </div>

                    <div style={{marginBottom:'15px'}}>
                        <label className="input-label">Fecha L√≠mite:</label>
                        <div>{new Date(actividad.Fecha_Programada).toLocaleDateString('es-ES', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}</div>
                    </div>

                    <div style={{marginBottom:'15px'}}>
                        <label className="input-label">Descripci√≥n:</label>
                        <div className="read-only-box">{actividad.Descripcion || 'Sin descripci√≥n'}</div>
                    </div>

                    <div>
                        <label className="input-label">Observaciones:</label>
                        <div className="read-only-box">
                            {actividad.Bitacora_Seguimiento ? actividad.Bitacora_Seguimiento.replace(/\|\|/g, '\n') : 'Ninguna observaci√≥n registrada.'}
                        </div>
                    </div>
                </div>
                <div className="modal-footer-clean">
                    <button className="btn btn-blue" onClick={onClose}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};
export default ModalDetalleActividad;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalDetallePeso.jsx
==================================================================
import { useEffect, useState } from 'react';
// IMPORTAMOS TODOS LOS ICONOS NECESARIOS
import { 
    FaTimes, FaBalanceScale, FaCheckCircle, FaExclamationTriangle, 
    FaFilePdf, FaCamera, FaExternalLinkAlt, FaTimesCircle,
    FaCog, FaChevronDown, FaChevronUp 
} from 'react-icons/fa';

import { getDetallePeso } from '../../services/pesosService';
import { generarPDFPesos } from '../../utils/pdfPesosGenerator';
// Importamos las utilidades de streaming
import { apiFetchBlob, extractFilename } from '../../services/api';
import '../../styles/Modal.css';
import '../../styles/ModalDetallePeso.css';

// Gr√°fica
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';

const ModalDetallePeso = ({ isOpen, onClose, idControl }) => {
    const [data, setData] = useState(null);
    const [loading, setLoading] = useState(true);
    
    // --- ESTADOS PARA CONFIGURACI√ìN DEL PDF (RESTAURADOS) ---
    const [showConfig, setShowConfig] = useState(false);
    const [pdfConfig, setPdfConfig] = useState({
        empresa: 'EMPAQUETADOS EL TRECE S.A.S',
        sistema: 'SISTEMA DE GESTI√ìN DE CALIDAD',
        titulo: 'CONTROL DE PESOS EN PROCESO',
        codigo: 'R-CAL-005',
        version: '01'
    });

    useEffect(() => {
        if (isOpen) {
            document.body.style.overflow = 'hidden';
            // Resetear acorde√≥n al abrir
            setShowConfig(false);
            if (idControl) cargarDetalle();
        } else {
            document.body.style.overflow = 'unset';
        }
        return () => { document.body.style.overflow = 'unset'; };
    }, [isOpen, idControl]);

    const cargarDetalle = async () => {
        setLoading(true);
        try {
            const resultado = await getDetallePeso(idControl);
            setData(resultado);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleDownloadPDF = () => {
        // Pasamos el estado pdfConfig actual para que tome los cambios
        if (data) generarPDFPesos(data, pdfConfig);
    };

    // --- HELPER PARA ABRIR EVIDENCIA (CORREGIDO PARA HOSTINGER) ---
    const handleOpenEvidencia = async () => {
        if (data?.cabecera?.Url_Evidencia) {
            try {
                // 1. Extraemos solo el nombre del archivo (ej: "foto-123.jpg")
                const filename = extractFilename(data.cabecera.Url_Evidencia);
                
                // 2. Pedimos el archivo al endpoint seguro (Streaming)
                const blob = await apiFetchBlob(`/pesos/evidencia/${filename}`);
                
                // 3. Creamos una URL temporal y la abrimos
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');

                // Nota: Idealmente deber√≠amos revocar la URL despu√©s, pero al ser _blank est√° bien
                setTimeout(() => URL.revokeObjectURL(url), 60000); // Revocar al minuto para liberar memoria
            } catch (error) {
                console.error("Error al abrir evidencia:", error);
                alert("No se pudo cargar la evidencia. Verifique su conexi√≥n.");
            }
        }
    };

    // Componente Badge Sellado
    const SelladoBadge = ({ label, valor }) => (
        <div style={{
            display:'flex', justifyContent:'space-between', alignItems:'center',
            padding:'8px 12px', background:'white', borderRadius:'6px',
            borderLeft: `4px solid ${valor ? '#22c55e' : '#ef4444'}`,
            boxShadow:'0 2px 4px rgba(0,0,0,0.05)'
        }}>
            <span style={{fontSize:'0.85rem', fontWeight:'600', color:'#475569'}}>{label}</span>
            {valor 
                ? <span style={{color:'#16a34a', fontSize:'0.8rem', fontWeight:'bold', display:'flex', gap:'5px', alignItems:'center'}}><FaCheckCircle/> OK</span>
                : <span style={{color:'#dc2626', fontSize:'0.8rem', fontWeight:'bold', display:'flex', gap:'5px', alignItems:'center'}}><FaTimesCircle/> FALLO</span>
            }
        </div>
    );

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content-fixed">
                
                {/* Header Fijo */}
                <div className="modal-header-fixed">
                    <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <div style={{background:'#e0f2fe', padding:'8px', borderRadius:'8px', display:'flex'}}>
                            <FaBalanceScale style={{color:'#0c4760', fontSize:'1.2rem'}}/>
                        </div>
                        <div>
                            <h2 style={{margin:0, fontSize:'1.2rem'}}>Control #{idControl}</h2>
                            <span style={{fontSize:'0.85rem', color:'#64748b'}}>Detalle de muestreo de pesos</span>
                        </div>
                    </div>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>

                {/* Body Scrollable */}
                <div className="modal-body-scrollable">
                    {loading ? (
                        <div style={{height:'100%', display:'flex', alignItems:'center', justifyContent:'center', color:'#64748b'}}>
                            <p>Cargando datos del control...</p>
                        </div>
                    ) : data ? (
                        <>
                            {/* 1. INFO GENERAL */}
                            <div className="info-grid">
                                <div className="info-card">
                                    <label className="info-label">Producto</label>
                                    <div className="info-value">{data.cabecera.Producto}</div>
                                </div>
                                <div className="info-card">
                                    <label className="info-label">Lote</label>
                                    <div className="info-value highlight">{data.cabecera.Lote}</div>
                                </div>
                                <div className="info-card">
                                    <label className="info-label">Fecha Registro</label>
                                    <div className="info-value">{new Date(data.cabecera.Fecha_Creacion || data.cabecera.Fecha_Registro).toLocaleString()}</div>
                                </div>
                                <div className="info-card">
                                    <label className="info-label">Estado Final</label>
                                    <div>
                                        {data.cabecera.Estado_Final === 'Aprobado' 
                                            ? <span className="badge badge-success"><FaCheckCircle/> Aprobado</span>
                                            : <span className="badge badge-danger"><FaExclamationTriangle/> Rechazado</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            {/* 2. VERIFICACI√ìN DE SELLADO (NUEVO) */}
                            <div style={{background:'#f8fafc', padding:'15px', borderRadius:'10px', marginTop:'15px', border:'1px solid #e2e8f0'}}>
                                <h4 style={{margin:'0 0 10px 0', fontSize:'0.95rem', color:'#0f172a', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                    <span>Verificaci√≥n de Sellado</span>
                                    {data.cabecera.Url_Evidencia && (
                                        <button onClick={handleOpenEvidencia} style={{background:'none', border:'none', color:'#0ea5e9', cursor:'pointer', fontSize:'0.85rem', display:'flex', alignItems:'center', gap:'5px'}}>
                                            <FaCamera/> Ver Evidencia <FaExternalLinkAlt size={10}/>
                                        </button>
                                    )}
                                </h4>
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))', gap:'10px'}}>
                                    <SelladoBadge label="Sellado Inferior" valor={data.cabecera.Sellado_Inferior} />
                                    <SelladoBadge label="Sellado Superior" valor={data.cabecera.Sellado_Superior} />
                                    <SelladoBadge label="Sellado Vertical" valor={data.cabecera.Sellado_Vertical} />
                                    <SelladoBadge label="Loteado Legible" valor={data.cabecera.Sellado_Loteado} />
                                </div>
                            </div>

                            {/* 3. GR√ÅFICA */}
                            <div className="chart-container" style={{marginTop:'20px'}}>
                                <div className="chart-header">
                                    <h4 className="chart-title">Gr√°fica de Comportamiento</h4>
                                    <div style={{fontSize:'0.8rem', color:'#64748b'}}>Nominal: <strong>{data.cabecera.Peso_Nominal}g</strong></div>
                                </div>
                                <ResponsiveContainer width="100%" height="90%">
                                    <LineChart data={data.muestras}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                        <XAxis dataKey="Numero_Muestra" tick={{fontSize: 10}} interval={4} />
                                        <YAxis domain={['auto', 'auto']} tick={{fontSize: 11}} width={30}/>
                                        <Tooltip contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 10px rgba(0,0,0,0.1)'}} />
                                        <ReferenceLine y={data.cabecera.Limite_Superior} stroke="red" strokeDasharray="3 3" />
                                        <ReferenceLine y={data.cabecera.Limite_Inferior} stroke="red" strokeDasharray="3 3" />
                                        <ReferenceLine y={data.cabecera.Peso_Nominal} stroke="#10b981" strokeWidth={2} />
                                        <Line type="monotone" dataKey="Valor_Peso" stroke="#0c4760" strokeWidth={2} dot={{ r: 2 }} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>

                            {/* 4. PAR√ÅMETROS T√âCNICOS */}
                            <div className="params-container" style={{marginTop:'20px'}}>
                                <h4 className="params-title">Par√°metros de M√°quina</h4>
                                <div className="params-grid">
                                    <div><strong>Velocidad:</strong> {data.cabecera.Golpes_Minuto} gpm</div>
                                    <div><strong>Temp. Vertical:</strong> {data.cabecera.Temp_Vertical}¬∞C</div>
                                    <div><strong>Temp. H. Sup:</strong> {data.cabecera.Temp_Horiz_Sup}¬∞C</div>
                                    <div><strong>Temp. H. Inf:</strong> {data.cabecera.Temp_Horiz_Inf}¬∞C</div>
                                </div>
                            </div>

                            {/* 5. CONFIGURACI√ìN DE REPORTE PDF (RESTAURADA) */}
                            <div className="config-container" style={{marginTop:'20px', border:'1px solid #e2e8f0', borderRadius:'10px', overflow:'hidden'}}>
                                <div 
                                    className={`config-header-toggle ${showConfig ? 'open' : ''}`}
                                    onClick={() => setShowConfig(!showConfig)}
                                    style={{
                                        padding:'15px', background:'white', cursor:'pointer', 
                                        display:'flex', justifyContent:'space-between', alignItems:'center',
                                        fontWeight:'bold', color:'#334155'
                                    }}
                                >
                                    <span style={{display:'flex', alignItems:'center', gap:'10px'}}>
                                        <FaCog style={{color:'#0c4760'}}/> Configurar Encabezado del PDF
                                    </span>
                                    {showConfig ? <FaChevronUp size={12}/> : <FaChevronDown size={12}/>}
                                </div>
                                
                                {showConfig && (
                                    <div className="config-body" style={{padding:'15px', background:'#f8fafc', borderTop:'1px solid #e2e8f0'}}>
                                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                                                <div className="form-group">
                                                    <label style={{fontSize:'0.8rem', fontWeight:'bold', display:'block', marginBottom:'5px'}}>Nombre Empresa</label>
                                                    <input className="form-control" style={{width:'100%', padding:'8px', border:'1px solid #cbd5e1', borderRadius:'5px'}} value={pdfConfig.empresa} onChange={e=>setPdfConfig({...pdfConfig, empresa:e.target.value})} />
                                                </div>
                                                <div className="form-group">
                                                    <label style={{fontSize:'0.8rem', fontWeight:'bold', display:'block', marginBottom:'5px'}}>Sistema / Proceso</label>
                                                    <input className="form-control" style={{width:'100%', padding:'8px', border:'1px solid #cbd5e1', borderRadius:'5px'}} value={pdfConfig.sistema} onChange={e=>setPdfConfig({...pdfConfig, sistema:e.target.value})} />
                                                </div>
                                                <div className="form-group" style={{gridColumn:'span 2'}}>
                                                    <label style={{fontSize:'0.8rem', fontWeight:'bold', display:'block', marginBottom:'5px'}}>T√≠tulo del Documento</label>
                                                    <input className="form-control" style={{width:'100%', padding:'8px', border:'1px solid #cbd5e1', borderRadius:'5px'}} value={pdfConfig.titulo} onChange={e=>setPdfConfig({...pdfConfig, titulo:e.target.value})} />
                                                </div>
                                                <div className="form-group">
                                                    <label style={{fontSize:'0.8rem', fontWeight:'bold', display:'block', marginBottom:'5px'}}>C√≥digo Formato</label>
                                                    <input className="form-control" style={{width:'100%', padding:'8px', border:'1px solid #cbd5e1', borderRadius:'5px'}} value={pdfConfig.codigo} onChange={e=>setPdfConfig({...pdfConfig, codigo:e.target.value})} />
                                                </div>
                                                <div className="form-group">
                                                    <label style={{fontSize:'0.8rem', fontWeight:'bold', display:'block', marginBottom:'5px'}}>Versi√≥n</label>
                                                    <input className="form-control" style={{width:'100%', padding:'8px', border:'1px solid #cbd5e1', borderRadius:'5px'}} value={pdfConfig.version} onChange={e=>setPdfConfig({...pdfConfig, version:e.target.value})} />
                                                </div>
                                            </div>
                                    </div>
                                )}
                            </div>

                        </>
                    ) : <p>No hay datos disponibles.</p>}
                </div>

                {/* Footer Fijo */}
                <div className="modal-footer-fixed">
                    <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                    <button 
                        className="btn-primary-modal" 
                        onClick={handleDownloadPDF}
                        disabled={loading || !data}
                        style={{ background: '#dc2626', display: 'flex', alignItems: 'center', gap: '8px', paddingLeft:'20px', paddingRight:'20px' }}
                    >
                        <FaFilePdf /> Descargar Reporte
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalDetallePeso;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalDise√±adorCertificado.jsx
==================================================================
// frontend/src/components/modals/ModalDise√±adorCertificado.jsx
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { savePlantilla } from '../../services/certificadosService';
import '../../styles/Modal.css';
import { 
    FaPlus, FaTrash, FaSave, FaTimes, FaList, FaTable, 
    FaHeading, FaSignature, FaLock, FaLockOpen, FaPen 
} from 'react-icons/fa';

const ModalDise√±adorCertificado = ({ isOpen, onClose, onSuccess, plantillaEditar }) => {
    const [nombre, setNombre] = useState('');
    
    // --- ESTADOS DE CONFIGURACI√ìN ---
    const [headerData, setHeaderData] = useState({
        empresa: 'EMPAQUETADOS EL TRECE S.A.S',
        sistema: 'SISTEMA DE GESTI√ìN DE CALIDAD',
        tituloDoc: 'CERTIFICADO DE CALIDAD',
        codigo: 'FT-SGC-020',
        version: '03'
    });

    const [footerData, setFooterData] = useState({
        nombre: 'NILSON ALEXIS GALVIS LUJAN',
        cargo: 'L√≠der de Calidad',
        empresa: 'Empaquetados el Trece S.A.S'
    });

    const [secciones, setSecciones] = useState([]);

    // --- FUNCI√ìN SEGURA PARA PARSEAR JSON ---
    const safeParse = (data) => {
        if (!data) return []; 
        if (Array.isArray(data) || typeof data === 'object') return data; 
        try {
            return JSON.parse(data);
        } catch (e) {
            // Si falla, retornamos array vac√≠o para no romper la UI
            return [];
        }
    };

    // --- CARGA DE DATOS ---
    useEffect(() => {
        if (isOpen) {
            if (plantillaEditar) {
                setNombre(plantillaEditar.Nombre);
                try {
                    const estructura = safeParse(plantillaEditar.Estructura_JSON);
                    
                    if (!Array.isArray(estructura)) {
                        // Estructura nueva (Objeto completo)
                        if(estructura.header) setHeaderData(estructura.header);
                        if(estructura.footer) setFooterData(estructura.footer);
                        
                        // Limpieza adicional para filas de tablas
                        const seccionesLimpias = (estructura.secciones || []).map(sec => {
                            if(sec.tipo === 'tabla') {
                                // Aseguramos que filas sea siempre un array
                                return { ...sec, filas: Array.isArray(sec.filas) ? sec.filas : safeParse(sec.filas) };
                            }
                            return sec;
                        });
                        setSecciones(seccionesLimpias);
                    } else {
                        // Estructura antigua
                        setSecciones(estructura); 
                    }
                } catch (e) { console.error("Error cargando plantilla:", e); }
            } else {
                // NUEVO FORMATO
                setNombre('');
                setHeaderData({ empresa: 'EMPAQUETADOS EL TRECE S.A.S', sistema: 'SISTEMA DE GESTI√ìN DE CALIDAD', tituloDoc: 'CERTIFICADO DE CALIDAD', codigo: 'FT-SGC-020', version: '03' });
                setFooterData({ nombre: 'NILSON ALEXIS GALVIS LUJAN', cargo: 'L√≠der de Calidad', empresa: 'Empaquetados el Trece S.A.S' });
                setSecciones([
                    { 
                        id: 1, tipo: 'info', titulo: 'Informaci√≥n General', 
                        campos: [
                            { nombre: 'Producto', valor: '', fijo: false },
                            { nombre: 'Lote', valor: '', fijo: false },
                            { nombre: 'Cliente', valor: '', fijo: false }
                        ] 
                    }
                ]);
            }
        }
    }, [isOpen, plantillaEditar]);

    // --- L√ìGICA DE SECCIONES ---
    const addSeccion = (tipo) => {
        const id = Date.now();
        if (tipo === 'texto') setSecciones([...secciones, { id, tipo, titulo: 'T√≠tulo de la Secci√≥n...', contenido: '', fijo: false }]);
        if (tipo === 'tabla') setSecciones([...secciones, { id, tipo, titulo: 'T√≠tulo de la Tabla...', columnas: ['Propiedad', 'Resultado'], filas: [], fijo: false }]);
        if (tipo === 'info') setSecciones([...secciones, { id, tipo, titulo: 'T√≠tulo del Grupo de Datos...', campos: [{ nombre: '', valor: '', fijo: false }] }]);
    };

    const removeSeccion = (idx) => {
        const nuevas = [...secciones];
        nuevas.splice(idx, 1);
        setSecciones(nuevas);
    };

    const updateSeccionProp = (idx, key, val) => {
        const nuevas = [...secciones];
        nuevas[idx][key] = val;
        setSecciones(nuevas);
    };

    // --- L√ìGICA CAMPO INFO ---
    const addFieldToInfo = (secIdx) => {
        const nuevas = [...secciones];
        nuevas[secIdx].campos.push({ nombre: '', valor: '', fijo: false });
        setSecciones(nuevas);
    };
    const removeFieldFromInfo = (secIdx, fieldIdx) => {
        const nuevas = [...secciones];
        nuevas[secIdx].campos.splice(fieldIdx, 1);
        setSecciones(nuevas);
    };
    const updateFieldInfo = (secIdx, fieldIdx, key, val) => {
        const nuevas = [...secciones];
        nuevas[secIdx].campos[fieldIdx][key] = val;
        setSecciones(nuevas);
    };

    // --- L√ìGICA TABLA ---
    const handleColumnasChange = (secIdx, val) => {
        const array = val.split(',').map(s => s.trim());
        const nuevas = [...secciones];
        nuevas[secIdx].columnas = array;
        // Al cambiar columnas, intentamos preservar los datos si la columna existe, sino ''
        if (nuevas[secIdx].filas) {
            nuevas[secIdx].filas = nuevas[secIdx].filas.map(fila => {
                const nuevaFila = {};
                array.forEach(col => {
                    nuevaFila[col] = fila[col] || '';
                });
                return nuevaFila;
            });
        }
        setSecciones(nuevas);
    };

    const addRowToTable = (secIdx) => {
        const nuevas = [...secciones];
        const cols = nuevas[secIdx].columnas;
        const newRow = {};
        // Inicializamos la fila con claves vac√≠as para evitar undefined
        cols.forEach(c => newRow[c] = '');
        
        if (!Array.isArray(nuevas[secIdx].filas)) nuevas[secIdx].filas = [];
        
        nuevas[secIdx].filas.push(newRow);
        setSecciones(nuevas);
    };

    const removeRowFromTable = (secIdx, rowIdx) => {
        const nuevas = [...secciones];
        if (Array.isArray(nuevas[secIdx].filas)) {
            nuevas[secIdx].filas.splice(rowIdx, 1);
            setSecciones(nuevas);
        }
    };

    const updateRowTable = (secIdx, rowIdx, col, val) => {
        const nuevas = [...secciones];
        if (Array.isArray(nuevas[secIdx].filas) && nuevas[secIdx].filas[rowIdx]) {
            nuevas[secIdx].filas[rowIdx][col] = val;
            setSecciones(nuevas);
        }
    };

    // --- GUARDAR ---
    const handleSave = async () => {
        if (!nombre) return Swal.fire('Falta Nombre', 'Por favor asigne un nombre al formato.', 'warning');
        const fullStructure = { header: headerData, footer: footerData, secciones: secciones };
        try {
            await savePlantilla({ nombre, estructura: fullStructure, id: plantillaEditar?.ID_Plantilla });
            Swal.fire('Guardado', 'El formato se ha guardado correctamente.', 'success');
            onSuccess(); 
            onClose();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '1000px', maxHeight:'92vh', display:'flex', flexDirection:'column', background:'#f8fafc' }}>
                
                {/* --- HEADER MODAL --- */}
                <div className="modal-header" style={{background: 'white', borderBottom: '1px solid #e2e8f0', color:'#0c4760', padding:'15px 25px'}}>
                    <div style={{display:'flex', alignItems:'center', gap:'12px'}}>
                        <div style={{background:'#f0f9ff', padding:'8px', borderRadius:'8px', display:'flex', alignItems:'center', justifyContent:'center'}}>
                            <FaTable size={20} color="#0ea5e9"/>
                        </div>
                        <h2 style={{fontSize:'1.3rem', margin:0, fontWeight:'700'}}>{plantillaEditar ? 'Editar' : 'Dise√±ar'} Formato de Certificado</h2>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color:'#64748b', fontSize:'1.2rem'}}><FaTimes/></button>
                </div>
                
                <div className="modal-body" style={{padding:'25px', overflowY:'auto', flex:1}}>
                    
                    {/* INPUT NOMBRE */}
                    <div className="form-group" style={{background:'white', padding:'20px', borderRadius:'12px', border:'1px solid #e2e8f0', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}}>
                        <label style={{fontWeight:'700', color:'#1e293b', marginBottom:'8px', display:'block', fontSize:'0.9rem'}}>Nombre del Formato (Ej: Ficha At√∫n - Cliente X)</label>
                        <input className="form-control" value={nombre} onChange={e => setNombre(e.target.value)} placeholder="Escriba un nombre descriptivo..." style={{fontSize:'1rem', padding:'10px', border:'1px solid #cbd5e1'}} />
                    </div>

                    {/* --- ZONA 1: ENCABEZADO --- */}
                    <div className="design-section" style={{background:'#f0f9ff', border:'1px solid #bae6fd', padding:'20px', borderRadius:'12px', marginTop:'20px'}}>
                        <h4 style={{marginTop:0, color:'#0369a1', display:'flex', alignItems:'center', gap:'8px', borderBottom:'1px solid #bae6fd', paddingBottom:'10px', fontSize:'0.95rem'}}>
                            <FaHeading/> 1. Configuraci√≥n del Encabezado
                        </h4>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px', marginTop:'15px'}}>
                            <div><label className="label-sm">Empresa</label><input className="input-sm" value={headerData.empresa} onChange={e=>setHeaderData({...headerData, empresa:e.target.value})} /></div>
                            <div><label className="label-sm">Sistema</label><input className="input-sm" value={headerData.sistema} onChange={e=>setHeaderData({...headerData, sistema:e.target.value})} /></div>
                            <div><label className="label-sm">T√≠tulo Doc</label><input className="input-sm" value={headerData.tituloDoc} onChange={e=>setHeaderData({...headerData, tituloDoc:e.target.value})} /></div>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'10px'}}>
                                <div><label className="label-sm">C√≥digo</label><input className="input-sm" value={headerData.codigo} onChange={e=>setHeaderData({...headerData, codigo:e.target.value})} /></div>
                                <div><label className="label-sm">Versi√≥n</label><input className="input-sm" value={headerData.version} onChange={e=>setHeaderData({...headerData, version:e.target.value})} /></div>
                            </div>
                        </div>
                    </div>

                    {/* --- ZONA 2: CUERPO --- */}
                    <div style={{marginTop:'30px'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'15px'}}>
                            <h4 style={{margin:0, color:'#334155', fontSize:'1rem'}}>2. Estructura del Cuerpo</h4>
                            <div style={{display:'flex', gap:'10px'}}>
                                <button className="btn-tool" onClick={() => addSeccion('info')}><FaList/> + Datos</button>
                                <button className="btn-tool" onClick={() => addSeccion('texto')}><FaHeading/> + Texto</button>
                                <button className="btn-tool" onClick={() => addSeccion('tabla')}><FaTable/> + Tabla</button>
                            </div>
                        </div>

                        <div style={{display:'flex', flexDirection:'column', gap:'20px'}}>
                            {secciones.map((sec, idx) => (
                                <div key={sec.id} className="section-card" style={{background:'white', padding:'20px', borderRadius:'12px', border:'1px solid #e2e8f0', boxShadow:'0 4px 6px -1px rgba(0, 0, 0, 0.05)', position:'relative'}}>
                                    
                                    {/* CABECERA DE LA SECCI√ìN */}
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'15px', borderBottom:'1px dashed #e2e8f0', paddingBottom:'10px'}}>
                                        <div style={{flex:1, marginRight:'15px', display:'flex', alignItems:'center', gap:'10px'}}>
                                            <FaPen color="#94a3b8" size={12}/>
                                            <input 
                                                value={sec.titulo} 
                                                onChange={e => updateSeccionProp(idx, 'titulo', e.target.value)} 
                                                style={{width:'100%', border:'none', fontSize:'1.2rem', fontWeight:'700', color:'#0c4760', outline:'none', background:'transparent'}}
                                                placeholder="Escriba el t√≠tulo de esta secci√≥n..."
                                                autoFocus={!sec.titulo} 
                                            />
                                        </div>
                                        <div style={{display:'flex', gap:'10px'}}>
                                            <span className="badge-type">{sec.tipo === 'info' ? 'LISTA DE DATOS' : sec.tipo === 'texto' ? 'P√ÅRRAFO' : 'TABLA'}</span>
                                            <button onClick={() => removeSeccion(idx)} className="btn-icon-danger" title="Eliminar Secci√≥n"><FaTrash/></button>
                                        </div>
                                    </div>

                                    {/* TIPO INFO */}
                                    {sec.tipo === 'info' && (
                                        <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', border:'1px solid #f1f5f9'}}>
                                            <div style={{display:'grid', gridTemplateColumns:'3fr 3fr 1fr 40px', gap:'10px', marginBottom:'8px', color:'#64748b', fontSize:'0.75rem', fontWeight:'bold', textTransform:'uppercase'}}>
                                                <span>Etiqueta del Campo</span>
                                                <span>Contenido (Llenar ahora si desea)</span>
                                                <span style={{textAlign:'center'}}>Estado</span>
                                                <span></span>
                                            </div>
                                            {sec.campos.map((campo, cIdx) => (
                                                <div key={cIdx} className="row-item">
                                                    <input className="input-row" placeholder="Ej: Producto" value={campo.nombre} onChange={e => updateFieldInfo(idx, cIdx, 'nombre', e.target.value)} />
                                                    <input 
                                                        className="input-row" 
                                                        placeholder="Valor por defecto (opcional)" 
                                                        value={campo.valor} 
                                                        onChange={e => updateFieldInfo(idx, cIdx, 'valor', e.target.value)} 
                                                        style={{background: campo.valor ? '#f0fdf4' : 'white', borderColor: campo.valor ? '#86efac' : '#e2e8f0'}}
                                                    />
                                                    <div 
                                                        className={`toggle-lock ${campo.fijo ? 'locked' : 'unlocked'}`}
                                                        onClick={() => updateFieldInfo(idx, cIdx, 'fijo', !campo.fijo)}
                                                    >
                                                        {campo.fijo ? <><FaLock/> Fijo</> : <><FaLockOpen/> Editable</>}
                                                    </div>
                                                    <button onClick={() => removeFieldFromInfo(idx, cIdx)} className="btn-icon-danger"><FaTimes/></button>
                                                </div>
                                            ))}
                                            <button className="btn-add-row" onClick={() => addFieldToInfo(idx)}><FaPlus size={10}/> Agregar Campo</button>
                                        </div>
                                    )}

                                    {/* TIPO TEXTO */}
                                    {sec.tipo === 'texto' && (
                                        <div>
                                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'5px'}}>
                                                <label style={{fontSize:'0.8rem', color:'#64748b'}}>Escriba el contenido del p√°rrafo (puede dejarlo listo aqu√≠):</label>
                                                <div 
                                                    className={`toggle-lock ${sec.fijo ? 'locked' : 'unlocked'}`}
                                                    onClick={() => updateSeccionProp(idx, 'fijo', !sec.fijo)}
                                                >
                                                    {sec.fijo ? <><FaLock/> Texto Fijo</> : <><FaLockOpen/> Texto Editable</>}
                                                </div>
                                            </div>
                                            <textarea 
                                                className="input-area" 
                                                rows="4" 
                                                placeholder="Escriba aqu√≠ el texto..."
                                                value={sec.contenido} 
                                                onChange={e => updateSeccionProp(idx, 'contenido', e.target.value)}
                                            />
                                        </div>
                                    )}

                                    {/* TIPO TABLA */}
                                    {sec.tipo === 'tabla' && (
                                        <div>
                                            <div style={{marginBottom:'10px'}}>
                                                <label className="label-sm">Columnas (Separar por comas)</label>
                                                <input className="input-sm" defaultValue={sec.columnas.join(', ')} onBlur={e => handleColumnasChange(idx, e.target.value)} placeholder="Ej: Caracter√≠stica, Especificaci√≥n, Resultado" />
                                            </div>
                                            
                                            <div style={{background:'#f8fafc', padding:'10px', borderRadius:'8px', border:'1px solid #f1f5f9'}}>
                                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px', alignItems:'center'}}>
                                                    <label className="label-sm" style={{color:'#0c4760'}}>Filas Predeterminadas (Llenar datos fijos)</label>
                                                    <div 
                                                        className={`toggle-lock ${sec.fijo ? 'locked' : 'unlocked'}`}
                                                        onClick={() => updateSeccionProp(idx, 'fijo', !sec.fijo)}
                                                    >
                                                        {sec.fijo ? <><FaLock/> Tabla Fija</> : <><FaLockOpen/> Tabla Editable</>}
                                                    </div>
                                                </div>

                                                <table className="mini-table">
                                                    <thead><tr>{sec.columnas.map(c=><th key={c}>{c}</th>)}<th style={{width:'30px'}}></th></tr></thead>
                                                    <tbody>
                                                        {Array.isArray(sec.filas) && sec.filas.map((fila, rIdx) => (
                                                            <tr key={rIdx}>
                                                                {sec.columnas.map(col => (
                                                                    <td key={col}>
                                                                        <input 
                                                                            value={fila[col] || ''}
                                                                            onChange={e => updateRowTable(idx, rIdx, col, e.target.value)}
                                                                            placeholder="..."
                                                                        />
                                                                    </td>
                                                                ))}
                                                                <td><button onClick={() => removeRowFromTable(idx, rIdx)} className="btn-icon-danger"><FaTimes/></button></td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                                <button className="btn-add-row" onClick={() => addRowToTable(idx)}><FaPlus size={10}/> Agregar Fila Base</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* --- ZONA 3: PIE DE P√ÅGINA --- */}
                    <div style={{background:'#fff7ed', border:'1px solid #fed7aa', padding:'20px', borderRadius:'12px', marginTop:'30px'}}>
                        <h4 style={{marginTop:0, color:'#c2410c', display:'flex', alignItems:'center', gap:'8px', borderBottom:'1px solid #fed7aa', paddingBottom:'10px', fontSize:'0.95rem'}}>
                            <FaSignature/> 3. Configuraci√≥n de Firma (Footer)
                        </h4>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px', marginTop:'15px'}}>
                            <div><label className="label-sm">Nombre Firmante</label><input className="input-sm" value={footerData.nombre} onChange={e=>setFooterData({...footerData, nombre:e.target.value})} /></div>
                            <div><label className="label-sm">Cargo</label><input className="input-sm" value={footerData.cargo} onChange={e=>setFooterData({...footerData, cargo:e.target.value})} /></div>
                            <div><label className="label-sm">Empresa Pie</label><input className="input-sm" value={footerData.empresa} onChange={e=>setFooterData({...footerData, empresa:e.target.value})} /></div>
                        </div>
                    </div>

                </div>

                <div className="modal-footer" style={{background:'white', borderTop:'1px solid #e2e8f0', padding:'20px'}}>
                    <button className="btn-secondary" onClick={onClose} style={{marginRight:'10px'}}>Cancelar Operaci√≥n</button>
                    <button className="btn-primary-modal" onClick={handleSave} style={{padding:'10px 25px', fontSize:'1rem'}}>
                        <FaSave/> Guardar Dise√±o Final
                    </button>
                </div>
            </div>

            {/* --- ESTILOS INLINE AUXILIARES --- */}
            <style>{`
                .label-sm { font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; display: block; text-transform: uppercase; }
                .input-sm { width: 100%; padding: 8px; border: 1px solid #cbd5e1; borderRadius: 6px; font-size: 0.9rem; }
                .btn-tool { background: white; border: 1px solid #cbd5e1; padding: 6px 15px; borderRadius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; color: #475569; font-weight: 600; transition: all 0.2s; }
                .btn-tool:hover { background: #f1f5f9; color: #0c4760; border-color: #0c4760; }
                .badge-type { background: #e2e8f0; color: #475569; font-size: 0.7rem; padding: 3px 8px; borderRadius: 4px; font-weight: 700; }
                .btn-icon-danger { border: none; background: transparent; color: #ef4444; cursor: pointer; padding: 5px; opacity: 0.7; transition: 0.2s; }
                .btn-icon-danger:hover { opacity: 1; transform: scale(1.1); }
                .row-item { display: grid; grid-template-columns: 3fr 3fr 1fr 40px; gap: 10px; margin-bottom: 8px; align-items: center; }
                .input-row { width: 100%; padding: 8px; border: 1px solid #e2e8f0; borderRadius: 6px; font-size: 0.9rem; }
                .input-area { width: 100%; padding: 10px; border: 1px solid #cbd5e1; borderRadius: 6px; font-family: inherit; font-size: 0.9rem; resize: vertical; }
                .toggle-lock { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 5px 10px; borderRadius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; user-select: none; transition: 0.2s; }
                .toggle-lock.locked { background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; }
                .toggle-lock.unlocked { background: #ecfdf5; color: #10b981; border: 1px solid #a7f3d0; }
                .btn-add-row { background: transparent; border: 1px dashed #94a3b8; color: #64748b; width: 100%; padding: 5px; borderRadius: 6px; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }
                .btn-add-row:hover { background: #f1f5f9; color: #0c4760; border-color: #0c4760; }
                .mini-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                .mini-table th { text-align: left; font-size: 0.75rem; color: #64748b; padding: 5px; border-bottom: 1px solid #e2e8f0; }
                .mini-table td { padding: 3px; }
                .mini-table input { width: 100%; border: 1px solid #e2e8f0; padding: 5px; borderRadius: 4px; font-size: 0.85rem; }
            `}</style>
        </div>
    );
};

export default ModalDise√±adorCertificado;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalEditActivo.jsx
==================================================================
import { useState, useEffect } from 'react';
import { updateUser, getRoles } from '../../services/userService';
import '../../styles/Modal.css';

const ModalEditUser = ({ isOpen, onClose, user, onSuccess }) => {
    const [formData, setFormData] = useState({ nombre: '', area: '', cargo: '', idRol: '' });
    const [roles, setRoles] = useState([]);

    useEffect(() => {
        if (isOpen && user) {
            // Cargar Roles
            const fetchRoles = async () => {
                try {
                    const data = await getRoles();
                    setRoles(data);
                } catch (error) { console.error(error); }
            };
            fetchRoles();

            // eslint-disable-next-line react-hooks/set-state-in-effect
            setFormData({
                nombre: user.Nombre_Completo || '',
                area: user.Area || '',
                cargo: user.Cargo || '',
                idRol: user.ID_Rol || '' 
            });
        }
    }, [isOpen, user]);

    if (!isOpen || !user) return null;

    const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            await updateUser(user.ID_Usuario, formData);
            alert('Usuario actualizado');
            onSuccess();
            onClose();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <div className="modal-header">
                    <h2>Editar Usuario</h2>
                    <button className="modal-close-button" onClick={onClose}>√ó</button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        <div className="form-group">
                            <label>C√©dula (No editable)</label>
                            <input type="text" value={user.Cedula || ''} disabled style={{backgroundColor:'#f3f4f6'}} />
                        </div>
                        <div className="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" name="nombre" required value={formData.nombre} onChange={handleChange} />
                        </div>
                        <div className="form-group">
                            <label>Rol</label>
                            <select name="idRol" value={formData.idRol} onChange={handleChange} required>
                                <option value="">-- Seleccione --</option>
                                {roles.map(rol => (
                                    <option key={rol.ID_Rol} value={rol.ID_Rol}>{rol.Nombre}</option>
                                ))}
                            </select>
                        </div>
                        <div className="form-grid-row">
                            <div className="form-group form-col-half">
                                <label>√Årea</label>
                                <input type="text" name="area" value={formData.area} onChange={handleChange} />
                            </div>
                            <div className="form-group form-col-half">
                                <label>Cargo</label>
                                <input type="text" name="cargo" value={formData.cargo} onChange={handleChange} />
                            </div>
                        </div>
                    </div>
                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn-primary-modal">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditUser;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalEditarActividad.jsx
==================================================================
import { useState, useEffect } from 'react';
import { updateActividad } from '../../services/cronogramaService';
import '../../styles/Cronograma.css'; // Usamos los mismos estilos del m√≥dulo

const ModalEditarActividad = ({ isOpen, onClose, actividad, onSuccess }) => {
    const [formData, setFormData] = useState({
        nombreActividad: '',
        descripcion: '',
        responsable: '',
        fechaLimite: ''
    });

    // Efecto para cargar los datos cuando se abre el modal
    useEffect(() => {
        if (isOpen && actividad) {
            // L√≥gica segura para la fecha
            let fechaSafe = '';
            if (actividad.Fecha_Programada || actividad.Fecha_Limite || actividad.Fecha_Inicio) {
                const fechaRaw = actividad.Fecha_Programada || actividad.Fecha_Limite || actividad.Fecha_Inicio;
                const dateObj = new Date(fechaRaw);
                
                // Verificamos si es una fecha v√°lida antes de convertir
                if (!isNaN(dateObj.getTime())) {
                    fechaSafe = dateObj.toISOString().split('T')[0];
                }
            }

            setFormData({
                nombreActividad: actividad.Nombre_Actividad || actividad.Titulo || '',
                descripcion: actividad.Descripcion || '',
                responsable: actividad.Responsable || '',
                fechaLimite: fechaSafe
            });
        }
    }, [isOpen, actividad]);

    if (!isOpen) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            // Identificar ID (puede venir como ID_Actividad o ID)
            const id = actividad.ID_Actividad || actividad.ID;
            
            await updateActividad(id, {
                ...formData,
                // Si el backend espera nombres espec√≠ficos, mapearlos aqu√≠:
                nombreActividad: formData.nombreActividad,
                fechaLimite: formData.fechaLimite // Se env√≠a YYYY-MM-DD
            });
            
            onSuccess();
            onClose();
        } catch (error) {
            alert('Error al actualizar: ' + error.message);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div className="modal-header-clean">
                    <h3>Editar Actividad</h3>
                    <button className="close-btn" onClick={onClose}>&times;</button>
                </div>
                
                <form onSubmit={handleSubmit}>
                    <div className="modal-body-clean">
                        
                        {/* NOMBRE */}
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Nombre de la Actividad</label>
                            <input 
                                type="text" 
                                className="form-control" 
                                required
                                value={formData.nombreActividad} 
                                onChange={e => setFormData({...formData, nombreActividad: e.target.value})} 
                            />
                        </div>

                        {/* RESPONSABLE */}
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Responsable</label>
                            <input 
                                type="text" 
                                className="form-control" 
                                required
                                value={formData.responsable} 
                                onChange={e => setFormData({...formData, responsable: e.target.value})} 
                            />
                        </div>

                        {/* FECHA */}
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Fecha Programada</label>
                            <input 
                                type="date" 
                                className="form-control" 
                                required
                                value={formData.fechaLimite} 
                                onChange={e => setFormData({...formData, fechaLimite: e.target.value})} 
                            />
                        </div>

                        {/* DESCRIPCI√ìN */}
                        <div style={{marginBottom:'15px'}}>
                            <label className="input-label">Descripci√≥n / Observaciones</label>
                            <textarea 
                                className="form-control" 
                                rows="3"
                                value={formData.descripcion} 
                                onChange={e => setFormData({...formData, descripcion: e.target.value})} 
                            />
                        </div>

                    </div>
                    
                    <div className="modal-footer-clean">
                        <button type="button" className="btn btn-grey" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn btn-blue">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditarActividad;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalEditForm.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { updateFormulario, getCategorias } from '../../services/coreService';
import '../../styles/Modal.css';

const ModalEditForm = ({ isOpen, onClose, form, onSuccess }) => {
    const [formData, setFormData] = useState({ 
        codigo: '', nombre: '', descripcion: '', idCategoria: '', programa: 'General' 
    });
    const [categorias, setCategorias] = useState([]);

    useEffect(() => {
        if (isOpen && form) {
            cargarCategorias();
            setFormData({
                codigo: form.Codigo || '',
                nombre: form.Titulo || '',
                descripcion: form.Descripcion || '',
                idCategoria: form.ID_Categoria || '',
                programa: form.Programa || 'General' 
            });
        }
    }, [isOpen, form]);

    const cargarCategorias = async () => {
        try {
            const data = await getCategorias();
            setCategorias(data);
        } catch (error) { console.error(error); }
    };

    const handleSave = async (e) => {
        e.preventDefault();
        try {
            await updateFormulario(form.ID_Formulario, {
                titulo: formData.nombre,
                codigo: formData.codigo,
                descripcion: formData.descripcion,
                idCategoria: formData.idCategoria,
                programa: formData.programa
            });
            
            Swal.fire({
                title: 'Actualizado',
                text: 'La informaci√≥n del formulario ha sido actualizada correctamente.',
                icon: 'success',
                confirmButtonColor: '#0c4760',
                timer: 2000
            });
            onSuccess();
            onClose();
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    if (!isOpen || !form) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '600px'}}>
                <div className="modal-header">
                    <h2>Editar Cabecera Formulario</h2>
                    <button className="modal-close-button" onClick={onClose}>&times;</button>
                </div>
                
                <form onSubmit={handleSave}>
                    <div className="modal-body">
                        
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginBottom:'15px'}}>
                            <div className="form-group">
                                <label>C√≥digo Identificador</label>
                                <input type="text" value={formData.codigo} onChange={e => setFormData({...formData, codigo: e.target.value})} />
                            </div>
                            <div className="form-group">
                                <label>Nombre del Formulario *</label>
                                <input type="text" value={formData.nombre} onChange={e => setFormData({...formData, nombre: e.target.value})} required />
                            </div>
                        </div>

                        <div className="form-group" style={{marginBottom:'15px'}}>
                            <label>Descripci√≥n</label>
                            <textarea rows="2" value={formData.descripcion} onChange={e => setFormData({...formData, descripcion: e.target.value})} style={{resize:'none'}}/>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                            <div className="form-group" style={{background:'#f0f9ff', padding:'10px', borderRadius:'8px', border:'1px solid #bae6fd'}}>
                                <label style={{color:'#0369a1'}}>Categor√≠a de Activo *</label>
                                <select value={formData.idCategoria} onChange={e => setFormData({...formData, idCategoria: e.target.value})} required style={{marginTop:'5px', borderColor:'#0ea5e9'}}>
                                    <option value="">-- Seleccione --</option>
                                    {categorias.map(c => <option key={c.ID_Categoria} value={c.ID_Categoria}>{c.Nombre}</option>)}
                                </select>
                            </div>
                            
                            {/* SELECTOR DE PROGRAMA DESTINO - SIN PUNTOS DE VENTA */}
                            <div className="form-group" style={{background:'#f0fdf4', padding:'10px', borderRadius:'8px', border:'1px solid #bbf7d0'}}>
                                <label style={{color:'#166534', fontWeight:'bold'}}>Programa Destino *</label>
                                <select 
                                    value={formData.programa} 
                                    onChange={e => setFormData({...formData, programa: e.target.value})} 
                                    required 
                                    style={{marginTop:'5px', borderColor:'#22c55e', fontWeight:'500'}}
                                >
                                    <option value="General">General / Otros</option>
                                    <option value="Limpieza y Desinfecci√≥n">Limpieza y Desinfecci√≥n (LYD)</option>
                                    <option value="Calibraci√≥n">Calibraci√≥n</option>
                                    <option value="Muestreo">Programa de Muestreo</option>
                                    <option value="PMIR">Programa PMIR (Residuos)</option>
                                    <option value="Control de Plagas">Control de Plagas</option>
                                    <option value="Agua Potable">Agua Potable</option>
                                    <option value="Trazabilidad">Trazabilidad</option>
                                    <option value="Proveedores">Proveedores / Recepci√≥n</option>
                                    <option value="Materia Prima">Materia Prima</option>
                                    <option value="Capacitaci√≥n">Programa de Capacitaci√≥n</option>
                                    <option value="Recall">Recall (Retiro de Producto)</option>
                                    <option value="Elementos Extra√±os">Elementos Extra√±os</option>
                                    <option value="Al√©rgenos">Control de Al√©rgenos</option>
                                    <option value="HACCP">HACCP / PCC</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn-primary-modal">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalEditForm;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalEditUser.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { updateUser, getRoles } from '../../services/userService';
import useAuth from '../../hooks/useAuth'; // <--- Importamos el Auth para verificar permisos
import { FaTimes, FaUser, FaBriefcase, FaBuilding, FaUserTag, FaInfoCircle } from 'react-icons/fa';
import '../../styles/Modal.css';

const ModalEditUser = ({ isOpen, onClose, user, onSuccess }) => {
    const { auth } = useAuth(); // <--- Obtenemos al usuario logueado
    const [formData, setFormData] = useState({
        nombre: '',
        cargo: '',
        area: '',
        idRol: ''
    });
    
    const [roles, setRoles] = useState([]); 
    const [loading, setLoading] = useState(false);

    // Verificamos si el que est√° logueado es SuperAdmin
    const isSuperAdmin = auth.user?.rol === 'SuperAdmin';

    // 1. Cargar Roles al montar o abrir
    useEffect(() => {
        if (isOpen) {
            cargarRoles();
        }
    }, [isOpen]);

    // 2. Rellenar datos cuando cambia el 'user' a editar
    useEffect(() => {
        if (user && isOpen) {
            setFormData({
                nombre: user.Nombre_Completo || '',
                cargo: user.Cargo || '',
                area: user.Area || '',
                idRol: user.ID_Rol || '' 
            });
        }
    }, [user, isOpen]);

    const cargarRoles = async () => {
        try {
            const data = await getRoles();
            setRoles(data);
        } catch (error) {
            console.error("Error cargando roles", error);
            Swal.fire('Error', 'No se pudieron cargar los roles', 'error');
        }
    };

    const handleChange = (e) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!formData.nombre || !formData.idRol) {
            return Swal.fire('Error', 'El nombre y el rol son obligatorios', 'warning');
        }

        setLoading(true);
        try {
            await updateUser(user.ID_Usuario, {
                nombre: formData.nombre,
                cargo: formData.cargo,
                area: formData.area,
                idRol: formData.idRol
            });
            
            Swal.fire({
                icon: 'success',
                title: 'Actualizado',
                text: 'Usuario modificado correctamente.',
                timer: 1500,
                showConfirmButton: false
            });

            onSuccess();
            onClose();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '500px' }}>
                <div className="modal-header">
                    <h2>Editar Usuario</h2>
                    <button className="modal-close-button" onClick={onClose}>
                        <FaTimes />
                    </button>
                </div>

                <div className="modal-body">
                    <form id="editUserForm" onSubmit={handleSubmit}>
                        
                        {/* C√âDULA (SOLO LECTURA) */}
                        <div className="form-group">
                            <label style={{ fontSize: '0.8rem', color: '#64748b' }}>C√©dula (No editable)</label>
                            <input 
                                type="text" 
                                value={user?.Cedula || ''} 
                                disabled 
                                style={{ backgroundColor: '#f1f5f9', color: '#94a3b8', cursor: 'not-allowed' }} 
                            />
                        </div>

                        {/* NOMBRE */}
                        <div className="form-group">
                            <label><FaUser /> Nombre Completo</label>
                            <input 
                                type="text" 
                                name="nombre" 
                                value={formData.nombre} 
                                onChange={handleChange}
                                required
                            />
                        </div>

                        {/* ROL - BLOQUEADO SI NO ES SUPERADMIN */}
                        <div className="form-group">
                            <label><FaUserTag /> Rol de Usuario</label>
                            <select 
                                name="idRol" 
                                value={formData.idRol} 
                                onChange={handleChange}
                                required
                                disabled={!isSuperAdmin} // <--- AQU√ç EST√Å LA L√ìGICA DE BLOQUEO
                                style={{
                                    backgroundColor: !isSuperAdmin ? '#f1f5f9' : '#f8fafc',
                                    color: !isSuperAdmin ? '#64748b' : '#0f172a',
                                    cursor: !isSuperAdmin ? 'not-allowed' : 'pointer',
                                    borderColor: !isSuperAdmin ? '#e2e8f0' : '#cbd5e1'
                                }}
                            >
                                <option value="">-- Seleccionar Rol --</option>
                                {roles.map((rol) => (
                                    <option key={rol.ID_Rol} value={rol.ID_Rol}>
                                        {rol.Nombre}
                                    </option>
                                ))}
                            </select>
                            
                            {/* Mensaje informativo si est√° bloqueado */}
                            {!isSuperAdmin && (
                                <div style={{ display: 'flex', alignItems: 'center', gap: '5px', marginTop: '5px', fontSize: '0.75rem', color: '#64748b' }}>
                                    <FaInfoCircle /> Solo el SuperAdmin puede cambiar el rol.
                                </div>
                            )}
                        </div>

                        <div className="form-grid-row">
                            {/* CARGO */}
                            <div className="form-group form-col-half">
                                <label><FaBriefcase /> Cargo</label>
                                <input 
                                    type="text" 
                                    name="cargo" 
                                    value={formData.cargo} 
                                    onChange={handleChange}
                                />
                            </div>
                            
                            {/* √ÅREA */}
                            <div className="form-group form-col-half">
                                <label><FaBuilding /> √Årea</label>
                                <input 
                                    type="text" 
                                    name="area" 
                                    value={formData.area} 
                                    onChange={handleChange}
                                />
                            </div>
                        </div>

                    </form>
                </div>

                <div className="modal-footer">
                    <button type="button" className="btn-secondary" onClick={onClose}>
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        form="editUserForm" 
                        className="btn-primary-modal"
                        disabled={loading}
                    >
                        {loading ? 'Guardando...' : 'Guardar Cambios'}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalEditUser;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalGenerarCertificado.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { logCertificado } from '../../services/certificadosService';
import { generarPDFDesdeDatos } from '../../utils/pdfCertificadoGenerator.js'; 
import '../../styles/Modal.css';
import { 
    FaFilePdf, FaTimes, FaSignature, FaHeading, FaLock, 
    FaPen, FaPlus, FaTrash 
} from 'react-icons/fa';

const ModalGenerarCertificado = ({ isOpen, onClose, plantilla }) => {
    // --- ESTADOS ---
    const [formData, setFormData] = useState({});
    const [tableData, setTableData] = useState({});
    const [customHeader, setCustomHeader] = useState({});
    const [customFooter, setCustomFooter] = useState({});
    const [seccionesRender, setSeccionesRender] = useState([]);
    const [generating, setGenerating] = useState(false);

    // Funci√≥n segura para parsear
    const safeParse = (data) => {
        if (!data) return [];
        if (typeof data === 'object') return data;
        try { return JSON.parse(data); } catch { return []; }
    };

    // --- CARGA INICIAL DE LA ESTRUCTURA ---
    useEffect(() => {
        if (isOpen && plantilla) {
            let estructuraTotal = {};
            let seccionesArray = [];

            try {
                estructuraTotal = safeParse(plantilla.Estructura_JSON);
                
                // Normalizar estructura
                if (Array.isArray(estructuraTotal)) {
                    seccionesArray = estructuraTotal;
                    // Valores por defecto
                    setCustomHeader({ empresa: 'EMPAQUETADOS EL TRECE S.A.S', sistema: 'SISTEMA DE GESTI√ìN DE CALIDAD', tituloDoc: 'CERTIFICADO DE CALIDAD', codigo: 'FT-SGC-020', version: '03' });
                    setCustomFooter({ nombre: 'NILSON ALEXIS GALVIS LUJAN', cargo: 'L√≠der de Calidad', empresa: 'Empaquetados el Trece S.A.S' });
                } else {
                    seccionesArray = estructuraTotal.secciones || [];
                    setCustomHeader(estructuraTotal.header || {});
                    setCustomFooter(estructuraTotal.footer || {});
                }
            } catch (e) { console.error("Error cargando estructura:", e); }

            setSeccionesRender(seccionesArray);

            // Inicializar valores vac√≠os
            const initialForm = {};
            const initialTables = {};

            seccionesArray.forEach(sec => {
                if (sec.tipo === 'info') {
                    initialForm[sec.titulo] = {};
                    sec.campos.forEach(campoObj => {
                        initialForm[sec.titulo][campoObj.nombre] = campoObj.valor || '';
                    });
                }
                if (sec.tipo === 'texto') {
                    initialForm[sec.titulo] = sec.contenido || '';
                }
                if (sec.tipo === 'tabla') {
                    // Si tiene filas predefinidas las usamos, si no, creamos una vac√≠a
                    const filasPredefinidas = safeParse(sec.filas);
                    
                    if (filasPredefinidas && filasPredefinidas.length > 0) {
                        initialTables[sec.titulo] = filasPredefinidas;
                    } else {
                        const row = {};
                        (sec.columnas || []).forEach(c => row[c] = '');
                        initialTables[sec.titulo] = [row];
                    }
                }
            });
            setFormData(initialForm);
            setTableData(initialTables);
        }
    }, [isOpen, plantilla]);

    // --- HANDLERS (Manejo de Inputs) ---
    const handleInfoChange = (seccion, campo, valor) => {
        setFormData(prev => ({ ...prev, [seccion]: { ...prev[seccion], [campo]: valor } }));
    };
    
    const handleTextChange = (seccion, valor) => { 
        setFormData(prev => ({ ...prev, [seccion]: valor })); 
    };
    
    const handleTableChange = (seccion, rowIndex, col, valor) => {
        // Copia segura del array
        const newTable = [...(tableData[seccion] || [])];
        if (newTable[rowIndex]) {
            newTable[rowIndex] = { ...newTable[rowIndex], [col]: valor };
            setTableData(prev => ({ ...prev, [seccion]: newTable }));
        }
    };
    
    const addRow = (seccion, columnas) => {
        const newRow = {};
        columnas.forEach(c => newRow[c] = '');
        setTableData(prev => ({ ...prev, [seccion]: [...(prev[seccion] || []), newRow] }));
    };
    
    const removeRow = (seccion, rowIndex) => {
        const newTable = (tableData[seccion] || []).filter((_, i) => i !== rowIndex);
        setTableData(prev => ({ ...prev, [seccion]: newTable }));
    };

    // --- GENERAR Y GUARDAR (L√≥gica Principal) ---
    const handleGenerateAndSave = async () => {
        setGenerating(true);
        try {
            const datosCompletos = { form: formData, tables: tableData, header: customHeader, footer: customFooter };
            // 1. Generar el PDF en Memoria (BLOB)
            const pdfBlob = generarPDFDesdeDatos(
                plantilla.Nombre,
                plantilla.Estructura_JSON, 
                datosCompletos,
                true // <--- Importante: pedir el Blob, no descargar
            );

            // 2. Preparar el paquete de env√≠o (FormData)
            const formDataEnvio = new FormData();
            formDataEnvio.append('idPlantilla', plantilla.ID_Plantilla);
            // Extraer Lote y Cliente si existen en el formulario, para facilitar b√∫squedas
            formDataEnvio.append('lote', formData['Informaci√≥n General']?.['Lote'] || 'S/L');
            formDataEnvio.append('cliente', formData['Informaci√≥n General']?.['Cliente'] || 'Varios');
            
            // Adjuntar los datos JSON (para guardarlos en tablas din√°micas)
            formDataEnvio.append('datos', JSON.stringify(datosCompletos)); 
            
            // Adjuntar el archivo f√≠sico
            const nombreArchivo = `Certificado_${plantilla.Nombre.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
            formDataEnvio.append('pdf', pdfBlob, nombreArchivo);

            // 3. Enviar al Backend
            await logCertificado(formDataEnvio);

            // 4. Feedback al Usuario (y descarga opcional local)
            const link = document.createElement('a');
            link.href = URL.createObjectURL(pdfBlob);
            link.download = nombreArchivo;
            link.click();

            onClose();
            Swal.fire({ 
                icon: 'success', 
                title: 'Generado Correctamente', 
                text: 'El certificado se ha guardado en el historial y se ha descargado una copia.', 
                timer: 3000, 
                showConfirmButton: false 
            });

        } catch (error) {
            console.error("Error al generar/guardar:", error);
            Swal.fire('Error', 'Hubo un problema al procesar el certificado.', 'error');
        } finally {
            setGenerating(false);
        }
    };

    if (!isOpen || !plantilla) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '1000px', maxHeight:'95vh', display:'flex', flexDirection:'column', background:'#f8fafc' }}>
                
                {/* Header */}
                <div className="modal-header" style={{background: 'white', borderBottom: '1px solid #e2e8f0', color:'#0c4760', padding:'15px 25px'}}>
                    <div style={{display:'flex', alignItems:'center', gap:'12px'}}>
                        <div style={{background:'#dcfce7', padding:'8px', borderRadius:'8px', display:'flex', alignItems:'center', justifyContent:'center'}}>
                            <FaFilePdf size={20} color="#16a34a"/>
                        </div>
                        <div>
                            <h2 style={{fontSize:'1.2rem', margin:0, fontWeight:'700'}}>Generar Certificado</h2>
                            <p style={{margin:0, fontSize:'0.8rem', color:'#64748b'}}>Llene los datos variables para: <strong>{plantilla.Nombre}</strong></p>
                        </div>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color:'#64748b', fontSize:'1.2rem'}}><FaTimes/></button>
                </div>
                
                {/* Body (Formulario) */}
                <div className="modal-body" style={{padding:'25px', overflowY:'auto', flex:1}}>
                    
                    {/* Secci√≥n Encabezado */}
                    <div className="design-section" style={{background:'#f0f9ff', border:'1px solid #bae6fd', padding:'15px', borderRadius:'12px', marginBottom:'25px'}}>
                        <h4 style={{marginTop:0, fontSize:'0.9rem', color:'#0369a1', display:'flex', alignItems:'center', gap:'8px'}}>
                            <FaHeading/> Encabezado del Documento (Editable para este PDF)
                        </h4>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))', gap:'10px', marginTop:'10px'}}>
                            <div><label className="label-gen">Empresa</label><input className="input-gen" value={customHeader.empresa || ''} onChange={e=>setCustomHeader({...customHeader, empresa:e.target.value})}/></div>
                            <div><label className="label-gen">T√≠tulo</label><input className="input-gen" value={customHeader.tituloDoc || ''} onChange={e=>setCustomHeader({...customHeader, tituloDoc:e.target.value})}/></div>
                            <div><label className="label-gen">C√≥digo</label><input className="input-gen" value={customHeader.codigo || ''} onChange={e=>setCustomHeader({...customHeader, codigo:e.target.value})}/></div>
                            <div><label className="label-gen">Versi√≥n</label><input className="input-gen" value={customHeader.version || ''} onChange={e=>setCustomHeader({...customHeader, version:e.target.value})}/></div>
                        </div>
                    </div>

                    {/* Secciones Din√°micas */}
                    {seccionesRender.map((sec, idx) => (
                        <div key={idx} className="section-card" style={{background:'white', padding:'20px', borderRadius:'12px', border:'1px solid #e2e8f0', marginBottom:'20px', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}}>
                            <h4 style={{marginTop:0, color:'#0c4760', fontSize:'1rem', borderBottom:'1px dashed #e2e8f0', paddingBottom:'10px', marginBottom:'15px'}}>
                                {sec.titulo.toUpperCase()}
                            </h4>
                            
                            {/* Inputs Tipo Info */}
                            {sec.tipo === 'info' && (
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))', gap:'20px'}}>
                                    {sec.campos.map((campoObj, cIdx) => (
                                        <div key={cIdx}>
                                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'5px'}}>
                                                <label style={{fontSize:'0.8rem', fontWeight:'700', color:'#475569'}}>{campoObj.nombre}</label>
                                                {campoObj.fijo ? <span className="badge-fijo"><FaLock size={8}/> Fijo</span> : null}
                                            </div>
                                            <input 
                                                className="input-gen"
                                                disabled={campoObj.fijo}
                                                style={{
                                                    backgroundColor: campoObj.fijo ? '#f8fafc' : 'white',
                                                    color: campoObj.fijo ? '#94a3b8' : '#1e293b',
                                                    cursor: campoObj.fijo ? 'not-allowed' : 'text'
                                                }}
                                                value={formData[sec.titulo]?.[campoObj.nombre] || ''}
                                                onChange={e => handleInfoChange(sec.titulo, campoObj.nombre, e.target.value)}
                                            />
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Inputs Tipo Texto */}
                            {sec.tipo === 'texto' && (
                                <div style={{position:'relative'}}>
                                    <textarea 
                                        className="input-area-gen"
                                        rows="4" 
                                        disabled={sec.fijo}
                                        value={formData[sec.titulo] || ''} 
                                        onChange={e => handleTextChange(sec.titulo, e.target.value)}
                                    />
                                </div>
                            )}

                            {/* Inputs Tipo Tabla (CORREGIDO) */}
                            {sec.tipo === 'tabla' && (
                                <div>
                                    <table className="table-gen">
                                        <thead>
                                            <tr>
                                                {(sec.columnas || []).map(c => <th key={c}>{c}</th>)}
                                                <th style={{width:'40px'}}></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {/* BLINDAJE: Usamos ( ... || []) para que no falle si tableData es null */}
                                            {(tableData[sec.titulo] || []).map((row, rIdx) => (
                                                <tr key={rIdx}>
                                                    {(sec.columnas || []).map(col => (
                                                        <td key={col}>
                                                            <input 
                                                                className="input-table-gen"
                                                                value={row[col] || ''} 
                                                                onChange={e => handleTableChange(sec.titulo, rIdx, col, e.target.value)}
                                                            />
                                                        </td>
                                                    ))}
                                                    <td>
                                                        <button className="btn-icon-del" onClick={() => removeRow(sec.titulo, rIdx)}><FaTrash/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <button className="btn-add-table" onClick={() => addRow(sec.titulo, sec.columnas)}>
                                        <FaPlus size={10}/> Agregar Fila
                                    </button>
                                </div>
                            )}
                        </div>
                    ))}

                    {/* Secci√≥n Firma */}
                    <div style={{background:'#fff7ed', border:'1px solid #fed7aa', padding:'15px', borderRadius:'12px', marginTop:'20px'}}>
                        <h4 style={{marginTop:0, fontSize:'0.9rem', color:'#c2410c', display:'flex', gap:'5px', alignItems:'center'}}>
                            <FaSignature/> Firma Autorizada (Editable)
                        </h4>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:'10px', marginTop:'10px'}}>
                            <div><label className="label-gen">Nombre</label><input className="input-gen" value={customFooter.nombre || ''} onChange={e=>setCustomFooter({...customFooter, nombre:e.target.value})}/></div>
                            <div><label className="label-gen">Cargo</label><input className="input-gen" value={customFooter.cargo || ''} onChange={e=>setCustomFooter({...customFooter, cargo:e.target.value})}/></div>
                            <div><label className="label-gen">Empresa</label><input className="input-gen" value={customFooter.empresa || ''} onChange={e=>setCustomFooter({...customFooter, empresa:e.target.value})}/></div>
                        </div>
                    </div>

                </div>

                {/* Footer Botones */}
                <div className="modal-footer" style={{background:'white', borderTop:'1px solid #e2e8f0', padding:'20px'}}>
                    <button className="btn-secondary" onClick={onClose} style={{marginRight:'10px'}}>Cancelar</button>
                    <button 
                        className="btn-primary-modal" 
                        onClick={handleGenerateAndSave} 
                        disabled={generating}
                        style={{background:'#dc2626', padding:'10px 25px', fontSize:'1rem', boxShadow:'0 4px 6px rgba(220, 38, 38, 0.2)'}}
                    >
                        {generating ? 'Guardando...' : <><FaFilePdf style={{marginRight:'8px'}}/> Generar y Guardar</>}
                    </button>
                </div>
            </div>

            {/* Estilos CSS en l√≠nea para este componente */}
            <style>{`
                .label-gen { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 3px; display: block; text-transform: uppercase; }
                .input-gen { width: 100%; padding: 8px; border: 1px solid #cbd5e1; borderRadius: 6px; font-size: 0.9rem; transition: all 0.2s; }
                .input-gen:focus { border-color: #0ea5e9; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1); outline: none; }
                .input-area-gen { width: 100%; padding: 10px; border: 1px solid #cbd5e1; borderRadius: 6px; font-family: inherit; font-size: 0.95rem; resize: vertical; }
                .table-gen { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85rem; }
                .table-gen th { text-align: left; padding: 8px; color: #64748b; border-bottom: 1px solid #e2e8f0; font-size: 0.75rem; text-transform: uppercase; }
                .table-gen td { padding: 5px; }
                .input-table-gen { width: 100%; padding: 6px; border: 1px solid #e2e8f0; borderRadius: 4px; font-size: 0.9rem; }
                .btn-icon-del { border: none; background: transparent; color: #ef4444; cursor: pointer; opacity: 0.6; }
                .btn-icon-del:hover { opacity: 1; transform: scale(1.1); }
                .btn-add-table { margin-top: 10px; background: white; border: 1px dashed #cbd5e1; color: #64748b; padding: 6px 12px; borderRadius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
                .btn-add-table:hover { border-color: #0ea5e9; color: #0ea5e9; background: #f0f9ff; }
                .badge-fijo { font-size: 0.65rem; color: #94a3b8; background: #f1f5f9; padding: 2px 5px; border-radius: 4px; display: inline-flex; align-items: center; gap: 3px; }
            `}</style>
        </div>
    );
};
export default ModalGenerarCertificado;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalGestionarACPM.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
// Usamos manageACPM unificado (aseg√∫rate de que tu servicio acpmService soporte FormData, lo veremos luego)
import { manageACPM } from '../../services/acpmService';
import '../../styles/Modal.css';
import { 
    FaCheckCircle, FaExclamationCircle, FaPaperPlane, 
    FaTimes, FaCloudUploadAlt, FaFileAlt
} from 'react-icons/fa';

const ModalGestionarACPM = ({ isOpen, onClose, acpm, onSuccess }) => {
    // --- ESTADOS ---
    const [estado, setEstado] = useState('');
    const [comentarios, setComentarios] = useState('');
    const [urlEvidencia, setUrlEvidencia] = useState(''); // Para links externos (Drive, etc.)
    const [archivo, setArchivo] = useState(null); // Para archivos locales (Fotos/PDF)
    const [loading, setLoading] = useState(false);

    // --- EFECTO: CARGAR DATOS AL ABRIR ---
    useEffect(() => {
        if (acpm && isOpen) {
            setEstado(acpm.Estado || 'Abierta');
            setComentarios(''); 
            setUrlEvidencia(acpm.Url_Evidencia_Cierre || '');
            setArchivo(null); 
        }
    }, [acpm, isOpen]);

    if (!isOpen || !acpm) return null;

    // --- MANEJADORES ---
    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            setArchivo(file);
            setUrlEvidencia(''); // Si el usuario sube un archivo, limpiamos el campo de URL externa
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
            // 1. Validaci√≥n: Si se cierra, DEBE haber evidencia
            const tieneEvidencia = archivo || (urlEvidencia && urlEvidencia.trim() !== '');
            
            if (estado === 'Cerrada' && !tieneEvidencia) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Falta Evidencia',
                    text: 'Para cerrar el plan es OBLIGATORIO adjuntar un archivo o link de evidencia.',
                    confirmButtonColor: '#0c4760'
                });
                setLoading(false);
                return;
            }

            // 2. Preparar FormData (Unificado para texto y archivos)
            const formData = new FormData();
            formData.append('nuevoEstado', estado);
            formData.append('comentario', comentarios);
            formData.append('usuario', 'Administrador'); // Aqu√≠ podr√≠as poner el usuario real del localStorage si quisieras
            
            if (archivo) {
                // Si hay archivo f√≠sico
                formData.append('evidencia', archivo);
            } else if (urlEvidencia) {
                // Si es solo link
                formData.append('urlEvidencia', urlEvidencia);
            }

            // 3. Enviar al Backend
            await manageACPM(acpm.ID_ACPM, formData);

            // 4. Feedback
            Swal.fire({
                title: '¬°Gesti√≥n Guardada!',
                text: `El plan de acci√≥n ha sido actualizado correctamente a: ${estado}.`,
                icon: 'success',
                confirmButtonColor: '#0c4760',
                timer: 2000
            });
            
            onSuccess(); // Recargar tabla padre
            onClose();   // Cerrar modal

        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'Error al procesar la solicitud', 'error');
        } finally {
            setLoading(false);
        }
    };

    // --- ESTILOS DIN√ÅMICOS PARA BOTONES DE ESTADO ---
    const getStatusStyle = (currentStatus) => {
        if (estado === currentStatus) {
            switch (currentStatus) {
                case 'Abierta': return { background: '#fff7ed', color: '#c2410c', borderColor: '#fdba74', fontWeight: 'bold' };
                case 'En Progreso': return { background: '#eff6ff', color: '#1d4ed8', borderColor: '#bfdbfe', fontWeight: 'bold' };
                case 'Cerrada': return { background: '#f0fdf4', color: '#15803d', borderColor: '#86efac', fontWeight: 'bold' };
                default: return {};
            }
        }
        return { background: '#fff', color: '#64748b', borderColor: '#e2e8f0', opacity: 0.7 };
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '850px', flexDirection: 'row', overflow: 'hidden', height: '90vh' }}>
                
                {/* --- COLUMNA IZQUIERDA: RESUMEN DEL HALLAZGO --- */}
                <div style={{ 
                    flex: '1', 
                    background: '#f8fafc', 
                    padding: '2rem', 
                    borderRight: '1px solid #e2e8f0', 
                    display: 'flex', 
                    flexDirection: 'column',
                    overflowY: 'auto', 
                    maxHeight: '100%' 
                }}>
                    <h3 style={{ color: '#0c4760', marginBottom: '1.5rem', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem' }}>
                        Detalle del Hallazgo
                    </h3>
                    
                    <div style={{ marginBottom: '1rem' }}>
                        <label style={{ fontSize: '0.75rem', fontWeight: '700', color: '#94a3b8', textTransform: 'uppercase' }}>ID & Origen</label>
                        <div style={{ color: '#334155', fontWeight: '600' }}>#{acpm.ID_ACPM} - {acpm.Origen}</div>
                    </div>

                    <div style={{ marginBottom: '1rem' }}>
                        <label style={{ fontSize: '0.75rem', fontWeight: '700', color: '#94a3b8', textTransform: 'uppercase' }}>Descripci√≥n</label>
                        <div style={{ 
                            color: '#334155', 
                            fontSize: '0.9rem', 
                            lineHeight: '1.5', 
                            background: '#fff', 
                            padding: '0.8rem', 
                            borderRadius: '6px', 
                            border: '1px solid #e2e8f0',
                            whiteSpace: 'pre-wrap' 
                        }}>
                            {acpm.Descripcion}
                        </div>
                    </div>

                    <div style={{ marginTop: 'auto', padding: '1rem', background: '#fff1f2', borderRadius: '6px', border: '1px solid #fecdd3' }}>
                        <label style={{ fontSize: '0.75rem', fontWeight: '700', color: '#be123c', textTransform: 'uppercase' }}>Fecha L√≠mite</label>
                        <div style={{ color: '#881337', fontWeight: 'bold' }}>
                            {new Date(acpm.Fecha_Limite).toLocaleDateString()}
                        </div>
                    </div>
                </div>

                {/* --- COLUMNA DERECHA: FORMULARIO DE GESTI√ìN --- */}
                <div style={{ 
                    flex: '1.3', 
                    padding: '2rem', 
                    display: 'flex', 
                    flexDirection: 'column', 
                    overflowY: 'auto', 
                    maxHeight: '100%' 
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ fontSize: '1.4rem', margin: 0 }}>Gestionar Plan de Acci√≥n</h2>
                        <button onClick={onClose} style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: '#94a3b8', cursor: 'pointer' }}><FaTimes /></button>
                    </div>

                    <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '1.2rem', flex: 1 }}>
                        
                        {/* SELECCI√ìN DE ESTADO */}
                        <div className="form-group">
                            <label>Actualizar Estado</label>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                {['Abierta', 'En Progreso', 'Cerrada'].map(status => (
                                    <button
                                        type="button"
                                        key={status}
                                        onClick={() => setEstado(status)}
                                        style={{ 
                                            flex: 1, padding: '0.6rem', borderRadius: '6px', border: '1px solid',
                                            cursor: 'pointer', transition: 'all 0.2s', ...getStatusStyle(status)
                                        }}
                                    >
                                        {status}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* COMENTARIOS */}
                        <div className="form-group">
                            <label>Comentarios de Avance / Cierre</label>
                            <textarea
                                rows="3"
                                placeholder="Describa las acciones realizadas..."
                                value={comentarios}
                                onChange={e => setComentarios(e.target.value)}
                                style={{ resize: 'none' }}
                            ></textarea>
                        </div>

                        {/* EVIDENCIA */}
                        <div className="form-group">
                            <label style={{ display: 'flex', alignItems: 'center', gap: '5px' }}>
                                Evidencia de Cierre
                                {estado === 'Cerrada' && <span style={{ color: '#ef4444', fontSize: '0.8rem' }}>(Obligatorio)</span>}
                            </label>

                            {/* CAJA DE SUBIDA DE ARCHIVO */}
                            <div style={{ 
                                border: '2px dashed #cbd5e1', borderRadius: '8px', padding: '1rem', 
                                background: '#f8fafc', position: 'relative', textAlign: 'center' 
                            }}>
                                <input 
                                    type="file" 
                                    onChange={handleFileChange} 
                                    accept="image/*,.pdf,.doc,.docx"
                                    style={{ 
                                        position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', 
                                        opacity: 0, cursor: 'pointer' 
                                    }} 
                                />
                                
                                {archivo ? (
                                    <div style={{ color: '#0c4760', fontWeight: '500', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                                        <FaFileAlt size={20} />
                                        <span>{archivo.name}</span>
                                        <button 
                                            type="button" 
                                            onClick={(e) => { e.stopPropagation(); setArchivo(null); }} 
                                            style={{ marginLeft:'10px', color:'#ef4444', background:'none', border:'none', cursor:'pointer' }}
                                        >
                                            x
                                        </button>
                                    </div>
                                ) : (
                                    <div style={{ color: '#64748b', fontSize: '0.9rem' }}>
                                        <FaCloudUploadAlt size={24} style={{ marginBottom: '5px', display: 'block', margin: '0 auto' }} />
                                        <span>Click o Arrastra para subir <b>Foto</b> o <b>PDF</b></span>
                                    </div>
                                )}
                            </div>

                            {/* INPUT DE URL (SOLO SI NO HAY ARCHIVO) */}
                            {!archivo && (
                                <input
                                    type="text"
                                    placeholder="O pegue un enlace externo (Drive, SharePoint)..."
                                    value={urlEvidencia}
                                    onChange={e => setUrlEvidencia(e.target.value)}
                                    style={{ marginTop: '10px', fontSize:'0.85rem' }}
                                />
                            )}

                            {/* MENSAJE DE VALIDACI√ìN VISUAL */}
                            {estado === 'Cerrada' && !archivo && !urlEvidencia && (
                                <div style={{ fontSize: '0.8rem', color: '#ef4444', marginTop: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <FaExclamationCircle /> Se requiere archivo o link para cerrar el plan.
                                </div>
                            )}
                        </div>

                        {/* BOTONES DE ACCI√ìN */}
                        <div style={{ marginTop: 'auto', display: 'flex', justifyContent: 'flex-end', gap: '10px', paddingTop: '1rem', borderTop: '1px solid #f1f5f9' }}>
                            <button type="button" className="btn-secondary" onClick={onClose} disabled={loading}>
                                Cancelar
                            </button>
                            <button 
                                type="submit" 
                                className="btn-primary-modal" 
                                disabled={loading}
                                style={{ 
                                    display: 'flex', alignItems: 'center', gap: '8px', 
                                    background: estado === 'Cerrada' ? '#16a34a' : '#0c4760',
                                    opacity: loading ? 0.7 : 1
                                }}
                            >
                                {loading ? 'Subiendo...' : (
                                    <>
                                        {estado === 'Cerrada' ? <FaCheckCircle /> : <FaPaperPlane />} 
                                        {estado === 'Cerrada' ? 'Cerrar Plan' : 'Guardar Gesti√≥n'}
                                    </>
                                )}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default ModalGestionarACPM;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalGestionarActividad.jsx
==================================================================
import { useState } from 'react';
import { updateEstadoActividad, addSeguimiento } from '../../services/cronogramaService';
import { FaTimes, FaTools, FaCheckCircle, FaBan, FaClock, FaPaperPlane, FaCamera } from 'react-icons/fa';
import '../../styles/Modal.css';

const ModalGestionarActividad = ({ isOpen, onClose, actividad, onSuccess }) => {
    const [estado, setEstado] = useState(actividad?.Estado || 'Pendiente');
    const [nota, setNota] = useState('');
    const [archivo, setArchivo] = useState(null);
    const [loading, setLoading] = useState(false);

    if (!isOpen || !actividad) return null;

    const handleSave = async () => {
        setLoading(true);
        try {
            // 1. Actualizar Estado (si cambi√≥)
            if (estado !== actividad.Estado) {
                await updateEstadoActividad(actividad.ID_Actividad, estado);
            }

            // 2. Enviar Nota y/o Evidencia (FormData)
            if (nota.trim() || archivo) {
                const formData = new FormData();
                formData.append('nota', nota);
                if (archivo) formData.append('evidencia', archivo);
                
                await addSeguimiento(actividad.ID_Actividad, formData);
            }

            onSuccess();
            onClose();
            // Reset
            setNota(''); setArchivo(null);
        } catch (error) { 
            alert('Error al gestionar: ' + error.message); 
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-box">
                <div className="modal-header-clean">
                    <h3>Gestionar Actividad</h3>
                    <button className="close-btn" onClick={onClose}>&times;</button>
                </div>
                <div className="modal-body-clean">
                    <h4 style={{marginTop:0, marginBottom:'15px', color:'#0c4760'}}>{actividad.Nombre_Actividad}</h4>
                    
                    <div style={{marginBottom:'20px'}}>
                        <label className="input-label">Actualizar Estado</label>
                        <div style={{display:'flex', gap:'10px'}}>
                            <button onClick={() => setEstado('Realizada')} className={`btn ${estado === 'Realizada' ? 'btn-blue' : 'btn-grey'}`} style={{flex:1, opacity: estado==='Realizada'?1:0.5}}>
                                <FaCheckCircle/> Realizada
                            </button>
                            <button onClick={() => setEstado('Pendiente')} className={`btn ${estado === 'Pendiente' ? 'btn-yellow' : 'btn-grey'}`} style={{flex:1, opacity: estado==='Pendiente'?1:0.5, color: estado==='Pendiente'?'black':'white'}}>
                                <FaClock/> Pendiente
                            </button>
                            <button onClick={() => setEstado('Cancelada')} className={`btn ${estado === 'Cancelada' ? 'btn-red' : 'btn-grey'}`} style={{flex:1, opacity: estado==='Cancelada'?1:0.5}}>
                                <FaBan/> Cancelada
                            </button>
                        </div>
                    </div>
                    
                    <div style={{marginBottom:'15px'}}>
                        <label className="input-label">Observaciones / Bit√°cora</label>
                        <textarea className="form-control" rows="3" placeholder="Ej: Actividad completada, se adjunta soporte..." value={nota} onChange={e => setNota(e.target.value)}></textarea>
                    </div>
                    
                    <div style={{marginBottom:'15px'}}>
                        <label className="input-label">Adjuntar Evidencia (Foto/PDF)</label>
                        <div style={{position:'relative'}}>
                            <input 
                                type="file" 
                                className="form-control" 
                                onChange={e => setArchivo(e.target.files[0])}
                                accept="image/*,.pdf"
                                style={{paddingLeft:'40px'}}
                            />
                            <FaCamera style={{position:'absolute', left:'12px', top:'10px', color:'#64748b'}}/>
                        </div>
                    </div>
                </div>
                <div className="modal-footer-clean">
                    <button className="btn btn-grey" onClick={onClose}>Cancelar</button>
                    <button className="btn btn-blue" onClick={handleSave} disabled={loading}>
                        {loading ? 'Guardando...' : 'Guardar Gesti√≥n'}
                    </button>
                </div>
            </div>
        </div>
    );
};
export default ModalGestionarActividad;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalHistorialCertificados.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getHistorialCertificados } from '../../services/certificadosService';
// Importamos utilidades seguras
import { apiFetchBlob, extractFilename } from '../../services/api';
import { FaTimes, FaSearch, FaHistory, FaFilter, FaFilePdf, FaIndustry, FaUserTie, FaEye } from 'react-icons/fa';
import Swal from 'sweetalert2';
import '../../styles/ModalHistorialCertificados.css';

const ModalHistorialCertificados = ({ isOpen, onClose, plantillaFiltro }) => {
    const [historial, setHistorial] = useState([]);
    const [filtro, setFiltro] = useState('');
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (isOpen) {
            document.body.style.overflow = 'hidden'; 
            cargarHistorial();
        } else {
            document.body.style.overflow = 'auto'; 
        }
        return () => { document.body.style.overflow = 'auto'; };
    }, [isOpen, plantillaFiltro]);

    const cargarHistorial = async () => {
        setLoading(true);
        try {
            const data = await getHistorialCertificados();
            if (Array.isArray(data)) {
                setHistorial(data);
            } else {
                setHistorial([]);
            }
        } catch (error) { 
            console.error(error); 
            setHistorial([]);
        } finally { 
            setLoading(false); 
        }
    };

    // --- FUNCI√ìN SEGURA PARA VER CERTIFICADO ---
    const handleVerCertificado = async (urlPdf) => {
        if (!urlPdf) return;
        
        try {
            const filename = extractFilename(urlPdf);
            // Usamos una ruta de streaming para certificados. 
            // (Aseg√∫rate de crearla en el backend: /certificados/pdf/:filename)
            const blob = await apiFetchBlob(`/certificados/pdf/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error viendo certificado:", error);
            // Fallback para certificados antiguos
            if (urlPdf.startsWith('http')) {
                window.open(urlPdf, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo abrir el certificado.', 'error');
            }
        }
    };

    const filtered = historial.filter(h => {
        if (plantillaFiltro) {
            const idHistorial = String(h.ID_Plantilla || '');
            const idFiltro = String(plantillaFiltro.ID_Plantilla || '');
            if (idHistorial !== idFiltro) return false;
        }
        
        const search = filtro.toLowerCase();
        const lote = (h.Lote || '').toString().toLowerCase();
        const cliente = (h.Cliente || '').toString().toLowerCase();
        const responsable = (h.Responsable || '').toString().toLowerCase();
        const nombrePlantilla = (h.Nombre_Certificado || '').toString().toLowerCase();

        return (
            lote.includes(search) || 
            cliente.includes(search) ||
            responsable.includes(search) ||
            nombrePlantilla.includes(search)
        );
    });

    if (!isOpen) return null;

    return (
        <div className="history-modal-overlay">
            <div className="history-modal-content">
                <div className="history-modal-header">
                    <div className="history-title-block">
                        <h2><FaHistory className="icon-header"/> Historial de Certificados</h2>
                        {plantillaFiltro && (
                            <div className="filter-badge-active">
                                <FaFilter size={10}/> <span>Filtrando solo: <strong>{plantillaFiltro.Nombre}</strong></span>
                            </div>
                        )}
                    </div>
                    <button className="btn-close-modal" onClick={onClose}><FaTimes/></button>
                </div>
                
                <div className="history-modal-body">
                    <div className="history-search-container">
                        <div className="search-input-wrapper">
                            <FaSearch className="search-icon"/>
                            <input 
                                className="search-input"
                                placeholder="Escribe aqu√≠ el Lote, Cliente o Responsable..." 
                                value={filtro} 
                                onChange={e => setFiltro(e.target.value)}
                                autoFocus
                            />
                        </div>
                        <div className="results-count"><strong>{filtered.length}</strong> registros</div>
                    </div>

                    <div className="history-table-wrapper">
                        <table className="history-table">
                            <thead>
                                <tr>
                                    <th width="15%">Fecha</th>
                                    {!plantillaFiltro && <th width="20%">Formato</th>} 
                                    <th width="20%">Lote / Referencia</th>
                                    <th width="20%">Cliente</th>
                                    <th width="15%">Generado Por</th>
                                    <th width="10%" style={{textAlign:'center'}}>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? (
                                    <tr><td colSpan="6" className="state-cell">Cargando datos...</td></tr>
                                ) : filtered.length === 0 ? (
                                    <tr><td colSpan="6" className="state-cell">No se encontraron coincidencias.</td></tr>
                                ) : (
                                    filtered.map((cert, idx) => (
                                        <tr key={cert.ID_Generado || idx} className="history-row">
                                            <td>
                                                <div className="date-cell">
                                                    <span className="date-text">
                                                        {new Date(cert.Fecha_Generacion).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                                    </span>
                                                    <span className="time-text">
                                                        {new Date(cert.Fecha_Generacion).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}
                                                    </span>
                                                </div>
                                            </td>
                                            
                                            {!plantillaFiltro && (
                                                <td className="format-cell">{cert.Nombre_Certificado}</td>
                                            )}
                                            
                                            <td>
                                                <div className="lote-badge">
                                                    <FaIndustry size={10} style={{marginRight:'4px', opacity:0.7}}/>
                                                    {cert.Lote}
                                                </div>
                                            </td>
                                            
                                            <td className="client-cell">
                                                <FaUserTie size={10} style={{marginRight:'5px', color:'#64748b'}}/>
                                                {cert.Cliente}
                                            </td>
                                            
                                            <td className="user-cell">{cert.Responsable}</td>
                                            
                                            <td style={{textAlign:'center'}}>
                                                {cert.Url_PDF ? (
                                                    <button 
                                                        onClick={() => handleVerCertificado(cert.Url_PDF)} 
                                                        className="btn-pdf-action" 
                                                        title="Ver Documento"
                                                        style={{border:'none', background:'transparent', cursor:'pointer'}}
                                                    >
                                                        <FaFilePdf size={18} color="#ef4444"/>
                                                    </button>
                                                ) : <span className="no-doc">-</span>}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default ModalHistorialCertificados;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalHistorialPesos.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getHistorialPesos, getDetallePeso } from '../../services/pesosService';
import { generarPDFPesos } from '../../utils/pdfPesosGenerator';
import Swal from 'sweetalert2';

import { FaTimes, FaHistory, FaSearch, FaEye, FaCheckCircle, FaTimesCircle, FaFilePdf } from 'react-icons/fa';
import ModalDetallePeso from './ModalDetallePeso';
import '../../styles/Modal.css';
import '../../styles/Tables.css'; 

const ModalHistorialPesos = ({ isOpen, onClose }) => {
    const [historial, setHistorial] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    
    const [selectedId, setSelectedId] = useState(null);
    const [showDetail, setShowDetail] = useState(false);

    useEffect(() => {
        if (isOpen) {
            document.body.style.overflow = 'hidden';
            cargarDatos();
        } else {
            document.body.style.overflow = 'unset';
        }
        return () => { document.body.style.overflow = 'unset'; };
    }, [isOpen]);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            const data = await getHistorialPesos();
            setHistorial(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleViewDetail = (id) => {
        setSelectedId(id);
        setShowDetail(true);
    };

    const handleViewPDF = async (idControl) => {
        try {
            Swal.fire({
                title: 'Generando Vista Previa...',
                text: 'Por favor espere un momento.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // Obtenemos los datos completos del control
            const data = await getDetallePeso(idControl);

            const pdfConfig = {
                empresa: 'EMPAQUETADOS EL TRECE S.A.S',
                sistema: 'SISTEMA DE GESTI√ìN DE CALIDAD',
                titulo: 'CONTROL DE PESOS EN PROCESO',
                codigo: 'R-CAL-005',
                version: '01'
            };

            // Generamos el PDF (Este archivo necesita ser revisado luego)
            await generarPDFPesos(data, pdfConfig, true);

            Swal.close(); 

        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo generar la vista previa del PDF.', 'error');
        }
    };

    const filteredData = historial.filter(item => 
        item.Lote.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.Producto.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.Responsable.toLowerCase().includes(searchTerm.toLowerCase())
    );

    if (!isOpen) return null;

    return (
        <>
            <div className="modal-overlay">
                <div className="modal-content" style={{ maxWidth: '1000px', height: '85vh', maxHeight: '85vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                    
                    {/* Header Fijo */}
                    <div className="modal-header" style={{ flexShrink: 0 }}>
                        <h2 style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaHistory style={{color:'#0c4760'}}/> Historial de Pesos
                        </h2>
                        <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                    </div>

                    {/* Body Scrollable */}
                    <div className="modal-body" style={{ padding: '0', flex: '1', overflowY: 'auto', minHeight: '0' }}>
                        
                        {/* Buscador */}
                        <div style={{padding:'1.5rem', background:'#f8fafc', borderBottom:'1px solid #e2e8f0', position:'sticky', top:0, zIndex:10}}>
                            <div className="search-input-container" style={{maxWidth:'100%'}}>
                                <FaSearch />
                                <input 
                                    type="text" 
                                    placeholder="Buscar por lote, producto o responsable..." 
                                    value={searchTerm}
                                    onChange={e => setSearchTerm(e.target.value)}
                                    autoFocus
                                />
                            </div>
                        </div>

                        {/* Tabla */}
                        <div className="table-container" style={{border:'none', borderRadius:0, boxShadow:'none', padding:'0 1.5rem 1.5rem 1.5rem'}}>
                            <table className="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Lote</th>
                                        <th>Producto</th>
                                        <th>Nominal (g)</th>
                                        <th>Estado</th>
                                        <th>Responsable</th>
                                        <th style={{textAlign:'center'}}>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {loading ? (
                                        <tr><td colSpan="7" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr>
                                    ) : filteredData.length === 0 ? (
                                        <tr><td colSpan="7" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No se encontraron registros.</td></tr>
                                    ) : (
                                        filteredData.map(item => (
                                            <tr key={item.ID_Control}>
                                                <td>
                                                    <div style={{fontWeight:'bold', color:'#334155'}}>
                                                        {new Date(item.Fecha_Registro).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                                    </div>
                                                    <div style={{fontSize:'0.75rem', color:'#94a3b8'}}>
                                                        {new Date(item.Fecha_Registro).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour:'2-digit', minute:'2-digit' })}
                                                    </div>
                                                </td>
                                                <td style={{fontWeight:'bold', color:'#0c4760'}}>{item.Lote}</td>
                                                <td>{item.Producto}</td>
                                                <td>{item.Peso_Nominal} g</td>
                                                <td>
                                                    {item.Estado_Final === 'Aprobado' ? (
                                                        <span className="badge badge-success"><FaCheckCircle/> OK</span>
                                                    ) : (
                                                        <span className="badge badge-danger"><FaTimesCircle/> Fallo</span>
                                                    )}
                                                </td>
                                                <td style={{fontSize:'0.85rem'}}>{item.Responsable}</td>
                                                <td style={{textAlign:'center'}}>
                                                    <div style={{display:'flex', justifyContent:'center', gap:'8px'}}>
                                                        
                                                        <button 
                                                            className="btn-action" 
                                                            onClick={() => handleViewDetail(item.ID_Control)}
                                                            title="Ver Detalle y Gr√°fica"
                                                        >
                                                            <FaEye />
                                                        </button>

                                                        <button 
                                                            className="btn-action" 
                                                            onClick={() => handleViewPDF(item.ID_Control)}
                                                            title="Ver Reporte PDF"
                                                            style={{color:'#dc2626', borderColor:'#fca5a5', background:'#fef2f2'}}
                                                        >
                                                            <FaFilePdf />
                                                        </button>

                                                    </div>
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="modal-footer" style={{ flexShrink: 0 }}>
                        <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                    </div>
                </div>
            </div>

            <ModalDetallePeso 
                isOpen={showDetail} 
                onClose={() => setShowDetail(false)} 
                idControl={selectedId} 
            />
        </>
    );
};

export default ModalHistorialPesos;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalRegistrarAgua.jsx
==================================================================
import { useState, useEffect } from 'react';
import { registrarAgua, getHistorialAgua } from '../../services/specializedService'; // Importamos getHistorialAgua
import '../../styles/Modal.css';
import { FaTint, FaCamera, FaSave, FaTimes, FaPen, FaSync } from 'react-icons/fa';
import Swal from 'sweetalert2';

const ModalRegistrarAgua = ({ isOpen, onClose, onSuccess }) => {
    
    // Lista base por defecto
    const DEFAULT_PUNTOS = [
        "Grifo Entrada Principal",
        "Filtro Planta Producci√≥n",
        "Ba√±os Administrativos",
        "Comedor"
    ];

    // Estados
    const [puntosDisponibles, setPuntosDisponibles] = useState(DEFAULT_PUNTOS);
    const [form, setForm] = useState({ puntoToma: '', cloro: '', ph: '' });
    const [isCustom, setIsCustom] = useState(false);
    
    const [foto, setFoto] = useState(null);
    const [preview, setPreview] = useState(null);
    const [loading, setLoading] = useState(false);

    // Cargar historial al abrir el modal
    useEffect(() => {
        if (isOpen) {
            cargarPuntosHistoricos();
            // Resetear formulario al abrir
            setForm({ puntoToma: '', cloro: '', ph: '' });
            setIsCustom(false);
            setFoto(null);
            setPreview(null);
        }
    }, [isOpen]);

    const cargarPuntosHistoricos = async () => {
        try {
            const historial = await getHistorialAgua();
            const puntosUsados = historial.map(item => item.Punto_Toma);
            const listaCombinada = [...new Set([...DEFAULT_PUNTOS, ...puntosUsados])];
            setPuntosDisponibles(listaCombinada);
        } catch (error) {
            console.error("Error cargando puntos", error);
        }
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            setFoto(file);
            setPreview(URL.createObjectURL(file));
        }
    };

    const handleSelectChange = (e) => {
        const valor = e.target.value;
        if (valor === 'Otro') {
            setIsCustom(true);
            setForm({ ...form, puntoToma: '' });
        } else {
            setIsCustom(false);
            setForm({ ...form, puntoToma: valor });
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (!form.puntoToma.trim()) return Swal.fire('Atenci√≥n', 'Indique el punto de toma.', 'warning');
        if (!foto) return Swal.fire('Falta evidencia', 'La foto es obligatoria.', 'warning');

        setLoading(true);
        try {
            const datosMedicion = `Cloro: ${form.cloro} ppm | pH: ${form.ph}`;
            await registrarAgua(form.puntoToma, datosMedicion, foto);
            
            Swal.fire({
                icon: 'success',
                title: 'Registrado',
                text: 'Verificaci√≥n de agua guardada correctamente.',
                timer: 2000,
                showConfirmButton: false
            });

            if(onSuccess) onSuccess(); 
            onClose();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px'}}>
                <div className="modal-header">
                    <h2 style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaTint style={{color:'#0ea5e9'}}/> Verificar Calidad de Agua
                    </h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        
                        {/* SECCI√ìN PUNTO DE TOMA */}
                        <div className="form-group">
                            <label>Punto de Toma *</label>
                            
                            <select 
                                value={isCustom ? 'Otro' : form.puntoToma}
                                onChange={handleSelectChange}
                                required
                                style={{marginBottom: isCustom ? '10px' : '0'}}
                            >
                                <option value="">Seleccione...</option>
                                {puntosDisponibles.map((punto, index) => (
                                    <option key={index} value={punto}>{punto}</option>
                                ))}
                                <option value="Otro" style={{fontWeight:'bold', color:'#0ea5e9'}}>+ Otro (Nuevo Punto)</option>
                            </select>

                            {isCustom && (
                                <div style={{position:'relative', animation: 'fadeIn 0.3s ease'}}>
                                    <FaPen style={{position:'absolute', top:'12px', left:'12px', color:'#94a3b8', fontSize:'0.8rem'}}/>
                                    <input 
                                        type="text" 
                                        placeholder="Escriba el nombre del nuevo punto..." 
                                        value={form.puntoToma}
                                        onChange={e => setForm({...form, puntoToma: e.target.value})}
                                        required
                                        style={{paddingLeft:'2.2rem', borderColor:'#0ea5e9', background:'#f0f9ff'}}
                                        autoFocus
                                    />
                                    <small style={{color:'#64748b', marginTop:'4px', display:'block', fontSize:'0.75rem'}}>
                                        * Se guardar√° en la lista autom√°ticamente.
                                    </small>
                                </div>
                            )}
                        </div>

                        <div className="form-grid-row">
                            <div className="form-group form-col-half">
                                <label>Cloro (ppm) *</label>
                                <input 
                                    type="number" step="0.1" placeholder="Ej: 1.5"
                                    value={form.cloro}
                                    onChange={e => setForm({...form, cloro: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group form-col-half">
                                <label>pH *</label>
                                <input 
                                    type="number" step="0.1" placeholder="Ej: 7.2"
                                    value={form.ph}
                                    onChange={e => setForm({...form, ph: e.target.value})}
                                    required
                                />
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Evidencia (Foto) *</label>
                            <div style={{
                                border:'2px dashed #cbd5e1', padding:'1rem', borderRadius:'8px', 
                                textAlign:'center', position:'relative', background: '#f8fafc', cursor:'pointer'
                            }}>
                                <input 
                                    type="file" accept="image/*"
                                    onChange={handleFileChange}
                                    style={{position:'absolute', top:0, left:0, width:'100%', height:'100%', opacity:0, cursor:'pointer'}}
                                    required={!foto}
                                />
                                {!preview ? (
                                    <div style={{color:'#64748b'}}>
                                        <FaCamera size={24} style={{marginBottom:'5px'}}/>
                                        <div style={{fontSize:'0.85rem'}}>Click para tomar foto</div>
                                    </div>
                                ) : (
                                    <div style={{position:'relative'}}>
                                        <img src={preview} alt="Evidencia" style={{maxHeight:'150px', borderRadius:'4px'}} />
                                        <div style={{fontSize:'0.8rem', color:'#10b981', marginTop:'5px'}}>Imagen cargada</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose}>Cancelar</button>
                        <button type="submit" className="btn-primary-modal" disabled={loading}>
                            {loading ? <><FaSync className="spin"/> Guardando...</> : <><FaSave/> Guardar Registro</>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalRegistrarAgua;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalResetPassword.jsx
==================================================================
import { useState } from 'react';
import Swal from 'sweetalert2'; // <--- IMPORTADO
import { resetUserPassword } from '../../services/userService';
import '../../styles/Modal.css';
import { FaTimes, FaKey, FaExclamationTriangle } from 'react-icons/fa';

const ModalResetPassword = ({ isOpen, onClose, user }) => {
    const [newPassword, setNewPassword] = useState('');
    const [loading, setLoading] = useState(false);

    if (!isOpen || !user) return null;

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (newPassword.length < 6) {
            return Swal.fire({
                icon: 'warning',
                title: 'Contrase√±a insegura',
                text: 'La contrase√±a debe tener al menos 6 caracteres.',
                confirmButtonColor: '#f59e0b'
            });
        }

        setLoading(true);
        try {
            await resetUserPassword(user.ID_Usuario, newPassword);
            
            await Swal.fire({
                icon: 'success',
                title: 'Contrase√±a Restablecida',
                text: `La contrase√±a para ${user.Nombre_Completo} ha sido actualizada correctamente.`,
                confirmButtonColor: '#0c4760',
                timer: 2500
            });

            setNewPassword('');
            onClose();
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                confirmButtonColor: '#d33'
            });
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '450px' }}>
                
                <div className="modal-header">
                    <h2 style={{ color: '#d97706', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <FaExclamationTriangle /> Restablecer Clave
                    </h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="modal-body">
                        
                        <div style={{ 
                            background: '#fffbeb', 
                            border: '1px solid #fcd34d', 
                            padding: '1rem', 
                            borderRadius: '8px',
                            marginBottom: '1rem',
                            color: '#92400e',
                            fontSize: '0.9rem'
                        }}>
                            <strong>Atenci√≥n:</strong> Est√°s a punto de cambiar la contrase√±a de acceso para el usuario:
                            <div style={{ marginTop: '5px', fontSize: '1rem', fontWeight: 'bold' }}>
                                {user.Nombre_Completo}
                            </div>
                        </div>
                    
                        <div className="form-group">
                            <label><FaKey /> Nueva Contrase√±a</label>
                            <input 
                                type="password" 
                                required 
                                minLength="6"
                                placeholder="Ingrese la nueva clave (min 6 chars)"
                                value={newPassword} 
                                onChange={e => setNewPassword(e.target.value)} 
                                autoFocus
                            />
                        </div>
                    </div>

                    <div className="modal-footer">
                        <button type="button" className="btn-secondary" onClick={onClose} disabled={loading}>
                            Cancelar
                        </button>
                        <button 
                            type="submit" 
                            className="btn-primary-modal" 
                            style={{ backgroundColor: '#d97706' }} // Naranja de advertencia
                            disabled={loading}
                        >
                            {loading ? 'Actualizando...' : 'Cambiar Contrase√±a'}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

export default ModalResetPassword;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerACPM.jsx
==================================================================
import React from 'react';
import '../../styles/Modal.css';
import { 
    FaTimes, FaExternalLinkAlt, FaFileDownload, FaCalendarAlt, 
    FaUser, FaMapMarkerAlt, FaClipboardList, FaBullseye, FaCamera, FaTimesCircle 
} from 'react-icons/fa';
import { apiFetchBlob, extractFilename } from '../../services/api';

const ModalVerACPM = ({ isOpen, onClose, acpm }) => {
    if (!isOpen || !acpm) return null;

    // --- 1. DETECCI√ìN ROBUSTA DE LA URL DE EVIDENCIA ---
    // Buscamos en las dos posibles propiedades que devuelve el backend
    const urlEvidenciaReal = acpm.Url_Evidencia_Cierre || acpm.Url_Evidencia || null;

    // --- FUNCI√ìN SEGURA PARA ABRIR EVIDENCIA ---
    const handleVerEvidencia = async () => {
        if (!urlEvidenciaReal) return;
        
        try {
            const filename = extractFilename(urlEvidenciaReal);
            // Intentamos descargarla de forma segura
            const blob = await apiFetchBlob(`/acpm/evidencia/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al cargar evidencia:", error);
            // Fallback: Si falla el blob (ej: es un link externo de Drive), intentamos abrirlo directo
            if (urlEvidenciaReal.startsWith('http')) {
                window.open(urlEvidenciaReal, '_blank');
            } else {
                alert("No se pudo cargar el archivo adjunto.");
            }
        }
    };

    // --- 2. BADGE DE ESTADO MEJORADO ---
    const getStatusBadge = (estado) => {
        if (!estado) return <span className="badge">Desconocido</span>;

        // Normalizamos a min√∫sculas para comparar
        const estadoNorm = estado.toLowerCase().trim();

        let styles = { bg: '#f3f4f6', color: '#4b5563', border: '#e5e7eb' }; // Default (Gris)

        if (estadoNorm === 'abierta') {
            styles = { bg: '#fff7ed', color: '#c2410c', border: '#fdba74' }; // Naranja
        } else if (estadoNorm === 'en progreso') {
            styles = { bg: '#eff6ff', color: '#1d4ed8', border: '#bfdbfe' }; // Azul
        } else if (estadoNorm === 'cerrada' || estadoNorm === 'realizada') {
            styles = { bg: '#f0fdf4', color: '#15803d', border: '#86efac' }; // Verde
        } else if (estadoNorm === 'cancelada') {
            styles = { bg: '#fef2f2', color: '#991b1b', border: '#fecaca' }; // Rojo
        }

        return (
            <span style={{
                backgroundColor: styles.bg, 
                color: styles.color, 
                border: `1px solid ${styles.border}`,
                padding: '0.2rem 0.8rem', 
                borderRadius: '12px', 
                fontSize: '0.85rem', 
                fontWeight: 'bold',
                textTransform: 'capitalize'
            }}>
                {estado}
            </span>
        );
    };

    const readOnlyInputStyle = {
        width: '100%',
        padding: '0.8rem',
        backgroundColor: '#f8fafc',
        border: '1px solid #e2e8f0',
        borderRadius: '8px',
        color: '#334155',
        fontSize: '0.95rem',
        marginTop: '0.4rem',
        whiteSpace: 'pre-wrap', 
        lineHeight: '1.5'
    };

    const labelStyle = {
        fontSize: '0.8rem',
        fontWeight: '700',
        color: '#64748b',
        marginBottom: '2px',
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
        display: 'flex', 
        alignItems: 'center', 
        gap: '6px'
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '800px', maxHeight: '95vh', display: 'flex', flexDirection: 'column' }}>
                
                {/* CABECERA */}
                <div className="modal-header" style={{ borderBottom: '1px solid #f1f5f9', backgroundColor:'#fff' }}>
                    <div style={{display:'flex', flexDirection:'column'}}>
                        <h2 style={{ fontSize: '1.3rem', color: '#0f172a', margin:0 }}>
                            Plan de Acci√≥n #{acpm.ID_ACPM}
                        </h2>
                        <span style={{fontSize:'0.85rem', color:'#64748b'}}>Detalle completo del hallazgo y seguimiento</span>
                    </div>
                    <button className="modal-close-button" onClick={onClose}><FaTimes /></button>
                </div>

                {/* CUERPO */}
                <div className="modal-body" style={{ padding: '2rem', overflowY: 'auto', backgroundColor: '#ffffff' }}>
                    
                    {/* SECCI√ìN 1: DATOS GENERALES */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
                        <div>
                            <div style={labelStyle}><FaBullseye style={{color:'#f59e0b'}}/> Tipo de Acci√≥n</div>
                            <div style={{fontWeight:'600', color:'#1e293b', fontSize:'1rem', marginTop:'5px'}}>
                                {acpm.Tipo_Accion}
                            </div>
                        </div>
                        <div>
                            <div style={labelStyle}><FaClipboardList style={{color:'#0ea5e9'}}/> Fuente / Origen</div>
                            <div style={{fontWeight:'600', color:'#0c4760', fontSize:'1rem', marginTop:'5px'}}>
                                {acpm.Origen_Plan || 'No especificado'}
                            </div>
                        </div>
                        <div>
                            <div style={labelStyle}><FaMapMarkerAlt style={{color:'#ef4444'}}/> Ubicaci√≥n Hallazgo</div>
                            <div style={{fontSize:'0.95rem', color:'#475569', marginTop:'5px'}}>
                                {acpm.Origen}
                            </div>
                        </div>
                        <div>
                            <div style={labelStyle}>Estado Actual</div>
                            <div style={{ marginTop: '5px' }}>{getStatusBadge(acpm.Estado)}</div>
                        </div>
                    </div>

                    <hr style={{border:'0', borderTop:'1px solid #f1f5f9', margin:'0 0 1.5rem 0'}} />

                    {/* SECCI√ìN 2: DETALLES */}
                    <div style={{ marginBottom: '1.5rem' }}>
                        <div style={labelStyle}>Descripci√≥n del Problema / Hallazgo</div>
                        <div style={readOnlyInputStyle}>{acpm.Descripcion}</div>
                    </div>

                    <div style={{ marginBottom: '1.5rem' }}>
                        <div style={labelStyle}>An√°lisis de Causa Ra√≠z</div>
                        <div style={readOnlyInputStyle}>
                            {acpm.Analisis_Causa || <span style={{color:'#9ca3af', fontStyle:'italic'}}>No registrado</span>}
                        </div>
                    </div>

                    <div style={{ marginBottom: '2rem' }}>
                        <div style={labelStyle}>Plan de Acci√≥n (Actividades a Ejecutar)</div>
                        <div style={{...readOnlyInputStyle, backgroundColor:'#f0f9ff', borderColor:'#bae6fd', color:'#0369a1'}}>
                            {acpm.Plan_Accion || <span style={{color:'#9ca3af', fontStyle:'italic'}}>No registrado</span>}
                        </div>
                    </div>

                    {/* SECCI√ìN 3: SEGUIMIENTO Y CIERRE */}
                    <div style={{ backgroundColor:'#f8fafc', padding:'1.5rem', borderRadius:'12px', border:'1px solid #e2e8f0' }}>
                        <h4 style={{marginTop:0, marginBottom:'1rem', color:'#0c4760', fontSize:'0.9rem', textTransform:'uppercase', letterSpacing:'0.5px'}}>Seguimiento y Cierre</h4>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '1.5rem', marginBottom: '1.5rem' }}>
                            <div>
                                <div style={labelStyle}>Responsable</div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop:'5px', color:'#334155', fontWeight:'600' }}>
                                    <div style={{width:'28px', height:'28px', borderRadius:'50%', background:'#e2e8f0', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                        <FaUser size={12} style={{color:'#64748b'}} />
                                    </div>
                                    {acpm.Responsable}
                                </div>
                            </div>
                            <div>
                                <div style={labelStyle}>Fecha L√≠mite</div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginTop:'5px', color:'#b91c1c', fontWeight:'600' }}>
                                    <FaCalendarAlt /> {acpm.Fecha_Limite ? new Date(acpm.Fecha_Limite).toLocaleDateString() : 'N/A'}
                                </div>
                            </div>
                            <div>
                                <div style={labelStyle}>Fecha de Cierre</div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginTop:'5px', color: acpm.Fecha_Cierre ? '#15803d' : '#94a3b8', fontWeight:'600' }}>
                                    <FaCalendarAlt /> 
                                    {acpm.Fecha_Cierre ? new Date(acpm.Fecha_Cierre).toLocaleDateString() : '-- / -- / --'}
                                </div>
                            </div>
                        </div>

                        {/* COMENTARIO DE CIERRE (NUEVO) */}
                        {acpm.Comentario_Cierre && (
                            <div style={{ marginBottom: '1.5rem' }}>
                                <div style={labelStyle}>Comentarios de Gesti√≥n/Cierre</div>
                                <div style={{ ...readOnlyInputStyle, background: '#fff', border: '1px solid #cbd5e1' }}>
                                    {acpm.Comentario_Cierre}
                                </div>
                            </div>
                        )}

                        {/* EVIDENCIA */}
                        <div style={{ borderTop:'1px dashed #cbd5e1', paddingTop:'1rem' }}>
                            <div style={labelStyle}>Evidencia de Cierre:</div>
                            <div style={{ marginTop: '0.5rem' }}>
                                {urlEvidenciaReal ? (
                                    <button 
                                        onClick={handleVerEvidencia} 
                                        className="btn-primary"
                                        style={{ 
                                            textDecoration: 'none', display: 'inline-flex', alignItems: 'center', cursor: 'pointer', border: 'none',
                                            gap: '8px', backgroundColor: '#0c4760', padding: '0.6rem 1.2rem',
                                            borderRadius: '8px', color: 'white', fontSize: '0.9rem', width:'fit-content'
                                        }}
                                    >
                                        <FaFileDownload /> Descargar / Ver Evidencia
                                        <FaExternalLinkAlt size={12} style={{ opacity: 0.7 }}/>
                                    </button>
                                ) : (
                                    <span style={{ color: '#94a3b8', fontStyle: 'italic', fontSize:'0.9rem', display:'flex', alignItems:'center', gap:'5px' }}>
                                        <FaTimesCircle size={14}/> No se han adjuntado evidencias de cierre a√∫n.
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>

                </div>

                <div className="modal-footer" style={{ padding: '1.2rem 2rem', background: '#ffffff', borderTop:'1px solid #f1f5f9' }}>
                    <button className="btn-secondary" onClick={onClose} style={{ marginLeft:'auto' }}>
                        Cerrar Ventana
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerACPM;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerActa.jsx
==================================================================
import { useState, useEffect } from 'react'; // Agregamos useEffect para cargar im√°genes al abrir
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { FaTimes, FaFilePdf, FaBuilding, FaBoxOpen, FaUsers, FaInfoCircle, FaCamera, FaSignature, FaBarcode, FaCalendarAlt, FaCheckCircle } from 'react-icons/fa';
import '../../styles/Modal.css';
import { API_URL, apiFetchBlob, extractFilename } from '../../services/api'; // Importamos las nuevas funciones
import logoImg from '../../assets/logo_eltrece.png';

const ModalVerActa = ({ isOpen, onClose, data }) => {
    const [generating, setGenerating] = useState(false);
    // Estado para guardar las URLs temporales de las im√°genes (blobs)
    const [previewImages, setPreviewImages] = useState({});

    const THEME_COLOR = '#0c4760';

    // --- EFECTO: CARGAR IM√ÅGENES SEGURAS AL ABRIR ---
    useEffect(() => {
        if (isOpen && data) {
            const loadImages = async () => {
                const urls = [data.Url_Foto1, data.Url_Foto2, data.Url_Foto3, data.Url_Foto4].filter(Boolean);
                const newPreviews = {};

                for (const urlBD of urls) {
                    try {
                        const filename = extractFilename(urlBD);
                        // Usamos el endpoint de streaming que creamos en el backend
                        // endpoint: /actas/foto/:nombreArchivo
                        const blob = await apiFetchBlob(`/actas/foto/${filename}`);
                        newPreviews[urlBD] = URL.createObjectURL(blob);
                    } catch (error) {
                        console.error("Error cargando imagen segura:", error);
                    }
                }
                setPreviewImages(newPreviews);
            };
            loadImages();
        }
        
        // Limpieza de memoria al cerrar
        return () => {
            Object.values(previewImages).forEach(url => URL.revokeObjectURL(url));
        };
    }, [isOpen, data]);


    if (!isOpen || !data) return null;

    // --- FUNCI√ìN IM√ÅGENES (ADAPTADA PARA PDF) ---
    // Ahora usa las URLs blob que ya cargamos en el estado
    const getImageData = async (urlBD) => {
        try {
            const blobUrl = previewImages[urlBD];
            if (!blobUrl) return null;

            const response = await fetch(blobUrl);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result); // Devuelve base64 para jsPDF
                reader.readAsDataURL(blob);
            });
        } catch (error) { return null; }
    };

    // --- GENERAR PDF (L√ìGICA INTACTA, SOLO USA LA NUEVA getImageData) ---
    const generatePDF = async () => {
        setGenerating(true);
        const doc = new jsPDF();
        
        // 1. CONFIGURACI√ìN
        const margins = { top: 20, bottom: 20, left: 20, right: 20 };
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const contentWidth = pageWidth - margins.left - margins.right;
        
        let currentY = margins.top;

        // --- 2. ENCABEZADO ---
        const headerHeight = 28; 
        
        doc.setLineWidth(0.5);
        doc.setDrawColor(0); 
        doc.rect(margins.left, currentY, contentWidth, headerHeight);
        
        const logoColWidth = 45;
        const infoColWidth = 40;
        const titleColWidth = contentWidth - logoColWidth - infoColWidth;

        doc.line(margins.left + logoColWidth, currentY, margins.left + logoColWidth, currentY + headerHeight);
        doc.line(margins.left + logoColWidth + titleColWidth, currentY, margins.left + logoColWidth + titleColWidth, currentY + headerHeight);

        // LOGO
        try {
            const imgProps = doc.getImageProperties(logoImg);
            const ratio = imgProps.width / imgProps.height;
            const logoH = 20; 
            const logoW = logoH * ratio;
            doc.addImage(logoImg, 'PNG', margins.left + (logoColWidth - logoW) / 2, currentY + (headerHeight - logoH) / 2, logoW, logoH);
        } catch (e) { }

        // T√çTULOS
        const centerX = margins.left + logoColWidth + (titleColWidth / 2);
        const centerY = currentY + (headerHeight / 2);
        
        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text('EMPAQUETADOS EL TRECE S.A.S', centerX, centerY - 5, { align: 'center' });
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.text('SISTEMA DE GESTI√ìN DE CALIDAD', centerX, centerY, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const titulo = doc.splitTextToSize('ACTA DE DESTRUCCI√ìN DE PRODUCTO NO CONFORME', titleColWidth - 5);
        doc.text(titulo, centerX, centerY + 6, { align: 'center' });

        // INFO DERECHA
        const infoXLabel = margins.left + logoColWidth + titleColWidth + 2;
        const infoXValue = margins.left + contentWidth - 2;
        const rowH = headerHeight / 3;

        doc.line(margins.left + logoColWidth + titleColWidth, currentY + rowH, margins.left + contentWidth, currentY + rowH);
        doc.line(margins.left + logoColWidth + titleColWidth, currentY + (rowH * 2), margins.left + contentWidth, currentY + (rowH * 2));

        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold'); doc.text("C√ìDIGO:", infoXLabel, currentY + 5);
        doc.setFont('helvetica', 'normal'); doc.text(data.Codigo_Formato || "FT-SGC-019", infoXValue, currentY + 5, { align: 'right' });

        doc.setFont('helvetica', 'bold'); doc.text("VERSI√ìN:", infoXLabel, currentY + rowH + 5);
        doc.setFont('helvetica', 'normal'); doc.text("01", infoXValue, currentY + rowH + 5, { align: 'right' });

        doc.setFont('helvetica', 'bold'); doc.text("FECHA:", infoXLabel, currentY + (rowH * 2) + 5);
        doc.setFont('helvetica', 'normal'); doc.text(new Date(data.Fecha).toLocaleDateString(), infoXValue, currentY + (rowH * 2) + 5, { align: 'right' });

        currentY += headerHeight + 10;

        // --- 3. TABLAS DE DATOS ---
        autoTable(doc, {
            startY: currentY,
            head: [['DATOS DE IDENTIFICACI√ìN', '']],
            body: [
                ['N√öMERO DE ACTA:', data.Numero_Acta],
                ['SEDE:', data.Sede],
                ['EMPRESA:', data.Empresa || 'Empaquetados El Trece'],
                ['BODEGA PROCEDENTE:', data.Bodega_Procedente]
            ],
            theme: 'plain', 
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold', lineWidth: 0.3, lineColor: 0 },
            bodyStyles: { textColor: 0, lineColor: 0, lineWidth: 0.3 },
            columnStyles: { 0: { fontStyle: 'bold', width: 60 } },
            margin: { left: margins.left, right: margins.right }
        });

        // TABLA 2: DETALLES
        autoTable(doc, {
            startY: doc.lastAutoTable.finalY + 5,
            head: [['DETALLES DE LA DESTRUCCI√ìN', 'VALORES']],
            body: [
                ['TESTIGOS DE LA DESTRUCCI√ìN', data.Testigos],
                ['PRODUCTO', data.Producto],
                ['CANTIDAD', data.Cantidad],
                ['NOVEDAD / MOTIVO', data.Novedad]
            ],
            theme: 'plain',
            headStyles: { fillColor: 220, textColor: 0, fontStyle: 'bold', lineColor: 0, lineWidth: 0.3, halign: 'center' },
            bodyStyles: { textColor: 0, lineColor: 0, lineWidth: 0.3 },
            columnStyles: { 0: { fontStyle: 'bold', width: 80 } },
            margin: { left: margins.left, right: margins.right }
        });

        currentY = doc.lastAutoTable.finalY + 8; // Espacio despu√©s de la tabla

        // ==========================================
        //  MENSAJE SAAVE
        // ==========================================
        if (data.Aplica_Saave) {
            const textoSaave = data.Nota_Saave || "SAAVE 1370 Doc realizado por operaciones en sofsin";
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);
            
            doc.text("NOTA OFICIAL:", margins.left, currentY);
            
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50);
            const splitSaave = doc.splitTextToSize(textoSaave, contentWidth - 30);
            doc.text(splitSaave, margins.left + 30, currentY);
            
            currentY += (splitSaave.length * 4) + 10;
            doc.setTextColor(0);
        } else {
            currentY += 5;
        }

        // --- 4. TEXTO LEGAL ---
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bolditalic');
        const legalText = "Declaraci√≥n: Encontr√°ndose este producto en condiciones no aptas para el proceso e igualmente no apto para consumo humano.";
        const splitText = doc.splitTextToSize(legalText, contentWidth);
        doc.text(splitText, margins.left, currentY);
        
        currentY += (splitText.length * 5) + 10;

        // --- 5. FOTOS ---
        if (currentY + 60 > pageHeight - margins.bottom) { doc.addPage(); currentY = margins.top; }

        doc.setFont('helvetica', 'bold');
        doc.text('REGISTRO FOTOGR√ÅFICO:', margins.left, currentY);
        currentY += 5;

        // Usamos las fotos de la DB para iterar
        const photoUrlsBD = [data.Url_Foto1, data.Url_Foto2, data.Url_Foto3, data.Url_Foto4].filter(Boolean);
        
        let xPos = margins.left;
        const gap = 5;
        const photoSize = (contentWidth - (gap * 3)) / 4;

        // Iteramos 4 veces para mantener el layout
        for(let i = 0; i < 4; i++) {
            doc.setDrawColor(0);
            doc.rect(xPos, currentY, photoSize, photoSize); 
            
            // Si existe URL en BD
            if (photoUrlsBD[i]) {
                try {
                    // Llamamos a getImageData pasando la URL de BD
                    const base64Img = await getImageData(photoUrlsBD[i]);
                    if (base64Img) {
                        doc.addImage(base64Img, 'JPEG', xPos + 1, currentY + 1, photoSize - 2, photoSize - 2);
                    }
                } catch (err) {
                    console.error("Error al poner imagen en PDF", err);
                }
            } else {
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`FOTO ${i+1}`, xPos + 5, currentY + (photoSize/2));
            }
            xPos += photoSize + gap;
        }
        currentY += photoSize + 20;

        // --- 6. FIRMAS ---
        if (currentY + 30 > pageHeight - margins.bottom) { doc.addPage(); currentY = margins.top + 20; }

        doc.setLineWidth(0.5);
        doc.setDrawColor(0);

        const firmaWidth = contentWidth * 0.4;
        const f1Start = margins.left + 10;
        const f1End = f1Start + firmaWidth;
        doc.line(f1Start, currentY, f1End, currentY); 
        
        const f2End = pageWidth - margins.right - 10;
        const f2Start = f2End - firmaWidth;
        doc.line(f2Start, currentY, f2End, currentY); 
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text('FIRMA ENCARGADO DE LA DEVOLUCI√ìN', f1Start + (firmaWidth/2), currentY + 5, { align: 'center' });
        doc.text('FIRMA LIDER DE CALIDAD', f2Start + (firmaWidth/2), currentY + 5, { align: 'center' });

        // --- 7. PIE DE P√ÅGINA ---
        currentY += 20;
        autoTable(doc, {
            startY: currentY,
            head: [['ELABORADO POR', 'REVISADO POR', 'APROBADO POR']],
            body: [[data.Elaborado_Por || '', data.Revisado_Por || '', data.Aprobado_Por || '']],
            theme: 'plain',
            headStyles: { fillColor: 240, textColor: 0, fontSize: 8, halign: 'center', lineColor: 0, lineWidth: 0.3, fontStyle: 'bold' },
            bodyStyles: { textColor: 0, fontSize: 8, halign: 'center', minCellHeight: 10, lineColor: 0, lineWidth: 0.3 },
            margin: { left: margins.left, right: margins.right }
        });

        setGenerating(false);
        window.open(URL.createObjectURL(doc.output('blob')), '_blank');
    };

    // COMPONENTES UI
    const DetailRow = ({ icon, label, value }) => (
        <div style={{display:'flex', alignItems:'flex-start', marginBottom:'12px', gap:'12px'}}>
            <div style={{color: THEME_COLOR, marginTop:'3px', flexShrink:0}}>{icon}</div>
            <div style={{flex:1}}>
                <span style={{display:'block', fontSize:'0.75rem', color:'#64748b', fontWeight:'600', textTransform:'uppercase'}}>{label}</span>
                <span style={{display:'block', fontSize:'0.95rem', color:'#1e293b', fontWeight:'500'}}>{value || 'N/A'}</span>
            </div>
        </div>
    );

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '850px', borderRadius: '12px', padding: 0, overflow:'hidden', boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)'}}>
                
                {/* HEADER */}
                <div className="modal-header" style={{background: 'white', borderBottom: '1px solid #e2e8f0', padding: '1.5rem'}}>
                    <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                        <div style={{background:'#f0f9ff', padding:'12px', borderRadius:'10px', color: THEME_COLOR}}>
                            <FaFilePdf size={24}/>
                        </div>
                        <div>
                            <h2 style={{margin:0, fontSize: '1.25rem', color:'#1e293b'}}>Acta de Destrucci√≥n #{data.Numero_Acta}</h2>
                            <p style={{margin:0, fontSize:'0.85rem', color:'#64748b'}}>Previsualizaci√≥n de la informaci√≥n oficial.</p>
                        </div>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color:'#94a3b8'}}><FaTimes/></button>
                </div>

                <div className="modal-body" style={{padding: '2rem', maxHeight: '70vh', overflowY: 'auto', background: '#f8fafc'}}>
                    
                    {/* BARRA T√âCNICA */}
                    <div style={{
                        display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))', gap:'15px', 
                        background:'white', padding:'15px', borderRadius:'8px', border:'1px solid #e2e8f0', marginBottom:'20px'
                    }}>
                        <DetailRow icon={<FaBarcode/>} label="C√≥digo" value={data.Codigo_Formato || 'FT-SGC-019'} />
                        <DetailRow icon={<FaInfoCircle/>} label="Versi√≥n" value="01" />
                        <DetailRow icon={<FaCalendarAlt/>} label="Fecha" value={new Date(data.Fecha).toLocaleDateString()} />
                        <DetailRow icon={<FaBuilding/>} label="Sede" value={data.Sede} />
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'2fr 1fr', gap:'20px'}}>
                        
                        {/* IZQUIERDA: DETALLES */}
                        <div>
                            <div style={{background:'white', padding:'20px', borderRadius:'8px', border:'1px solid #e2e8f0', marginBottom:'20px'}}>
                                <h4 style={{marginTop:0, color: THEME_COLOR, borderBottom:'2px solid #f1f5f9', paddingBottom:'10px', marginBottom:'15px'}}>Detalles</h4>
                                <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px'}}>
                                    <DetailRow icon={<FaBoxOpen/>} label="Producto" value={data.Producto} />
                                    <DetailRow icon={<FaInfoCircle/>} label="Cantidad" value={data.Cantidad} />
                                    <DetailRow icon={<FaBuilding/>} label="Bodega" value={data.Bodega_Procedente} />
                                    <DetailRow icon={<FaUsers/>} label="Testigos" value={data.Testigos} />
                                </div>
                                <div style={{marginTop:'15px'}}>
                                    <DetailRow icon={<FaInfoCircle/>} label="Novedad" value={data.Novedad} />
                                </div>
                                <div style={{marginTop:'15px', padding:'10px', background:'#fef2f2', borderRadius:'6px', border:'1px solid #fee2e2', color:'#b91c1c', fontSize:'0.85rem', fontStyle:'italic'}}>
                                    Declaraci√≥n Legal Activa
                                </div>
                            </div>

                            {/* EVIDENCIAS (MODIFICADO PARA USAR previewImages) */}
                            <div style={{background:'white', padding:'20px', borderRadius:'8px', border:'1px solid #e2e8f0'}}>
                                <h4 style={{marginTop:0, color: THEME_COLOR, borderBottom:'2px solid #f1f5f9', paddingBottom:'10px', marginBottom:'15px'}}>Evidencias</h4>
                                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(80px, 1fr))', gap:'10px'}}>
                                    {[data.Url_Foto1, data.Url_Foto2, data.Url_Foto3, data.Url_Foto4].filter(Boolean).map((urlBD, i) => (
                                        <a key={i} href={previewImages[urlBD]} target="_blank" rel="noopener noreferrer" style={{display:'block', width:'100%', aspectRatio:'1/1', border:'1px solid #e2e8f0', borderRadius:'6px', overflow:'hidden', cursor: 'zoom-in'}}>
                                            {/* Usamos la URL temporal (blob) si existe, o un placeholder mientras carga */}
                                            {previewImages[urlBD] ? (
                                                <img src={previewImages[urlBD]} alt={`Evidencia ${i+1}`} style={{width:'100%', height:'100%', objectFit:'cover'}} />
                                            ) : (
                                                <div style={{width:'100%', height:'100%', display:'flex', alignItems:'center', justifyContent:'center', background:'#f1f5f9', color:'#94a3b8', fontSize:'0.7rem'}}>Cargando...</div>
                                            )}
                                        </a>
                                    ))}
                                    {![data.Url_Foto1, data.Url_Foto2, data.Url_Foto3, data.Url_Foto4].some(Boolean) && (
                                        <div style={{gridColumn:'1/-1', textAlign:'center', color:'#94a3b8', fontSize:'0.8rem'}}>Sin fotos</div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* DERECHA: FIRMAS */}
                        <div>
                            <div style={{background:'white', padding:'20px', borderRadius:'8px', border:'1px solid #e2e8f0', height:'100%'}}>
                                <h4 style={{marginTop:0, color: THEME_COLOR, borderBottom:'2px solid #f1f5f9', paddingBottom:'10px', marginBottom:'15px'}}>Responsables</h4>
                                
                                <DetailRow icon={<FaSignature/>} label="Elaborado" value={data.Elaborado_Por} />
                                <DetailRow icon={<FaSignature/>} label="Revisado" value={data.Revisado_Por} />
                                <DetailRow icon={<FaSignature/>} label="Aprobado" value={data.Aprobado_Por} />

                                <div style={{borderTop:'1px dashed #e2e8f0', paddingTop:'15px', marginTop:'20px'}}>
                                    <span style={{display:'block', fontSize:'0.75rem', color:'#64748b', fontWeight:'600', marginBottom:'10px'}}>FIRMAS REQUERIDAS</span>
                                    <div style={{background:'#f8fafc', padding:'10px', borderRadius:'6px', marginBottom:'10px', fontSize:'0.75rem', color:'#475569', textAlign:'center', border:'1px solid #e2e8f0'}}>
                                        ENCARGADO DEVOLUCI√ìN
                                    </div>
                                    <div style={{background:'#f8fafc', padding:'10px', borderRadius:'6px', fontSize:'0.75rem', color:'#475569', textAlign:'center', border:'1px solid #e2e8f0', position:'relative'}}>
                                        L√çDER DE CALIDAD
                                        
                                        {data.Aplica_Saave && (
                                            <div style={{marginTop:'8px', paddingTop:'8px', borderTop:'1px dotted #cbd5e1', fontSize:'0.7rem', color:'#1e293b'}}>
                                                <FaCheckCircle style={{color:'#16a34a', marginRight:'4px', verticalAlign:'middle'}}/> 
                                                <strong>Nota Oficial:</strong><br/>
                                                <span style={{fontStyle:'italic', color:'#475569'}}>
                                                    {data.Nota_Saave || "SAAVE 1370..."}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div className="modal-footer" style={{padding: '1.5rem', background:'white', borderTop:'1px solid #e2e8f0', display:'flex', justifyContent:'flex-end', gap:'10px'}}>
                    <button type="button" className="btn-secondary" onClick={onClose}>Cerrar</button>
                    <button type="button" onClick={generatePDF} disabled={generating} className="btn-primary" style={{backgroundColor: THEME_COLOR, padding:'10px 25px', display:'flex', alignItems:'center', gap:'8px'}}>
                        <FaFilePdf /> {generating ? 'Generando...' : 'Generar PDF Oficial'}
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerActa;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerAuditoria.jsx
==================================================================
import React from 'react';
import '../../styles/Modal.css';
import { 
    FaTimes, FaExternalLinkAlt, FaFileDownload, FaCalendarAlt, 
    FaUserTie, FaBuilding, FaClipboardList, FaInfoCircle, FaUserEdit, FaTimesCircle
} from 'react-icons/fa';
// Importamos las utilidades de seguridad para evitar errores en Hostinger
import { apiFetchBlob, extractFilename } from '../../services/api';

const ModalVerAuditoria = ({ isOpen, onClose, auditoria }) => {
    if (!isOpen || !auditoria) return null;

    // --- FUNCI√ìN SEGURA PARA DESCARGAR EVIDENCIA ---
    const handleDownloadEvidence = async () => {
        if (!auditoria.Url_Evidencia) return;
        
        try {
            const filename = extractFilename(auditoria.Url_Evidencia);
            // Llamamos a la ruta segura que configuramos en el backend
            const blob = await apiFetchBlob(`/auditorias/evidencia/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error descargando evidencia:", error);
            
            // Fallback: Si es un link externo (ej: Google Drive), intentamos abrirlo directo
            if (auditoria.Url_Evidencia.startsWith('http')) {
                window.open(auditoria.Url_Evidencia, '_blank');
            } else {
                alert("No se pudo descargar el archivo adjunto. Verifique su conexi√≥n.");
            }
        }
    };

    const labelStyle = {
        fontSize: '0.8rem',
        fontWeight: '700',
        color: '#64748b',
        marginBottom: '4px',
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
        display: 'flex', 
        alignItems: 'center', 
        gap: '6px'
    };

    const valueStyle = {
        color: '#1e293b',
        fontWeight: '500',
        fontSize: '0.95rem'
    };

    const cardStyle = {
        backgroundColor: '#f8fafc',
        padding: '1.2rem',
        borderRadius: '8px',
        border: '1px solid #e2e8f0',
        marginBottom: '1rem'
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '750px', maxHeight: '95vh', display: 'flex', flexDirection: 'column' }}>
                
                {/* CABECERA */}
                <div className="modal-header" style={{ borderBottom: '1px solid #f1f5f9', backgroundColor: '#fff' }}>
                    <div style={{display:'flex', flexDirection:'column'}}>
                        <h2 style={{ fontSize: '1.3rem', color: '#0f172a', margin:0 }}>
                            Detalle de Auditor√≠a #{auditoria.ID_Auditoria}
                        </h2>
                        <span style={{fontSize:'0.85rem', color:'#64748b'}}>
                            {auditoria.Tipo === 'Interna' ? 'Auditor√≠a Interna de Calidad' : 'Auditor√≠a Externa / Certificaci√≥n'}
                        </span>
                    </div>
                    <button className="modal-close-button" onClick={onClose}><FaTimes /></button>
                </div>

                {/* CUERPO */}
                <div className="modal-body" style={{ padding: '2rem', overflowY: 'auto', backgroundColor: '#ffffff' }}>
                    
                    {/* INFO PRINCIPAL */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
                        <div>
                            <div style={labelStyle}><FaCalendarAlt style={{color:'#0ea5e9'}}/> Fecha de Registro</div>
                            <div style={valueStyle}>
                                {new Date(auditoria.Fecha_Registro).toLocaleDateString('es-CO', { 
                                    year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                })}
                            </div>
                        </div>
                        <div>
                            <div style={labelStyle}><FaUserEdit style={{color:'#f59e0b'}}/> Registrado Por</div>
                            <div style={valueStyle}>
                                {auditoria.Usuario_Registra || 'Sistema'}
                            </div>
                        </div>
                    </div>

                    <hr style={{border:'0', borderTop:'1px solid #f1f5f9', margin:'0 0 1.5rem 0'}} />

                    {/* DETALLES DE LA AUDITOR√çA */}
                    <div style={cardStyle}>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                            <div>
                                <div style={labelStyle}><FaUserTie style={{color:'#64748b'}}/> Auditor / Entidad</div>
                                <div style={{...valueStyle, fontSize:'1.1rem', color:'#0c4760', fontWeight:'700'}}>
                                    {auditoria.Auditor}
                                </div>
                            </div>
                            <div>
                                <div style={labelStyle}><FaBuilding style={{color:'#64748b'}}/> √Årea Auditada</div>
                                <div style={{...valueStyle, fontSize:'1.1rem', color:'#0c4760', fontWeight:'700'}}>
                                    {auditoria.Area_Auditada}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style={{ marginBottom: '1.5rem' }}>
                        <div style={labelStyle}><FaClipboardList style={{color:'#8b5cf6'}}/> Normas / Criterios Evaluados</div>
                        <div style={{ 
                            marginTop: '5px', padding: '10px', background: '#f0fdf4', 
                            border: '1px solid #bbf7d0', borderRadius: '6px', color: '#166534' 
                        }}>
                            {auditoria.Normas || 'No se especificaron normas.'}
                        </div>
                    </div>

                    <div style={{ marginBottom: '1.5rem' }}>
                        <div style={labelStyle}><FaInfoCircle style={{color:'#3b82f6'}}/> Observaciones / Hallazgos</div>
                        <div style={{ 
                            marginTop: '5px', padding: '15px', background: '#fff', 
                            border: '1px solid #cbd5e1', borderRadius: '6px', 
                            whiteSpace: 'pre-wrap', color: '#334155', lineHeight: '1.6'
                        }}>
                            {auditoria.Observaciones || 'Sin observaciones registradas.'}
                        </div>
                    </div>

                    {/* EVIDENCIA (MODIFICADO PARA USAR EL BOT√ìN SEGURO) */}
                    <div style={{ borderTop: '1px dashed #cbd5e1', paddingTop: '1.5rem', marginTop: '1.5rem' }}>
                        <div style={labelStyle}>Evidencia Adjunta</div>
                        <div style={{ marginTop: '10px' }}>
                            {auditoria.Url_Evidencia ? (
                                <button 
                                    onClick={handleDownloadEvidence}
                                    style={{ 
                                        textDecoration: 'none', display: 'inline-flex', alignItems: 'center', 
                                        gap: '8px', backgroundColor: '#0c4760', padding: '0.8rem 1.5rem',
                                        borderRadius: '8px', color: 'white', fontSize: '0.9rem', width:'fit-content',
                                        border: 'none', cursor: 'pointer', boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                    }}
                                >
                                    <FaFileDownload /> Descargar / Ver Archivo
                                    <FaExternalLinkAlt size={12} style={{ opacity: 0.7 }}/>
                                </button>
                            ) : (
                                <span style={{ color: '#94a3b8', fontStyle: 'italic', display:'flex', alignItems:'center', gap:'5px' }}>
                                    <FaTimesCircle size={14}/> No se adjunt√≥ evidencia digital.
                                </span>
                            )}
                        </div>
                    </div>

                </div>

                <div className="modal-footer" style={{ padding: '1.2rem 2rem', background: '#ffffff', borderTop:'1px solid #f1f5f9' }}>
                    <button 
                        className="btn-secondary" 
                        onClick={onClose}
                        style={{ marginLeft:'auto' }}
                    >
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerAuditoria;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerDetalleCapacitacion.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getDetalleResultado } from '../../services/capacitacionService';
import '../../styles/Modal.css';
import { FaTimes, FaCheckCircle, FaTimesCircle, FaUser } from 'react-icons/fa';

const ModalVerDetalleCapacitacion = ({ isOpen, onClose, resultado }) => {
    const [detalles, setDetalles] = useState([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (isOpen && resultado) {
            cargarDetalle();
        }
    }, [isOpen, resultado]);

    const cargarDetalle = async () => {
        setLoading(true);
        try {
            const data = await getDetalleResultado(resultado.ID_Resultado);
            setDetalles(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen || !resultado) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '90vh'}}>
                <div className="modal-header">
                    <h2>Detalle de Respuestas</h2>
                    <button className="modal-close-button" onClick={onClose}><FaTimes /></button>
                </div>

                <div className="modal-body" style={{background: '#f8fafc'}}>
                    
                    {/* CABECERA USUARIO */}
                    <div style={{
                        background: 'white', padding: '1rem', borderRadius: '8px', 
                        border: '1px solid #e2e8f0', marginBottom: '1rem',
                        display: 'flex', justifyContent: 'space-between', alignItems: 'center'
                    }}>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <div style={{width:'40px', height:'40px', background:'#e0f2fe', borderRadius:'50%', display:'flex', alignItems:'center', justifyContent:'center', color:'#0369a1'}}>
                                <FaUser />
                            </div>
                            <div>
                                <h4 style={{margin:0, color:'#0f172a'}}>{resultado.Nombre_Evaluado}</h4>
                                
                                {/* FECHA CORREGIDA CON UTC */}
                                <span style={{fontSize:'0.85rem', color:'#64748b'}}>
                                    {new Date(resultado.Fecha_Ejecucion).toLocaleString('es-CO', { timeZone: 'UTC' })}
                                </span>
                            </div>
                        </div>
                        <div style={{textAlign:'right'}}>
                            <div style={{fontSize:'0.8rem', color:'#64748b'}}>Calificaci√≥n</div>
                            <div style={{fontSize:'1.5rem', fontWeight:'bold', color: resultado.Calificacion >= 4 ? '#16a34a' : '#dc2626'}}>
                                {resultado.Calificacion}
                            </div>
                        </div>
                    </div>

                    {/* LISTA DE PREGUNTAS */}
                    <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                        {loading ? <p style={{textAlign:'center', color:'#999'}}>Cargando respuestas...</p> : 
                         detalles.length === 0 ? <p style={{textAlign:'center', color:'#94a3b8'}}>No se encontraron detalles para este examen.</p> :
                         detalles.map((item, idx) => (
                            <div key={idx} style={{
                                background: 'white', padding: '1rem', borderRadius: '8px',
                                borderLeft: `4px solid ${item.Fue_Correcta ? '#16a34a' : '#dc2626'}`,
                                boxShadow: '0 1px 3px rgba(0,0,0,0.05)'
                            }}>
                                <div style={{fontWeight:'600', marginBottom:'0.5rem', color:'#334155'}}>
                                    {idx + 1}. {item.Texto_Pregunta}
                                </div>
                                
                                <div style={{fontSize:'0.9rem'}}>
                                    <div style={{display:'flex', alignItems:'center', gap:'5px', marginBottom:'4px'}}>
                                        <span style={{fontWeight:'bold', color:'#64748b'}}>Respuesta Usuario:</span>
                                        <span style={{color: item.Fue_Correcta ? '#16a34a' : '#dc2626', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px'}}>
                                            {item.Respuesta_Usuario} 
                                            {item.Fue_Correcta ? <FaCheckCircle/> : <FaTimesCircle/>}
                                        </span>
                                    </div>

                                    {!item.Fue_Correcta && (
                                        <div style={{display:'flex', alignItems:'center', gap:'5px', background:'#f0fdf4', padding:'4px 8px', borderRadius:'4px', width:'fit-content', marginTop:'5px'}}>
                                            <span style={{fontWeight:'bold', color:'#166534', fontSize:'0.85rem'}}>Correcta:</span>
                                            <span style={{color:'#166534', fontSize:'0.85rem'}}>
                                                {item.Respuesta_Correcta_Texto}
                                            </span>
                                        </div>
                                    )}
                                </div>
                            </div>
                         ))}
                    </div>
                </div>

                <div className="modal-footer">
                    <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerDetalleCapacitacion;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerEvaluacionProveedor.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getEvaluacionById } from '../../services/proveedoresService';
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import { 
    FaTimes, FaBuilding, FaCheckCircle, FaTimesCircle, FaFilePdf, FaExclamationTriangle
} from 'react-icons/fa';
import '../../styles/Modal.css';

// --- IMPORTANTE: Aseg√∫rate de importar el logo ---
import logoImg from '../../assets/logo_eltrece.png'; 

const ModalVerEvaluacionProveedor = ({ isOpen, onClose, idEvaluacion }) => {
    const [data, setData] = useState(null);
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(true);

    // Colores corporativos
    const CORPORATE_BLUE = [12, 71, 96]; 
    const COLOR_HEX = '#0c4760';

    useEffect(() => {
        if (isOpen && idEvaluacion) {
            fetchData();
        } else {
            // Limpiar estados al cerrar
            setData(null);
            setItems([]);
            setLoading(true);
        }
    }, [isOpen, idEvaluacion]);

    const fetchData = async () => {
        setLoading(true);
        try {
            const result = await getEvaluacionById(idEvaluacion);
            if (result && result.datos) {
                setData(result.datos);
                setItems(result.items || []);
            } else {
                setData(null);
            }
        } catch (error) {
            console.error("Error al cargar evaluaci√≥n:", error);
            setData(null);
        } finally {
            setLoading(false);
        }
    };

    const stats = () => {
        if (!items.length) return { cumple: 0, noCumple: 0, na: 0 };
        const cumple = items.filter(i => i.Calificacion === 2 && !i.Es_NA).length;
        const noCumple = items.filter(i => i.Calificacion === 0 && !i.Es_NA).length;
        const na = items.filter(i => i.Es_NA).length;
        return { cumple, noCumple, na };
    };
    const estadisticas = stats();

    // --- GENERAR PDF ---
    const handleViewPDF = () => {
        if (!data) return; // Protecci√≥n contra click sin datos

        const doc = new jsPDF();
        const runAutoTable = autoTable.default || autoTable;

        const marginLeft = 15;
        const startY = 10;
        const headerHeight = 28;
        const pageWidth = doc.internal.pageSize.width;
        const contentWidth = pageWidth - (marginLeft * 2);

        // 1. ENCABEZADO
        doc.setLineWidth(0.3);
        doc.setDrawColor(0);
        doc.setFillColor(255, 255, 255);
        doc.rect(marginLeft, startY, contentWidth, headerHeight);

        const logoColWidth = 45;
        const infoColWidth = 40;
        const titleColWidth = contentWidth - logoColWidth - infoColWidth;

        doc.line(marginLeft + logoColWidth, startY, marginLeft + logoColWidth, startY + headerHeight);
        doc.line(marginLeft + logoColWidth + titleColWidth, startY, marginLeft + logoColWidth + titleColWidth, startY + headerHeight);

        // LOGO
        try {
            const imgProps = doc.getImageProperties(logoImg);
            const maxLogoW = 35;
            const maxLogoH = 22;
            let finalW = imgProps.width;
            let finalH = imgProps.height;
            const ratio = finalW / finalH;
            if (finalW > maxLogoW) { finalW = maxLogoW; finalH = finalW / ratio; }
            if (finalH > maxLogoH) { finalH = maxLogoH; finalW = finalH * ratio; }
            doc.addImage(logoImg, 'PNG', marginLeft + (logoColWidth - finalW) / 2, startY + (headerHeight - finalH) / 2, finalW, finalH);
        } catch (e) { }

        // TEXTOS
        const centerX = marginLeft + logoColWidth + (titleColWidth / 2);
        const centerY = startY + (headerHeight / 2);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.text("EMPAQUETADOS EL TRECE S.A.S", centerX, centerY - 6, { align: 'center' });
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.text("SISTEMA DE GESTI√ìN DE CALIDAD", centerX, centerY, { align: 'center' });
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text("EVALUACI√ìN DE PROVEEDORES", centerX, centerY + 7, { align: 'center' });

        // INFO DERECHA
        const infoXLabel = marginLeft + logoColWidth + titleColWidth + 2;
        const infoXValue = marginLeft + contentWidth - 2;
        const rowH = headerHeight / 3;
        doc.line(marginLeft + logoColWidth + titleColWidth, startY + rowH, marginLeft + contentWidth, startY + rowH);
        doc.line(marginLeft + logoColWidth + titleColWidth, startY + (rowH * 2), marginLeft + contentWidth, startY + (rowH * 2));

        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold'); doc.text("C√ìDIGO:", infoXLabel, startY + 5);
        doc.setFont('helvetica', 'normal'); doc.text("FTO-COM-01", infoXValue, startY + 5, { align: 'right' });
        doc.setFont('helvetica', 'bold'); doc.text("VERSI√ìN:", infoXLabel, startY + rowH + 5);
        doc.setFont('helvetica', 'normal'); doc.text("01", infoXValue, startY + rowH + 5, { align: 'right' });
        doc.setFont('helvetica', 'bold'); doc.text("FECHA:", infoXLabel, startY + (rowH * 2) + 5);
        
        // Validar fecha antes de imprimir en PDF
        const fechaImpresion = data.Fecha_Registro ? new Date(data.Fecha_Registro).toLocaleDateString() : 'N/A';
        doc.setFont('helvetica', 'normal'); doc.text(fechaImpresion, infoXValue, startY + (rowH * 2) + 5, { align: 'right' });

        // 2. CONTENIDO
        let currentY = startY + headerHeight + 10;
        doc.setTextColor(0);
        doc.setFontSize(10);
        
        doc.setFont("helvetica", "bold"); doc.text("Empresa:", marginLeft, currentY);
        doc.setFont("helvetica", "normal"); doc.text(data.Empresa || '', marginLeft + 25, currentY);
        doc.setFont("helvetica", "bold"); doc.text("Fecha Auditor√≠a:", 120, currentY);
        doc.setFont("helvetica", "normal"); doc.text(fechaImpresion, 155, currentY);
        
        currentY += 6;
        doc.setFont("helvetica", "bold"); doc.text("Producto:", marginLeft, currentY);
        doc.setFont("helvetica", "normal"); doc.text(data.Producto_Provee || 'N/A', marginLeft + 25, currentY);
        doc.setFont("helvetica", "bold"); doc.text("Ciudad:", 120, currentY);
        doc.setFont("helvetica", "normal"); doc.text(data.Ciudad || 'N/A', 155, currentY);

        currentY += 6;
        doc.setFont("helvetica", "bold"); doc.text("Reg. Sanitario:", marginLeft, currentY);
        doc.setFont("helvetica", "normal"); doc.text(data.Registro_Sanitario || 'N/A', marginLeft + 25, currentY);

        currentY += 10;
        doc.setDrawColor(200); doc.line(marginLeft, currentY, pageWidth - marginLeft, currentY); currentY += 10;

        doc.setFontSize(11); doc.setFont("helvetica", "bold"); doc.setTextColor(...CORPORATE_BLUE);
        doc.text("RESULTADO DE LA EVALUACI√ìN", marginLeft, currentY);
        
        const colorConcepto = data.Concepto_Final === 'FAVORABLE' ? [22, 163, 74] : [220, 38, 38];
        doc.setTextColor(...colorConcepto); doc.setFontSize(12);
        doc.text(`${data.Concepto_Final} (${data.Porcentaje_Final}%)`, 95, currentY);
        
        currentY += 6;
        doc.setTextColor(80); doc.setFontSize(9); doc.setFont("helvetica", "normal");
        doc.text(`Cumple: ${estadisticas.cumple}   |   No Cumple: ${estadisticas.noCumple}   |   N/A: ${estadisticas.na}`, marginLeft, currentY);

        currentY += 8;

        const tableRows = items.map(item => [
            item.Pregunta,
            item.Es_NA ? 'N/A' : (item.Calificacion === 2 ? 'CUMPLE' : 'NO CUMPLE'),
            item.Observacion || ''
        ]);

        runAutoTable(doc, {
            startY: currentY,
            head: [['Criterio de Evaluaci√≥n', 'Estado', 'Observaci√≥n']],
            body: tableRows,
            theme: 'grid',
            headStyles: { fillColor: CORPORATE_BLUE, textColor: 255, fontSize: 9, halign: 'center' },
            styles: { fontSize: 8, cellPadding: 3, textColor: 50 },
            columnStyles: { 0: { cellWidth: 90 }, 1: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }, 2: { cellWidth: 'auto' } },
            didParseCell: (d) => {
                if (d.section === 'body' && d.column.index === 1) {
                    if (d.cell.raw === 'CUMPLE') d.cell.styles.textColor = [22, 163, 74];
                    if (d.cell.raw === 'NO CUMPLE') d.cell.styles.textColor = [220, 38, 38];
                }
            },
            margin: { left: marginLeft, right: marginLeft }
        });

        // OBSERVACIONES
        let finalY = (doc.lastAutoTable ? doc.lastAutoTable.finalY : currentY) + 10;
        if (data.Observaciones_Generales) {
            if (finalY + 30 > 280) { doc.addPage(); finalY = 20; }
            doc.setFillColor(245, 247, 250); doc.rect(marginLeft, finalY, contentWidth, 20, 'F');
            doc.setTextColor(...CORPORATE_BLUE); doc.setFontSize(9); doc.setFont("helvetica", "bold");
            doc.text("Observaciones Generales:", marginLeft + 2, finalY + 5);
            doc.setTextColor(60); doc.setFont("helvetica", "normal");
            const splitObs = doc.splitTextToSize(data.Observaciones_Generales, contentWidth - 4);
            doc.text(splitObs, marginLeft + 2, finalY + 11);
            finalY += (Math.max(splitObs.length * 5, 20)) + 15;
        } else { finalY += 15; }

        // FIRMAS
        if (finalY + 40 > 280) { doc.addPage(); finalY = 40; }
        doc.setDrawColor(150);
        doc.line(marginLeft + 10, finalY + 20, marginLeft + 80, finalY + 20);
        doc.line(marginLeft + 100, finalY + 20, marginLeft + 170, finalY + 20);
        doc.setFontSize(8); doc.setTextColor(100);
        doc.text("Realizado Por (Auditor)", marginLeft + 10, finalY + 25);
        doc.text("Recibido Por (Proveedor)", marginLeft + 100, finalY + 25);
        doc.setFontSize(10); doc.setTextColor(0);
        doc.text(data.Realizado_Por || '', marginLeft + 10, finalY + 15);
        doc.text(data.Recibido_Por || '', marginLeft + 100, finalY + 15);

        window.open(URL.createObjectURL(doc.output('blob')), '_blank');
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{ maxWidth: '900px', height: '90vh', display: 'flex', flexDirection: 'column', padding: 0 }}>
                {/* HEADER */}
                <div className="modal-header" style={{ padding: '15px 25px', background:'#ffffff', borderBottom: '1px solid #e2e8f0' }}>
                    <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                        <div style={{background:'#f1f5f9', padding:'10px', borderRadius:'8px', color: COLOR_HEX}}>
                            <FaBuilding size={22}/>
                        </div>
                        <div>
                            {data ? (
                                <>
                                    <h2 style={{margin:0, fontSize:'1.2rem', color:'#1e293b', fontWeight:'700'}}>{data.Empresa}</h2>
                                    <span style={{color:'#64748b', fontSize:'0.85rem'}}>Auditor√≠a de Calidad</span>
                                </>
                            ) : (
                                <h2 style={{margin:0, fontSize:'1.2rem', color:'#1e293b'}}>Detalle Evaluaci√≥n</h2>
                            )}
                        </div>
                    </div>
                    <div style={{display:'flex', gap:'10px'}}>
                        {data && !loading && (
                            <button onClick={handleViewPDF} className="btn-primary" style={{backgroundColor: COLOR_HEX, display:'flex', alignItems:'center', gap:'8px', fontSize: '0.9rem', padding: '8px 16px'}}>
                                <FaFilePdf /> Ver Reporte
                            </button>
                        )}
                        <button className="modal-close-button" onClick={onClose} style={{color:'#94a3b8'}}><FaTimes /></button>
                    </div>
                </div>

                {/* BODY */}
                <div className="modal-body" style={{ padding: '30px', overflowY: 'auto', flex: 1, background: '#f8fafc' }}>
                    {loading ? (
                        <div style={{textAlign:'center', padding:'50px', color:'#64748b'}}>
                            <div className="spin" style={{fontSize:'2rem', marginBottom:'10px'}}>‚óè</div>
                            <p>Cargando informaci√≥n...</p>
                        </div>
                    ) : !data ? (
                        <div style={{textAlign:'center', padding:'50px', color:'#ef4444'}}>
                            <FaExclamationTriangle size={40} style={{marginBottom:'10px'}}/>
                            <p>No se pudo cargar la informaci√≥n de esta evaluaci√≥n.</p>
                        </div>
                    ) : (
                        <div className="fade-in">
                            {/* Resumen */}
                            <div style={{background:'white', borderRadius:'12px', padding:'25px', boxShadow:'0 4px 6px -1px rgba(0, 0, 0, 0.05)', marginBottom:'25px', border: '1px solid #e2e8f0'}}>
                                <div style={{display:'grid', gridTemplateColumns:'1fr 320px', gap:'40px'}}>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px', alignContent:'start'}}>
                                        {/* AQUI ESTABA EL ERROR: Validamos data antes de acceder */}
                                        <InfoField label="Fecha Auditor√≠a" value={data.Fecha_Registro ? new Date(data.Fecha_Registro).toLocaleDateString() : 'N/A'} />
                                        <InfoField label="Ciudad" value={data.Ciudad} />
                                        <InfoField label="Producto / Servicio" value={data.Producto_Provee} />
                                        <InfoField label="Registro Sanitario" value={data.Registro_Sanitario} />
                                        
                                        <div style={{gridColumn:'span 2', marginTop:'10px'}}>
                                            <label style={{fontWeight:'700', color:'#475569', fontSize:'0.75rem', textTransform:'uppercase'}}>Observaciones Generales</label>
                                            <p style={{margin:'5px 0', padding:'12px', background:'#f8fafc', borderRadius:'6px', fontSize:'0.9rem', border:'1px solid #f1f5f9', color:'#334155'}}>{data.Observaciones_Generales || 'Sin observaciones.'}</p>
                                        </div>
                                    </div>
                                    <div style={{background: data.Concepto_Final === 'FAVORABLE' ? '#f0fdf4' : '#fef2f2', border: `1px solid ${data.Concepto_Final === 'FAVORABLE' ? '#bbf7d0' : '#fecaca'}`, borderRadius:'12px', padding:'25px', textAlign:'center', display:'flex', flexDirection:'column', justifyContent:'center'}}>
                                        <h4 style={{margin:0, color:'#64748b', fontSize:'0.85rem', textTransform:'uppercase', letterSpacing:'0.5px'}}>Concepto Final</h4>
                                        <div style={{fontSize:'1.8rem', fontWeight:'900', color: data.Concepto_Final === 'FAVORABLE' ? '#15803d' : '#991b1b', margin:'10px 0'}}>{data.Concepto_Final}</div>
                                        <div style={{fontSize:'2.2rem', fontWeight:'800', marginBottom:'15px', color:'#1e293b'}}>{data.Porcentaje_Final}%</div>
                                        <div style={{height:'1px', background:'rgba(0,0,0,0.05)', width:'100%', margin:'10px 0'}}></div>
                                        <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.85rem', padding:'0 10px'}}>
                                            <div style={{textAlign:'center'}}><span style={{display:'block', fontWeight:'bold', color:'#15803d', fontSize:'1.1rem'}}>{estadisticas.cumple}</span><span style={{color:'#64748b'}}>Cumple</span></div>
                                            <div style={{textAlign:'center'}}><span style={{display:'block', fontWeight:'bold', color:'#991b1b', fontSize:'1.1rem'}}>{estadisticas.noCumple}</span><span style={{color:'#64748b'}}>Falla</span></div>
                                            <div style={{textAlign:'center'}}><span style={{display:'block', fontWeight:'bold', color:'#94a3b8', fontSize:'1.1rem'}}>{estadisticas.na}</span><span style={{color:'#64748b'}}>N/A</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Detalle */}
                            <div style={{background:'white', borderRadius:'12px', border:'1px solid #e2e8f0', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}}>
                                <div style={{padding:'15px 20px', background:'white', borderBottom:'1px solid #f1f5f9'}}>
                                    <h3 style={{margin:0, fontSize:'1rem', color: COLOR_HEX, fontWeight:'700'}}>Detalle de Verificaci√≥n</h3>
                                </div>
                                <table className="data-table" style={{width:'100%', borderCollapse:'collapse'}}>
                                    <thead>
                                        <tr style={{background:'#f8fafc', borderBottom:'1px solid #e2e8f0'}}>
                                            <th style={{padding:'12px 20px', textAlign:'left', color:'#475569', fontSize:'0.85rem'}}>Criterio Evaluado</th>
                                            <th style={{padding:'12px', textAlign:'center', width:'140px', color:'#475569', fontSize:'0.85rem'}}>Estado</th>
                                            <th style={{padding:'12px 20px', textAlign:'left', color:'#475569', fontSize:'0.85rem'}}>Observaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.map((item, idx) => (
                                            <tr key={idx} style={{borderBottom:'1px solid #f1f5f9'}}>
                                                <td style={{padding:'12px 20px', fontSize:'0.9rem', color:'#334155'}}>{item.Pregunta}</td>
                                                <td style={{textAlign:'center', padding:'12px'}}>
                                                    {item.Es_NA ? <span style={{background:'#f1f5f9', color:'#94a3b8', padding:'4px 10px', borderRadius:'20px', fontSize:'0.75rem', fontWeight:'700'}}>N/A</span> : item.Calificacion === 2 ? <span style={{background:'#dcfce7', color:'#166534', padding:'4px 10px', borderRadius:'20px', fontSize:'0.75rem', fontWeight:'700', display:'inline-flex', alignItems:'center', gap:'4px'}}><FaCheckCircle size={10}/> CUMPLE</span> : <span style={{background:'#fee2e2', color:'#991b1b', padding:'4px 10px', borderRadius:'20px', fontSize:'0.75rem', fontWeight:'700', display:'inline-flex', alignItems:'center', gap:'4px'}}><FaTimesCircle size={10}/> NO CUMPLE</span>}
                                                </td>
                                                <td style={{padding:'12px 20px', fontSize:'0.85rem', color:'#64748b', fontStyle:'italic'}}>{item.Observacion || '-'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'60px', marginTop:'40px', padding:'20px'}}>
                                <div style={{borderTop:'1px solid #cbd5e1', paddingTop:'10px'}}>
                                    <div style={{fontSize:'0.95rem', fontWeight:'700', color:'#1e293b'}}>{data.Realizado_Por}</div>
                                    <div style={{fontSize:'0.8rem', color:'#64748b'}}>Realizado Por (Auditor)</div>
                                </div>
                                <div style={{borderTop:'1px solid #cbd5e1', paddingTop:'10px'}}>
                                    <div style={{fontSize:'0.95rem', fontWeight:'700', color:'#1e293b'}}>{data.Recibido_Por}</div>
                                    <div style={{fontSize:'0.8rem', color:'#64748b'}}>Recibido Por (Proveedor)</div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

const InfoField = ({ label, value }) => (
    <div style={{marginBottom:'5px'}}>
        <label style={{fontSize:'0.7rem', color:'#94a3b8', fontWeight:'700', textTransform:'uppercase', display:'block', marginBottom:'2px'}}>{label}</label>
        <span style={{fontSize:'0.95rem', color:'#334155', fontWeight:'500'}}>{value || 'N/A'}</span>
    </div>
);

export default ModalVerEvaluacionProveedor;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerRecoleccion.jsx
==================================================================
import { useState, useEffect } from 'react';
import { FaTimes, FaFilePdf, FaRecycle, FaWeightHanging, FaCalendarDay, FaBuilding, FaExternalLinkAlt, FaBox, FaImage } from 'react-icons/fa';
// Importamos las utilidades de seguridad
import { apiFetchBlob, extractFilename } from '../../services/api';
import '../../styles/Modal.css';

const ModalVerRecoleccion = ({ isOpen, onClose, data }) => {
    const [secureFileUrl, setSecureFileUrl] = useState(null);
    const [loadingFile, setLoadingFile] = useState(false);
    const ACCENT_COLOR = '#0c4760';

    // Cargar el archivo de forma segura al abrir el modal
    useEffect(() => {
        if (isOpen && data?.Url_Documento) {
            loadFile();
        }
        // Limpieza de memoria
        return () => {
            if (secureFileUrl) URL.revokeObjectURL(secureFileUrl);
        };
    }, [isOpen, data]);

    const loadFile = async () => {
        setLoadingFile(true);
        try {
            const filename = extractFilename(data.Url_Documento);
            // Usamos la ruta de streaming que creamos en pmirRoutes
            const blob = await apiFetchBlob(`/pmir/evidencia/${filename}`);
            
            if (blob.size === 0) throw new Error("Archivo vac√≠o");

            const url = URL.createObjectURL(blob);
            setSecureFileUrl(url);
        } catch (error) {
            console.error("Error cargando evidencia:", error);
            // Fallback si es un link externo antiguo
            if (data.Url_Documento.startsWith('http')) {
                setSecureFileUrl(data.Url_Documento);
            }
        } finally {
            setLoadingFile(false);
        }
    };

    if (!isOpen || !data) return null;

    // Detectar si es imagen
    const isImage = data.Url_Documento && /\.(jpg|jpeg|png|gif|webp)$/i.test(data.Url_Documento);

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '550px', borderRadius:'12px', overflow:'hidden', padding:0, boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'}}>
                
                {/* CABECERA */}
                <div className="modal-header" style={{
                    backgroundColor: 'white', 
                    color: '#1e293b', 
                    borderBottom: '1px solid #e2e8f0',
                    padding: '15px 25px',
                    display: 'flex', justifyContent: 'space-between', alignItems: 'center'
                }}>
                    <div>
                        <span style={{fontSize:'0.75rem', color:'#64748b', textTransform:'uppercase', fontWeight:'bold', letterSpacing:'0.5px'}}>ID RECOLECCI√ìN #{data.ID_Recoleccion}</span>
                        <h2 style={{margin:'5px 0 0 0', fontSize:'1.4rem', color: ACCENT_COLOR, display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaRecycle /> {data.TipoMaterial}
                        </h2>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color:'#94a3b8'}}>
                        <FaTimes/>
                    </button>
                </div>

                <div className="modal-body" style={{padding:'25px', maxHeight:'75vh', overflowY:'auto'}}>
                    
                    {/* DATOS PRINCIPALES */}
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginBottom:'25px'}}>
                        <div style={{background:'#f8fafc', padding:'15px', borderRadius:'10px', border:'1px solid #e2e8f0', textAlign:'center'}}>
                            <FaWeightHanging style={{color: ACCENT_COLOR, fontSize:'1.5rem', marginBottom:'8px', opacity:0.8}} />
                            <div style={{fontSize:'0.7rem', color:'#64748b', fontWeight:'700', letterSpacing:'1px', textTransform:'uppercase'}}>PESO TOTAL</div>
                            <div style={{fontSize:'1.4rem', fontWeight:'800', color:'#0f172a'}}>{data.Peso} <span style={{fontSize:'0.9rem', fontWeight:'600', color:'#64748b'}}>Kg</span></div>
                        </div>
                        <div style={{background:'#f8fafc', padding:'15px', borderRadius:'10px', border:'1px solid #e2e8f0', textAlign:'center'}}>
                            <FaBox style={{color: '#15803d', fontSize:'1.5rem', marginBottom:'8px', opacity:0.8}} />
                            <div style={{fontSize:'0.7rem', color:'#64748b', fontWeight:'700', letterSpacing:'1px', textTransform:'uppercase'}}>CANTIDAD</div>
                            <div style={{fontSize:'1.4rem', fontWeight:'800', color:'#0f172a'}}>{data.Cantidad} <span style={{fontSize:'0.9rem', fontWeight:'600', color:'#64748b'}}>Und</span></div>
                        </div>
                    </div>

                    {/* DETALLES */}
                    <div style={{marginBottom:'25px'}}>
                        <div style={{display:'flex', alignItems:'center', gap:'15px', marginBottom:'15px', borderBottom:'1px solid #f1f5f9', paddingBottom:'10px'}}>
                            <div style={{background:'#eff6ff', padding:'10px', borderRadius:'50%', color:'#3b82f6'}}>
                                <FaCalendarDay size={18} />
                            </div>
                            <div>
                                <span style={{display:'block', fontSize:'0.75rem', color:'#64748b', fontWeight:'600', textTransform:'uppercase'}}>Fecha de Recolecci√≥n</span>
                                <span style={{color:'#334155', fontWeight:'500', fontSize:'0.95rem'}}>
                                    {new Date(data.Fecha).toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}
                                </span>
                            </div>
                        </div>
                        
                        <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                            <div style={{background:'#f0fdf4', padding:'10px', borderRadius:'50%', color:'#16a34a'}}>
                                <FaBuilding size={18} />
                            </div>
                            <div>
                                <span style={{display:'block', fontSize:'0.75rem', color:'#64748b', fontWeight:'600', textTransform:'uppercase'}}>Cliente / Gestor</span>
                                <span style={{color:'#334155', fontWeight:'500', fontSize:'0.95rem'}}>{data.Cliente}</span>
                            </div>
                        </div>
                    </div>

                    {/* EVIDENCIA SEGURA */}
                    <div>
                        <h4 style={{fontSize:'0.85rem', color:'#475569', borderBottom:'2px solid #e2e8f0', paddingBottom:'5px', marginBottom:'15px'}}>SOPORTE DE RECOLECCI√ìN</h4>
                        
                        {data.Url_Documento ? (
                            <div style={{width:'100%'}}>
                                {loadingFile ? (
                                    <div style={{textAlign:'center', padding:'20px', color:'#64748b'}}>Cargando evidencia...</div>
                                ) : secureFileUrl ? (
                                    isImage ? (
                                        // VISTA IMAGEN
                                        <div style={{borderRadius:'8px', overflow:'hidden', border:'1px solid #cbd5e1', boxShadow:'0 4px 6px -1px rgba(0,0,0,0.1)'}}>
                                            <img 
                                                src={secureFileUrl} 
                                                alt="Evidencia" 
                                                style={{width:'100%', maxHeight:'300px', objectFit:'contain', display:'block', background:'#f1f5f9'}} 
                                            />
                                            <div style={{padding:'10px', background:'white', textAlign:'center', borderTop:'1px solid #e2e8f0'}}>
                                                <a href={secureFileUrl} target="_blank" rel="noopener noreferrer" style={{textDecoration:'none', color: ACCENT_COLOR, fontWeight:'600', fontSize:'0.85rem', display:'flex', alignItems:'center', justifyContent:'center', gap:'5px'}}>
                                                    <FaExternalLinkAlt /> Ver en pesta√±a nueva
                                                </a>
                                            </div>
                                        </div>
                                    ) : (
                                        // VISTA PDF/OTRO
                                        <a 
                                            href={secureFileUrl} 
                                            target="_blank" 
                                            rel="noopener noreferrer" 
                                            style={{
                                                display:'flex', alignItems:'center', justifyContent:'center', gap:'10px',
                                                backgroundColor: '#f1f5f9', color:'#334155', padding:'20px', borderRadius:'8px',
                                                textDecoration:'none', fontWeight:'600', transition:'all 0.2s', border:'2px dashed #cbd5e1'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.borderColor = ACCENT_COLOR}
                                            onMouseLeave={(e) => e.currentTarget.style.borderColor = '#cbd5e1'}
                                        >
                                            <FaFilePdf size={24} color="#ef4444"/> 
                                            <span>Ver Documento Adjunto</span>
                                            <FaExternalLinkAlt size={12} style={{marginLeft:'auto', opacity:0.5}}/>
                                        </a>
                                    )
                                ) : (
                                    <div style={{textAlign:'center', padding:'20px', color:'#ef4444', fontSize:'0.9rem'}}>No se pudo cargar el archivo.</div>
                                )}
                            </div>
                        ) : (
                            <div style={{textAlign:'center', padding:'20px', background:'#f8fafc', borderRadius:'8px', color:'#94a3b8', fontSize:'0.9rem', border:'1px dashed #e2e8f0'}}>
                                <FaImage size={24} style={{marginBottom:'5px', opacity:0.3}} />
                                <p style={{margin:0}}>No se adjunt√≥ soporte digital</p>
                            </div>
                        )}
                    </div>
                </div>

                <div className="modal-footer" style={{padding:'15px 25px', background:'#f8fafc', borderTop:'1px solid #e2e8f0', display:'flex', justifyContent:'flex-end'}}>
                    <button type="button" className="btn-secondary" onClick={onClose} style={{padding:'10px 25px'}}>Cerrar</button>
                </div>
            </div>
        </div>
    );
};

export default ModalVerRecoleccion;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerReporte.jsx
==================================================================
import { useEffect, useState } from 'react';
import { getReporteDetalle, verifyReporte } from '../../services/reportesService'; 
// Importamos utilidades de seguridad
import { apiFetchBlob, extractFilename } from '../../services/api';
import '../../styles/Modal.css';
import { FaTimes, FaClipboardList, FaCheck, FaTimesCircle, FaCamera, FaUser, FaCalendarAlt, FaIndustry, FaCheckDouble, FaExternalLinkAlt } from 'react-icons/fa';
import Swal from 'sweetalert2';

const ModalVerReporte = ({ isOpen, onClose, reporte, onUpdate }) => {
    const [detalles, setDetalles] = useState([]);
    const [cabecera, setCabecera] = useState(null);
    const [loading, setLoading] = useState(true);
    const [verificando, setVerificando] = useState(false);

    useEffect(() => {
        if (isOpen && reporte) {
            setCabecera(reporte); 
            cargarDetalle();
        }
    }, [isOpen, reporte]);

    const cargarDetalle = async () => {
        setLoading(true);
        try {
            const data = await getReporteDetalle(reporte.ID_Reporte);
            setDetalles(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const handleVerificar = async () => {
        setVerificando(true);
        try {
            await verifyReporte(reporte.ID_Reporte);
            Swal.fire({
                icon: 'success',
                title: 'Verificado',
                text: 'El reporte ha sido marcado como revisado.',
                timer: 1500,
                showConfirmButton: false
            });
            if (onUpdate) onUpdate(); 
            onClose(); 
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setVerificando(false);
        }
    };

    // --- FUNCI√ìN SEGURA PARA ABRIR EVIDENCIA ---
    const handleVerEvidencia = async () => {
        if (!reporte.Url_Evidencia) return;
        
        try {
            const filename = extractFilename(reporte.Url_Evidencia);
            // Usamos el endpoint seguro (Asumimos que la ruta es /reportes/evidencia/:nombre)
            // Si no existe esa ruta espec√≠fica en backend, usaremos la gen√©rica luego
            const blob = await apiFetchBlob(`/reportes/evidencia/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al cargar evidencia:", error);
            alert("No se pudo cargar el archivo adjunto. Verifique su conexi√≥n.");
        }
    };

    if (!isOpen) return null;

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '700px', maxHeight: '90vh', overflowY:'auto'}}>
                <div className="modal-header">
                    <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <h2 style={{margin:0}}>Reporte #{reporte?.ID_Reporte}</h2>
                        {reporte?.Verificado ? (
                            <span className="badge badge-success" style={{fontSize:'0.8rem', padding:'4px 8px', background:'#dcfce7', color:'#166534'}}>
                                <FaCheckDouble /> Verificado
                            </span>
                        ) : (
                            <span className="badge" style={{background:'#f3f4f6', color:'#6b7280', fontSize:'0.8rem', padding:'4px 8px'}}>
                                Sin Verificar
                            </span>
                        )}
                    </div>
                    <button className="modal-close-button" onClick={onClose}><FaTimes/></button>
                </div>

                <div className="modal-body">
                    {/* RESUMEN CABECERA */}
                    <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', marginBottom:'20px', display:'grid', gridTemplateColumns:'1fr 1fr', gap:'10px'}}>
                        <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            <FaUser color="#64748b"/> 
                            <div>
                                <div style={{fontSize:'0.75rem', color:'#94a3b8'}}>Realizado por</div>
                                <div style={{fontWeight:'bold', color:'#334155'}}>{reporte?.Usuario}</div>
                            </div>
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'8px'}}>
                            <FaCalendarAlt color="#64748b"/> 
                            <div>
                                <div style={{fontSize:'0.75rem', color:'#94a3b8'}}>Fecha</div>
                                <div style={{fontWeight:'bold', color:'#334155'}}>
                                    {reporte ? new Date(reporte.Fecha_Reporte).toLocaleString() : ''}
                                </div>
                            </div>
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'8px', gridColumn:'span 2'}}>
                            <FaIndustry color="#64748b"/> 
                            <div>
                                <div style={{fontSize:'0.75rem', color:'#94a3b8'}}>Activo Inspeccionado</div>
                                <div style={{fontWeight:'bold', color:'#0c4760', fontSize:'1.1rem'}}>{reporte?.Activo}</div>
                            </div>
                        </div>
                    </div>

                    {/* DETALLE CHECKLIST */}
                    <h3 style={{fontSize:'1rem', borderBottom:'1px solid #eee', paddingBottom:'0.5rem', display:'flex', alignItems:'center', gap:'8px'}}>
                        <FaClipboardList color="#0c4760"/> Detalles de Inspecci√≥n
                    </h3>
                    
                    <div style={{marginBottom:'1.5rem'}}>
                        {loading ? <p>Cargando detalle...</p> : detalles.map((p, idx) => (
                            <div key={idx} style={{padding:'0.8rem 0', borderBottom:'1px dashed #f1f5f9'}}>
                                <div style={{color:'#334155', fontWeight:'600', marginBottom:'4px'}}>{p.Texto_Pregunta}</div>
                                
                                {/* LOGICA DE VISUALIZACION SEGUN TIPO */}
                                {p.Tipo === 'TEXT' ? (
                                    <div style={{
                                        background: '#f0f9ff', padding: '8px 12px', borderRadius: '6px', 
                                        color: '#0369a1', fontSize: '0.9rem', border: '1px solid #bae6fd',
                                        marginTop: '5px'
                                    }}>
                                        {p.Respuesta_Texto || 'Sin datos'}
                                    </div>
                                ) : (
                                    <div style={{display:'flex', alignItems:'center', marginTop:'5px'}}>
                                        {p.Cumple ? 
                                            <span style={{color:'#16a34a', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px', fontSize:'0.9rem'}}>
                                                <FaCheck size={14}/> CUMPLE
                                            </span> 
                                            : 
                                            <span style={{color:'#dc2626', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px', fontSize:'0.9rem'}}>
                                                <FaTimesCircle size={14}/> NO CUMPLE
                                            </span>
                                        }
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* EVIDENCIA Y OBSERVACIONES */}
                    {(reporte?.Url_Evidencia || reporte?.Observaciones) && (
                        <div style={{background:'#fff', border:'1px solid #e2e8f0', borderRadius:'8px', padding:'15px'}}>
                            {reporte.Observaciones && (
                                <div style={{marginBottom:'10px'}}>
                                    <strong style={{color:'#64748b', fontSize:'0.8rem', textTransform:'uppercase'}}>Observaciones Generales:</strong>
                                    <p style={{marginTop:'5px', color:'#334155'}}>{reporte.Observaciones}</p>
                                </div>
                            )}
                            
                            {reporte.Url_Evidencia && (
                                <div>
                                    <strong style={{color:'#64748b', fontSize:'0.8rem', textTransform:'uppercase', display:'flex', alignItems:'center', gap:'5px'}}>
                                        <FaCamera/> Evidencia Adjunta:
                                    </strong>
                                    
                                    <button 
                                        onClick={handleVerEvidencia}
                                        style={{
                                            display:'inline-flex', alignItems:'center', gap:'5px', marginTop:'8px', 
                                            color:'#0c4760', textDecoration:'none', fontSize:'0.9rem',
                                            background:'none', border:'none', cursor:'pointer', fontWeight:'bold'
                                        }}
                                    >
                                        Ver fotograf√≠a / documento <FaExternalLinkAlt size={12}/>
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                <div className="modal-footer" style={{justifyContent: 'space-between'}}>
                    <button className="btn-secondary" onClick={onClose}>Cerrar</button>
                    
                    {!reporte?.Verificado && (
                        <button 
                            className="btn-primary-modal" 
                            style={{backgroundColor: '#10b981', display:'flex', alignItems:'center', gap:'8px'}}
                            onClick={handleVerificar}
                            disabled={verificando}
                        >
                            <FaCheckDouble /> {verificando ? 'Procesando...' : 'Marcar como Revisado'}
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};

export default ModalVerReporte;


==================================================================
ARCHIVO: frontend\src\components\modals\ModalVerSalida.jsx
==================================================================
import { useState, useEffect } from 'react';
import { FaTimes, FaFilePdf, FaTruck, FaUser, FaCalendarDay, FaExternalLinkAlt, FaImage } from 'react-icons/fa';
// Importamos las utilidades seguras
import { apiFetchBlob, extractFilename } from '../../services/api';
import '../../styles/Modal.css';

const ModalVerSalida = ({ isOpen, onClose, data }) => {
    // Estado para la URL segura del archivo
    const [secureFileUrl, setSecureFileUrl] = useState(null);
    const [loadingFile, setLoadingFile] = useState(false);
    
    const ACCENT_COLOR = '#0c4760';

    // Cargar archivo al abrir
    useEffect(() => {
        if (isOpen && data?.Url_Documento) {
            loadFile();
        }
        // Limpieza de memoria
        return () => {
            if (secureFileUrl) URL.revokeObjectURL(secureFileUrl);
        };
    }, [isOpen, data]);

    const loadFile = async () => {
        setLoadingFile(true);
        try {
            const filename = extractFilename(data.Url_Documento);
            // Usamos la ruta de streaming de Recall
            // Aseg√∫rate de que esta ruta exista en recallRoutes.js: router.get('/documento/:filename', ...)
            const blob = await apiFetchBlob(`/recall/documento/${filename}`);
            
            if (blob.size === 0) throw new Error("Archivo vac√≠o");

            const url = URL.createObjectURL(blob);
            setSecureFileUrl(url);
        } catch (error) {
            console.error("Error cargando documento:", error);
            // Fallback para URLs antiguas
            if (data.Url_Documento.startsWith('http')) {
                setSecureFileUrl(data.Url_Documento);
            }
        } finally {
            setLoadingFile(false);
        }
    };

    if (!isOpen || !data) return null;

    // Detectar si es imagen
    const isImage = data.Url_Documento && /\.(jpg|jpeg|png|gif|webp)$/i.test(data.Url_Documento);

    return (
        <div className="modal-overlay">
            <div className="modal-content" style={{maxWidth: '500px', borderRadius:'12px', overflow:'hidden', padding:0}}>
                
                {/* Header Estilizado */}
                <div className="modal-header" style={{backgroundColor: 'white', borderBottom: '1px solid #e2e8f0', padding: '15px 20px'}}>
                    <div>
                        <span style={{fontSize:'0.75rem', color:'#64748b', textTransform:'uppercase', fontWeight:'bold'}}>
                            SALIDA #{data.ID_Recall_Salida}
                        </span>
                        <h2 style={{margin:0, fontSize:'1.2rem', color: ACCENT_COLOR, display:'flex', alignItems:'center', gap:'8px'}}>
                            <FaTruck /> {data.Producto}
                        </h2>
                    </div>
                    <button className="modal-close-button" onClick={onClose} style={{color:'#64748b'}}><FaTimes/></button>
                </div>

                <div className="modal-body" style={{padding:'25px'}}>
                    
                    {/* Tarjeta de Resumen */}
                    <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', border:'1px solid #e2e8f0', marginBottom:'20px'}}>
                        <div style={{display:'flex', justifyContent:'space-between'}}>
                            <div>
                                <span style={{fontSize:'0.75rem', color:'#64748b', fontWeight:'bold'}}>LOTE</span>
                                <div style={{fontSize:'1.1rem', fontWeight:'800', color:'#0f172a'}}>{data.Lote}</div>
                            </div>
                            <div style={{textAlign:'right'}}>
                                <span style={{fontSize:'0.75rem', color:'#64748b', fontWeight:'bold'}}>CANTIDAD</span>
                                <div style={{fontSize:'1.1rem', fontWeight:'800', color:'#0f172a'}}>{data.Cantidad}</div>
                            </div>
                        </div>
                    </div>

                    {/* Lista de Detalles */}
                    <div className="detail-list" style={{display:'flex', flexDirection:'column', gap:'15px'}}>
                        <div style={{display:'flex', alignItems:'center', gap:'12px'}}>
                            <FaUser style={{color: '#94a3b8'}} />
                            <div>
                                <span style={{display:'block', fontSize:'0.75rem', color:'#64748b'}}>Cliente Destino</span>
                                <span style={{color:'#334155', fontWeight:'500'}}>{data.Cliente}</span>
                            </div>
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'12px'}}>
                            <FaCalendarDay style={{color: '#94a3b8'}} />
                            <div>
                                <span style={{display:'block', fontSize:'0.75rem', color:'#64748b'}}>Fecha de Env√≠o</span>
                                <span style={{color:'#334155', fontWeight:'500'}}>
                                    {new Date(data.Fecha_Envio).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                </span>
                            </div>
                        </div>
                    </div>

                    {/* Observaciones */}
                    {data.Observaciones && (
                        <div style={{marginTop:'20px', padding:'10px', background:'#fffbeb', border:'1px solid #fef3c7', borderRadius:'6px', fontSize:'0.9rem', color:'#92400e'}}>
                            <strong>Nota:</strong> {data.Observaciones}
                        </div>
                    )}

                    {/* Bot√≥n de Documento Seguro */}
                    <div style={{marginTop:'25px'}}>
                        <h4 style={{fontSize:'0.85rem', color:'#475569', marginBottom:'10px', borderBottom:'1px solid #eee'}}>SOPORTE DIGITAL</h4>
                        
                        {data.Url_Documento ? (
                            loadingFile ? (
                                <div style={{textAlign:'center', color:'#64748b', fontSize:'0.9rem'}}>Cargando documento...</div>
                            ) : secureFileUrl ? (
                                isImage ? (
                                    // Vista Imagen
                                    <div style={{borderRadius:'8px', overflow:'hidden', border:'1px solid #cbd5e1'}}>
                                        <img src={secureFileUrl} alt="Soporte" style={{width:'100%', maxHeight:'250px', objectFit:'contain', background:'#f1f5f9'}} />
                                        <a href={secureFileUrl} target="_blank" rel="noopener noreferrer" style={{display:'block', padding:'8px', textAlign:'center', fontSize:'0.85rem', color: ACCENT_COLOR, textDecoration:'none', background:'white'}}>
                                            <FaExternalLinkAlt /> Abrir imagen original
                                        </a>
                                    </div>
                                ) : (
                                    // Vista PDF/Otro
                                    <a 
                                        href={secureFileUrl} 
                                        target="_blank" 
                                        rel="noopener noreferrer" 
                                        style={{
                                            display:'flex', alignItems:'center', justifyContent:'center', gap:'10px',
                                            backgroundColor: ACCENT_COLOR, color:'white', padding:'12px', borderRadius:'8px',
                                            textDecoration:'none', fontWeight:'600', transition:'all 0.2s', width:'100%', boxSizing:'border-box'
                                        }}
                                    >
                                        <FaFilePdf /> Ver Soporte / Remisi√≥n <FaExternalLinkAlt size={12} style={{marginLeft:'auto', opacity:0.7}}/>
                                    </a>
                                )
                            ) : (
                                <div style={{textAlign:'center', color:'#ef4444', fontSize:'0.9rem'}}>Error cargando archivo.</div>
                            )
                        ) : (
                            <div style={{textAlign:'center', padding:'10px', background:'#f1f5f9', borderRadius:'6px', color:'#94a3b8', fontSize:'0.9rem'}}>
                                Sin documento adjunto
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default ModalVerSalida;


==================================================================
ARCHIVO: frontend\src\components\ProtectedRoute.jsx
==================================================================
// frontend/src/components/ProtectedRoute.jsx
import { Navigate, Outlet } from 'react-router-dom';
import useAuth from '../hooks/useAuth';
import MainLayout from './layout/MainLayout';

const ProtectedRoute = () => {
    const { auth, loading } = useAuth();

    if (loading) return <div>Cargando...</div>;

    // Si no hay token, al login
    if (!auth.token) {
        return <Navigate to="/" />;
    }

    // Si hay token, mostramos el contenido DENTRO del Layout
    return (
        <MainLayout>
            <Outlet />
        </MainLayout>
    );
};

export default ProtectedRoute;


==================================================================
ARCHIVO: frontend\src\context\AuthProvider.jsx
==================================================================
// frontend/src/context/AuthProvider.jsx
import { createContext, useState, useEffect } from 'react';

const AuthContext = createContext();

export const AuthProvider = ({ children }) => {
    const [auth, setAuth] = useState({});
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        // Verificar si ya hay un token guardado al recargar la p√°gina
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        if (token && user) {
            // eslint-disable-next-line react-hooks/set-state-in-effect
            setAuth({ token, user: JSON.parse(user) });
        }
        setLoading(false);
    }, []);

    const loginUser = (userData, token) => {
        // Guardar en estado y en localStorage
        setAuth({ token, user: userData });
        localStorage.setItem('token', token);
        localStorage.setItem('user', JSON.stringify(userData));
    };

    const logoutUser = () => {
        setAuth({});
        localStorage.removeItem('token');
        localStorage.removeItem('user');
    };

    return (
        <AuthContext.Provider value={{ auth, setAuth, loginUser, logoutUser, loading }}>
            {children}
        </AuthContext.Provider>
    );
};

export default AuthContext;


==================================================================
ARCHIVO: frontend\src\hooks\useAuth.jsx
==================================================================
// frontend/src/hooks/useAuth.jsx
import { useContext } from 'react';
import AuthContext from '../context/AuthProvider';

const useAuth = () => {
    return useContext(AuthContext);
};

export default useAuth;


==================================================================
ARCHIVO: frontend\src\index.css
==================================================================
/* frontend/src/index.css */
:root {
  /* --- COLOR ESTRUCTURAL (Solo fondos y bordes) --- */
  --color-primary: #000000;
  --color-primary-dark: #083548;
  
  /* Fondos */
  --color-bg-body: #f4f4f4; 
  --color-bg-card: #ffffff;

  /* --- TEXTOS (Estrictamente Blanco y Negro) --- */
  --color-text-main: #000000;      /* Negro Puro */
  --color-text-secondary: #000000; /* Negro Puro */
  --color-text-muted: #333333;     /* Gris muy oscuro casi negro */
  --color-white: #ffffff;

  /* Estructura */
  --sidebar-width: 260px;
  --header-height: 60px;
  --radius: 8px; /* Un poco m√°s suave que 4px */
  
  /* Sombras planas/sutiles */
  --shadow-card: 0 1px 3px rgba(0,0,0,0.1);

  --font-family: 'Inter', system-ui, -apple-system, sans-serif;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: var(--font-family);
  background-color: var(--color-bg-body);
  color: var(--color-text-main);
  -webkit-font-smoothing: antialiased;
  line-height: 1.5;
  font-weight: 400; /* Letra fina/normal */
}

/* --- TIPOGRAF√çA: SIEMPRE NEGRA --- */
h1, h2, h3, h4, h5, h6 {
  color: #000000 !important; /* Forzamos negro */
  font-weight: 600; /* Un poco m√°s de peso para jerarqu√≠a */
  margin-bottom: 0.8rem;
  line-height: 1.3;
}

/* Botones (Fondo Azul, Letra Blanca) */
button {
  cursor: pointer;
  border: none;
  font-family: inherit;
  transition: transform 0.1s, background-color 0.2s;
}

button:active {
  transform: scale(0.98);
}

.btn-primary {
  background-color: var(--color-primary);
  color: var(--color-white);
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  font-weight: 500;
  font-size: 0.95rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary:hover {
  background-color: var(--color-primary-dark);
}

/* Tarjetas Globales */
.card {
  background: var(--color-bg-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-card);
  padding: 2rem;
  border: 1px solid #e2e8f0;
}

/* T√≠tulos de p√°gina: NEGROS */
.page-title {
    font-size: 1.8rem;
    color: #000000 !important;
    font-weight: 700; 
    border-bottom: none; /* Quitamos borde inferior antiguo si exist√≠a */
    padding-bottom: 0;
    margin-bottom: 5px;
    letter-spacing: -0.5px;
}

/* Bot√≥n "Volver" Flotante (Usado en Login/Welcome) */
.btn-back-nav {
    position: absolute;
    top: 20px;
    left: 20px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
    font-weight: 600;
    color: #475569; /* Gris oscuro para fondo claro */
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.2s ease;
    z-index: 10;
}

.btn-back-nav:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: #0c4760;
    transform: translateX(-3px); /* Peque√±a animaci√≥n hacia la izquierda */
}

/* Variante para fondos oscuros */
.btn-back-nav.light {
    color: white;
}
.btn-back-nav.light:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

/* --- CORRECCI√ìN PRIORIDAD DE ALERTAS --- */
/* Forzamos a SweetAlert a estar siempre encima de nuestros modales (que tienen z-index 2000) */
.swal2-container {
    z-index: 200000 !important;
}

/* ==========================================================================
   RESPONSIVE GLOBAL (M√ìVIL Y TABLET < 768px)
   ========================================================================== */
@media (max-width: 768px) {
    
    /* 1. Ajuste de fuentes globales */
    html {
        font-size: 15px; /* Reduce ligeramente todo el escalado rem */
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.3rem; }
    h3 { font-size: 1.1rem; }

    .page-title {
        font-size: 1.5rem !important; /* T√≠tulo de p√°gina m√°s compacto */
    }

    /* 2. Ajuste de Tarjetas */
    .card {
        padding: 1.2rem; /* Menos relleno para ganar espacio */
        border-radius: 12px;
    }

    /* 3. Ajuste de Bot√≥n Flotante Volver */
    .btn-back-nav {
        top: 15px;
        left: 15px;
        font-size: 0.9rem;
        padding: 6px 10px;
        background-color: rgba(255,255,255,0.8); /* Fondo semi-transparente para legibilidad */
        backdrop-filter: blur(2px);
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
}


==================================================================
ARCHIVO: frontend\src\main.jsx
==================================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

// AGREGA ESTA L√çNEA AQU√ç:
import 'sweetalert2/dist/sweetalert2.min.css'; 

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


==================================================================
ARCHIVO: frontend\src\pages\admin\ActasDestruccion.jsx
==================================================================
import { useState, useEffect } from 'react';
import axios from 'axios';
import { API_URL, getAuthHeaders } from '../../services/api'; // Aseg√∫rate de usar getAuthHeaders si tienes seguridad
import { FaPlus, FaSearch, FaEye, FaTrash, FaFileAlt, FaClipboardList } from 'react-icons/fa';
import ModalCreateActa from '../../components/modals/ModalCreateActa';
import ModalVerActa from '../../components/modals/ModalVerActa'; 
import '../../styles/Dashboard.css';
import '../../styles/Tables.css';

const ActasDestruccion = () => {
    const [actas, setActas] = useState([]);
    const [loading, setLoading] = useState(false);
    const [showCreate, setShowCreate] = useState(false);
    const [showView, setShowView] = useState(false);
    const [selectedActa, setSelectedActa] = useState(null);
    const [searchTerm, setSearchTerm] = useState('');

    // Color Corporativo
    const THEME_COLOR = '#0c4760';

    useEffect(() => {
        fetchActas();
    }, []);

    const fetchActas = async () => {
        setLoading(true);
        try {
            // Usamos la URL configurada y los headers de autenticaci√≥n
            const res = await axios.get(`${API_URL}/actas`, { headers: getAuthHeaders() });
            setActas(res.data);
        } catch (error) {
            console.error("Error cargando actas:", error);
        } finally {
            setLoading(false);
        }
    };

    const handleView = (acta) => {
        setSelectedActa(acta);
        setShowView(true);
    };

    // Filtro de b√∫squeda (Por n√∫mero, producto o sede)
    const filteredActas = actas.filter(a => 
        a.Numero_Acta.toLowerCase().includes(searchTerm.toLowerCase()) ||
        a.Producto.toLowerCase().includes(searchTerm.toLowerCase()) ||
        a.Sede.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="fade-in">
            {/* --- ENCABEZADO DE P√ÅGINA --- */}
            <div className="page-header" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                <div>
                    <h1 className="page-title" style={{color: THEME_COLOR, display:'flex', gap:'12px', alignItems:'center', fontSize:'1.8rem'}}>
                        <FaTrash /> Actas de Destrucci√≥n
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px', fontSize:'0.95rem'}}>
                        Gesti√≥n y control de producto no conforme para disposici√≥n final.
                    </p>
                </div>
                
                {/* Estad√≠sticas R√°pidas (Opcional, visualmente atractivo) */}
                <div style={{display:'flex', gap:'20px', paddingRight:'10px'}}>
                    <div style={{textAlign:'center'}}>
                        <span style={{display:'block', fontSize:'1.2rem', fontWeight:'bold', color: THEME_COLOR}}>{actas.length}</span>
                        <span style={{fontSize:'0.75rem', color:'#94a3b8', textTransform:'uppercase'}}>Total Actas</span>
                    </div>
                </div>
            </div>

            {/* --- BARRA DE CONTROL --- */}
            <div className="control-bar" style={{
                marginBottom:'25px', 
                display:'flex', 
                justifyContent:'space-between', 
                flexWrap:'wrap', 
                gap:'15px',
                background: '#f8fafc',
                padding: '15px',
                borderRadius: '12px',
                border: '1px solid #e2e8f0'
            }}>
                {/* BUSCADOR CORREGIDO (Flexbox Inline) */}
                <div style={{
                    display:'flex', 
                    alignItems:'center', 
                    background:'white', 
                    border:'1px solid #cbd5e1', 
                    borderRadius:'8px', 
                    padding:'0 15px', 
                    width:'100%', 
                    maxWidth:'350px',
                    height:'45px',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.02)'
                }}>
                    <FaSearch style={{color:'#94a3b8', marginRight:'12px', flexShrink:0}} />
                    <input 
                        style={{
                            border:'none', 
                            outline:'none', 
                            width:'100%', 
                            fontSize:'0.95rem', 
                            color:'#334155',
                            background: 'transparent'
                        }} 
                        placeholder="Buscar por acta, producto..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>

                <button 
                    className="btn-primary" 
                    onClick={() => setShowCreate(true)} 
                    style={{
                        backgroundColor: THEME_COLOR, 
                        display:'flex', 
                        alignItems:'center', 
                        gap:'8px', 
                        padding:'10px 20px',
                        boxShadow: '0 4px 6px -1px rgba(12, 71, 96, 0.2)'
                    }}
                >
                    <FaPlus /> Nueva Acta
                </button>
            </div>

            {/* --- TABLA DE DATOS --- */}
            <div className="table-container" style={{boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.05)', borderRadius: '12px', overflow: 'hidden'}}>
                <table className="modern-table">
                    <thead>
                        <tr>
                            <th style={{width: '100px'}}>N¬∞ Acta</th>
                            <th style={{width: '120px'}}>Fecha</th>
                            <th>Producto / Descripci√≥n</th>
                            <th>Cantidad</th>
                            <th>Sede / Bodega</th>
                            <th style={{textAlign:'right', width: '140px'}}>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr>
                                <td colSpan="6" style={{textAlign:'center', padding:'40px'}}>
                                    <div className="spin" style={{fontSize:'2rem', color: THEME_COLOR, marginBottom:'10px'}}>‚óè</div>
                                    <span style={{color:'#64748b'}}>Cargando registros...</span>
                                </td>
                            </tr>
                        ) : filteredActas.length === 0 ? (
                            <tr>
                                <td colSpan="6" style={{textAlign:'center', padding:'50px', color:'#94a3b8'}}>
                                    <FaClipboardList size={40} style={{marginBottom:'10px', opacity:0.3}} />
                                    <p>No se encontraron actas registradas.</p>
                                </td>
                            </tr>
                        ) : (
                            filteredActas.map(acta => (
                                <tr key={acta.ID_Acta} className="modern-row">
                                    <td className="modern-cell">
                                        <span style={{
                                            background: '#e0f2fe', 
                                            color: '#0369a1', 
                                            padding: '4px 10px', 
                                            borderRadius: '6px', 
                                            fontWeight: 'bold', 
                                            fontSize: '0.85rem'
                                        }}>
                                            #{acta.Numero_Acta}
                                        </span>
                                    </td>
                                    <td className="modern-cell" style={{color:'#475569'}}>
                                        {new Date(acta.Fecha).toLocaleDateString()}
                                    </td>
                                    <td className="modern-cell">
                                        <div style={{fontWeight:'600', color:'#1e293b'}}>{acta.Producto}</div>
                                        <div style={{fontSize:'0.8rem', color:'#94a3b8'}}>Novedad: {acta.Novedad ? acta.Novedad.substring(0, 30) + '...' : 'Sin detalles'}</div>
                                    </td>
                                    <td className="modern-cell"><strong>{acta.Cantidad}</strong></td>
                                    <td className="modern-cell" style={{fontSize:'0.9rem'}}>{acta.Bodega_Procedente}</td>
                                    <td className="modern-cell" style={{textAlign:'right'}}>
                                        <button 
                                            onClick={() => handleView(acta)} 
                                            style={{
                                                background: 'white',
                                                border: `1px solid ${THEME_COLOR}`,
                                                color: THEME_COLOR,
                                                padding: '6px 12px',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                display: 'inline-flex',
                                                alignItems: 'center',
                                                gap: '6px',
                                                fontSize: '0.85rem',
                                                fontWeight: '600',
                                                transition: 'all 0.2s'
                                            }}
                                            onMouseEnter={(e) => {
                                                e.currentTarget.style.background = THEME_COLOR;
                                                e.currentTarget.style.color = 'white';
                                            }}
                                            onMouseLeave={(e) => {
                                                e.currentTarget.style.background = 'white';
                                                e.currentTarget.style.color = THEME_COLOR;
                                            }}
                                        >
                                            <FaEye /> Ver / PDF
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* --- MODALES --- */}
            <ModalCreateActa isOpen={showCreate} onClose={() => setShowCreate(false)} onSuccess={fetchActas} />
            <ModalVerActa isOpen={showView} onClose={() => setShowView(false)} data={selectedActa} />
        </div>
    );
};

export default ActasDestruccion;


==================================================================
ARCHIVO: frontend\src\pages\admin\Activos.jsx
==================================================================
// frontend/src/pages/admin/Activos.jsx
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { getActivos, createActivo, toggleActivoStatus } from '../../services/coreService';
import ModalCreateActivo from '../../components/modals/ModalCreateActivo';
import ModalEditActivo from '../../components/modals/ModalEditActivo'; // IMPORTAR NUEVO
import '../../styles/Tables.css';
import '../../styles/Usuarios.css'; // Usamos los filtros de usuarios
import { FaPlus, FaIndustry, FaEdit, FaBan, FaCheck, FaMapMarkerAlt, FaBarcode, FaSearch } from 'react-icons/fa';

const Activos = () => {
    const [activos, setActivos] = useState([]);
    const [loading, setLoading] = useState(true);
    
    // Filtros
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('activo'); // Por defecto solo activos

    // Modales
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);
    const [selectedActivo, setSelectedActivo] = useState(null);

    useEffect(() => {
        cargarDatos();
    }, []);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            const data = await getActivos();
            setActivos(data);
        } catch (error) { console.error(error); } 
        finally { setLoading(false); }
    };

    // L√≥gica Editar
    const handleOpenEdit = (activo) => {
        setSelectedActivo(activo);
        setShowEditModal(true);
    };

    // L√≥gica Inactivar/Activar
    const handleToggleStatus = async (activo) => {
        const action = activo.Estado ? 'Inactivar' : 'Activar';
        const color = activo.Estado ? '#d33' : '#10b981';

        Swal.fire({
            title: `¬ø${action} activo?`,
            text: `El activo "${activo.Nombre}" cambiar√° de estado.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: color,
            cancelButtonColor: '#3085d6',
            confirmButtonText: `S√≠, ${action}`,
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await toggleActivoStatus(activo.ID_Activo, !activo.Estado);
                    cargarDatos();
                    Swal.fire('¬°Listo!', `El activo ha sido ${action.toLowerCase()}do.`, 'success');
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        });
    };

    // Filtrado
    const filteredActivos = activos.filter(activo => {
        const matchesText = 
            activo.Nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (activo.Codigo && activo.Codigo.toLowerCase().includes(searchTerm.toLowerCase()));
        
        const matchesStatus = 
            filterStatus === 'todos' ? true :
            filterStatus === 'activo' ? activo.Estado === true :
            activo.Estado === false;

        return matchesText && matchesStatus;
    });

    return (
        <div>
            <div className="page-header">
                <h1 className="page-title">Inventario de Activos</h1>
                <button className="btn-new-user" onClick={() => setShowCreateModal(true)}>
                    <FaPlus style={{ marginRight: '8px' }} /> Nuevo Activo
                </button>
            </div>

            {/* BARRA DE FILTROS */}
            <div className="filters-bar">
                <div className="search-input-container">
                    <FaSearch />
                    <input 
                        type="text" 
                        placeholder="Buscar por c√≥digo o nombre..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="filter-select-container">
                    <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                        <option value="activo">Solo Activos (Operativos)</option>
                        <option value="inactivo">Dados de Baja</option>
                        <option value="todos">Todos los Activos</option>
                    </select>
                </div>
            </div>

            <div className="table-container">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Activo</th>
                            <th>Categor√≠a</th>
                            <th>Ubicaci√≥n</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr>
                        ) : filteredActivos.map(activo => (
                            <tr key={activo.ID_Activo}>
                                <td>
                                    <div style={{display:'flex', alignItems:'center', gap:'5px', color:'#64748b', fontWeight:'bold', fontSize:'0.85rem'}}>
                                        <FaBarcode /> {activo.Codigo || 'N/A'}
                                    </div>
                                </td>
                                <td style={{fontWeight:'600', color:'#0f172a'}}>{activo.Nombre}</td>
                                <td>
                                    <span style={{background:'#f1f5f9', padding:'4px 10px', borderRadius:'4px', fontSize:'0.8rem', color:'#475569', border:'1px solid #e2e8f0'}}>
                                        {activo.Tipo}
                                    </span>
                                </td>
                                <td>
                                    <div style={{display:'flex', alignItems:'center', gap:'5px', fontSize:'0.9rem', color:'#64748b'}}>
                                        <FaMapMarkerAlt /> {activo.Ubicacion || '-'}
                                    </div>
                                </td>
                                <td>
                                    <span className={`badge ${activo.Estado ? 'badge-success' : 'badge-danger'}`}>
                                        {activo.Estado ? 'Operativo' : 'Baja'}
                                    </span>
                                </td>
                                <td>
                                    <div className="action-buttons">
                                        <button 
                                            className="btn-action btn-edit" 
                                            title="Editar" 
                                            onClick={() => handleOpenEdit(activo)}
                                        >
                                            <FaEdit />
                                        </button>
                                        
                                        <button 
                                            className={`btn-action ${activo.Estado ? 'btn-toggle-off' : 'btn-toggle-on'}`}
                                            title={activo.Estado ? "Dar de baja" : "Reactivar"}
                                            onClick={() => handleToggleStatus(activo)}
                                        >
                                            {activo.Estado ? <FaBan /> : <FaCheck />}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        ))}
                        {!loading && filteredActivos.length === 0 && (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No se encontraron activos.</td></tr>
                        )}
                    </tbody>
                </table>
            </div>

            <ModalCreateActivo 
                isOpen={showCreateModal} 
                onClose={() => setShowCreateModal(false)} 
                onSuccess={cargarDatos} 
            />

            <ModalEditActivo 
                isOpen={showEditModal} 
                onClose={() => setShowEditModal(false)} 
                activo={selectedActivo} 
                onSuccess={cargarDatos} 
            />
        </div>
    );
};

export default Activos;


==================================================================
ARCHIVO: frontend\src\pages\admin\Auditoria.jsx
==================================================================
// frontend/src/pages/admin/Auditoria.jsx
import { useState, useEffect } from 'react';
import { getAuditoriaData } from '../../services/auditService';
import '../../styles/Dashboard.css'; // Reusamos estilos de dashboard
import '../../styles/Tables.css';
import { FaUserSecret, FaClipboardCheck, FaExclamationCircle, FaChartPie, FaCalendarCheck } from 'react-icons/fa';

const Auditoria = () => {
    const [data, setData] = useState({ resumen: [], cronogramas: [], actividades: [] });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetchData();
    }, []);

    const fetchData = async () => {
        try {
            const result = await getAuditoriaData();
            setData(result);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    // C√°lculo de porcentaje para las barras
    const getPercent = (part, total) => total === 0 ? 0 : Math.round((part / total) * 100);

    return (
        <div>
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaUserSecret /> Auditor√≠a de Gesti√≥n
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Supervisi√≥n de cumplimiento del equipo de Calidad.</p>
                </div>
            </div>

            {/* --- SECCI√ìN 1: TARJETAS DE RENDIMIENTO POR ADMIN --- */}
            <h3 className="section-title"><FaChartPie /> Rendimiento por Responsable</h3>
            <div className="stats-grid" style={{marginBottom:'2rem'}}>
                {loading ? <p>Cargando m√©tricas...</p> : data.resumen.map((user, idx) => (
                    <div key={idx} className="stat-card" style={{borderTop:'4px solid #0c4760'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                            <h3 style={{margin:0, fontSize:'1.1rem', color:'#0f172a'}}>{user.AdminCalidad}</h3>
                            <span className="badge" style={{background:'#f1f5f9'}}>{user.Total_Actividades} Actividades</span>
                        </div>
                        
                        {/* Barras de Progreso */}
                        <div style={{display:'flex', flexDirection:'column', gap:'8px'}}>
                            
                            {/* Realizadas */}
                            <div>
                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.8rem', marginBottom:'2px'}}>
                                    <span style={{color:'#166534'}}>Completadas</span>
                                    <strong>{user.Realizadas} ({getPercent(user.Realizadas, user.Total_Actividades)}%)</strong>
                                </div>
                                <div style={{height:'6px', background:'#e2e8f0', borderRadius:'3px', overflow:'hidden'}}>
                                    <div style={{width:`${getPercent(user.Realizadas, user.Total_Actividades)}%`, background:'#16a34a', height:'100%'}}></div>
                                </div>
                            </div>

                            {/* Vencidas */}
                            <div>
                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.8rem', marginBottom:'2px'}}>
                                    <span style={{color:'#dc2626'}}>Vencidas / No Cumplidas</span>
                                    <strong>{user.Vencidas} ({getPercent(user.Vencidas, user.Total_Actividades)}%)</strong>
                                </div>
                                <div style={{height:'6px', background:'#e2e8f0', borderRadius:'3px', overflow:'hidden'}}>
                                    <div style={{width:`${getPercent(user.Vencidas, user.Total_Actividades)}%`, background:'#dc2626', height:'100%'}}></div>
                                </div>
                            </div>

                        </div>
                    </div>
                ))}
            </div>

            {/* --- SECCI√ìN 2: TABLA DE DETALLE (ACTIVIDADES) --- */}
            <h3 className="section-title"><FaCalendarCheck /> Detalle de Actividades Asignadas</h3>
            <div className="table-container">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th>Responsable</th>
                            <th>Actividad</th>
                            <th>Fecha Prog.</th>
                            <th>Estado</th>
                            <th>Evidencia / Bit√°cora</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? <tr><td colSpan="5" style={{padding:'2rem', textAlign:'center'}}>Cargando...</td></tr> : 
                        data.actividades.length === 0 ? <tr><td colSpan="5" style={{padding:'2rem', textAlign:'center'}}>No hay actividades registradas.</td></tr> :
                        data.actividades.map((act, i) => (
                            <tr key={i}>
                                <td style={{fontWeight:'600'}}>{act.Responsable}</td>
                                <td>{act.Titulo}</td>
                                <td>{new Date(act.Fecha_Registro).toLocaleDateString()}</td>
                                <td>
                                    <span className={`badge ${
                                        act.Estado === 'Realizada' ? 'badge-success' : 
                                        act.Estado === 'Cancelada' ? 'badge-danger' : 'status-pendiente'
                                    }`} style={act.Estado === 'Pendiente' ? {background:'#fff7ed', color:'#c2410c', border:'1px solid #fdba74'} : {}}>
                                        {act.Estado}
                                    </span>
                                </td>
                                <td style={{fontSize:'0.85rem', color:'#64748b', maxWidth:'300px'}}>
                                    {act.Descripcion ? 
                                        act.Descripcion.replace(/\|\|/g, ' ') : 
                                        <span style={{fontStyle:'italic'}}>Sin novedades</span>
                                    }
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* --- SECCI√ìN 3: PLANEACI√ìN (CRONOGRAMAS) --- */}
            <h3 className="section-title" style={{marginTop:'2rem'}}><FaClipboardCheck /> Cronogramas Creados</h3>
            <div className="table-container">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th>Creador</th>
                            <th>Nombre Cronograma</th>
                            <th>Fecha Creaci√≥n</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.cronogramas.map((crono, i) => (
                            <tr key={i}>
                                <td style={{fontWeight:'600'}}>{crono.Responsable}</td>
                                <td>{crono.Titulo}</td>
                                <td>{new Date(crono.Fecha_Registro).toLocaleDateString()}</td>
                                <td><span className="badge badge-success">{crono.Estado}</span></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

export default Auditoria;


==================================================================
ARCHIVO: frontend\src\pages\admin\AuditoriaProveedor.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { FaTrash, FaPlus, FaSave, FaArrowLeft, FaCheckCircle, FaTimesCircle, FaBan, FaInfoCircle } from 'react-icons/fa';
// 1. Usamos apiFetch en lugar de importar API_URL y headers sueltos
import { apiFetch } from '../../services/api';
import { getListasExternas } from '../../services/externosService';
import '../../styles/Dashboard.css';

const ITEMS_POR_DEFECTO = [
    "1. Construcci√≥n resistente al medio ambiente (polvo, lluvia) y a prueba de plagas.",
    "2. Planta libre de residuos, objetos en desuso y animales dom√©sticos.",
    "3. Edificaci√≥n secuencial, sin contraflujos (separaci√≥n f√≠sica de √°reas).",
    "4. Pisos impermeables, lavables, sin grietas y con drenajes protegidos.",
    "5. Paredes claras, lisas, lavables y sin grietas. Uniones redondeadas.",
    "6. Techos limpios, sin condensaci√≥n y con protecci√≥n en luces (vidrio/pl√°stico).",
    "7. Ventanas y puertas en buen estado, con protecci√≥n (mallas) contra insectos.",
    "8. Iluminaci√≥n y ventilaci√≥n adecuadas para la operaci√≥n.",
    "9. Servicios sanitarios limpios, dotados (jab√≥n, papel, toallas) y separados.",
    "10. Pr√°cticas higi√©nicas del personal (lavado de manos, conducta).",
    "11. Dotaci√≥n del personal (uniformes claros, limpios, sin botones/bolsillos).",
    "12. Programa de Limpieza y Desinfecci√≥n documentado y verificado.",
    "13. Programa de Control de Plagas (cebos protegidos, registros).",
    "14. Agua Potable (tanques lavados, control de cloro/pH).",
    "15. Manejo de Residuos S√≥lidos (canecas tapadas, punto de acopio).",
    "16. Materias Primas: Inspecci√≥n en recepci√≥n y Fichas T√©cnicas.",
    "17. Almacenamiento: Estibas pl√°sticas, rotaci√≥n (PEPS), identificado.",
    "18. Control de Producto No Conforme (√°rea identificada).",
    "19. Transporte (Veh√≠culo limpio, exclusivo, libre de olores/plagas).",
    "20. Planeaci√≥n Estrat√©gica (Misi√≥n, Visi√≥n, Pol√≠tica de Calidad).",
    "21. Certificaciones de Calidad vigentes."
];

const AuditoriaProveedor = ({ onCancel, onSaveSuccess }) => {
    // --- ESTADO LIMPIO (SIN LOS CAMPOS ELIMINADOS) ---
    const [header, setHeader] = useState({
        empresa: '', 
        ciudad: '', 
        registroSanitario: '', 
        producto: '',
        conceptoSanitario: '', 
        realizadoPor: '', 
        recibidoPor: '', 
        observaciones: ''
    });

    const [proveedoresList, setProveedoresList] = useState([]);
    
    // --- ESTADOS PARA BUSCADOR INTELIGENTE ---
    const [searchProveedor, setSearchProveedor] = useState('');
    const [showProvList, setShowProvList] = useState(false);

    const [items, setItems] = useState(
        ITEMS_POR_DEFECTO.map((pregunta, index) => ({
            id: index, pregunta: pregunta, calificacion: 0, esNA: false, observacion: ''
        }))
    );

    const [resultados, setResultados] = useState({
        obtenido: 0, posible: 0, porcentaje: 0, concepto: 'PENDIENTE',
        countCumple: 0, countNoCumple: 0, countNA: 0 
    });

    // Color Corporativo
    const CORPORATE_BLUE = '#0c4760';

    useEffect(() => {
        const cargarListas = async () => {
            try {
                const data = await getListasExternas();
                setProveedoresList(data.proveedores || []);
            } catch (error) {
                console.error("Error cargando proveedores externos:", error);
            }
        };
        cargarListas();
    }, []);

    useEffect(() => {
        calcularResultados();
    }, [items]);

    const calcularResultados = () => {
        let obtenido = 0;
        let posible = 0;
        let countCumple = 0;
        let countNoCumple = 0;
        let countNA = 0;

        items.forEach(item => {
            if (item.esNA) {
                countNA++;
            } else {
                posible += 2;
                if(item.calificacion === 2) {
                    obtenido += 2;
                    countCumple++;
                } else {
                    countNoCumple++;
                }
            }
        });

        const porcentaje = posible > 0 ? ((obtenido / posible) * 100).toFixed(2) : 0;
        
        let concepto = 'DESFAVORABLE';
        if (porcentaje > 85) concepto = 'FAVORABLE';
        else if (porcentaje >= 65) concepto = 'FAVORABLE CONDICIONADO';

        setResultados({ obtenido, posible, porcentaje, concepto, countCumple, countNoCumple, countNA });
    };

    const handleItemChange = (index, field, value) => {
        const newItems = [...items];
        newItems[index][field] = value;
        if(field === 'esNA' && value === true) newItems[index].calificacion = 0; 
        setItems(newItems);
    };

    const handleDeleteItem = (index) => {
        const newItems = items.filter((_, i) => i !== index);
        setItems(newItems);
    };

    const handleAddItem = () => {
        Swal.fire({
            title: 'Nuevo Criterio',
            input: 'text',
            inputLabel: 'Escribe la pregunta o criterio a evaluar',
            showCancelButton: true,
            confirmButtonColor: CORPORATE_BLUE
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                setItems([...items, { id: Date.now(), pregunta: result.value, calificacion: 0, esNA: false, observacion: '' }]);
            }
        });
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!header.empresa) return Swal.fire('Error', 'Debe seleccionar un Proveedor', 'error');

        const formData = new FormData();
        Object.keys(header).forEach(key => formData.append(key, header[key]));
        
        formData.append('puntajeObtenido', resultados.obtenido);
        formData.append('puntajePosible', resultados.posible);
        formData.append('porcentajeFinal', resultados.porcentaje);
        formData.append('conceptoFinal', resultados.concepto);
        formData.append('items', JSON.stringify(items));

        try {
            // --- CORRECCI√ìN CLAVE: USAMOS apiFetch ---
            // apiFetch maneja el token, la URL base y detecta que es FormData autom√°ticamente
            await apiFetch('/proveedores', {
                method: 'POST',
                body: formData
            });

            Swal.fire({
                title: 'Guardado', 
                text: `Auditor√≠a registrada con concepto: ${resultados.concepto}`, 
                icon: 'success',
                confirmButtonColor: CORPORATE_BLUE
            });
            onSaveSuccess();

        } catch (error) {
            console.error(error);
            Swal.fire('Error', error.message || 'Fallo de conexi√≥n', 'error');
        }
    };

    return (
        <div className="fade-in" style={{background: '#f8fafc', padding: '20px', borderRadius: '8px'}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px'}}>
                <h2 style={{color: CORPORATE_BLUE, margin:0}}>Nueva Auditor√≠a de Proveedor</h2>
                <button onClick={onCancel} className="btn-secondary"><FaArrowLeft/> Volver</button>
            </div>

            <form onSubmit={handleSubmit}>
                {/* 1. CABECERA */}
                <div className="card-section" style={{background:'white', padding:'20px', borderRadius:'10px', marginBottom:'20px', boxShadow:'0 2px 4px rgba(0,0,0,0.05)'}}>
                     <h3 style={{color:'#64748b', fontSize:'1rem', marginBottom:'15px', borderBottom:'1px solid #e2e8f0', paddingBottom:'5px'}}>Datos del Proveedor</h3>
                     
                     <div className="form-grid" style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                        
                        {/* --- BUSCADOR INTELIGENTE --- */}
                        <div className="form-group" style={{position: 'relative'}}>
                            <label>Proveedor (ERP) *</label>
                            <input 
                                type="text" 
                                className="form-control"
                                placeholder="Buscar proveedor..."
                                value={header.empresa} 
                                onChange={(e) => {
                                    setHeader({...header, empresa: e.target.value});
                                    setSearchProveedor(e.target.value); 
                                    setShowProvList(true);
                                }}
                                onFocus={() => setShowProvList(true)}
                                onBlur={() => setTimeout(() => setShowProvList(false), 200)}
                            />
                            {showProvList && (
                                <div style={{
                                    position: 'absolute', top: '100%', left: 0, width: '100%', maxHeight: '200px', 
                                    overflowY: 'auto', background: 'white', border: '1px solid #cbd5e1', 
                                    borderRadius: '0 0 8px 8px', zIndex: 100, boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)'
                                }}>
                                    {proveedoresList
                                        .filter(p => p.nombre.toLowerCase().includes((searchProveedor || '').toLowerCase()))
                                        .slice(0, 50)
                                        .map(p => (
                                            <div 
                                                key={p.codigo}
                                                onClick={() => {
                                                    setHeader({...header, empresa: p.nombre});
                                                    setSearchProveedor(p.nombre);
                                                    setShowProvList(false);
                                                }}
                                                style={{padding: '10px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '0.9rem'}}
                                                onMouseEnter={(e) => e.target.style.background = '#f0f9ff'}
                                                onMouseLeave={(e) => e.target.style.background = 'white'}
                                            >
                                                {p.nombre}
                                            </div>
                                        ))}
                                    {proveedoresList.filter(p => p.nombre.toLowerCase().includes((searchProveedor || '').toLowerCase())).length === 0 && (
                                        <div style={{padding:'10px', color:'#94a3b8', fontSize:'0.8rem'}}>No hay coincidencias</div>
                                    )}
                                </div>
                            )}
                        </div>
                        {/* ----------------------------- */}

                        <div className="form-group"><label>Ciudad</label><input className="form-control" value={header.ciudad} onChange={e=>setHeader({...header, ciudad:e.target.value})} /></div>
                        <div className="form-group"><label>Producto / Insumo</label><input className="form-control" value={header.producto} onChange={e=>setHeader({...header, producto:e.target.value})} /></div>
                        <div className="form-group"><label>Registro Sanitario</label><input className="form-control" value={header.registroSanitario} onChange={e=>setHeader({...header, registroSanitario:e.target.value})} /></div>
                     </div>
                </div>

                {/* 2. TABLA */}
                <div className="card-section" style={{background:'white', padding:'20px', borderRadius:'10px', marginBottom:'20px', boxShadow:'0 2px 4px rgba(0,0,0,0.05)'}}>
                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                        <h3 style={{color:'#64748b', fontSize:'1rem'}}>Lista de Verificaci√≥n</h3>
                        <button type="button" onClick={handleAddItem} className="btn-primary" style={{backgroundColor: CORPORATE_BLUE, padding:'5px 10px', fontSize:'0.8rem'}}><FaPlus/> Item</button>
                    </div>
                    <div className="table-container" style={{maxHeight:'500px', overflowY:'auto'}}>
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th style={{width:'50%'}}>Criterio</th><th>Estado</th><th>N/A</th><th>Observaci√≥n</th><th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.map((item, index) => (
                                    <tr key={index}>
                                        <td><textarea rows="2" className="form-control" value={item.pregunta} onChange={(e) => handleItemChange(index, 'pregunta', e.target.value)} style={{resize:'vertical', fontSize:'0.9rem'}}/></td>
                                        <td>
                                            <select className="form-control" disabled={item.esNA} value={item.calificacion} onChange={(e) => handleItemChange(index, 'calificacion', parseInt(e.target.value))}
                                                style={{borderColor: item.esNA ? '#e2e8f0' : (item.calificacion === 2 ? '#22c55e' : '#ef4444'), color: item.esNA ? '#94a3b8' : (item.calificacion === 2 ? '#15803d' : '#b91c1c'), fontWeight: 'bold'}}>
                                                <option value={0}>NO CUMPLE</option><option value={2}>CUMPLE</option>
                                            </select>
                                        </td>
                                        <td style={{textAlign:'center'}}><input type="checkbox" checked={item.esNA} onChange={(e) => handleItemChange(index, 'esNA', e.target.checked)} style={{width:'18px', height:'18px'}}/></td>
                                        <td><input className="form-control" value={item.observacion} onChange={(e) => handleItemChange(index, 'observacion', e.target.value)}/></td>
                                        <td style={{textAlign:'center'}}><button type="button" onClick={() => handleDeleteItem(index)} style={{color:'#ef4444', background:'none', border:'none'}}><FaTrash/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* 3. FOOTER Y RESULTADOS */}
                <div style={{display:'flex', gap:'20px', flexWrap:'wrap', alignItems:'flex-start'}}>
                    
                    {/* Panel Izquierdo: Cierre */}
                    <div style={{flex:1, background:'white', padding:'20px', borderRadius:'10px', boxShadow:'0 2px 4px rgba(0,0,0,0.05)'}}>
                        <h3 style={{fontSize:'1rem', color:'#64748b'}}>Cierre de Auditor√≠a</h3>
                        <div className="form-group"><label>Observaciones Generales</label><textarea className="form-control" rows="3" value={header.observaciones} onChange={e=>setHeader({...header, observaciones:e.target.value})}></textarea></div>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'15px', marginTop:'10px'}}>
                            <div className="form-group"><label>Auditor</label><input className="form-control" value={header.realizadoPor} onChange={e=>setHeader({...header, realizadoPor:e.target.value})} /></div>
                            <div className="form-group"><label>Proveedor</label><input className="form-control" value={header.recibidoPor} onChange={e=>setHeader({...header, recibidoPor:e.target.value})} /></div>
                        </div>
                    </div>

                    {/* Panel Derecho: Resultados Visuales */}
                    <div style={{width:'320px', background: CORPORATE_BLUE, color:'white', padding:'25px', borderRadius:'12px', boxShadow:'0 10px 15px -3px rgba(0, 0, 0, 0.1)'}}>
                        <h3 style={{marginTop:0, borderBottom:'1px solid rgba(255,255,255,0.2)', paddingBottom:'10px', textAlign:'center'}}>Resultado Final</h3>
                        
                        {/* Contadores */}
                        <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px', marginTop:'15px'}}>
                            <div style={{textAlign:'center'}}><div style={{fontSize:'1.5rem', fontWeight:'bold', color:'#86efac'}}>{resultados.countCumple}</div><div style={{fontSize:'0.7rem', opacity:0.8}}><FaCheckCircle/> CUMPLE</div></div>
                            <div style={{textAlign:'center'}}><div style={{fontSize:'1.5rem', fontWeight:'bold', color:'#fca5a5'}}>{resultados.countNoCumple}</div><div style={{fontSize:'0.7rem', opacity:0.8}}><FaTimesCircle/> NO CUMPLE</div></div>
                            <div style={{textAlign:'center'}}><div style={{fontSize:'1.5rem', fontWeight:'bold', color:'#cbd5e1'}}>{resultados.countNA}</div><div style={{fontSize:'0.7rem', opacity:0.8}}><FaBan/> N/A</div></div>
                        </div>
                        
                        {/* Porcentaje */}
                        <div style={{fontSize:'3rem', fontWeight:'bold', textAlign:'center', margin:'10px 0'}}>{resultados.porcentaje}%</div>
                        
                        {/* Badge de Estado */}
                        <div style={{textAlign:'center', padding:'8px', borderRadius:'6px', fontWeight:'bold', textTransform:'uppercase', background: resultados.concepto === 'FAVORABLE' ? '#22c55e' : (resultados.concepto === 'DESFAVORABLE' ? '#ef4444' : '#f59e0b'), color: 'white', boxShadow: '0 4px 6px rgba(0,0,0,0.1)'}}>
                            {resultados.concepto}
                        </div>

                        {/* --- ESCALA DE CALIFICACI√ìN --- */}
                        <div style={{marginTop:'20px', fontSize:'0.75rem', background:'rgba(255,255,255,0.1)', padding:'15px', borderRadius:'8px'}}>
                            <div style={{marginBottom:'8px', fontWeight:'bold', display:'flex', alignItems:'center', gap:'5px', borderBottom:'1px solid rgba(255,255,255,0.2)', paddingBottom:'4px'}}>
                                <FaInfoCircle /> Escala de Calificaci√≥n
                            </div>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'4px'}}>
                                <span>0% - 64%</span> <span style={{color:'#fca5a5', fontWeight:'bold'}}>Desfavorable</span>
                            </div>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'4px'}}>
                                <span>65% - 85%</span> <span style={{color:'#fcd34d', fontWeight:'bold'}}>Condicionado</span>
                            </div>
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span>{'>'} 85%</span> <span style={{color:'#86efac', fontWeight:'bold'}}>Favorable</span>
                            </div>
                        </div>

                        <button type="submit" className="btn-primary" style={{marginTop:'25px', background:'white', color: CORPORATE_BLUE, border:'none', width:'100%', fontWeight:'bold', padding:'12px'}}>
                            <FaSave style={{marginRight:'5px'}}/> GUARDAR AUDITOR√çA
                        </button>
                    </div>
                </div>
            </form>
        </div>
    );
};

export default AuditoriaProveedor;


==================================================================
ARCHIVO: frontend\src\pages\admin\BitacoraGlobal.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getBitacora } from '../../services/auditGlobalService';
import '../../styles/Tables.css';
import { FaShieldAlt, FaSearch } from 'react-icons/fa';

const BitacoraGlobal = () => {
    const [logs, setLogs] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        cargarLogs();
    }, []);

    const cargarLogs = async () => {
        try {
            const data = await getBitacora();
            setLogs(data);
        } catch (error) {
            console.error(error);
        } finally {
            setLoading(false);
        }
    };

    const filteredLogs = logs.filter(log => 
        log.Usuario_Responsable.toLowerCase().includes(searchTerm.toLowerCase()) ||
        log.Detalle.toLowerCase().includes(searchTerm.toLowerCase()) ||
        log.Accion.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div>
            <div className="page-header">
                <div>
                    <h1 className="page-title"><FaShieldAlt /> Bit√°cora de Seguridad</h1>
                    <p style={{color:'#64748b'}}>Historial de movimientos cr√≠ticos del sistema.</p>
                </div>
            </div>

            <div className="filters-bar">
                <div className="search-input-container" style={{width:'100%'}}>
                    <FaSearch />
                    <input 
                        type="text" 
                        placeholder="Buscar por usuario, acci√≥n o detalle..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>
            </div>

            <div className="table-container">
                <table className="data-table" style={{fontSize:'0.9rem'}}>
                    <thead>
                        <tr>
                            <th>Fecha / Hora</th>
                            <th>Responsable</th>
                            <th>Rol</th>
                            <th>Acci√≥n</th>
                            <th>M√≥dulo</th>
                            <th>Detalle del Evento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>Cargando Bit√°cora...</td></tr>
                        ) : filteredLogs.map(log => (
                            <tr key={log.ID_Log}>
                                <td style={{whiteSpace:'nowrap', color:'#64748b'}}>
                                    {/* CORRECCI√ìN DE HORA: timeZone: 'UTC' */}
                                    {new Date(log.Fecha).toLocaleString('es-CO', { timeZone: 'UTC' })}
                                </td>
                                <td style={{fontWeight:'bold'}}>{log.Usuario_Responsable}</td>
                                <td>
                                    <span style={{fontSize:'0.75rem', padding:'2px 6px', borderRadius:'4px', background:'#e2e8f0'}}>
                                        {log.Rol_Responsable}
                                    </span>
                                </td>
                                <td>
                                    <span className={`badge ${
                                        log.Accion === 'CREAR' ? 'badge-success' : 
                                        log.Accion === 'ELIMINAR' ? 'badge-danger' : 
                                        log.Accion === 'LOGIN' ? 'status-pendiente' : 
                                        'badge-warning'
                                    }`} style={log.Accion === 'LOGIN' ? {background:'#eff6ff', color:'#1d4ed8', border:'1px solid #bfdbfe'} : {}}>
                                        {log.Accion}
                                    </span>
                                </td>
                                <td style={{fontWeight:'600', color:'#475569'}}>{log.Modulo}</td>
                                <td style={{maxWidth:'400px'}}>{log.Detalle}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

export default BitacoraGlobal;


==================================================================
ARCHIVO: frontend\src\pages\admin\ControlPesos.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';
import { getListasExternas } from '../../services/externosService'; 
import ModalHistorialPesos from '../../components/modals/ModalHistorialPesos'; 
import '../../styles/Dashboard.css'; 
import { 
    FaBalanceScale, FaArrowRight, FaSave, FaArrowLeft, 
    FaCalculator, FaThermometerHalf, FaBoxOpen, FaHistory,
    FaCheckSquare, FaFileUpload, FaCamera, FaTimesCircle, FaCheckCircle
} from 'react-icons/fa';

const ControlPesos = () => {
    const [step, setStep] = useState(1);
    const [showHistory, setShowHistory] = useState(false);
    
    // --- ESTADOS PARA BUSCADOR PROVEEDORES ---
    const [searchProveedor, setSearchProveedor] = useState('');
    const [showProvList, setShowProvList] = useState(false);

    // --- ESTADO PARA LISTAS EXTERNAS ---
    const [listas, setListas] = useState({
        productos: [],
        proveedores: [],
        maquinistas: [],
        selladores: []
    });

    // Cargar listas al iniciar
    useEffect(() => {
        const cargarDatos = async () => {
            const data = await getListasExternas();
            setListas(data);
        };
        cargarDatos();
    }, []);

    // --- CONFIGURACI√ìN DEL FORMULARIO ---
    const [config, setConfig] = useState({
        lote: '', fechaVencimiento: '', producto: '', pesoNominal: '', 
        proveedor: '', maquinista: '', sellador: '',
        nombreLamina: '', golpesMinuto: '', 
        tempVertical: '', tempHorizSup: '', tempHorizInf: '',
        loteMP: '', loteLamina: '',
        limiteInferior: '', limiteSuperior: '',
        // NUEVOS CAMPOS DE SELLADO (Por defecto true = Cumple)
        selladoInferior: true, 
        selladoSuperior: true,
        selladoVertical: true,
        selladoLoteado: true
    });

    // Estado separado para el archivo
    const [evidenciaFile, setEvidenciaFile] = useState(null);

    const [muestras, setMuestras] = useState(
        Array.from({ length: 50 }, (_, i) => ({ index: i + 1, peso: '' }))
    );

    // Manejo gen√©rico para inputs de texto y fecha
    const handleChangeConfig = (e) => {
        const { name, value } = e.target;
        setConfig(prev => ({ ...prev, [name]: value }));
    };

    // --- NUEVO: MANEJO PARA LOS SELECTS DE SELLADO (Booleans) ---
    const handleBooleanChange = (e) => {
        const { name, value } = e.target;
        // El value viene como string "true" o "false", lo convertimos a boolean real
        setConfig(prev => ({ 
            ...prev, 
            [name]: value === 'true' 
        }));
    };

    // Manejo del archivo
    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            setEvidenciaFile(e.target.files[0]);
        }
    };

    // --- MANEJO INTELIGENTE: PRODUCTO -> PESO AUTOM√ÅTICO ---
    const handleProductoChange = (e) => {
        const nombreSeleccionado = e.target.value;
        const productoEncontrado = listas.productos.find(p => p.descripcion === nombreSeleccionado);
        
        if (productoEncontrado) {
            setConfig(prev => ({
                ...prev,
                producto: productoEncontrado.descripcion, 
                pesoNominal: productoEncontrado.peso || '' 
            }));
        } else {
            setConfig(prev => ({ ...prev, producto: '', pesoNominal: '' }));
        }
    };

    // --- VALIDACIONES PASO 1 ---
    const validateStep1 = () => {
        const { lote, producto, pesoNominal, limiteInferior, limiteSuperior, loteMP, loteLamina } = config;
        
        if(!lote || !producto || !pesoNominal || !limiteInferior || !limiteSuperior || !loteMP || !loteLamina) {
            Swal.fire('Campos Incompletos', 'Por favor complete todos los campos obligatorios (*).', 'warning');
            return false;
        }

        const pNom = parseFloat(pesoNominal);
        const pMin = parseFloat(limiteInferior);
        const pMax = parseFloat(limiteSuperior);

        if (pMin >= pNom) {
            Swal.fire('Error en L√≠mites', 'El l√≠mite INFERIOR no puede ser mayor o igual al peso inicial.', 'error');
            return false;
        }
        if (pMax <= pNom) {
            Swal.fire('Error en L√≠mites', 'El l√≠mite SUPERIOR no puede ser menor o igual al peso inicial.', 'error');
            return false;
        }

        // Advertencia si hay fallas de sellado pero no se subi√≥ foto
        const hayFallaSellado = (!config.selladoInferior || !config.selladoSuperior || !config.selladoVertical || !config.selladoLoteado);
        if (hayFallaSellado && !evidenciaFile) {
            Swal.fire('Advertencia', 'Ha reportado fallas de sellado ("NO CUMPLE"). Se recomienda adjuntar una foto como evidencia.', 'info');
        }

        return true;
    };

    const nextStep = () => {
        if(validateStep1()) setStep(2);
    };

    // --- MANEJO DE MUESTRAS (GRID) ---
    const handlePesoChange = (index, valor) => {
        const nuevasMuestras = muestras.map((muestra, i) => {
            if (i === index) return { ...muestra, peso: valor };
            return muestra;
        });
        setMuestras(nuevasMuestras);
    };

    const getStatusColor = (valor) => {
        if (valor === '') return '#e2e8f0';
        const num = parseFloat(valor);
        const min = parseFloat(config.limiteInferior);
        const max = parseFloat(config.limiteSuperior);
        if (num >= min && num <= max) return '#22c55e'; 
        return '#ef4444';
    };

    const getStats = () => {
        const llenos = muestras.filter(m => m.peso !== '');
        const total = llenos.length;
        if(total === 0) return { promedio: 0, ok: 0, fail: 0, total: 0 };
        const valores = llenos.map(m => parseFloat(m.peso));
        const sum = valores.reduce((a, b) => a + b, 0);
        const promedio = (sum / total).toFixed(2);
        const min = parseFloat(config.limiteInferior);
        const max = parseFloat(config.limiteSuperior);
        const ok = valores.filter(v => v >= min && v <= max).length;
        const fail = total - ok;
        return { promedio, ok, fail, total };
    };

    const stats = getStats();

    // --- ENVIAR DATOS (FORM DATA PARA ARCHIVOS) ---
    const handleSubmit = async () => {
        const vacios = muestras.filter(m => m.peso === '').length;
        if(vacios > 0) {
            const result = await Swal.fire({
                title: '¬øGuardar incompleto?',
                text: `Faltan ${vacios} muestras. ¬øDesea guardar de todos modos?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S√≠, Guardar',
                cancelButtonText: 'Seguir Editando'
            });
            if(!result.isConfirmed) return;
        }

        try {
            // 1. Convertir muestras
            const muestrasFinales = muestras.map(m => ({
                index: m.index,
                peso: m.peso === '' ? 0 : parseFloat(m.peso)
            }));

            // 2. Limpiar cabecera
            const cabeceraLimpia = {
                ...config,
                pesoNominal: config.pesoNominal ? parseFloat(config.pesoNominal) : 0,
                limiteInferior: config.limiteInferior ? parseFloat(config.limiteInferior) : 0,
                limiteSuperior: config.limiteSuperior ? parseFloat(config.limiteSuperior) : 0,
                golpesMinuto: config.golpesMinuto ? parseInt(config.golpesMinuto) : 0,
                tempVertical: config.tempVertical ? parseFloat(config.tempVertical) : 0,
                tempHorizSup: config.tempHorizSup ? parseFloat(config.tempHorizSup) : 0,
                tempHorizInf: config.tempHorizInf ? parseFloat(config.tempHorizInf) : 0,
            };

            // 3. Crear FormData
            const formData = new FormData();
            formData.append('cabecera', JSON.stringify(cabeceraLimpia));
            formData.append('muestras', JSON.stringify(muestrasFinales));
            if (evidenciaFile) {
                formData.append('evidencia', evidenciaFile);
            }

            // 4. Headers especiales
            const headers = getAuthHeaders();
            delete headers['Content-Type']; 

            const response = await fetch(`${API_URL}/pesos`, {
                method: 'POST',
                headers: headers,
                body: formData
            });

            const data = await response.json();

            if(response.ok) {
                Swal.fire({
                    title: '¬°Registrado!',
                    text: `Control #${data.id} guardado exitosamente.`,
                    icon: 'success',
                    confirmButtonColor: '#0c4760'
                });
                
                // Reiniciar todo
                setStep(1);
                setMuestras(Array.from({ length: 50 }, (_, i) => ({ index: i + 1, peso: '' })));
                setConfig({
                    lote: '', fechaVencimiento: '', producto: '', pesoNominal: '', 
                    proveedor: '', maquinista: '', sellador: '',
                    nombreLamina: '', golpesMinuto: '', 
                    tempVertical: '', tempHorizSup: '', tempHorizInf: '',
                    loteMP: '', loteLamina: '',
                    limiteInferior: '', limiteSuperior: '',
                    selladoInferior: true, selladoSuperior: true,
                    selladoVertical: true, selladoLoteado: true
                });
                setEvidenciaFile(null);
                setSearchProveedor('');
            } else {
                Swal.fire('Error', data.mensaje || 'No se pudo guardar.', 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Fallo de conexi√≥n.', 'error');
        }
    };

    return (
        <div className="fade-in" style={{padding:'20px', maxWidth:'1200px', margin:'0 auto'}}>
            
            {/* ENCABEZADO */}
            <div style={{marginBottom:'20px', borderBottom:'2px solid #e2e8f0', paddingBottom:'15px', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                <div>
                    <h1 style={{fontSize:'1.8rem', color:'#1e293b', margin:0, display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaBalanceScale style={{color:'#0c4760'}}/> Control de Pesos
                    </h1>
                    <p style={{color:'#64748b', margin:'5px 0 0 0'}}>Verificaci√≥n de peso en l√≠nea (50 muestras)</p>
                </div>
                <div style={{display:'flex', gap:'10px'}}>
                    <button className="btn-secondary" onClick={() => setShowHistory(true)} style={{display:'flex', alignItems:'center', gap:'8px', padding:'8px 15px', fontWeight:'600'}}>
                        <FaHistory /> Ver Historial
                    </button>
                    <div style={{background:'#e0f2fe', padding:'8px 20px', borderRadius:'30px', fontWeight:'bold', color:'#0369a1', border:'1px solid #bae6fd'}}>
                        Paso {step} / 2
                    </div>
                </div>
            </div>

            {/* --- PASO 1: CONFIGURACI√ìN --- */}
            {step === 1 && (
                <div className="fade-in" style={{background:'white', padding:'30px', borderRadius:'15px', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}}>
                    
                    <h3 style={{color:'#0f172a', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px', marginTop:0}}>Configuraci√≥n del Lote</h3>

                    <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'25px', marginBottom:'30px'}}>
                        <div className="form-group">
                            <label>Lote Producci√≥n *</label>
                            <input className="form-control" name="lote" value={config.lote} onChange={handleChangeConfig} autoFocus />
                        </div>
                        <div className="form-group">
                            <label>Producto *</label>
                            <select className="form-control" name="producto" value={config.producto} onChange={handleProductoChange}>
                                <option value="">-- Seleccionar --</option>
                                {listas.productos.map(p => (
                                    <option key={p.codigo} value={p.descripcion}>{p.descripcion}</option>
                                ))}
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Fecha Vencimiento *</label>
                            <input type="date" className="form-control" name="fechaVencimiento" value={config.fechaVencimiento} onChange={handleChangeConfig} />
                        </div>
                        <div className="form-group">
                            <label>Peso Inicial / Nominal (g) *</label>
                            <input type="number" step="0.01" className="form-control" name="pesoNominal" value={config.pesoNominal} onChange={handleChangeConfig} placeholder="Autom√°tico o Manual" />
                        </div>
                    </div>

                    {/* TRAZABILIDAD */}
                    <h4 style={{color:'#475569', display:'flex', alignItems:'center', gap:'10px', marginTop:'0'}}><FaBoxOpen /> Trazabilidad de Materiales</h4>
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'20px', marginBottom:'30px', background:'#f8fafc', padding:'15px', borderRadius:'8px', border:'1px solid #e2e8f0'}}>
                        <div className="form-group"><label>Lote Materia Prima (MP) *</label><input className="form-control" name="loteMP" value={config.loteMP} onChange={handleChangeConfig} /></div>
                        <div className="form-group"><label>Lote L√°mina / Empaque *</label><input className="form-control" name="loteLamina" value={config.loteLamina} onChange={handleChangeConfig} /></div>
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'20px', marginBottom:'30px'}}>
                        {/* BUSCADOR PROVEEDOR */}
                        <div className="form-group" style={{position: 'relative'}}>
                            <label>Proveedor (L√°mina/MP) *</label>
                            <input type="text" className="form-control" placeholder="Escriba para buscar..." value={config.proveedor} 
                                onChange={(e) => {setConfig({...config, proveedor: e.target.value}); setSearchProveedor(e.target.value); setShowProvList(true);}}
                                onFocus={() => setShowProvList(true)} onBlur={() => setTimeout(() => setShowProvList(false), 200)} 
                            />
                            {showProvList && (
                                <div style={{position: 'absolute', top: '100%', left: 0, width: '100%', maxHeight: '200px', overflowY: 'auto', background: 'white', border: '1px solid #cbd5e1', borderRadius: '0 0 8px 8px', zIndex: 100, boxShadow: '0 4px 6px -1px rgba(0,0,0,0.1)'}}>
                                    {listas.proveedores.filter(p => p.nombre.toLowerCase().includes((searchProveedor || '').toLowerCase())).slice(0, 50).map(p => (
                                        <div key={p.codigo} onClick={() => {setConfig({...config, proveedor: p.nombre}); setSearchProveedor(p.nombre); setShowProvList(false);}}
                                            style={{padding: '10px', cursor: 'pointer', borderBottom: '1px solid #f1f5f9', fontSize: '0.9rem'}} onMouseEnter={(e) => e.target.style.background = '#f0f9ff'} onMouseLeave={(e) => e.target.style.background = 'white'}>
                                            {p.nombre}
                                        </div>
                                    ))}
                                    {listas.proveedores.filter(p => p.nombre.toLowerCase().includes((searchProveedor || '').toLowerCase())).length === 0 && <div style={{padding:'10px', color:'#94a3b8', fontSize:'0.8rem'}}>No hay coincidencias</div>}
                                </div>
                            )}
                        </div>
                        
                        <div className="form-group">
                            <label>Maquinista</label>
                            <select className="form-control" name="maquinista" value={config.maquinista} onChange={handleChangeConfig}>
                                <option value="">-- Seleccionar --</option>{listas.maquinistas.map(m => (<option key={m.id} value={m.nombre}>{m.nombre}</option>))}
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Sellador</label>
                            <select className="form-control" name="sellador" value={config.sellador} onChange={handleChangeConfig}>
                                <option value="">-- Seleccionar --</option>{listas.selladores.map(s => (<option key={s.id} value={s.nombre}>{s.nombre}</option>))}
                            </select>
                        </div>
                        <div className="form-group"><label>Nombre L√°mina</label><input className="form-control" name="nombreLamina" value={config.nombreLamina} onChange={handleChangeConfig} /></div>
                    </div>

                    {/* DATOS T√âCNICOS */}
                    <h4 style={{color:'#475569', display:'flex', alignItems:'center', gap:'10px', marginTop:'0'}}><FaThermometerHalf /> Par√°metros de M√°quina</h4>
                    <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'15px', background:'#f8fafc', padding:'20px', borderRadius:'10px', border:'1px solid #e2e8f0', marginBottom:'30px'}}>
                        <div className="form-group"><label>Golpes/Min</label><input type="number" className="form-control" name="golpesMinuto" value={config.golpesMinuto} onChange={handleChangeConfig} /></div>
                        <div className="form-group"><label>Temp. Vertical</label><input type="number" className="form-control" name="tempVertical" value={config.tempVertical} onChange={handleChangeConfig} /></div>
                        <div className="form-group"><label>Temp. Horiz. Sup</label><input type="number" className="form-control" name="tempHorizSup" value={config.tempHorizSup} onChange={handleChangeConfig} /></div>
                        <div className="form-group"><label>Temp. Horiz. Inf</label><input type="number" className="form-control" name="tempHorizInf" value={config.tempHorizInf} onChange={handleChangeConfig} /></div>
                    </div>

                    {/* --- NUEVO: VERIFICACI√ìN DE SELLADO (TIPO SELECT) --- */}
                    <h4 style={{color:'#475569', display:'flex', alignItems:'center', gap:'10px', marginTop:'0'}}>
                        <FaCheckSquare /> Verificaci√≥n de Sellado
                    </h4>
                    <div style={{
                        display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'15px', 
                        background:'#f0fdf4', padding:'20px', borderRadius:'10px', border:'1px solid #86efac', marginBottom:'30px'
                    }}>
                        <div className="form-group">
                            <label>Sellado Inferior</label>
                            <select 
                                name="selladoInferior" 
                                className="form-control" 
                                value={config.selladoInferior.toString()} 
                                onChange={handleBooleanChange}
                                style={{
                                    borderColor: config.selladoInferior ? '#22c55e' : '#ef4444', 
                                    color: config.selladoInferior ? '#15803d' : '#b91c1c',
                                    fontWeight: 'bold',
                                    backgroundColor: config.selladoInferior ? '#f0fdf4' : '#fef2f2'
                                }}
                            >
                                <option value="true">CUMPLE</option>
                                <option value="false">NO CUMPLE</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Sellado Superior</label>
                            <select 
                                name="selladoSuperior" 
                                className="form-control" 
                                value={config.selladoSuperior.toString()} 
                                onChange={handleBooleanChange}
                                style={{
                                    borderColor: config.selladoSuperior ? '#22c55e' : '#ef4444', 
                                    color: config.selladoSuperior ? '#15803d' : '#b91c1c',
                                    fontWeight: 'bold',
                                    backgroundColor: config.selladoSuperior ? '#f0fdf4' : '#fef2f2'
                                }}
                            >
                                <option value="true">CUMPLE</option>
                                <option value="false">NO CUMPLE</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Sellado Vertical</label>
                            <select 
                                name="selladoVertical" 
                                className="form-control" 
                                value={config.selladoVertical.toString()} 
                                onChange={handleBooleanChange}
                                style={{
                                    borderColor: config.selladoVertical ? '#22c55e' : '#ef4444', 
                                    color: config.selladoVertical ? '#15803d' : '#b91c1c',
                                    fontWeight: 'bold',
                                    backgroundColor: config.selladoVertical ? '#f0fdf4' : '#fef2f2'
                                }}
                            >
                                <option value="true">CUMPLE</option>
                                <option value="false">NO CUMPLE</option>
                            </select>
                        </div>
                        <div className="form-group">
                            <label>Loteado Legible</label>
                            <select 
                                name="selladoLoteado" 
                                className="form-control" 
                                value={config.selladoLoteado.toString()} 
                                onChange={handleBooleanChange}
                                style={{
                                    borderColor: config.selladoLoteado ? '#22c55e' : '#ef4444', 
                                    color: config.selladoLoteado ? '#15803d' : '#b91c1c',
                                    fontWeight: 'bold',
                                    backgroundColor: config.selladoLoteado ? '#f0fdf4' : '#fef2f2'
                                }}
                            >
                                <option value="true">CUMPLE</option>
                                <option value="false">NO CUMPLE</option>
                            </select>
                        </div>
                    </div>

                    {/* --- NUEVO: EVIDENCIA --- */}
                    <div className="form-group" style={{marginBottom:'30px'}}>
                        <label style={{display:'flex', alignItems:'center', gap:'10px', fontSize:'1rem', fontWeight:'bold', color:'#334155', marginBottom:'10px'}}>
                            <FaCamera /> Adjuntar Evidencia (Foto/Documento)
                        </label>
                        <div style={{display:'flex', alignItems:'center', gap:'15px'}}>
                            <label className="btn-secondary" style={{cursor:'pointer', display:'flex', alignItems:'center', gap:'8px'}}>
                                <FaFileUpload /> Seleccionar Archivo
                                <input type="file" onChange={handleFileChange} style={{display:'none'}} accept="image/*,.pdf" />
                            </label>
                            {evidenciaFile && <span style={{color:'#0c4760', fontWeight:'bold'}}>{evidenciaFile.name}</span>}
                        </div>
                        <small style={{color:'#64748b'}}>Opcional. Recomendado si hay fallas de sellado o peso.</small>
                    </div>
                    {/* --------------------------- */}

                    {/* L√çMITES */}
                    <div style={{background:'#fff7ed', padding:'20px', borderRadius:'10px', border:'1px dashed #fdba74'}}>
                        <h4 style={{marginTop:0, color:'#c2410c', display:'flex', alignItems:'center', gap:'10px'}}><FaCalculator /> L√≠mites de Control</h4>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'30px'}}>
                            <div className="form-group">
                                <label style={{color:'#dc2626', fontWeight:'bold'}}>L√≠mite Inferior (M√≠nimo)</label>
                                <input type="number" step="0.01" className="form-control" name="limiteInferior" value={config.limiteInferior} onChange={handleChangeConfig} style={{border:'2px solid #fca5a5'}} />
                            </div>
                            <div className="form-group">
                                <label style={{color:'#dc2626', fontWeight:'bold'}}>L√≠mite Superior (M√°ximo)</label>
                                <input type="number" step="0.01" className="form-control" name="limiteSuperior" value={config.limiteSuperior} onChange={handleChangeConfig} style={{border:'2px solid #fca5a5'}} />
                            </div>
                        </div>
                    </div>

                    <div style={{display:'flex', justifyContent:'flex-end', marginTop:'30px'}}>
                        <button className="btn-primary" onClick={nextStep} style={{padding:'12px 35px', fontSize:'1.1rem'}}>
                            Comenzar Muestreo <FaArrowRight style={{marginLeft:'10px'}}/>
                        </button>
                    </div>
                </div>
            )}

            {/* --- PASO 2: MUESTREO (Igual que antes) --- */}
            {step === 2 && (
                <div className="fade-in">
                    <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))', gap:'15px', marginBottom:'25px'}}>
                        <div style={{background:'white', padding:'15px', borderRadius:'10px', textAlign:'center', boxShadow:'0 4px 6px -1px rgba(0,0,0,0.1)'}}>
                            <span style={{fontSize:'0.8rem', color:'#64748b', textTransform:'uppercase', fontWeight:'bold'}}>Promedio</span>
                            <div style={{fontSize:'2rem', color:'#0c4760', fontWeight:'800'}}>{stats.promedio}</div>
                        </div>
                        <div style={{background:'#dcfce7', padding:'15px', borderRadius:'10px', textAlign:'center', border:'1px solid #86efac'}}>
                            <span style={{fontSize:'0.8rem', color:'#166534', textTransform:'uppercase', fontWeight:'bold'}}>Aprobados</span>
                            <div style={{fontSize:'2rem', color:'#15803d', fontWeight:'800'}}>{stats.ok}</div>
                        </div>
                        <div style={{background:'#fee2e2', padding:'15px', borderRadius:'10px', textAlign:'center', border:'1px solid #fca5a5'}}>
                            <span style={{fontSize:'0.8rem', color:'#991b1b', textTransform:'uppercase', fontWeight:'bold'}}>Defectuosos</span>
                            <div style={{fontSize:'2rem', color:'#dc2626', fontWeight:'800'}}>{stats.fail}</div>
                        </div>
                    </div>

                    <div style={{background:'white', padding:'30px', borderRadius:'15px', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}}>
                        <div style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <h3 style={{margin:0, color:'#334155'}}>Ingrese los 50 pesos:</h3>
                            <div style={{fontSize:'0.9rem', color:'#64748b'}}>
                                Rango: <strong style={{color:'#16a34a'}}>{config.limiteInferior}</strong> - <strong style={{color:'#16a34a'}}>{config.limiteSuperior}</strong>
                            </div>
                        </div>

                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(85px, 1fr))', gap:'12px'}}>
                            {muestras.map((m, i) => (
                                <div key={i} style={{position:'relative'}}>
                                    <span style={{position:'absolute', top:'-8px', left:'8px', background:'white', padding:'0 4px', fontSize:'0.75rem', fontWeight:'bold', color:'#94a3b8'}}>#{i+1}</span>
                                    <input type="number" step="0.01" value={m.peso} onChange={(e) => handlePesoChange(i, e.target.value)} style={{width:'100%', padding:'15px 5px', textAlign:'center', borderRadius:'8px', border:'2px solid', outline:'none', fontSize:'1.1rem', fontWeight:'bold', borderColor: getStatusColor(m.peso), color: getStatusColor(m.peso) === '#ef4444' ? '#dc2626' : '#334155', backgroundColor: getStatusColor(m.peso) === '#ef4444' ? '#fef2f2' : (m.peso ? '#f0fdf4' : 'white')}} placeholder="-" />
                                </div>
                            ))}
                        </div>

                        <div style={{display:'flex', justifyContent:'space-between', marginTop:'40px', borderTop:'1px solid #e2e8f0', paddingTop:'20px'}}>
                            <button className="btn-secondary" onClick={() => setStep(1)}><FaArrowLeft style={{marginRight:'5px'}}/> Corregir Configuraci√≥n</button>
                            <button className="btn-primary" onClick={handleSubmit} style={{backgroundColor: stats.fail > 0 ? '#ef4444' : '#0c4760', padding:'12px 40px', fontSize:'1.1rem'}}>
                                <FaSave style={{marginRight:'10px'}}/> {stats.fail > 0 ? 'Guardar con Defectos' : 'Finalizar y Guardar'}
                            </button>
                        </div>
                    </div>
                </div>
            )}

            <ModalHistorialPesos isOpen={showHistory} onClose={() => setShowHistory(false)} />
        </div>
    );
};

export default ControlPesos;


==================================================================
ARCHIVO: frontend\src\pages\admin\CrearReporteAdmin.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getActivos, getFormsByActivo, getPreguntas } from '../../services/coreService';
// Importaci√≥n corregida: usamos el servicio especializado
import { createReporte } from '../../services/reportesService'; 
import Swal from 'sweetalert2';
import { 
    FaIndustry, FaFileSignature, FaCheck, FaTimes, FaArrowLeft, 
    FaCheckCircle, FaCamera, FaSave, FaSearch, FaMapMarkerAlt, FaBarcode, FaFilter
} from 'react-icons/fa';
import '../../styles/Reportes.css';

const CrearReporteAdmin = () => {
    // --- ESTADOS ---
    const [step, setStep] = useState(1);
    const [activos, setActivos] = useState([]);
    const [forms, setForms] = useState([]);
    const [preguntas, setPreguntas] = useState([]);
    
    // --- FILTROS DE ACTIVOS ---
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('Todos');
    const [categories, setCategories] = useState(['Todos']);

    // --- SELECCIONES ---
    const [selectedActivo, setSelectedActivo] = useState(null);
    const [selectedForm, setSelectedForm] = useState(null);
    const [respuestas, setRespuestas] = useState({});
    const [observaciones, setObservaciones] = useState('');
    const [evidenciaFile, setEvidenciaFile] = useState(null);
    const [previewUrl, setPreviewUrl] = useState(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        loadActivos();
    }, []);

    const loadActivos = async () => {
        try {
            const data = await getActivos();
            // Filtramos solo los activos activos (Estado = 1)
            const activosActivos = data.filter(a => a.Estado === true);
            setActivos(activosActivos);

            // Extraer categor√≠as √∫nicas para el filtro
            const uniqueCats = ['Todos', ...new Set(activosActivos.map(a => a.Tipo))];
            setCategories(uniqueCats);

        } catch (error) { console.error(error); }
    };

    // --- FILTRADO EN TIEMPO REAL ---
    const filteredActivos = activos.filter(act => {
        const matchesSearch = 
            act.Nombre.toLowerCase().includes(searchTerm.toLowerCase()) || 
            (act.Codigo && act.Codigo.toLowerCase().includes(searchTerm.toLowerCase()));
        
        const matchesCategory = selectedCategory === 'Todos' || act.Tipo === selectedCategory;

        return matchesSearch && matchesCategory;
    });

    // --- NAVEGACI√ìN ---
    const resetForm = () => {
        setStep(1);
        setSelectedActivo(null);
        setSelectedForm(null);
        setRespuestas({});
        setObservaciones('');
        setEvidenciaFile(null);
        setPreviewUrl(null);
        setSearchTerm('');
    };

    // PASO 1 -> 2: SELECCIONAR ACTIVO
    const handleSelectActivo = async (activo) => {
        setSelectedActivo(activo);
        setLoading(true);
        try {
            const data = await getFormsByActivo(activo.ID_Activo);
            if (!data || data.length === 0) {
                Swal.fire('Sin Formularios', `El activo "${activo.Nombre}" no tiene formularios asignados. Ve a "Gestor de Formularios" para asignarle uno.`, 'info');
                setLoading(false);
                return;
            }
            setForms(data);
            setStep(2);
        } catch (error) { 
            console.error(error);
            setLoading(false);
        } finally { setLoading(false); }
    };

    // PASO 2 -> 3: SELECCIONAR FORMULARIO
    const handleSelectForm = async (form) => {
        setSelectedForm(form);
        setLoading(true);
        try {
            const data = await getPreguntas(form.ID_Formulario);
            setPreguntas(data);
            // Inicializar respuestas
            const initResp = {};
            data.forEach(p => initResp[p.ID_Pregunta] = null); 
            setRespuestas(initResp);
            setStep(3);
        } catch (error) { console.error(error);
        } finally { setLoading(false); }
    };

    const handleAnswer = (idPregunta, valor) => {
        setRespuestas(prev => ({ ...prev, [idPregunta]: valor }));
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            setEvidenciaFile(file);
            setPreviewUrl(URL.createObjectURL(file));
        }
    };

    const handleSubmit = async () => {
        // Validaci√≥n
        const faltantes = preguntas.some(p => {
            const val = respuestas[p.ID_Pregunta];
            if (p.Tipo === 'TEXT') return !val || val.trim() === '';
            return val === null || val === undefined;
        });

        if (faltantes) return Swal.fire('Incompleto', 'Por favor responda todas las preguntas.', 'warning');
        
        setLoading(true);
        
        const formData = new FormData();
        formData.append('idActivo', selectedActivo.ID_Activo);
        formData.append('idFormulario', selectedForm.ID_Formulario);
        formData.append('observaciones', observaciones);
        
        // CONSTRUCCI√ìN DEL JSON ROBUSTA (IGUAL QUE EN REPORTES.JSX)
        const arrayRespuestas = Object.keys(respuestas).map(key => {
            const idPreg = parseInt(key);
            const pregData = preguntas.find(p => p.ID_Pregunta === idPreg);
            const valor = respuestas[key];

            // Aseguramos que el tipo siempre se env√≠e para que el backend valide correctamente
            const tipoSeguro = pregData.Tipo || 'BOOL';

            return {
                idPregunta: idPreg,
                tipo: tipoSeguro,
                // Si es texto, cumple es true por defecto; si es bool, toma el valor real (true/false)
                cumple: tipoSeguro === 'TEXT' ? true : valor,
                respuestaTexto: tipoSeguro === 'TEXT' ? valor : null
            };
        });

        formData.append('respuestas', JSON.stringify(arrayRespuestas));
        if (evidenciaFile) formData.append('evidencia', evidenciaFile);

        try {
            await createReporte(formData);
            Swal.fire({
                title: 'Reporte Creado',
                text: 'La inspecci√≥n ha sido registrada correctamente.',
                icon: 'success',
                confirmButtonColor: '#0c4760'
            });
            resetForm();
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        } finally {
            setLoading(false);
        }
    };

    return (
        <div style={{ padding: '20px' }}>
            <div className="page-header">
                <h1 className="page-title">Generar Nuevo Reporte (Admin)</h1>
            </div>

            <div className="wizard-container" style={{ margin: '0 auto', boxShadow: '0 4px 15px rgba(0,0,0,0.05)' }}>
                {/* Header del Wizard */}
                <div className="wizard-header">
                    <button className="btn-back" onClick={step === 1 ? null : () => setStep(step - 1)} disabled={step === 1} style={{opacity: step===1?0:1}}>
                        <FaArrowLeft /> Atr√°s
                    </button>
                    <div className="step-indicator">Paso {step} de 3</div>
                </div>

                <div className="wizard-body">
                    
                    {/* --- PASO 1: SELECCI√ìN DE ACTIVO --- */}
                    {step === 1 && (
                        <div className="step-content">
                            <h2 style={{textAlign:'center', marginBottom:'1.5rem', color:'#1e293b'}}>
                                ¬øQu√© activo vamos a inspeccionar?
                            </h2>

                            <div className="asset-search-container">
                                <div className="search-bar-large">
                                    <FaSearch className="search-icon-large" />
                                    <input 
                                        type="text" 
                                        placeholder="Buscar por nombre o c√≥digo (ej: MAQ-01)..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        autoFocus
                                    />
                                </div>
                                
                                <div className="category-tabs">
                                    {categories.map(cat => (
                                        <button 
                                            key={cat}
                                            className={`cat-tab ${selectedCategory === cat ? 'active' : ''}`}
                                            onClick={() => setSelectedCategory(cat)}
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid-pro">
                                {filteredActivos.length === 0 ? (
                                    <div className="empty-search">
                                        <FaFilter size={40} style={{color:'#cbd5e1', marginBottom:'10px'}}/>
                                        <p>No se encontraron activos con esos criterios.</p>
                                    </div>
                                ) : (
                                    filteredActivos.map(act => (
                                        <div key={act.ID_Activo} className="card-asset-modern" onClick={() => handleSelectActivo(act)}>
                                            <div className="card-asset-header">
                                                <div className="asset-icon-circle">
                                                    <FaIndustry />
                                                </div>
                                                {act.Codigo && <span className="asset-code-badge"><FaBarcode/> {act.Codigo}</span>}
                                            </div>
                                            
                                            <div className="card-asset-body">
                                                <h3>{act.Nombre}</h3>
                                                <p className="asset-type">{act.Tipo}</p>
                                            </div>

                                            <div className="card-asset-footer">
                                                <div className="asset-location">
                                                    <FaMapMarkerAlt /> {act.Ubicacion || 'Sin ubicaci√≥n'}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}

                    {/* PASO 2: SELECCI√ìN DE FORMULARIO */}
                    {step === 2 && (
                        <div className="step-content">
                            <h2 style={{textAlign:'center', marginBottom:'2rem'}}>Seleccione el Checklist</h2>
                            
                            <div className="selected-asset-summary">
                                <strong>Activo Seleccionado:</strong> {selectedActivo.Nombre} ({selectedActivo.Codigo})
                            </div>

                            <div className="grid-pro">
                                {forms.map(form => (
                                    <div key={form.ID_Formulario} className="card-pro" onClick={() => handleSelectForm(form)}>
                                        <div className="card-icon"><FaFileSignature /></div>
                                        <div className="card-info">
                                            <h3>{form.Titulo}</h3>
                                            <span>{form.Codigo}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* PASO 3: CHECKLIST (ACTUALIZADO CON SOPORTE TEXTO) */}
                    {step === 3 && (
                        <div className="step-content form-view">
                            <div className="form-header-pro">
                                <h2>{selectedForm.Titulo}</h2>
                                <span className="badge-pro">{selectedActivo.Nombre}</span>
                            </div>
                            
                            <div className="questions-list-pro">
                                {preguntas.map((p, idx) => (
                                    <div key={p.ID_Pregunta} className="question-row-pro">
                                        <div className="q-number">{idx + 1}</div>
                                        <div className="q-content" style={{flex:1, width:'100%'}}>
                                            <div className="q-text">{p.Texto_Pregunta}</div>
                                            
                                            {/* RENDERIZADO CONDICIONAL: TEXTO vs BOOLEANO */}
                                            {p.Tipo === 'TEXT' ? (
                                                <input 
                                                    type="text"
                                                    placeholder="Escriba el detalle..."
                                                    className="input-observaciones"
                                                    style={{marginTop:0, background:'#f8fafc', borderColor: respuestas[p.ID_Pregunta] ? '#10b981' : '#cbd5e1'}}
                                                    value={respuestas[p.ID_Pregunta] || ''}
                                                    onChange={(e) => handleAnswer(p.ID_Pregunta, e.target.value)}
                                                />
                                            ) : (
                                                <div className="q-actions">
                                                    <button 
                                                        className={`btn-option pass ${respuestas[p.ID_Pregunta] === true ? 'selected' : ''}`}
                                                        onClick={() => handleAnswer(p.ID_Pregunta, true)}
                                                    >
                                                        <FaCheck /> S√ç
                                                    </button>
                                                    <button 
                                                        className={`btn-option fail ${respuestas[p.ID_Pregunta] === false ? 'selected' : ''}`}
                                                        onClick={() => handleAnswer(p.ID_Pregunta, false)}
                                                    >
                                                        <FaTimes /> NO
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="evidence-section-pro">
                                <label style={{display:'flex', alignItems:'center', gap:'8px', marginBottom:'10px', fontWeight:'600'}}>
                                    <FaCamera /> Evidencia y Observaciones
                                </label>
                                <div className="file-input-wrapper">
                                    <input type="file" accept="image/*,.pdf" onChange={handleFileChange} />
                                    <div className="file-custom-label">
                                        {evidenciaFile ? evidenciaFile.name : 'Adjuntar Foto o Documento (Opcional)'}
                                    </div>
                                </div>
                                {previewUrl && evidenciaFile?.type.startsWith('image') && (
                                    <div style={{textAlign:'center', margin:'10px 0'}}>
                                        <img src={previewUrl} alt="Preview" style={{maxHeight:'150px', borderRadius:'8px'}} />
                                    </div>
                                )}
                                <textarea 
                                    placeholder="Observaciones generales..." 
                                    className="input-observaciones"
                                    value={observaciones}
                                    onChange={e => setObservaciones(e.target.value)}
                                ></textarea>
                            </div>

                            <button className="btn-submit-pro" onClick={handleSubmit} disabled={loading}>
                                {loading ? 'Guardando...' : <><FaSave/> Finalizar Reporte</>}
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

export default CrearReporteAdmin;


==================================================================
ARCHIVO: frontend\src\pages\admin\Cronogramas.jsx
==================================================================
import { useState, useEffect, useMemo } from 'react';
import Swal from 'sweetalert2';
// --- IMPORTACIONES CORREGIDAS PARA LA EVIDENCIA ---
import { API_URL, apiFetchBlob, extractFilename } from '../../services/api';

import { 
    getCronogramas, 
    getAllActividades, 
    deleteCronograma, 
    deleteActividad 
} from '../../services/cronogramaService';

// --- LIBRER√çA CALENDARIO ---
import { Calendar, dateFnsLocalizer, Views } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import { es } from 'date-fns/locale'; 
import 'react-big-calendar/lib/css/react-big-calendar.css';
import '../../styles/Cronograma.css';

// --- ICONOS ---
import { 
    FaPlus, FaTrash, FaEdit, FaTools, FaInfoCircle, 
    FaUserTie, FaLock, FaCalendarAlt, FaList, FaSearch, FaEye, FaFilter, FaTimes
} from 'react-icons/fa';

// --- MODALES ---
import ModalCreateCronograma from '../../components/modals/ModalCreateCronograma';
import ModalCreateActividad from '../../components/modals/ModalCreateActividad';
import ModalEditarActividad from '../../components/modals/ModalEditarActividad';
import ModalGestionarActividad from '../../components/modals/ModalGestionarActividad';
import ModalDetalleActividad from '../../components/modals/ModalDetalleActividad';

// --- CONFIGURACI√ìN REGIONAL ---
const locales = { 'es': es };

const localizer = dateFnsLocalizer({
    format,
    parse,
    startOfWeek: (date) => startOfWeek(date, { weekStartsOn: 1 }), 
    getDay,
    locales,
});

const messages = {
    allDay: 'Todo el d√≠a',
    previous: 'Ant.',
    next: 'Sig.',
    today: 'Hoy',
    month: 'Mes',
    week: 'Semana',
    day: 'D√≠a',
    agenda: 'Agenda',
    date: 'Fecha',
    time: 'Hora',
    event: 'Evento',
    noEventsInRange: 'No hay actividades.',
    showMore: total => `+ Ver ${total} m√°s` // Texto personalizado
};

const Cronogramas = () => {
    // --- DATOS ---
    const [cronogramas, setCronogramas] = useState([]);
    const [agendaGlobal, setAgendaGlobal] = useState([]); 
    const [userRole, setUserRole] = useState('');
    
    // --- ESTADO DE SELECCI√ìN Y FILTROS ---
    const [selectedCronoId, setSelectedCronoId] = useState(''); 
    const [filtroTexto, setFiltroTexto] = useState('');
    const [filtroEstado, setFiltroEstado] = useState('Todos'); 

    // --- CALENDARIO ---
    const [currentDate, setCurrentDate] = useState(new Date());
    const [currentView, setCurrentView] = useState(Views.MONTH);

    // --- MODALES ---
    const [showCreateCrono, setShowCreateCrono] = useState(false);
    const [showCreateAct, setShowCreateAct] = useState(false);
    const [showEditAct, setShowEditAct] = useState(false);
    const [showManageAct, setShowManageAct] = useState(false);
    const [showDetailAct, setShowDetailAct] = useState(false);
    
    // --- NUEVO: MODAL "VER M√ÅS" (D√çA) ---
    const [showMoreModal, setShowMoreModal] = useState(false);
    const [dayEvents, setDayEvents] = useState([]);
    const [dayDate, setDayDate] = useState(null);

    const [selectedActividad, setSelectedActividad] = useState(null);

    // --- CARGA INICIAL ---
    useEffect(() => {
        cargarDatos();
        obtenerRol();
    }, []);

    const obtenerRol = () => {
        try {
            const usuarioStr = localStorage.getItem('user');
            if (usuarioStr) {
                const u = JSON.parse(usuarioStr);
                setUserRole(u.Rol || u.rol || '');
            }
        } catch (e) { console.error(e); }
    };

    const cargarDatos = async () => {
        try {
            const dataCronos = await getCronogramas();
            setCronogramas(dataCronos);
            
            const dataAgenda = await getAllActividades();
            setAgendaGlobal(dataAgenda);
        } catch (error) { console.error(error); }
    };

    // --- NUEVA FUNCI√ìN PARA VER EVIDENCIA ---
    const handleVerEvidencia = async (urlEvidencia) => {
        if (!urlEvidencia) return;

        // Si es un enlace externo completo (ej: https://...), lo abrimos directo
        if (urlEvidencia.startsWith('http')) {
            window.open(urlEvidencia, '_blank');
            return;
        }

        try {
            // Extraemos solo el nombre del archivo (ej: "evidencia-123.pdf")
            const filename = extractFilename(urlEvidencia);
            
            // Usamos el endpoint inteligente '/drive/ver/' que arreglamos en el backend
            const blob = await apiFetchBlob(`/drive/ver/${filename}`);
            
            if (blob.size === 0) throw new Error("El archivo parece estar vac√≠o.");

            // Creamos una URL temporal para ver el archivo
            const urlBlob = URL.createObjectURL(blob);
            window.open(urlBlob, '_blank');
        } catch (error) {
            console.error("Error visualizando evidencia:", error);
            Swal.fire('Error', 'No se pudo abrir la evidencia. Verifique que el archivo exista.', 'error');
        }
    };

    const formatearFechaLocal = (fechaString) => {
        if (!fechaString) return '-';
        const partes = fechaString.toString().split('T')[0].split('-');
        if (partes.length < 3) return fechaString;
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    };

    const stats = useMemo(() => {
        return {
            pendientes: agendaGlobal.filter(a => a.Estado === 'Pendiente' && a.Tipo === 'ACTIVIDAD').length,
            acpm: agendaGlobal.filter(a => a.Estado === 'Pendiente' && a.Tipo === 'ACPM').length,
            realizadas: agendaGlobal.filter(a => a.Estado === 'Realizada').length,
            canceladas: agendaGlobal.filter(a => a.Estado === 'Cancelada').length,
        };
    }, [agendaGlobal]);

    const actividadesTabla = agendaGlobal.filter(item => {
        if (item.Tipo !== 'ACTIVIDAD') return false; 
        
        if (selectedCronoId) {
            const crono = cronogramas.find(c => c.ID_Cronograma === parseInt(selectedCronoId));
            if (crono && (item.Origen || '') !== crono.Nombre) return false; 
        }

        if (filtroTexto) {
            const txt = filtroTexto.toLowerCase();
            const titulo = (item.Titulo || '').toLowerCase();
            const responsable = (item.Responsable || '').toLowerCase();
            const match = titulo.includes(txt) || responsable.includes(txt);
            if (!match) return false;
        }

        if (filtroEstado !== 'Todos') {
            if (item.Estado !== filtroEstado) return false;
        }

        return true;
    });

    const cronogramaActual = cronogramas.find(c => c.ID_Cronograma === parseInt(selectedCronoId));

    const handleDeleteCronograma = async () => {
        if (!selectedCronoId || userRole !== 'SuperAdmin') return;
        Swal.fire({
            title: '¬øEliminar Cronograma?',
            text: "Se borrar√° todo el contenido de este cronograma.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'S√≠, eliminar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await deleteCronograma(selectedCronoId);
                    setSelectedCronoId('');
                    cargarDatos();
                    Swal.fire('Eliminado', '', 'success');
                } catch (error) {
                    Swal.fire('Error', 'No se pudo eliminar', 'error');
                }
            }
        });
    };

    // --- CALENDARIO EVENTS ---
    const calendarEvents = useMemo(() => {
        return agendaGlobal.map(act => {
            if (!act.Fecha) return null;
            let dateObj = new Date(act.Fecha);
            if (isNaN(dateObj)) return null;
            
            if (typeof act.Fecha === 'string' && act.Fecha.includes('T')) {
                 const parts = act.Fecha.split('T')[0].split('-');
                 dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
            }

            return {
                title: act.Titulo || 'Sin T√≠tulo', 
                start: dateObj,
                end: dateObj,
                allDay: true,
                resource: act
            };
        }).filter(Boolean);
    }, [agendaGlobal]);

    // --- L√ìGICA DE COLORES ACTUALIZADA ---
    const eventStyleGetter = (event) => {
        const { Estado, Tipo } = event.resource;
        let backgroundColor = '#64748b'; 

        if (Estado === 'Realizada') {
            if (Tipo === 'ACPM') {
                backgroundColor = '#0d9488'; 
            } else {
                backgroundColor = '#10b981'; 
            }
        } 
        else if (Estado === 'Cancelada') backgroundColor = '#ef4444'; 
        else if (Estado === 'Pendiente') {
            if (Tipo === 'ACPM') backgroundColor = '#f97316'; // Naranja
            else backgroundColor = '#3b82f6'; // Azul
        }

        return { style: { backgroundColor, borderRadius: '4px', border: 'none', color: '#fff', fontSize: '0.75rem' } };
    };

    const handleSelectEvent = (event) => {
        const item = event.resource || event; // Soporte para click directo o desde modal custom
        
        if (item.Tipo === 'ACPM') {
            Swal.fire({
                title: 'Plan de Acci√≥n ACPM',
                html: `
                    <div style="text-align:left">
                        <p><strong>Hallazgo:</strong> ${item.Titulo || 'Sin t√≠tulo'}</p>
                        <p><strong>Plan:</strong> ${item.Descripcion || 'Sin descripci√≥n'}</p>
                        <p><strong>Responsable:</strong> ${item.Responsable || 'Sin asignar'}</p>
                        <p><strong>Estado:</strong> ${item.Estado}</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonColor: '#0c4760'
            });
            return;
        }
        
        setSelectedActividad({
            ...item, 
            ID_Actividad: item.ID, 
            Nombre_Actividad: item.Titulo, 
            Fecha_Programada: item.Fecha
        });

        if (item.Estado === 'Pendiente') setShowManageAct(true);
        else setShowDetailAct(true);
    };

    // --- NUEVO MANEJADOR PARA "VER M√ÅS" ---
    const handleShowMore = (events, date) => {
        setDayEvents(events);
        setDayDate(date);
        setShowMoreModal(true);
    };

    return (
        <div className="page-container">
            
            <div className="page-header">
                <h1>Gesti√≥n de Planificaci√≥n</h1>
                <div className="header-actions">
                    <button className="btn btn-grey" onClick={() => setShowCreateCrono(true)}>
                        <FaPlus /> Crear Cronograma
                    </button>
                </div>
            </div>

            {/* SELECCI√ìN DE CRONOGRAMA */}
            <div className="card-section" style={{marginBottom: '20px', padding: '20px', borderLeft: '5px solid #0c4760'}}>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: '20px'}}>
                    <div style={{flex: 1, minWidth: '300px'}}>
                        <label className="input-label" style={{fontSize: '0.9rem'}}>Seleccione el Cronograma a trabajar:</label>
                        <select 
                            className="form-control" 
                            value={selectedCronoId} 
                            onChange={(e) => setSelectedCronoId(e.target.value)}
                            style={{fontSize: '1rem', padding: '10px'}}
                        >
                            <option value="">-- Ver Todos (Vista General) --</option>
                            {cronogramas.map(c => (
                                <option key={c.ID_Cronograma} value={c.ID_Cronograma}>
                                    {c.Nombre} - A√±o {c.Anio}
                                </option>
                            ))}
                        </select>
                        {cronogramaActual && (
                            <div style={{marginTop: '15px', color: '#64748b', fontSize: '0.95rem'}}>
                                <strong>Descripci√≥n: </strong> 
                                {cronogramaActual.Descripcion || 'Sin descripci√≥n disponible.'}
                            </div>
                        )}
                    </div>
                    {selectedCronoId && (
                        <div style={{display: 'flex', gap: '10px', marginTop: '25px'}}>
                            <button className="btn btn-blue" onClick={() => setShowCreateAct(true)}>
                                <FaPlus /> A√±adir Actividad
                            </button>
                            {userRole === 'SuperAdmin' && (
                                <button className="btn btn-red" onClick={handleDeleteCronograma}>
                                    <FaTrash /> Eliminar Cronograma
                                </button>
                            )}
                        </div>
                    )}
                </div>
            </div>

            {/* CALENDARIO */}
            <div className="card-section" style={{ marginBottom: '30px' }}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'15px', flexWrap:'wrap', gap:'10px'}}>
                    <h3 style={{margin:0, color:'#0c4760', fontSize:'1.1rem'}}>
                        <FaCalendarAlt style={{marginRight: '8px'}}/> 
                        Calendario {cronogramaActual ? `- ${cronogramaActual.Nombre}` : 'Global'}
                    </h3>
                    
                    {/* LEYENDA */}
                    <div style={{display:'flex', flexWrap:'wrap', gap:'15px', alignItems:'center', fontSize:'0.85rem'}}>
                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#334155'}}>
                            <span style={{width:'10px', height:'10px', borderRadius:'50%', background:'#3b82f6'}}></span>
                            Pendientes <strong>({stats.pendientes})</strong>
                        </span>
                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#334155'}}>
                            <span style={{width:'10px', height:'10px', borderRadius:'50%', background:'#10b981'}}></span>
                            Act. Realizadas <strong>({stats.realizadas})</strong>
                        </span>
                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#334155'}}>
                            <span style={{width:'10px', height:'10px', borderRadius:'50%', background:'#0d9488'}}></span>
                            ACPM Realizado
                        </span>
                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#334155'}}>
                            <span style={{width:'10px', height:'10px', borderRadius:'50%', background:'#ef4444'}}></span>
                            Canceladas <strong>({stats.canceladas})</strong>
                        </span>
                        <span style={{display:'flex', alignItems:'center', gap:'5px', color:'#334155'}}>
                            <span style={{width:'10px', height:'10px', borderRadius:'50%', background:'#f97316'}}></span>
                            Plan de Acci√≥n <strong>({stats.acpm})</strong>
                        </span>
                    </div>

                </div>
                <div style={{height: '600px'}}>
                    <Calendar
                        localizer={localizer}
                        events={calendarEvents}
                        startAccessor="start"
                        endAccessor="end"
                        style={{ height: '100%' }}
                        messages={messages}
                        culture='es'
                        date={currentDate}
                        view={currentView}
                        onNavigate={setCurrentDate}
                        onView={setCurrentView}
                        eventPropGetter={eventStyleGetter}
                        onSelectEvent={handleSelectEvent}
                        
                        onShowMore={handleShowMore} 
                        popup={false} 
                    />
                </div>
            </div>

            {/* LISTADO DETALLADO */}
            <div className="card-section">
                
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px', flexWrap: 'wrap', gap: '15px'}}>
                    <h3 style={{margin:0, display:'flex', alignItems:'center', gap:'10px', fontSize:'1.1rem'}}>
                        <FaList /> Listado Detallado
                    </h3>
                    
                    <div style={{display: 'flex', gap: '10px', flexWrap:'wrap'}}>
                        <div className="input-group" style={{width: '180px'}}>
                            <span className="input-icon"><FaFilter/></span>
                            <select 
                                className="form-control" 
                                value={filtroEstado} 
                                onChange={(e) => setFiltroEstado(e.target.value)}
                            >
                                <option value="Todos">Todos los Estados</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Realizada">Realizada</option>
                                <option value="Cancelada">Cancelada</option>
                            </select>
                        </div>

                        <div className="input-group" style={{width: '250px'}}>
                            <span className="input-icon"><FaSearch/></span>
                            <input 
                                type="text" 
                                className="form-control" 
                                placeholder="Buscar actividad..." 
                                value={filtroTexto}
                                onChange={(e) => setFiltroTexto(e.target.value)}
                            />
                        </div>
                    </div>
                </div>

                <div className="table-container">
                    <table className="custom-table">
                        <thead>
                            <tr>
                                <th>Cronograma</th>
                                <th>Actividad</th>
                                <th>Responsable</th>
                                <th>Fecha L√≠mite</th>
                                <th>Estado</th>
                                <th style={{textAlign:'center'}}>Evidencia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {actividadesTabla.length === 0 ? (
                                <tr><td colSpan="7" style={{textAlign:'center', padding:'30px', color:'#94a3b8'}}>No se encontraron actividades con los filtros actuales.</td></tr>
                            ) : (
                                actividadesTabla.map((act, index) => (
                                    <tr key={`${act.ID}-${index}`}>
                                        <td style={{fontSize:'0.85rem', color:'#64748b'}}>{act.Origen}</td>
                                        <td><strong>{act.Titulo}</strong></td>
                                        <td><FaUserTie style={{marginRight:'5px', color:'#94a3b8'}}/>{act.Responsable}</td>
                                        <td>{formatearFechaLocal(act.Fecha)}</td>
                                        <td>
                                            <span className={`status-badge status-${act.Estado ? act.Estado.toLowerCase() : 'pendiente'}`}>
                                                {act.Estado}
                                            </span>
                                        </td>
                                        <td style={{textAlign:'center'}}>
                                            {/* --- CORRECCI√ìN AQU√ç: BOT√ìN EN VEZ DE LINK DIRECTO --- */}
                                            {act.Url_Evidencia ? (
                                                <button 
                                                    className="btn-icon" 
                                                    onClick={() => handleVerEvidencia(act.Url_Evidencia)} 
                                                    style={{color:'#0ea5e9', cursor:'pointer', background:'transparent', border:'none'}}
                                                    title="Ver Evidencia"
                                                >
                                                    <FaEye/>
                                                </button>
                                            ) : '-'}
                                        </td>
                                        <td>
                                            <div className="action-buttons">
                                                <button className="btn-icon" onClick={()=>{
                                                    setSelectedActividad({...act, ID_Actividad: act.ID, Nombre_Actividad: act.Titulo, Fecha_Programada: act.Fecha}); 
                                                    setShowDetailAct(true);
                                                }} title="Ver Detalle">
                                                    <FaInfoCircle color="#64748b"/>
                                                </button>
                                                {act.Estado !== 'Realizada' && act.Estado !== 'Cancelada' ? (
                                                    <>
                                                        <button className="btn-icon" onClick={()=>{
                                                            setSelectedActividad({...act, ID_Actividad: act.ID, Nombre_Actividad: act.Titulo, Fecha_Programada: act.Fecha});
                                                            setShowManageAct(true);
                                                        }} title="Gestionar">
                                                            <FaTools color="#0ea5e9"/>
                                                        </button>
                                                        <button className="btn-icon" onClick={()=>{
                                                            setSelectedActividad({...act, ID_Actividad: act.ID, Nombre_Actividad: act.Titulo, Fecha_Programada: act.Fecha});
                                                            setShowEditAct(true);
                                                        }} title="Editar">
                                                            <FaEdit color="#f59e0b"/>
                                                        </button>
                                                    </>
                                                ) : <span title="Cerrada"><FaLock color="#10b981"/></span>}
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- MODAL PARA "VER M√ÅS" ACTIVIDADES --- */}
            {showMoreModal && (
                <div className="modal-overlay" style={{zIndex: 3000}}>
                    <div className="modal-box" style={{width:'400px', maxHeight:'80vh'}}>
                        <div className="modal-header-clean">
                            <h3>{dayDate ? dayDate.toLocaleDateString() : 'Actividades'}</h3>
                            <button className="close-btn" onClick={() => setShowMoreModal(false)}><FaTimes/></button>
                        </div>
                        <div className="modal-body-clean" style={{padding:'10px'}}>
                            <div style={{display:'flex', flexDirection:'column', gap:'8px'}}>
                                {dayEvents.map((evt, idx) => {
                                    const styleObj = eventStyleGetter(evt).style;
                                    return (
                                        <div 
                                            key={idx}
                                            onClick={() => {
                                                setShowMoreModal(false); 
                                                handleSelectEvent(evt);  
                                            }}
                                            style={{
                                                padding:'10px', 
                                                border:'1px solid #e2e8f0', 
                                                borderRadius:'8px', 
                                                cursor:'pointer',
                                                background:'white',
                                                display:'flex',
                                                alignItems:'center',
                                                gap:'10px',
                                                transition:'background 0.2s'
                                            }}
                                            onMouseEnter={(e) => e.currentTarget.style.background = '#f8fafc'}
                                            onMouseLeave={(e) => e.currentTarget.style.background = 'white'}
                                        >
                                            <div style={{
                                                width:'12px', height:'12px', borderRadius:'50%', 
                                                backgroundColor: styleObj.backgroundColor,
                                                flexShrink: 0
                                            }}></div>
                                            <div style={{fontSize:'0.9rem', color:'#334155', fontWeight:'500'}}>
                                                {evt.title}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>
                        <div className="modal-footer-clean">
                            <button className="btn btn-grey" onClick={() => setShowMoreModal(false)}>Cerrar</button>
                        </div>
                    </div>
                </div>
            )}

            {/* MODALES DE GESTI√ìN */}
            <ModalCreateCronograma isOpen={showCreateCrono} onClose={() => setShowCreateCrono(false)} onSuccess={cargarDatos} />
            <ModalCreateActividad isOpen={showCreateAct} onClose={() => setShowCreateAct(false)} idCronograma={selectedCronoId} onSuccess={cargarDatos} />
            <ModalEditarActividad isOpen={showEditAct} onClose={() => setShowEditAct(false)} actividad={selectedActividad} onSuccess={cargarDatos} />
            <ModalGestionarActividad isOpen={showManageAct} onClose={() => setShowManageAct(false)} actividad={selectedActividad} onSuccess={cargarDatos} />
            <ModalDetalleActividad isOpen={showDetailAct} onClose={() => setShowDetailAct(false)} actividad={selectedActividad} />
        </div>
    );
};

export default Cronogramas;


==================================================================
ARCHIVO: frontend\src\pages\admin\DashboardAdmin.jsx
==================================================================
import { useEffect, useState } from 'react';
import { getDashboardStats } from '../../services/dashboardService';
import { useNavigate } from 'react-router-dom';
import '../../styles/Dashboard.css';

// Gr√°ficas
import { 
    BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
    PieChart, Pie, Cell, Legend 
} from 'recharts';

// Iconos
import { FaClipboardList, FaExclamationTriangle, FaIndustry, FaUsers, FaChartLine, FaArrowRight } from 'react-icons/fa';

const DashboardAdmin = () => {
    const navigate = useNavigate();
    const [data, setData] = useState({
        stats: { ReportesHoy: 0, AlertasACPM: 0, ActivosTotales: 0, UsuariosActivos: 0 },
        chartData: [],
        pieData: []
    });
    const [loading, setLoading] = useState(true);

    // Colores para la gr√°fica de pastel
    const COLORS = ['#10b981', '#ef4444']; // Verde (Conforme), Rojo (Fallas)

    useEffect(() => {
        const fetchStats = async () => {
            try {
                const result = await getDashboardStats();
                
                // Procesar datos para gr√°ficas si vienen vac√≠os
                const processedChart = result.chartData.length > 0 
                    ? result.chartData 
                    : [{ Fecha: 'Hoy', Total: 0 }]; // Placeholder

                const processedPie = result.pieData.length > 0
                    ? result.pieData
                    : [{ Estado: 'Sin datos', Cantidad: 1 }];

                setData({
                    stats: result.stats,
                    chartData: processedChart,
                    pieData: processedPie
                });
            } catch (error) {
                console.error(error);
            } finally {
                setLoading(false);
            }
        };
        fetchStats();
    }, []);

    const StatCard = ({ title, value, icon, colorBg, colorText, onClick, subtext }) => (
        <div className="stat-card" onClick={onClick} style={{cursor: onClick ? 'pointer' : 'default'}}>
            <div className="stat-header">
                <div className="stat-icon-wrapper" style={{ background: colorBg, color: colorText }}>
                    {icon}
                </div>
                {onClick && <FaArrowRight style={{color:'#cbd5e1', fontSize:'0.9rem'}} />}
            </div>
            <div className="stat-body">
                <div className="stat-value">{loading ? '-' : value}</div>
                <div className="stat-label">{title}</div>
                {subtext && <div className="stat-subtext">{subtext}</div>}
            </div>
        </div>
    );

    return (
        <div className="dashboard-container">
            <div className="page-header">
                <div>
                    <h1 className="page-title">Panel de Control</h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Visi√≥n general del estado del sistema.</p>
                </div>
                <div style={{fontSize:'0.9rem', color:'#64748b', background:'white', padding:'5px 15px', borderRadius:'20px', border:'1px solid #e2e8f0'}}>
                    üìÖ {new Date().toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'long' })}
                </div>
            </div>
            
            {/* 1. TARJETAS DE KPI */}
            <div className="stats-grid">
                <StatCard 
                    title="Reportes Hoy" 
                    value={data.stats.ReportesHoy} 
                    icon={<FaClipboardList />} 
                    colorBg="#e0f2fe" colorText="#0284c7"
                    onClick={() => navigate('/admin/reportes')}
                    subtext="Inspecciones diarias"
                />
                <StatCard 
                    title="Planes Abiertos" 
                    value={data.stats.AlertasACPM} 
                    icon={<FaExclamationTriangle />} 
                    colorBg="#fee2e2" colorText="#dc2626"
                    onClick={() => navigate('/admin/acpm')}
                    subtext="Requieren atenci√≥n"
                />
                <StatCard 
                    title="Activos Totales" 
                    value={data.stats.ActivosTotales} 
                    icon={<FaIndustry />} 
                    colorBg="#f3f4f6" colorText="#4b5563"
                    onClick={() => navigate('/admin/activos')}
                    subtext="Maquinaria y equipos"
                />
                <StatCard 
                    title="Usuarios" 
                    value={data.stats.UsuariosActivos} 
                    icon={<FaUsers />} 
                    colorBg="#f0fdf4" colorText="#16a34a"
                    onClick={() => navigate('/admin/usuarios')}
                    subtext="Colaboradores activos"
                />
            </div>

            {/* 2. SECCI√ìN DE GR√ÅFICAS */}
            <div className="charts-grid">
                
                {/* GR√ÅFICA DE BARRAS (ACTIVIDAD SEMANAL) */}
                <div className="chart-card large">
                    <h3 className="chart-title"><FaChartLine /> Actividad de la Semana</h3>
                    <div style={{ width: '100%', height: 300 }}>
                        <ResponsiveContainer>
                            <BarChart data={data.chartData}>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                <XAxis dataKey="Fecha" axisLine={false} tickLine={false} tick={{fill:'#64748b', fontSize:12}} />
                                <YAxis axisLine={false} tickLine={false} tick={{fill:'#64748b', fontSize:12}} />
                                <Tooltip 
                                    cursor={{fill: '#f1f5f9'}}
                                    contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px rgba(0,0,0,0.1)'}}
                                />
                                <Bar dataKey="Total" fill="#0c4760" radius={[4, 4, 0, 0]} barSize={40} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* GR√ÅFICA DE PASTEL (ESTADO HOY) */}
                <div className="chart-card small">
                    <h3 className="chart-title">Calidad de Hoy</h3>
                    <div style={{ width: '100%', height: 300 }}>
                        <ResponsiveContainer>
                            <PieChart>
                                <Pie
                                    data={data.pieData}
                                    cx="50%" cy="50%"
                                    innerRadius={60}
                                    outerRadius={80}
                                    paddingAngle={5}
                                    dataKey="Cantidad"
                                    nameKey="Estado"
                                >
                                    {data.pieData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={entry.Estado === 'Con Fallas' ? '#ef4444' : '#10b981'} />
                                    ))}
                                </Pie>
                                <Tooltip />
                                <Legend verticalAlign="bottom" height={36}/>
                            </PieChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>

            {/* 3. ACCESOS R√ÅPIDOS */}
            <h2 className="section-title" style={{marginTop:'1rem'}}>Accesos Directos</h2>
            <div className="quick-actions">
                <button className="action-card" onClick={() => navigate('/admin/cronogramas')}>
                    <span>üìÖ Planificaci√≥n</span>
                </button>
                <button className="action-card" onClick={() => navigate('/admin/forms')}>
                    <span>üìã Dise√±ador</span>
                </button>
                <button className="action-card" onClick={() => navigate('/admin/agua-historial')}>
                    <span>üíß Agua Potable</span>
                </button>
                <button className="action-card" onClick={() => navigate('/admin/capacitacion')}>
                    <span>üéì Capacitaciones</span>
                </button>
            </div>
        </div>
    );
};

export default DashboardAdmin;


==================================================================
ARCHIVO: frontend\src\pages\admin\Dise√±adorForms.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { 
    getAllFormularios, getPreguntas, 
    addPregunta, deletePregunta, 
    toggleFormVisibility, deleteFormulario 
} from '../../services/coreService';
import ModalCreateForm from '../../components/modals/ModalCreateForm';
import ModalEditForm from '../../components/modals/ModalEditForm';
import '../../styles/GestorFormularios.css';
import { FaTrash, FaEdit, FaClipboardList, FaSearch, FaArrowLeft, FaPlus, FaCheckSquare, FaFont } from 'react-icons/fa';

const Dise√±adorForms = () => {
    const [formularios, setFormularios] = useState([]);
    const [selectedForm, setSelectedForm] = useState(null);
    const [preguntas, setPreguntas] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [loading, setLoading] = useState(true);
    
    // --- ESTADOS PARA NUEVA PREGUNTA ---
    const [newQuestionText, setNewQuestionText] = useState('');
    const [newQuestionType, setNewQuestionType] = useState('BOOL'); // 'BOOL' = Si/No, 'TEXT' = Abierta
    
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showEditModal, setShowEditModal] = useState(false);

    useEffect(() => {
        loadForms();
    }, []);

    const loadForms = async () => {
        try {
            const data = await getAllFormularios();
            setFormularios(data || []);
            if (selectedForm) {
                const updated = data.find(f => f.ID_Formulario === selectedForm.ID_Formulario);
                if (updated) setSelectedForm(updated);
            }
        } catch (error) { console.error(error); } 
        finally { setLoading(false); }
    };

    const handleSelectForm = async (form) => {
        setSelectedForm(form);
        setPreguntas([]);
        try {
            const data = await getPreguntas(form.ID_Formulario);
            setPreguntas(data);
        } catch (error) { console.error("Error cargando preguntas", error); }
    };

    const handleAddQuestion = async (e) => {
        e.preventDefault(); // IMPORTANTE: Previene recarga de p√°gina
        
        if (!newQuestionText.trim()) return;
        
        try {
            // Enviamos ID, TEXTO y TIPO al backend
            await addPregunta(selectedForm.ID_Formulario, newQuestionText, newQuestionType);
            
            setNewQuestionText('');
            // No reseteamos el tipo para permitir agregar varias del mismo tipo seguido
            
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true
            });
            Toast.fire({ icon: 'success', title: 'Campo agregado' });

            // Recargar lista
            const data = await getPreguntas(selectedForm.ID_Formulario);
            setPreguntas(data);
        } catch (error) {
            Swal.fire('Error', error.message, 'error');
        }
    };

    const handleDeleteQuestion = async (idPregunta) => {
        Swal.fire({
            title: '¬øEst√°s seguro?',
            text: "Esta pregunta se eliminar√° permanentemente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0c4760',
            cancelButtonColor: '#d33',
            confirmButtonText: 'S√≠, borrar',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await deletePregunta(idPregunta);
                    setPreguntas(preguntas.filter(p => p.ID_Pregunta !== idPregunta));
                    Swal.fire('Eliminada', 'La pregunta ha sido borrada.', 'success');
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        });
    };

    const handleToggleVisibility = async () => {
        try {
            const newState = !selectedForm.Es_Visible_Colaborador;
            await toggleFormVisibility(selectedForm.ID_Formulario, newState);
            setSelectedForm({...selectedForm, Es_Visible_Colaborador: newState});
            loadForms();
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            Toast.fire({ icon: newState ? 'success' : 'info', title: newState ? 'Formulario Visible' : 'Formulario Oculto' });
        } catch (error) { Swal.fire('Error', error.message, 'error'); }
    };

    const handleDeleteForm = async () => {
        Swal.fire({
            title: '¬øEliminar Formulario?',
            text: `Se borrar√° "${selectedForm.Titulo}" y todo su historial.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, eliminar todo',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await deleteFormulario(selectedForm.ID_Formulario);
                    setSelectedForm(null);
                    loadForms();
                    Swal.fire('Eliminado', 'El formulario ha sido eliminado.', 'success');
                } catch (error) { Swal.fire('Error', error.message, 'error'); }
            }
        });
    };

    const filteredForms = formularios.filter(f => f.Titulo.toLowerCase().includes(searchTerm.toLowerCase()));

    return (
        <div>
            <div className="page-header">
                <h1 className="page-title">Gestor de Formularios</h1>
                <div style={{display:'flex', gap:'10px'}}>
                    <button className="btn-new-user" onClick={() => setShowCreateModal(true)}>
                        <FaPlus style={{marginRight:'5px'}}/> Crear Nuevo
                    </button>
                </div>
            </div>

            <div className="gestor-layout">
                {/* SIDEBAR LISTA */}
                <aside className="forms-sidebar">
                    <div className="forms-search-box">
                        <FaSearch style={{color:'#94a3b8', position:'absolute', marginTop:'10px', marginLeft:'10px'}}/>
                        <input type="text" placeholder="Buscar formulario..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                    </div>
                    <div className="forms-list">
                        {loading ? <p style={{padding:'1rem', textAlign:'center', color:'#999'}}>Cargando...</p> : 
                         filteredForms.length === 0 ? <p style={{padding:'2rem', textAlign:'center', color:'#94a3b8', fontSize:'0.9rem'}}>No se encontraron resultados.</p> :
                         filteredForms.map(form => (
                            <div key={form.ID_Formulario} className={`form-list-item ${selectedForm?.ID_Formulario === form.ID_Formulario ? 'active' : ''}`} onClick={() => handleSelectForm(form)}>
                                <div className="form-item-title">{form.Titulo}</div>
                                <div className="form-item-meta">
                                    <span>{form.Codigo || 'S/C'}</span>
                                    <div style={{display:'flex', alignItems:'center'}}>
                                        <span className={`status-dot ${form.Es_Visible_Colaborador ? 'status-visible' : 'status-hidden'}`}></span>
                                        <span style={{fontSize:'0.75rem', color: '#64748b'}}>{form.Es_Visible_Colaborador ? 'Visible' : 'Oculto'}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </aside>

                {/* MAIN DETALLE */}
                <main className="form-detail-panel">
                    {!selectedForm ? (
                        <div className="empty-state">
                            <FaClipboardList />
                            <h3>Selecciona un formulario</h3>
                            <p>O crea uno nuevo para comenzar a gestionar sus campos.</p>
                        </div>
                    ) : (
                        <>
                            <div className="detail-header">
                                <div className="detail-title">
                                    <h2>{selectedForm.Titulo}</h2>
                                    <div className="detail-meta">
                                        <strong>ID:</strong> {selectedForm.Codigo} <br/>
                                        <strong>Categor√≠a:</strong> {selectedForm.Categoria || 'General'}
                                    </div>
                                </div>
                                <div className="header-actions">
                                    <div className="toggle-switch-container">
                                        <label className="switch">
                                            <input type="checkbox" checked={!!selectedForm.Es_Visible_Colaborador} onChange={handleToggleVisibility} />
                                            <span className="slider"></span>
                                        </label>
                                        <span>{selectedForm.Es_Visible_Colaborador ? 'Visible' : 'Oculto'}</span>
                                    </div>
                                    <button className="btn-circle-action" title="Editar Info" onClick={() => setShowEditModal(true)}><FaEdit /></button>
                                    <button className="btn-circle-action delete" title="Eliminar Formulario" onClick={handleDeleteForm}><FaTrash /></button>
                                </div>
                            </div>

                            <div className="questions-container">
                                <div className="questions-header">Campos del Formulario ({preguntas.length})</div>

                                <div className="questions-list">
                                    {preguntas.map((p, index) => (
                                        <div key={p.ID_Pregunta} className="question-row">
                                            <div className="question-number">{index + 1}</div>
                                            
                                            <div className="question-text" style={{display:'flex', flexDirection:'column'}}>
                                                <span>{p.Texto_Pregunta}</span>
                                                {/* INDICADOR VISUAL DEL TIPO */}
                                                <span style={{fontSize:'0.7rem', color:'#94a3b8', fontWeight:'600', marginTop:'2px', display:'flex', alignItems:'center', gap:'4px'}}>
                                                    {p.Tipo === 'TEXT' ? <><FaFont/> TEXTO ESPEC√çFICO</> : <><FaCheckSquare/> VERIFICACI√ìN (SI/NO)</>}
                                                </span>
                                            </div>
                                            
                                            <div className="btn-delete-q" onClick={() => handleDeleteQuestion(p.ID_Pregunta)} title="Eliminar">
                                                <FaTrash />
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* FORMULARIO PARA AGREGAR */}
                                <form onSubmit={handleAddQuestion} className="add-question-box">
                                    {/* SELECTOR DE TIPO */}
                                    <select 
                                        className="input-new-q" 
                                        style={{flex:'0 0 140px', background:'#f8fafc', fontWeight:'600', color:'#0c4760'}}
                                        value={newQuestionType}
                                        onChange={(e) => setNewQuestionType(e.target.value)}
                                    >
                                        <option value="BOOL">Si / No</option>
                                        <option value="TEXT">Texto / Detalle</option>
                                    </select>

                                    <input 
                                        type="text" 
                                        className="input-new-q" 
                                        placeholder={newQuestionType === 'BOOL' ? "¬øQu√© se debe verificar?" : "¬øQu√© dato se debe escribir? (Ej: √Årea exacta)"}
                                        value={newQuestionText}
                                        onChange={e => setNewQuestionText(e.target.value)}
                                        autoFocus
                                    />
                                    <button type="submit" className="btn-new-user" style={{padding:'0.8rem 1.5rem'}}>
                                        <FaPlus /> Agregar
                                    </button>
                                </form>
                            </div>
                        </>
                    )}
                </main>
            </div>

            <ModalCreateForm isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} onSuccess={loadForms} />
            <ModalEditForm isOpen={showEditModal} onClose={() => setShowEditModal(false)} form={selectedForm} onSuccess={() => { loadForms(); handleSelectForm(selectedForm); }} />
        </div>
    );
};

export default Dise√±adorForms;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionACPM.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getACPMs } from '../../services/acpmService';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalGestionarACPM from '../../components/modals/ModalGestionarACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';
import '../../styles/Tables.css';
import '../../styles/Usuarios.css';
import { FaPlus, FaSearch, FaEye, FaTools } from 'react-icons/fa';

const GestionACPM = () => {
    const [acpms, setAcpms] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterState, setFilterState] = useState('Todos');

    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showManageModal, setShowManageModal] = useState(false);
    const [selectedACPMManage, setSelectedACPMManage] = useState(null);
    const [showViewModal, setShowViewModal] = useState(false);
    const [selectedACPMView, setSelectedACPMView] = useState(null);

    useEffect(() => {
        cargarDatos();
    }, []);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            const data = await getACPMs();
            setAcpms(data);
        } catch (error) { 
            console.error(error); 
        } finally { 
            setLoading(false);
        }
    };

    const handleManage = (item) => {
        setSelectedACPMManage(item);
        setShowManageModal(true);
    };

    const handleView = (item) => {
        setSelectedACPMView(item);
        setShowViewModal(true);
    };

    const filteredData = acpms.filter(item => {
        // Mantenemos la b√∫squeda por descripci√≥n aunque est√© oculta visualmente
        const descripcion = (item.Descripcion || '').toLowerCase();
        const origen = (item.Origen || '').toLowerCase();
        const origenPlan = (item.Origen_Plan || '').toLowerCase();
        const term = searchTerm.toLowerCase();

        const matchText = 
            descripcion.includes(term) ||
            origen.includes(term) ||
            origenPlan.includes(term);

        const matchState = filterState === 'Todos' ? true : item.Estado === filterState;
        
        return matchText && matchState;
    });

    const getStatusBadge = (estado) => {
        switch(estado) {
            case 'Abierta': return <span className="badge" style={{backgroundColor:'#fff7ed', color:'#c2410c', border:'1px solid #fdba74'}}>Abierta</span>;
            case 'En Progreso': return <span className="badge" style={{backgroundColor:'#eff6ff', color:'#1d4ed8', border:'1px solid #bfdbfe'}}>En Progreso</span>;
            case 'Cerrada': return <span className="badge badge-success">Cerrada</span>;
            default: return <span className="badge">{estado}</span>;
        }
    };

    return (
        <div>
            <div className="page-header">
                <h1 className="page-title">Gesti√≥n de Planes de Acci√≥n</h1>
                <button 
                    className="btn-primary" 
                    style={{backgroundColor:'#0c4760'}} 
                    onClick={() => setShowCreateModal(true)}
                >
                    <FaPlus style={{marginRight:'8px'}}/> Crear Nuevo Plan
                </button>
            </div>

            <div className="filters-bar">
                <div className="search-input-container">
                    <FaSearch />
                    <input 
                        type="text" 
                        placeholder="Buscar..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="filter-select-container">
                    <select value={filterState} onChange={e => setFilterState(e.target.value)}>
                        <option value="Todos">Todos los Estados</option>
                        <option value="Abierta">Abiertas</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="Cerrada">Cerradas</option>
                    </select>
                </div>
            </div>

            <div className="table-container">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th style={{width:'50px'}}>ID</th>
                            <th>TIPO</th>
                            <th>ORIGEN</th>
                            {/* COLUMNA DESCRIPCI√ìN ELIMINADA */}
                            <th>RESPONSABLE</th>
                            <th>FECHA L√çMITE</th>
                            <th>ESTADO</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="7" style={{textAlign:'center', padding:'2rem'}}>Cargando planes...</td></tr>
                        ) : filteredData.length === 0 ? (
                            <tr><td colSpan="7" style={{textAlign:'center', padding:'2rem', color:'#999'}}>No se encontraron registros.</td></tr>
                        ) : filteredData.map(item => (
                            <tr key={item.ID_ACPM}>
                                <td>{item.ID_ACPM}</td>
                                <td>{item.Tipo_Accion}</td>
                                <td>
                                    <strong>{item.Origen_Plan}</strong>
                                    {item.Origen_Plan && item.Origen ? <br/> : ''}
                                    <small style={{color:'#64748b'}}>{item.Origen}</small>
                                </td>
                                {/* CELDA DESCRIPCI√ìN ELIMINADA */}
                                <td>{item.Responsable}</td>
                                <td>
                                    {new Date(item.Fecha_Limite).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                </td>
                                <td>{getStatusBadge(item.Estado)}</td>
                                <td>
                                    <div style={{display:'flex', gap:'8px'}}>
                                        <button 
                                            className="btn-action" 
                                            title="Ver Detalle"
                                            onClick={() => handleView(item)}
                                            style={{color: '#64748b'}}
                                        >
                                            <FaEye />
                                        </button>
                                        
                                        {item.Estado !== 'Cerrada' && (
                                            <button 
                                                onClick={() => handleManage(item)}
                                                style={{
                                                    backgroundColor: '#e0f2fe', 
                                                    color: '#0369a1', 
                                                    border: '1px solid #bae6fd', 
                                                    padding: '0.4rem 0.8rem', 
                                                    borderRadius: '6px', 
                                                    fontWeight: '600', 
                                                    fontSize: '0.8rem',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '5px'
                                                }} 
                                                title="Gestionar Plan"
                                            >
                                                <FaTools size={12}/> Gestionar
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            <ModalCreateACPM isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} onSuccess={cargarDatos} />
            <ModalGestionarACPM isOpen={showManageModal} onClose={() => setShowManageModal(false)} acpm={selectedACPMManage} onSuccess={cargarDatos} />
            <ModalVerACPM isOpen={showViewModal} onClose={() => setShowViewModal(false)} acpm={selectedACPMView} />
        </div>
    );
};

export default GestionACPM;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionAlergenos.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService'; 
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaSearch, FaFilter, FaFolder, FaPlus, FaTrash, FaTimes, 
    FaExclamationTriangle, FaCheckCircle, FaCheckDouble, FaFileContract, 
    FaEye, FaTools, FaBan, FaBreadSlice, FaVial, FaHandPaper
} from 'react-icons/fa';

// Mapa de Iconos Tem√°ticos
const ICON_MAP = {
    'folder': <FaFolder />,
    'ban': <FaBan />,            // Restricciones / Sin Al√©rgenos
    'food': <FaBreadSlice />,    // Ingredientes / Productos
    'test': <FaVial />,          // Pruebas de laboratorio / Swab test
    'stop': <FaHandPaper />      // Controles estrictos
};

const GestionAlergenos = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('documentacion');
    
    // --- ESTADOS DOCUMENTACI√ìN ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    
    // COLOR CORPORATIVO EST√ÅNDAR
    const THEME_COLOR = '#0c4760'; 

    const [newCardData, setNewCardData] = useState({ 
        titulo: '', 
        descripcion: '', 
        color: THEME_COLOR, 
        icono: 'ban' 
    });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        if(activeTab === 'documentacion') loadCards();
        if(activeTab === 'reportes') fetchReportesOperativos(); 
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            // M√≥dulo: 'ALERGENOS'
            const res = await fetch(`${API_URL}/core/tarjetas/ALERGENOS`, { headers: getAuthHeaders() });
            setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'ALERGENOS' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'ban' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la carpeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso directo.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            // 1. Encontrar carpeta ra√≠z
            let rootId = await findOrCreateFolder(1, "Programa Al√©rgenos", headers);
            // 2. Encontrar carpeta de la tarjeta
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error al acceder al repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        return (await res2.json()).carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            // Filtrar reportes para Al√©rgenos
            const filtered = data.filter(r => 
                (r.Programa === 'Al√©rgenos') || 
                (r.Programa === 'Control de Al√©rgenos') ||
                (r.Categoria && r.Categoria.toLowerCase().includes('alergeno')) ||
                (r.Categoria && r.Categoria.toLowerCase().includes('etiquetado'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Control Al√©rgenos #${rep.ID_Reporte}`,
            descripcion: `Posible contaminaci√≥n cruzada o error etiqueta: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // Helper estilos tabs
    const getTabStyle = (isActive) => ({
        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
        background: isActive ? THEME_COLOR : 'transparent', 
        color: isActive ? 'white' : '#64748b', 
        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
    });

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaBreadSlice style={{color: THEME_COLOR}}/> Control de Al√©rgenos
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de contaminaci√≥n cruzada, etiquetado y limpiezas especiales.</p>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion')}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes')}>
                    <FaFileContract/> Reportes Operativos
                </button>
            </div>

            {/* --- CONTENIDO DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            {/* TARJETA DE "NUEVA CARPETA" ESTANDARIZADA */}
                            <div onClick={() => setShowCreateCardModal(true)} 
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', 
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px', 
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = THEME_COLOR; e.currentTarget.style.color = THEME_COLOR; e.currentTarget.style.background = '#f0f9ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO SIN CLASES EXTERNAS */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    padding:'0', 
                                    fontSize: '0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }} 
                                placeholder="Buscar reporte..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select 
                                style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}}
                                value={filterStatus} 
                                onChange={e => setFilterStatus(e.target.value)}
                            >
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato / L√≠nea</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay registros de al√©rgenos.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'L√≠nea General'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Riesgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Seguro</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- MODALES GLOBALES --- */}
            
            {/* FILE MANAGER AMPLIO */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Al√©rgenos: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* CREAR CARPETA - DISE√ëO ORGANIZADO */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Al√©rgenos</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                
                                <div className="form-group">
                                    <label>T√≠tulo de la Carpeta</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Fichas T√©cnicas 2026" />
                                </div>
                                
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Breve descripci√≥n..." />
                                </div>
                                
                                <div className="form-group">
                                    <label>Color de Etiqueta</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0, cursor:'pointer'}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', 
                                                    color: newCardData.icono === key ? THEME_COLOR : '#64748b', 
                                                    background: newCardData.icono === key ? '#f0f9ff' : 'transparent',
                                                    display:'flex', alignItems:'center', justifyContent:'center', height:'45px'
                                                }}
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal" style={{backgroundColor: THEME_COLOR}}>Crear Carpeta</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default GestionAlergenos;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionAuditorias.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getAuditorias } from '../../services/auditoriaService';
import { getACPMById } from '../../services/acpmService';
import { API_URL } from '../../services/api';
import ModalCrearAuditoria from '../../components/modals/ModalCrearAuditoria';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerAuditoria from '../../components/modals/ModalVerAuditoria';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import { 
    FaSearch, FaPlus, FaClipboardList, FaExternalLinkAlt, 
    FaFilePdf, FaImage, FaFileAlt, FaEye, FaUserTie, FaBuilding, FaFileSignature
} from 'react-icons/fa';

const GestionAuditorias = () => {
    const [auditorias, setAuditorias] = useState([]);
    const [loading, setLoading] = useState(true);
    const [tabActive, setTabActive] = useState('Interna');
    const [searchTerm, setSearchTerm] = useState('');

    // Modales
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showACPMModal, setShowACPMModal] = useState(false);
    const [showViewModal, setShowViewModal] = useState(false);
    
    // Modal Ver ACPM
    const [showVerPlanModal, setShowVerPlanModal] = useState(false);
    const [selectedPlanACPM, setSelectedPlanACPM] = useState(null);

    const [acpmInitialData, setAcpmInitialData] = useState(null);
    const [selectedAuditoria, setSelectedAuditoria] = useState(null);

    const SERVER_URL = API_URL.replace('/api', '');

    useEffect(() => {
        cargarDatos();
    }, []);

    const cargarDatos = async () => {
        setLoading(true);
        try {
            const data = await getAuditorias();
            setAuditorias(data);
        } catch (error) { console.error(error); } 
        finally { setLoading(false); }
    };

    const filteredData = auditorias.filter(item => 
        item.Tipo === tabActive && 
        (item.Auditor.toLowerCase().includes(searchTerm.toLowerCase()) || 
         item.Area_Auditada.toLowerCase().includes(searchTerm.toLowerCase()) ||
         (item.Normas && item.Normas.toLowerCase().includes(searchTerm.toLowerCase())))
    );

    // Abrir Modal Crear Plan
    const handleCreatePlan = (auditoria) => {
        setAcpmInitialData({
            origen: `Auditor√≠a ${auditoria.Tipo} #${auditoria.ID_Auditoria}`,
            descripcion: `Hallazgo en auditor√≠a realizada por ${auditoria.Auditor} en √°rea ${auditoria.Area_Auditada}. Obs: ${auditoria.Observaciones}`,
            idAuditoria: auditoria.ID_Auditoria
        });
        setShowACPMModal(true);
    };

    // Abrir Modal Ver Plan
    const handleViewPlan = async (idACPM) => {
        try {
            const plan = await getACPMById(idACPM);
            setSelectedPlanACPM(plan);
            setShowVerPlanModal(true);
        } catch (error) {
            console.error("Error cargando plan", error);
        }
    };

    const handleViewAuditoria = (auditoria) => {
        setSelectedAuditoria(auditoria);
        setShowViewModal(true);
    };

    const getFileIcon = (url) => {
        if (!url) return <FaExternalLinkAlt />;
        const ext = url.split('.').pop().toLowerCase();
        if (ext === 'pdf') return <FaFilePdf />;
        if (['jpg', 'jpeg', 'png'].includes(ext)) return <FaImage />;
        return <FaFileAlt />;
    };

    // --- ESTILOS CSS RESPONSIVE ---
    const styles = `
        .page-container { padding: 20px; animation: fadeIn 0.5s ease-in-out; }
        .header-container { display: flex; justify-content: space-between; alignItems: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 15px; }
        .filter-container { display: flex; justify-content: space-between; alignItems: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .search-box { position: relative; min-width: 300px; }
        
        /* ESTILOS DE LA TABLA RESPONSIVE */
        .table-wrapper { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; }
        .responsive-table { width: 100%; border-collapse: collapse; }
        .responsive-table thead { background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .responsive-table th { padding: 15px; text-align: left; color: #475569; font-size: 0.85rem; text-transform: uppercase; }
        .responsive-table td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }

        /* Media Query para M√≥viles (Menos de 768px) */
        @media (max-width: 768px) {
            .page-container { padding: 10px; }
            .header-container { flex-direction: column; align-items: flex-start; }
            .header-container button { width: 100%; justify-content: center; }
            .filter-container { flex-direction: column-reverse; align-items: stretch; }
            .search-box { min-width: 100%; }
            
            /* Transformaci√≥n de Tabla a Tarjetas */
            .responsive-table thead { display: none; }
            .responsive-table, .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
            .responsive-table tr { margin-bottom: 15px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            .responsive-table td { text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
            .responsive-table td::before { 
                content: attr(data-label); 
                position: absolute; left: 15px; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: 700; color: #64748b; font-size: 0.8rem; text-transform: uppercase;
            }
            .responsive-table td:last-child { border-bottom: 0; justify-content: center; padding: 15px; }
            .responsive-table td:last-child::before { display: none; } /* Ocultar label en acciones */
            
            .action-buttons { width: 100%; justify-content: space-between; }
        }
    `;

    return (
        <div className="page-container">
            <style>{styles}</style>
            
            {/* CABECERA */}
            <div className="header-container">
                <div>
                    <h1 style={{ fontSize: '1.8rem', color: '#1e293b', margin: 0, display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <FaClipboardList style={{ color: '#0c4760' }} /> 
                        Gestionar Auditor√≠as
                    </h1>
                    <p style={{ color: '#64748b', margin: '5px 0 0 0', fontSize: '0.95rem' }}>
                        Control de auditor√≠as internas, externas y evidencias.
                    </p>
                </div>
                <button 
                    className="btn-primary" 
                    onClick={() => setShowCreateModal(true)}
                    style={{ 
                        backgroundColor: '#0c4760', padding: '10px 20px', borderRadius: '8px', 
                        display: 'flex', alignItems: 'center', gap: '8px', boxShadow: '0 4px 6px -1px rgba(12, 71, 96, 0.2)',
                        color: 'white', border: 'none', cursor: 'pointer', fontWeight: 'bold'
                    }}
                >
                    <FaPlus /> Nueva Auditor√≠a
                </button>
            </div>

            {/* PESTA√ëAS Y BUSCADOR */}
            <div className="filter-container">
                <div style={{ display: 'flex', background: '#f1f5f9', padding: '5px', borderRadius: '10px', gap: '5px' }}>
                    {['Interna', 'Externa'].map(tipo => (
                        <button 
                            key={tipo}
                            onClick={() => setTabActive(tipo)}
                            style={{
                                padding: '8px 20px', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600',
                                backgroundColor: tabActive === tipo ? '#fff' : 'transparent',
                                color: tabActive === tipo ? '#0c4760' : '#64748b',
                                boxShadow: tabActive === tipo ? '0 2px 4px rgba(0,0,0,0.05)' : 'none',
                                transition: 'all 0.2s', flex: 1
                            }}
                        >
                            {tipo}s
                        </button>
                    ))}
                </div>

                <div className="search-box">
                    <FaSearch style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#94a3b8' }} />
                    <input 
                        type="text" 
                        placeholder="Buscar por auditor, √°rea, norma..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        style={{
                            width: '100%', padding: '10px 10px 10px 35px', borderRadius: '8px',
                            border: '1px solid #cbd5e1', outline: 'none', fontSize: '0.95rem'
                        }}
                    />
                </div>
            </div>

            {/* TABLA RESPONSIVE */}
            <div className="table-wrapper">
                <table className="responsive-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Auditor / Entidad</th>
                            <th>√Årea</th>
                            <th>Normas</th>
                            <th>Evidencia</th>
                            <th style={{textAlign: 'center'}}>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{ padding: '30px', textAlign: 'center', color: '#64748b' }}>Cargando registros...</td></tr>
                        ) : filteredData.length === 0 ? (
                            <tr><td colSpan="6" style={{ padding: '30px', textAlign: 'center', color: '#94a3b8' }}>No se encontraron auditor√≠as.</td></tr>
                        ) : (
                            filteredData.map(item => (
                                <tr key={item.ID_Auditoria}>
                                    <td data-label="Fecha" style={{ fontWeight: '500' }}>
                                        {new Date(item.Fecha_Registro).toLocaleDateString('es-CO')}
                                    </td>
                                    <td data-label="Auditor">
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', fontWeight: '600' }}>
                                            <FaUserTie style={{ color: '#64748b' }} /> {item.Auditor}
                                        </div>
                                    </td>
                                    <td data-label="√Årea">
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <FaBuilding style={{ color: '#94a3b8' }} /> {item.Area_Auditada}
                                        </div>
                                    </td>
                                    <td data-label="Normas">
                                        <span style={{ background: '#f0fdf4', color: '#166534', padding: '3px 8px', borderRadius: '4px', fontSize: '0.85rem', border: '1px solid #bbf7d0' }}>
                                            {item.Normas || 'General'}
                                        </span>
                                    </td>
                                    <td data-label="Evidencia">
                                        {item.Url_Evidencia ? (
                                            <a 
                                                href={`${SERVER_URL}${item.Url_Evidencia}`} 
                                                target="_blank" 
                                                rel="noreferrer" 
                                                style={{ 
                                                    display: 'inline-flex', alignItems: 'center', gap: '6px', 
                                                    color: '#0ea5e9', textDecoration: 'none', fontWeight: '500',
                                                    background: '#e0f2fe', padding: '5px 10px', borderRadius: '6px', fontSize:'0.85rem'
                                                }}
                                            >
                                                {getFileIcon(item.Url_Evidencia)} Archivo
                                            </a>
                                        ) : (
                                            <span style={{ color: '#cbd5e1', fontStyle: 'italic', fontSize: '0.9rem' }}>--</span>
                                        )}
                                    </td>
                                    <td data-label="Acciones">
                                        <div className="action-buttons" style={{ display: 'flex', justifyContent: 'center', gap: '8px', width: '100%' }}>
                                            
                                            {/* BOT√ìN VER DETALLE */}
                                            <button 
                                                onClick={() => handleViewAuditoria(item)}
                                                style={{
                                                    backgroundColor: '#f1f5f9', color: '#475569', border: '1px solid #e2e8f0',
                                                    padding: '8px', borderRadius: '6px', cursor: 'pointer',
                                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                    transition: 'all 0.2s', flex: 1, maxWidth: '40px'
                                                }}
                                                title="Ver Detalle"
                                            >
                                                <FaEye size={16} />
                                            </button>

                                            {/* BOT√ìN PLAN ACCI√ìN */}
                                            {item.ID_ACPM_Relacionado ? (
                                                <button 
                                                    onClick={() => handleViewPlan(item.ID_ACPM_Relacionado)}
                                                    style={{
                                                        backgroundColor: '#ecfdf5', color: '#059669', border: '1px solid #a7f3d0',
                                                        padding: '6px 12px', borderRadius: '6px', cursor: 'pointer',
                                                        display: 'inline-flex', alignItems: 'center', gap: '6px', justifyContent: 'center',
                                                        fontWeight: '600', fontSize: '0.85rem', transition: 'all 0.2s', flex: 2
                                                    }}
                                                >
                                                    <FaEye /> Ver Plan
                                                </button>
                                            ) : (
                                                <button 
                                                    onClick={() => handleCreatePlan(item)}
                                                    style={{
                                                        backgroundColor: '#fff', color: '#dc2626', border: '1px solid #fca5a5',
                                                        padding: '6px 12px', borderRadius: '6px', cursor: 'pointer',
                                                        display: 'inline-flex', alignItems: 'center', gap: '6px', justifyContent: 'center',
                                                        fontWeight: '600', fontSize: '0.85rem', transition: 'all 0.2s', flex: 2
                                                    }}
                                                >
                                                    <FaFileSignature /> Crear Plan
                                                </button>
                                            )}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <ModalCrearAuditoria isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} onSuccess={cargarDatos} />
            
            <ModalCreateACPM 
                isOpen={showACPMModal} 
                onClose={() => setShowACPMModal(false)} 
                initialData={acpmInitialData}
                onSuccess={cargarDatos} 
            />

            <ModalVerAuditoria 
                isOpen={showViewModal}
                onClose={() => setShowViewModal(false)}
                auditoria={selectedAuditoria}
            />

            <ModalVerACPM 
                isOpen={showVerPlanModal}
                onClose={() => setShowVerPlanModal(false)}
                acpm={selectedPlanACPM}
            />
        </div>
    );
};

export default GestionAuditorias;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionCalibracion.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';
import { 
    getCronogramas, 
    getActividades, 
    deleteActividad 
} from '../../services/cronogramaService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager'; 
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

// Modales de Gesti√≥n de Actividades
import ModalCreateActividad from '../../components/modals/ModalCreateActividad'; 
import ModalEditarActividad from '../../components/modals/ModalEditarActividad';     
import ModalGestionarActividad from '../../components/modals/ModalGestionarActividad'; 
import ModalDetalleActividad from '../../components/modals/ModalDetalleActividad';     

import { 
    FaPlus, FaSearch, FaTrash, FaFolder, FaTimes, 
    FaBalanceScale, FaRulerCombined, FaTachometerAlt, FaWeightHanging, FaThermometerHalf, 
    FaFileContract, FaChartLine, FaWrench,
    FaClipboardCheck, FaCheckCircle, FaExclamationTriangle, FaCheckDouble, 
    FaEye, FaTools, FaFilter, FaCalendarAlt, FaSync, FaListAlt, FaInfoCircle, FaEdit, FaLock, FaUserTie
} from 'react-icons/fa';

import '../../styles/Cronograma.css'; 
import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 

// --- MAPA DE ICONOS ---
const ICON_MAP = {
    'scale': <FaBalanceScale />, 
    'ruler': <FaRulerCombined />, 
    'gauge': <FaTachometerAlt />,
    'weight': <FaWeightHanging />, 
    'thermo': <FaThermometerHalf />, 
    'tools': <FaWrench />,
    'contract': <FaFileContract />, 
    'chart': <FaChartLine />, 
    'folder': <FaFolder />
};

const GestionCalibracion = () => {
    const [activeTab, setActiveTab] = useState('cronograma');

    // --- ESTADOS CRONOGRAMA ---
    const [listaCronogramas, setListaCronogramas] = useState([]); 
    const [idCronogramaSeleccionado, setIdCronogramaSeleccionado] = useState(''); 
    const [actividades, setActividades] = useState([]);
    const [loadingCronograma, setLoadingCronograma] = useState(false);
    
    // --- ESTADOS DE MODALES DE ACTIVIDADES ---
    const [showModalActividad, setShowModalActividad] = useState(false);         
    const [showEditAct, setShowEditAct] = useState(false);                       
    const [showManageAct, setShowManageAct] = useState(false);                   
    const [showDetailAct, setShowDetailAct] = useState(false);                   
    const [selectedActividad, setSelectedActividad] = useState(null);            

    // --- ESTADOS GESTI√ìN DOCUMENTAL ---
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo: '', descripcion: '', color: '#0c4760', icono: 'scale' });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // Efectos
    useEffect(() => {
        if (activeTab === 'documentacion') loadCards();
        if (activeTab === 'reportes') fetchReportes();
        if (activeTab === 'cronograma') cargarTodosLosCronogramas();
    }, [activeTab]); 

    useEffect(() => {
        if (idCronogramaSeleccionado) {
            fetchActividades(idCronogramaSeleccionado);
        } else {
            setActividades([]);
        }
    }, [idCronogramaSeleccionado]);

    // ==========================================
    // 1. L√ìGICA CRONOGRAMA (Tipo: CALIBRACION)
    // ==========================================
    const cargarTodosLosCronogramas = async () => {
        setLoadingCronograma(true);
        try {
            const todos = await getCronogramas('CALIBRACION'); 
            
            todos.sort((a, b) => {
                if (b.Anio !== a.Anio) return b.Anio - a.Anio; 
                return a.Nombre.localeCompare(b.Nombre);
            });
            setListaCronogramas(todos);
            
            if (todos.length > 0 && !idCronogramaSeleccionado) {
                setIdCronogramaSeleccionado(todos[0].ID_Cronograma);
            } else if (todos.length === 0) {
                setIdCronogramaSeleccionado('');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudieron cargar los programas', 'error');
        } finally {
            setLoadingCronograma(false);
        }
    };

    const fetchActividades = async (id) => {
        setLoadingCronograma(true);
        try {
            const acts = await getActividades(id);
            setActividades(acts);
        } catch (error) {
            console.error(error);
            setActividades([]);
        } finally {
            setLoadingCronograma(false);
        }
    };

    const handleDeleteActividad = async (id) => {
        if(await Swal.fire({title:'¬øEliminar actividad?', text:'Esta acci√≥n no se puede deshacer', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>r.isConfirmed)){
            try {
                await deleteActividad(id);
                Swal.fire('Eliminado', 'Actividad eliminada', 'success');
                fetchActividades(idCronogramaSeleccionado); 
            } catch (error) {
                Swal.fire('Error', 'No se pudo eliminar', 'error');
            }
        }
    };

    // ==========================================
    // 2. L√ìGICA DOCUMENTACI√ìN (Tipo: CALIBRACION)
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/CALIBRACION`, { headers: getAuthHeaders() });
            const data = await res.json();
            setCards(data);
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'CALIBRACION' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: '#0c4760', icono:'scale' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({title:'¬øBorrar carpeta?', text:'Se ocultar√° el acceso, los archivos permanecen en el Drive.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootModuleId = await findOrCreateFolder(1, "Programa de Calibraci√≥n", headers);
            let categoryFolderId = await findOrCreateFolder(rootModuleId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: categoryFolderId });
            setShowFileManager(true);
        } catch (error) {
            Swal.fire('Error', 'No se pudo acceder al repositorio.', 'error');
        } finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (parentId, folderName, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data = await res.json();
        const existing = data.carpetas.find(c => c.NombreCarpeta === folderName);
        if (existing) return existing.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, {
            method: 'POST', headers,
            body: JSON.stringify({ nombre: folderName, idPadre: parentId })
        });
        const res2 = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === folderName).ID_Carpeta;
    };

    // ==========================================
    // 3. L√ìGICA REPORTES (Programa: Calibraci√≥n)
    // ==========================================
    const fetchReportes = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            const onlyCalib = data.filter(r => r.Programa === 'Calibraci√≥n');
            setReportes(onlyCalib);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const filteredReportes = reportes.filter(item => {
        const textMatch = (item.Usuario || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                          (item.Activo || '').toLowerCase().includes(searchTerm.toLowerCase());
        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
        return textMatch && statusMatch;
    });

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte Calibraci√≥n #${rep.ID_Reporte}`,
            descripcion: `Desviaci√≥n en instrumento: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // --- RENDERIZADO ---
    return (
        <div>
            {/* CABECERA */}
            <div className="page-header">
                <div style={{display:'flex', gap:'15px', alignItems:'center'}}>
                    <div style={{background:'#e0f2fe', padding:'10px', borderRadius:'12px', color:'#0284c7'}}>
                        <FaBalanceScale size={28}/>
                    </div>
                    <div>
                        <h1 className="page-title">Programa de Calibraci√≥n</h1>
                        <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de instrumentos de medici√≥n y certificados.</p>
                    </div>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button 
                    onClick={() => setActiveTab('cronograma')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'cronograma' ? '#0c4760' : 'transparent',
                        color: activeTab === 'cronograma' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaCalendarAlt/> Cronograma Anual
                </button>
                <button 
                    onClick={() => setActiveTab('documentacion')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'documentacion' ? '#0c4760' : 'transparent',
                        color: activeTab === 'documentacion' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaFolder/> Documentaci√≥n
                </button>
                <button 
                    onClick={() => setActiveTab('reportes')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'reportes' ? '#0c4760' : 'transparent',
                        color: activeTab === 'reportes' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaClipboardCheck/> Reportes de Verificaci√≥n
                </button>
            </div>

            {/* --- TAB 1: CRONOGRAMA ANUAL --- */}
            {activeTab === 'cronograma' && (
                <div className="fade-in">
                    
                    {/* BARRA SUPERIOR (Selector) */}
                    <div style={{display:'flex', flexWrap:'wrap', gap:'20px', alignItems:'end', marginBottom:'1.5rem', background:'white', padding:'15px', borderRadius:'12px', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}}>
                        <div style={{display:'flex', flexDirection:'column', gap:'5px', flexGrow: 1}}>
                            <label style={{fontWeight:'bold', color:'#334155', fontSize:'0.9rem'}}>Selecciona Programa de Calibraci√≥n</label>
                            <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                                <FaListAlt className="text-gray-400"/>
                                <select 
                                    value={idCronogramaSeleccionado} 
                                    onChange={(e) => setIdCronogramaSeleccionado(e.target.value)}
                                    disabled={listaCronogramas.length === 0}
                                    style={{padding:'8px 15px', borderRadius:'6px', border:'1px solid #cbd5e1', outline:'none', color:'#334155', width:'100%', fontWeight:'600'}}
                                >
                                    {listaCronogramas.length === 0 ? (
                                        <option value="">-- No hay programas de Calibraci√≥n creados --</option>
                                    ) : (
                                        listaCronogramas.map(c => (
                                            <option key={c.ID_Cronograma} value={c.ID_Cronograma}>
                                                {c.Nombre} - ({c.Anio})
                                            </option>
                                        ))
                                    )}
                                </select>
                            </div>
                        </div>

                        <div style={{display:'flex', gap:'10px'}}>
                            <button 
                                onClick={cargarTodosLosCronogramas} 
                                className="btn-icon"
                                title="Recargar lista"
                                style={{padding:'10px', background:'#f1f5f9', color:'#64748b', borderRadius:'6px', border:'none', cursor:'pointer'}}
                            >
                                <FaSync />
                            </button>
                        </div>
                    </div>

                    {/* CONTENIDO CRONOGRAMA */}
                    {loadingCronograma ? (
                        <div style={{textAlign:'center', padding:'40px', color:'#64748b'}}>Cargando...</div>
                    ) : (
                        !idCronogramaSeleccionado ? (
                            <div style={{textAlign:'center', padding:'60px', background:'white', borderRadius:'12px', border:'2px dashed #cbd5e1'}}>
                                <FaCalendarAlt size={50} style={{color:'#cbd5e1', marginBottom:'15px'}} />
                                <h3 style={{color:'#334155', fontSize:'1.2rem', margin:'0 0 10px 0'}}>Ning√∫n Programa Seleccionado</h3>
                                <p style={{color:'#64748b'}}>Selecciona un programa de la lista superior para gestionar sus calibraciones.</p>
                            </div>
                        ) : (
                            <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center" style={{padding:'15px 20px'}}>
                                    <h2 className="font-bold text-gray-700">Actividades Programadas</h2>
                                    {/* BOT√ìN AZUL - NUEVA ACTIVIDAD */}
                                    <button 
                                        onClick={() => setShowModalActividad(true)}
                                        className="btn-primary" 
                                        style={{background:'#0c4760', display:'flex', alignItems:'center', gap:'8px', padding:'8px 16px', fontSize:'0.9rem'}}
                                    >
                                        <FaPlus /> Nueva Actividad
                                    </button>
                                </div>

                                <div className="table-container">
                                    <table className="custom-table">
                                        <thead>
                                            <tr>
                                                <th>Actividad</th>
                                                <th>Responsable</th>
                                                <th>Fecha L√≠mite</th>
                                                <th>Estado</th>
                                                <th style={{textAlign:'center'}}>Evidencia</th>
                                                <th style={{textAlign:'right'}}>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {actividades.length === 0 ? (
                                                <tr><td colSpan="6" style={{textAlign:'center', padding:'30px', color:'#94a3b8'}}>No hay actividades en este programa.</td></tr>
                                            ) : (
                                                actividades.map(act => (
                                                    <tr key={act.ID_Actividad}>
                                                        <td><strong>{act.Nombre_Actividad}</strong></td>
                                                        <td><FaUserTie style={{marginRight:'5px', color:'#94a3b8'}}/> {act.Responsable}</td>
                                                        <td>{new Date(act.Fecha_Inicio).toLocaleDateString()}</td>
                                                        <td>
                                                            <span className={`status-badge status-${act.Estado ? act.Estado.toLowerCase() : 'pendiente'}`}>
                                                                {act.Estado}
                                                            </span>
                                                        </td>
                                                        <td style={{textAlign:'center'}}>
                                                            {act.Url_Evidencia ? (
                                                                <a href={act.Url_Evidencia} target="_blank" rel="noreferrer" style={{color:'#0ea5e9'}}>
                                                                    <FaEye/>
                                                                </a>
                                                            ) : '-'}
                                                        </td>
                                                        <td style={{textAlign:'right'}}>
                                                            <div className="action-buttons" style={{display:'flex', justifyContent:'flex-end', gap:'8px'}}>
                                                                
                                                                {/* Ver Detalle */}
                                                                <button className="btn-icon" onClick={() => {
                                                                    setSelectedActividad({...act, Fecha_Programada: act.Fecha_Inicio}); 
                                                                    setShowDetailAct(true);
                                                                }} title="Ver Detalle" style={{background:'none', border:'none', cursor:'pointer'}}>
                                                                    <FaInfoCircle color="#64748b" size={16}/>
                                                                </button>

                                                                {/* Gestionar / Editar (Solo si no est√° cerrada) */}
                                                                {act.Estado !== 'Realizada' && act.Estado !== 'Cancelada' ? (
                                                                    <>
                                                                        <button className="btn-icon" onClick={() => {
                                                                            setSelectedActividad({...act, Fecha_Programada: act.Fecha_Inicio}); 
                                                                            setShowManageAct(true);
                                                                        }} title="Gestionar" style={{background:'none', border:'none', cursor:'pointer'}}>
                                                                            <FaTools color="#0ea5e9" size={16}/>
                                                                        </button>
                                                                        
                                                                        <button className="btn-icon" onClick={() => {
                                                                            setSelectedActividad({...act, Fecha_Programada: act.Fecha_Inicio}); 
                                                                            setShowEditAct(true);
                                                                        }} title="Editar" style={{background:'none', border:'none', cursor:'pointer'}}>
                                                                            <FaEdit color="#f59e0b" size={16}/>
                                                                        </button>
                                                                    </>
                                                                ) : (
                                                                    <span title="Cerrada" style={{padding:'5px'}}><FaLock color="#10b981"/></span>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )
                    )}
                </div>
            )}

            {/* --- TAB 2: DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button onClick={()=>setShowCreateCardModal(true)} style={{border:'none', background:'transparent', color:'#0c4760', fontWeight:'bold', cursor:'pointer'}}>+ Nueva Carpeta</button>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)}
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            <div onClick={() => setShowCreateCardModal(true)}
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column',
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px',
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#0c4760'; e.currentTarget.style.color = '#0c4760'; e.currentTarget.style.background = '#f0f9ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- TAB 3: REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                      <div className="control-bar">
                        <div className="search-box">
                            <FaSearch />
                            <input className="search-input" placeholder="Buscar reporte..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Instrumento / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredReportes.length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de calibraci√≥n.</td></tr> :
                                filteredReportes.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                
                                                {/* --- AQU√ç EST√Å EL CAMBIO SOLICITADO --- */}
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Con Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {/* -------------------------------------- */}

                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES GLOBALES */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h2>Nueva Carpeta</h2><button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button></div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group"><label>T√≠tulo</label><input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Certificados Balanzas" /></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} /></div>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                <div className="form-group"><label>Icono</label>
                                    <div style={{display:'flex', gap:'10px', marginTop:'5px', flexWrap:'wrap'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} style={{padding:'10px', borderRadius:'8px', cursor:'pointer', fontSize:'1.2rem', border: newCardData.icono === key ? `2px solid #0c4760` : '1px solid #e2e8f0', color: newCardData.icono === key ? '#0c4760' : '#64748b', background: newCardData.icono === key ? '#f0f9ff' : 'transparent', display:'flex', alignItems:'center', justifyContent:'center', width:'45px', height:'45px'}}>{ICON_MAP[key]}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer"><button type="submit" className="btn-primary" style={{backgroundColor: '#0c4760'}}>Crear Carpeta</button></div>
                        </form>
                    </div>
                </div>
            )}

            {/* --- MODAL FILE MANAGER CORREGIDO --- */}
            {showFileManager && (
                <div className="modal-overlay"> 
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Calibraci√≥n: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color:'#0c4760'}}>‚óè</div></div>}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportes} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportes} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />

            {/* --- MODALES DE GESTI√ìN DE ACTIVIDADES --- */}
            
            {/* 1. Crear Actividad */}
            {idCronogramaSeleccionado && (
                <ModalCreateActividad 
                    isOpen={showModalActividad}
                    onClose={() => setShowModalActividad(false)}
                    idCronograma={idCronogramaSeleccionado}
                    onSuccess={() => {
                        setShowModalActividad(false);
                        fetchActividades(idCronogramaSeleccionado);
                    }}
                />
            )}

            {/* 2. Editar Actividad */}
            <ModalEditarActividad 
                isOpen={showEditAct} 
                onClose={() => setShowEditAct(false)} 
                actividad={selectedActividad} 
                onSuccess={() => {
                    setShowEditAct(false);
                    fetchActividades(idCronogramaSeleccionado);
                }} 
            />

            {/* 3. Gestionar Actividad */}
            <ModalGestionarActividad 
                isOpen={showManageAct} 
                onClose={() => setShowManageAct(false)} 
                actividad={selectedActividad} 
                onSuccess={() => {
                    setShowManageAct(false);
                    fetchActividades(idCronogramaSeleccionado);
                }} 
            />

            {/* 4. Detalle Actividad */}
            <ModalDetalleActividad 
                isOpen={showDetailAct} 
                onClose={() => setShowDetailAct(false)} 
                actividad={selectedActividad} 
            />
        </div>
    );
};

export default GestionCalibracion;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionCapacitaciones.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders, apiFetchBlob, extractFilename } from '../../services/api';
import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 
import { 
    FaTrash, FaPlus, FaEye, FaListOl, FaArrowLeft, 
    FaUserGraduate, FaFilePdf, FaFilePowerpoint, FaChartLine, 
    FaHistory, FaChalkboardTeacher, FaClipboardList,
    FaFileContract, FaPaperclip, FaCertificate, FaUsers, 
    FaCogs, FaFolder, FaTimes, FaImage, FaSignOutAlt, 
    FaClipboardCheck, FaSearch, FaFilter, FaExclamationTriangle, FaCheckCircle, FaCheckDouble
} from 'react-icons/fa';

import ModalVerDetalleCapacitacion from '../../components/modals/ModalVerDetalleCapacitacion';
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';

// MAPA DE ICONOS
const ICON_MAP = {
    'contract': <FaFileContract />,
    'clip': <FaPaperclip />,
    'teacher': <FaChalkboardTeacher />,
    'cert': <FaCertificate />,
    'list': <FaClipboardList />,
    'users': <FaUsers />,
    'cogs': <FaCogs />,
    'folder': <FaFolder />
};

const GestionCapacitaciones = () => {
    const [activeTab, setActiveTab] = useState('capacitaciones'); 
    
    // Estados Gesti√≥n Capacitaci√≥n
    const [capacitaciones, setCapacitaciones] = useState([]);
    const [newCap, setNewCap] = useState({ titulo: '', descripcion: '' });
    const [archivoCap, setArchivoCap] = useState(null);
    const [loading, setLoading] = useState(false);

    // Editor de Examen
    const [showEditor, setShowEditor] = useState(false);
    const [selectedCapForEditor, setSelectedCapForEditor] = useState(null);
    const [preguntasEditor, setPreguntasEditor] = useState([]);
    
    // Nueva pregunta
    const [nuevaPregunta, setNuevaPregunta] = useState({ texto: '', opcionA: '', opcionB: '', opcionC: '', correcta: 0 });
    const [imagenPregunta, setImagenPregunta] = useState(null);

    // Resultados
    const [viewLevel, setViewLevel] = useState(0); 
    const [resumenCursos, setResumenCursos] = useState([]);
    const [usuariosCurso, setUsuariosCurso] = useState([]);
    const [historialUsuario, setHistorialUsuario] = useState([]);
    const [selectedCurso, setSelectedCurso] = useState(null);
    const [selectedUser, setSelectedUser] = useState(null);

    // Modales Capacitaci√≥n
    const [showDetalleModal, setShowDetalleModal] = useState(false);
    const [selectedResultado, setSelectedResultado] = useState(null);

    // Gesti√≥n Documental
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo:'', descripcion:'', color:'#0c4760', icono:'folder' });

    // --- REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);

    useEffect(() => {
        if (activeTab === 'capacitaciones') {
            loadCapacitaciones();
            loadCards(); 
        }
        if (activeTab === 'resultados') loadResumenCursos();
        if (activeTab === 'reportes') fetchReportes(); 
    }, [activeTab]);

    // --- AUTH ERROR HANDLER ---
    const handleAuthError = () => {
        Swal.fire({
            title: 'Sesi√≥n Caducada',
            text: 'Por seguridad, tu sesi√≥n ha terminado. Inicia sesi√≥n nuevamente.',
            icon: 'warning',
            confirmButtonText: 'Ir al Login',
            allowOutsideClick: false
        }).then(() => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/'; 
        });
    };

    // --- FUNCI√ìN SEGURA PARA VER MATERIAL (PDF/VIDEO) ---
    const handleViewMaterial = async (urlMaterial) => {
        if (!urlMaterial) return;
        try {
            const filename = extractFilename(urlMaterial);
            // Usamos ruta segura (Debemos crearla en backend)
            const blob = await apiFetchBlob(`/capacitacion/material/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al ver material:", error);
            // Fallback para links externos
            if(urlMaterial.startsWith('http')) {
                window.open(urlMaterial, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo cargar el material educativo', 'error');
            }
        }
    };

    // --- CARGAS DE DATOS ---
    const loadCards = async () => {
        try {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/core/tarjetas/CAPACITACION`, { 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (res.status === 401) return handleAuthError();
            if (res.ok) setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const loadCapacitaciones = async () => {
        try { 
            const token = localStorage.getItem('token');
            if(!token) return;

            const res = await fetch(`${API_URL}/capacitacion`, { 
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                } 
            });
            
            if (res.status === 401) return handleAuthError();
            if (!res.ok) throw new Error("Error cargando datos");
            
            const data = await res.json();
            setCapacitaciones(Array.isArray(data) ? data : []);
        } catch (e) { 
            console.error("Error loadCapacitaciones:", e);
            setCapacitaciones([]); 
        }
    };
    
    const loadResumenCursos = async () => { 
        setLoading(true); 
        try { 
            const res = await fetch(`${API_URL}/capacitacion/admin/resumen`, { headers: getAuthHeaders() }); 
            if(res.status === 401) return handleAuthError();
            if(res.ok) setResumenCursos(await res.json());
        } catch (e) { console.error(e); } finally { setLoading(false); } 
    };

    const fetchReportes = async () => {
        setLoadingReportes(true);
        try {
            const res = await fetch(`${API_URL}/reportes`, { headers: getAuthHeaders() });
            if (res.status === 401) return handleAuthError();
            if (res.ok) {
                const data = await res.json();
                const onlyCap = data.filter(r => r.Programa === 'Capacitaci√≥n' || r.Categoria === 'Capacitacion');
                setReportes(onlyCap);
            }
        } catch (e) { console.error(e); } 
        finally { setLoadingReportes(false); }
    };

    const filteredReportes = reportes.filter(item => {
        const textMatch = (item.Usuario || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                          (item.Activo || '').toLowerCase().includes(searchTerm.toLowerCase());
        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
        return textMatch && statusMatch;
    });

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };

    // --- HANDLERS EXISTENTES ---
    const handleSelectCurso = async (curso) => { 
        setSelectedCurso(curso); 
        setLoading(true); 
        try { 
            const res = await fetch(`${API_URL}/capacitacion/admin/usuarios/${curso.ID_Evaluacion}`, { headers: getAuthHeaders() }); 
            if(res.status === 401) return handleAuthError();
            if(res.ok) {
                setUsuariosCurso(await res.json()); 
                setViewLevel(1); 
            }
        } catch (e) { console.error(e); } finally { setLoading(false); } 
    };
    
    const handleSelectUsuario = async (user) => { 
        setSelectedUser(user); 
        setLoading(true); 
        try { 
            const res = await fetch(`${API_URL}/capacitacion/admin/historial/${selectedCurso.ID_Evaluacion}?nombre=${encodeURIComponent(user.Nombre_Evaluado)}`, { headers: getAuthHeaders() }); 
            if(res.status === 401) return handleAuthError();
            if(res.ok) {
                setHistorialUsuario(await res.json()); 
                setViewLevel(2); 
            }
        } catch (e) { console.error(e); } finally { setLoading(false); } 
    };

    const handleCreateCapacitacion = async (e) => { 
        e.preventDefault(); 
        if (!archivoCap) return Swal.fire('Falta archivo', 'Suba el material', 'warning'); 
        
        const token = localStorage.getItem('token');
        if (!token) return handleAuthError();

        const formData = new FormData(); 
        formData.append('titulo', newCap.titulo); 
        formData.append('descripcion', newCap.descripcion); 
        formData.append('archivo', archivoCap); 
        
        setLoading(true); 
        try { 
            const res = await fetch(`${API_URL}/capacitacion`, { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${token}` }, 
                body: formData 
            }); 

            if (res.status === 401) return handleAuthError();

            if (res.ok) { 
                Swal.fire('Creado', 'Capacitaci√≥n subida con √©xito', 'success'); 
                setNewCap({titulo:'', descripcion:''}); 
                setArchivoCap(null); 
                const fileInput = document.getElementById('fileInputCap');
                if(fileInput) fileInput.value = '';
                loadCapacitaciones(); 
            } else { throw new Error("Error al subir"); }
        } catch (e) {
            console.error(e);
            Swal.fire('Error', 'No se pudo subir la capacitaci√≥n', 'error');
        } finally { setLoading(false); } 
    };
    
    const openEditor = async (cap) => { 
        setSelectedCapForEditor(cap); 
        setShowEditor(true); 
        try {
            const res = await fetch(`${API_URL}/capacitacion/preguntas/${cap.ID_Evaluacion}`, { headers: getAuthHeaders() });
            if (res.status === 401) return handleAuthError();
            if (res.ok) setPreguntasEditor(await res.json());
        } catch(e) {} 
    };
    
    const handleAddPregunta = async (e) => {
        e.preventDefault();
        const { texto, opcionA, opcionB, opcionC, correcta } = nuevaPregunta;
        if(!texto.trim()) return Swal.fire('Atenci√≥n', 'Escriba el enunciado', 'warning');
        if(!opcionA.trim() || !opcionB.trim()) return Swal.fire('Atenci√≥n', 'M√≠nimo 2 opciones', 'warning');

        const token = localStorage.getItem('token');
        if (!token) return handleAuthError();

        const opcionesArr = [
            { texto: opcionA, esCorrecta: parseInt(correcta) === 0 },
            { texto: opcionB, esCorrecta: parseInt(correcta) === 1 }
        ];
        if (opcionC.trim()) opcionesArr.push({ texto: opcionC, esCorrecta: parseInt(correcta) === 2 });

        const formData = new FormData();
        formData.append('idEvaluacion', selectedCapForEditor.ID_Evaluacion);
        formData.append('texto', texto);
        formData.append('opciones', JSON.stringify(opcionesArr)); 
        if (imagenPregunta) formData.append('imagen', imagenPregunta);

        setLoading(true);
        try {
            const res = await fetch(`${API_URL}/capacitacion/preguntas`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (res.status === 401) return handleAuthError();

            if(res.ok) {
                setNuevaPregunta({ texto: '', opcionA: '', opcionB: '', opcionC: '', correcta: 0 });
                setImagenPregunta(null); 
                const imgInput = document.getElementById('fileInputImg');
                if(imgInput) imgInput.value = '';
                openEditor(selectedCapForEditor);
                Swal.fire({ icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false });
            } else { throw new Error('Error al guardar'); }
        } catch(e) { Swal.fire('Error', 'No se pudo guardar la pregunta', 'error'); } 
        finally { setLoading(false); }
    };

    const handleDeletePregunta = async (id) => { 
        if(await Swal.fire({ title: '¬øEliminar?', icon: 'warning', showCancelButton: true }).then(r => r.isConfirmed)) { 
            const res = await fetch(`${API_URL}/capacitacion/preguntas/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
            if (res.status === 401) return handleAuthError();
            openEditor(selectedCapForEditor); 
        } 
    };

    // --- TARJETAS ---
    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'CAPACITACION' })
            });
            if (res.status === 401) return handleAuthError();
            if(res.ok) {
                Swal.fire('√âxito', 'Tarjeta agregada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color:'#0c4760', icono:'folder' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({title:'¬øBorrar tarjeta?', text:'Se ocultar√° el acceso.', icon:'warning', showCancelButton:true}).then(r=>r.isConfirmed)){
            const res = await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            if (res.status === 401) return handleAuthError();
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootModuleId = await findOrCreateFolder(1, "Gesti√≥n Capacitaci√≥n", headers);
            let categoryFolderId = await findOrCreateFolder(rootModuleId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: categoryFolderId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'No se pudo acceder al repositorio.', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (parentId, folderName, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        if(res.status === 401) { handleAuthError(); return; }
        const data = await res.json();
        const existing = data.carpetas.find(c => c.NombreCarpeta === folderName);
        if (existing) return existing.ID_Carpeta;
        
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: folderName, idPadre: parentId }) });
        
        const res2 = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === folderName).ID_Carpeta;
    };

    return (
        <div>
            <div className="page-header">
                <div><h1 className="page-title">Centro de Capacitaci√≥n</h1><p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n integral de formaci√≥n.</p></div>
            </div>

            {/* SECCI√ìN DE TARJETAS */}
            <div style={{marginBottom:'2rem'}}>
                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                    <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Documentaci√≥n T√©cnica</h3>
                    <small style={{color:'#64748b'}}>Gestione las carpetas del repositorio</small>
                </div>
                
                <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                    {cards.map((card) => (
                        <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} style={{background:'white', padding:'1.2rem', borderRadius:'12px', border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s', position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)'}} onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }} onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}>
                            <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>{ICON_MAP[card.Icono] || <FaFolder/>}</div>
                                <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px', borderRadius:'50%'}} title="Eliminar"><FaTrash size={12}/></button>
                            </div>
                            <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                            <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                        </div>
                    ))}
                    <div onClick={() => setShowCreateCardModal(true)} style={{border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px', color:'#94a3b8', transition:'all 0.2s'}} onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#0c4760'; e.currentTarget.style.color = '#0c4760'; e.currentTarget.style.background = '#f0f9ff'; }} onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}>
                        <FaPlus size={30} /><span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Categor√≠a</span>
                    </div>
                </div>
            </div>

            {/* TABS */}
            <div style={{display:'flex', gap:'5px', background:'#e2e8f0', padding:'4px', borderRadius:'10px', height:'fit-content', marginBottom:'1.5rem', width:'fit-content'}}>
                <button onClick={() => { setActiveTab('capacitaciones'); setShowEditor(false); }} style={{padding: '8px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'600', fontSize:'0.9rem', background: activeTab === 'capacitaciones' ? 'white' : 'transparent', color: activeTab === 'capacitaciones' ? '#0c4760' : '#64748b', boxShadow: activeTab === 'capacitaciones' ? '0 2px 5px rgba(0,0,0,0.05)' : 'none', transition: 'all 0.2s', display:'flex', alignItems:'center', gap:'8px'}}><FaChalkboardTeacher/> Plataforma E-Learning</button>
                <button onClick={() => { setActiveTab('resultados'); setViewLevel(0); setShowEditor(false); }} style={{padding: '8px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'600', fontSize:'0.9rem', background: activeTab === 'resultados' ? 'white' : 'transparent', color: activeTab === 'resultados' ? '#0c4760' : '#64748b', boxShadow: activeTab === 'resultados' ? '0 2px 5px rgba(0,0,0,0.05)' : 'none', transition: 'all 0.2s', display:'flex', alignItems:'center', gap:'8px'}}><FaChartLine/> Resultados y Reportes</button>
                <button onClick={() => { setActiveTab('reportes'); setShowEditor(false); }} style={{padding: '8px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'600', fontSize:'0.9rem', background: activeTab === 'reportes' ? 'white' : 'transparent', color: activeTab === 'reportes' ? '#0c4760' : '#64748b', boxShadow: activeTab === 'reportes' ? '0 2px 5px rgba(0,0,0,0.05)' : 'none', transition: 'all 0.2s', display:'flex', alignItems:'center', gap:'8px'}}><FaClipboardCheck/> Historial Reportes</button>
            </div>

            {/* CONTENIDO TABS */}
            {activeTab === 'capacitaciones' && !showEditor && (
                <div style={{display:'grid', gridTemplateColumns:'2fr 1fr', gap:'20px'}}>
                    <div className="table-container">
                        <table className="data-table">
                            <thead><tr><th>T√≠tulo</th><th>Tipo</th><th>Preguntas</th><th>Acci√≥n</th></tr></thead>
                            <tbody>
                                {Array.isArray(capacitaciones) && capacitaciones.map(cap => (
                                    <tr key={cap.ID_Capacitacion}>
                                        <td><div style={{fontWeight:'600', color:'#1e293b'}}>{cap.Titulo}</div><div style={{fontSize:'0.8rem', color:'#64748b', marginTop:'4px'}}>{cap.Descripcion}</div></td>
                                        <td>{cap.Url_Material.includes('.pdf') ? <span className="badge" style={{background:'#fee2e2', color:'#dc2626'}}>PDF</span> : <span className="badge" style={{background:'#ffedd5', color:'#ea580c'}}>PPT</span>}</td>
                                        <td><span className="badge" style={{background:'#f1f5f9', color:'#475569'}}>{cap.Total_Preguntas || 0} Preguntas</span></td>
                                        <td><button className="btn-action" onClick={() => openEditor(cap)} title="Gestionar Preguntas" style={{display:'inline-flex', alignItems:'center', gap:'5px', width:'auto', padding:'5px 12px', fontSize:'0.85rem'}}><FaListOl /> Editar Examen</button></td>
                                    </tr>
                                ))}
                                {(!Array.isArray(capacitaciones) || capacitaciones.length === 0) && (
                                    <tr><td colSpan="4" style={{textAlign:'center', padding:'20px', color:'#888'}}>No hay capacitaciones cargadas.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                    <div className="card-section" style={{margin:0, height:'fit-content', borderTop:'4px solid #0c4760'}}>
                        <h3 style={{marginTop:0, color:'#0c4760', fontSize:'1.1rem', display:'flex', alignItems:'center', gap:'8px'}}><FaPlus/> Subir Nueva Capacitaci√≥n</h3>
                        <form onSubmit={handleCreateCapacitacion}>
                            <div className="form-group"><label>T√≠tulo del Tema</label><input type="text" className="form-control" required value={newCap.titulo} onChange={e => setNewCap({...newCap, titulo: e.target.value})} placeholder="Ej: Seguridad en Alturas" /></div>
                            <div className="form-group"><label>Descripci√≥n</label><textarea className="form-control" rows="2" value={newCap.descripcion} onChange={e => setNewCap({...newCap, descripcion: e.target.value})} placeholder="Breve resumen..." /></div>
                            <div className="form-group"><label>Material (PDF / PowerPoint)</label><div style={{position:'relative'}}><input type="file" id="fileInputCap" className="form-control" style={{paddingLeft:'40px'}} required onChange={e => setArchivoCap(e.target.files[0])} accept=".pdf,.ppt,.pptx,.mp4" /><FaFilePdf style={{position:'absolute', top:'12px', left:'12px', color:'#64748b'}}/></div></div>
                            <button type="submit" className="btn btn-blue" style={{width:'100%', marginTop:'10px'}} disabled={loading}>{loading ? 'Subiendo...' : 'Crear Capacitaci√≥n'}</button>
                        </form>
                    </div>
                </div>
            )}
            
            {/* EDITOR PREGUNTAS */}
            {activeTab === 'capacitaciones' && showEditor && selectedCapForEditor && (
                <div>
                    <button className="btn-secondary" onClick={() => setShowEditor(false)} style={{marginBottom:'1rem', display:'flex', alignItems:'center', gap:'5px', padding:'0.5rem 1rem'}}><FaArrowLeft /> Volver al Listado</button>
                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'2rem'}}>
                        <div className="card-section">
                            <h3 style={{margin:0, color:'#0c4760', borderBottom:'1px solid #eee', paddingBottom:'10px'}}>Banco de Preguntas: <span style={{fontWeight:'400', color:'#475569'}}>{selectedCapForEditor.Titulo}</span></h3>
                            <div style={{marginTop:'1rem', display:'flex', flexDirection:'column', gap:'10px', maxHeight:'600px', overflowY:'auto'}}>
                                {preguntasEditor.map((p, i) => (
                                    <div key={p.id} style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', border:'1px solid #e2e8f0'}}>
                                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-start'}}>
                                            <div style={{flex:1}}>
                                                {p.imagen && <img src={p.imagen} alt="Ref" style={{maxWidth: '150px', borderRadius:'6px', marginBottom:'10px', border:'1px solid #ddd'}} />}
                                                <strong style={{color:'#0c4760', display:'block'}}>Pregunta {i+1}:</strong> {p.pregunta}
                                                <ul style={{margin:'5px 0 0 20px', padding:0, fontSize:'0.9rem', color:'#64748b'}}>
                                                    {p.opciones.map(opt => <li key={opt.id} style={{color: opt.isCorrect ? '#16a34a' : 'inherit', fontWeight: opt.isCorrect ? 'bold' : 'normal'}}>{opt.text} {opt.isCorrect && '(Correcta)'}</li>)}
                                                </ul>
                                            </div>
                                            <button onClick={() => handleDeletePregunta(p.id)} style={{color:'#ef4444', background:'none', border:'none', cursor:'pointer', padding:'5px'}}><FaTrash/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="card-section" style={{height:'fit-content'}}>
                            <h3 style={{marginTop:0, color:'#0c4760'}}>Agregar Nueva Pregunta</h3>
                            <form onSubmit={handleAddPregunta}>
                                <div className="form-group" style={{background:'#f0f9ff', padding:'10px', borderRadius:'8px', border:'1px dashed #bae6fd'}}>
                                    <label style={{color:'#0369a1', display:'flex', alignItems:'center', gap:'5px', cursor:'pointer'}}><FaImage /> Imagen de referencia (Opcional)</label>
                                    <input type="file" id="fileInputImg" accept="image/*" className="form-control" style={{marginTop:'5px', fontSize:'0.85rem'}} onChange={e => setImagenPregunta(e.target.files[0])} />
                                </div>
                                <div className="form-group"><label>Enunciado</label><textarea className="form-control" rows="2" value={nuevaPregunta.texto} onChange={e=>setNuevaPregunta({...nuevaPregunta, texto:e.target.value})} placeholder="Ej: Seg√∫n la imagen anterior..." required/></div>
                                <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', marginTop:'10px', border:'1px solid #e2e8f0'}}>
                                    <label style={{fontWeight:'bold', fontSize:'0.85rem', color:'#64748b', marginBottom:'10px', display:'block'}}>Opciones (Marque la correcta)</label>
                                    {['A', 'B', 'C'].map((letra, idx) => (
                                        <div key={idx} style={{display:'flex', alignItems:'center', gap:'10px', marginBottom:'8px'}}>
                                            <input type="radio" name="correcta" checked={nuevaPregunta.correcta===idx} onChange={()=>setNuevaPregunta({...nuevaPregunta, correcta:idx})} style={{cursor:'pointer'}} />
                                            <input className="form-control" style={{padding:'8px', fontSize:'0.9rem'}} value={idx===0 ? nuevaPregunta.opcionA : idx===1 ? nuevaPregunta.opcionB : nuevaPregunta.opcionC} onChange={e => { if(idx===0) setNuevaPregunta({...nuevaPregunta, opcionA: e.target.value}); if(idx===1) setNuevaPregunta({...nuevaPregunta, opcionB: e.target.value}); if(idx===2) setNuevaPregunta({...nuevaPregunta, opcionC: e.target.value}); }} placeholder={`Opci√≥n ${letra}`} />
                                        </div>
                                    ))}
                                </div>
                                <button className="btn btn-blue" style={{width:'100%', marginTop:'15px'}} disabled={loading}>{loading ? 'Guardando...' : 'Guardar Pregunta'}</button>
                            </form>
                        </div>
                    </div>
                </div>
            )}

            {/* RESULTADOS E-LEARNING */}
            {activeTab === 'resultados' && (
                <div>
                     <div style={{marginBottom:'1.5rem', display:'flex', alignItems:'center', gap:'10px', fontSize:'0.95rem', color:'#64748b', background:'white', padding:'10px 15px', borderRadius:'8px', border:'1px solid #e2e8f0', width:'fit-content'}}>
                        <span style={{cursor:'pointer', fontWeight: viewLevel===0?'700':'400', color: viewLevel===0?'#0c4760':'inherit', display:'flex', alignItems:'center', gap:'5px'}} onClick={()=>setViewLevel(0)}><FaClipboardList/> Cursos</span>
                        {viewLevel > 0 && <><span style={{color:'#cbd5e1'}}>/</span><span style={{cursor:'pointer', fontWeight: viewLevel===1?'700':'400', color: viewLevel===1?'#0c4760':'inherit'}} onClick={()=>setViewLevel(1)}>{selectedCurso.Titulo}</span></>}
                        {viewLevel > 1 && <><span style={{color:'#cbd5e1'}}>/</span><span style={{fontWeight:'700', color:'#0c4760', display:'flex', alignItems:'center', gap:'5px'}}><FaUserGraduate/> {selectedUser.Nombre_Evaluado}</span></>}
                    </div>
                    
                    {viewLevel === 0 && (
                        <div className="table-container">
                            <table className="data-table">
                                <thead><tr><th>Capacitaci√≥n</th><th>Material</th><th>Estado</th><th>Participaci√≥n</th><th>Acci√≥n</th></tr></thead>
                                <tbody>
                                    {resumenCursos.map(curso => (
                                        <tr key={curso.ID_Capacitacion}>
                                            <td style={{fontWeight:'600', color:'#1e293b'}}>{curso.Titulo}</td>
                                            <td>
                                                {/* AQU√ç EST√Å EL CAMBIO IMPORTANTE */}
                                                <button 
                                                    onClick={() => handleViewMaterial(curso.Url_Material)}
                                                    className="btn-action" 
                                                    style={{color:'#0369a1', textDecoration:'none', display:'inline-flex', gap:'5px', width:'auto', padding:'5px 10px', background:'transparent', border:'none', cursor:'pointer'}}
                                                >
                                                    <FaEye/> Ver Material
                                                </button>
                                            </td>
                                            <td><span className="badge badge-success">Activo</span></td>
                                            <td><span className="badge" style={{background:'#f0f9ff', color:'#0369a1', fontSize:'0.85rem'}}>{curso.Total_Evaluaciones} Evaluaciones</span></td>
                                            <td><button className="btn-action" onClick={() => handleSelectCurso(curso)} title="Ver Participantes" style={{width:'auto', padding:'5px 12px', display:'inline-flex', gap:'5px', color:'#0c4760'}}><FaListOl /> Ver Participantes</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {viewLevel === 1 && (
                        <div className="table-container">
                            <h3 style={{padding:'1rem 1.5rem', margin:0, borderBottom:'1px solid #e2e8f0', background:'#f8fafc', color:'#0c4760'}}>Participantes: <strong>{selectedCurso.Titulo}</strong></h3>
                            <table className="data-table">
                                <thead><tr><th>Colaborador</th><th>Intentos</th><th>Mejor Nota</th><th>√öltimo Intento</th><th>Acci√≥n</th></tr></thead>
                                <tbody>
                                    {usuariosCurso.map((user, idx) => (
                                        <tr key={idx}>
                                            <td style={{fontWeight:'600'}}>{user.Nombre_Evaluado}</td>
                                            <td>{user.Intentos}</td>
                                            <td>{user.Mejor_Nota}</td>
                                            <td>{new Date(user.Ultimo_Intento).toLocaleString()}</td>
                                            <td><button className="btn-action" onClick={() => handleSelectUsuario(user)}><FaHistory/> Ver</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {viewLevel === 2 && (
                        <div className="table-container">
                            <h3 style={{padding:'1rem', margin:0}}>Historial: {selectedUser.Nombre_Evaluado}</h3>
                            <table className="data-table">
                                <thead><tr><th>Fecha</th><th>Nota</th><th>Detalle</th></tr></thead>
                                <tbody>
                                    {historialUsuario.map(intento => (
                                        <tr key={intento.ID_Resultado}>
                                            <td>{new Date(intento.Fecha_Ejecucion).toLocaleString()}</td>
                                            <td>{intento.Calificacion}</td>
                                            <td><button className="btn-action" onClick={()=>{setSelectedResultado(intento);setShowDetalleModal(true)}}><FaEye/></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            )}

            {/* --- NUEVA PESTA√ëA: HISTORIAL REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                      <div className="control-bar">
                        <div className="search-box">
                            <FaSearch />
                            <input className="search-input" placeholder="Buscar reporte..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Tema / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredReportes.length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de capacitaci√≥n registrados.</td></tr> :
                                filteredReportes.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'General'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            <ModalVerDetalleCapacitacion isOpen={showDetalleModal} onClose={() => setShowDetalleModal(false)} resultado={selectedResultado} />
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportes} />
            
            {showFileManager && (
                <div style={{position:'fixed', top:0, left:0, width:'100vw', height:'100vh', background:'rgba(0,0,0,0.7)', zIndex: 99999, display:'flex', alignItems:'center', justifyContent:'center', padding:'20px'}}>
                    <div style={{width:'900px', height:'85vh', background:'white', borderRadius:'12px', overflow:'hidden', boxShadow:'0 25px 50px -12px rgba(0,0,0,0.5)', position: 'relative'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Documentaci√≥n: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* MODAL CREAR TARJETA */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h2>Nueva Categor√≠a</h2><button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button></div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group"><label>T√≠tulo</label><input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Normativa" /></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Descripci√≥n corta" /></div>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                <div className="form-group"><label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (<div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} style={{padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.2rem', border: newCardData.icono === key ? '2px solid #0c4760' : '1px solid #e2e8f0', background: newCardData.icono === key ? '#e0f2fe' : 'white', color: newCardData.icono === key ? '#0c4760' : '#64748b'}}>{ICON_MAP[key]}</div>))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal">Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};

export default GestionCapacitaciones;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionElementosExtranos.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService'; 
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaSearch, FaFilter, FaFolder, FaPlus, FaTrash, FaTimes, 
    FaExclamationTriangle, FaCheckCircle, FaCheckDouble, FaFileContract, 
    FaEye, FaTools, FaMagnet, FaGlasses, FaBan, FaShieldAlt, FaBox
} from 'react-icons/fa';

// Mapa de Iconos Tem√°ticos
const ICON_MAP = {
    'folder': <FaFolder />,
    'magnet': <FaMagnet />,      // Para trampas magn√©ticas
    'glasses': <FaGlasses />,    // Para inspecci√≥n visual
    'ban': <FaBan />,            // Para prohibiciones/restricciones
    'shield': <FaShieldAlt />,   // Seguridad
    'box': <FaBox />
};

const GestionElementosExtranos = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('documentacion');
    
    // --- ESTADOS DOCUMENTACI√ìN ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    
    // COLOR CORPORATIVO EST√ÅNDAR
    const THEME_COLOR = '#0c4760'; 
    
    const [newCardData, setNewCardData] = useState({ 
        titulo: '', 
        descripcion: '', 
        color: THEME_COLOR, 
        icono: 'magnet' 
    });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        if(activeTab === 'documentacion') loadCards();
        if(activeTab === 'reportes') fetchReportesOperativos(); 
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            // M√≥dulo: 'ELEMENTOS'
            const res = await fetch(`${API_URL}/core/tarjetas/ELEMENTOS`, { headers: getAuthHeaders() });
            setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'ELEMENTOS' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'magnet' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la carpeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso directo.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootId = await findOrCreateFolder(1, "Elementos Extra√±os", headers);
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error al acceder al repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        return (await res2.json()).carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            // Filtrar reportes para Elementos Extra√±os
            const filtered = data.filter(r => 
                (r.Programa === 'Elementos Extra√±os') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('vidrio')) ||
                (r.Categoria && r.Categoria.toLowerCase().includes('plastico')) ||
                (r.Categoria && r.Categoria.toLowerCase().includes('metal'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Control Elementos Extra√±os #${rep.ID_Reporte}`,
            descripcion: `Hallazgo potencial de contaminaci√≥n: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // Helper estilos tabs
    const getTabStyle = (isActive) => ({
        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
        background: isActive ? THEME_COLOR : 'transparent', 
        color: isActive ? 'white' : '#64748b', 
        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
    });

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaMagnet style={{color: THEME_COLOR}}/> Control de Elementos Extra√±os
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de vidrio, pl√°stico quebradizo, metales y otros contaminantes.</p>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion')}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes')}>
                    <FaFileContract/> Reportes Operativos
                </button>
            </div>

            {/* --- CONTENIDO DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            {/* TARJETA DE "NUEVA CARPETA" ESTANDARIZADA */}
                            <div onClick={() => setShowCreateCardModal(true)} 
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', 
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px', 
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = THEME_COLOR; e.currentTarget.style.color = THEME_COLOR; e.currentTarget.style.background = '#f0f9ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO SIN CLASES EXTERNAS */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                className="search-input" 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    padding:'0', 
                                    width:'100%', 
                                    fontSize:'0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }} 
                                placeholder="Buscar reporte..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select 
                                className="filter-select" 
                                style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}}
                                value={filterStatus} 
                                onChange={e => setFilterStatus(e.target.value)}
                            >
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato / √Årea</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes registrados.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'General'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- MODALES GLOBALES --- */}
            
            {/* FILE MANAGER AMPLIO */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Elementos Extra√±os: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* CREAR CARPETA - DISE√ëO ORGANIZADO */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Elementos</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                
                                <div className="form-group">
                                    <label>T√≠tulo de la Carpeta</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Control Vidrio 2026" />
                                </div>
                                
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Breve descripci√≥n..." />
                                </div>
                                
                                <div className="form-group">
                                    <label>Color de Etiqueta</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0, cursor:'pointer'}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', 
                                                    color: newCardData.icono === key ? THEME_COLOR : '#64748b', 
                                                    background: newCardData.icono === key ? '#f0f9ff' : 'transparent',
                                                    display:'flex', alignItems:'center', justifyContent:'center', height:'45px'
                                                }}
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal" style={{backgroundColor: THEME_COLOR}}>Crear Carpeta</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default GestionElementosExtranos;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionHACCP.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService'; 
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaShieldAlt, FaFolder, FaPlus, FaTrash, FaTimes, 
    FaSearch, FaFilter, FaExclamationTriangle, FaCheckCircle, 
    FaCheckDouble, FaFileContract, FaEye, FaTools, 
    FaClipboardList, FaTemperatureHigh, FaBiohazard, FaHandSparkles
} from 'react-icons/fa';

// Mapa de Iconos Tem√°ticos HACCP
const ICON_MAP = {
    'folder': <FaFolder />,
    'shield': <FaShieldAlt />,       // Seguridad General
    'temp': <FaTemperatureHigh />,   // Control Temperatura (PCC com√∫n)
    'bio': <FaBiohazard />,          // Riesgos Biol√≥gicos
    'clean': <FaHandSparkles />,     // Higiene / Prerrequisitos
    'list': <FaClipboardList />      // Listas de Chequeo
};

const GestionHACCP = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('documentacion');
    
    // --- ESTADOS DOCUMENTACI√ìN ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    
    // COLOR CORPORATIVO EST√ÅNDAR
    const THEME_COLOR = '#0c4760'; 

    const [newCardData, setNewCardData] = useState({ 
        titulo: '', 
        descripcion: '', 
        color: THEME_COLOR, 
        icono: 'shield' 
    });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        if(activeTab === 'documentacion') loadCards();
        if(activeTab === 'reportes') fetchReportesOperativos(); 
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            // M√≥dulo: 'HACCP'
            const res = await fetch(`${API_URL}/core/tarjetas/HACCP`, { headers: getAuthHeaders() });
            setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'HACCP' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'shield' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la carpeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso directo.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            // 1. Encontrar carpeta ra√≠z del m√≥dulo
            let rootId = await findOrCreateFolder(1, "Programa HACCP", headers);
            // 2. Encontrar carpeta de la tarjeta
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error al acceder al repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        return (await res2.json()).carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            // Filtrar reportes para HACCP
            const filtered = data.filter(r => 
                (r.Programa === 'HACCP') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('haccp')) ||
                (r.Categoria && r.Categoria.toLowerCase().includes('pcc'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Monitoreo PCC / HACCP #${rep.ID_Reporte}`,
            descripcion: `Desviaci√≥n en l√≠mite cr√≠tico o prerrequisito: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // Helper estilos tabs
    const getTabStyle = (isActive) => ({
        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
        background: isActive ? THEME_COLOR : 'transparent', 
        color: isActive ? 'white' : '#64748b', 
        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
    });

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaShieldAlt style={{color: THEME_COLOR}}/> Programa HACCP
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>An√°lisis de Peligros y Puntos Cr√≠ticos de Control.</p>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion')}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes')}>
                    <FaFileContract/> Reportes Operativos (PCC)
                </button>
            </div>

            {/* --- CONTENIDO DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            {/* TARJETA PUNTEADA "NUEVA CARPETA" */}
                            <div onClick={() => setShowCreateCardModal(true)} 
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', 
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px', 
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = THEME_COLOR; e.currentTarget.style.color = THEME_COLOR; e.currentTarget.style.background = '#f0f9ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* AQU√ç EST√Å LA CORRECCI√ìN DE LA LUPITA */}
                        <div className="search-box" style={{width: '300px'}}>
                            <FaSearch />
                            <input 
                                className="search-input"
                                placeholder="Buscar monitoreo..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select 
                                style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}}
                                value={filterStatus} 
                                onChange={e => setFilterStatus(e.target.value)}
                            >
                                <option value="todos">Todos</option>
                                <option value="fallas">Desviaci√≥n PCC</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Verif.</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Monitor</th><th>PCC / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay registros de HACCP.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'Punto de Control'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Desviaci√≥n</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- MODAL GESTOR DE ARCHIVOS --- */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`HACCP: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* --- MODAL CREAR CARPETA --- */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta HACCP</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>T√≠tulo de la Carpeta</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Plan HACCP 2026" />
                                </div>
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Breve descripci√≥n..." />
                                </div>
                                <div className="form-group">
                                    <label>Color de Etiqueta</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0, cursor:'pointer'}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'flex', gap:'10px', marginTop:'5px', flexWrap:'wrap'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', fontSize:'1.2rem', 
                                                    border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', 
                                                    color: newCardData.icono === key ? THEME_COLOR : '#64748b', 
                                                    background: newCardData.icono === key ? '#f0f9ff' : 'transparent', 
                                                    display:'flex', alignItems:'center', justifyContent:'center', width:'45px', height:'45px'
                                                }}
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal" style={{backgroundColor: THEME_COLOR}}>Crear Carpeta</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default GestionHACCP;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionLimpieza.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager'; 
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import { 
    FaPlus, FaSearch, FaTrash, FaFolder, FaTimes, FaEdit, 
    FaBroom, FaSoap, FaHandsWash, FaSprayCan, FaRecycle, FaTrashAlt, FaFill, 
    FaBiohazard, FaExclamationTriangle, FaClipboardCheck, FaHardHat, FaFirstAid, FaFireExtinguisher,
    FaFilePdf, FaFileAlt, FaFileExcel, FaBoxOpen, FaIndustry, FaTruck, FaTint, FaCheckCircle,
    FaFileContract, FaEye, FaTools, FaCheckDouble, FaFilter
} from 'react-icons/fa';

import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 

// --- MAPA DE ICONOS ---
const ICON_MAP = {
    'folder': <FaFolder />, 'clipboard': <FaClipboardCheck />,
    'broom': <FaBroom />, 'bucket': <FaFill />, 'soap': <FaSoap />, 'spray': <FaSprayCan />,
    'hands': <FaHandsWash />, 'trash': <FaTrashAlt />, 'recycle': <FaRecycle />,
    'bio': <FaBiohazard />, 'warning': <FaExclamationTriangle />, 'helmet': <FaHardHat />,
    'aid': <FaFirstAid />, 'fire': <FaFireExtinguisher />,
    'box': <FaBoxOpen />, 'industry': <FaIndustry />, 'truck': <FaTruck />,
    'water': <FaTint />, 'check': <FaCheckCircle />,
    'pdf': <FaFilePdf />, 'doc': <FaFileAlt />, 'xls': <FaFileExcel />
};

const GestionLimpieza = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('docs'); // 'docs' o 'reportes'

    // --- ESTADOS GESTI√ìN DOCUMENTAL ---
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo:'', descripcion:'', color:'#10b981', icono:'broom' });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        if (activeTab === 'docs') loadCards();
        if (activeTab === 'reportes') fetchReportes();
    }, [activeTab]);

    // ==========================================
    // L√ìGICA TARJETAS
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/LIMPIEZA`, { headers: getAuthHeaders() });
            const data = await res.json();
            setCards(data);
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'LIMPIEZA' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Categor√≠a agregada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color:'#10b981', icono:'broom' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({title:'¬øBorrar categor√≠a?', text:'Se ocultar√° el acceso, los archivos permanecen en el Drive.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootModuleId = await findOrCreateFolder(1, "Limpieza y Desinfecci√≥n", headers);
            let categoryFolderId = await findOrCreateFolder(rootModuleId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: categoryFolderId });
            setShowFileManager(true);
        } catch (error) {
            Swal.fire('Error', 'No se pudo acceder al repositorio.', 'error');
        } finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (parentId, folderName, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data = await res.json();
        const existing = data.carpetas.find(c => c.NombreCarpeta === folderName);
        if (existing) return existing.ID_Carpeta;
        
        await fetch(`${API_URL}/drive/carpeta`, {
            method: 'POST', headers,
            body: JSON.stringify({ nombre: folderName, idPadre: parentId })
        });
        const res2 = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === folderName).ID_Carpeta;
    };

    // ==========================================
    // L√ìGICA REPORTES
    // ==========================================
    const fetchReportes = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            
            // --- AQU√ç EST√Å EL CAMBIO SOLICITADO ---
            // Ahora filtra si el Programa es 'Limpieza y Desinfecci√≥n' O si la categor√≠a tiene la palabra 'limpieza'
            const onlyLimpieza = data.filter(r => 
                (r.Programa === 'Limpieza y Desinfecci√≥n') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('limpieza'))
            );
            
            setReportes(onlyLimpieza);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const filteredReportes = reportes.filter(item => {
        const textMatch = item.Usuario.toLowerCase().includes(searchTerm.toLowerCase()) || item.Activo.toLowerCase().includes(searchTerm.toLowerCase());
        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
        return textMatch && statusMatch;
    });

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte LyD #${rep.ID_Reporte}`,
            descripcion: `Falla en limpieza: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    return (
        <div>
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title">Programa de Limpieza y Desinfecci√≥n</h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de protocolos y registros L&D.</p>
                </div>
            </div>

            {/* PESTA√ëAS (TABS) */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button 
                    onClick={() => setActiveTab('docs')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'docs' ? '#0c4760' : 'transparent',
                        color: activeTab === 'docs' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaFolder/> Documentaci√≥n
                </button>
                <button 
                    onClick={() => setActiveTab('reportes')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'reportes' ? '#0c4760' : 'transparent',
                        color: activeTab === 'reportes' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaClipboardCheck/> Reportes Operativos
                </button>
            </div>

            {/* --- SECCI√ìN: TARJETAS DIN√ÅMICAS --- */}
            {activeTab === 'docs' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <small style={{color:'#64748b'}}>Gestione las carpetas del √°rea</small>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)}
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            <div onClick={() => setShowCreateCardModal(true)}
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column',
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px',
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#10b981'; e.currentTarget.style.color = '#10b981'; e.currentTarget.style.background = '#f0fdf4'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- SECCI√ìN: REPORTES (CON HORA CORREGIDA) --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                      <div className="control-bar">
                        <div className="search-box">
                            <FaSearch />
                            <input className="search-input" placeholder="Buscar reporte..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Lugar / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredReportes.length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de limpieza registrados.</td></tr> :
                                filteredReportes.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            {/* --- CORRECCI√ìN DE HORA AQU√ç --- */}
                                            <div className="date-main">
                                                {new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                            </div>
                                            <div className="date-sub">
                                                {new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}
                                            </div>
                                            {/* ------------------------------- */}
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES TARJETAS */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'550px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta L&D</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group"><label>T√≠tulo</label><input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Protocolos de Aseo" /></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} /></div>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                
                                <div className="form-group">
                                    <label>Seleccionar Icono</label>
                                    <div style={{
                                        display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'10px', marginTop:'5px',
                                        maxHeight: '180px', overflowY: 'auto', padding: '5px', border: '1px solid #e2e8f0', borderRadius: '8px'
                                    }}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? '2px solid #10b981' : '1px solid white', 
                                                    background: newCardData.icono === key ? '#f0fdf4' : 'transparent', 
                                                    color: newCardData.icono === key ? '#10b981' : '#64748b'
                                                }}
                                                title={key} 
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal">Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* FILE MANAGER */}
            {showFileManager && (
                <div style={{position:'fixed', top:0, left:0, width:'100vw', height:'100vh', background:'rgba(0,0,0,0.7)', zIndex: 99999, display:'flex', alignItems:'center', justifyContent:'center', padding:'20px'}}>
                    <div style={{width:'900px', height:'85vh', background:'white', borderRadius:'12px', overflow:'hidden', boxShadow:'0 25px 50px -12px rgba(0,0,0,0.5)', position: 'relative'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`L&D: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {loadingFolder && (
                <div style={{position:'fixed', top:0, left:0, width:'100%', height:'100%', background:'rgba(255,255,255,0.8)', zIndex: 99999, display:'flex', alignItems:'center', justifyContent:'center', flexDirection:'column'}}>
                    <div className="spin" style={{fontSize:'3rem', color:'#10b981'}}>‚óè</div>
                    <p style={{marginTop:'10px', color:'#0c4760', fontWeight:'600'}}>Cargando archivos...</p>
                </div>
            )}

            {/* NUEVOS MODALES DE REPORTES */}
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportes} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportes} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
        </div>
    );
};

export default GestionLimpieza;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionMuestreo.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager'; 
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import { 
    FaPlus, FaSearch, FaTrash, FaFolder, FaTimes, 
    FaVial, FaMicroscope, FaClipboardCheck, FaFilter,
    FaFileContract, FaEye, FaTools, FaCheckCircle, FaExclamationTriangle, FaCheckDouble,
    FaFilePdf, FaFileAlt, FaFileExcel
} from 'react-icons/fa';

import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 

// --- MAPA DE ICONOS ---
const ICON_MAP = {
    'folder': <FaFolder />, 'clipboard': <FaClipboardCheck />,
    'vial': <FaVial />, 'microscope': <FaMicroscope />,
    'pdf': <FaFilePdf />, 'doc': <FaFileAlt />, 'xls': <FaFileExcel />
};

const GestionMuestreo = () => {
    // Por defecto inicia en Documentaci√≥n
    const [activeTab, setActiveTab] = useState('docs');

    // --- ESTADOS GESTI√ìN DOCUMENTAL ---
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo:'', descripcion:'', color:'#8b5cf6', icono:'vial' });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // Efectos
    useEffect(() => {
        if (activeTab === 'docs') loadCards();
        if (activeTab === 'reportes') fetchReportes();
    }, [activeTab]); 

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/MUESTREO`, { headers: getAuthHeaders() });
            const data = await res.json();
            setCards(data);
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'MUESTREO' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Categor√≠a agregada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color:'#8b5cf6', icono:'vial' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({title:'¬øBorrar categor√≠a?', text:'Se ocultar√° el acceso, los archivos permanecen en el Drive.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootModuleId = await findOrCreateFolder(1, "Programa de Muestreo", headers);
            let categoryFolderId = await findOrCreateFolder(rootModuleId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: categoryFolderId });
            setShowFileManager(true);
        } catch (error) {
            Swal.fire('Error', 'No se pudo acceder al repositorio.', 'error');
        } finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (parentId, folderName, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data = await res.json();
        const existing = data.carpetas.find(c => c.NombreCarpeta === folderName);
        if (existing) return existing.ID_Carpeta;
        
        await fetch(`${API_URL}/drive/carpeta`, {
            method: 'POST', headers,
            body: JSON.stringify({ nombre: folderName, idPadre: parentId })
        });
        const res2 = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === folderName).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES
    // ==========================================
    const fetchReportes = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            const onlyMuestreo = data.filter(r => 
                (r.Programa === 'Muestreo') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('muestreo'))
            );
            setReportes(onlyMuestreo);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const filteredReportes = reportes.filter(item => {
        const textMatch = item.Usuario.toLowerCase().includes(searchTerm.toLowerCase()) || item.Activo.toLowerCase().includes(searchTerm.toLowerCase());
        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
        return textMatch && statusMatch;
    });

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte Muestreo #${rep.ID_Reporte}`,
            descripcion: `Hallazgo en muestreo: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // --- RENDERIZADO ---
    return (
        <div>
            {/* CABECERA */}
            <div className="page-header">
                <div style={{display:'flex', gap:'15px', alignItems:'center'}}>
                    <div style={{background:'#f3e8ff', padding:'10px', borderRadius:'12px', color:'#7e22ce'}}>
                        <FaVial size={28}/>
                    </div>
                    <div>
                        <h1 className="page-title">Programa de Muestreo</h1>
                        <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de muestreos y an√°lisis de calidad.</p>
                    </div>
                </div>
            </div>

            {/* PESTA√ëAS (SIN CRONOGRAMA) */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button 
                    onClick={() => setActiveTab('docs')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'docs' ? '#0c4760' : 'transparent',
                        color: activeTab === 'docs' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaFolder/> Documentaci√≥n
                </button>
                <button 
                    onClick={() => setActiveTab('reportes')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'reportes' ? '#0c4760' : 'transparent',
                        color: activeTab === 'reportes' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaClipboardCheck/> Reportes Operativos
                </button>
            </div>

            {/* --- TAB 1: TARJETAS DIN√ÅMICAS (DOCS) --- */}
            {activeTab === 'docs' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                                <small style={{color:'#64748b'}}>Gestione las carpetas del √°rea</small>
                            </div>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)}
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            <div onClick={() => setShowCreateCardModal(true)}
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column',
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px',
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = '#8b5cf6'; e.currentTarget.style.color = '#8b5cf6'; e.currentTarget.style.background = '#f3e8ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- TAB 2: REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                      <div className="control-bar">
                        <div className="search-box">
                            <FaSearch />
                            <input className="search-input" placeholder="Buscar reporte..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Lugar / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredReportes.length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de muestreo registrados.</td></tr> :
                                filteredReportes.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">
                                                {new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                            </div>
                                            <div className="date-sub">
                                                {new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}
                                            </div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES GLOBALES */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'550px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Muestreo</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group"><label>T√≠tulo</label><input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: An√°lisis Microbiol√≥gicos" /></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} /></div>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                
                                <div className="form-group">
                                    <label>Seleccionar Icono</label>
                                    <div style={{
                                        display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'10px', marginTop:'5px',
                                        maxHeight: '180px', overflowY: 'auto', padding: '5px', border: '1px solid #e2e8f0', borderRadius: '8px'
                                    }}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? '2px solid #8b5cf6' : '1px solid white', 
                                                    background: newCardData.icono === key ? '#f3e8ff' : 'transparent', 
                                                    color: newCardData.icono === key ? '#8b5cf6' : '#64748b'
                                                }}
                                                title={key} 
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal">Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* MODAL FILE MANAGER (CORREGIDO PANTALLA COMPLETA) */}
            {showFileManager && (
                <div className="modal-overlay"> 
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Muestreo: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color:'#8b5cf6'}}>‚óè</div></div>}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportes} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportes} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
        </div>
    );
};

export default GestionMuestreo;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionPlagas.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import '../../styles/Dashboard.css'; // Reutilizamos estilos
import '../../styles/Tables.css';    // Estilos de tablas

import { 
    FaBug, FaSpider, FaSprayCan, FaFolder, FaPlus, FaTimes, FaTrash, 
    FaSkullCrossbones, FaShieldAlt, FaFileContract, FaClipboardCheck,
    FaSearch, FaFilter, FaExclamationTriangle, FaCheckCircle, FaCheckDouble,
    FaEye, FaTools
} from 'react-icons/fa';

// Mapa de Iconos espec√≠fico para Plagas
const ICON_MAP = {
    'bug': <FaBug />,
    'spider': <FaSpider />,
    'spray': <FaSprayCan />,
    'skull': <FaSkullCrossbones />,
    'shield': <FaShieldAlt />,
    'folder': <FaFolder />,
    'contract': <FaFileContract />
};

const GestionPlagas = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('documentacion'); // 'documentacion' o 'reportes'

    // --- ESTADOS GESTI√ìN DOCUMENTAL ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo: '', descripcion: '', color: '#8b5cf6', icono: 'bug' });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // Color Tem√°tico
    const THEME_COLOR = '#8b5cf6'; // Violeta

    useEffect(() => {
        if (activeTab === 'documentacion') loadCards();
        if (activeTab === 'reportes') fetchReportes();
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/PLAGAS`, { headers: getAuthHeaders() });
            const data = await res.json();
            setCards(data);
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', 
                headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'PLAGAS' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'bug' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la tarjeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso directo, pero los archivos permanecen en el Drive.', icon:'warning', showCancelButton:true, confirmButtonColor: '#d33'}).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootId = await findOrCreateFolder(1, "Control de Plagas", headers);
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error al acceder al repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES
    // ==========================================
    const fetchReportes = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            // Filtrar reportes de Plagas
            const onlyPlagas = data.filter(r => 
                (r.Programa === 'Control de Plagas') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('plagas'))
            );
            setReportes(onlyPlagas);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const filteredReportes = reportes.filter(item => {
        const textMatch = (item.Usuario || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                          (item.Activo || '').toLowerCase().includes(searchTerm.toLowerCase());
        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
        return textMatch && statusMatch;
    });

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte Plagas #${rep.ID_Reporte}`,
            descripcion: `Hallazgo en control de plagas: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaBug style={{color: THEME_COLOR}}/> Control de Plagas
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de certificados de fumigaci√≥n y controles.</p>
                </div>
            </div>

            {/* PESTA√ëAS (TABS) */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button 
                    onClick={() => setActiveTab('documentacion')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'documentacion' ? '#0c4760' : 'transparent',
                        color: activeTab === 'documentacion' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaFolder/> Documentaci√≥n
                </button>
                <button 
                    onClick={() => setActiveTab('reportes')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'reportes' ? '#0c4760' : 'transparent',
                        color: activeTab === 'reportes' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaClipboardCheck/> Reportes Operativos
                </button>
            </div>

            {/* --- TAB 1: DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            <div onClick={() => setShowCreateCardModal(true)}
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column',
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px',
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = THEME_COLOR; e.currentTarget.style.color = THEME_COLOR; e.currentTarget.style.background = '#f5f3ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- TAB 2: REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                      <div className="control-bar">
                        <div className="search-box">
                            <FaSearch />
                            <input className="search-input" placeholder="Buscar reporte..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Ubicaci√≥n / Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredReportes.length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de plagas registrados.</td></tr> :
                                filteredReportes.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'General'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES GLOBALES */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Plagas</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>T√≠tulo</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Certificados Fumigaci√≥n" />
                                </div>
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Color</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(5, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', 
                                                    background: newCardData.icono === key ? '#f5f3ff' : 'transparent', 
                                                    color: newCardData.icono === key ? THEME_COLOR : '#64748b'
                                                }}
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal" style={{backgroundColor: THEME_COLOR}}>Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {showFileManager && (
                <div className="modal-overlay"> 
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Plagas: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportes} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportes} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
        </div>
    );
};

export default GestionPlagas;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionPMIR.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService'; 
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';
import ModalCreateRecoleccion from '../../components/modals/ModalCreateRecoleccion'; 
import ModalVerRecoleccion from '../../components/modals/ModalVerRecoleccion';

import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaRecycle, FaFolder, FaPlus, FaTrash, FaTimes, 
    FaSearch, FaFilter, FaExclamationTriangle, FaCheckCircle, 
    FaCheckDouble, FaFileContract, FaEye, FaTools, 
    FaLeaf, FaTruck, FaBoxOpen
} from 'react-icons/fa';

// Mapa de Iconos Tem√°ticos PMIR
const ICON_MAP = {
    'folder': <FaFolder />,
    'recycle': <FaRecycle />,
    'leaf': <FaLeaf />,
    'truck': <FaTruck />,
    'box': <FaBoxOpen />
};

const GestionPMIR = () => {
    // --- ESTADOS TABS ---
    const [activeTab, setActiveTab] = useState('documentacion');
    
    // --- ESTADOS DOCUMENTACI√ìN ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    
    // COLOR CORPORATIVO EST√ÅNDAR
    const THEME_COLOR = '#0c4760'; 

    const [newCardData, setNewCardData] = useState({ 
        titulo: '', 
        descripcion: '', 
        color: THEME_COLOR, 
        icono: 'recycle' 
    });

    // --- ESTADOS REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // --- ESTADOS RECOLECCI√ìN (NUEVO) ---
    const [recolecciones, setRecolecciones] = useState([]);
    const [loadingRecoleccion, setLoadingRecoleccion] = useState(false);
    const [showCreateRecoleccion, setShowCreateRecoleccion] = useState(false);
    const [showViewRecoleccion, setShowViewRecoleccion] = useState(false);
    const [selectedRecoleccion, setSelectedRecoleccion] = useState(null);
    const [searchRecoleccion, setSearchRecoleccion] = useState('');

    useEffect(() => {
        if(activeTab === 'documentacion') loadCards();
        if(activeTab === 'reportes') fetchReportesOperativos(); 
        if(activeTab === 'recoleccion') fetchRecolecciones();
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN (Igual a HACCP)
    // ==========================================
    const loadCards = async () => {
        try {
            // M√≥dulo: 'PMIR'
            const res = await fetch(`${API_URL}/core/tarjetas/PMIR`, { headers: getAuthHeaders() });
            setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'PMIR' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'recycle' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la carpeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso directo.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            // 1. Encontrar carpeta ra√≠z del m√≥dulo
            let rootId = await findOrCreateFolder(1, "Programa PMIR", headers);
            // 2. Encontrar carpeta de la tarjeta
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error al acceder al repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        return (await res2.json()).carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            // Filtrar reportes para PMIR
            const filtered = data.filter(r => 
                (r.Programa === 'PMIR') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('residuos'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `PMIR - Residuos #${rep.ID_Reporte}`,
            descripcion: `Incidente ambiental: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    // ==========================================
    // 3. L√ìGICA RECOLECCI√ìN (NUEVO)
    // ==========================================
    const fetchRecolecciones = async () => {
        setLoadingRecoleccion(true);
        try {
            const res = await fetch(`${API_URL}/pmir/recoleccion`, { headers: getAuthHeaders() });
            if(res.ok) setRecolecciones(await res.json());
        } catch (e) { console.error(e); } 
        finally { setLoadingRecoleccion(false); }
    };

    const filteredRecolecciones = recolecciones.filter(r => 
        r.TipoMaterial.toLowerCase().includes(searchRecoleccion.toLowerCase()) || 
        r.Cliente.toLowerCase().includes(searchRecoleccion.toLowerCase())
    );

    const handleViewRecoleccion = (rec) => {
        setSelectedRecoleccion(rec);
        setShowViewRecoleccion(true);
    };

    // Helper estilos tabs
    const getTabStyle = (isActive) => ({
        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
        background: isActive ? THEME_COLOR : 'transparent', 
        color: isActive ? 'white' : '#64748b', 
        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
    });

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaRecycle style={{color: THEME_COLOR}}/> Programa PMIR
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Manejo Integral de Residuos S√≥lidos.</p>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px', flexWrap:'wrap'}}>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion')}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes')}>
                    <FaFileContract/> Reportes Operativos
                </button>
                <button onClick={() => setActiveTab('recoleccion')} style={getTabStyle(activeTab === 'recoleccion')}>
                    <FaTruck/> Recolecci√≥n Residuos
                </button>
            </div>

            {/* --- CONTENIDO DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', 
                                        border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                        position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}

                            {/* TARJETA PUNTEADA "NUEVA CARPETA" */}
                            <div onClick={() => setShowCreateCardModal(true)} 
                                style={{
                                    border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', 
                                    alignItems:'center', justifyContent:'center', cursor:'pointer', minHeight:'140px', 
                                    color:'#94a3b8', transition:'all 0.2s'
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.borderColor = THEME_COLOR; e.currentTarget.style.color = THEME_COLOR; e.currentTarget.style.background = '#f0f9ff'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.borderColor = '#cbd5e1'; e.currentTarget.style.color = '#94a3b8'; e.currentTarget.style.background = 'transparent'; }}
                            >
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO REPORTES --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    padding:'0', 
                                    fontSize: '0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }} 
                                placeholder="Buscar reporte..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select 
                                style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}}
                                value={filterStatus} 
                                onChange={e => setFilterStatus(e.target.value)}
                            >
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Verif.</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay registros de PMIR.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'Residuos'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO RECOLECCI√ìN --- */}
            {activeTab === 'recoleccion' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    padding:'0', 
                                    fontSize: '0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }} 
                                placeholder="Buscar residuo o cliente..." 
                                value={searchRecoleccion} 
                                onChange={e => setSearchRecoleccion(e.target.value)} 
                            />
                        </div>

                        <button className="btn-primary" onClick={() => setShowCreateRecoleccion(true)} style={{backgroundColor: THEME_COLOR, display:'flex', alignItems:'center', gap:'8px', padding:'10px 20px'}}>
                            <FaTruck /> Registrar Recolecci√≥n
                        </button>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Material</th>
                                    <th>Cantidad</th>
                                    <th>Peso (Kg)</th>
                                    <th>Cliente / Gestor</th>
                                    <th style={{textAlign:'right'}}>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loadingRecoleccion ? <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                filteredRecolecciones.length === 0 ? <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay recolecciones.</td></tr> :
                                filteredRecolecciones.map(rec => (
                                    <tr key={rec.ID_Recoleccion} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main" style={{fontWeight:'bold', color:'#334155'}}>{new Date(rec.Fecha).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <span style={{background:'#f0fdf4', color:'#166534', padding:'4px 10px', borderRadius:'15px', fontSize:'0.85rem', fontWeight:'600', border:'1px solid #bbf7d0'}}>
                                                {rec.TipoMaterial}
                                            </span>
                                        </td>
                                        <td className="modern-cell">{rec.Cantidad} Unid.</td>
                                        <td className="modern-cell"><strong style={{color: THEME_COLOR}}>{rec.Peso} Kg</strong></td>
                                        <td className="modern-cell">{rec.Cliente}</td>
                                        <td className="modern-cell" style={{textAlign:'right'}}>
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleViewRecoleccion(rec)} style={{color: THEME_COLOR, background:'#f0f9ff', border:`1px solid ${THEME_COLOR}30`}}>
                                                    <FaEye/> Ver Detalle
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- MODAL GESTOR DE ARCHIVOS --- */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`PMIR: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* --- MODAL CREAR CARPETA (ESTILO HACCP/ORGANIZADO) --- */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta PMIR</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>T√≠tulo de la Carpeta</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Certificados Disposici√≥n 2026" />
                                </div>
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Breve descripci√≥n..." />
                                </div>
                                <div className="form-group">
                                    <label>Color de Etiqueta</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0, cursor:'pointer'}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'flex', gap:'10px', marginTop:'5px', flexWrap:'wrap'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', fontSize:'1.2rem', 
                                                    border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', 
                                                    color: newCardData.icono === key ? THEME_COLOR : '#64748b', 
                                                    background: newCardData.icono === key ? '#f0f9ff' : 'transparent', 
                                                    display:'flex', alignItems:'center', justifyContent:'center', width:'45px', height:'45px'
                                                }}
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal" style={{backgroundColor: THEME_COLOR}}>Crear Carpeta</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
            
            {/* NUEVOS MODALES RECOLECCI√ìN */}
            <ModalCreateRecoleccion isOpen={showCreateRecoleccion} onClose={() => setShowCreateRecoleccion(false)} onSuccess={fetchRecolecciones} />
            <ModalVerRecoleccion isOpen={showViewRecoleccion} onClose={() => setShowViewRecoleccion(false)} data={selectedRecoleccion} />

            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default GestionPMIR;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionProveedores.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders, apiFetchBlob, extractFilename } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService'; 
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES ---
import FileManager from '../../components/FileManager';
import AuditoriaProveedor from './AuditoriaProveedor';
import ModalVerEvaluacionProveedor from '../../components/modals/ModalVerEvaluacionProveedor';

// --- MODALES PARA REPORTES ---
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaTruck, FaHandshake, FaFileContract, FaIdCard, FaFolder, 
    FaPlus, FaTrash, FaCertificate, FaGlobe, FaTimes, FaClipboardCheck, FaEye,
    FaFileUpload, FaFilePdf, FaArchive, FaBox, FaTag, FaCubes,
    FaSearch, FaFilter, FaExclamationTriangle, FaCheckCircle, FaCheckDouble, FaTools
} from 'react-icons/fa';

// Mapa de Iconos Ampliado
const ICON_MAP = {
    'folder': <FaFolder />, 'truck': <FaTruck />, 'handshake': <FaHandshake />,
    'contract': <FaFileContract />, 'id': <FaIdCard />, 'cert': <FaCertificate />,
    'globe': <FaGlobe />, 'archive': <FaArchive />, 'box': <FaBox />, 'tag': <FaTag />
};

const GestionProveedores = () => {
    // TABS: 'documentacion', 'evaluaciones', 'reportes' (Proveedores), 'materiaprima' (Nuevo)
    const [activeTab, setActiveTab] = useState('documentacion');
    const [viewMode, setViewMode] = useState('list');
    
    // Estados Documentaci√≥n
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo: '', descripcion: '', color: '#0c4760', icono: 'folder' });

    // Estados Evaluaciones
    const [evaluaciones, setEvaluaciones] = useState([]);
    const [showViewModal, setShowViewModal] = useState(false);
    const [selectedEvaluacionId, setSelectedEvaluacionId] = useState(null);

    // Estados Reportes (Compartido para Proveedores y Materia Prima)
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // Color Corporativo
    const CORPORATE_BLUE = '#0c4760';

    useEffect(() => {
        if(activeTab === 'documentacion') loadCards();
        if(activeTab === 'evaluaciones') loadEvaluaciones();
        // Cargamos reportes si estamos en 'reportes' (Proveedores) o 'materiaprima'
        if(activeTab === 'reportes' || activeTab === 'materiaprima') fetchReportesOperativos(); 
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DOCUMENTACI√ìN
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/PROVEEDORES`, { headers: getAuthHeaders() });
            setCards(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'PROVEEDORES' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: CORPORATE_BLUE, icono:'folder' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar?', text: 'Se ocultar√° el acceso.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootId = await findOrCreateFolder(1, "Gesti√≥n de Proveedores", headers);
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'Error repositorio', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        return (await res2.json()).carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 2. L√ìGICA AUDITOR√çAS (EVALUACIONES)
    // ==========================================
    const loadEvaluaciones = async () => {
        try {
            const res = await fetch(`${API_URL}/proveedores`, { headers: getAuthHeaders() });
            if(res.ok) setEvaluaciones(await res.json());
        } catch (e) { console.error(e); }
    };

    const handleViewEvaluacion = (id) => { setSelectedEvaluacionId(id); setShowViewModal(true); };

    // --- FUNCI√ìN SEGURA PARA VER CARTA INVIMA ---
    const handleViewCarta = async (urlCarta) => {
        if (!urlCarta) return;
        try {
            const filename = extractFilename(urlCarta);
            // Ruta segura de streaming que crearemos en backend
            const blob = await apiFetchBlob(`/proveedores/carta/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al ver carta:", error);
            if (urlCarta.startsWith('http')) window.open(urlCarta, '_blank');
            else Swal.fire('Error', 'No se pudo abrir el documento adjunto', 'error');
        }
    };

    const handleUploadCarta = async (idEvaluacion) => {
        const { value: file } = await Swal.fire({
            title: 'Subir Carta INVIMA', text: 'Seleccione PDF o Imagen.', input: 'file',
            inputAttributes: { 'accept': 'application/pdf, image/*' }, showCancelButton: true, confirmButtonText: 'Subir', confirmButtonColor: CORPORATE_BLUE
        });
        if (file) {
            const formData = new FormData(); formData.append('archivo', file);
            Swal.fire({ title: 'Subiendo...', didOpen: () => Swal.showLoading() });
            try {
                // Nota: Usamos fetch directo aqu√≠ porque Swal input file retorna un objeto File directo
                // Pero es seguro usar los headers manuales.
                const res = await fetch(`${API_URL}/proveedores/${idEvaluacion}/carta-invima`, {
                    method: 'PUT', headers: { 'Authorization': getAuthHeaders()['Authorization'] }, body: formData
                });
                if (res.ok) { Swal.fire('√âxito', 'Carta adjuntada', 'success'); loadEvaluaciones(); }
                else { throw new Error('Error al subir'); }
            } catch (error) { Swal.fire('Error', 'No se pudo subir', 'error'); }
        }
    };

    // ==========================================
    // 3. L√ìGICA REPORTES OPERATIVOS (PROVEEDORES Y MATERIA PRIMA)
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            let filtered = [];

            if (activeTab === 'materiaprima') {
                // Filtro para Materia Prima
                filtered = data.filter(r => 
                    (r.Programa === 'Materia Prima') || 
                    (r.Categoria && r.Categoria.toLowerCase().includes('materia'))
                );
            } else {
                // Filtro para Proveedores (Default)
                filtered = data.filter(r => 
                    (r.Programa === 'Proveedores') || 
                    (r.Programa === 'Gesti√≥n de Proveedores') ||
                    (r.Categoria && r.Categoria.toLowerCase().includes('proveedor'))
                );
            }
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        const origenTexto = activeTab === 'materiaprima' ? 'Materia Prima' : 'Proveedores';
        setAcpmData({
            origen: `Reporte ${origenTexto} #${rep.ID_Reporte}`,
            descripcion: `Hallazgo en ${origenTexto}: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    if (activeTab === 'evaluaciones' && viewMode === 'create') {
        return <AuditoriaProveedor onCancel={() => setViewMode('list')} onSaveSuccess={() => { setViewMode('list'); loadEvaluaciones(); }} />;
    }

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaHandshake style={{color: CORPORATE_BLUE}}/> Programa de Proveedores
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de terceros, contratos, auditor√≠as y materia prima.</p>
                </div>
            </div>

            {/* PESTA√ëAS (TABS) */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px', flexWrap:'wrap'}}>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion', CORPORATE_BLUE)}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('evaluaciones')} style={getTabStyle(activeTab === 'evaluaciones', CORPORATE_BLUE)}>
                    <FaClipboardCheck/> Auditor√≠as
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes', CORPORATE_BLUE)}>
                    <FaFileContract/> Reportes Proveedores
                </button>
                {/* NUEVA PESTA√ëA MATERIA PRIMA */}
                <button onClick={() => setActiveTab('materiaprima')} style={getTabStyle(activeTab === 'materiaprima', CORPORATE_BLUE)}>
                    <FaCubes/> Materia Prima
                </button>
            </div>

            {/* --- CONTENIDO DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: CORPORATE_BLUE}}>
                                <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                            </button>
                        </div>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} className="card-folder" style={{
                                    background:'white', padding:'1.2rem', borderRadius:'12px', border:'1px solid #e2e8f0', cursor:'pointer', 
                                    position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)', borderTop: `4px solid ${card.Color}`
                                }}>
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem'}}>{ICON_MAP[card.Icono] || <FaFolder/>}</div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} className="btn-delete" style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer'}}><FaTrash size={12}/></button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}
                            <div onClick={() => setShowCreateCardModal(true)} style={{
                                border:'2px dashed #cbd5e1', borderRadius:'12px', display:'flex', flexDirection:'column', alignItems:'center', justifyContent:'center', 
                                cursor:'pointer', minHeight:'140px', color:'#94a3b8'
                            }}>
                                <FaPlus size={30} />
                                <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO AUDITOR√çAS --- */}
            {activeTab === 'evaluaciones' && (
                <div className="fade-in">
                      <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                        <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Historial de Auditor√≠as</h3>
                        <button className="btn-primary" onClick={() => setViewMode('create')} style={{backgroundColor: CORPORATE_BLUE, padding:'8px 15px', fontSize:'0.9rem'}}>
                            <FaPlus style={{marginRight:'5px'}}/> Nueva Auditor√≠a
                        </button>
                    </div>
                    <div className="table-container">
                        <table className="data-table">
                            <thead>
                                <tr><th>Fecha</th><th>Empresa</th><th>Puntaje</th><th>Resultado</th><th>Auditor</th><th style={{textAlign:'center'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {evaluaciones.length === 0 ? <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>No hay auditor√≠as</td></tr> : 
                                    evaluaciones.map(ev => (
                                        <tr key={ev.ID_Evaluacion}>
                                            <td>{new Date(ev.Fecha_Registro).toLocaleDateString()}</td>
                                            <td><b>{ev.Empresa}</b></td>
                                            <td>{ev.Porcentaje_Final}%</td>
                                            <td><span className={`status-badge status-${ev.Concepto_Final === 'FAVORABLE' ? 'active' : 'inactive'}`}>{ev.Concepto_Final}</span></td>
                                            <td>{ev.Realizado_Por}</td>
                                            <td style={{textAlign:'center'}}>
                                                <div style={{display:'flex', justifyContent:'center', gap:'10px'}}>
                                                    <button onClick={() => handleViewEvaluacion(ev.ID_Evaluacion)} style={{display:'flex', alignItems:'center', gap:'5px', background:'#f0f9ff', border:'1px solid #bae6fd', color:'#0369a1', padding:'5px 12px', borderRadius:'6px', cursor:'pointer'}}><FaEye /> Ver</button>
                                                    {ev.Url_Carta_Invima ? 
                                                        // AQU√ç EST√Å EL CAMBIO IMPORTANTE: BOT√ìN SEGURO
                                                        <button 
                                                            onClick={() => handleViewCarta(ev.Url_Carta_Invima)} 
                                                            style={{display:'flex', alignItems:'center', gap:'5px', background:'#fef2f2', border:'1px solid #fecaca', color:'#dc2626', padding:'5px 12px', borderRadius:'6px', cursor:'pointer'}}
                                                        >
                                                            <FaFilePdf /> Carta
                                                        </button> : 
                                                        <button onClick={() => handleUploadCarta(ev.ID_Evaluacion)} style={{display:'flex', alignItems:'center', gap:'5px', background:'#ecfdf5', border:'1px solid #a7f3d0', color:'#059669', padding:'5px 12px', borderRadius:'6px', cursor:'pointer'}}><FaFileUpload /> Subir</button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO REPORTES (REUTILIZABLE PARA PROVEEDORES Y MATERIA PRIMA) --- */}
            {(activeTab === 'reportes' || activeTab === 'materiaprima') && (
                <div className="fade-in">
                    <div style={{marginBottom:'1rem', display:'flex', alignItems:'center', gap:'10px', background:'#f8fafc', padding:'10px', borderRadius:'8px', border:'1px solid #e2e8f0'}}>
                        <span style={{fontWeight:'bold', color: CORPORATE_BLUE, display:'flex', alignItems:'center', gap:'5px'}}>
                             {activeTab === 'materiaprima' ? <FaCubes/> : <FaFileContract/>}
                             Viendo: {activeTab === 'materiaprima' ? 'Reportes de Materia Prima' : 'Reportes de Recepci√≥n / Proveedores'}
                        </span>
                    </div>

                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    padding:'0', 
                                    fontSize: '0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }} 
                                placeholder="Buscar..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0'}} value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato / Item</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || (activeTab==='materiaprima'?'Materia Prima':'Proveedor')}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES GLOBALES */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width:'95%', maxWidth:'1000px', height:'85vh', padding:0}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Repositorio: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* CREAR TARJETA */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h2>Nueva Carpeta</h2><button onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button></div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <input className="form-control" required placeholder="T√≠tulo" value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} style={{marginBottom:'10px'}}/>
                                <input className="form-control" placeholder="Descripci√≥n" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} style={{marginBottom:'10px'}}/>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                <div className="form-group"><label>Icono</label>
                                    <div style={{display:'flex', gap:'10px', marginTop:'5px', flexWrap:'wrap'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} style={{padding:'10px', borderRadius:'8px', cursor:'pointer', fontSize:'1.2rem', border: newCardData.icono === key ? `2px solid ${CORPORATE_BLUE}` : '1px solid #e2e8f0', color: newCardData.icono === key ? CORPORATE_BLUE : '#64748b', background: newCardData.icono === key ? '#f0f9ff' : 'transparent', display:'flex', alignItems:'center', justifyContent:'center', width:'45px', height:'45px'}}>{ICON_MAP[key]}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer"><button type="submit" className="btn-primary" style={{backgroundColor: CORPORATE_BLUE}}>Crear</button></div>
                        </form>
                    </div>
                </div>
            )}

            <ModalVerEvaluacionProveedor isOpen={showViewModal} onClose={() => setShowViewModal(false)} idEvaluacion={selectedEvaluacionId} />
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: CORPORATE_BLUE}}>‚óè</div></div>}
        </div>
    );
};

// Helper estilos tabs
const getTabStyle = (isActive, color) => ({
    padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
    background: isActive ? color : 'transparent', color: isActive ? 'white' : '#64748b', display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
});

export default GestionProveedores;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionRecall.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { API_URL, getAuthHeaders } from '../../services/api';

// --- SERVICIOS ---
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';

// --- COMPONENTES GLOBALES ---
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

// --- MODALES ESPEC√çFICOS RECALL ---
import ModalCreateSalida from '../../components/modals/ModalCreateSalida';
import ModalVerSalida from '../../components/modals/ModalVerSalida';

// --- ESTILOS ---
import '../../styles/Dashboard.css';
import '../../styles/Tables.css'; 

import { 
    FaBullhorn, FaTruck, FaClipboardList, FaFolder, FaSearch, FaFilter, 
    FaPlus, FaTrash, FaEye, FaFileContract, FaExclamationTriangle, 
    FaCheckCircle, FaCheckDouble, FaTools, FaBoxOpen, FaUserTie, FaTimes
} from 'react-icons/fa';

// Mapa de Iconos para Carpetas
const ICON_MAP = {
    'folder': <FaFolder />,
    'truck': <FaTruck />,
    'alert': <FaBullhorn />,
    'box': <FaBoxOpen />
};

const GestionRecall = () => {
    // --- ESTADO PRINCIPAL (TABS) ---
    const [activeTab, setActiveTab] = useState('salidas'); 

    // --- ESTADOS TAB 1: SALIDAS (RECALL) ---
    const [salidas, setSalidas] = useState([]);
    const [loadingSalidas, setLoadingSalidas] = useState(false);
    const [showCreateSalida, setShowCreateSalida] = useState(false);
    const [showVerSalida, setShowVerSalida] = useState(false);
    const [selectedSalida, setSelectedSalida] = useState(null);
    const [searchSalida, setSearchSalida] = useState('');

    // --- ESTADOS TAB 2: DOCUMENTACI√ìN ---
    const [cards, setCards] = useState([]);
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo: '', descripcion: '', color: '#0c4760', icono: 'folder' });

    // --- ESTADOS TAB 3: REPORTES ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');
    
    // Modales Reportes y ACPM
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // COLOR TEMA
    const THEME_COLOR = '#0c4760';

    // Carga de datos seg√∫n la pesta√±a activa
    useEffect(() => {
        if (activeTab === 'salidas') fetchSalidas();
        if (activeTab === 'documentacion') loadCards();
        if (activeTab === 'reportes') fetchReportesOperativos();
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA DISTRIBUCI√ìN / SALIDAS
    // ==========================================
    const fetchSalidas = async () => {
        setLoadingSalidas(true);
        try {
            const res = await fetch(`${API_URL}/recall/salidas`, { headers: getAuthHeaders() });
            if (res.ok) {
                const data = await res.json();
                setSalidas(data);
            }
        } catch (error) {
            console.error(error);
        } finally {
            setLoadingSalidas(false);
        }
    };

    const handleVerSalida = (item) => {
        setSelectedSalida(item);
        setShowVerSalida(true);
    };

    const filteredSalidas = salidas.filter(item => 
        item.Producto.toLowerCase().includes(searchSalida.toLowerCase()) ||
        item.Lote.toLowerCase().includes(searchSalida.toLowerCase()) ||
        item.Cliente.toLowerCase().includes(searchSalida.toLowerCase())
    );

    // ==========================================
    // 2. L√ìGICA DOCUMENTACI√ìN (CARPETAS)
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/RECALL`, { headers: getAuthHeaders() });
            if (res.ok) {
                setCards(await res.json());
            }
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'RECALL' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Carpeta creada', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color: THEME_COLOR, icono:'folder' });
                loadCards();
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation();
        if(await Swal.fire({ title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootId = await findOrCreateFolder(1, "Programa Recall", headers);
            let catId = await findOrCreateFolder(rootId, card.Titulo, headers);
            
            setCurrentCategory({ name: card.Titulo, id: catId });
            setShowFileManager(true);
        } catch (error) { 
            console.error(error);
            Swal.fire('Error', 'Error al acceder al repositorio de archivos', 'error'); 
        } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (pid, name, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data = await res.json();
        
        const ex = data.carpetas.find(c => c.NombreCarpeta === name);
        if (ex) return ex.ID_Carpeta;
        
        const resCreate = await fetch(`${API_URL}/drive/carpeta`, { 
            method: 'POST', 
            headers, 
            body: JSON.stringify({ nombre: name, idPadre: pid }) 
        });
        
        const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta;
    };

    // ==========================================
    // 3. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            const filtered = data.filter(r => 
                (r.Programa === 'Recall') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('recall')) ||
                (r.Categoria && r.Categoria.toLowerCase().includes('retiro'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => { 
        setAcpmData({ 
            origen: `Simulacro Recall #${rep.ID_Reporte}`, 
            descripcion: `Falla en simulacro: ${rep.Observaciones || 'Sin detalles'}`, 
            idReporte: rep.ID_Reporte 
        }); 
        setShowCreateACPM(true); 
    };

    const handleOpenViewACPM = async (idACPM) => { 
        try { 
            const all = await getACPMs(); 
            const found = all.find(a => a.ID_ACPM === idACPM); 
            if(found) { setAcpmData(found); setShowViewACPM(true); } 
        } catch (e) { console.error(e); } 
    };

    const getTabStyle = (isActive) => ({
        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer',
        fontWeight:'bold', fontSize:'0.95rem',
        background: isActive ? THEME_COLOR : 'transparent',
        color: isActive ? 'white' : '#64748b',
        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
    });

    // ==========================================
    // RENDERIZADO
    // ==========================================
    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px', color: THEME_COLOR}}>
                        <FaBullhorn /> Programa de Recall
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n de retiros de producto y trazabilidad de salidas.</p>
                </div>
            </div>

            {/* PESTA√ëAS */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px'}}>
                <button onClick={() => setActiveTab('salidas')} style={getTabStyle(activeTab === 'salidas')}>
                    <FaTruck/> Distribuci√≥n Salidas
                </button>
                <button onClick={() => setActiveTab('documentacion')} style={getTabStyle(activeTab === 'documentacion')}>
                    <FaFolder/> Documentaci√≥n
                </button>
                <button onClick={() => setActiveTab('reportes')} style={getTabStyle(activeTab === 'reportes')}>
                    <FaClipboardList/> Reportes Operativos
                </button>
            </div>

            {/* --- CONTENIDO TAB 1: SALIDAS --- */}
            {activeTab === 'salidas' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', // Padding horizontal
                            width:'350px',
                            height: '42px', // Altura fija
                            boxShadow: '0 2px 5px rgba(0,0,0,0.05)'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    fontSize:'0.9rem', 
                                    background: 'transparent',
                                    color: '#334155'
                                }}
                                placeholder="Buscar por Lote, Cliente o Producto..." 
                                value={searchSalida}
                                onChange={e => setSearchSalida(e.target.value)}
                            />
                        </div>

                        <button className="btn-primary" onClick={() => setShowCreateSalida(true)} style={{backgroundColor: THEME_COLOR, color:'white', border:'none', padding:'8px 15px', borderRadius:'6px', display:'flex', alignItems:'center', gap:'8px', cursor:'pointer'}}>
                            <FaPlus /> Registrar Salida
                        </button>
                    </div>

                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr>
                                    <th>Fecha Env√≠o</th>
                                    <th>Producto</th>
                                    <th>Lote</th>
                                    <th>Cliente Destino</th>
                                    <th>Cantidad</th>
                                    <th style={{textAlign:'right'}}>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loadingSalidas ? (
                                    <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>Cargando salidas...</td></tr>
                                ) : filteredSalidas.length === 0 ? (
                                    <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay salidas registradas.</td></tr>
                                ) : (
                                    filteredSalidas.map(salida => (
                                        <tr key={salida.ID_Recall_Salida} className="modern-row">
                                            <td className="modern-cell">
                                                {new Date(salida.Fecha_Envio).toLocaleDateString('es-CO', {timeZone:'UTC'})}
                                            </td>
                                            <td className="modern-cell">
                                                <div style={{fontWeight:'600', color:'#1e293b'}}>{salida.Producto}</div>
                                            </td>
                                            <td className="modern-cell">
                                                <span className="badge" style={{background:'#e0f2fe', color:'#0369a1', border:'1px solid #bae6fd', padding:'2px 8px', borderRadius:'4px', fontSize:'0.85rem'}}>
                                                    {salida.Lote}
                                                </span>
                                            </td>
                                            <td className="modern-cell">
                                                <div style={{display:'flex', alignItems:'center', gap:'5px'}}>
                                                    <FaUserTie style={{color:'#64748b'}}/> {salida.Cliente}
                                                </div>
                                            </td>
                                            <td className="modern-cell">
                                                <strong>{salida.Cantidad}</strong>
                                            </td>
                                            <td className="modern-cell" style={{textAlign:'right'}}>
                                                <button className="btn-text-modern" onClick={() => handleVerSalida(salida)} style={{border:'none', background:'transparent', color: THEME_COLOR, cursor:'pointer'}}>
                                                    <FaEye/> Ver
                                                </button>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO TAB 2: DOCUMENTACI√ìN --- */}
            {activeTab === 'documentacion' && (
                <div className="fade-in">
                    <div style={{marginBottom:'2rem'}}>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'0.5rem'}}>
                            <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Repositorio Documental</h3>
                            <button onClick={() => setShowCreateCardModal(true)} style={{padding:'8px 15px', fontSize:'0.9rem', backgroundColor: THEME_COLOR, color:'white', border:'none', borderRadius:'6px', cursor:'pointer', display:'flex', alignItems:'center', gap:'5px'}}>
                                <FaPlus /> Nueva Carpeta
                            </button>
                        </div>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))', gap:'15px'}}>
                            {cards.map((card) => (
                                <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} 
                                    style={{
                                        background:'white', padding:'1.2rem', borderRadius:'12px', border:'1px solid #e2e8f0', cursor:'pointer', 
                                        transition:'all 0.2s', position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)', 
                                        borderTop: `4px solid ${card.Color}`
                                    }}
                                    onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                    onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                                >
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px'}}>
                                        <div style={{background: `${card.Color}20`, color: card.Color, padding:'10px', borderRadius:'10px', fontSize:'1.4rem', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                            {ICON_MAP[card.Icono] || <FaFolder/>}
                                        </div>
                                        <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px'}}>
                                            <FaTrash size={12}/>
                                        </button>
                                    </div>
                                    <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                    <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )}

            {/* --- CONTENIDO TAB 3: REPORTES OPERATIVOS --- */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        {/* BUSCADOR CORREGIDO TAB REPORTES */}
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px',
                            boxShadow: '0 2px 5px rgba(0,0,0,0.05)'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight:'10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    fontSize:'0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }}
                                placeholder="Buscar simulacro..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}} value={filterStatus} onChange={e => setFilterStatus(e.target.value)} >
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay registros de Recall.</td></tr> : 
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Formulario}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Activo || 'General'}</div>
                                        </td>
                                        <td className="modern-cell">
                                            {rep.Tiene_Fallas ? <span className="status-pill danger" style={{color:'#ef4444'}}><FaExclamationTriangle/> Falla</span> : <span className="status-pill success" style={{color:'#10b981'}}><FaCheckCircle/> Conforme</span> }
                                            {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                        </td>
                                        <td className="modern-cell" style={{textAlign:'right'}}>
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)} style={{border:'none', background:'transparent', color: THEME_COLOR, cursor:'pointer'}}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)} style={{border:'none', background:'transparent', color: '#6366f1', cursor:'pointer'}}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)} style={{border:'none', background:'transparent', color: '#f59e0b', cursor:'pointer'}}><FaTools/></button> : null 
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* ==========================================
                MODALES
               ========================================== */}
            
            {/* Modal de Gestor de Archivos (Drive) */}
            {showFileManager && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Recall: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}

            {/* Modal Crear Carpeta */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Recall</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>T√≠tulo de la Carpeta</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Simulacros 2026" />
                                </div>
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Breve descripci√≥n..." />
                                </div>
                                <div className="form-group">
                                    <label>Color de Etiqueta</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0, cursor:'pointer'}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} style={{ padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', color: newCardData.icono === key ? THEME_COLOR : '#64748b', background: newCardData.icono === key ? '#f0f9ff' : 'transparent' }} >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary" style={{backgroundColor: THEME_COLOR, color:'white', border:'none', padding:'8px 15px', borderRadius:'6px'}}>Crear Carpeta</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}

            {/* Modales Importados */}
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />

            {/* MODALES ESPEC√çFICOS RECALL */}
            <ModalCreateSalida isOpen={showCreateSalida} onClose={() => setShowCreateSalida(false)} onSuccess={fetchSalidas} />
            <ModalVerSalida isOpen={showVerSalida} onClose={() => setShowVerSalida(false)} data={selectedSalida} />

            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default GestionRecall;


==================================================================
ARCHIVO: frontend\src\pages\admin\GestionTrazabilidad.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
// Importamos utilidades seguras
import { API_URL, getAuthHeaders, apiFetchBlob, extractFilename } from '../../services/api';

// Servicios existentes
import { getFichasTecnicas, uploadFichaTecnica, deleteFichaTecnica } from '../../services/trazabilidadService';
import { getPlantillas } from '../../services/certificadosService';

// NUEVOS SERVICIOS PARA REPORTES
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';

// Componentes
import FileManager from '../../components/FileManager';
import ModalDise√±adorCertificado from '../../components/modals/ModalDise√±adorCertificado';
import ModalGenerarCertificado from '../../components/modals/ModalGenerarCertificado';
import ModalHistorialCertificados from '../../components/modals/ModalHistorialCertificados';

// NUEVOS MODALES PARA REPORTES
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

// IMPORTAMOS EL COMPONENTE DE PESOS
import ControlPesos from './ControlPesos'; 

// ESTILOS
import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 
import '../../styles/GestionTrazabilidad.css';

import { 
    FaRoute, FaChartPie, FaFolder, FaPlus, FaTimes, FaTrash, 
    FaFileContract, FaBoxOpen, FaTruck, FaBarcode, FaClipboardCheck, 
    FaCloudUploadAlt, FaSearch, FaFilePdf, FaEye, 
    FaClipboardList, FaCertificate, FaPrint, FaEdit, FaHistory,
    FaBalanceScale,
    // Iconos para Reportes
    FaFilter, FaExclamationTriangle, FaCheckCircle, FaCheckDouble, FaTools
} from 'react-icons/fa';

// MAPA DE ICONOS
const ICON_MAP = {
    'route': <FaRoute />, 'chart': <FaChartPie />, 'folder': <FaFolder />, 'box': <FaBoxOpen />,
    'truck': <FaTruck />, 'barcode': <FaBarcode />, 'clipboard': <FaClipboardCheck />, 'contract': <FaFileContract />
};

const GestionTrazabilidad = () => {
    const [activeTab, setActiveTab] = useState('dashboard'); 
    
    // Estados Documental
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo:'', descripcion:'', color:'#0c4760', icono:'folder' });

    // Estados Fichas
    const [fichas, setFichas] = useState([]);
    const [loadingFichas, setLoadingFichas] = useState(false);
    const [uploadingFicha, setUploadingFicha] = useState(false);
    const [filtroFicha, setFiltroFicha] = useState('');
    const [newFichaNombre, setNewFichaNombre] = useState('');
    const [newFichaArchivo, setNewFichaArchivo] = useState(null);

    // Estados Certificados
    const [plantillas, setPlantillas] = useState([]);
    const [showDesigner, setShowDesigner] = useState(false);
    const [showGenerator, setShowGenerator] = useState(false);
    const [showHistory, setShowHistory] = useState(false);
    
    const [plantillaParaHistorial, setPlantillaParaHistorial] = useState(null); 
    const [selectedPlantilla, setSelectedPlantilla] = useState(null);
    const [filtroCert, setFiltroCert] = useState('');

    // --- ESTADOS REPORTES OPERATIVOS (NUEVO) ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    const [searchTermRep, setSearchTermRep] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        loadCards();
        if (activeTab === 'fichas') loadFichas();
        if (activeTab === 'certificados') loadPlantillas();
        if (activeTab === 'reportes') fetchReportesOperativos(); 
    }, [activeTab]);

    // --- LOGICA EXISTENTE ---
    const loadCards = async () => { try { const res = await fetch(`${API_URL}/core/tarjetas/TRAZABILIDAD`, { headers: getAuthHeaders() }); setCards(await res.json()); } catch (e) { console.error(e); } };
    
    const handleCreateCard = async (e) => { 
        e.preventDefault(); 
        try { 
            const res = await fetch(`${API_URL}/core/tarjetas`, { 
                method: 'POST', 
                headers: getAuthHeaders(), 
                body: JSON.stringify({ ...newCardData, modulo: 'TRAZABILIDAD' }) 
            }); 
            if(res.ok) { 
                Swal.fire('√âxito', 'Carpeta creada correctamente', 'success'); 
                setShowCreateCardModal(false); 
                setNewCardData({ titulo:'', descripcion:'', color:'#0c4760', icono:'folder' }); 
                loadCards(); 
            } 
        } catch (error) { Swal.fire('Error', 'No se pudo crear', 'error'); } 
    };

    const handleDeleteCard = async (e, id) => { e.stopPropagation(); if(await Swal.fire({title:'¬øBorrar carpeta?', text: 'Se ocultar√° el acceso, pero los archivos permanecen en el Drive.', icon:'warning', showCancelButton:true}).then(r=>r.isConfirmed)){ await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() }); loadCards(); } };
    const handleCardClick = async (card) => { setLoadingFolder(true); try { const headers = getAuthHeaders(); let rootId = await findOrCreateFolder(1, "Programa Trazabilidad", headers); let catId = await findOrCreateFolder(rootId, card.Titulo, headers); setCurrentCategory({ name: card.Titulo, id: catId }); setShowFileManager(true); } catch (error) { Swal.fire('Error', 'Error repositorio', 'error'); } finally { setLoadingFolder(false); } };
    const findOrCreateFolder = async (pid, name, headers) => { const res = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers }); const data = await res.json(); const ex = data.carpetas.find(c => c.NombreCarpeta === name); if (ex) return ex.ID_Carpeta; await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: name, idPadre: pid }) }); const res2 = await fetch(`${API_URL}/drive/contenido/${pid}`, { headers }); const data2 = await res2.json(); return data2.carpetas.find(c => c.NombreCarpeta === name).ID_Carpeta; };

    const loadFichas = async () => { setLoadingFichas(true); try { setFichas(await getFichasTecnicas()); } catch (e) { console.error(e); } finally { setLoadingFichas(false); } };
    
    // --- FUNCI√ìN SEGURA PARA VER FICHA ---
    const handleVerFicha = async (urlFicha) => {
        if (!urlFicha) return;
        try {
            const filename = extractFilename(urlFicha);
            // Usamos ruta segura (Debemos crearla en backend)
            const blob = await apiFetchBlob(`/trazabilidad/ficha/${filename}`);
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al ver ficha:", error);
            if (urlFicha.startsWith('http')) window.open(urlFicha, '_blank');
            else Swal.fire('Error', 'No se pudo abrir el documento', 'error');
        }
    };

    const handleUploadFicha = async (e) => { e.preventDefault(); if (!newFichaNombre || !newFichaArchivo) return Swal.fire('Faltan datos', '', 'warning'); setUploadingFicha(true); const fd = new FormData(); fd.append('nombre', newFichaNombre); fd.append('archivo', newFichaArchivo); fd.append('descripcion', 'Ficha T√©cnica'); try { await uploadFichaTecnica(fd); Swal.fire('Subido', '', 'success'); setNewFichaNombre(''); setNewFichaArchivo(null); loadFichas(); } catch (e) { Swal.fire('Error', e.message, 'error'); } finally { setUploadingFicha(false); } };
    const handleDeleteFicha = async (id) => { if (await Swal.fire({ title: '¬øEliminar?', icon: 'warning', showCancelButton: true }).then(r => r.isConfirmed)) { await deleteFichaTecnica(id); loadFichas(); } };
    const filteredFichas = fichas.filter(f => f.Nombre.toLowerCase().includes(filtroFicha.toLowerCase()));

    // --- CERTIFICADOS ---
    const loadPlantillas = async () => { try { const data = await getPlantillas(); setPlantillas(data); } catch (error) { console.error(error); } };
    const handleDesign = (plantilla = null) => { setSelectedPlantilla(plantilla); setShowDesigner(true); };
    const handleGenerate = (plantilla) => { setSelectedPlantilla(plantilla); setShowGenerator(true); };
    
    const handleOpenHistory = (plantilla = null) => {
        setPlantillaParaHistorial(plantilla); 
        setShowHistory(true);
    };

    const filteredPlantillas = plantillas.filter(p => p.Nombre.toLowerCase().includes(filtroCert.toLowerCase()));

    // --- L√ìGICA REPORTES OPERATIVOS (NUEVO) ---
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            const filtered = data.filter(r => 
                (r.Programa === 'Trazabilidad') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('trazabilidad'))
            );
            setReportes(filtered);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    const getFilteredReportes = () => {
        return reportes.filter(item => {
            const term = searchTermRep.toLowerCase();
            const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                              (item.Activo || '').toLowerCase().includes(term) ||
                              (item.Formulario || '').toLowerCase().includes(term);
            let statusMatch = true;
            if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
            if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
            if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
            return textMatch && statusMatch;
        });
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte Trazabilidad #${rep.ID_Reporte}`,
            descripcion: `Hallazgo en proceso: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    return (
        <div className="traza-container">
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaRoute style={{color:'#0c4760'}}/> Programa de Trazabilidad
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Gesti√≥n integral de lotes y calidad.</p>
                </div>
            </div>

            {/* NAVBAR RESPONSIVE */}
            <div className="traza-tabs">
                <button onClick={() => setActiveTab('dashboard')} className={activeTab === 'dashboard' ? 'active' : ''}>
                    <FaChartPie/> Dashboard BI
                </button>
                <button onClick={() => setActiveTab('pesos')} className={activeTab === 'pesos' ? 'active' : ''}>
                    <FaBalanceScale/> Control Pesos
                </button>
                <button onClick={() => setActiveTab('docs')} className={activeTab === 'docs' ? 'active' : ''}>
                    <FaFolder/> Repositorio
                </button>
                <button onClick={() => setActiveTab('fichas')} className={activeTab === 'fichas' ? 'active' : ''}>
                    <FaClipboardList/> Fichas T√©cnicas
                </button>
                <button onClick={() => setActiveTab('certificados')} className={activeTab === 'certificados' ? 'active' : ''}>
                    <FaCertificate/> Certificados
                </button>
                <button onClick={() => setActiveTab('reportes')} className={activeTab === 'reportes' ? 'active' : ''}>
                    <FaClipboardCheck/> Reportes Op.
                </button>
            </div>

            {/* VISTAS */}
            
            {/* 1. DASHBOARD */}
            {activeTab === 'dashboard' && (
                <div className="card-section iframe-container">
                    <iframe title="Trazabilidad" width="100%" height="100%" src="https://app.powerbi.com/view?r=eyJrIjoiOGFiNWJmZDktNTdkOS00MTZlLWI2YTYtMmRmNzdkZGRmY2NmIiwidCI6IjQ0Y2FjYTMwLTJjZWYtNGQ4ZS1hYzk5LTcwODliZTkwNDJmYiIsImMiOjR9" frameBorder="0" allowFullScreen={true}></iframe>
                </div>
            )}

            {/* 2. CONTROL DE PESOS (INTEGRADO) */}
            {activeTab === 'pesos' && (
                <ControlPesos />
            )}
            
            {/* 3. REPOSITORIO */}
            {activeTab === 'docs' && (
                <div className="fade-in">
                    <div className="section-actions">
                        <div>
                            <h3 className="section-title">Repositorio Documental</h3>
                            <p className="section-subtitle">Gestione las carpetas del √°rea</p>
                        </div>
                    </div>
                    
                    <div className="grid-cards">
                        {cards.map((card) => (
                            <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)} className="doc-card">
                                <div className="doc-card-header">
                                    <div className="icon-wrapper" style={{color: card.Color, background: `${card.Color}20`}}>
                                        {ICON_MAP[card.Icono] || <FaFolder/>}
                                    </div>
                                    <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} className="btn-icon-delete">
                                        <FaTrash size={12}/>
                                    </button>
                                </div>
                                <h4>{card.Titulo}</h4>
                                <p>{card.Descripcion}</p>
                            </div>
                        ))}

                        <div 
                            onClick={() => setShowCreateCardModal(true)}
                            className="new-card-btn"
                        >
                            <FaPlus size={30} />
                            <span style={{fontWeight:'600', marginTop:'10px'}}>Nueva Carpeta</span>
                        </div>
                    </div>
                </div>
            )}
            
            {/* 4. FICHAS T√âCNICAS */}
            {activeTab === 'fichas' && (
                <div className="fade-in">
                    <div className="fichas-layout">
                        <div className="panel-upload">
                            <h3><FaCloudUploadAlt/> Subir Ficha</h3>
                            <form onSubmit={handleUploadFicha}>
                                <div className="form-group">
                                    <label>Nombre</label>
                                    <input className="form-control" value={newFichaNombre} onChange={e=>setNewFichaNombre(e.target.value)} required placeholder="Ej: Ficha-Ma√≠z" />
                                </div>
                                <div className="form-group">
                                    <label>Archivo</label>
                                    <input type="file" className="form-control" onChange={e=>setNewFichaArchivo(e.target.files[0])} accept=".pdf,.doc,.xls,image/*" required style={{padding:'8px'}} />
                                </div>
                                <button className="btn-primary full-width" disabled={uploadingFicha}>
                                    {uploadingFicha ? 'Subiendo...' : 'Subir Documento'}
                                </button>
                            </form>
                        </div>

                        <div className="panel-list">
                            <div className="list-header">
                                <h3>Listado ({filteredFichas.length})</h3>
                                <div className="search-wrapper">
                                    <FaSearch className="search-icon"/>
                                    <input placeholder="Filtrar..." value={filtroFicha} onChange={e=>setFiltroFicha(e.target.value)} />
                                </div>
                            </div>
                            
                            <div className="list-content">
                                {filteredFichas.map(f => (
                                    <div key={f.ID_Doc} className="list-item">
                                        <div className="item-icon"><FaFilePdf size={20}/></div>
                                        <div className="item-info">
                                            <div className="item-name">{f.Nombre}</div>
                                            <div className="item-date">{new Date(f.Fecha_Creacion).toLocaleDateString()}</div>
                                        </div>
                                        <div className="item-actions">
                                            {/* BOT√ìN SEGURO PARA VER FICHA */}
                                            <button 
                                                onClick={() => handleVerFicha(f.Url_Archivo)} 
                                                className="btn-action-icon"
                                            >
                                                <FaEye/>
                                            </button>
                                            <button onClick={()=>handleDeleteFicha(f.ID_Doc)} className="btn-action-icon delete"><FaTrash/></button>
                                        </div>
                                    </div>
                                ))}
                                {filteredFichas.length === 0 && <p className="empty-msg">No hay fichas.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* 5. CERTIFICADOS */}
            {activeTab === 'certificados' && (
                <div className="fade-in">
                    <div className="section-actions">
                        <div>
                            <h3 className="section-title">Gesti√≥n de Certificados</h3>
                            <p className="section-subtitle">Dise√±e formatos y genere certificados.</p>
                        </div>
                        <div className="btn-group-responsive">
                            <button className="btn-secondary" onClick={() => handleOpenHistory(null)}>
                                <FaHistory/> <span className="hide-mobile">Historial Completo</span>
                            </button>
                            <button className="btn-primary" onClick={() => handleDesign(null)}>
                                <FaPlus/> <span className="hide-mobile">Nuevo Dise√±o</span>
                            </button>
                        </div>
                    </div>

                    <div className="search-bar-full">
                        <FaSearch className="search-icon"/>
                        <input type="text" placeholder="Buscar formato..." value={filtroCert} onChange={e => setFiltroCert(e.target.value)} />
                    </div>

                    <div className="table-container">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre del Formato</th>
                                    <th>Fecha Creaci√≥n</th>
                                    <th style={{textAlign:'right'}}>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredPlantillas.map(p => (
                                    <tr key={p.ID_Plantilla}>
                                        <td style={{fontWeight:'bold', color:'#0c4760'}}>
                                            <FaFileContract style={{marginRight:'8px', verticalAlign:'middle', color:'#0c4760'}}/>
                                            {p.Nombre}
                                        </td>
                                        <td>{new Date(p.Fecha_Creacion).toLocaleDateString()}</td>
                                        <td>
                                            <div className="action-buttons right">
                                                <button className="btn-action" title="Historial" onClick={() => handleOpenHistory(p)}>
                                                    <FaHistory />
                                                </button>
                                                <button className="btn-action" title="Editar" onClick={() => handleDesign(p)}>
                                                    <FaEdit />
                                                </button>
                                                <button className="btn-action primary-outline" onClick={() => handleGenerate(p)}>
                                                    <FaPrint /> Generar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                                {filteredPlantillas.length === 0 && <tr><td colSpan="3" style={{textAlign:'center', padding:'2rem', color:'#999'}}>No hay formatos disponibles.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* 6. REPORTES OPERATIVOS (NUEVO TAB) */}
            {activeTab === 'reportes' && (
                <div className="fade-in">
                    <div className="control-bar" style={{marginBottom:'20px', display:'flex', justifyContent:'space-between', flexWrap:'wrap', gap:'10px'}}>
                        
                        <div style={{
                            display:'flex', 
                            alignItems:'center', 
                            background:'white', 
                            border:'1px solid #e2e8f0', 
                            borderRadius:'8px', 
                            padding:'0 15px', 
                            width:'300px',
                            height: '42px',
                            boxShadow: '0 2px 5px rgba(0,0,0,0.05)'
                        }}>
                            <FaSearch style={{color:'#94a3b8', marginRight: '10px', flexShrink: 0}} />
                            <input 
                                style={{
                                    border:'none', 
                                    outline:'none', 
                                    width:'100%', 
                                    padding:'0', 
                                    fontSize: '0.9rem',
                                    background: 'transparent',
                                    color: '#334155'
                                }}
                                placeholder="Buscar reporte..." 
                                value={searchTermRep} 
                                onChange={e => setSearchTermRep(e.target.value)} 
                            />
                        </div>

                        <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                            <FaFilter style={{color:'#64748b'}}/>
                            <select style={{padding:'8px', borderRadius:'8px', border:'1px solid #e2e8f0', background:'white', color:'#475569'}} value={filterStatus} onChange={e => setFilterStatus(e.target.value)} >
                                <option value="todos">Todos</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div className="table-container">
                        <table className="modern-table">
                            <thead>
                                <tr><th>Fecha</th><th>Responsable</th><th>Formato / Proceso</th><th>Estado</th><th style={{textAlign:'right'}}>Acciones</th></tr>
                            </thead>
                            <tbody>
                                {loadingReportes ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr> : 
                                getFilteredReportes().length === 0 ? <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes de trazabilidad registrados.</td></tr> :
                                getFilteredReportes().map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'N/A'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell" style={{textAlign:'right'}}>
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* MODALES GLOBALES */}
            
            {/* Modal Creaci√≥n Carpetas */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'550px'}}>
                        <div className="modal-header">
                            <h2>Nueva Carpeta Trazabilidad</h2>
                            <button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button>
                        </div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group">
                                    <label>T√≠tulo</label>
                                    <input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Registros Lote" />
                                </div>
                                <div className="form-group">
                                    <label>Descripci√≥n</label>
                                    <input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} placeholder="Descripci√≥n corta" />
                                </div>
                                <div className="form-group">
                                    <label>Color</label>
                                    <input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} />
                                </div>
                                
                                <div className="form-group">
                                    <label>Seleccionar Icono</label>
                                    <div style={{
                                        display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'10px', marginTop:'5px',
                                        maxHeight: '180px', overflowY: 'auto', padding: '5px', border: '1px solid #e2e8f0', borderRadius: '8px'
                                    }}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} 
                                                style={{
                                                    padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.4rem', 
                                                    border: newCardData.icono === key ? '2px solid #0c4760' : '1px solid white', 
                                                    background: newCardData.icono === key ? '#f0f9ff' : 'transparent', 
                                                    color: newCardData.icono === key ? '#0c4760' : '#64748b'
                                                }} 
                                                title={key} 
                                            >
                                                {ICON_MAP[key]}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer">
                                <button type="button" className="btn-secondary" onClick={()=>setShowCreateCardModal(false)}>Cancelar</button>
                                <button type="submit" className="btn-primary-modal">Crear</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
            
            <ModalDise√±adorCertificado isOpen={showDesigner} onClose={() => setShowDesigner(false)} onSuccess={loadPlantillas} plantillaEditar={selectedPlantilla} />
            <ModalGenerarCertificado isOpen={showGenerator} onClose={() => setShowGenerator(false)} plantilla={selectedPlantilla} />
            
            <ModalHistorialCertificados 
                isOpen={showHistory} 
                onClose={() => setShowHistory(false)} 
                plantillaFiltro={plantillaParaHistorial} 
            />

            {/* NUEVOS MODALES DE REPORTES */}
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />

            {showFileManager && (
                <div style={{position:'fixed', top:0, left:0, width:'100vw', height:'100vh', background:'rgba(0,0,0,0.7)', zIndex: 99999, display:'flex', alignItems:'center', justifyContent:'center', padding:'10px'}}>
                    <div style={{width:'100%', maxWidth:'1000px', height:'85vh', background:'white', borderRadius:'12px', overflow:'hidden', position: 'relative'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Trazabilidad: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}
            
            {loadingFolder && <div style={{position:'fixed', top:0, left:0, width:'100%', height:'100%', background:'rgba(255,255,255,0.8)', zIndex: 99999, display:'flex', alignItems:'center', justifyContent:'center', flexDirection:'column'}}><div className="spin" style={{fontSize:'3rem', color:'#0c4760'}}>‚óè</div><p>Cargando...</p></div>}
        </div>
    );
};

export default GestionTrazabilidad;


==================================================================
ARCHIVO: frontend\src\pages\admin\HistorialAguaAdmin.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
// Importamos utilidades de seguridad
import { API_URL, getAuthHeaders, apiFetchBlob, extractFilename } from '../../services/api';

// --- SERVICIOS ---
import { getHistorialAgua } from '../../services/specializedService'; // Registro Diario (Cloro/pH)
import { getReportes } from '../../services/reportesService';         // Reportes Operativos (Forms)
import { getACPMs } from '../../services/acpmService';                // Planes de Acci√≥n

// --- COMPONENTES ---
import ModalRegistrarAgua from '../../components/modals/ModalRegistrarAgua';
import FileManager from '../../components/FileManager';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import { 
    FaPlus, FaSearch, FaEye, FaFileContract, FaPaperclip, 
    FaCamera, FaClipboardList, FaMap, FaCogs,
    FaTrash, FaFolder, FaTimes, FaTint, FaCalendarCheck, 
    FaFilter, FaExclamationTriangle, FaCheckCircle, FaCheckDouble, FaTools
} from 'react-icons/fa';

import '../../styles/Tables.css';
import '../../styles/Dashboard.css'; 

// MAPA DE ICONOS
const ICON_MAP = {
    'contract': <FaFileContract />,
    'cogs': <FaCogs />,
    'clip': <FaPaperclip />,
    'camera': <FaCamera />,
    'list': <FaClipboardList />,
    'map': <FaMap />,
    'folder': <FaFolder />,
    'water': <FaTint />
};

const HistorialAguaAdmin = () => {
    // --- TABS: 'monitoreo' (Diario), 'docs' (Archivos), 'reportes' (Checklists) ---
    const [activeTab, setActiveTab] = useState('monitoreo');

    // --- ESTADOS MONITOREO DIARIO (Cloro/pH) ---
    const [registrosDiarios, setRegistrosDiarios] = useState([]);
    const [loadingDiario, setLoadingDiario] = useState(false);
    const [showModalRegistro, setShowModalRegistro] = useState(false);

    // --- ESTADOS GESTI√ìN DOCUMENTAL ---
    const [showFileManager, setShowFileManager] = useState(false);
    const [currentCategory, setCurrentCategory] = useState({ name: '', id: null });
    const [loadingFolder, setLoadingFolder] = useState(false);
    const [cards, setCards] = useState([]);
    const [showCreateCardModal, setShowCreateCardModal] = useState(false);
    const [newCardData, setNewCardData] = useState({ titulo:'', descripcion:'', color:'#0ea5e9', icono:'water' });

    // --- ESTADOS REPORTES OPERATIVOS ---
    const [reportes, setReportes] = useState([]);
    const [loadingReportes, setLoadingReportes] = useState(false);
    const [filterStatus, setFilterStatus] = useState('todos');
    
    // Filtro de b√∫squeda general
    const [searchTerm, setSearchTerm] = useState('');

    // Modales Reportes
    const [showViewReporte, setShowViewReporte] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    // Color Tem√°tico (Azul Agua)
    const THEME_COLOR = '#0ea5e9';

    useEffect(() => {
        if (activeTab === 'monitoreo') fetchRegistrosDiarios();
        if (activeTab === 'docs') loadCards();
        if (activeTab === 'reportes') fetchReportesOperativos();
    }, [activeTab]);

    // ==========================================
    // 1. L√ìGICA MONITOREO DIARIO
    // ==========================================
    const fetchRegistrosDiarios = async () => {
        setLoadingDiario(true);
        try {
            const data = await getHistorialAgua();
            setRegistrosDiarios(data);
        } catch (error) { console.error(error); } 
        finally { setLoadingDiario(false); }
    };

    // --- FUNCI√ìN SEGURA PARA VER EVIDENCIA DE AGUA ---
    const handleVerEvidencia = async (urlEvidencia) => {
        if (!urlEvidencia) return;
        try {
            const filename = extractFilename(urlEvidencia);
            // CORRECCI√ìN APLICADA: Se agreg√≥ el prefijo '/specialized' a la ruta
            const blob = await apiFetchBlob(`/specialized/agua/evidencia/${filename}`);
            
            if (blob.size === 0) throw new Error("Archivo vac√≠o");

            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al ver evidencia:", error);
            if (urlEvidencia.startsWith('http')) window.open(urlEvidencia, '_blank');
            else Swal.fire('Error', 'No se pudo abrir la evidencia', 'error');
        }
    };

    // ==========================================
    // 2. L√ìGICA DOCUMENTACI√ìN (CARPETAS)
    // ==========================================
    const loadCards = async () => {
        try {
            const res = await fetch(`${API_URL}/core/tarjetas/AGUA`, { headers: getAuthHeaders() });
            const data = await res.json();
            setCards(data);
        } catch (e) { console.error(e); }
    };

    const handleCreateCard = async (e) => {
        e.preventDefault();
        try {
            const res = await fetch(`${API_URL}/core/tarjetas`, {
                method: 'POST', headers: getAuthHeaders(),
                body: JSON.stringify({ ...newCardData, modulo: 'AGUA' })
            });
            if(res.ok) {
                Swal.fire('√âxito', 'Tarjeta agregada correctamente', 'success');
                setShowCreateCardModal(false);
                setNewCardData({ titulo:'', descripcion:'', color:'#0ea5e9', icono:'folder' });
                loadCards(); 
            }
        } catch (error) { Swal.fire('Error', 'No se pudo crear la tarjeta', 'error'); }
    };

    const handleDeleteCard = async (e, id) => {
        e.stopPropagation(); 
        if(await Swal.fire({
            title:'¬øBorrar tarjeta?', 
            text:'Se ocultar√° el acceso, pero los archivos seguir√°n seguros en el Drive.', 
            icon:'warning', showCancelButton:true, confirmButtonColor: '#d33'
        }).then(r=>r.isConfirmed)){
            await fetch(`${API_URL}/core/tarjetas/${id}`, { method:'DELETE', headers:getAuthHeaders() });
            loadCards();
        }
    };

    const handleCardClick = async (card) => {
        setLoadingFolder(true);
        try {
            const headers = getAuthHeaders();
            let rootModuleId = await findOrCreateFolder(1, "Monitoreo Agua", headers);
            let categoryFolderId = await findOrCreateFolder(rootModuleId, card.Titulo, headers);
            setCurrentCategory({ name: card.Titulo, id: categoryFolderId });
            setShowFileManager(true);
        } catch (error) { Swal.fire('Error', 'No se pudo acceder al repositorio.', 'error'); } 
        finally { setLoadingFolder(false); }
    };

    const findOrCreateFolder = async (parentId, folderName, headers) => {
        const res = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data = await res.json();
        const existing = data.carpetas.find(c => c.NombreCarpeta === folderName);
        if (existing) return existing.ID_Carpeta;
        await fetch(`${API_URL}/drive/carpeta`, { method: 'POST', headers, body: JSON.stringify({ nombre: folderName, idPadre: parentId }) });
        const res2 = await fetch(`${API_URL}/drive/contenido/${parentId}`, { headers });
        const data2 = await res2.json();
        return data2.carpetas.find(c => c.NombreCarpeta === folderName).ID_Carpeta;
    };

    // ==========================================
    // 3. L√ìGICA REPORTES OPERATIVOS
    // ==========================================
    const fetchReportesOperativos = async () => {
        setLoadingReportes(true);
        try {
            const data = await getReportes();
            const onlyAgua = data.filter(r => 
                (r.Programa === 'Agua Potable') || 
                (r.Categoria && r.Categoria.toLowerCase().includes('agua'))
            );
            setReportes(onlyAgua);
        } catch (error) { console.error(error); } 
        finally { setLoadingReportes(false); }
    };

    // Filtros combinados
    const getFilteredData = () => {
        const term = searchTerm.toLowerCase();
        
        if (activeTab === 'monitoreo') {
            return registrosDiarios.filter(r => 
                r.Usuario.toLowerCase().includes(term) || 
                r.Punto_Toma.toLowerCase().includes(term)
            );
        }
        
        if (activeTab === 'reportes') {
            return reportes.filter(item => {
                const textMatch = (item.Usuario || '').toLowerCase().includes(term) || 
                                  (item.Activo || '').toLowerCase().includes(term);
                let statusMatch = true;
                if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
                if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
                if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;
                return textMatch && statusMatch;
            });
        }
        return [];
    };

    const handleOpenViewReporte = (rep) => { setSelectedReporte(rep); setShowViewReporte(true); };
    
    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte Agua #${rep.ID_Reporte}`,
            descripcion: `Novedad en sistema de agua: ${rep.Observaciones || 'Sin detalles'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const all = await getACPMs();
            const found = all.find(a => a.ID_ACPM === idACPM);
            if(found) { setAcpmData(found); setShowViewACPM(true); }
        } catch (e) { console.error(e); }
    };

    const filteredData = getFilteredData();

    return (
        <div className="fade-in">
            {/* CABECERA */}
            <div className="page-header">
                <div>
                    <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px'}}>
                        <FaTint style={{color: THEME_COLOR}}/> Gesti√≥n de Agua Potable
                    </h1>
                    <p style={{color:'#64748b', marginTop:'-5px'}}>Monitoreo de calidad, documentaci√≥n y reportes operativos.</p>
                </div>
            </div>

            {/* PESTA√ëAS (TABS) */}
            <div style={{display:'flex', gap:'10px', marginBottom:'1.5rem', borderBottom:'1px solid #e2e8f0', paddingBottom:'10px', flexWrap:'wrap'}}>
                <button 
                    onClick={() => setActiveTab('monitoreo')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'monitoreo' ? '#0c4760' : 'transparent',
                        color: activeTab === 'monitoreo' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaCalendarCheck/> Monitoreo Diario (Cloro/pH)
                </button>
                <button 
                    onClick={() => setActiveTab('docs')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'docs' ? '#0c4760' : 'transparent',
                        color: activeTab === 'docs' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaFolder/> Documentaci√≥n
                </button>
                <button 
                    onClick={() => setActiveTab('reportes')}
                    style={{
                        padding:'10px 20px', borderRadius:'8px', border:'none', cursor:'pointer', fontWeight:'bold', fontSize:'0.95rem',
                        background: activeTab === 'reportes' ? '#0c4760' : 'transparent',
                        color: activeTab === 'reportes' ? 'white' : '#64748b', 
                        display:'flex', alignItems:'center', gap:'8px', transition:'all 0.2s'
                    }}
                >
                    <FaClipboardList/> Reportes Operativos
                </button>
            </div>

            {/* BARRA DE FILTROS (Com√∫n para Monitoreo y Reportes) */}
            {activeTab !== 'docs' && (
                <div className="filters-bar" style={{marginBottom:'20px'}}>
                    <div className="search-input-container">
                        <FaSearch />
                        <input 
                            type="text" 
                            placeholder={activeTab === 'monitoreo' ? "Buscar por usuario o punto de toma..." : "Buscar reporte por activo o responsable..."}
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                        />
                    </div>
                    {activeTab === 'reportes' && (
                        <div className="filter-select-container">
                            <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                                <option value="todos">Todos los Estados</option>
                                <option value="fallas">Con Hallazgos</option>
                                <option value="ok">Conforme</option>
                                <option value="pendiente">Pendiente Revisi√≥n</option>
                            </select>
                        </div>
                    )}
                    {activeTab === 'monitoreo' && (
                        <button 
                            className="btn-primary" 
                            onClick={() => setShowModalRegistro(true)}
                            style={{backgroundColor: THEME_COLOR, display:'flex', alignItems:'center', gap:'8px', padding:'10px 20px'}}
                        >
                            <FaPlus /> Registrar Medici√≥n
                        </button>
                    )}
                </div>
            )}

            {/* --- CONTENIDO TAB 1: MONITOREO DIARIO --- */}
            {activeTab === 'monitoreo' && (
                <div className="table-container fade-in">
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Fecha / Hora</th>
                                <th>Responsable</th>
                                <th>Punto de Toma</th>
                                <th>Mediciones</th>
                                <th>Evidencia</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loadingDiario ? (
                                <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando historial...</td></tr>
                            ) : filteredData.length === 0 ? (
                                <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay registros de medici√≥n.</td></tr>
                            ) : (
                                filteredData.map(row => (
                                    <tr key={row.ID_Registro}>
                                        <td>
                                            <div style={{fontWeight:'500'}}>
                                                {new Date(row.Fecha).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                            </div>
                                            <div style={{fontSize:'0.8rem', color:'#64748b'}}>
                                                {new Date(row.Fecha).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour:'2-digit', minute:'2-digit' })}
                                            </div>
                                        </td>
                                        <td>{row.Usuario}</td>
                                        <td><span style={{fontWeight:'600', color:'#0c4760'}}>{row.Punto_Toma}</span></td>
                                        <td>
                                            <span style={{background:'#f0f9ff', padding:'4px 8px', borderRadius:'4px', fontSize:'0.85rem', border:'1px solid #bae6fd', color:'#0369a1'}}>
                                                {row.Datos_Medicion}
                                            </span>
                                        </td>
                                        <td>
                                            {/* BOT√ìN SEGURO PARA VER FOTO */}
                                            {row.Url_Foto_Evidencia ? (
                                                <button 
                                                    onClick={() => handleVerEvidencia(row.Url_Foto_Evidencia)} 
                                                    className="btn-action" 
                                                    style={{display:'inline-flex', alignItems:'center', gap:'5px', textDecoration:'none', color:'#64748b', border:'none', background:'transparent', cursor:'pointer'}}
                                                >
                                                    <FaEye /> Ver Foto
                                                </button>
                                            ) : (
                                                <span style={{color:'#94a3b8', fontSize:'0.85rem'}}>Sin foto</span>
                                            )}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            )}

            {/* --- CONTENIDO TAB 2: DOCUMENTACI√ìN --- */}
            {activeTab === 'docs' && (
                <div className="fade-in">
                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'1rem'}}>
                        <h3 style={{fontSize:'1.1rem', color:'#334155', margin:0}}>Carpetas del Repositorio</h3>
                        <button className="btn-primary" onClick={() => setShowCreateCardModal(true)} style={{backgroundColor: THEME_COLOR, padding:'8px 15px', fontSize:'0.9rem'}}>
                            <FaPlus style={{marginRight:'5px'}}/> Nueva Carpeta
                        </button>
                    </div>
                    
                    <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))', gap:'15px'}}>
                        {cards.map((card) => (
                            <div key={card.ID_Tarjeta} onClick={() => handleCardClick(card)}
                                style={{
                                    background:'white', padding:'1.2rem', borderRadius:'12px', 
                                    border:'1px solid #e2e8f0', cursor:'pointer', transition:'all 0.2s',
                                    position:'relative', overflow:'hidden', boxShadow:'0 2px 4px rgba(0,0,0,0.02)',
                                    borderTop: `4px solid ${card.Color}`
                                }}
                                onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-3px)'; e.currentTarget.style.boxShadow = '0 10px 15px rgba(0,0,0,0.05)'; }}
                                onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 4px rgba(0,0,0,0.02)'; }}
                            >
                                <div style={{display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:'10px'}}>
                                    <div style={{background: `${card.Color}20`, color: card.Color, width:'45px', height:'45px', borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center', fontSize:'1.4rem'}}>
                                        {ICON_MAP[card.Icono] || <FaFolder/>}
                                    </div>
                                    <button onClick={(e) => handleDeleteCard(e, card.ID_Tarjeta)} style={{border:'none', background:'transparent', color:'#ef4444', cursor:'pointer', padding:'5px', borderRadius:'50%'}}>
                                        <FaTrash size={12}/>
                                    </button>
                                </div>
                                <h4 style={{margin:0, color:'#1e293b', fontSize:'1rem'}}>{card.Titulo}</h4>
                                <p style={{margin:'5px 0 0 0', fontSize:'0.8rem', color:'#64748b'}}>{card.Descripcion}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* --- CONTENIDO TAB 3: REPORTES OPERATIVOS --- */}
            {activeTab === 'reportes' && (
                <div className="table-container fade-in">
                    <table className="modern-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Responsable</th>
                                <th>Formato / √Årea</th>
                                <th>Estado</th>
                                <th style={{textAlign:'right'}}>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {loadingReportes ? (
                                <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando reportes...</td></tr>
                            ) : filteredData.length === 0 ? (
                                <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No hay reportes operativos registrados.</td></tr>
                            ) : (
                                filteredData.map(rep => (
                                    <tr key={rep.ID_Reporte} className="modern-row">
                                        <td className="modern-cell">
                                            <div className="date-main">{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</div>
                                            <div className="date-sub">{new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}</div>
                                        </td>
                                        <td className="modern-cell"><strong>{rep.Usuario}</strong></td>
                                        <td className="modern-cell">
                                            <div className="asset-name">{rep.Activo || 'General'}</div>
                                            <div className="form-name" style={{color:'#64748b', fontSize:'0.85rem'}}>{rep.Formulario}</div>
                                        </td>
                                        <td className="modern-cell">
                                            <div style={{display:'flex', gap:'5px', flexDirection:'column'}}>
                                                {rep.Tiene_Fallas ? 
                                                    <span className="status-pill danger"><FaExclamationTriangle/> Hallazgo</span> : 
                                                    <span className="status-pill success"><FaCheckCircle/> Conforme</span>
                                                }
                                                {rep.Verificado && <span className="verified-badge" style={{fontSize:'0.7rem', color:'#10b981', fontWeight:'bold', display:'flex', alignItems:'center', gap:'4px'}}><FaCheckDouble/> Verificado</span>}
                                            </div>
                                        </td>
                                        <td className="modern-cell">
                                            <div className="action-group">
                                                <button className="btn-text-modern" onClick={() => handleOpenViewReporte(rep)}><FaFileContract/> Ver</button>
                                                {rep.ID_ACPM ? 
                                                    <button className="btn-text-modern btn-acpm-view" onClick={() => handleOpenViewACPM(rep.ID_ACPM)}><FaEye/></button> : 
                                                    rep.Tiene_Fallas ? <button className="btn-text-modern btn-acpm-create" onClick={() => handleOpenCreateACPM(rep)}><FaTools/></button> : null
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            )}

            {/* MODALES GLOBALES */}
            <ModalRegistrarAgua isOpen={showModalRegistro} onClose={() => setShowModalRegistro(false)} onSuccess={fetchRegistrosDiarios} />
            <ModalVerReporte isOpen={showViewReporte} onClose={() => setShowViewReporte(false)} reporte={selectedReporte} onUpdate={fetchReportesOperativos} />
            <ModalCreateACPM isOpen={showCreateACPM} onClose={() => setShowCreateACPM(false)} initialData={acpmData} onSuccess={fetchReportesOperativos} />
            <ModalVerACPM isOpen={showViewACPM} onClose={() => setShowViewACPM(false)} acpm={acpmData} />

            {/* MODAL CREAR TARJETA */}
            {showCreateCardModal && (
                <div className="modal-overlay">
                    <div className="modal-content" style={{maxWidth:'500px'}}>
                        <div className="modal-header"><h2>Nueva Carpeta</h2><button className="modal-close-button" onClick={()=>setShowCreateCardModal(false)}><FaTimes/></button></div>
                        <form onSubmit={handleCreateCard}>
                            <div className="modal-body">
                                <div className="form-group"><label>T√≠tulo</label><input className="form-control" required value={newCardData.titulo} onChange={e=>setNewCardData({...newCardData, titulo:e.target.value})} placeholder="Ej: Certificados Lab" /></div>
                                <div className="form-group"><label>Descripci√≥n</label><input className="form-control" value={newCardData.descripcion} onChange={e=>setNewCardData({...newCardData, descripcion:e.target.value})} /></div>
                                <div className="form-group"><label>Color</label><input type="color" className="form-control" style={{height:'40px', padding:0}} value={newCardData.color} onChange={e=>setNewCardData({...newCardData, color:e.target.value})} /></div>
                                <div className="form-group"><label>Icono</label>
                                    <div style={{display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:'10px', marginTop:'5px'}}>
                                        {Object.keys(ICON_MAP).map(key => (
                                            <div key={key} onClick={()=>setNewCardData({...newCardData, icono:key})} style={{padding:'10px', borderRadius:'8px', cursor:'pointer', textAlign:'center', fontSize:'1.2rem', border: newCardData.icono === key ? `2px solid ${THEME_COLOR}` : '1px solid #e2e8f0', color: newCardData.icono === key ? THEME_COLOR : '#64748b', background: newCardData.icono === key ? '#f0f9ff' : 'transparent'}}>{ICON_MAP[key]}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="modal-footer"><button type="submit" className="btn-primary" style={{backgroundColor: THEME_COLOR}}>Crear</button></div>
                        </form>
                    </div>
                </div>
            )}

            {/* FILE MANAGER */}
            {showFileManager && (
                <div className="modal-overlay"> 
                    <div className="modal-content" style={{width: '95%', maxWidth: '1100px', height: '85vh', padding: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column'}}>
                        <FileManager initialFolderId={currentCategory.id} title={`Agua: ${currentCategory.name}`} onClose={() => setShowFileManager(false)} />
                    </div>
                </div>
            )}
            
            {loadingFolder && <div style={{position:'fixed', inset:0, background:'rgba(255,255,255,0.8)', zIndex:999, display:'flex', alignItems:'center', justifyContent:'center'}}><div className="spin" style={{fontSize:'3rem', color: THEME_COLOR}}>‚óè</div></div>}
        </div>
    );
};

export default HistorialAguaAdmin;


==================================================================
ARCHIVO: frontend\src\pages\admin\HistorialReportes.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { getReportes } from '../../services/reportesService';
import { getACPMs } from '../../services/acpmService';
import ModalVerReporte from '../../components/modals/ModalVerReporte';
import ModalCreateACPM from '../../components/modals/ModalCreateACPM';
import ModalVerACPM from '../../components/modals/ModalVerACPM';

import { 
    FaSearch, FaFilter, FaCheckCircle, FaExclamationTriangle, 
    FaEye, FaTools, FaCheckDouble, FaFileContract, FaClipboardList 
} from 'react-icons/fa';

import '../../styles/Tables.css';
import '../../styles/HistorialReportes.css';

const HistorialReportes = () => {
    const [reportes, setReportes] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');

    // Modales
    const [showViewModal, setShowViewModal] = useState(false);
    const [showCreateACPM, setShowCreateACPM] = useState(false);
    const [showViewACPM, setShowViewACPM] = useState(false);
    
    const [selectedReporte, setSelectedReporte] = useState(null);
    const [acpmData, setAcpmData] = useState(null);

    useEffect(() => {
        fetchReportes();
    }, []);

    const fetchReportes = async () => {
        setLoading(true);
        try {
            const data = await getReportes();
            
            // Verificamos si 'data' es un array antes de usar .filter
            if (Array.isArray(data)) {
                // Filtramos para no mostrar los de limpieza si as√≠ lo deseas, 
                // o lo dejas general. Aqu√≠ lo dejo general pero excluyendo limpieza 
                // si esa era la l√≥gica original, o puedes quitar el filter.
                const reportesGenerales = data.filter(r => 
                    !r.Categoria || !r.Categoria.toLowerCase().includes('limpieza')
                );
                setReportes(reportesGenerales);
            } else {
                console.error("La API no devolvi√≥ una lista:", data);
                setReportes([]); 
            }
            
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo cargar el historial', 'error');
            setReportes([]); 
        } finally {
            setLoading(false);
        }
    };

    // Filtros de b√∫squeda y estado
    const filteredReportes = reportes.filter(item => {
        if (!item) return false;

        const textMatch = 
            (item.Usuario || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (item.Activo || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (item.Formulario || '').toLowerCase().includes(searchTerm.toLowerCase());

        let statusMatch = true;
        if (filterStatus === 'fallas') statusMatch = item.Tiene_Fallas === true;
        if (filterStatus === 'ok') statusMatch = item.Tiene_Fallas === false;
        if (filterStatus === 'pendiente') statusMatch = item.Verificado !== true;

        return textMatch && statusMatch;
    });

    const handleOpenView = (rep) => {
        setSelectedReporte(rep);
        setShowViewModal(true);
    };

    const handleOpenCreateACPM = (rep) => {
        setAcpmData({
            origen: `Reporte #${rep.ID_Reporte}`,
            descripcion: `Hallazgos en el activo ${rep.Activo}: ${rep.Observaciones || 'Sin observaciones'}`,
            idReporte: rep.ID_Reporte
        });
        setShowCreateACPM(true);
    };

    const handleOpenViewACPM = async (idACPM) => {
        try {
            const allACPM = await getACPMs();
            if (Array.isArray(allACPM)) {
                const found = allACPM.find(a => a.ID_ACPM === idACPM);
                if (found) {
                    setAcpmData(found);
                    setShowViewACPM(true);
                }
            }
        } catch (error) {
            console.error(error);
        }
    };

    return (
        <div>
            <div className="page-header">
                <h1 className="page-title">Historial General de Reportes</h1>
                <p style={{color:'#64748b', marginTop:'-5px'}}>Inspecciones Operativas y de Mantenimiento</p>
            </div>

            {/* BARRA DE CONTROL */}
            <div className="control-bar">
                <div className="search-box">
                    <FaSearch />
                    <input 
                        className="search-input"
                        placeholder="Buscar por usuario, activo o formulario..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>

                <div style={{display:'flex', alignItems:'center', gap:'10px'}}>
                    <FaFilter style={{color:'#64748b'}}/>
                    <select className="filter-select" value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                        <option value="todos">Todos los Estados</option>
                        <option value="fallas">Con Hallazgos</option>
                        <option value="ok">Conforme (OK)</option>
                        <option value="pendiente">Pendiente Revisi√≥n</option>
                    </select>
                </div>
            </div>

            {/* TABLA */}
            <div className="table-container">
                <table className="modern-table">
                    <thead>
                        <tr>
                            <th>Fecha / Hora</th>
                            <th>Responsable</th>
                            <th>Detalle Inspecci√≥n</th>
                            <th>Estado</th>
                            <th style={{textAlign:'right'}}>Gesti√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem'}}>Cargando historial...</td></tr>
                        ) : filteredReportes.length === 0 ? (
                            <tr><td colSpan="5" style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>No se encontraron reportes.</td></tr>
                        ) : (
                            filteredReportes.map(rep => (
                                <tr key={rep.ID_Reporte} className="modern-row">
                                    <td className="modern-cell">
                                        {/* --- CORRECCI√ìN DE HORA AQU√ç --- */}
                                        <div className="date-main">
                                            {new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}
                                        </div>
                                        <div className="date-sub">
                                            {new Date(rep.Fecha_Reporte).toLocaleTimeString('es-CO', { timeZone: 'UTC', hour: '2-digit', minute:'2-digit' })}
                                        </div>
                                        {/* ------------------------------- */}
                                    </td>
                                    
                                    <td className="modern-cell">
                                        <div style={{fontWeight:'600', color:'#1e293b'}}>{rep.Usuario}</div>
                                    </td>

                                    <td className="modern-cell">
                                        <div className="asset-name">{rep.Activo}</div>
                                        <div className="form-name"><FaClipboardList size={10} style={{marginRight:'4px'}}/> {rep.Formulario}</div>
                                        {rep.Categoria && <span style={{fontSize:'0.7rem', background:'#f1f5f9', padding:'2px 6px', borderRadius:'4px', color:'#64748b'}}>{rep.Categoria}</span>}
                                    </td>

                                    <td className="modern-cell">
                                        <div style={{display:'flex', flexDirection:'column', gap:'4px'}}>
                                            {rep.Tiene_Fallas ? (
                                                <span className="status-pill danger">
                                                    <FaExclamationTriangle /> Hallazgos
                                                </span>
                                            ) : (
                                                <span className="status-pill success">
                                                    <FaCheckCircle /> Conforme
                                                </span>
                                            )}
                                            
                                            {rep.Verificado && (
                                                <span style={{fontSize:'0.7rem', color:'#10b981', display:'flex', alignItems:'center', gap:'3px', fontWeight:'700'}}>
                                                    <FaCheckDouble /> Verificado
                                                </span>
                                            )}
                                        </div>
                                    </td>

                                    <td className="modern-cell">
                                        <div className="action-group">
                                            <button 
                                                className="btn-text-modern" 
                                                onClick={() => handleOpenView(rep)}
                                                title="Ver Detalle Completo"
                                            >
                                                <FaFileContract /> Ver
                                            </button>

                                            {rep.ID_ACPM ? (
                                                <button 
                                                    className="btn-text-modern btn-acpm-view" 
                                                    onClick={() => handleOpenViewACPM(rep.ID_ACPM)}
                                                    title="Ver Plan de Acci√≥n"
                                                >
                                                    <FaEye /> Plan De Acci√≥n
                                                </button>
                                            ) : rep.Tiene_Fallas ? (
                                                <button 
                                                    className="btn-text-modern btn-acpm-create" 
                                                    onClick={() => handleOpenCreateACPM(rep)}
                                                    title="Crear Plan de Acci√≥n"
                                                >
                                                    <FaTools /> Crear PDA
                                                </button>
                                            ) : null}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* MODALES */}
            <ModalVerReporte 
                isOpen={showViewModal} 
                onClose={() => setShowViewModal(false)} 
                reporte={selectedReporte} 
                onUpdate={fetchReportes} 
            />

            <ModalCreateACPM 
                isOpen={showCreateACPM} 
                onClose={() => setShowCreateACPM(false)} 
                initialData={acpmData} 
                onSuccess={fetchReportes} 
            />

            <ModalVerACPM 
                isOpen={showViewACPM} 
                onClose={() => setShowViewACPM(false)} 
                acpm={acpmData} 
            />
        </div>
    );
};

export default HistorialReportes;


==================================================================
ARCHIVO: frontend\src\pages\admin\Usuarios.jsx
==================================================================
import { useState, useEffect } from 'react';
import Swal from 'sweetalert2';
import { getUsers, toggleUserStatus } from '../../services/userService';
import useAuth from '../../hooks/useAuth'; // <--- IMPORTANTE: Traemos la info del usuario logueado
// Modales
import ModalCreateUser from '../../components/modals/ModalCreateUser';
import ModalEditUser from '../../components/modals/ModalEditUser';
import ModalResetPassword from '../../components/modals/ModalResetPassword';
// Estilos e Iconos
import '../../styles/Tables.css';
import '../../styles/Usuarios.css';
import { FaSearch, FaPlus, FaEdit, FaUserCheck, FaUserSlash, FaKey } from 'react-icons/fa';

const Usuarios = () => {
    const { auth } = useAuth(); // <--- Obtenemos el rol del usuario conectado
    const [users, setUsers] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [filterStatus, setFilterStatus] = useState('todos');

    // Modales
    const [isCreateOpen, setCreateOpen] = useState(false);
    const [isEditOpen, setEditOpen] = useState(false);
    const [isResetOpen, setResetOpen] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);

    useEffect(() => {
        fetchUsers();
    }, []);

    const fetchUsers = async () => {
        setLoading(true);
        try {
            const data = await getUsers();
            setUsers(data);
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudieron cargar los usuarios', 'error');
        } finally {
            setLoading(false);
        }
    };

    // --- FILTRADO INTELIGENTE (TEXTO + ESTADO + PERMISOS DE ROL) ---
    const filteredUsers = users.filter(user => {
        // 1. Filtro por Texto (Buscador)
        const matchesText = 
            user.Nombre_Completo.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.Cedula.includes(searchTerm);
        
        // 2. Filtro por Estado (Select)
        const matchesStatus = 
            filterStatus === 'todos' ? true :
            filterStatus === 'activo' ? user.Estado === true :
            user.Estado === false;

        // 3. FILTRO DE SEGURIDAD POR ROL (LO QUE PEDISTE)
        let matchesRolePermission = true;
        
        if (auth.user?.rol === 'AdminCalidad') {
            // Si soy AdminCalidad, SOLO puedo ver a los 'Colaborador'
            // Ocultamos a otros AdminCalidad y al SuperAdmin
            matchesRolePermission = user.Rol === 'Colaborador';
        }
        // Si soy SuperAdmin, matchesRolePermission se queda en true (veo todo)

        return matchesText && matchesStatus && matchesRolePermission;
    });

    const handleToggleStatus = async (user) => {
        Swal.fire({
            title: user.Estado ? '¬øInactivar Usuario?' : '¬øReactivar Usuario?',
            text: `Vas a cambiar el estado de acceso para "${user.Nombre_Completo}".`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: user.Estado ? '#ef4444' : '#10b981',
            cancelButtonColor: '#6b7280',
            confirmButtonText: user.Estado ? 'S√≠, inactivar' : 'S√≠, activar',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await toggleUserStatus(user.ID_Usuario, !user.Estado);
                    
                    Swal.fire(
                        '¬°Actualizado!',
                        `El usuario ha sido ${user.Estado ? 'inactivado' : 'activado'} correctamente.`,
                        'success'
                    );
                    fetchUsers();
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        });
    };

    const handleOpenEdit = (user) => {
        setSelectedUser(user);
        setEditOpen(true);
    };

    const handleOpenReset = (user) => {
        setSelectedUser(user);
        setResetOpen(true);
    };

    return (
        <div>
            {/* CABECERA */}
            <div className="page-header">
                <h1 className="page-title">Gesti√≥n de Usuarios</h1>
                <button className="btn-new-user" onClick={() => setCreateOpen(true)}>
                    <FaPlus /> Nuevo Usuario
                </button>
            </div>

            {/* FILTROS */}
            <div className="filters-bar">
                <div className="search-input-container">
                    <FaSearch />
                    <input 
                        type="text" 
                        placeholder="Buscar por nombre o c√©dula..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="filter-select-container">
                    <select value={filterStatus} onChange={e => setFilterStatus(e.target.value)}>
                        <option value="todos">Todos los Estados</option>
                        <option value="activo">Solo Activos</option>
                        <option value="inactivo">Solo Inactivos</option>
                    </select>
                </div>
            </div>

            {/* TABLA */}
            <div className="table-container">
                <table className="data-table">
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>C√©dula</th>
                            <th>Rol</th>
                            <th>√Årea / Cargo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {loading ? (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem'}}>Cargando...</td></tr>
                        ) : filteredUsers.length === 0 ? (
                            <tr><td colSpan="6" style={{textAlign:'center', padding:'2rem', color: '#94a3b8'}}>No se encontraron usuarios.</td></tr>
                        ) : (
                            filteredUsers.map(user => (
                                <tr key={user.ID_Usuario}>
                                    <td style={{fontWeight:'500'}}>{user.Nombre_Completo}</td>
                                    <td>{user.Cedula}</td>
                                    <td>
                                        <span style={{
                                            color: user.Rol === 'SuperAdmin' ? '#7c3aed' : 
                                                   user.Rol === 'AdminCalidad' ? '#0c4760' : '#475569',
                                            fontWeight:'700', 
                                            fontSize:'0.8rem',
                                            background: user.Rol === 'SuperAdmin' ? '#f3e8ff' : 
                                                        user.Rol === 'AdminCalidad' ? '#e0f2fe' : '#f1f5f9',
                                            padding: '2px 8px',
                                            borderRadius: '10px'
                                        }}>
                                            {user.Rol}
                                        </span>
                                    </td>
                                    <td>
                                        <div style={{fontSize:'0.85rem', lineHeight:'1.4'}}>
                                            <div>{user.Area || '-'}</div>
                                            <div style={{color:'#6b7280'}}>{user.Cargo || '-'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span className={`badge ${user.Estado ? 'badge-success' : 'badge-danger'}`}>
                                            {user.Estado ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div className="action-buttons">
                                            <button className="btn-action btn-edit" onClick={() => handleOpenEdit(user)} title="Editar">
                                                <FaEdit />
                                            </button>
                                            
                                            {/* El bot√≥n de estado es delicado, agregamos seguridad visual */}
                                            <button 
                                                className={`btn-action ${user.Estado ? 'btn-toggle-off' : 'btn-toggle-on'}`}
                                                onClick={() => handleToggleStatus(user)}
                                                title={user.Estado ? "Inactivar" : "Activar"}
                                            >
                                                {user.Estado ? <FaUserSlash/> : <FaUserCheck/>}
                                            </button>
                                            
                                            <button className="btn-action btn-reset" onClick={() => handleOpenReset(user)} title="Reset Password">
                                                <FaKey />
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            {/* MODALES */}
            <ModalCreateUser isOpen={isCreateOpen} onClose={() => setCreateOpen(false)} onSuccess={fetchUsers} />
            <ModalEditUser isOpen={isEditOpen} onClose={() => setEditOpen(false)} user={selectedUser} onSuccess={fetchUsers} />
            <ModalResetPassword isOpen={isResetOpen} onClose={() => setResetOpen(false)} user={selectedUser} />
        </div>
    );
};

export default Usuarios;


==================================================================
ARCHIVO: frontend\src\pages\colaborador\AguaPotable.jsx
==================================================================
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Swal from 'sweetalert2'; // <--- IMPORTANTE: Importamos SweetAlert2
import { registrarAgua, getHistorialAgua } from '../../services/specializedService';
import '../../styles/Dashboard.css';
import { FaTint, FaCamera, FaSave, FaCheckCircle, FaArrowLeft, FaPen, FaSync } from 'react-icons/fa';

const AguaPotable = () => {
    const navigate = useNavigate();
    
    // Lista base por defecto
    const DEFAULT_PUNTOS = [
        "Grifo Entrada Principal",
        "Filtro Planta Producci√≥n",
        "Ba√±os Administrativos",
        "Comedor"
    ];

    // Estados
    const [puntosDisponibles, setPuntosDisponibles] = useState(DEFAULT_PUNTOS);
    const [form, setForm] = useState({ puntoToma: '', cloro: '', ph: '' });
    const [isCustom, setIsCustom] = useState(false);
    const [foto, setFoto] = useState(null);
    const [preview, setPreview] = useState(null);
    const [loading, setLoading] = useState(false);
    const [success, setSuccess] = useState(false);

    // 1. Cargar historial
    useEffect(() => {
        cargarPuntosHistoricos();
    }, []);

    const cargarPuntosHistoricos = async () => {
        try {
            const historial = await getHistorialAgua();
            const puntosUsados = historial.map(item => item.Punto_Toma);
            const listaCombinada = [...new Set([...DEFAULT_PUNTOS, ...puntosUsados])];
            setPuntosDisponibles(listaCombinada);
        } catch (error) {
            console.error("No se pudo cargar el historial de puntos", error);
        }
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            setFoto(file);
            setPreview(URL.createObjectURL(file));
        }
    };

    const handleSelectChange = (e) => {
        const valor = e.target.value;
        if (valor === 'Otro') {
            setIsCustom(true);
            setForm({ ...form, puntoToma: '' });
        } else {
            setIsCustom(false);
            setForm({ ...form, puntoToma: valor });
        }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // --- VALIDACI√ìN CON SWEETALERT ---
        if (!form.puntoToma.trim()) {
            return Swal.fire({
                icon: 'warning',
                title: 'Falta Informaci√≥n',
                text: 'Por favor indique el Punto de Toma.',
                confirmButtonColor: '#0ea5e9'
            });
        }
        if (!foto) {
            return Swal.fire({
                icon: 'warning',
                title: 'Evidencia Requerida',
                text: 'La foto de evidencia es obligatoria.',
                confirmButtonColor: '#0ea5e9'
            });
        }
        
        setLoading(true);
        try {
            const datosMedicion = `Cloro: ${form.cloro} ppm | pH: ${form.ph}`;
            await registrarAgua(form.puntoToma, datosMedicion, foto);
            
            setSuccess(true);
            
            // Actualizar la lista localmente
            if (!puntosDisponibles.includes(form.puntoToma)) {
                setPuntosDisponibles(prev => [...prev, form.puntoToma]);
            }

            // Resetear formulario
            setForm({ puntoToma: '', cloro: '', ph: '' });
            setIsCustom(false);
            setFoto(null);
            setPreview(null);
            
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                confirmButtonColor: '#d33'
            });
        } finally {
            setLoading(false);
        }
    };

    if (success) {
        return (
            <div style={{textAlign:'center', padding:'3rem', background:'white', borderRadius:'8px', boxShadow:'0 4px 6px rgba(0,0,0,0.1)', maxWidth:'500px', margin:'2rem auto'}}>
                <FaCheckCircle style={{fontSize:'4rem', color:'#10b981', marginBottom:'1rem'}} />
                <h2>¬°Registro Guardado!</h2>
                <p style={{color:'#64748b', marginBottom:'2rem'}}>Verificaci√≥n de agua registrada exitosamente.</p>
                <div style={{display:'flex', gap:'10px', justifyContent:'center'}}>
                    <button className="btn-primary" onClick={() => setSuccess(false)}>Nueva Toma</button>
                    <button className="btn-primary" style={{background:'#64748b'}} onClick={() => navigate('/colaborador/reportes')}>Salir</button>
                </div>
            </div>
        );
    }

    return (
        <div style={{maxWidth:'600px', margin:'0 auto', padding:'20px'}}>
            <button onClick={() => navigate(-1)} style={{background:'none', border:'none', display:'flex', alignItems:'center', gap:'5px', color:'#64748b', cursor:'pointer', marginBottom:'1rem', fontWeight:'600'}}>
                <FaArrowLeft /> Volver
            </button>

            <div className="page-header">
                <h1 className="page-title" style={{display:'flex', alignItems:'center', gap:'10px', fontSize:'1.5rem'}}>
                    <FaTint style={{color:'#0ea5e9'}}/> Verificaci√≥n Agua Potable
                </h1>
            </div>

            <div className="card">
                <form onSubmit={handleSubmit}>
                    
                    {/* SECCI√ìN PUNTO DE TOMA */}
                    <div className="form-group">
                        <label>Punto de Toma</label>
                        
                        <select 
                            style={{width:'100%', padding:'0.8rem', border:'1px solid #ddd', borderRadius:'6px', marginBottom: isCustom ? '10px' : '0'}}
                            value={isCustom ? 'Otro' : form.puntoToma}
                            onChange={handleSelectChange}
                            required
                        >
                            <option value="">Seleccione...</option>
                            {puntosDisponibles.map((punto, index) => (
                                <option key={index} value={punto}>{punto}</option>
                            ))}
                            <option value="Otro" style={{fontWeight:'bold', color:'#0ea5e9'}}>+ Otro (Nuevo Punto)</option>
                        </select>

                        {isCustom && (
                            <div style={{position:'relative', animation: 'fadeIn 0.3s ease'}}>
                                <FaPen style={{position:'absolute', top:'12px', left:'12px', color:'#94a3b8', fontSize:'0.8rem'}}/>
                                <input 
                                    type="text" 
                                    placeholder="Escriba el nombre del nuevo punto..." 
                                    value={form.puntoToma}
                                    onChange={e => setForm({...form, puntoToma: e.target.value})}
                                    required
                                    style={{width:'100%', padding:'0.8rem 0.8rem 0.8rem 2.2rem', border:'1px solid #0ea5e9', borderRadius:'6px', background:'#f0f9ff'}}
                                    autoFocus
                                />
                                <small style={{color:'#64748b', marginTop:'5px', display:'block', fontSize:'0.8rem'}}>
                                    * Este punto se guardar√° en la lista para futuros registros.
                                </small>
                            </div>
                        )}
                    </div>

                    <div style={{display:'flex', gap:'1rem', marginTop:'1rem'}}>
                        <div className="form-group" style={{flex:1}}>
                            <label>Cloro (ppm)</label>
                            <input type="number" step="0.1" placeholder="Ej: 1.5" value={form.cloro} onChange={e => setForm({...form, cloro: e.target.value})} required style={{width:'100%', padding:'0.8rem', border:'1px solid #ddd', borderRadius:'6px'}} />
                        </div>
                        <div className="form-group" style={{flex:1}}>
                            <label>pH</label>
                            <input type="number" step="0.1" placeholder="Ej: 7.2" value={form.ph} onChange={e => setForm({...form, ph: e.target.value})} required style={{width:'100%', padding:'0.8rem', border:'1px solid #ddd', borderRadius:'6px'}} />
                        </div>
                    </div>

                    <div className="form-group" style={{marginTop:'1.5rem'}}>
                        <label>Evidencia Fotogr√°fica (Obligatorio)</label>
                        <div style={{border:'2px dashed #cbd5e1', padding:'1.5rem', borderRadius:'6px', textAlign:'center', cursor:'pointer', position:'relative', background: '#f8fafc'}}>
                            <input type="file" accept="image/*" onChange={handleFileChange} style={{position:'absolute', top:0, left:0, width:'100%', height:'100%', opacity:0, cursor:'pointer'}} required={!foto} />
                            {!preview ? (
                                <div><FaCamera style={{fontSize:'2rem', color:'#94a3b8', marginBottom:'0.5rem'}}/><p style={{margin:0, color:'var(--color-primary)', fontWeight:'500'}}>Toque para tomar foto</p></div>
                            ) : (
                                <div style={{position:'relative'}}><img src={preview} alt="Evidencia" style={{maxHeight:'200px', maxWidth:'100%', borderRadius:'4px'}} /><p style={{marginTop:'0.5rem', fontSize:'0.8rem', color:'#10b981'}}>Imagen cargada correctamente</p></div>
                            )}
                        </div>
                    </div>

                    <button type="submit" className="btn-primary" style={{width:'100%', marginTop:'2rem', padding:'1rem', fontSize:'1.1rem', display:'flex', justifyContent:'center', gap:'10px'}} disabled={loading}>
                        {loading ? <><FaSync className="spin"/> Guardando...</> : <><FaSave /> Guardar Registro</>}
                    </button>
                </form>
            </div>
        </div>
    );
};

export default AguaPotable;


==================================================================
ARCHIVO: frontend\src\pages\colaborador\FichasTecnicas.jsx
==================================================================
import { useState, useEffect } from 'react';
import { getFichasTecnicas } from '../../services/trazabilidadService';
// Importamos las utilidades de seguridad
import { apiFetchBlob, extractFilename } from '../../services/api';
import { FaSearch, FaFilePdf, FaFileImage, FaDownload, FaBoxOpen, FaEye, FaArrowLeft, FaFileAlt, FaFileExcel } from 'react-icons/fa';
import { useNavigate } from 'react-router-dom';
import Swal from 'sweetalert2';
import '../../styles/Tables.css'; 

const FichasTecnicas = () => {
    const navigate = useNavigate();
    const [fichas, setFichas] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filtro, setFiltro] = useState('');
    
    // Estados de carga individuales
    const [downloadingId, setDownloadingId] = useState(null);
    const [viewingId, setViewingId] = useState(null);

    useEffect(() => {
        cargarDatos();
    }, []);

    const cargarDatos = async () => {
        try {
            const data = await getFichasTecnicas();
            setFichas(data);
        } catch (error) { console.error(error); } 
        finally { setLoading(false); }
    };

    // --- L√ìGICA DE DESCARGA SEGURA ---
    const handleDirectDownload = async (urlOriginal, nombre, id) => {
        if (!urlOriginal) return;
        setDownloadingId(id);
        try {
            const filename = extractFilename(urlOriginal);
            // Usamos la ruta de streaming de Trazabilidad
            const blob = await apiFetchBlob(`/trazabilidad/ficha/${filename}`);
            
            // Crear link de descarga
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = nombre || filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

        } catch (error) {
            console.error("Error en descarga:", error);
            Swal.fire('Error', 'No se pudo descargar el archivo.', 'error');
        } finally {
            setDownloadingId(null);
        }
    };

    // --- L√ìGICA DE VISUALIZACI√ìN SEGURA ---
    const handleView = async (urlOriginal, id) => {
        if (!urlOriginal) return;
        setViewingId(id);
        try {
            const filename = extractFilename(urlOriginal);
            // Usamos la misma ruta de streaming
            const blob = await apiFetchBlob(`/trazabilidad/ficha/${filename}`);
            const url = window.URL.createObjectURL(blob);
            window.open(url, '_blank');
        } catch (error) {
            console.error("Error al visualizar:", error);
            // Fallback para urls antiguas http
            if (urlOriginal.startsWith('http')) {
                window.open(urlOriginal, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo abrir el documento.', 'error');
            }
        } finally {
            setViewingId(null);
        }
    };

    const getIcono = (tipo) => {
        if(tipo === 'Imagen') return <FaFileImage size={28} color="#8b5cf6"/>;
        if(tipo === 'Excel') return <FaFileExcel size={28} color="#10b981"/>;
        if(tipo === 'Word') return <FaFileAlt size={28} color="#3b82f6"/>;
        return <FaFilePdf size={28} color="#ef4444"/>; // Por defecto PDF
    };

    const filtered = fichas.filter(f => f.Nombre.toLowerCase().includes(filtro.toLowerCase()));

    return (
        <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '20px' }}>
            {/* Header con bot√≥n volver */}
            <div style={{ marginBottom: '20px' }}>
                <button onClick={() => navigate('/colaborador/reportes')} style={{ background: 'none', border: 'none', color: '#64748b', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '5px', fontWeight: '600', marginBottom: '10px' }}>
                    <FaArrowLeft /> Volver al Inicio
                </button>
                <h1 className="page-title" style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                    <FaBoxOpen style={{ color: '#8b5cf6' }} /> Fichas T√©cnicas
                </h1>
                <p style={{ color: '#64748b' }}>Consulta y descarga de especificaciones de producto.</p>
            </div>

            {/* Buscador Grande */}
            <div style={{ background: 'white', padding: '1.5rem', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.05)', marginBottom: '2rem', display: 'flex', alignItems: 'center', border: '1px solid #e2e8f0' }}>
                <FaSearch style={{ color: '#94a3b8', fontSize: '1.2rem', marginRight: '15px' }} />
                <input 
                    type="text" 
                    placeholder="Buscar ficha por nombre..." 
                    style={{ border: 'none', outline: 'none', fontSize: '1.1rem', flex: 1, color: '#334155' }}
                    value={filtro}
                    onChange={e => setFiltro(e.target.value)}
                    autoFocus
                />
            </div>

            {/* Grid de Fichas */}
            {loading ? <p style={{ textAlign: 'center' }}>Cargando documentos...</p> : 
             filtered.length === 0 ? 
             <div style={{ textAlign: 'center', padding: '3rem', color: '#94a3b8', border: '2px dashed #e2e8f0', borderRadius: '12px' }}>
                 No se encontraron fichas t√©cnicas con ese nombre.
             </div> :
             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '20px' }}>
                {filtered.map(ficha => (
                    <div key={ficha.ID_Doc} style={{ background: 'white', borderRadius: '12px', overflow: 'hidden', border: '1px solid #e2e8f0', boxShadow: '0 2px 4px rgba(0,0,0,0.02)', transition: 'transform 0.2s', display: 'flex', flexDirection: 'column' }}
                         onMouseEnter={e => e.currentTarget.style.transform = 'translateY(-3px)'}
                         onMouseLeave={e => e.currentTarget.style.transform = 'translateY(0)'}
                    >
                        {/* Cabecera Tipo Archivo */}
                        <div style={{ height: '6px', background: ficha.Tipo_Origen === 'Imagen' ? '#8b5cf6' : '#ef4444' }}></div>
                        
                        <div style={{ padding: '1.5rem', flex: 1 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                                {getIcono(ficha.Tipo_Origen)}
                                <span style={{ fontSize: '0.75rem', background: '#f1f5f9', padding: '2px 8px', borderRadius: '10px', color: '#64748b' }}>
                                    {new Date(ficha.Fecha_Creacion).toLocaleDateString()}
                                </span>
                            </div>
                            <h3 style={{ margin: '0 0 5px 0', color: '#1e293b', fontSize: '1.1rem' }}>{ficha.Nombre}</h3>
                            <p style={{ fontSize: '0.85rem', color: '#64748b', margin: 0 }}>{ficha.Descripcion || 'Documento Oficial'}</p>
                        </div>

                        {/* Botones Acci√≥n */}
                        <div style={{ background: '#f8fafc', padding: '10px 1.5rem', borderTop: '1px solid #f1f5f9', display: 'flex', gap: '10px' }}>
                            {/* BOT√ìN VISUALIZAR SEGURA */}
                            <button 
                                onClick={() => handleView(ficha.Url_Archivo, ficha.ID_Doc)}
                                disabled={viewingId === ficha.ID_Doc}
                                style={{ flex: 1, textAlign: 'center', padding: '8px', borderRadius: '6px', background: 'white', border: '1px solid #e2e8f0', color: '#334155', fontSize: '0.9rem', fontWeight: '600', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '5px', cursor: 'pointer' }}
                            >
                                {viewingId === ficha.ID_Doc ? 'Cargando...' : <><FaEye /> Visualizar</>}
                            </button>

                            {/* BOT√ìN DESCARGAR SEGURA */}
                            <button 
                                onClick={() => handleDirectDownload(ficha.Url_Archivo, ficha.Nombre, ficha.ID_Doc)}
                                disabled={downloadingId === ficha.ID_Doc}
                                style={{ 
                                    flex: 1, 
                                    textAlign: 'center', 
                                    padding: '8px', 
                                    borderRadius: '6px', 
                                    background: '#0c4760', 
                                    border: '1px solid #0c4760', 
                                    color: 'white', 
                                    fontSize: '0.9rem', 
                                    fontWeight: '600', 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'center', 
                                    gap: '5px',
                                    cursor: downloadingId === ficha.ID_Doc ? 'wait' : 'pointer',
                                    opacity: downloadingId === ficha.ID_Doc ? 0.7 : 1
                                }}
                            >
                                {downloadingId === ficha.ID_Doc ? '...' : <><FaDownload /> Descargar</>}
                            </button>
                        </div>
                    </div>
                ))}
             </div>
            }
        </div>
    );
};

export default FichasTecnicas;


==================================================================
ARCHIVO: frontend\src\pages\colaborador\Reportes.jsx
==================================================================
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import useAuth from '../../hooks/useAuth';

// Servicios
import { getActivos, getFormsByActivo, getPreguntas } from '../../services/coreService';
import { createReporte, getReportes } from '../../services/reportesService'; 
import { getHistorialAgua } from '../../services/specializedService'; 

import Swal from 'sweetalert2';
import '../../styles/Reportes.css';
import { 
    FaIndustry, FaClipboardList, FaCheck, FaTimes, FaArrowLeft, 
    FaCheckCircle, FaCamera, FaHistory, FaPlusCircle, FaTint, FaBoxOpen,
    FaFileAlt, FaPaperclip, FaSearch, FaFilter
} from 'react-icons/fa';

const Reportes = () => {
    const { auth } = useAuth();
    const navigate = useNavigate();
    
    // Estados de Vista
    const [viewMode, setViewMode] = useState('dashboard');
    const [step, setStep] = useState(1);
    const [activeTab, setActiveTab] = useState('reportes');

    // Datos
    const [activos, setActivos] = useState([]);
    const [forms, setForms] = useState([]);
    const [preguntas, setPreguntas] = useState([]);
    
    // Estado para b√∫squeda
    const [searchTerm, setSearchTerm] = useState('');
    
    // Historiales
    const [misReportes, setMisReportes] = useState([]);
    const [misRegistrosAgua, setMisRegistrosAgua] = useState([]);

    // Selecciones del Wizard
    const [selectedActivo, setSelectedActivo] = useState(null);
    const [selectedForm, setSelectedForm] = useState(null);
    const [respuestas, setRespuestas] = useState({});
    const [observaciones, setObservaciones] = useState('');
    const [evidenciaFile, setEvidenciaFile] = useState(null);
    const [previewUrl, setPreviewUrl] = useState(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        loadData();
    }, []);

    const loadData = async () => {
        try {
            const dataActivos = await getActivos();
            setActivos(dataActivos.filter(a => a.Estado));

            if (auth.user && auth.user.nombre) {
                const allReportes = await getReportes();
                setMisReportes(allReportes.filter(r => r.Usuario === auth.user.nombre));
                
                const dataAgua = await getHistorialAgua();
                setMisRegistrosAgua(dataAgua);
            }
        } catch (error) { console.error(error); }
    };

    const startNewReport = () => {
        setStep(1);
        setViewMode('wizard');
        resetForm();
    };

    const backToDashboard = () => {
        setViewMode('dashboard');
        resetForm();
        loadData();
    };

    const resetForm = () => {
        setSelectedActivo(null);
        setSelectedForm(null);
        setRespuestas({});
        setObservaciones('');
        setEvidenciaFile(null);
        setPreviewUrl(null);
        setSearchTerm(''); 
    };

    // --- FILTRADO DE ACTIVOS ---
    const filteredActivos = activos.filter(act => 
        act.Nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (act.Codigo && act.Codigo.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    // --- WIZARD LOGIC ---
    const handleSelectActivo = async (activo) => {
        setSelectedActivo(activo);
        try {
            const data = await getFormsByActivo(activo.ID_Activo);
            if (!data || data.length === 0) {
                Swal.fire('Atenci√≥n', 'Este activo no tiene formularios asignados.', 'info');
                return;
            }
            setForms(data);
            setStep(2);
        } catch (error) { console.error(error); }
    };

    const handleSelectForm = async (form) => {
        setSelectedForm(form);
        try {
            const data = await getPreguntas(form.ID_Formulario);
            setPreguntas(data);
            setStep(3);
        } catch (error) { console.error(error); }
    };

    const handleAnswer = (id, val) => {
        setRespuestas(prev => ({...prev, [id]: val}));
    };

    const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
            setEvidenciaFile(file);
            setPreviewUrl(URL.createObjectURL(file));
        }
    };

    // --- AQU√ç EST√Å LA L√ìGICA MODIFICADA ---
    const handleSubmit = async () => {
        // 1. Validaci√≥n: ¬øEst√°n todas respondidas?
        const faltantes = preguntas.some(p => {
            const val = respuestas[p.ID_Pregunta];
            if (p.Tipo === 'TEXT') return !val || val.trim() === '';
            return val === null || val === undefined;
        });

        if (faltantes) return Swal.fire('Faltan respuestas', 'Complete todos los campos del formulario.', 'warning');
        
        // 2. Validaci√≥n NUEVA: Si hay fallos (NO), observaci√≥n obligatoria
        // Buscamos si alguna respuesta booleana es 'false' (NO)
        const hayFallos = preguntas.some(p => p.Tipo !== 'TEXT' && respuestas[p.ID_Pregunta] === false);

        if (hayFallos && (!observaciones || observaciones.trim().length < 5)) {
            return Swal.fire(
                'Observaci√≥n Requerida', 
                'Ha marcado √≠tems con "NO". Debe justificar los hallazgos en el campo de observaciones.', 
                'warning'
            );
        }

        setLoading(true);
        const formData = new FormData();
        formData.append('idActivo', selectedActivo.ID_Activo);
        formData.append('idFormulario', selectedForm.ID_Formulario);
        formData.append('observaciones', observaciones);
        
        const arrayResp = Object.keys(respuestas).map(k => {
            const idPreg = parseInt(k);
            const pregData = preguntas.find(p => p.ID_Pregunta === idPreg);
            const valor = respuestas[k];
            const tipoSeguro = pregData.Tipo || 'BOOL';

            return { 
                idPregunta: idPreg, 
                tipo: tipoSeguro, 
                cumple: tipoSeguro === 'TEXT' ? true : valor, 
                respuestaTexto: tipoSeguro === 'TEXT' ? valor : null
            };
        });

        formData.append('respuestas', JSON.stringify(arrayResp));
        if (evidenciaFile) formData.append('evidencia', evidenciaFile);

        try {
            await createReporte(formData);
            setStep(4);
        } catch (error) { Swal.fire('Error', error.message, 'error'); } 
        finally { setLoading(false); }
    };

    // --- RENDER DASHBOARD ---
    if (viewMode === 'dashboard') {
        return (
            <div className="colaborador-dashboard">
                <div className="welcome-banner">
                    <h1>Hola, {auth.user?.nombre?.split(' ')[0]}</h1>
                    <p>¬øQu√© actividad realizaremos hoy?</p>
                </div>

                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginBottom: '3rem'}}>
                    <button className="btn-big-action" onClick={startNewReport} style={{background: 'linear-gradient(135deg, #0c4760, #155e75)'}}>
                        <div className="icon-circle"><FaPlusCircle /></div><span>Inspecci√≥n / Reporte</span>
                    </button>
                    <button className="btn-big-action" onClick={() => navigate('/colaborador/agua')} style={{background: 'linear-gradient(135deg, #0284c7, #06b6d4)'}}>
                        <div className="icon-circle"><FaTint /></div><span>Calidad de Agua</span>
                    </button>
                    <button className="btn-big-action" onClick={() => navigate('/colaborador/fichas')} style={{background: 'linear-gradient(135deg, #ea580c, #fb923c)'}}>
                        <div className="icon-circle"><FaBoxOpen /></div><span>Fichas T√©cnicas</span>
                    </button>
                </div>

                <div className="history-section">
                    <div className="section-header" style={{borderBottom:'1px solid #e2e8f0', paddingBottom:'10px', marginBottom:'15px'}}>
                        <h3 style={{margin:0, display:'flex', alignItems:'center', gap:'10px'}}><FaHistory /> Historial Reciente</h3>
                    </div>
                    <div style={{display:'flex', gap:'10px', marginBottom:'15px'}}>
                        <button onClick={() => setActiveTab('reportes')} style={{padding:'8px 16px', borderRadius:'20px', border:'none', cursor:'pointer', fontWeight:'600', background: activeTab === 'reportes' ? '#0c4760' : '#e2e8f0', color: activeTab === 'reportes' ? 'white' : '#64748b'}}><FaClipboardList style={{marginRight:'5px'}}/> Inspecciones</button>
                        <button onClick={() => setActiveTab('agua')} style={{padding:'8px 16px', borderRadius:'20px', border:'none', cursor:'pointer', fontWeight:'600', background: activeTab === 'agua' ? '#0284c7' : '#e2e8f0', color: activeTab === 'agua' ? 'white' : '#64748b'}}><FaTint style={{marginRight:'5px'}}/> Calidad de Agua</button>
                    </div>

                    <div className="table-container-clean">
                        <table className="clean-table">
                            <thead>
                                {activeTab === 'reportes' ? (<tr><th>Fecha</th><th>Activo</th><th>Formulario</th><th>Estado</th></tr>) : (<tr><th>Fecha</th><th>Punto Toma</th><th>Medici√≥n</th><th>Evidencia</th></tr>)}
                            </thead>
                            <tbody>
                                {activeTab === 'reportes' ? (
                                    misReportes.length === 0 ? <tr><td colSpan="4" className="empty-row">Sin inspecciones recientes.</td></tr> :
                                    misReportes.slice(0, 5).map(rep => (
                                        <tr key={rep.ID_Reporte}>
                                            <td>{new Date(rep.Fecha_Reporte).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</td>
                                            <td><strong>{rep.Activo}</strong></td>
                                            <td>{rep.Formulario}</td>
                                            <td>{rep.Tiene_Fallas ? <span className="tag tag-fail">Hallazgos</span> : <span className="tag tag-success">Conforme</span>}</td>
                                        </tr>
                                    ))
                                ) : (
                                    misRegistrosAgua.length === 0 ? <tr><td colSpan="4" className="empty-row">Sin registros de agua recientes.</td></tr> :
                                    misRegistrosAgua.slice(0, 5).map(reg => (
                                        <tr key={reg.ID_Registro}>
                                            <td>{new Date(reg.Fecha).toLocaleDateString('es-CO', { timeZone: 'UTC' })}</td>
                                            <td><strong>{reg.Punto_Toma}</strong></td>
                                            <td style={{fontSize:'0.85rem', color:'#475569'}}>{reg.Datos_Medicion}</td>
                                            <td><a href={reg.Url_Foto_Evidencia} target="_blank" rel="noopener noreferrer" style={{color:'#0ea5e9', fontWeight:'bold', textDecoration:'none'}}>Ver Foto</a></td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );
    }

    // --- RENDER WIZARD ---
    return (
        <div className="wizard-container">
            <div className="wizard-header">
                <button className="btn-back" onClick={step === 1 ? backToDashboard : () => setStep(step - 1)}>
                    <FaArrowLeft /> {step === 1 ? 'Cancelar' : 'Atr√°s'}
                </button>
                <div className="step-indicator">Paso {step} de 3</div>
            </div>
            <div className="wizard-body">
                
                {/* PASO 1: SELECCIONAR ACTIVO (CON BUSCADOR) */}
                {step === 1 && (
                    <div className="step-content">
                        <h2>Selecciona el √Årea o Equipo</h2>
                        
                        {/* --- BARRA DE B√öSQUEDA --- */}
                        <div style={{
                            position: 'relative', 
                            marginBottom: '20px', 
                            maxWidth: '100%',
                            boxShadow: '0 4px 6px -1px rgba(0,0,0,0.05)',
                            borderRadius: '50px'
                        }}>
                            <FaSearch style={{
                                position: 'absolute', 
                                left: '20px', 
                                top: '50%', 
                                transform: 'translateY(-50%)', 
                                color: '#94a3b8'
                            }} />
                            <input 
                                type="text" 
                                placeholder="Buscar por nombre o c√≥digo..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                autoFocus
                                style={{
                                    width: '100%',
                                    padding: '12px 15px 12px 50px',
                                    borderRadius: '50px',
                                    border: '1px solid #e2e8f0',
                                    fontSize: '1rem',
                                    outline: 'none',
                                    transition: 'all 0.2s',
                                    backgroundColor: 'white'
                                }}
                                onFocus={(e) => e.target.style.borderColor = '#0c4760'}
                                onBlur={(e) => e.target.style.borderColor = '#e2e8f0'}
                            />
                        </div>

                        {/* LISTA DE ACTIVOS FILTRADA */}
                        <div className="grid-pro">
                            {filteredActivos.length === 0 ? (
                                <div style={{gridColumn:'1/-1', textAlign:'center', padding:'40px', color:'#94a3b8'}}>
                                    <FaFilter size={40} style={{marginBottom:'10px', opacity:0.5}}/>
                                    <p>No se encontraron activos que coincidan.</p>
                                </div>
                            ) : (
                                filteredActivos.map(act => (
                                    <div key={act.ID_Activo} className="card-pro" onClick={() => handleSelectActivo(act)}>
                                        <div className="card-icon"><FaIndustry /></div>
                                        <div className="card-info">
                                            <h3>{act.Nombre}</h3>
                                            <span>{act.Codigo || act.Tipo}</span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                )}

                {step === 2 && (
                    <div className="step-content">
                        <h2>Formularios Disponibles</h2>
                        <div className="grid-pro">
                            {forms.map(form => (
                                <div key={form.ID_Formulario} className="card-pro" onClick={() => handleSelectForm(form)}>
                                    <div className="card-icon"><FaClipboardList /></div>
                                    <div className="card-info"><h3>{form.Titulo}</h3><span>{form.Codigo}</span></div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {step === 3 && (
                    <div className="step-content form-view">
                        <div className="form-header-pro">
                            <h2>{selectedForm.Titulo}</h2>
                            <span className="badge-pro">{selectedForm.Codigo}</span>
                        </div>
                        
                        <div className="questions-list-pro">
                            {preguntas.map((p, idx) => (
                                <div key={p.ID_Pregunta} className="question-row-pro">
                                    <div className="q-number">{idx + 1}</div>
                                    <div className="q-content" style={{flex:1, width:'100%'}}>
                                        <div className="q-text" style={{marginBottom:'8px'}}>{p.Texto_Pregunta}</div>
                                        
                                        {/* RENDERIZADO CONDICIONAL: TEXTO vs BOOLEANO */}
                                        {p.Tipo === 'TEXT' ? (
                                            <input 
                                                type="text"
                                                placeholder="Escriba aqu√≠ el detalle (Ej: √Årea norte, Serial 123)..."
                                                className="input-observaciones"
                                                style={{
                                                    marginTop:0, 
                                                    borderColor: respuestas[p.ID_Pregunta] ? '#10b981' : '#cbd5e1',
                                                    background: '#f8fafc'
                                                }}
                                                value={respuestas[p.ID_Pregunta] || ''}
                                                onChange={(e) => handleAnswer(p.ID_Pregunta, e.target.value)} 
                                            />
                                        ) : (
                                            <div className="q-actions">
                                                <button 
                                                    className={`btn-option pass ${respuestas[p.ID_Pregunta] === true ? 'selected' : ''}`} 
                                                    onClick={() => handleAnswer(p.ID_Pregunta, true)}
                                                >
                                                    <FaCheck /> S√ç
                                                </button>
                                                <button 
                                                    className={`btn-option fail ${respuestas[p.ID_Pregunta] === false ? 'selected' : ''}`} 
                                                    onClick={() => handleAnswer(p.ID_Pregunta, false)}
                                                >
                                                    <FaTimes /> NO
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* SECCI√ìN EVIDENCIA Y OBSERVACIONES */}
                        <div className="evidence-section-pro">
                            <label style={{display:'flex', alignItems:'center', gap:'8px', marginBottom:'10px', fontWeight:'600'}}>
                                <FaCamera /> Evidencia y Observaciones
                            </label>
                            
                            <div className="file-input-wrapper">
                                <input 
                                    type="file" 
                                    accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" 
                                    onChange={handleFileChange} 
                                />
                                <div className="file-custom-label">
                                    <FaPaperclip style={{marginRight:'8px'}}/>
                                    {evidenciaFile ? evidenciaFile.name : 'Tomar Foto / Subir Archivo'}
                                </div>
                            </div>

                            {/* PREVISUALIZACI√ìN */}
                            {evidenciaFile && (
                                <div style={{textAlign:'center', margin:'10px 0', padding:'10px', background:'#f1f5f9', borderRadius:'8px', border:'1px dashed #cbd5e1'}}>
                                    {evidenciaFile.type.startsWith('image') ? (
                                        <img src={previewUrl} style={{maxHeight:'200px', borderRadius:'8px', boxShadow:'0 2px 5px rgba(0,0,0,0.1)'}} alt="preview"/>
                                    ) : (
                                        <div style={{display:'flex', alignItems:'center', justifyContent:'center', gap:'10px', color:'#475569', padding:'10px'}}>
                                            <FaFileAlt size={35} color="#0c4760"/>
                                            <div style={{textAlign:'left'}}>
                                                <div style={{fontWeight:'bold', fontSize:'0.9rem'}}>{evidenciaFile.name}</div>
                                                <div style={{fontSize:'0.75rem'}}>Documento adjunto</div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            <textarea 
                                placeholder="Observaciones generales (Obligatorio si hay fallos)..." 
                                className="input-observaciones" 
                                value={observaciones} 
                                onChange={e => setObservaciones(e.target.value)}
                                style={{
                                    // Borde rojo sutil si hay fallos y est√° vac√≠o, para dar feedback visual
                                    borderColor: (preguntas.some(p => p.Tipo !== 'TEXT' && respuestas[p.ID_Pregunta] === false) && !observaciones) ? '#fca5a5' : '#cbd5e1'
                                }}
                            ></textarea>
                        </div>

                        <button className="btn-submit-pro" onClick={handleSubmit} disabled={loading}>
                            {loading ? 'Guardando...' : 'Finalizar'}
                        </button>
                    </div>
                )}
                
                {step === 4 && (
                    <div className="success-view">
                        <FaCheckCircle className="success-icon" />
                        <h2>¬°Reporte Exitoso!</h2>
                        <button className="btn-primary" onClick={backToDashboard}>Volver al Inicio</button>
                    </div>
                )}
            </div>
        </div>
    );
};

export default Reportes;


==================================================================
ARCHIVO: frontend\src\pages\Login.jsx
==================================================================
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import useAuth from '../hooks/useAuth';
import { loginService } from '../services/authService';
import '../styles/Login.css';
import { FaUser, FaLock, FaArrowLeft } from 'react-icons/fa';
import logoImg from '../assets/logo_eltrece.png';

const Login = () => {
    const [cedula, setCedula] = useState('');
    const [password, setPassword] = useState('');
    const [alerta, setAlerta] = useState('');
    const [cargando, setCargando] = useState(false);
    
    const { loginUser } = useAuth();
    const navigate = useNavigate();

    const handleSubmit = async (e) => {
        e.preventDefault();
        setAlerta('');

        if([cedula, password].includes('')) {
            setAlerta('Todos los campos son obligatorios');
            return;
        }

        setCargando(true);

        try {
            const data = await loginService(cedula, password);
            
            // --- CORRECCI√ìN CRITICA AQU√ç ---
            // 1. Forzamos el guardado en localStorage ANTES de usar el contexto
            // Esto asegura que GestionCapacitaciones encuentre el token s√≠ o s√≠.
            localStorage.setItem('token', data.token);
            
            // Si tu backend devuelve el usuario completo, gu√°rdalo tambi√©n
            if (data.usuario) {
                localStorage.setItem('user', JSON.stringify(data.usuario));
            }

            // 2. Actualizamos el contexto de React (para men√∫s, sidebar, etc.)
            loginUser(data.usuario, data.token);
            
            // 3. Redirecci√≥n basada en rol
            if (data.usuario.rol === 'SuperAdmin' || data.usuario.rol === 'AdminCalidad') {
                navigate('/admin/dashboard');
            } else {
                navigate('/colaborador/reportes');
            }

        } catch (error) {
            console.error(error);
            setAlerta(error.message || 'Error al iniciar sesi√≥n');
            // Limpiamos basura por si acaso
            localStorage.removeItem('token');
        } finally {
            setCargando(false);
        }
    };

    return (
        <div className="login-wrapper">
            {/* BOT√ìN VOLVER FLOTANTE */}
            <button className="btn-back-nav" onClick={() => navigate('/')}>
                <FaArrowLeft /> Volver
            </button>

            <div className="login-card-split">
                {/* PANEL IZQUIERDO */}
                <div className="login-left">
                    <div className="left-content">
                        <h1>Sistema de <br/>Gesti√≥n de <br/>Calidad</h1>
                        <div className="underline-accent"></div>
                        <p>Plataforma integral para el control, reporte y mejora continua de procesos.</p>
                    </div>
                </div>

                {/* PANEL DERECHO */}
                <div className="login-right">
                    <div className="logo-container">
                        <img src={logoImg} alt="Logo El Trece" className="logo-login" />
                    </div>
                    <h2 className="company-name">Empaquetados El Trece</h2>
                    <h3 className="login-subtitle">Iniciar Sesi√≥n</h3>

                    {alerta && <div className="alerta-error">{alerta}</div>}

                    <form onSubmit={handleSubmit} className="login-form-split">
                        <div className="input-group">
                            <label htmlFor="cedula">Usuario / C√©dula</label>
                            <div className="input-wrapper">
                                <FaUser className="input-icon" />
                                <input 
                                    type="text" 
                                    id="cedula"
                                    placeholder="Ingrese su usuario"
                                    value={cedula}
                                    onChange={e => setCedula(e.target.value)}
                                />
                            </div>
                        </div>

                        <div className="input-group">
                            <label htmlFor="password">Contrase√±a</label>
                            <div className="input-wrapper">
                                <FaLock className="input-icon" />
                                <input 
                                    type="password" 
                                    id="password"
                                    placeholder="Ingrese su contrase√±a"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                />
                            </div>
                        </div>

                        <button type="submit" className="btn-login-split" disabled={cargando}>
                            {cargando ? 'Ingresando...' : 'INGRESAR'}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    );
};

export default Login;


==================================================================
ARCHIVO: frontend\src\pages\public\Kiosco.jsx
==================================================================
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Swal from 'sweetalert2'; 
import { getPreguntasKiosco, submitEvaluacionKiosco } from '../../services/specializedService';
import { API_URL } from '../../services/api';
import '../../styles/Kiosco.css';
import { 
    FaUserGraduate, FaPlay, FaArrowLeft, FaCheckCircle, 
    FaFilePdf, FaFilePowerpoint, FaIdCard, FaHardHat, 
    FaTimesCircle, FaRedo, FaInfoCircle 
} from 'react-icons/fa';

const Kiosco = () => {
    const navigate = useNavigate();
    
    // --- ESTADOS DE FLUJO ---
    // Fases: 'LISTA' -> 'VIENDO_MATERIAL' -> 'DATOS' -> 'EXAMEN' -> 'FIN'
    const [phase, setPhase] = useState('LISTA');
    const [capacitaciones, setCapacitaciones] = useState([]);
    const [selectedCap, setSelectedCap] = useState(null);
    
    // --- DATOS DEL COLABORADOR ---
    const [nombre, setNombre] = useState('');
    const [cargo, setCargo] = useState('');
    
    // --- L√ìGICA DEL EXAMEN ---
    const [preguntas, setPreguntas] = useState([]);
    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [respuestasUsuario, setRespuestasUsuario] = useState([]); 
    const [score, setScore] = useState(0);
    const [loading, setLoading] = useState(false);
    
    // --- RESULTADO FINAL ---
    const [examResult, setExamResult] = useState({ note: 0, percentage: 0, approved: false });

    // Cargar capacitaciones al iniciar
    useEffect(() => {
        fetchCapacitaciones();
    }, []);

    const fetchCapacitaciones = async () => {
        try {
            const res = await fetch(`${API_URL}/specialized/kiosco/capacitaciones`);
            const data = await res.json();
            setCapacitaciones(data);
        } catch (error) { 
            console.error("Error cargando cursos:", error); 
        }
    };

    const handleSelectCap = (cap) => {
        setSelectedCap(cap);
        setPhase('VIENDO_MATERIAL');
    };

    const handleStartExamFlow = () => {
        // Si ya ingres√≥ datos (ej. reintento), salta al examen, si no, pide datos
        if (nombre && cargo) {
            startExam(null);
        } else {
            setPhase('DATOS');
        }
    };

    const startExam = async (e) => {
        if (e) e.preventDefault();
        
        // --- VALIDACIONES ---
        if (!nombre.trim()) {
            return Swal.fire({
                icon: 'warning',
                title: 'Datos Incompletos',
                text: 'Por favor escriba su Nombre Completo para continuar.',
                confirmButtonColor: '#0c4760'
            });
        }
        if (!cargo.trim()) {
            return Swal.fire({
                icon: 'warning',
                title: 'Datos Incompletos',
                text: 'Por favor indique su Cargo u Oficio.',
                confirmButtonColor: '#0c4760'
            });
        }
        
        setLoading(true);
        try {
            // Traer preguntas del backend
            const data = await getPreguntasKiosco(selectedCap.ID_Evaluacion);
            
            if (!data || data.length === 0) {
                await Swal.fire({
                    icon: 'info',
                    title: 'Sin Evaluaci√≥n',
                    text: 'Este tema no tiene preguntas activas. Contacte al √°rea de Calidad.',
                    confirmButtonColor: '#0c4760'
                });
                setLoading(false);
                return;
            }

            // Iniciar variables de examen
            setPreguntas(data);
            setRespuestasUsuario([]);
            setScore(0);
            setCurrentQuestion(0);
            setPhase('EXAMEN'); // Cambiar vista
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo cargar el examen. Intente nuevamente.', 'error');
        } finally {
            setLoading(false);
        }
    };

    const handleAnswer = (opcion) => {
        // 1. Calcular puntaje acumulado
        let currentScore = score;
        if (opcion.esCorrecta) {
            currentScore = score + 1;
            setScore(currentScore);
        }
        
        // 2. Guardar respuesta para enviar al final
        const nuevaRespuesta = { 
            idPregunta: preguntas[currentQuestion].id, 
            idOpcion: opcion.id 
        };
        const nuevasRespuestas = [...respuestasUsuario, nuevaRespuesta];
        setRespuestasUsuario(nuevasRespuestas);

        // 3. Avanzar o Terminar
        if (currentQuestion < preguntas.length - 1) {
            setCurrentQuestion(prev => prev + 1);
        } else {
            finishExam(currentScore, nuevasRespuestas);
        }
    };

    const finishExam = async (finalScore, finalRespuestas) => {
        setLoading(true);
        const totalQuestions = preguntas.length;
        
        // Regla de 3 para nota sobre 5.0
        const percentage = Math.round((finalScore / totalQuestions) * 100);
        const notaFinal = (finalScore / totalQuestions) * 5;
        const isApproved = percentage >= 80; // Aprobar con 80%

        setExamResult({
            note: notaFinal.toFixed(1),
            percentage: percentage,
            approved: isApproved
        });

        try {
            const nombreCompletoRegistro = `${nombre} - ${cargo}`;
            
            // Enviar resultados al backend
            await submitEvaluacionKiosco({
                idEvaluacion: selectedCap.ID_Evaluacion,
                nombreEvaluado: nombreCompletoRegistro, 
                calificacion: notaFinal,
                detalleRespuestas: finalRespuestas
            });
            
            // Peque√±o delay para UX
            setTimeout(() => {
                setPhase('FIN');
                setLoading(false);
            }, 500);

        } catch (error) { 
            console.error(error);
            setLoading(false);
            Swal.fire('Error de Conexi√≥n', 'No se pudieron guardar los resultados, pero completaste el examen.', 'warning');
            setPhase('FIN'); // Mostrar resultado aunque falle el guardado
        }
    };

    const handleRetake = () => {
        // Reiniciar variables de examen pero mantener nombre/cargo
        setScore(0);
        setCurrentQuestion(0);
        setRespuestasUsuario([]);
        setExamResult({ note: 0, percentage: 0, approved: false });
        setPhase('VIENDO_MATERIAL'); // Volver al material para repasar
    };

    const resetKiosco = () => {
        // Reiniciar TODO para el siguiente usuario
        setNombre('');
        setCargo('');
        setSelectedCap(null);
        setPhase('LISTA');
        setExamResult({ note: 0, percentage: 0, approved: false });
    };

    const renderCourseIcon = (tipo) => {
        if(tipo === 'PDF') return <FaFilePdf />;
        return <FaFilePowerpoint />;
    };

    return (
        <div className="kiosco-container">
            {/* BARRA SUPERIOR */}
            <div className="kiosco-topbar">
                <button className="btn-back-kiosco" onClick={phase === 'LISTA' ? () => navigate('/') : () => setPhase('LISTA')}>
                    <FaArrowLeft /> {phase === 'LISTA' ? 'Salir' : 'Men√∫ Principal'}
                </button>
                <div className="brand-kiosco">Campus Virtual <strong>El Trece</strong></div>
            </div>

            <div className="kiosco-content">
                
                {/* 1. LISTA DE TEMAS DISPONIBLES */}
                {phase === 'LISTA' && (
                    <div className="fade-in">
                        <div className="hero-section">
                            <h1><FaUserGraduate /> Centro de Capacitaci√≥n</h1>
                            <p>Seleccione un m√≥dulo para iniciar su formaci√≥n.</p>
                        </div>

                        {capacitaciones.length === 0 ? (
                            <p style={{textAlign:'center', color:'#6b7280'}}>No hay capacitaciones activas en este momento.</p>
                        ) : (
                            <div className="courses-grid">
                                {capacitaciones.map(cap => (
                                    <div key={cap.ID_Capacitacion} className="course-card" onClick={() => handleSelectCap(cap)}>
                                        <div className={`course-cover ${cap.Tipo_Archivo === 'PDF' ? 'cover-red' : 'cover-orange'}`}>
                                            {renderCourseIcon(cap.Tipo_Archivo)}
                                        </div>
                                        <div className="course-body">
                                            <span className="course-tag">{cap.Tipo_Archivo}</span>
                                            <h3>{cap.Titulo}</h3>
                                            <p>{cap.Descripcion || "Sin descripci√≥n disponible."}</p>
                                            <button className="btn-start-course">Iniciar M√≥dulo</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}

                {/* 2. VISOR DE MATERIAL (PDF/PPT) */}
                {phase === 'VIENDO_MATERIAL' && selectedCap && (
                    <div className="material-viewer fade-in">
                        <div className="viewer-header">
                            <h2>{selectedCap.Titulo}</h2>
                            
                            {/* [CORREGIDO] MOSTRAR DESCRIPCI√ìN */}
                            <p style={{fontSize: '1.1rem', color: '#475569', marginBottom:'15px', maxWidth:'800px', margin:'0 auto 15px auto', lineHeight:'1.5'}}>
                                {selectedCap.Descripcion}
                            </p>
                            
                            <p style={{fontSize:'0.9rem', color:'#94a3b8', fontStyle:'italic'}}>
                                <FaInfoCircle style={{marginRight:'5px'}}/>
                                Lea atentamente el material antes de presentar la evaluaci√≥n.
                            </p>
                        </div>
                        
                        <div className="document-frame">
                            {selectedCap.Url_Material.endsWith('.pdf') ? (
                                <iframe src={selectedCap.Url_Material} title="Visor Documento"></iframe>
                            ) : (
                                <div className="ppt-placeholder">
                                    <FaFilePowerpoint className="ppt-icon"/>
                                    <h3>Material PowerPoint / Video</h3>
                                    <p>Este contenido se ha descargado o abierto en otra ventana.</p>
                                    <a href={selectedCap.Url_Material} className="btn-download-ppt" target="_blank" rel="noopener noreferrer">
                                        Abrir Material
                                    </a>
                                </div>
                            )}
                        </div>

                        <div className="viewer-footer">
                            <button className="btn-action-primary" onClick={handleStartExamFlow}>
                                <FaPlay /> REALIZAR EVALUACI√ìN
                            </button>
                        </div>
                    </div>
                )}

                {/* 3. REGISTRO DE DATOS DEL EMPLEADO */}
                {phase === 'DATOS' && (
                    <div className="auth-card fade-in">
                        <div className="auth-header">
                            <FaIdCard className="auth-icon"/>
                            <h2>Registro de Asistencia</h2>
                            <p>Ingrese sus datos para validar la evaluaci√≥n.</p>
                        </div>
                        
                        <form onSubmit={startExam} className="auth-form">
                            <div className="input-group-kiosco">
                                <label><FaUserGraduate/> Nombre Completo</label>
                                <input 
                                    type="text" 
                                    placeholder="Ej: Pepito P√©rez" 
                                    value={nombre} 
                                    onChange={e => setNombre(e.target.value)} 
                                    autoFocus 
                                />
                            </div>

                            <div className="input-group-kiosco">
                                <label><FaHardHat/> Cargo / Oficio</label>
                                <input 
                                    type="text" 
                                    placeholder="Ej: Operario de Sellado" 
                                    value={cargo} 
                                    onChange={e => setCargo(e.target.value)} 
                                />
                            </div>

                            <div className="form-actions">
                                <button type="button" className="btn-ghost" onClick={() => setPhase('VIENDO_MATERIAL')}>Volver</button>
                                <button type="submit" className="btn-action-primary" disabled={loading}>
                                    {loading ? 'Cargando...' : 'Comenzar Examen'}
                                </button>
                            </div>
                        </form>
                    </div>
                )}

                {/* 4. EXAMEN (PREGUNTAS) */}
                {phase === 'EXAMEN' && preguntas.length > 0 && (
                    <div className="exam-container fade-in">
                        {/* Barra de Progreso */}
                        <div className="exam-progress">
                            <span>Pregunta {currentQuestion + 1} de {preguntas.length}</span>
                            <div className="progress-track">
                                <div className="progress-bar" style={{width: `${((currentQuestion+1)/preguntas.length)*100}%`}}></div>
                            </div>
                        </div>
                        
                        <div className="question-card">
                            {/* --- SECCI√ìN IMAGEN DE PREGUNTA --- */}
                            {preguntas[currentQuestion].imagen && (
                                <div style={{textAlign: 'center', marginBottom: '20px'}}>
                                    <img 
                                        src={preguntas[currentQuestion].imagen} 
                                        alt="Referencia Visual" 
                                        style={{
                                            maxWidth: '100%', 
                                            maxHeight: '300px', 
                                            borderRadius: '8px', 
                                            boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                                            border: '1px solid #e2e8f0',
                                            objectFit: 'contain'
                                        }}
                                    />
                                    <div style={{fontSize:'0.8rem', color:'#64748b', marginTop:'5px'}}>
                                        <FaInfoCircle/> Observe la imagen para responder
                                    </div>
                                </div>
                            )}
                            {/* ---------------------------------- */}

                            <h2 className="question-text">{preguntas[currentQuestion].pregunta}</h2>
                            
                            <div className="options-grid">
                                {preguntas[currentQuestion].opciones.map((opcion) => (
                                    <button 
                                        key={opcion.id} 
                                        className="option-button"
                                        onClick={() => handleAnswer(opcion)}
                                    >
                                        {opcion.texto}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {/* 5. PANTALLA FINAL (RESULTADOS) */}
                {phase === 'FIN' && (
                    <div className="success-card fade-in">
                        <div className="success-icon-wrapper" style={{color: examResult.approved ? '#10b981' : '#ef4444'}}>
                            {examResult.approved ? <FaCheckCircle /> : <FaTimesCircle />}
                        </div>

                        <h1 style={{color: examResult.approved ? '#0c4760' : '#ef4444'}}>
                            {examResult.approved ? '¬°Felicitaciones!' : 'No Aprobado'}
                        </h1>

                        <div className="score-circle" style={{
                            borderColor: examResult.approved ? '#10b981' : '#ef4444',
                            color: examResult.approved ? '#10b981' : '#ef4444'
                        }}>
                            {examResult.note}
                        </div>
                        
                        <p style={{fontSize:'1.2rem', fontWeight:'600', color:'#4b5563', marginBottom:'0.5rem'}}>
                            Obtuviste un {examResult.percentage}%
                        </p>

                        <p style={{marginBottom:'2rem', color:'#6b7280'}}>
                            {examResult.approved 
                                ? `Excelente trabajo ${nombre}, tus resultados han sido registrados.` 
                                : `Lo sentimos ${nombre}, el m√≠nimo para aprobar es 80%. Debes repasar el material.`}
                        </p>

                        {examResult.approved ? (
                            <button onClick={resetKiosco} className="btn-action-primary">
                                Finalizar y Salir
                            </button>
                        ) : (
                            <button onClick={handleRetake} className="btn-action-primary" style={{backgroundColor:'#ef4444'}}>
                                <FaRedo style={{marginRight:'8px'}}/> Repasar y Reintentar
                            </button>
                        )}
                    </div>
                )}

            </div>
        </div>
    );
};

export default Kiosco;


==================================================================
ARCHIVO: frontend\src\pages\Welcome.jsx
==================================================================
import { Link } from 'react-router-dom';
import logoImg from '../assets/logo_eltrece.png'; // Aseg√∫rate de tener el logo aqu√≠
import '../styles/Welcome.css';
import { FaUserShield, FaUsers, FaGraduationCap } from 'react-icons/fa';

const Welcome = () => {
    return (
        <div className="welcome-container">
            <div className="welcome-content">
                
                {/* LOGO */}
                <div className="welcome-header">
                    <img src={logoImg} alt="Empaquetados El Trece" className="welcome-logo" />
                    <h1 className="welcome-title">Bienvenido al Sistema</h1>
                    <p className="welcome-subtitle">Empaquetados El Trece S.A.S</p>
                    <p className="welcome-instruction">Seleccione una opci√≥n para ingresar:</p>
                </div>

                {/* GRID DE OPCIONES */}
                <div className="welcome-grid">
                    
                    {/* OPCI√ìN 1: ADMIN / SG-SST */}
                    <Link to="/login" className="welcome-card">
                        <div className="card-icon-wrapper icon-admin">
                            <FaUserShield />
                        </div>
                        <h3>Gesti√≥n SGC</h3>
                        <p>Administradores y L√≠deres GC</p>
                    </Link>

                    {/* OPCI√ìN 2: COLABORADOR */}
                    <Link to="/login" className="welcome-card">
                        <div className="card-icon-wrapper icon-collab">
                            <FaUsers />
                        </div>
                        <h3>Colaborador</h3>
                        <p>Reportes y Consultas Operativas</p>
                    </Link>

                    {/* OPCI√ìN 3: KIOSCO (NUEVA) */}
                    <Link to="/kiosco" className="welcome-card">
                        <div className="card-icon-wrapper icon-kiosco">
                            <FaGraduationCap />
                        </div>
                        <h3>Evaluaci√≥n de Capacitaci√≥n</h3>
                        <p>Realizar examen en Kiosco</p>
                    </Link>

                </div>

                <footer className="welcome-footer">
                    v2.0 - Sistema Integrado de Gesti√≥n
                </footer>
            </div>
        </div>
    );
};

export default Welcome;


==================================================================
ARCHIVO: frontend\src\services\acpmService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const createACPM = async (data) => {
    const response = await fetch(`${API_URL}/acpm`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

export const getACPMs = async () => {
    const response = await fetch(`${API_URL}/acpm`, { headers: getAuthHeaders() });
    return await response.json();
};

// --- NUEVO: OBTENER UN ACPM POR ID ---
export const getACPMById = async (id) => {
    const response = await fetch(`${API_URL}/acpm/${id}`, { headers: getAuthHeaders() });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

// ... (Resto de funciones igual: closeACPM, manageACPM, etc.)

export const closeACPM = async (id, urlEvidencia) => {
    const response = await fetch(`${API_URL}/acpm/cerrar/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ urlEvidencia })
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

export const manageACPM = async (id, data) => {
    const response = await fetch(`${API_URL}/acpm/gestion/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

export const getOrigenesACPM = async () => {
    const response = await fetch(`${API_URL}/acpm/origenes`, { headers: getAuthHeaders() });
    if (!response.ok) return []; 
    return await response.json();
};

export const addOrigenACPM = async (nombre) => {
    const response = await fetch(`${API_URL}/acpm/origenes`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ nombre })
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};


==================================================================
ARCHIVO: frontend\src\services\api.js
==================================================================
// frontend/src/services/api.js

// 1. Configuraci√≥n din√°mica (Detecta si es Local o Producci√≥n autom√°ticamente)
// Si existe la variable de entorno VITE_API_URL la usa, si no, usa localhost
export const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000/api';

// 2. Helper cl√°sico de headers (Mantenido por compatibilidad)
export const getAuthHeaders = () => {
    const token = localStorage.getItem('token');
    return {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
    };
};

// 3. Wrapper Est√°ndar para Peticiones JSON
// Maneja autom√°ticamente el Token, FormData y los errores
export const apiFetch = async (endpoint, options = {}) => {
    const token = localStorage.getItem('token');
    
    // DETALLE IMPORTANTE: Si enviamos FormData (archivos), NO ponemos Content-Type.
    // El navegador lo calcula solo. Si es JSON, s√≠ lo ponemos.
    const isFormData = options.body instanceof FormData;
    
    const headers = {
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...(!isFormData && { 'Content-Type': 'application/json' }),
        ...options.headers
    };

    // Aseguramos que el endpoint empiece con / si no lo tiene
    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;

    // eslint-disable-next-line no-useless-catch
    try {
        const response = await fetch(`${API_URL}${cleanEndpoint}`, {
            ...options,
            headers
        });

        if (!response.ok) {
            // Intentamos extraer el mensaje de error del Backend
            try {
                const errorData = await response.json();
                throw new Error(errorData.mensaje || errorData.msg || 'Error en la petici√≥n');
            } catch (jsonError) {
                // Si no es JSON (ej. error 500 de servidor ca√≠do, timeout, etc.)
                throw new Error(jsonError.message || `Error del servidor (${response.status})`);
            }
        }

        // Si la respuesta es 204 (No Content), retornamos null
        if (response.status === 204) return null;

        return await response.json();

    } catch (error) {
        // Propagamos el error para que el componente lo maneje (Alertas, Toast, etc.)
        throw error;
    }
};

// 4. Wrapper para DESCARGAR Archivos (BLOB / Streaming)
// Esta funci√≥n es vital para ver im√°genes/PDFs en Hostinger sin hacer p√∫blica la carpeta uploads.
export const apiFetchBlob = async (endpoint, options = {}) => {
    const token = localStorage.getItem('token');
    
    const headers = {
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...options.headers
    };

    const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;

    const response = await fetch(`${API_URL}${cleanEndpoint}`, {
        ...options,
        headers
    });

    if (!response.ok) {
        throw new Error('Error al descargar el archivo. Verifique permisos o existencia.');
    }

    // Retorna el binario (Blob) listo para crear una URL temporal con URL.createObjectURL()
    return await response.blob(); 
};

// 5. NUEVA UTILIDAD: EXTRAER NOMBRE DE ARCHIVO
// Ayuda a convertir rutas sucias de BD ("uploads/mi_foto.jpg" o "C:\fake\path\foto.jpg")
// en solo el nombre del archivo ("mi_foto.jpg") para pedirlo al endpoint de streaming.
export const extractFilename = (pathOrUrl) => {
    if (!pathOrUrl) return null;
    // Divide por barra normal (/) o invertida (\) para compatibilidad total Linux/Windows
    const parts = pathOrUrl.split(/[/\\]/);
    return parts[parts.length - 1]; // Retorna solo el nombre final
};


==================================================================
ARCHIVO: frontend\src\services\auditGlobalService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getBitacora = async () => {
    const response = await fetch(`${API_URL}/bitacora`, { headers: getAuthHeaders() });
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\auditoriaService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getAuditorias = async () => {
    const res = await fetch(`${API_URL}/auditorias`, { headers: getAuthHeaders() });
    return await res.json();
};

export const createAuditoria = async (formData) => {
    // NOTA: Cuando enviamos FormData, NO debemos poner 'Content-Type': 'application/json'
    // El navegador lo pone autom√°ticamente como 'multipart/form-data'
    const headers = getAuthHeaders();
    delete headers['Content-Type']; // Borramos el content-type JSON para que pase el archivo

    const res = await fetch(`${API_URL}/auditorias`, {
        method: 'POST',
        headers: headers, 
        body: formData // Enviamos el objeto FormData directo
    });
    if (!res.ok) throw new Error('Error al crear auditor√≠a');
    return await res.json();
};

// Obtener o Crear Auditor (Si pasas 'nuevo', lo crea)
export const getAuditoresList = async (nuevo = null) => {
    const res = await fetch(`${API_URL}/auditorias/auditores`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ nuevo })
    });
    return await res.json();
};

// Obtener o Crear √Årea (Si pasas 'nuevo', la crea)
export const getAreasList = async (nuevo = null) => {
    const res = await fetch(`${API_URL}/auditorias/areas`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ nuevo })
    });
    return await res.json();
};


==================================================================
ARCHIVO: frontend\src\services\auditService.js
==================================================================
// frontend/src/services/auditService.js
import { API_URL, getAuthHeaders } from './api';

export const getAuditoriaData = async () => {
    const response = await fetch(`${API_URL}/auditoria`, { headers: getAuthHeaders() });
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\authService.js
==================================================================
// frontend/src/services/authService.js
import { API_URL } from './api';

export const loginService = async (cedula, password) => {
    const response = await fetch(`${API_URL}/auth/login`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cedula, password })
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.mensaje || 'Error en la petici√≥n');
    }

    return data;
};


==================================================================
ARCHIVO: frontend\src\services\capacitacionService.js
==================================================================
// frontend/src/services/capacitacionService.js
import { API_URL, getAuthHeaders } from './api';

// Obtener lista general de resultados
export const getResultados = async () => {
    const response = await fetch(`${API_URL}/capacitacion/resultados`, { headers: getAuthHeaders() });
    return await response.json();
};

// Aprobar o Rechazar
export const updateEstadoResultado = async (id, estado) => {
    const response = await fetch(`${API_URL}/capacitacion/resultados/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ estado })
    });
    if (!response.ok) throw new Error('Error al actualizar');
    return await response.json();
};

// NUEVO: Ver detalle de respuestas de un examen espec√≠fico
export const getDetalleResultado = async (idResultado) => {
    const response = await fetch(`${API_URL}/capacitacion/resultados/${idResultado}`, { 
        headers: getAuthHeaders() 
    });
    if (!response.ok) throw new Error('Error al cargar detalle');
    return await response.json();
};

// Obtener configuraci√≥n de preguntas
export const getPreguntasCapacitacion = async (idEvaluacion) => {
    const response = await fetch(`${API_URL}/capacitacion/preguntas/${idEvaluacion}`, { headers: getAuthHeaders() });
    return await response.json();
};

// Agregar nueva pregunta con opciones
export const addPreguntaCapacitacion = async (idEvaluacion, texto, opciones, correcta) => {
    const response = await fetch(`${API_URL}/capacitacion/preguntas`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ idEvaluacion, texto, opciones, correcta })
    });
    if (!response.ok) throw new Error('Error al agregar');
    return await response.json();
};

// Eliminar pregunta
export const deletePreguntaCapacitacion = async (id) => {
    const response = await fetch(`${API_URL}/capacitacion/preguntas/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Error al eliminar');
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\certificadosService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getPlantillas = async () => {
    const response = await fetch(`${API_URL}/certificados/plantillas`, { headers: getAuthHeaders() });
    return await response.json();
};

export const savePlantilla = async (data) => {
    const response = await fetch(`${API_URL}/certificados/plantillas`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al guardar');
    return await response.json();
};

// --- ACTUALIZADO: SOPORTE PARA FORMDATA (Subida de PDF) ---
export const logCertificado = async (formData) => {
    const token = localStorage.getItem('token');
    
    // NOTA: Al enviar FormData, NO pongas 'Content-Type': 'application/json'
    // El navegador lo gestiona autom√°ticamente.
    const response = await fetch(`${API_URL}/certificados/generar`, {
        method: 'POST', 
        headers: {
            'Authorization': `Bearer ${token}`
        }, 
        body: formData
    });
    
    if (!response.ok) throw new Error('Error al guardar certificado');
    return await response.json();
};

export const getHistorialCertificados = async () => {
    const response = await fetch(`${API_URL}/certificados/historial`, { headers: getAuthHeaders() });
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\coreService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

// --- ACTIVOS ---
export const getActivos = async () => {
    const response = await fetch(`${API_URL}/core/activos`, { headers: getAuthHeaders() });
    return await response.json();
};

export const createActivo = async (data) => {
    const response = await fetch(`${API_URL}/core/activos`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

export const updateActivo = async (id, data) => {
    const response = await fetch(`${API_URL}/core/activos/${id}`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al actualizar activo');
    return await response.json();
};

export const toggleActivoStatus = async (id, estado) => {
    const response = await fetch(`${API_URL}/core/activos/${id}/estado`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify({ nuevoEstado: estado })
    });
    if (!response.ok) throw new Error('Error al cambiar estado');
    return await response.json();
};

// --- CATEGOR√çAS ---
export const getCategorias = async () => {
    const response = await fetch(`${API_URL}/core/categorias`, { headers: getAuthHeaders() });
    return await response.json();
};

export const createCategoria = async (nombre) => {
    const response = await fetch(`${API_URL}/core/categorias`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ nombre })
    });
    return await response.json();
};

// --- FORMULARIOS ---
export const getAllFormularios = async () => {
    const response = await fetch(`${API_URL}/core/formularios`, { headers: getAuthHeaders() });
    if (!response.ok) return [];
    return await response.json();
};

export const createFormulario = async (data) => {
    const response = await fetch(`${API_URL}/core/formularios`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al crear formulario');
    return await response.json();
};

export const updateFormulario = async (id, data) => {
    const response = await fetch(`${API_URL}/core/formularios/${id}`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al editar formulario');
    return await response.json();
};

export const deleteFormulario = async (id) => {
    const response = await fetch(`${API_URL}/core/formularios/${id}`, {
        method: 'DELETE', headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Error al eliminar formulario');
    return await response.json();
};

export const toggleFormVisibility = async (id, visible) => {
    const response = await fetch(`${API_URL}/core/formularios/${id}/visibilidad`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify({ esVisible: visible })
    });
    if (!response.ok) throw new Error('Error visibilidad');
    return await response.json();
};

// --- PREGUNTAS ---
export const getPreguntas = async (idFormulario) => {
    const response = await fetch(`${API_URL}/core/formularios/${idFormulario}/preguntas`, { headers: getAuthHeaders() });
    return await response.json();
};

// [IMPORTANTE] Esta funci√≥n debe recibir 'tipo'
export const addPregunta = async (idFormulario, texto, tipo) => {
    const response = await fetch(`${API_URL}/core/formularios/pregunta`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({ idFormulario, texto, tipo }) 
    });
    if (!response.ok) {
        const err = await response.json();
        throw new Error(err.mensaje || 'Error al agregar pregunta');
    }
    return await response.json();
};

export const deletePregunta = async (idPregunta) => {
    const response = await fetch(`${API_URL}/core/formularios/pregunta/${idPregunta}`, {
        method: 'DELETE', headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Error al eliminar pregunta');
    return await response.json();
};

// --- ASIGNACI√ìN ---
export const assignFormulario = async (idActivo, idFormulario) => {
    const response = await fetch(`${API_URL}/core/asignar`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ idActivo, idFormulario })
    });
    if(!response.ok) throw new Error('Error');
    return await response.json();
};

export const getFormsByActivo = async (idActivo) => {
    const response = await fetch(`${API_URL}/core/asignar/${idActivo}`, { headers: getAuthHeaders() });
    return await response.json();
};

// --- TARJETAS ---
export const getTarjetas = async (modulo) => {
    const response = await fetch(`${API_URL}/core/tarjetas/${modulo}`, { headers: getAuthHeaders() });
    return await response.json();
};

export const createTarjeta = async (data) => {
    const response = await fetch(`${API_URL}/core/tarjetas`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al crear tarjeta');
    return await response.json();
};

export const deleteTarjeta = async (id) => {
    const response = await fetch(`${API_URL}/core/tarjetas/${id}`, {
        method: 'DELETE', headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Error al eliminar tarjeta');
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\cronogramaService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

// --- CRONOGRAMAS ---

// ACTUALIZADO: Ahora acepta un par√°metro 'tipo' opcional
export const getCronogramas = async (tipo = null) => {
    let url = `${API_URL}/cronogramas`;
    if (tipo) {
        url += `?tipo=${tipo}`;
    }
    const response = await fetch(url, { headers: getAuthHeaders() });
    return await response.json();
};

export const createCronograma = async (data) => {
    // data debe incluir { nombre, anio, descripcion, tipo }
    const response = await fetch(`${API_URL}/cronogramas`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    const res = await response.json();
    if (!response.ok) throw new Error(res.mensaje || 'Error al crear cronograma');
    return res;
};

export const deleteCronograma = async (id) => {
    const response = await fetch(`${API_URL}/cronogramas/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
    if (!response.ok) throw new Error('Error al eliminar');
    return await response.json();
};

// --- ACTIVIDADES ---

// Traer todo para el calendario global
export const getAllActividades = async () => {
    const response = await fetch(`${API_URL}/cronogramas/actividades/todas`, { headers: getAuthHeaders() });
    return await response.json();
};

export const getActividades = async (idCronograma) => {
    const response = await fetch(`${API_URL}/cronogramas/${idCronograma}/actividades`, { headers: getAuthHeaders() });
    return await response.json();
};

export const createActividad = async (data) => {
    const response = await fetch(`${API_URL}/cronogramas/actividad`, {
        method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    const res = await response.json();
    if (!response.ok) throw new Error(res.mensaje);
    return res;
};

export const updateActividad = async (id, data) => {
    const response = await fetch(`${API_URL}/cronogramas/actividad/${id}`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Error al actualizar');
    return await response.json();
};

export const deleteActividad = async (id) => {
    const response = await fetch(`${API_URL}/cronogramas/actividad/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
    if (!response.ok) throw new Error('Error eliminando actividad');
    return await response.json();
};

export const updateEstadoActividad = async (id, nuevoEstado) => {
    const response = await fetch(`${API_URL}/cronogramas/actividad/estado/${id}`, {
        method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify({ nuevoEstado })
    });
    return await response.json();
};

// --- SEGUIMIENTO CON ARCHIVOS ---
export const addSeguimiento = async (id, formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_URL}/cronogramas/actividad/seguimiento/${id}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${token}` 
        },
        body: formData
    });
    const res = await response.json();
    if (!response.ok) throw new Error(res.mensaje);
    return res;
};


==================================================================
ARCHIVO: frontend\src\services\dashboardService.js
==================================================================
// frontend/src/services/dashboardService.js
import { API_URL, getAuthHeaders } from './api';

export const getDashboardStats = async () => {
    const response = await fetch(`${API_URL}/dashboard/resumen`, {
        headers: getAuthHeaders()
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje || 'Error al obtener datos del dashboard');
    return result;
};


==================================================================
ARCHIVO: frontend\src\services\externosService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getListasExternas = async () => {
    try {
        // Asumiendo que tienes endpoints separados o uno unificado. 
        // Si usas endpoints separados, agrega el fetch de clientes:
        
        const [prodRes, provRes, maqRes, sellRes, cliRes] = await Promise.all([
            fetch(`${API_URL}/externos/productos`, { headers: getAuthHeaders() }),
            fetch(`${API_URL}/externos/proveedores`, { headers: getAuthHeaders() }),
            fetch(`${API_URL}/externos/maquinistas`, { headers: getAuthHeaders() }),
            fetch(`${API_URL}/externos/selladores`, { headers: getAuthHeaders() }),
            fetch(`${API_URL}/externos/clientes`, { headers: getAuthHeaders() }) // <--- NUEVO
        ]);

        return {
            productos: await prodRes.json(),
            proveedores: await provRes.json(),
            maquinistas: await maqRes.json(),
            selladores: await sellRes.json(),
            clientes: await cliRes.json() // <--- NUEVO
        };
    } catch (error) {
        console.error("Error cargando listas externas", error);
        return { productos: [], proveedores: [], maquinistas: [], selladores: [], clientes: [] };
    }
};


==================================================================
ARCHIVO: frontend\src\services\notificationService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getNotificaciones = async () => {
    const response = await fetch(`${API_URL}/notificaciones`, { headers: getAuthHeaders() });
    return await response.json();
};

// CAMBIO: Funci√≥n para eliminar
export const deleteNotification = async (id) => {
    await fetch(`${API_URL}/notificaciones/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
    });
};


==================================================================
ARCHIVO: frontend\src\services\pesosService.js
==================================================================
// frontend/src/services/pesosService.js
import { API_URL, getAuthHeaders } from './api';

export const getHistorialPesos = async () => {
    const response = await fetch(`${API_URL}/pesos`, { 
        headers: getAuthHeaders() 
    });
    return await response.json();
};

export const getDetallePeso = async (id) => {
    const response = await fetch(`${API_URL}/pesos/${id}`, { 
        headers: getAuthHeaders() 
    });
    if (!response.ok) throw new Error('Error al cargar detalle');
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\proveedoresService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

// Obtener todas las evaluaciones (Para la tabla principal)
export const getEvaluaciones = async () => {
    try {
        const response = await fetch(`${API_URL}/proveedores`, {
            headers: getAuthHeaders()
        });
        if (!response.ok) throw new Error('Error al cargar evaluaciones');
        return await response.json();
    } catch (error) {
        console.error("Error en getEvaluaciones:", error);
        throw error;
    }
};

// Obtener el detalle de una evaluaci√≥n espec√≠fica (Para el Modal)
export const getEvaluacionById = async (id) => {
    try {
        const response = await fetch(`${API_URL}/proveedores/${id}`, {
            headers: getAuthHeaders()
        });
        if (!response.ok) throw new Error('Error al obtener el detalle de la evaluaci√≥n');
        return await response.json();
    } catch (error) {
        console.error(`Error en getEvaluacionById (${id}):`, error);
        throw error;
    }
};

// Guardar una nueva evaluaci√≥n
export const createEvaluacion = async (payload) => {
    try {
        const response = await fetch(`${API_URL}/proveedores`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error('Error al guardar la evaluaci√≥n');
        return await response.json();
    } catch (error) {
        console.error("Error en createEvaluacion:", error);
        throw error;
    }
};


==================================================================
ARCHIVO: frontend\src\services\recallService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

// --- SALIDAS (DISTRIBUCI√ìN) ---

export const getSalidas = async () => {
    const res = await fetch(`${API_URL}/recall/salidas`, { headers: getAuthHeaders() });
    if (!res.ok) throw new Error('Error cargando salidas');
    return await res.json();
};

export const createSalida = async (formData) => {
    // Nota: No poner Content-Type cuando es FormData, el navegador lo pone con el boundary
    const res = await fetch(`${API_URL}/recall/salidas`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: formData
    });
    if (!res.ok) {
        const error = await res.json();
        throw new Error(error.mensaje || 'Error al crear salida');
    }
    return await res.json();
};


==================================================================
ARCHIVO: frontend\src\services\reportesService.js
==================================================================
// frontend/src/services/reportesService.js
import { API_URL, getAuthHeaders } from './api';

// Crear Reporte (Soporta Fotos y Archivos)
export const createReporte = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_URL}/reportes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}` 
        },
        body: formData
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

// Obtener Historial de Reportes
export const getReportes = async () => {
    const response = await fetch(`${API_URL}/reportes`, {
        headers: getAuthHeaders()
    });
    return await response.json();
};

// Obtener Detalle de un Reporte
export const getReporteDetalle = async (id) => {
    const response = await fetch(`${API_URL}/reportes/${id}/detalle`, { 
        headers: getAuthHeaders() 
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje || 'Error al cargar detalles');
    return result;
};

// NUEVO: Verificar Reporte
export const verifyReporte = async (id) => {
    const response = await fetch(`${API_URL}/reportes/${id}/verificar`, {
        method: 'PUT',
        headers: getAuthHeaders()
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje || 'Error al verificar');
    return result;
};


==================================================================
ARCHIVO: frontend\src\services\specializedService.js
==================================================================
// frontend/src/services/specializedService.js
import { API_URL, getAuthHeaders } from './api';

// 1. Registrar Agua (FormData con foto)
export const registrarAgua = async (puntoToma, medicion, fotoFile) => {
    const formData = new FormData();
    formData.append('puntoToma', puntoToma);
    formData.append('medicion', medicion);
    formData.append('foto', fotoFile);

    const token = localStorage.getItem('token');
    // Fetch pone el Content-Type correcto para FormData autom√°ticamente
    const response = await fetch(`${API_URL}/specialized/agua/verificar`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};

// 2. Obtener Historial Agua
export const getHistorialAgua = async () => {
    const response = await fetch(`${API_URL}/specialized/agua/historial`, {
        headers: getAuthHeaders()
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje || 'Error al obtener historial');
    return data;
};

// 3. Kiosco: Enviar Evaluaci√≥n (P√∫blico)
export const submitEvaluacionKiosco = async (data) => {
    // data: { idEvaluacion, nombreEvaluado, calificacion, detalleRespuestas }
    const response = await fetch(`${API_URL}/specialized/kiosco/evaluar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.mensaje);
    return result;
};

// 4. Kiosco: Obtener Preguntas (P√∫blico)
export const getPreguntasKiosco = async (idEvaluacion) => {
    const response = await fetch(`${API_URL}/specialized/kiosco/preguntas/${idEvaluacion}`);
    const result = await response.json();
    if (!response.ok) throw new Error('Error al cargar preguntas');
    return result;
};

// 5. Helper de Subida (Usado por ACPM y otros)
export const uploadFile = async (file, modulo, tipo, nombre) => {
    const formData = new FormData();
    formData.append('archivo', file);
    formData.append('idCarpeta', 1); // Carpeta ra√≠z por defecto para temporales
    
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_URL}/drive/archivo`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
    });
    
    if (!response.ok) {
        const err = await response.json();
        throw new Error(err.mensaje);
    }
    // Retornamos la URL p√∫blica construida (ajustar si backend cambia)
    return { url: `http://localhost:3000/uploads/${file.name}` }; 
};


==================================================================
ARCHIVO: frontend\src\services\trazabilidadService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getFichasTecnicas = async () => {
    const response = await fetch(`${API_URL}/trazabilidad/fichas`, { headers: getAuthHeaders() });
    return await response.json();
};

export const uploadFichaTecnica = async (formData) => {
    const token = localStorage.getItem('token');
    const response = await fetch(`${API_URL}/trazabilidad/fichas`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }, // FormData no lleva Content-Type manual
        body: formData
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};

export const deleteFichaTecnica = async (id) => {
    const response = await fetch(`${API_URL}/trazabilidad/fichas/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders()
    });
    if (!response.ok) throw new Error('Error al eliminar');
    return await response.json();
};


==================================================================
ARCHIVO: frontend\src\services\userService.js
==================================================================
import { API_URL, getAuthHeaders } from './api';

export const getUsers = async () => {
    const response = await fetch(`${API_URL}/usuarios`, { headers: getAuthHeaders() });
    return await response.json();
};

export const getRoles = async () => {
    const response = await fetch(`${API_URL}/usuarios/roles`, { headers: getAuthHeaders() });
    return await response.json();
};

export const createUser = async (userData) => {
    const response = await fetch(`${API_URL}/usuarios`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(userData)
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};

export const updateUser = async (id, userData) => {
    const response = await fetch(`${API_URL}/usuarios/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify(userData)
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};

export const toggleUserStatus = async (id, nuevoEstado) => {
    const response = await fetch(`${API_URL}/usuarios/estado/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ estado: nuevoEstado })
    });
    if (!response.ok) throw new Error('Error al cambiar estado');
    return await response.json();
};

export const resetUserPassword = async (id, nuevaPassword) => {
    const response = await fetch(`${API_URL}/usuarios/password/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ nuevaPassword })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};

// NUEVA: Actualizar correo de perfil
export const updateEmailPerfil = async (id, email) => {
    const response = await fetch(`${API_URL}/usuarios/perfil/correo/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ email })
    });
    const data = await response.json();
    if (!response.ok) throw new Error(data.mensaje);
    return data;
};


==================================================================
ARCHIVO: frontend\src\styles\Cronograma.css
==================================================================
/* frontend/src/styles/Cronograma.css */
@import 'react-big-calendar/lib/css/react-big-calendar.css';

/* --- ESTILOS GENERALES --- */
.page-container {
    padding: 30px;
    font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
    background-color: #f0f2f5;
    min-height: 100vh;
}

@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.98); }
    to { opacity: 1; transform: scale(1); }
}

/* --- HEADER PRINCIPAL --- */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    animation: fadeInScale 0.3s ease-out;
    flex-wrap: wrap;
    gap: 15px;
}

.page-header h1 {
    font-size: 1.8rem;
    color: #1e293b;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

/* --- BOTONES GENERALES --- */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.btn:active { transform: translateY(0); }

.btn-grey { background-color: #64748b; color: white; }
.btn-blue { background: linear-gradient(135deg, #0c4760, #0891b2); color: white; }
.btn-red { background-color: #ef4444; color: white; }
.btn-yellow { background-color: #f59e0b; color: white; }

.btn-sm {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
}

/* --- FILTROS Y CONTENEDORES --- */
.card-section {
    background: white;
    padding: 25px;
    border-radius: 20px;
    border: 1px solid #fff;
    margin-bottom: 25px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    animation: fadeInScale 0.4s ease-out;
}

.filters-wrapper {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    background: white;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    align-items: center;
}

.filter-search-box { flex: 1; }
.filter-select-box { width: 220px; }

/* --- INPUTS Y LABELS (Usados en p√°gina y modales) --- */
.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 0.95rem;
    color: #334155;
    background-color: #f8fafc;
    transition: all 0.2s;
    outline: none;
}

.form-control:focus {
    border-color: #0c4760;
    background-color: #fff;
    box-shadow: 0 0 0 4px rgba(12, 71, 96, 0.1);
}

.input-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: #64748b;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* --- CALENDARIO --- */
.calendar-legend {
    display: flex;
    gap: 20px;
    font-size: 0.85rem;
    justify-content: flex-end;
    flex-wrap: wrap;
}
.legend-item { display: flex; align-items: center; gap: 8px; color: #64748b; font-weight: 500; }
.dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* Overrides React Big Calendar */
.rbc-calendar { font-family: inherit; border-radius: 16px; overflow: hidden; }
.rbc-month-view { border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; }
.rbc-header {
    padding: 12px 0;
    font-weight: 700;
    color: #0c4760;
    background-color: #f1f5f9;
    border-bottom: 1px solid #e2e8f0;
    text-transform: uppercase;
    font-size: 0.8rem;
}
.rbc-day-bg + .rbc-day-bg { border-left: 1px solid #f1f5f9; }
.rbc-month-row + .rbc-month-row { border-top: 1px solid #f1f5f9; }
.rbc-off-range-bg { background-color: #fcfcfc; }
.rbc-today { background-color: #f0f9ff; }

.rbc-event {
    border-radius: 6px !important;
    padding: 2px 8px !important;
    font-size: 0.8rem !important;
    border: none !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 2px 4px !important;
    transition: transform 0.1s;
}
.rbc-event:hover { transform: scale(1.02); z-index: 5; }

.rbc-toolbar button {
    border: 1px solid #e2e8f0 !important;
    color: #64748b !important;
    border-radius: 8px !important;
    margin: 0 4px !important;
    padding: 6px 12px !important;
    font-size: 0.9rem;
}
.rbc-toolbar button:hover, .rbc-toolbar button.rbc-active {
    background-color: #0c4760 !important;
    color: white !important;
    box-shadow: none !important;
    border-color: #0c4760 !important;
}

/* --- TABLA --- */
.table-container { 
    overflow-x: auto; 
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    width: 100%;
}

.custom-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 800px; /* Scroll horizontal m√≥vil */
}

.custom-table th {
    background-color: #f8fafc;
    color: #475569;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
    letter-spacing: 0.5px;
}

.custom-table td {
    padding: 16px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
    color: #334155;
    vertical-align: middle;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}
.status-pendiente { background-color: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
.status-realizada { background-color: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
.status-cancelada { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

/* =========================================================================
   MODALES ESPEC√çFICOS DE CRONOGRAMA 
   (IMPORTANTE: Restaura el fondo y estilos perdidos)
   ========================================================================= */

/* 1. Fondo Oscuro */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.65); /* Fondo oscuro */
    backdrop-filter: blur(4px);
    z-index: 10000; /* Encima de todo */
    display: flex; justify-content: center; alignItems: center;
    padding: 20px; /* Espacio lateral en m√≥vil */
}

/* 2. Caja del Modal (El "Fondo" que faltaba) */
.modal-box {
    background-color: #ffffff !important; /* FORZAMOS BLANCO */
    width: 550px;
    max-width: 100%;
    border-radius: 20px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden; /* Para que el header no se salga */
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* Altura m√°xima */
    animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes modalPop {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* 3. Partes del Modal "Clean" */
.modal-header-clean {
    padding: 20px 25px;
    border-bottom: 1px solid #f1f5f9;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    background-color: #ffffff; /* Fondo blanco */
}

.modal-header-clean h3 { 
    margin: 0; 
    font-size: 1.4rem; 
    color: #0f172a; 
    font-weight: 700; 
}

.close-btn { 
    background: #f1f5f9;
    border: none; 
    width: 32px; height: 32px; 
    border-radius: 50%; 
    color: #64748b; 
    cursor: pointer; 
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    transition: all 0.2s;
}
.close-btn:hover { background: #e2e8f0; color: #ef4444; }

.modal-body-clean { 
    padding: 25px;
    overflow-y: auto; /* Scroll si es muy largo */
    background-color: #ffffff; /* Fondo blanco */
}

.modal-footer-clean {
    padding: 20px 25px;
    border-top: 1px solid #f1f5f9;
    display: flex; 
    justify-content: flex-end; 
    gap: 12px;
    background-color: #f8fafc; /* Fondo gris claro footer */
}

/* Caja de lectura (Detalle Actividad) */
.read-only-box {
    background: #f8fafc; 
    border: 1px dashed #cbd5e1; 
    padding: 12px;
    border-radius: 8px; 
    min-height: 40px; 
    color: #334155;
    font-size: 0.9rem;
    line-height: 1.5;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    .page-container {
        padding: 15px;
    }

    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .header-actions {
        width: 100%;
        flex-direction: column;
    }

    .header-actions .btn {
        width: 100%;
    }

    /* Filtros Verticales */
    .filters-wrapper {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
    }

    .filter-select-box { width: 100%; }

    /* Ajustes Modales M√≥vil */
    .modal-box {
        max-height: 95vh;
        width: 100%;
    }
    
    .modal-footer-clean {
        flex-direction: column-reverse; /* Botones apilados */
    }
    
    .modal-footer-clean .btn {
        width: 100%;
    }

    /* Calendario */
    .rbc-toolbar {
        flex-direction: column;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px !important;
    }
    .rbc-btn-group {
        display: flex;
        width: 100%;
        justify-content: center;
    }
    .rbc-btn-group button { flex: 1; }
    
    .custom-table th, .custom-table td {
        padding: 10px;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Dashboard.css
==================================================================
/* frontend/src/styles/Dashboard.css */

.dashboard-container {
    padding-bottom: 2rem;
    animation: fadeIn 0.5s ease-out;
}

/* --- TARJETAS KPI (STATS) --- */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background-color: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e1;
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.stat-icon-wrapper {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
}

.stat-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: #0f172a;
    line-height: 1;
    margin-bottom: 5px;
}

.stat-label {
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-subtext {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 5px;
}

/* --- GR√ÅFICAS (GRID) --- */
.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr; /* Izquierda ancha, derecha angosta */
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 900px) {
    .charts-grid {
        grid-template-columns: 1fr; /* Una columna en tablets/m√≥vil */
    }
}

.chart-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.chart-title {
    margin: 0 0 1.5rem 0;
    font-size: 1.1rem;
    color: #1e293b;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* --- ACCESOS R√ÅPIDOS --- */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.action-card {
    background-color: white;
    border: 1px solid #e2e8f0;
    color: #0c4760;
    padding: 1rem;
    border-radius: 12px;
    font-weight: 600;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
}

.action-card:hover {
    background-color: #0c4760;
    color: #ffffff;
    border-color: #0c4760;
    transform: translateY(-2px);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}




==================================================================
ARCHIVO: frontend\src\styles\Designer.css
==================================================================
/* frontend/src/styles/Designer.css */

.designer-grid {
    display: grid;
    grid-template-columns: 2fr 1fr; /* El constructor es m√°s ancho que la asignaci√≥n */
    gap: 2rem;
    align-items: start;
}

@media (max-width: 900px) {
    .designer-grid {
        grid-template-columns: 1fr;
    }
}

.section-card {
    background: white;
    padding: 2rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    border: 1px solid #e2e8f0;
    margin-bottom: 2rem;
}

.card-title {
    font-size: 1.1rem;
    color: var(--color-primary);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 2px solid #f1f5f9;
    padding-bottom: 0.5rem;
}

/* Lista de Preguntas */
.questions-list {
    margin-top: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.question-item {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
    align-items: center;
}

.question-input {
    flex: 1;
    padding: 0.6rem;
    border: 1px solid #cbd5e1;
    border-radius: var(--radius);
    font-size: 0.95rem;
}

.btn-remove {
    background: #fee2e2;
    color: #ef4444;
    width: 36px;
    height: 36px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.2s;
}

.btn-remove:hover {
    background: #ef4444;
    color: white;
}

.btn-add-question {
    background: #e0f2fe;
    color: #0284c7;
    width: 100%;
    padding: 0.8rem;
    border-radius: var(--radius);
    font-weight: 600;
    margin-top: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn-add-question:hover {
    background: #0284c7;
    color: white;
}


==================================================================
ARCHIVO: frontend\src\styles\Drive.css
==================================================================
/* frontend/src/styles/Drive.css */

:root {
    --color-border: #e2e8f0;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
    --color-text: #334155;
    --color-text-secondary: #64748b;
    --color-acento: #0c4760;
    --color-bg: #f8fafc;
}

.drive-container {
    padding: 1.5rem 2rem;
    background-color: var(--color-bg);
    min-height: calc(100vh - 70px);
    font-family: 'Segoe UI', system-ui, sans-serif;
    animation: fadeIn 0.4s ease;
}

/* Clases espec√≠ficas para el contenedor embebido (dentro del modal) */
.file-manager-embedded {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Importante para que el scroll sea interno */
}

/* --- Barra de Herramientas --- */
.docs-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    background-color: #fff;
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-sm);
    flex-wrap: wrap;
    gap: 1rem;
}

.toolbar-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* --- Breadcrumbs (Ruta de carpetas) --- */
.document-breadcrumb {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    flex-wrap: wrap; /* Si la ruta es larga, que baje */
    flex: 1;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 20px;
    transition: background 0.2s, color 0.2s;
    background-color: transparent;
    color: #64748b;
    white-space: nowrap; /* No romper nombres de carpeta */
}

.breadcrumb-item:hover {
    background-color: #f1f5f9;
    color: var(--color-acento);
}

.breadcrumb-item.active {
    background-color: #e0f2fe;
    color: #0369a1;
    font-weight: 600;
    cursor: default;
}

/* --- Botones de Acci√≥n (Crear Carpeta / Subir) --- */
.btn-icon-action {
    border: none;
    height: 38px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0 1rem;
    gap: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: transform 0.1s, background-color 0.2s;
}

.btn-icon-action:active { transform: scale(0.98); }

.btn-icon-action.primary {
    background: var(--color-acento);
    color: white;
    box-shadow: 0 2px 5px rgba(12, 71, 96, 0.2);
}
.btn-icon-action.primary:hover { background: #09425a; }

.btn-icon-action.secondary {
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}
.btn-icon-action.secondary:hover { background: #e2e8f0; color: #1e293b; }


/* --- LISTA DE DOCUMENTOS (TABLA) --- */
.document-list-container {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow-sm);
    flex: 1; /* Ocupar el resto del espacio vertical */
    overflow: hidden; /* Contener el scroll */
    min-height: 300px;
}

/* Cabecera de la lista */
.document-list-header {
    display: grid;
    /* Estructura PC: Icono | Nombre | Acciones */
    /* Ajustamos seg√∫n FileManager.jsx que usa gridTemplateColumns inline, 
       pero aqu√≠ definimos el default para CSS puro si se quitara el inline */
    grid-template-columns: 40px 1fr 100px; 
    padding: 1rem 1.5rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #f1f5f9;
    background-color: #fff;
}

/* Fila de Documento */
.document-row {
    display: grid;
    /* Estructura PC: Icono | Nombre | Acciones */
    grid-template-columns: 40px 1fr 100px;
    align-items: center;
    background-color: #ffffff;
    border-bottom: 1px solid #f1f5f9;
    padding: 0.9rem 1.5rem;
    transition: all 0.15s ease;
    cursor: pointer;
}

.document-row:last-child { border-bottom: none; }

.document-row:hover {
    background-color: #f8fafc;
}

/* Iconos de Archivo */
.doc-icon-wrapper {
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #cbd5e1;
}

/* Colores por tipo */
.icon-folder { color: #f59e0b; }
.icon-pdf { color: #ef4444; }
.icon-word { color: #2563eb; }
.icon-excel { color: #16a34a; }
.icon-img { color: #8b5cf6; }
.icon-default { color: #cbd5e1; }

/* Nombre del Archivo */
.doc-name {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-right: 15px;
}

/* Acciones (Botones de Fila) */
.doc-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    opacity: 0.6; /* Transparente en PC hasta hover */
    transition: opacity 0.2s;
}

.document-row:hover .doc-actions { opacity: 1; }

.btn-row-action {
    background: transparent;
    border: 1px solid transparent;
    color: #94a3b8;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.btn-row-action:hover {
    background-color: #f1f5f9;
    color: var(--color-acento);
    border-color: #e2e8f0;
}

.btn-row-action.delete:hover {
    background-color: #fef2f2;
    color: #ef4444;
    border-color: #fecaca;
}

.btn-row-action.download:hover {
    background-color: #f0f9ff;
    color: #0284c7;
    border-color: #bae6fd;
}

/* Loader */
.spin {
    animation: spin 1s linear infinite;
    color: var(--color-acento);
    font-size: 2rem;
}
@keyframes spin { 100% { transform: rotate(360deg); } }


/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 768px)
   ========================================================================== */
@media (max-width: 768px) {
    
    .drive-container {
        padding: 10px; /* Menos padding general */
    }

    /* 1. Header del Componente (T√≠tulo y Flecha volver) */
    .file-manager-embedded > div:first-child {
        margin-bottom: 0.5rem !important;
    }
    
    .file-manager-embedded h3 {
        font-size: 1rem !important; /* T√≠tulo m√°s peque√±o */
    }

    /* 2. Barra de Herramientas */
    .docs-toolbar {
        flex-direction: column;
        align-items: stretch; /* Botones ancho completo */
        padding: 0.8rem;
        gap: 0.8rem;
    }

    .document-breadcrumb {
        width: 100%;
        overflow-x: auto; /* Scroll horizontal si la ruta es larga */
        white-space: nowrap;
        padding-bottom: 5px; /* Espacio para scrollbar */
    }

    /* Botones de acci√≥n toolbar */
    .docs-toolbar > div:last-child {
        display: flex;
        width: 100%;
        gap: 10px;
    }

    .btn-icon-action {
        flex: 1; /* Botones se reparten el ancho */
        justify-content: center;
    }

    /* 3. Lista de Archivos */
    .document-list-header {
        display: none !important; /* Ocultar cabecera de tabla */
    }

    .document-list-container {
        border-top: 1px solid #e2e8f0;
    }

    /* Ajuste de Fila para M√≥vil */
    /* Importante: Sobrescribimos el grid inline del JSX usando !important si es necesario, 
       pero idealmente el CSS deber√≠a mandar. 
       Estructura M√≥vil: Icono (40px) | Nombre (Auto) | Acciones (80px) */
    .document-row {
        grid-template-columns: 40px 1fr auto !important; 
        padding: 1rem 0.8rem;
        gap: 10px;
    }

    .doc-name {
        font-size: 0.9rem;
        white-space: normal; /* Permitir que el nombre baje de l√≠nea si es largo */
        line-height: 1.3;
    }

    /* Acciones siempre visibles (no hay hover en touch) */
    .doc-actions {
        opacity: 1; 
        gap: 10px; /* Separar m√°s los botones para el dedo */
    }

    .btn-row-action {
        width: 36px;
        height: 36px;
        font-size: 1rem;
        background-color: #f8fafc; /* Fondo suave para que parezcan botones */
        border: 1px solid #e2e8f0;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\GestionTrazabilidad.css
==================================================================
/* frontend/src/styles/GestionTrazabilidad.css */

/* --- CONTENEDOR PRINCIPAL --- */
.traza-container {
    animation: fadeIn 0.4s ease-out;
    padding-bottom: 2rem;
}

/* --- TABS DE NAVEGACI√ìN --- */
.traza-tabs {
    display: flex;
    gap: 5px;
    background: #f1f5f9;
    padding: 5px;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
    flex-wrap: wrap; /* Para m√≥viles */
}

.traza-tabs button {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    background: transparent;
    color: #64748b;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1; /* Distribuci√≥n equitativa */
    justify-content: center;
    white-space: nowrap;
}

.traza-tabs button:hover {
    color: #0c4760;
    background: rgba(255, 255, 255, 0.5);
}

.traza-tabs button.active {
    background: white;
    color: #0c4760;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* --- VISTA: REPOSITORIO (GRID DE CARPETAS) --- */
.section-actions { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; 
    margin-bottom: 1.5rem; 
    flex-wrap: wrap; 
    gap: 10px; 
}

.section-title { margin: 0; font-size: 1.2rem; color: #0c4760; font-weight: 700; }
.section-subtitle { margin: 0; color: #64748b; font-size: 0.9rem; }

.grid-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
}

.doc-card {
    background: white;
    padding: 1.2rem;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.doc-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px rgba(0,0,0,0.05);
    border-color: #cbd5e1;
}

.doc-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.icon-wrapper {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
}

.doc-card h4 { margin: 0; color: #1e293b; font-size: 1rem; font-weight: 600; }
.doc-card p { margin: 5px 0 0 0; fontSize: 0.8rem; color: #64748b; }

/* Bot√≥n "Nueva Carpeta" como tarjeta */
.new-card-btn {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    min-height: 140px;
    color: #94a3b8;
    transition: all 0.2s;
    background: #f8fafc;
}
.new-card-btn:hover {
    border-color: #0c4760;
    color: #0c4760;
    background: #f0f9ff;
}

/* Bot√≥n borrar carpeta */
.btn-icon-delete {
    border: none; 
    background: transparent; 
    color: #ef4444; 
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: background 0.2s;
}
.btn-icon-delete:hover { background: #fee2e2; }


/* --- VISTA: FICHAS T√âCNICAS (LAYOUT DIVIDIDO) --- */
.fichas-layout {
    display: grid;
    grid-template-columns: 1fr 2fr; /* Izquierda subida, Derecha lista */
    gap: 20px;
    align-items: start;
}

/* Paneles Blancos */
.panel-upload, .panel-list {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.panel-upload h3, .panel-list h3 { 
    margin-top: 0; 
    font-size: 1rem; 
    color: #0c4760; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    margin-bottom: 1.5rem;
    font-weight: 700;
}

.full-width { width: 100%; margin-top: 10px; }

/* Cabecera de lista con buscador */
.list-header { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 1rem; 
    align-items: center; 
    flex-wrap: wrap;
    gap: 10px;
}

.search-wrapper { 
    position: relative; 
    flex: 1;
    min-width: 200px; 
}
.search-icon { 
    position: absolute; 
    top: 50%; 
    transform: translateY(-50%); 
    left: 12px; 
    color: #94a3b8; 
}
.search-wrapper input { 
    width: 100%; 
    padding: 8px 8px 8px 35px; 
    border-radius: 20px; 
    border: 1px solid #e2e8f0; 
    outline: none; 
    background: #f8fafc;
    font-size: 0.9rem;
}
.search-wrapper input:focus {
    background: white;
    border-color: #0c4760;
}

/* Items de la lista de Fichas */
.list-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 500px;
    overflow-y: auto;
}

.list-item { 
    display: flex; 
    align-items: center; 
    padding: 12px; 
    border: 1px solid #f1f5f9;
    border-radius: 8px;
    transition: background 0.2s;
}
.list-item:hover { background: #f8fafc; }

.item-icon { margin-right: 15px; color: #0c4760; font-size: 1.2rem; }
.item-info { flex: 1; }
.item-name { font-weight: 600; font-size: 0.9rem; color: #334155; }
.item-date { font-size: 0.75rem; color: #94a3b8; }

/* BOTONES DE ACCI√ìN (Fichas) */
.item-actions { 
    display: flex; 
    gap: 8px; 
}

.btn-action-icon { 
    width: 32px; 
    height: 32px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    color: #64748b; 
    background: white; 
    cursor: pointer; 
    transition: all 0.2s;
}
.btn-action-icon:hover { 
    border-color: #0c4760; 
    color: #0c4760; 
    background: #f0f9ff;
}
.btn-action-icon.delete:hover { 
    border-color: #fee2e2; 
    color: #ef4444; 
    background: #fff1f2;
}

.empty-msg { text-align: center; color: #94a3b8; font-style: italic; padding: 2rem; }


/* --- VISTA: CERTIFICADOS --- */
.btn-group-responsive { display: flex; gap: 10px; }

.search-bar-full {
    background: white; 
    padding: 12px 20px; 
    border-radius: 12px; 
    border: 1px solid #e2e8f0; 
    margin-bottom: 1.5rem; 
    display: flex; 
    align-items: center; 
    gap: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.search-bar-full input { 
    border: none; 
    outline: none; 
    flex: 1; 
    font-size: 0.95rem; 
    color: #334155;
}

/* =========================================
   BOTONES DE ACCI√ìN (TABLA CERTIFICADOS)
   ========================================= */

.action-buttons {
    display: flex;
    gap: 8px; /* Espacio entre botones */
    align-items: center;
    justify-content: flex-end; /* Alinear a la derecha */
}

/* 1. ESTILO BASE UNIFICADO (Para todos los botones) */
.btn-action {
    height: 38px; /* Altura unificada y c√≥moda */
    min-width: 38px; /* Ancho m√≠nimo para que sean cuadrados si son solo icono */
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #64748b;
    font-size: 1rem; /* Iconos un poco m√°s grandes */
    cursor: pointer;
    
    /* Flexbox para centrar perfectamente el contenido */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    padding: 0; /* Sin padding por defecto para que los iconos queden centrados */
}

/* Hover gen√©rico */
.btn-action:hover {
    border-color: #0c4760;
    color: #0c4760;
    background: #f8fafc;
    transform: translateY(-2px); /* Peque√±a elevaci√≥n */
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

/* 2. ESTILO ESPEC√çFICO PARA EL BOT√ìN "GENERAR" (Con texto) */
.btn-action.primary-outline {
    width: auto; /* Permitir que crezca para que quepa el texto */
    padding: 0 16px; /* Espacio amplio a los lados del texto */
    gap: 8px; /* Separaci√≥n entre el icono y la palabra "Generar" */
    
    /* Colores Espec√≠ficos */
    background: #e0f2fe;
    color: #0284c7;
    border-color: #bae6fd;
    font-size: 0.9rem;
    font-weight: 700;
}

.btn-action.primary-outline:hover {
    background: #0c4760;
    color: white;
    border-color: #0c4760;
}
/* IFRAME DASHBOARD */
.iframe-container {
    padding: 0; 
    overflow: hidden; 
    height: 80vh; 
    border-radius: 12px; 
    border: 1px solid #e2e8f0;
}

/* ANIMACIONES */
.fade-in { animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* ==========================================================================
   RESPONSIVE (M√ìVIL)
   ========================================================================== */
@media (max-width: 900px) {
    .fichas-layout {
        grid-template-columns: 1fr; /* Una columna en m√≥vil */
    }
    
    .list-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-wrapper { width: 100%; }

    .hide-mobile { display: none; } /* Ocultar texto de botones en m√≥vil si es necesario */
    
    .iframe-container { height: 60vh; }
    
    .section-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn-group-responsive {
        width: 100%;
    }
    .btn-group-responsive button {
        flex: 1;
        justify-content: center;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\GestorFormularios.css
==================================================================
/* frontend/src/styles/GestorFormularios.css */

/* --- LAYOUT PRINCIPAL --- */
.gestor-layout {
    display: grid;
    grid-template-columns: 320px 1fr; /* Sidebar fijo, resto flexible */
    gap: 1.5rem;
    height: calc(100vh - 180px); /* Ajuste para que no genere doble scroll con el navbar */
    min-height: 500px;
    animation: fadeIn 0.4s ease-out;
}

/* ==========================================================================
   PANEL IZQUIERDO: LISTA DE FORMULARIOS
   ========================================================================== */
.forms-sidebar {
    background-color: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}

/* Buscador */
.forms-search-box {
    padding: 1rem;
    border-bottom: 1px solid #f1f5f9;
    background-color: #ffffff;
    position: relative;
    flex-shrink: 0;
}

.forms-search-box input {
    width: 100%;
    padding: 0.7rem 1rem 0.7rem 2.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.2s;
    background-color: #f8fafc;
    color: #0f172a;
}

.forms-search-box input:focus {
    background-color: white;
    border-color: #0c4760;
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

/* Lista Scrollable */
.forms-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.8rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    /* Scrollbar fina */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

/* Items de la Lista */
.form-list-item {
    padding: 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    background-color: #ffffff;
    position: relative;
}

.form-list-item:hover {
    background-color: #f8fafc;
    border-color: #e2e8f0;
    transform: translateX(2px);
}

.form-list-item.active {
    background-color: #f0f9ff;
    border-color: #bae6fd;
    box-shadow: 0 2px 5px rgba(12, 71, 96, 0.08);
}

.form-list-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 10px;
    bottom: 10px;
    width: 4px;
    background-color: #0c4760;
    border-top-right-radius: 4px;
    border-bottom-right-radius: 4px;
}

.form-item-title {
    font-weight: 700;
    color: #334155;
    font-size: 0.95rem;
    margin-bottom: 0.4rem;
    line-height: 1.3;
}

.form-list-item.active .form-item-title {
    color: #0c4760;
}

.form-item-meta {
    font-size: 0.75rem;
    color: #64748b;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Indicador de Estado (Puntito) */
.status-dot {
    height: 8px;
    width: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}
.status-visible { background-color: #10b981; box-shadow: 0 0 0 2px #dcfce7; }
.status-hidden { background-color: #cbd5e1; }


/* ==========================================================================
   PANEL DERECHO: DETALLE Y PREGUNTAS
   ========================================================================== */
.form-detail-panel {
    background-color: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* --- Header del Detalle --- */
.detail-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background-color: #ffffff;
    flex-wrap: wrap;
    gap: 15px;
    flex-shrink: 0;
}

.detail-title h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    color: #0f172a;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.detail-meta {
    font-size: 0.85rem;
    color: #64748b;
    line-height: 1.6;
}
.detail-meta strong { color: #334155; }

/* Acciones del Header */
.header-actions {
    display: flex;
    gap: 0.8rem;
    align-items: center;
}

.btn-circle-action {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    cursor: pointer;
    font-size: 1.1rem;
}
.btn-circle-action:hover {
    border-color: #0c4760;
    color: #0c4760;
    background-color: #f0f9ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.btn-circle-action.delete:hover {
    border-color: #fee2e2;
    color: #ef4444;
    background-color: #fff1f2;
}

/* Switch Toggle */
.toggle-switch-container {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    color: #475569;
    font-weight: 600;
    padding-right: 1.5rem;
    margin-right: 0.5rem;
    border-right: 1px solid #e2e8f0;
}

.switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1;
    transition: .3s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
input:checked + .slider { background-color: #10b981; }
input:checked + .slider:before { transform: translateX(18px); }

/* --- SECCI√ìN DE PREGUNTAS --- */
.questions-container {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem 2rem;
    background-color: #f8fafc; /* Fondo gris suave para diferenciar */
    display: flex;
    flex-direction: column;
}

.questions-header {
    font-size: 0.8rem;
    font-weight: 800;
    color: #94a3b8;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.questions-list {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    padding-bottom: 1rem;
}

/* Fila de Pregunta Individual */
.question-row {
    background: white;
    padding: 1rem 1.2rem;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: flex-start; /* Alinear arriba si el texto es largo */
    gap: 1rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    transition: all 0.2s;
}

.question-row:hover {
    border-color: #cbd5e1;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.question-number {
    background-color: #e0f2fe;
    color: #0369a1;
    min-width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    margin-top: 2px; /* Alineaci√≥n visual fina */
}

.question-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.question-text span:first-child {
    font-size: 0.95rem;
    color: #334155;
    font-weight: 500;
    line-height: 1.4;
}

/* Badge de Tipo (Texto vs Bool) */
.type-badge {
    font-size: 0.7rem;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    width: fit-content;
}
.type-text { color: #0369a1; background: #f0f9ff; border: 1px solid #bae6fd; }
.type-bool { color: #15803d; background: #f0fdf4; border: 1px solid #bbf7d0; }

.btn-delete-q {
    color: #cbd5e1;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
    margin-left: auto;
}
.btn-delete-q:hover {
    color: #ef4444;
    background-color: #fee2e2;
}

/* --- CAJA PARA AGREGAR NUEVA PREGUNTA --- */
.add-question-box {
    margin-top: auto; /* Empujar al fondo si hay espacio */
    background: white;
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.03); /* Sombra hacia arriba */
    display: flex;
    gap: 10px;
    align-items: stretch;
    position: sticky;
    bottom: 0;
}

.input-new-q {
    flex: 1;
    padding: 0.7rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    outline: none;
    font-size: 0.9rem;
    transition: border-color 0.2s;
    background-color: #f8fafc;
}
.input-new-q:focus {
    background-color: white;
    border-color: #0c4760;
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

/* Selector de Tipo */
.add-question-box select.input-new-q {
    flex: 0 0 160px; /* Ancho fijo para el select */
    font-weight: 600;
    color: #0c4760;
    cursor: pointer;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #94a3b8;
    text-align: center;
    background-color: #f8fafc;
    padding: 2rem;
}
.empty-state svg {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    color: #e2e8f0;
}
.empty-state h3 {
    color: #334155;
    margin: 0 0 0.5rem 0;
    font-size: 1.2rem;
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    .gestor-layout {
        grid-template-columns: 1fr; /* Una sola columna */
        height: auto;
        gap: 1rem;
    }

    /* En m√≥vil, la lista tiene altura fija */
    .forms-sidebar {
        height: 300px;
        order: 1;
    }

    /* El panel de detalle va debajo */
    .form-detail-panel {
        order: 2;
        height: auto;
        min-height: 500px;
    }

    .detail-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }

    .header-actions {
        justify-content: space-between;
        border-top: 1px solid #f1f5f9;
        padding-top: 1rem;
    }

    .toggle-switch-container {
        border-right: none;
        padding-right: 0;
        margin-right: 0;
        flex: 1;
    }

    /* Caja de agregar pregunta en columna */
    .add-question-box {
        flex-direction: column;
        position: relative; /* Ya no sticky en m√≥vil para evitar problemas de teclado */
        bottom: auto;
    }

    .add-question-box select.input-new-q {
        flex: auto;
        width: 100%;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\HistorialReportes.css
==================================================================
/* frontend/src/styles/HistorialReportes.css */

.history-view {
    padding-bottom: 2rem;
    animation: fadeIn 0.4s ease-in-out;
}

/* --- BARRA DE CONTROL (BUSCADOR Y FILTROS) --- */
.control-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 1rem;
}

.search-box {
    position: relative;
    flex: 1;
    min-width: 300px;
}

.search-box svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
}

.search-input {
    width: 100%;
    padding: 0.7rem 1rem 0.7rem 2.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.95rem;
    outline: none;
    transition: all 0.2s;
    background-color: #f8fafc;
}

.search-input:focus {
    background-color: white;
    border-color: #0c4760;
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

.filter-select {
    padding: 0.7rem 2rem 0.7rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background-color: white;
    color: #334155;
    font-weight: 500;
    cursor: pointer;
    outline: none;
}

/* --- TABLA MODERNA (CARD STYLE) --- */
.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px; /* Espacio entre filas */
}

.modern-table thead th {
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    padding: 0 1.5rem;
    text-align: left;
    font-weight: 700;
}

.modern-row {
    background: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    transition: transform 0.2s, box-shadow 0.2s;
}

.modern-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.05);
}

.modern-cell {
    padding: 1.2rem 1.5rem;
    border-top: 1px solid #e2e8f0;
    border-bottom: 1px solid #e2e8f0;
    color: #334155;
    vertical-align: middle;
}

.modern-cell:first-child {
    border-left: 1px solid #e2e8f0;
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
}

.modern-cell:last-child {
    border-right: 1px solid #e2e8f0;
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    text-align: right;
}

/* --- CELDAS ESPECIFICAS --- */
.date-info {
    display: flex;
    flex-direction: column;
}
.date-main { font-weight: 600; color: #0f172a; }
.date-sub { font-size: 0.8rem; color: #94a3b8; }

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}
.user-avatar-small {
    width: 32px;
    height: 32px;
    background: #e0f2fe;
    color: #0369a1;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
}

.asset-info {
    display: flex;
    flex-direction: column;
}
.asset-name { font-weight: 700; color: #0c4760; font-size: 0.95rem; }
.form-name { font-size: 0.8rem; color: #64748b; display: flex; align-items: center; gap: 5px; }

/* --- BADGES --- */
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0.4rem 0.8rem;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
}
.status-pill.danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
.status-pill.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }

/* --- BOTONES DE ACCI√ìN --- */
.action-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn-text-modern {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0.45rem 0.9rem;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background-color: white;
    color: #475569;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-text-modern:hover {
    background-color: #f8fafc;
    border-color: #cbd5e1;
    color: #0f172a;
    transform: translateY(-1px);
}

.btn-acpm-create {
    background-color: #fff1f2;
    color: #be123c;
    border-color: #fecdd3;
}
.btn-acpm-create:hover {
    background-color: #be123c;
    color: white;
    border-color: #be123c;
}

.btn-acpm-view {
    background-color: #ecfdf5;
    color: #059669;
    border-color: #a7f3d0;
}
.btn-acpm-view:hover {
    background-color: #059669;
    color: white;
    border-color: #059669;
}

.empty-state-row {
    text-align: center;
    padding: 3rem;
    color: #94a3b8;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    
    /* 1. Header m√°s compacto */
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
        margin-bottom: 1.5rem;
    }

    /* 2. Barra de Control en Columna */
    .control-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
        padding: 1rem;
    }

    .search-box {
        min-width: 100%;
        width: 100%;
    }

    /* Ajuste para el contenedor de filtros que usa style inline en el JSX */
    .control-bar > div:last-child {
        width: 100%;
        justify-content: space-between;
    }

    .filter-select {
        flex: 1; /* El select ocupa todo el espacio disponible */
    }

    /* 3. Tabla con Scroll Horizontal */
    .modern-table {
        min-width: 800px; /* Ancho m√≠nimo para forzar scroll y no romper dise√±o */
    }

    .modern-cell {
        padding: 1rem 0.8rem; /* Padding reducido */
    }

    /* Botones m√°s grandes para touch */
    .btn-text-modern {
        padding: 0.6rem 1rem; 
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Kiosco.css
==================================================================
/* frontend/src/styles/Kiosco.css */

:root {
    --k-primary: #0c4760;
    --k-primary-light: #156285;
    --k-bg: #f3f4f6;
    --k-white: #ffffff;
    --k-text: #1f2937;
    --k-text-light: #6b7280;
    --k-accent: #f59e0b; /* Amarillo para detalles */
}

body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, sans-serif;
}

.kiosco-container {
    min-height: 100vh;
    background-color: var(--k-bg);
    display: flex;
    flex-direction: column;
}

/* --- TOPBAR --- */
.kiosco-topbar {
    height: 70px;
    background-color: var(--k-white);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    z-index: 10;
    position: sticky;
    top: 0;
}

.brand-kiosco {
    font-size: 1.2rem;
    color: var(--k-primary);
    font-weight: 400;
}
.brand-kiosco strong { font-weight: 700; }

.btn-back-kiosco {
    background: transparent;
    border: 1px solid #e5e7eb;
    padding: 0.5rem 1rem;
    border-radius: 30px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--k-text-light);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}
.btn-back-kiosco:hover {
    background-color: #f9fafb;
    color: var(--k-primary);
    border-color: var(--k-primary);
}

/* --- CONTENT WRAPPER --- */
.kiosco-content {
    flex: 1;
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

/* --- HERO SECTION --- */
.hero-section {
    text-align: center;
    margin-bottom: 3rem;
}
.hero-section h1 {
    color: var(--k-primary);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}
.hero-section p {
    color: var(--k-text-light);
    font-size: 1.1rem;
}

/* --- COURSES GRID (TARJETAS) --- */
.courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 2rem;
}

.course-card {
    background: var(--k-white);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 20px rgba(0,0,0,0.03);
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
    border: 1px solid transparent;
}

.course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.08);
    border-color: #e5e7eb;
}

.course-cover {
    height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: white;
}
.cover-red { background: linear-gradient(135deg, #ef4444, #b91c1c); }
.cover-orange { background: linear-gradient(135deg, #f97316, #c2410c); }

.course-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    height: calc(100% - 140px); /* Asegura altura consistente */
}

.course-tag {
    background-color: #f3f4f6;
    color: var(--k-text-light);
    font-size: 0.75rem;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 700;
    align-self: flex-start;
}

.course-body h3 {
    margin: 10px 0;
    font-size: 1.1rem;
    color: var(--k-text);
    line-height: 1.4;
}

.course-body p {
    font-size: 0.9rem;
    color: var(--k-text-light);
    margin-bottom: 1.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1; /* Empuja el bot√≥n hacia abajo */
}

.btn-start-course {
    width: 100%;
    padding: 0.8rem;
    border: none;
    background-color: #e0f2fe;
    color: #0369a1;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-start-course:hover {
    background-color: #bae6fd;
}

/* --- MATERIAL VIEWER (Visor PDF/Video) --- */
.material-viewer {
    background: var(--k-white);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    padding: 2rem;
    height: 85vh;
    display: flex;
    flex-direction: column;
}

.viewer-header {
    text-align: center;
    margin-bottom: 1.5rem;
}
.viewer-header h2 { margin: 0; color: var(--k-primary); font-size: 1.5rem; }
.viewer-header p { margin: 5px 0 0 0; color: var(--k-text-light); }

.document-frame {
    flex: 1;
    background-color: #f9fafb;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
    position: relative;
}

.document-frame iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.ppt-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    text-align: center;
}
.ppt-icon { font-size: 4rem; color: #f97316; margin-bottom: 1rem; }
.btn-download-ppt {
    margin-top: 1rem;
    background: var(--k-primary);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    display: inline-block;
}

.viewer-footer {
    display: flex;
    justify-content: center;
}

/* --- AUTH CARD (Formulario Datos) --- */
.auth-card {
    max-width: 500px;
    margin: 4rem auto;
    background: white;
    padding: 3rem;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    text-align: center;
}

.auth-header { margin-bottom: 2rem; }
.auth-icon { font-size: 3rem; color: var(--k-primary); margin-bottom: 10px; }

.input-group-kiosco {
    text-align: left;
    margin-bottom: 1.5rem;
}
.input-group-kiosco label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--k-text);
}
.input-group-kiosco input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s;
}
.input-group-kiosco input:focus {
    border-color: var(--k-primary);
}

.form-actions {
    display: flex;
    gap: 15px;
    margin-top: 2rem;
}

.btn-ghost {
    flex: 1;
    background: transparent;
    border: 1px solid #d1d5db;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    color: var(--k-text-light);
}
.btn-action-primary {
    flex: 2;
    background: var(--k-primary);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: background 0.2s;
}
.btn-action-primary:hover { background: var(--k-primary-light); }

/* --- EXAMEN --- */
.exam-container {
    max-width: 800px;
    margin: 2rem auto;
}

.exam-progress {
    margin-bottom: 2rem;
    text-align: center;
    color: var(--k-text-light);
    font-weight: 600;
}
.progress-track {
    height: 10px;
    background: #e5e7eb;
    border-radius: 5px;
    margin-top: 10px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: #10b981;
    transition: width 0.3s ease;
}

.question-card {
    background: white;
    padding: 3rem;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    text-align: center;
}

.question-text {
    font-size: 1.5rem;
    color: var(--k-text);
    margin-bottom: 3rem;
    line-height: 1.4;
}

.options-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.option-button {
    background: white;
    border: 2px solid #e5e7eb;
    padding: 1.5rem;
    border-radius: 12px;
    font-size: 1.1rem;
    color: var(--k-text);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
    width: 100%; /* Asegura ancho completo */
}
.option-button:hover {
    border-color: var(--k-primary);
    background-color: #f0f9ff;
    color: var(--k-primary);
    transform: translateY(-2px);
}

/* --- SUCCESS / FIN --- */
.success-card {
    text-align: center;
    background: white;
    padding: 4rem;
    border-radius: 20px;
    max-width: 600px;
    margin: 4rem auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.1);
}
.success-icon-wrapper {
    font-size: 5rem;
    color: #10b981;
    margin-bottom: 1.5rem;
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.success-card h1 { color: var(--k-primary); margin-bottom: 1rem; }
.success-card p { font-size: 1.1rem; color: var(--k-text-light); margin-bottom: 2rem; line-height: 1.6; }

.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 700;
    margin: 0 auto 1.5rem auto;
}

/* Animaciones */
.fade-in { animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    .kiosco-topbar {
        padding: 0 1rem;
        height: 60px;
    }
    
    .brand-kiosco {
        font-size: 1rem; /* Texto de marca m√°s peque√±o */
    }

    .kiosco-content {
        padding: 1rem; /* Menos padding lateral */
    }

    /* Hero */
    .hero-section h1 { font-size: 1.8rem; }
    .hero-section p { font-size: 1rem; }

    /* Material Viewer (Visor) */
    .material-viewer {
        padding: 1rem;
        height: auto; /* Altura autom√°tica */
        min-height: 80vh; /* Pero ocupa casi toda la pantalla */
    }
    
    .document-frame {
        height: 50vh; /* Altura del iframe en m√≥vil */
    }

    .btn-action-primary {
        width: 100%; /* Bot√≥n "Realizar Evaluaci√≥n" ancho completo */
    }

    /* Auth Card (Datos) */
    .auth-card {
        padding: 1.5rem;
        margin: 1rem auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05); /* Sombra m√°s suave */
    }
    
    .form-actions {
        flex-direction: column-reverse; /* Bot√≥n Volver abajo */
    }

    /* Examen */
    .question-card {
        padding: 1.5rem;
    }
    .question-text {
        font-size: 1.2rem; /* Pregunta m√°s peque√±a */
        margin-bottom: 2rem;
    }

    .options-grid {
        grid-template-columns: 1fr; /* Una sola columna para opciones */
        gap: 1rem;
    }
    
    .option-button {
        padding: 1rem;
        font-size: 1rem;
    }

    /* Resultado Final */
    .success-card {
        padding: 2rem 1.5rem;
        margin: 1rem auto;
    }
    .success-icon-wrapper { font-size: 4rem; }
    .success-card h1 { font-size: 1.5rem; }
}


==================================================================
ARCHIVO: frontend\src\styles\layout.css
==================================================================
/* frontend/src/styles/layout.css */

.layout-container {
    display: flex;
    min-height: 100vh;
    position: relative; 
}

/* MAIN CONTENT - Estilos Base */
.main-content {
    margin-left: var(--sidebar-width);
    flex: 1;
    display: flex;
    flex-direction: column;
    width: calc(100% - var(--sidebar-width));
    transition: margin-left 0.3s ease, width 0.3s ease;
}

.topbar { /* Si tienes estilos de topbar viejos aqu√≠, los puedes borrar o ignorar */
    display: none; /* Navbar.jsx reemplaza esto */
}

.page-content {
    padding: 2rem;
}

/* --- OVERLAY OSCURO (Base) --- */
.mobile-overlay {
    display: none;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    
    /* Contenido ocupa todo el ancho */
    .main-content {
        margin-left: 0 !important; 
        width: 100% !important;
    }

    .page-content {
        padding: 1rem;
    }

    /* Overlay visible cuando men√∫ abierto */
    .mobile-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 900; /* Debajo del sidebar (1000) */
        backdrop-filter: blur(2px);
        animation: fadeInOverlay 0.3s ease;
    }
}

@keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
}


==================================================================
ARCHIVO: frontend\src\styles\Login.css
==================================================================
/* frontend/src/styles/Login.css */

:root {
    /* COLOR FIJO SOLICITADO */
    --login-primary: #0c4760;
    /* Fondos */
    --login-bg-page: #eef2f5;  /* Gris muy suave para el fondo de pantalla */
    --login-bg-card: #ffffff;  /* Blanco puro para la tarjeta */
    
    /* Bordes */
    --login-border: #d1d5db;
}

.login-wrapper {
    min-height: 100vh; /* Asegura altura completa */
    width: 100vw;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--login-bg-page);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    padding: 20px; /* Margen de seguridad para m√≥viles */
}

/* Tarjeta Principal */
.login-card-split {
    display: flex;
    width: 100%;
    max-width: 900px; /* Ancho m√°ximo en PC */
    height: 600px;    /* Altura fija en PC */
    background: var(--login-bg-card);
    /* Sombra elegante y suave */
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
    border-radius: 16px; /* Bordes m√°s redondeados */
    overflow: hidden;
    transition: all 0.3s ease; /* Suavizar cambios de tama√±o */
}

/* --- PANEL IZQUIERDO: AZUL S√ìLIDO --- */
.login-left {
    flex: 1;
    background-color: var(--login-primary); /* COLOR #0c4760 FIJO */
    color: #ffffff;
    padding: 4rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    overflow: hidden; /* Para efectos decorativos si se agregan */
}

.left-content h1 {
    font-size: 2.5rem;
    font-weight: 300; /* Letra fina (Light) para elegancia */
    line-height: 1.1;
    margin-bottom: 1.5rem;
    color: #ffffff !important;
}

.underline-accent {
    width: 60px;
    height: 4px;
    background-color: #ffffff;
    margin-bottom: 1.5rem;
    border-radius: 2px;
}

.left-content p {
    font-size: 1rem;
    font-weight: 300; /* Letra fina */
    color: rgba(255, 255, 255, 0.9);
    max-width: 90%;
    line-height: 1.6;
}

/* --- PANEL DERECHO: FORMULARIO --- */
.login-right {
    flex: 1;
    padding: 3rem 4rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background-color: #ffffff;
    position: relative;
}

/* Logo */
.logo-container {
    text-align: center;
    margin-bottom: 1.5rem;
}

.logo-login {
    max-width: 160px; /* Tama√±o controlado */
    height: auto;
}

/* Nombre de la Empresa */
.company-name {
    text-align: center;
    color: #0f172a !important; /* Casi negro */
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    letter-spacing: -0.5px;
}

/* Subt√≠tulo "Iniciar Sesi√≥n" */
.login-subtitle {
    text-align: center;
    color: #64748b; /* Gris texto */
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 2rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Inputs */
.input-group {
    margin-bottom: 1.2rem;
}

.input-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: #334155;
    font-weight: 600;
}

.input-wrapper {
    display: flex;
    align-items: center;
    border: 1px solid var(--login-border);
    border-radius: 8px; /* Borde redondeado */
    padding: 0 1rem;
    background-color: #f8fafc; /* Fondo input gris muy claro */
    height: 48px;
    transition: all 0.2s;
}

.input-wrapper:focus-within {
    border-color: var(--login-primary); /* Azul al escribir */
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

.input-icon {
    color: #64748b;
    margin-right: 12px;
    font-size: 1rem;
}

.input-wrapper input {
    border: none;
    background: transparent;
    outline: none;
    width: 100%;
    height: 100%;
    font-size: 0.95rem;
    color: #0f172a;
    font-weight: 500;
}

.input-wrapper input::placeholder {
    color: #94a3b8;
}

/* Bot√≥n Ingresar */
.btn-login-split {
    margin-top: 1.5rem;
    background-color: var(--login-primary); /* COLOR #0c4760 FIJO */
    color: #ffffff;
    padding: 1rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 6px rgba(12, 71, 96, 0.2);
}

.btn-login-split:hover {
    background-color: #09425a;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(12, 71, 96, 0.3);
}

.btn-login-split:disabled {
    background-color: #94a3b8;
    cursor: not-allowed;
    transform: none;
}

/* Alertas de error */
.alerta-error {
    background-color: #fef2f2;
    color: #991b1b;
    padding: 0.8rem;
    border: 1px solid #fecaca;
    border-radius: 8px;
    text-align: center;
    font-size: 0.85rem;
    margin-bottom: 1.5rem;
    font-weight: 500;
}

/* Bot√≥n Volver Flotante (Para PC) */
.btn-back-nav {
    position: absolute;
    top: 20px;
    left: 20px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: all 0.2s ease;
    z-index: 10;
}

.btn-back-nav:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: var(--login-primary);
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    .login-wrapper {
        padding: 15px;
        align-items: flex-start; /* Subir contenido en m√≥vil para que no quede cortado */
        overflow-y: auto; /* Permitir scroll si es muy alto */
    }

    .login-card-split {
        flex-direction: column; /* Apilar Verticalmente */
        width: 100%;
        max-width: 450px; /* Ancho m√°ximo para m√≥vil/tablet */
        height: auto; /* Altura autom√°tica seg√∫n contenido */
        margin-top: 30px; /* Espacio para el bot√≥n volver */
    }
    
    /* Panel Azul (Arriba) */
    .login-left {
        padding: 2.5rem 2rem;
        text-align: center;
        align-items: center;
    }

    .left-content h1 {
        font-size: 1.8rem; /* T√≠tulo m√°s peque√±o */
    }
    
    .left-content p {
        font-size: 0.9rem;
    }

    .underline-accent {
        margin: 1rem auto; /* Centrar l√≠nea */
    }

    /* Panel Blanco (Abajo) */
    .login-right {
        padding: 2.5rem 2rem;
    }

    /* Bot√≥n Volver en M√≥vil */
    .btn-back-nav {
        top: 10px;
        left: 10px;
        background-color: white; /* Fondo blanco para que se lea sobre gris */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Modal.css
==================================================================
/* frontend/src/styles/Modal.css */

/* --- FONDO OSCURO (OVERLAY) --- */
.modal-overlay {
    position: fixed;
    top: 0; 
    left: 0;
    width: 100vw; 
    height: 100vh;
    background-color: rgba(15, 23, 42, 0.65); /* Oscuro elegante (Slate-900) */
    backdrop-filter: blur(4px); /* Desenfoque del fondo */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000; /* Encima del Sidebar (1000), debajo de Alertas (200000) */
    padding: 1rem; /* Margen de seguridad en m√≥viles */
    opacity: 0;
    animation: fadeInOverlay 0.3s forwards;
}

@keyframes fadeInOverlay {
    to { opacity: 1; }
}

/* --- CAJA DEL MODAL --- */
.modal-content {
    background-color: #ffffff;
    padding: 0; 
    border-radius: 16px; /* M√°s redondeado */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    width: 100%;
    max-width: 600px; /* Ancho m√°ximo en PC */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    max-height: 90vh; /* Nunca m√°s alto que el 90% de la pantalla */
    transform: scale(0.95);
    animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

@keyframes modalIn {
    to { opacity: 1; transform: scale(1); }
}

/* --- CABECERA --- */
.modal-header {
    background-color: #ffffff;
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0; /* Evita que se aplaste al hacer scroll */
}

.modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #0f172a;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.modal-close-button {
    background: #f1f5f9;
    border: none;
    font-size: 1.2rem;
    color: #64748b;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.modal-close-button:hover { 
    background-color: #e2e8f0;
    color: #ef4444; /* Rojo al pasar el mouse */
}

/* --- CUERPO (SCROLLEABLE) --- */
.modal-body {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    overflow-y: auto;
    background-color: #ffffff;
    /* Scrollbar fina para Webkit */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

/* Inputs y Labels */
.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #334155;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.8rem 1rem;
    font-size: 0.95rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background-color: #f8fafc;
    color: #0f172a;
    outline: none;
    transition: all 0.2s ease;
    font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    background-color: #ffffff;
    border-color: #0c4760; /* Azul Corporativo */
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

/* Grilla para poner campos lado a lado (Nombre | Apellido) */
.form-grid-row {
    display: flex;
    gap: 1rem;
}
.form-col-half { flex: 1; }

/* Caja de Rol o Info Extra */
.role-assignment-box {
    background-color: #fffbeb;
    border: 1px solid #fef3c7;
    padding: 1rem;
    border-radius: 8px;
    color: #92400e;
    font-size: 0.9rem;
}

/* --- FOOTER --- */
.modal-footer {
    padding: 1.2rem 1.5rem;
    background-color: #f8fafc; /* Gris muy suave */
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    flex-shrink: 0;
}

.btn-secondary {
    background-color: white;
    border: 1px solid #cbd5e1;
    color: #475569;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s;
    cursor: pointer;
}
.btn-secondary:hover {
    background-color: #f1f5f9;
    border-color: #94a3b8;
    color: #0f172a;
}

.btn-primary-modal {
    background-color: #0c4760;
    color: white;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 6px rgba(12, 71, 96, 0.2);
    cursor: pointer;
    transition: background 0.2s;
}
.btn-primary-modal:hover {
    background-color: #09425a;
}
.btn-primary-modal:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 768px)
   ========================================================================== */
@media (max-width: 768px) {
    /* 1. Ajuste general del modal */
    .modal-content {
        max-width: 100%; /* Ocupa todo el ancho disponible */
        height: auto;
        max-height: 95vh; /* Casi toda la altura */
        border-radius: 12px;
    }

    /* 2. Cabecera m√°s compacta */
    .modal-header {
        padding: 1rem;
    }
    .modal-header h2 {
        font-size: 1.1rem;
    }

    /* 3. Cuerpo con menos padding */
    .modal-body {
        padding: 1rem;
        gap: 1rem;
    }

    /* 4. ROMPER LAS FILAS (Grid a Columna) */
    /* Los inputs lado a lado se ponen uno debajo del otro */
    .form-grid-row {
        flex-direction: column;
        gap: 1rem;
    }

    /* 5. Inputs con texto legible (evita zoom en iPhone) */
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 16px; /* Tama√±o m√≠nimo seguro para iOS */
        padding: 0.8rem;
    }

    /* 6. Footer: Botones apilados para f√°cil toque */
    .modal-footer {
        flex-direction: column-reverse; /* El bot√≥n principal (Guardar) queda arriba visualmente o abajo seg√∫n prefieras, reverse pone cancelar abajo */
        gap: 0.8rem;
        padding: 1rem;
    }

    .btn-secondary, 
    .btn-primary-modal {
        width: 100%; /* Botones de ancho completo */
        padding: 0.9rem; /* M√°s altos para el dedo */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
}




==================================================================
ARCHIVO: frontend\src\styles\ModalDetallePeso.css
==================================================================
/* frontend/src/styles/ModalDetallePeso.css */

/* --- 1. SECCI√ìN DE INFORMACI√ìN GENERAL --- */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.info-card {
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    transition: transform 0.2s;
}

.info-card:hover {
    border-color: #cbd5e1;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.info-label {
    font-size: 0.7rem;
    font-weight: 800;
    color: #94a3b8;
    text-transform: uppercase;
    margin-bottom: 4px;
    display: block;
    letter-spacing: 0.5px;
}

.info-value {
    font-weight: 600;
    color: #0f172a;
    font-size: 0.95rem;
}

.info-value.highlight {
    color: #0c4760;
}

/* --- 2. CONTENEDOR DE LA GR√ÅFICA --- */
.chart-container {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-bottom: 20px;
    height: 320px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    align-items: center;
}

.chart-title {
    margin: 0;
    color: #0c4760;
    font-size: 1rem;
}

/* --- 3. PAR√ÅMETROS T√âCNICOS --- */
.params-container {
    background: #f0f9ff;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #bae6fd;
    margin-bottom: 20px;
}

.params-title {
    margin: 0 0 10px 0;
    color: #0369a1;
    font-size: 0.95rem;
    font-weight: 700;
}

.params-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    font-size: 0.9rem;
    color: #334155;
}

/* --- 4. CONFIGURACI√ìN DEL REPORTE (ACORDE√ìN) --- */
.config-container {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    background: white;
    margin-bottom: 20px;
}

.config-header-toggle {
    padding: 12px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8fafc;
    transition: background 0.2s;
}

.config-header-toggle:hover {
    background: #f1f5f9;
}

.config-header-toggle.open {
    border-bottom: 1px solid #e2e8f0;
}

.config-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #475569;
    font-size: 0.9rem;
}

.config-body {
    padding: 20px;
    background: white;
    animation: fadeIn 0.3s ease-out;
}

/* --- TEXTOS Y VALORES ESPECIALES --- */
.text-approved {
    color: #10b981; /* Verde */
}
.text-rejected {
    color: #ef4444; /* Rojo */
}

/* frontend/src/styles/ModalDetallePeso.css */

/* ... (mant√©n tus estilos anteriores de info-grid, chart, etc.) ... */

/* --- ESTRUCTURA R√çGIDA PARA EL SCROLL (FIX) --- */

/* 1. El contenedor blanco principal */
.modal-content-fixed {
    display: flex !important;
    flex-direction: column !important;
    width: 100%;
    max-width: 900px;
    
    /* ALTURA FORZADA: Esto es lo que obliga al scroll a aparecer */
    height: 90vh !important; 
    max-height: 90vh !important;
    
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden !important; /* Corta lo que sobre */
    position: relative;
}

/* 2. El encabezado (No se mueve) */
.modal-header-fixed {
    flex: 0 0 auto; /* No crecer, no encoger */
    padding: 15px 20px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    z-index: 10;
}

/* 3. El cuerpo (ESTE ES EL QUE HACE SCROLL) */
.modal-body-scrollable {
    flex: 1 1 auto; /* Crece para ocupar todo el espacio disponible */
    overflow-y: auto !important; /* Scroll vertical OBLIGATORIO */
    overflow-x: hidden;
    padding: 20px;
    background-color: #f8fafc;
    
    /* Fix para navegadores que calculan mal el flex */
    min-height: 0; 
}

/* 4. El pie de p√°gina (No se mueve) */
.modal-footer-fixed {
    flex: 0 0 auto; /* No crecer, no encoger */
    padding: 15px 20px;
    border-top: 1px solid #e2e8f0;
    background: white;
    display: flex;
    justify-content: space-between;
    z-index: 10;
}


==================================================================
ARCHIVO: frontend\src\styles\ModalHistorialCertificados.css
==================================================================
/* frontend/src/styles/ModalHistorialCertificados.css */

.history-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(15, 23, 42, 0.7); /* Backdrop oscuro y elegante */
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease-out;
}

.history-modal-content {
    background: #ffffff;
    width: 90%;
    max-width: 1100px; /* Ancho amplio para ver bien las columnas */
    height: 85vh;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-family: 'Segoe UI', system-ui, sans-serif;
}

/* --- HEADER --- */
.history-modal-header {
    padding: 1.5rem 2rem;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.history-title-block h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.icon-header {
    color: #0ea5e9;
}

.filter-badge-active {
    margin-top: 0.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #e0f2fe;
    color: #0369a1;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 1px solid #bae6fd;
}

.btn-close-modal {
    background: transparent;
    border: none;
    color: #94a3b8;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close-modal:hover {
    background: #eff6ff;
    color: #ef4444;
}

/* --- BODY & SEARCH --- */
.history-modal-body {
    flex: 1;
    padding: 0 2rem 2rem 2rem;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Para que el scroll sea interno en la tabla */
}

.history-search-container {
    padding: 1.5rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.search-input-wrapper {
    position: relative;
    flex: 1;
    max-width: 500px;
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
}

.search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.8rem;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s;
    outline: none;
}

.search-input:focus {
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.results-count {
    font-size: 0.9rem;
    color: #64748b;
}

/* --- TABLA --- */
.history-table-wrapper {
    flex: 1;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.history-table thead {
    background: #f1f5f9;
    position: sticky;
    top: 0;
    z-index: 10;
}

.history-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #475569;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e2e8f0;
}

.history-table tbody tr {
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.1s;
}

.history-table tbody tr:hover {
    background: #f8fafc;
}

.history-table td {
    padding: 0.85rem 1rem;
    vertical-align: middle;
    color: #334155;
    font-size: 0.95rem;
}

/* CELDAS ESPECIFICAS */
.date-cell {
    display: flex;
    flex-direction: column;
}
.date-text { font-weight: 600; color: #334155; font-size: 0.9rem; }
.time-text { font-size: 0.75rem; color: #94a3b8; }

.format-cell {
    font-weight: 600;
    color: #0c4760; /* Color corporativo */
}

.lote-badge {
    display: inline-flex;
    align-items: center;
    background: #f0f9ff;
    color: #0369a1;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
    border: 1px solid #e0f2fe;
}

.client-cell {
    font-weight: 500;
}

.user-cell {
    color: #64748b;
    font-size: 0.85rem;
}

.btn-pdf-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    background: #fff1f2;
    color: #e11d48;
    border-radius: 8px;
    border: 1px solid #fecdd3;
    transition: all 0.2s;
}

.btn-pdf-action:hover {
    background: #e11d48;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.2);
}

.state-cell {
    text-align: center;
    padding: 3rem;
    color: #94a3b8;
    font-style: italic;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.98); }
    to { opacity: 1; transform: scale(1); }
}


==================================================================
ARCHIVO: frontend\src\styles\Navbar.css
==================================================================
/* frontend/src/styles/Navbar.css */

.navbar {
    height: 70px;
    background-color: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between; 
    padding: 0 2rem;
    position: sticky;
    top: 0;
    z-index: 900;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}

/* --- BOT√ìN HAMBURGUESA --- */
.btn-hamburger {
    display: none; 
    background: transparent;
    border: none;
    font-size: 1.5rem;
    color: #0c4760;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background 0.2s;
}

.btn-hamburger:hover {
    background-color: #f1f5f9;
}

/* --- ACCIONES DERECHA --- */
.navbar-actions {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-left: auto; 
}

.nav-action-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: opacity 0.2s;
}

/* Configurar Correo (Rojo) */
.danger-link {
    color: #dc2626;
    font-weight: 600;
}
.danger-link svg { font-size: 1.1rem; }
.danger-link:hover { opacity: 0.8; }

/* Icono Campana */
.icon-only {
    color: #6b7280;
    font-size: 1.2rem;
    position: relative; /* Para el badge */
    display: flex;
    align-items: center;
    justify-content: center;
}
.icon-only:hover { color: #1f2937; }

/* Badge Rojo (Contador) */
.bell-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background-color: #ef4444;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 5px;
    border-radius: 10px;
    min-width: 16px;
    text-align: center;
    border: 1px solid white;
}

/* Separador Vertical */
.nav-divider {
    width: 1px;
    height: 30px;
    background-color: #e5e7eb;
}

/* Info Usuario */
.user-info {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    line-height: 1.2;
}

.user-role { font-size: 0.75rem; color: #6b7280; }
.user-name { font-size: 0.9rem; font-weight: 700; color: #0c4760; }

/* Avatar */
.user-avatar {
    width: 40px;
    height: 40px;
    background-color: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.1rem;
    position: relative;
    flex-shrink: 0;
}

.status-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 10px;
    height: 10px;
    background-color: #dc2626;
    border: 2px solid white;
    border-radius: 50%;
}

/* Bot√≥n Cerrar Sesi√≥n */
.btn-logout-nav {
    background-color: transparent;
    border: 1px solid #dc2626;
    color: #dc2626;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-logout-nav:hover {
    background-color: #dc2626;
    color: white;
}

/* --- DROPDOWN NOTIFICACIONES --- */
.notif-dropdown {
    position: absolute;
    top: 50px; /* Un poco m√°s abajo */
    right: -10px;
    width: 320px; /* Un poco m√°s ancho */
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15);
    z-index: 2000;
    overflow: hidden;
    animation: fadeIn 0.2s ease;
}

.notif-header {
    padding: 12px 15px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 700;
    color: #0c4760;
    font-size: 0.85rem;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
}

.notif-list {
    max-height: 350px;
    overflow-y: auto;
}

.notif-empty {
    padding: 30px 20px;
    text-align: center;
    color: #94a3b8;
    font-size: 0.9rem;
}

/* √çtem de Notificaci√≥n */
.notif-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
    position: relative; /* Clave para posicionar elementos dentro */
    align-items: flex-start; /* Alinear arriba */
}

.notif-item:hover { background-color: #f0f9ff; }
.notif-item:last-child { border-bottom: none; }

.notif-danger { background-color: #fff1f2; }
.notif-danger:hover { background-color: #ffe4e6; }

.notif-icon {
    margin-top: 2px;
    color: #0c4760;
    font-size: 1.1rem;
    flex-shrink: 0;
}
.notif-danger .notif-icon { color: #ef4444; }

.notif-content {
    flex: 1; /* Ocupa todo el espacio disponible */
    padding-right: 5px; /* Espacio para no chocar con la X */
}

.notif-title {
    font-weight: 600;
    font-size: 0.85rem;
    color: #1e293b;
    margin-bottom: 2px;
    line-height: 1.3;
}

.notif-msg {
    font-size: 0.8rem;
    color: #64748b;
    line-height: 1.3;
    margin-bottom: 4px;
}

.notif-date {
    font-size: 0.7rem;
    color: #94a3b8;
    text-align: right;
}

/* --- BOT√ìN ELIMINAR (LA 'X') --- */
.btn-delete-notif {
    background: transparent;
    border: none;
    color: #94a3b8; /* Gris visible */
    cursor: pointer;
    padding: 4px; /* √Årea de toque */
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem; /* Tama√±o de la X */
    transition: all 0.2s;
    flex-shrink: 0; /* Que no se aplaste */
    margin-top: -2px; /* Alineaci√≥n fina */
}

.btn-delete-notif:hover {
    color: #ef4444; /* Rojo al pasar el mouse */
    background-color: rgba(239, 68, 68, 0.1);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* RESPONSIVE */
@media (max-width: 900px) {
    .navbar { padding: 0 1rem; }
    .btn-hamburger { display: block; }
    .navbar-actions { margin-left: 0; gap: 0.8rem; }
    .hide-on-mobile { display: none; }
    .user-info { display: none; }
    .nav-divider { display: none; }
    
    /* Dropdown ajustado a m√≥vil */
    .notif-dropdown {
        position: fixed; /* Fijo en pantalla */
        top: 60px;
        left: 10px;
        right: 10px;
        width: auto; /* Ancho autom√°tico */
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Reportes.css
==================================================================
/* frontend/src/styles/Reportes.css */

/* --- DASHBOARD COLABORADOR --- */
.colaborador-dashboard {
    max-width: 800px;
    margin: 0 auto;
    padding: 1rem;
    animation: fadeIn 0.5s ease;
}

.welcome-banner h1 {
    font-size: 1.8rem;
    color: #0c4760;
    margin-bottom: 0.2rem;
}
.welcome-banner p {
    color: #64748b;
    margin-bottom: 2rem;
}

/* Bot√≥n Gigante (Estilo Base PC) */
.btn-big-action {
    width: 100%;
    background: linear-gradient(135deg, #0c4760, #0ea5e9);
    border: none;
    border-radius: 16px;
    padding: 2.5rem;
    color: white;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 10px 20px rgba(12, 71, 96, 0.2);
    transition: transform 0.2s, box-shadow 0.2s;
    /* El margen bottom se maneja en el grid container normalmente, 
       pero se mantiene por compatibilidad si se usa fuera */
    margin-bottom: 0; 
}

.btn-big-action:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(12, 71, 96, 0.3);
}

.icon-circle {
    background: rgba(255, 255, 255, 0.2);
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.btn-big-action span {
    font-size: 1.4rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Tabla Historial Limpia */
.history-section h3 {
    font-size: 1.1rem;
    color: #334155;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.table-container-clean {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
    overflow-x: auto; /* Scroll horizontal si es necesario */
}

.clean-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px; /* Ancho m√≠nimo para forzar scroll en m√≥viles muy peque√±os */
}

.clean-table th {
    background: #f8fafc;
    text-align: left;
    padding: 1rem;
    font-size: 0.8rem;
    color: #64748b;
    text-transform: uppercase;
    font-weight: 700;
}

.clean-table td {
    padding: 1rem;
    border-top: 1px solid #f1f5f9;
    color: #1e293b;
    font-size: 0.95rem;
}

.tag {
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 700;
    white-space: nowrap;
}
.tag-success { background: #dcfce7; color: #166534; }
.tag-fail { background: #fee2e2; color: #991b1b; }

/* --- WIZARD PRO (PASO A PASO) --- */
.wizard-container {
    max-width: 700px;
    margin: 0 auto;
    background: white;
    min-height: 90vh;
    box-shadow: 0 0 20px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
}

.wizard-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    position: sticky;
    top: 0;
    z-index: 10;
}

.btn-back {
    background: none;
    border: none;
    color: #64748b;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 1rem;
}

.step-indicator {
    font-size: 0.85rem;
    color: #94a3b8;
    font-weight: 600;
}

.step-content {
    padding: 2rem;
    animation: fadeIn 0.3s ease;
    flex: 1; /* Para que ocupe el espacio disponible */
}

.step-content h2 {
    font-size: 1.5rem;
    color: #0f172a;
    margin-bottom: 1.5rem;
    text-align: center;
}

.highlight { color: #0c4760; }

/* Grid de Tarjetas Profesionales */
.grid-pro {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.card-pro {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}

.card-pro:hover {
    border-color: #0c4760;
    background: #f8fafc;
    transform: translateX(5px);
}

.card-icon {
    font-size: 1.5rem;
    color: #0c4760;
    background: #e0f2fe;
    width: 45px;
    height: 45px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.card-info h3 {
    margin: 0;
    font-size: 1rem;
    color: #1e293b;
}
.card-info span {
    font-size: 0.8rem;
    color: #64748b;
}

/* Checklist Pro (Paso 3) */
.form-header-pro {
    text-align: center;
    margin-bottom: 2rem;
}
.badge-pro {
    background: #f1f5f9;
    padding: 0.3rem 0.8rem;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #64748b;
    font-weight: 600;
}

/* Fila de Pregunta */
.question-row-pro {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.q-number {
    font-weight: 700;
    color: #cbd5e1;
    font-size: 1.2rem;
    min-width: 30px; /* Ancho fijo para alinear */
}

.q-text {
    flex: 1;
    font-size: 1rem;
    color: #334155;
    line-height: 1.4;
}

.btn-option {
    border: 1px solid #e2e8f0;
    background: white;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    color: #94a3b8;
    display: flex;
    align-items: center;
    justify-content: center; /* Centrar contenido */
    gap: 5px;
    transition: all 0.2s;
    min-width: 80px; /* Ancho m√≠nimo */
}

.btn-option.pass.selected {
    background: #16a34a;
    color: white;
    border-color: #16a34a;
}

.btn-option.fail.selected {
    background: #dc2626;
    color: white;
    border-color: #dc2626;
}

.q-actions { 
    display: flex;
    gap: 0.5rem; 
}

/* Evidencias */
.evidence-section-pro {
    margin-top: 2rem;
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
}

.file-custom-label {
    background: white;
    border: 1px solid #cbd5e1;
    padding: 0.8rem;
    text-align: center;
    border-radius: 6px;
    cursor: pointer;
    color: #475569;
    font-weight: 500;
}

.file-input-wrapper {
    position: relative;
    margin-bottom: 1rem;
}
.file-input-wrapper input {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.input-observaciones {
    width: 100%;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    padding: 0.8rem;
    margin-top: 1rem;
    font-family: inherit;
}

.btn-submit-pro {
    width: 100%;
    background: #0c4760;
    color: white;
    padding: 1rem;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    margin-top: 2rem;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.success-view {
    text-align: center;
    padding: 3rem;
}
.success-icon {
    font-size: 4rem;
    color: #10b981;
    margin-bottom: 1rem;
}

/* --- ESTILOS BUSCADOR ACTIVO --- */
.asset-search-container {
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
}

.search-bar-large {
    position: relative;
    width: 100%;
    max-width: 500px;
}

.search-icon-large {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.2rem;
}

.search-bar-large input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    background-color: #f8fafc;
}

.search-bar-large input:focus {
    border-color: #0c4760;
    background-color: white;
    box-shadow: 0 4px 12px rgba(12, 71, 96, 0.1);
}

.category-tabs {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.cat-tab {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    background-color: white;
    color: #64748b;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
}

.cat-tab:hover { background-color: #f1f5f9; color: #0c4760; }
.cat-tab.active {
    background-color: #0c4760;
    color: white;
    border-color: #0c4760;
    box-shadow: 0 2px 5px rgba(12, 71, 96, 0.2);
}

/* Tarjetas de Activo Modernas */
.card-asset-modern {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.2rem;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.card-asset-modern:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: #0c4760;
}

.card-asset-modern::before {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #0c4760, #0ea5e9);
    opacity: 0;
    transition: opacity 0.2s;
}
.card-asset-modern:hover::before { opacity: 1; }

.card-asset-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.asset-icon-circle {
    width: 45px;
    height: 45px;
    background-color: #e0f2fe;
    color: #0369a1;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
}

.asset-code-badge {
    background-color: #f1f5f9;
    color: #475569;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.card-asset-body h3 {
    margin: 0 0 0.3rem 0;
    font-size: 1.1rem;
    color: #1e293b;
    font-weight: 700;
}

.asset-type {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
    margin-bottom: 1rem;
}

.card-asset-footer {
    margin-top: auto;
    border-top: 1px solid #f1f5f9;
    padding-top: 0.8rem;
}

.asset-location {
    font-size: 0.8rem;
    color: #94a3b8;
    display: flex;
    align-items: center;
    gap: 5px;
}

.empty-search {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: #94a3b8;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.selected-asset-summary {
    background-color: #f0f9ff;
    border-left: 4px solid #0c4760;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
    color: #334155;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    
    /* --- DASHBOARD --- */
    .colaborador-dashboard {
        padding: 1rem;
    }

    /* Transformar botones gigantes de Cuadrado a Fila (Icono izq - Texto der) */
    /* Apunta al contenedor div grid del JSX */
    .colaborador-dashboard > div[style*="grid"] {
        grid-template-columns: 1fr !important;
        gap: 15px !important;
        margin-bottom: 2rem !important;
    }

    .btn-big-action {
        padding: 1.2rem;
        flex-direction: row; /* Horizontal */
        align-items: center;
        justify-content: flex-start;
        text-align: left;
        border-radius: 12px;
    }

    .icon-circle {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
        margin-right: 15px; /* Espacio entre icono y texto */
    }

    .btn-big-action span {
        font-size: 1.1rem; /* Texto un poco m√°s peque√±o */
    }

    /* --- WIZARD GENERAL --- */
    .wizard-container {
        box-shadow: none; /* Sin sombra en m√≥vil para ganar espacio */
        height: auto;
        min-height: calc(100vh - 70px);
    }

    .wizard-header {
        padding: 0.8rem 1rem;
    }

    .step-content {
        padding: 1.5rem 1rem; /* Menos padding lateral */
    }

    .step-content h2 {
        font-size: 1.3rem;
    }

    /* Grid de tarjetas (1 columna) */
    .grid-pro {
        grid-template-columns: 1fr; 
    }

    /* --- CHECKLIST (PREGUNTAS) --- */
    .question-row-pro {
        flex-direction: column; /* Pregunta arriba, botones abajo */
        align-items: flex-start;
        gap: 10px;
        padding: 1.2rem 0;
    }

    .q-number {
        font-size: 0.9rem;
        margin-bottom: 5px;
        background: #e2e8f0;
        padding: 2px 8px;
        border-radius: 10px;
    }

    .q-text {
        font-size: 1rem;
        font-weight: 600; /* M√°s peso para leer mejor */
        margin-bottom: 5px;
        width: 100%;
    }

    /* Botones S√ç/NO ocupan el ancho completo */
    .q-actions {
        width: 100%;
        display: flex;
        gap: 10px;
    }

    .btn-option {
        flex: 1; /* 50% cada uno */
        padding: 0.8rem;
        font-size: 1rem;
        justify-content: center;
    }

    /* Evidencia */
    .evidence-section-pro {
        padding: 1rem;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Sidebar.css
==================================================================
/* frontend/src/styles/Sidebar.css */

.sidebar {
    width: var(--sidebar-width);
    height: 100vh;
    
    /* CAMBIO: Degradado de Azul Oscuro Profundo (#051e2b) a Negro Puro (#000000) */
    background: linear-gradient(180deg, #2e4f80 0%, #000000 100%);
    
    color: #ffffff;
    display: flex;
    flex-direction: column;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 1000;
    box-shadow: 4px 0 10px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
}

/* --- CABECERA (LOGO Y T√çTULO) --- */
.sidebar-header {
    height: 16%;
    margin-top: 3%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: -10%;
    padding: 0rem 1.5rem;
    
    /* CAMBIO: Transparente para que se vea el degradado del fondo principal */
    background-color: transparent; 
    
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
    position: relative; 
}

.sidebar-logo-img {
    width: 180px;
    height: auto;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    margin-bottom: 2.5rem;
    transition: transform 0.2s;
}

.sidebar-logo-img:hover {
    transform: scale(1.05);
}

/* T√çTULO DEL SISTEMA */
.system-title {
    display: block;
    font-size: 0.75rem;
    font-weight: 700;
    color: #ffffff !important;
    position: absolute;
    text-align: center;
    line-height: 1.4;
    width: 100%;
    margin-bottom: -4rem;
}

/* --- NAVEGACI√ìN --- */
.sidebar-nav {
    flex: 1;
    overflow-y: auto;
    padding-top: 0rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.sidebar-nav::-webkit-scrollbar {
    display: none;
}

/* Etiquetas de Secci√≥n */
.sidebar-section-label {
    padding: 1.5rem 1.5rem 0.5rem 1.8rem;
    font-size: 0.7rem;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.sidebar-section-label:first-child {
    border-top: none;
    margin-top: 0;
}

/* --- √çTEMS DEL MEN√ö --- */
.menu-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.9rem 1.5rem;
    color: #ffffff;
    text-decoration: none;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.2s;
    border-left: 4px solid transparent;
    cursor: pointer;
}

.menu-item-content {
    display: flex;
    align-items: center;
}

.menu-item svg {
    font-size: 1.2rem;
    margin-right: 14px;
    opacity: 1;
    width: 20px;
    text-align: center;
    color: #ffffff;
}

.menu-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
    padding-left: 1.8rem;
}

.menu-item.active {
    background-color: #0c3760; /* Mantenemos este azul s√≥lido para resaltar la selecci√≥n */
    border-left-color: #ffffff;
    color: #ffffff;
    font-weight: 700;
}

/* --- FOOTER --- */
.sidebar-footer {
    /* CAMBIO: Transparente para mantener el degradado continuo hasta el final */
    background-color: transparent; 
    
    padding: 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
    flex-shrink: 0;
}

.footer-role-label {
    display: block; 
    font-size: 0.75rem; 
    color: rgba(255, 255, 255, 0.7); 
    margin-bottom: 0.3rem;
    text-transform: uppercase;
}

.footer-user-name {
    display: block; 
    font-size: 1rem; 
    font-weight: 700; 
    color: #ffffff; 
    margin-bottom: 0;
    letter-spacing: 0.5px;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET)
   ========================================================================== */
@media (max-width: 900px) {
    .sidebar {
        transform: translateX(-100%);
        width: 280px;
        box-shadow: none;
    }

    .sidebar.open {
        transform: translateX(0);
        box-shadow: 10px 0 30px rgba(0,0,0,0.5);
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Tables.css
==================================================================
/* frontend/src/styles/Tables.css */

/* --- CABECERA DE P√ÅGINA --- */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap; /* Permite que los elementos bajen si no caben */
    gap: 1rem; /* Espacio entre t√≠tulo y bot√≥n */
}

.page-title {
    font-size: 1.8rem;
    color: #000000;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin: 0;
    border: none;
    line-height: 1.2;
}

/* --- CONTENEDOR DE LA TABLA --- */
.table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    border: 1px solid #e2e8f0;
    overflow: hidden; /* Oculta bordes rectos */
    overflow-x: auto; /* IMPORTANTE: Permite scroll horizontal en m√≥vil */
    width: 100%;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
    white-space: nowrap; /* Evita que el texto se parta en l√≠neas extra√±as */
}

/* --- CABECERA DE TABLA --- */
.data-table th {
    background-color: #f8fafc; /* Gris muy claro */
    color: #475569; /* Gris oscuro para el encabezado */
    font-weight: 700;
    padding: 1.2rem 1.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid #e2e8f0;
}

/* --- CELDAS --- */
.data-table td {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    color: #1e293b; /* Negro suave */
    font-size: 0.9rem;
    vertical-align: middle;
}

/* Fila Hover */
.data-table tr {
    transition: background-color 0.15s ease;
}
.data-table tr:hover {
    background-color: #f8fafc;
}

/* --- BADGES (ETIQUETAS DE ESTADO) --- */
.badge {
    padding: 0.35rem 0.8rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    line-height: 1;
    white-space: nowrap; /* Mantiene la etiqueta en una l√≠nea */
}

.badge-success {
    background-color: #dcfce7;
    color: #166534;
    border: 1px solid #bbf7d0;
}

.badge-danger {
    background-color: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
}

.badge-warning {
    background-color: #fff7ed;
    color: #c2410c;
    border: 1px solid #fdba74;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    
    /* 1. Ajuste de Cabecera */
    .page-header {
        flex-direction: column; /* Apilar verticalmente */
        align-items: flex-start; /* Alinear a la izquierda */
        gap: 15px;
        margin-bottom: 1.5rem;
    }

    .page-title {
        font-size: 1.5rem; /* T√≠tulo un poco m√°s peque√±o */
    }

    /* El bot√≥n de acci√≥n (ej: Nuevo Usuario) ocupar√° todo el ancho para f√°cil acceso */
    .page-header button {
        width: 100%;
        justify-content: center;
    }

    /* 2. Ajuste de Tabla */
    .table-container {
        /* Borde m√°s sutil en m√≥vil */
        border-radius: 8px; 
    }

    .data-table {
        /* Forzamos un ancho m√≠nimo para que las columnas no se aplasten.
           Esto activa el scroll horizontal del .table-container */
        min-width: 800px; 
    }

    /* Reducimos el padding para que quepa m√°s info en pantallas medianas */
    .data-table th, 
    .data-table td {
        padding: 1rem 1rem; 
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Usuarios.css
==================================================================
/* frontend/src/styles/Usuarios.css */

/* --- BARRA DE FILTROS --- */
.filters-bar {
    background-color: #ffffff;
    padding: 1rem;
    border-radius: 12px;
    /* Sombra suave que la hace "flotar" */
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap; /* Permite que los elementos bajen si no caben en pantallas intermedias */
}

/* Input de B√∫squeda */
.search-input-container {
    position: relative;
    flex: 2; /* Ocupa el doble de espacio que el select en PC */
    min-width: 300px;
}

.search-input-container svg {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.1rem;
    pointer-events: none;
}

.search-input-container input {
    width: 100%;
    height: 50px;
    padding-left: 48px !important;
    padding-right: 1rem;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background-color: #f8fafc; /* Fondo gris claro */
    font-size: 0.95rem;
    color: #0f172a;
    outline: none;
    transition: all 0.2s ease;
}

.search-input-container input:focus {
    background-color: #ffffff;
    border-color: #0c4760; /* Color primario */
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

/* Selector */
.filter-select-container {
    flex: 1;
    min-width: 200px;
}

.filter-select-container select {
    width: 100%;
    height: 50px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background-color: #f8fafc;
    padding: 0 1rem;
    font-size: 0.95rem;
    color: #334155;
    cursor: pointer;
    outline: none;
    font-weight: 500;
    transition: all 0.2s ease;
}
.filter-select-container select:focus {
    border-color: #0c4760; /* Color primario */
    background-color: #ffffff;
    box-shadow: 0 0 0 3px rgba(12, 71, 96, 0.1);
}

/* --- BOT√ìN NUEVO USUARIO (Destacado) --- */
.btn-new-user {
    background-color: #0c4760; /* Color primario */
    color: white;
    padding: 0.9rem 1.8rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    box-shadow: 0 4px 6px rgba(12, 71, 96, 0.25);
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    white-space: nowrap;
}
.btn-new-user:hover {
    background-color: #083548;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(12, 71, 96, 0.3);
}

/* Botones de Acci√≥n (Tabla) */
.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background-color: #ffffff;
    color: #64748b;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 1rem;
}

/* Colores al pasar el mouse (Hover) */
.btn-edit:hover { 
    border-color: #0c4760; 
    background-color: #f0f9ff; 
    color: #0c4760;
}
.btn-toggle-off:hover { /* Inactivar */
    border-color: #ef4444; 
    background-color: #fef2f2; 
    color: #ef4444;
}
.btn-toggle-on:hover { /* Activar */
    border-color: #10b981; 
    background-color: #ecfdf5; 
    color: #10b981;
}
.btn-reset:hover { 
    border-color: #f59e0b; 
    background-color: #fffbeb; 
    color: #d97706;
}

/* ==========================================================================
   RESPONSIVE (M√ìVIL Y TABLET < 900px)
   ========================================================================== */
@media (max-width: 900px) {
    
    /* 1. Barra de Filtros en Columna */
    .filters-bar {
        flex-direction: column; /* Apilar verticalmente */
        align-items: stretch; /* Estirar hijos al ancho completo */
        gap: 15px; /* M√°s espacio vertical entre inputs */
        padding: 1rem;
    }

    /* 2. Inputs al 100% de ancho */
    .search-input-container {
        width: 100%;
        min-width: auto; /* Eliminar restricci√≥n m√≠nima */
        flex: none; /* Dejar de usar flex grow */
    }

    .filter-select-container {
        width: 100%;
        min-width: auto;
        flex: none;
    }

    /* 3. Ajuste de Botones de Acci√≥n en M√≥vil */
    /* Asegurar que sean f√°ciles de tocar */
    .btn-action {
        width: 40px; /* Un poco m√°s grandes */
        height: 40px;
    }
}


==================================================================
ARCHIVO: frontend\src\styles\Welcome.css
==================================================================
/* frontend/src/styles/Welcome.css */

.welcome-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f8fafc; /* Fondo gris muy claro */
    font-family: 'Segoe UI', system-ui, sans-serif;
    padding: 20px;
}

.welcome-content {
    width: 100%;
    max-width: 900px;
    text-align: center;
}

/* HEADER Y LOGO */
.welcome-logo {
    max-width: 220px;
    margin-bottom: 2rem;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
}

.welcome-title {
    font-size: 2.2rem;
    color: #0c4760; /* Tu azul corporativo */
    margin-bottom: 0.5rem;
    font-weight: 700;
}

.welcome-subtitle {
    font-size: 1.1rem;
    color: #64748b;
    margin-bottom: 2rem;
}

.welcome-instruction {
    color: #475569;
    margin-bottom: 2rem;
}

/* GRID DE TARJETAS */
.welcome-grid {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
}

.welcome-card {
    background: white;
    padding: 40px 30px;
    border-radius: 16px;
    width: 260px;
    text-decoration: none;
    color: inherit;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.welcome-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border-color: #e2e8f0;
}

/* ICONOS */
.card-icon-wrapper {
    font-size: 2.5rem;
    margin-bottom: 1.5rem;
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.icon-admin { color: #0c4760; background-color: #f0f9ff; }
.icon-collab { color: #0ea5e9; background-color: #e0f2fe; }
.icon-kiosco { color: #16a34a; background-color: #dcfce7; } /* Verde para capacitaci√≥n */

.welcome-card:hover .icon-admin { background-color: #0c4760; color: white; }
.welcome-card:hover .icon-collab { background-color: #0ea5e9; color: white; }
.welcome-card:hover .icon-kiosco { background-color: #16a34a; color: white; }

/* TEXTOS TARJETAS */
.welcome-card h3 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
}

.welcome-card p {
    font-size: 0.9rem;
    color: #64748b;
    line-height: 1.4;
}

/* FOOTER */
.welcome-footer {
    margin-top: 4rem;
    font-size: 0.8rem;
    color: #94a3b8;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .welcome-grid {
        flex-direction: column;
        align-items: center;
    }
    .welcome-card {
        width: 100%;
        max-width: 300px;
    }
}


==================================================================
ARCHIVO: frontend\src\utils\pdfCertificadoGenerator.js
==================================================================
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import logoImg from '../assets/logo_eltrece.png'; 

/**
 * Genera un PDF basado en la estructura de la plantilla y los datos llenados.
 * @param {string} plantillaNombre - Nombre del formato (ej: "Certificado de Calidad")
 * @param {string|object} estructuraJSON - La estructura de secciones, campos y columnas
 * @param {object} datosGuardados - Objeto con { form, tables, header, footer }
 * @param {boolean|string} returnBlob - Controla el retorno:
 * - false (default): Descarga el archivo al PC.
 * - true: Retorna el objeto BLOB (para subir al servidor).
 * - 'bloburl': Retorna una URL temporal (para previsualizar en iframe).
 */
export const generarPDFDesdeDatos = (plantillaNombre, estructuraJSON, datosGuardados, returnBlob = false) => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);

    // Colores y Estilos
    const drawColor = 0; // Negro
    const lineWidth = 0.3;

    // Desestructurar datos
    const { form: formData, tables: tableData, header: customHeader, footer: customFooter } = datosGuardados;

    // Parsear estructura si viene como string
    let seccionesRender = [];
    try {
        const estructuraTotal = typeof estructuraJSON === 'string' ? JSON.parse(estructuraJSON) : estructuraJSON;
        // Soporte para versiones antiguas (array directo) o nuevas (objeto con metadata)
        seccionesRender = Array.isArray(estructuraTotal) ? estructuraTotal : (estructuraTotal.secciones || []);
    } catch (e) {
        console.error("Error al leer la estructura de la plantilla:", e);
        return;
    }

    // --- FUNCI√ìN INTERNA: DIBUJAR CABECERA EN CADA P√ÅGINA ---
    const drawHeaderOnPage = (docInstance) => {
        const startY = 10;
        const fullHeight = 25; 
        
        // Caja Principal
        docInstance.setDrawColor(drawColor);
        docInstance.setLineWidth(lineWidth);
        docInstance.rect(margin, startY, contentWidth, fullHeight);

        // L√≠neas divisorias verticales
        const logoColWidth = 40;
        const infoColWidth = 45;
        const titleColWidth = contentWidth - logoColWidth - infoColWidth;

        docInstance.line(margin + logoColWidth, startY, margin + logoColWidth, startY + fullHeight);
        docInstance.line(margin + logoColWidth + titleColWidth, startY, margin + logoColWidth + titleColWidth, startY + fullHeight);

        // 1. LOGO
        try {
            const imgProps = docInstance.getImageProperties(logoImg);
            const imgWidth = 30;
            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
            const logoY = startY + (fullHeight - imgHeight) / 2;
            const logoX = margin + (logoColWidth - imgWidth) / 2;
            docInstance.addImage(logoImg, 'PNG', logoX, logoY, imgWidth, imgHeight);
        } catch (e) {
            console.warn("No se pudo cargar el logo", e);
        }

        // 2. T√çTULOS CENTRALES
        const centerX = margin + logoColWidth + (titleColWidth / 2);
        
        docInstance.setFontSize(11);
        docInstance.setTextColor(0);
        docInstance.setFont('helvetica', 'bold');
        docInstance.text((customHeader.empresa || 'EMPRESA DEFAULT').toUpperCase(), centerX, startY + 7, { align: 'center' });
        
        docInstance.setFontSize(8);
        docInstance.setFont('helvetica', 'normal');
        docInstance.text((customHeader.sistema || 'SISTEMA DE GESTI√ìN').toUpperCase(), centerX, startY + 14, { align: 'center' });
        
        docInstance.setFontSize(10);
        docInstance.setFont('helvetica', 'bold');
        docInstance.text((customHeader.tituloDoc || 'DOCUMENTO').toUpperCase(), centerX, startY + 21, { align: 'center' });

        // 3. INFORMACI√ìN DERECHA (C√≥digo, Versi√≥n, Fecha)
        const infoXLabel = margin + logoColWidth + titleColWidth + 2;
        const infoXValue = margin + contentWidth - 2;
        const rowH = fullHeight / 3;

        // L√≠neas horizontales en la columna derecha
        docInstance.line(margin + logoColWidth + titleColWidth, startY + rowH, margin + contentWidth, startY + rowH);
        docInstance.line(margin + logoColWidth + titleColWidth, startY + (rowH * 2), margin + contentWidth, startY + (rowH * 2));

        // Fecha
        docInstance.setFontSize(7);
        docInstance.setFont('helvetica', 'bold');
        docInstance.text("Fecha Emisi√≥n:", infoXLabel, startY + 5);
        docInstance.setFont('helvetica', 'normal');
        docInstance.text(new Date().toLocaleDateString(), infoXValue, startY + 5, { align: 'right' });

        // C√≥digo
        docInstance.setFont('helvetica', 'bold');
        docInstance.text("C√≥digo:", infoXLabel, startY + 5 + rowH);
        docInstance.setFont('helvetica', 'normal');
        docInstance.text(customHeader.codigo || 'N/A', infoXValue, startY + 5 + rowH, { align: 'right' });

        // Versi√≥n
        docInstance.setFont('helvetica', 'bold');
        docInstance.text("Versi√≥n:", infoXLabel, startY + 5 + (rowH * 2));
        docInstance.setFont('helvetica', 'normal');
        docInstance.text(customHeader.version || '01', infoXValue, startY + 5 + (rowH * 2), { align: 'right' });
    };

    // --- DIBUJAR CONTENIDO ---
    let yPos = 42; 
    const headerMargin = 42; 

    seccionesRender.forEach((sec) => {
        // Verificar espacio disponible en p√°gina
        if (yPos > (pageHeight - 25)) {
            doc.addPage();
            yPos = headerMargin;
        }

        // T√≠tulo de Secci√≥n
        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.setFont('helvetica', 'bold');
        doc.text(sec.titulo.toUpperCase(), margin, yPos);
        yPos += 5;

        // TIPO: INFORMACI√ìN (Formulario Key-Value)
        if (sec.tipo === 'info') {
            const bodyData = [];
            const keys = sec.campos.map(c => c.nombre);
            
            // Agrupar en pares para mostrar 2 columnas
            for (let i = 0; i < keys.length; i += 2) {
                const key1 = keys[i];
                const val1 = formData[sec.titulo]?.[key1] || '';
                const key2 = keys[i+1] || '';
                const val2 = key2 ? (formData[sec.titulo]?.[key2] || '') : '';
                
                bodyData.push([key1, val1, key2, val2]);
            }

            autoTable(doc, {
                startY: yPos,
                head: [],
                body: bodyData,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 1.5, textColor: 0, lineColor: 0, lineWidth: 0.1, valign: 'middle' },
                columnStyles: {
                    0: { fontStyle: 'bold', width: 40, fillColor: [248, 250, 252] },
                    2: { fontStyle: 'bold', width: 40, fillColor: [248, 250, 252] }
                },
                margin: { left: margin, right: margin, top: headerMargin },
                pageBreak: 'auto'
            });
            yPos = doc.lastAutoTable.finalY + 8;
        }

        // TIPO: TEXTO (P√°rrafos largos)
        if (sec.tipo === 'texto') {
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0);
            
            const texto = formData[sec.titulo] || '';
            const splitText = doc.splitTextToSize(texto, contentWidth);

            // Verificar si cabe el texto completo
            if (yPos + (splitText.length * 4) > (pageHeight - 20)) {
                doc.addPage();
                yPos = headerMargin;
            }

            doc.text(splitText, margin, yPos, { align: 'left' });
            yPos += (splitText.length * 4) + 8;
        }

        // TIPO: TABLA (Filas din√°micas)
        if (sec.tipo === 'tabla') {
            const headers = [sec.columnas];
            const dataRows = (tableData[sec.titulo] || []).map(row => 
                sec.columnas.map(col => row[col] || '')
            );

            autoTable(doc, {
                startY: yPos,
                head: headers,
                body: dataRows,
                theme: 'grid',
                headStyles: { 
                    fillColor: [226, 232, 240], 
                    textColor: 0, 
                    lineColor: 0, 
                    lineWidth: 0.1, 
                    fontStyle: 'bold', 
                    halign: 'center' 
                },
                styles: { 
                    fontSize: 9, 
                    cellPadding: 1.5, 
                    textColor: 0, 
                    lineColor: 0, 
                    lineWidth: 0.1, 
                    halign: 'center' 
                },
                margin: { left: margin, right: margin, top: headerMargin },
                tableWidth: 'auto',
                pageBreak: 'auto'
            });
            yPos = doc.lastAutoTable.finalY + 8;
        }
    });

    // --- FOOTER (FIRMAS) ---
    // Asegurar que no quede cortado al final de la p√°gina
    if (yPos > (pageHeight - 40)) {
        doc.addPage();
        yPos = headerMargin + 10;
    } else {
        yPos += 15;
    }

    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.line(margin, yPos + 10, margin + 70, yPos + 10); // L√≠nea de firma
    
    doc.setFontSize(9);
    doc.setTextColor(0);
    doc.setFont('helvetica', 'bold');
    doc.text((customFooter.nombre || '').toUpperCase(), margin, yPos + 15);
    
    doc.setFont('helvetica', 'normal');
    doc.text(customFooter.cargo || '', margin, yPos + 19);
    doc.text(customFooter.empresa || '', margin, yPos + 23);

    // --- NUMERACI√ìN DE P√ÅGINAS ---
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        drawHeaderOnPage(doc); // Dibujar cabecera en cada p√°gina
        doc.setFontSize(7);
        doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }

    // --- SALIDA DEL ARCHIVO (IMPORTANTE) ---
    if (returnBlob === true) {
        // Retorna el archivo binario para poder subirlo
        return doc.output('blob');
    } else if (returnBlob === 'bloburl') {
        // Retorna URL temporal para preview
        return doc.output('bloburl');
    } else {
        // Descarga directa (comportamiento por defecto)
        doc.save(`Certificado_${plantillaNombre.replace(/\s+/g, '_')}_${Date.now()}.pdf`);
    }
};


==================================================================
ARCHIVO: frontend\src\utils\pdfPesosGenerator.js
==================================================================
import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import logoImg from '../assets/logo_eltrece.png'; 
// Importamos las herramientas de seguridad
import { apiFetchBlob, extractFilename } from '../services/api';

// --- HELPER: CONVERTIR BLOB A BASE64 PARA JSPDF ---
const getBase64FromSecureUrl = async (urlBD) => {
    if (!urlBD) return null;
    try {
        const filename = extractFilename(urlBD);
        // Pedimos el blob al endpoint seguro
        const blob = await apiFetchBlob(`/pesos/evidencia/${filename}`);
        
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        });
    } catch (error) {
        console.warn("No se pudo cargar la imagen para el PDF:", error);
        return null;
    }
};

export const generarPDFPesos = async (data, customHeader, verEnPantalla = false) => {
    const doc = new jsPDF();
    const { cabecera, muestras } = data;

    // --- CONFIGURACI√ìN ---
    const marginLeft = 15;
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height; // Necesario para calcular saltos de p√°gina
    const contentWidth = pageWidth - (marginLeft * 2);
    
    // Fechas
    const fechaReporte = new Date(cabecera.Fecha_Creacion || cabecera.Fecha_Registro).toLocaleDateString('es-CO');

    // --- C√ÅLCULOS ESTAD√çSTICOS ---
    const valores = muestras.map(m => m.Valor_Peso);
    const totalMuestras = valores.length;
    const promedio = totalMuestras > 0 ? (valores.reduce((a, b) => a + b, 0) / totalMuestras).toFixed(2) : 0;
    const minVal = totalMuestras > 0 ? Math.min(...valores).toFixed(2) : 0;
    const maxVal = totalMuestras > 0 ? Math.max(...valores).toFixed(2) : 0;
    const aprobados = muestras.filter(m => m.Es_Conforme).length;
    // const rechazados = totalMuestras - aprobados; // (Variable no usada, se puede quitar)

    // --- 1. ENCABEZADO ---
    const startY = 10;
    const headerHeight = 28; 
    
    doc.setLineWidth(0.3);
    doc.setDrawColor(0);
    doc.rect(marginLeft, startY, contentWidth, headerHeight);
    
    const logoColWidth = 45;
    const infoColWidth = 40;
    const titleColWidth = contentWidth - logoColWidth - infoColWidth;

    doc.line(marginLeft + logoColWidth, startY, marginLeft + logoColWidth, startY + headerHeight);
    doc.line(marginLeft + logoColWidth + titleColWidth, startY, marginLeft + logoColWidth + titleColWidth, startY + headerHeight);

    // LOGO
    try {
        const imgProps = doc.getImageProperties(logoImg);
        const ratio = imgProps.width / imgProps.height;
        const logoH = 22; 
        const logoW = logoH * ratio;
        const logoX = marginLeft + (logoColWidth - logoW) / 2;
        const logoY = startY + (headerHeight - logoH) / 2;
        doc.addImage(logoImg, 'PNG', logoX, logoY, logoW, logoH);
    } catch (e) { console.warn("Logo no cargado"); }

    // TITULOS
    const centerX = marginLeft + logoColWidth + (titleColWidth / 2);
    const centerY = startY + (headerHeight / 2);
    
    doc.setTextColor(0);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text((customHeader.empresa || '').toUpperCase(), centerX, centerY - 6, { align: 'center' });
    
    doc.setFontSize(7);
    doc.setFont('helvetica', 'normal');
    doc.text((customHeader.sistema || '').toUpperCase(), centerX, centerY, { align: 'center' });
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text((customHeader.titulo || '').toUpperCase(), centerX, centerY + 7, { align: 'center' });

    // INFO DERECHA
    const infoXLabel = marginLeft + logoColWidth + titleColWidth + 2;
    const infoXValue = marginLeft + contentWidth - 2;
    const rowH = headerHeight / 3;

    doc.line(marginLeft + logoColWidth + titleColWidth, startY + rowH, marginLeft + contentWidth, startY + rowH);
    doc.line(marginLeft + logoColWidth + titleColWidth, startY + (rowH * 2), marginLeft + contentWidth, startY + (rowH * 2));

    doc.setFontSize(7);
    doc.setFont('helvetica', 'bold'); doc.text("C√ìDIGO:", infoXLabel, startY + 5);
    doc.setFont('helvetica', 'normal'); doc.text(customHeader.codigo || 'N/A', infoXValue, startY + 5, { align: 'right' });

    doc.setFont('helvetica', 'bold'); doc.text("VERSI√ìN:", infoXLabel, startY + rowH + 5);
    doc.setFont('helvetica', 'normal'); doc.text(customHeader.version || '01', infoXValue, startY + rowH + 5, { align: 'right' });

    doc.setFont('helvetica', 'bold'); doc.text("FECHA:", infoXLabel, startY + (rowH * 2) + 5);
    doc.setFont('helvetica', 'normal'); doc.text(fechaReporte, infoXValue, startY + (rowH * 2) + 5, { align: 'right' });

    let currentY = startY + headerHeight + 5;

    // --- 2. INFORMACI√ìN DEL LOTE ---
    doc.setFillColor(241, 245, 249);
    doc.setDrawColor(203, 213, 225);
    doc.rect(marginLeft, currentY, contentWidth, 7, 'FD');
    doc.setFontSize(9); doc.setFont('helvetica', 'bold'); doc.setTextColor(15, 23, 42); 
    doc.text(`INFORMACI√ìN DEL LOTE - CONTROL #${cabecera.ID_Control}`, marginLeft + 2, currentY + 4.5);
    currentY += 10;

    const rowHeight = 5;
    doc.setFontSize(8); doc.setTextColor(0);

    const printRow = (l1, v1, l2, v2, y) => {
        doc.setFont('helvetica', 'bold'); doc.text(l1, marginLeft, y);
        doc.setFont('helvetica', 'normal'); doc.text(v1 || '', marginLeft + 25, y);
        doc.setFont('helvetica', 'bold'); doc.text(l2, marginLeft + 90, y);
        doc.setFont('helvetica', 'normal'); doc.text(v2 || '', marginLeft + 115, y);
    };

    printRow("PRODUCTO:", cabecera.Producto, "LOTE:", cabecera.Lote, currentY);
    currentY += rowHeight;
    printRow("LOTE MP:", cabecera.Lote_MP, "LOTE L√ÅMINA:", cabecera.Lote_Lamina, currentY);
    currentY += rowHeight;
    printRow("MAQUINISTA:", cabecera.Maquinista, "PESO NOMINAL:", `${cabecera.Peso_Nominal} g`, currentY);
    currentY += rowHeight + 2;

    // --- 3. PAR√ÅMETROS Y SELLADO ---
    const sellInf = cabecera.Sellado_Inferior ? 'OK' : 'FALLO';
    const sellSup = cabecera.Sellado_Superior ? 'OK' : 'FALLO';
    const sellVert = cabecera.Sellado_Vertical ? 'OK' : 'FALLO';
    const sellLot = cabecera.Sellado_Loteado ? 'OK' : 'FALLO';

    const paramsData = [
        ['Velocidad', `${cabecera.Golpes_Minuto} gpm`, 'Promedio', `${promedio} g`],
        ['Temp. Vertical', `${cabecera.Temp_Vertical} ¬∞C`, 'M√≠nimo', `${minVal} g`],
        ['Temp. H. Sup', `${cabecera.Temp_Horiz_Sup} ¬∞C`, 'M√°ximo', `${maxVal} g`],
        ['Temp. H. Inf', `${cabecera.Temp_Horiz_Inf} ¬∞C`, 'Aprobados', `${aprobados} / ${totalMuestras}`],
        [{content: 'VERIFICACI√ìN DE SELLADO', colSpan: 4, styles: {fillColor: [226, 232, 240], fontStyle:'bold', halign:'center'}}],
        ['Sellado Inferior', sellInf, 'Sellado Vertical', sellVert],
        ['Sellado Superior', sellSup, 'Loteado Legible', sellLot],
        [{content: 'RESULTADO FINAL DEL CONTROL', colSpan: 2, styles:{fontStyle:'bold'}}, {content: cabecera.Estado_Final, colSpan: 2, styles:{fontStyle:'bold', textColor: cabecera.Estado_Final === 'Aprobado' ? [22, 163, 74] : [220, 38, 38]}}]
    ];

    autoTable(doc, {
        startY: currentY,
        head: [['PAR√ÅMETROS T√âCNICOS', 'VALOR', 'ESTAD√çSTICA', 'RESULTADO']],
        body: paramsData,
        theme: 'grid',
        headStyles: { fillColor: [12, 71, 96], fontSize: 8, halign: 'center' },
        styles: { fontSize: 8, cellPadding: 2, lineColor: 200 },
        columnStyles: {
            0: { fontStyle: 'bold', width: 40, fillColor: [248, 250, 252] },
            2: { fontStyle: 'bold', width: 40, fillColor: [248, 250, 252] }
        },
        didParseCell: function(data) {
            if (data.section === 'body') {
                if (data.cell.raw === 'FALLO') data.cell.styles.textColor = [220, 38, 38];
                if (data.cell.raw === 'OK') data.cell.styles.textColor = [22, 163, 74];
            }
        },
        margin: { left: marginLeft, right: marginLeft }
    });

    currentY = doc.lastAutoTable.finalY + 8;

    // --- 4. DETALLE DE MUESTRAS ---
    doc.setFontSize(9);
    doc.setTextColor(12, 71, 96);
    doc.setFont('helvetica', 'bold');
    doc.text("DETALLE DE MUESTRAS", marginLeft, currentY);
    currentY += 3;

    const muestrasBody = muestras.map(m => [
        `#${m.Numero_Muestra}`,
        `${m.Valor_Peso} g`,
        m.Es_Conforme ? 'OK' : 'FALLO'
    ]);

    const mitad = Math.ceil(muestrasBody.length / 2);
    const col1 = muestrasBody.slice(0, mitad);
    const col2 = muestrasBody.slice(mitad);

    const rowsCombined = [];
    for (let i = 0; i < mitad; i++) {
        const left = col1[i] || ['', '', ''];
        const right = col2[i] || ['', '', ''];
        rowsCombined.push([...left, '', ...right]); 
    }

    autoTable(doc, {
        startY: currentY,
        head: [['Muestra', 'Peso', 'Est', '', 'Muestra', 'Peso', 'Est']],
        body: rowsCombined,
        theme: 'striped',
        headStyles: { fillColor: [71, 85, 105], fontSize: 8, halign: 'center' },
        styles: { fontSize: 8, halign: 'center', cellPadding: 1 },
        columnStyles: {
            2: { fontStyle: 'bold' },
            6: { fontStyle: 'bold' },
            3: { fillColor: 255, cellWidth: 5 }
        },
        didParseCell: function(data) {
            if (data.section === 'body') {
                if ((data.column.index === 2 || data.column.index === 6)) {
                    if (data.cell.raw === 'FALLO') data.cell.styles.textColor = [220, 38, 38];
                    if (data.cell.raw === 'OK') data.cell.styles.textColor = [22, 163, 74];
                }
            }
        },
        margin: { left: marginLeft, right: marginLeft }
    });

    currentY = doc.lastAutoTable.finalY + 10;

    // --- 5. NUEVO: EVIDENCIA FOTOGR√ÅFICA (Seguro) ---
    if (cabecera.Url_Evidencia) {
        // Verificar espacio, si no cabe, nueva p√°gina
        if (currentY + 80 > pageHeight - 15) {
            doc.addPage();
            currentY = 20;
        }

        doc.setFontSize(9);
        doc.setTextColor(12, 71, 96);
        doc.setFont('helvetica', 'bold');
        doc.text("EVIDENCIA ADJUNTA", marginLeft, currentY);
        currentY += 5;

        // Descargamos la imagen usando el m√©todo seguro
        const base64Img = await getBase64FromSecureUrl(cabecera.Url_Evidencia);
        
        if (base64Img) {
            // Intentamos ajustar la imagen a un ancho razonable (ej. 80mm)
            const imgW = 80;
            const imgH = 80; // Cuadrada por defecto
            doc.addImage(base64Img, 'JPEG', marginLeft, currentY, imgW, imgH);
            
            // Borde opcional alrededor de la foto
            doc.setDrawColor(200);
            doc.rect(marginLeft, currentY, imgW, imgH);
        } else {
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("(No se pudo cargar la imagen de evidencia)", marginLeft, currentY + 5);
        }
    }

    // --- PIE DE P√ÅGINA ---
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(7);
        doc.setTextColor(150);
        doc.text(`Generado el: ${new Date().toLocaleString()}`, marginLeft, doc.internal.pageSize.height - 10);
        doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth - marginLeft, doc.internal.pageSize.height - 10, {align: 'right'});
    }

    // --- SALIDA ---
    const nombreArchivo = `Control_Pesos_${cabecera.Lote}_${cabecera.Producto}.pdf`;

    if (verEnPantalla) {
        const blob = doc.output('blob');
        const blobURL = URL.createObjectURL(blob);
        window.open(blobURL, '_blank');
    } else {
        doc.save(nombreArchivo);
    }
};


==================================================================
ARCHIVO: frontend\vite.config.js
==================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


